<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px;
            transition: background 0.2s;
        }
        .test-button:hover {
            background: #2563EB;
        }
        .test-button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
        }
        .results {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .instructions {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .status {
            padding: 8px 16px;
            border-radius: 6px;
            margin: 8px 0;
            font-weight: 600;
        }
        .status.success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #10B981;
        }
        .status.error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #EF4444;
        }
        .status.warning {
            background: #FEF3C7;
            color: #92400E;
            border: 1px solid #F59E0B;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="instructions">
        <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆæ‰‹é †</h3>
        <ol>
            <li>ã¾ãšå›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</li>
            <li>å›ç­”ã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„</li>
            <li>ä¸‹ã®ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</li>
            <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«(F12)ã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚‚ç¢ºèªã—ã¦ãã ã•ã„</li>
        </ol>
    </div>

    <div class="test-container">
        <h2>ğŸ¯ åŸºæœ¬ãƒ†ã‚¹ãƒˆ</h2>
        <button class="test-button" onclick="runBasicTest()">å˜ä¸€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ</button>
        <button class="test-button" onclick="runAllReactionsTest()">å…¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ãƒ†ã‚¹ãƒˆ</button>
        <button class="test-button" onclick="checkSystemStatus()">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª</button>
        <button class="test-button" onclick="runComprehensiveTest()" style="background: #10B981;">ğŸš€ ç·åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <div id="basicResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-container">
        <h2>âš¡ ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ</h2>
        <button class="test-button" onclick="runStressTest()">é€£ç¶šã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</button>
        <button class="test-button" onclick="runConcurrentTest()">åŒæ™‚å®Ÿè¡Œãƒ†ã‚¹ãƒˆ</button>
        <div id="stressResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-container">
        <h2>ğŸ” è©³ç´°æ¤œè¨¼</h2>
        <button class="test-button" onclick="runSyncTest()">ã‚µãƒ¼ãƒãƒ¼åŒæœŸãƒ†ã‚¹ãƒˆ</button>
        <button class="test-button" onclick="runUIConsistencyTest()">UIæ•´åˆæ€§ãƒ†ã‚¹ãƒˆ</button>
        <div id="detailResults" class="results" style="display: none;"></div>
    </div>

    <div id="status" class="status" style="display: none;"></div>

    <script>
        let testWindow = null;

        // ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
        function openTestWindow() {
            if (!testWindow || testWindow.closed) {
                // å®Ÿéš›ã®å›ç­”ãƒœãƒ¼ãƒ‰URLã«å¤‰æ›´ã—ã¦ãã ã•ã„
                testWindow = window.open('/a/macros/naha-okinawa.ed.jp/s/AKfycbyq0CohJCpwb8KYJQrba4pWhvtss5HD2nKDPMuzPBX2EOftIAI2UbtjjyEn4N52TCzX/exec?mode=view&userId=d6aad07b-8583-4fe2-be97-44f513f325dd', 'testWindow', 'width=1200,height=800');
                
                if (testWindow) {
                    showStatus('å›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹ã„ã¦ã„ã¾ã™...', 'warning');
                    
                    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
                    testWindow.addEventListener('load', () => {
                        setTimeout(() => {
                            showStatus('å›ç­”ãƒœãƒ¼ãƒ‰ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ', 'success');
                        }, 2000);
                    });
                } else {
                    showStatus('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚æ‰‹å‹•ã§å›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚', 'error');
                }
            }
            return testWindow;
        }

        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        function showResults(containerId, results) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.textContent = typeof results === 'string' ? results : JSON.stringify(results, null, 2);
        }

        // åŸºæœ¬ãƒ†ã‚¹ãƒˆ
        async function runBasicTest() {
            const win = openTestWindow();
            if (!win) return;

            try {
                // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®æº–å‚™ã‚’å¾…ã¤
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                if (typeof win.testReactionSystem === 'function') {
                    showStatus('å˜ä¸€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...', 'warning');
                    const result = await win.testReactionSystem({ cardIndex: 0, reaction: 'LIKE' });
                    showResults('basicResults', result);
                    showStatus('å˜ä¸€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                } else {
                    showStatus('ãƒ†ã‚¹ãƒˆé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å›ç­”ãƒœãƒ¼ãƒ‰ãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'error');
                }
            } catch (error) {
                showStatus('ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                showResults('basicResults', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        async function runAllReactionsTest() {
            const win = openTestWindow();
            if (!win) return;

            try {
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                if (typeof win.testAllReactions === 'function') {
                    showStatus('å…¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...', 'warning');
                    const result = await win.testAllReactions(0);
                    showResults('basicResults', result);
                    showStatus('å…¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                } else {
                    showStatus('ãƒ†ã‚¹ãƒˆé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                }
            } catch (error) {
                showStatus('ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                showResults('basicResults', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        async function checkSystemStatus() {
            const win = openTestWindow();
            if (!win) return;

            try {
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const status = {
                    studyQuestApp: !!win.studyQuestApp,
                    answersContainer: !!win.studyQuestApp?.elements?.answersContainer,
                    answerCards: win.document?.querySelectorAll('.answer-card')?.length || 0,
                    testFunctions: {
                        testReactionSystem: typeof win.testReactionSystem === 'function',
                        testAllReactions: typeof win.testAllReactions === 'function',
                        debugGetAnswerCardInfo: typeof win.debugGetAnswerCardInfo === 'function'
                    }
                };
                
                showResults('basicResults', status);
                showStatus('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªå®Œäº†', 'success');
            } catch (error) {
                showStatus('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                showResults('basicResults', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ
        async function runStressTest() {
            const win = openTestWindow();
            if (!win) return;

            try {
                await new Promise(resolve => setTimeout(resolve, 3000));
                showStatus('é€£ç¶šã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...', 'warning');
                
                const results = [];
                for (let i = 0; i < 5; i++) {
                    const result = await win.testReactionSystem({ 
                        cardIndex: 0, 
                        reaction: 'LIKE', 
                        verbose: false 
                    });
                    results.push(`ãƒ†ã‚¹ãƒˆ${i + 1}: ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                showResults('stressResults', results.join('\n'));
                showStatus('é€£ç¶šã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
            } catch (error) {
                showStatus('ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                showResults('stressResults', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        async function runConcurrentTest() {
            const win = openTestWindow();
            if (!win) return;

            try {
                await new Promise(resolve => setTimeout(resolve, 3000));
                showStatus('åŒæ™‚å®Ÿè¡Œãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...', 'warning');
                
                // è¤‡æ•°ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åŒæ™‚å®Ÿè¡Œ
                const promises = [
                    win.testReactionSystem({ cardIndex: 0, reaction: 'LIKE', verbose: false }),
                    win.testReactionSystem({ cardIndex: 0, reaction: 'UNDERSTAND', verbose: false }),
                    win.testReactionSystem({ cardIndex: 0, reaction: 'CURIOUS', verbose: false })
                ];
                
                const results = await Promise.allSettled(promises);
                const summary = results.map((result, index) => {
                    const reactions = ['LIKE', 'UNDERSTAND', 'CURIOUS'];
                    return `${reactions[index]}: ${result.status === 'fulfilled' && result.value.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`;
                });
                
                showResults('stressResults', summary.join('\n'));
                showStatus('åŒæ™‚å®Ÿè¡Œãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
            } catch (error) {
                showStatus('åŒæ™‚å®Ÿè¡Œãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                showResults('stressResults', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        async function runSyncTest() {
            showStatus('ã‚µãƒ¼ãƒãƒ¼åŒæœŸãƒ†ã‚¹ãƒˆã¯æ‰‹å‹•ã§å®Ÿè¡Œã—ã¦ãã ã•ã„', 'warning');
            showResults('detailResults', 'ã‚µãƒ¼ãƒãƒ¼åŒæœŸãƒ†ã‚¹ãƒˆã®æ‰‹é †:\n1. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n2. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿\n3. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ãŒä¿æŒã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª\n4. ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã‚‚åŒã˜çŠ¶æ…‹ãŒè¦‹ãˆã‚‹ã“ã¨ã‚’ç¢ºèª');
        }

        async function runUIConsistencyTest() {
            const win = openTestWindow();
            if (!win) return;

            try {
                await new Promise(resolve => setTimeout(resolve, 3000));
                showStatus('UIæ•´åˆæ€§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...', 'warning');
                
                const cardInfo = win.debugGetAnswerCardInfo(0);
                if (!cardInfo.success) {
                    throw new Error(cardInfo.error);
                }
                
                const card = win.document.querySelectorAll('.answer-card')[0];
                const reactionButtons = card.querySelectorAll('.reaction-btn');
                
                const uiState = Array.from(reactionButtons).map(btn => ({
                    reaction: btn.dataset.reaction,
                    pressed: btn.getAttribute('aria-pressed'),
                    count: btn.querySelector('.count')?.textContent || '0',
                    classes: btn.className,
                    icon: btn.querySelector('svg')?.outerHTML || 'ãªã—'
                }));
                
                showResults('detailResults', uiState);
                showStatus('UIæ•´åˆæ€§ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
            } catch (error) {
                showStatus('UIæ•´åˆæ€§ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                showResults('detailResults', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ç·åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runComprehensiveTest() {
            const win = openTestWindow();
            if (!win) return;

            try {
                showStatus('ç·åˆãƒ†ã‚¹ãƒˆã‚’æº–å‚™ä¸­...', 'warning');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ³¨å…¥
                if (!win.runAllTests) {
                    const script = win.document.createElement('script');
                    script.textContent = await fetch('./run-reaction-tests.js').then(r => r.text());
                    win.document.head.appendChild(script);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                if (typeof win.runAllTests === 'function') {
                    showStatus('ç·åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...', 'warning');
                    const results = await win.runAllTests();
                    
                    // çµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                    const summary = `
ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
====================
ğŸ¯ ç·ãƒ†ã‚¹ãƒˆæ•°: ${results.summary.total}
âœ… æˆåŠŸ: ${results.summary.passed}
âŒ å¤±æ•—: ${results.summary.failed}
ğŸ“ˆ æˆåŠŸç‡: ${((results.summary.passed / results.summary.total) * 100).toFixed(1)}%
â±ï¸ å®Ÿè¡Œæ™‚é–“: ${results.duration?.toFixed(2)}ms

ğŸ“‹ ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœ:
${Object.entries(results.tests).map(([category, tests]) => {
    const passed = tests.filter(t => t.status === 'passed').length;
    const total = tests.length;
    return `${category}: ${passed}/${total} (${((passed/total)*100).toFixed(1)}%)`;
}).join('\n')}

${results.summary.errors.length > 0 ? `\nğŸ” ã‚¨ãƒ©ãƒ¼:\n${results.summary.errors.join('\n')}` : ''}
                    `;
                    
                    showResults('basicResults', summary);
                    
                    if (results.summary.failed === 0) {
                        showStatus('ğŸ‰ å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚', 'success');
                    } else {
                        showStatus(`âš ï¸ ${results.summary.failed}ä»¶ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'error');
                    }
                    
                    // è©³ç´°çµæœã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
                    console.log('è©³ç´°ãƒ†ã‚¹ãƒˆçµæœ:', results);
                    
                } else {
                    showStatus('ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                }
            } catch (error) {
                showStatus('ç·åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                showResults('basicResults', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', () => {
            showStatus('ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸã€‚å›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹ã„ã¦ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚', 'success');
        });
    </script>
</body>
</html>