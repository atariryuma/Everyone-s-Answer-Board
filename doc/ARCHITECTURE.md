# StudyQuest - みんなの回答ボード: アーキテクチャ概要

このドキュメントでは、「StudyQuest - みんなの回答ボード」アプリケーションの全体的なアーキテクチャ、主要なコンポーネント、およびそれらの相互作用について説明します。

## 1. 概要

「みんなの回答ボード」は、Google Apps Script (GAS) を利用して構築されたウェブアプリケーションであり、Googleスプレッドシートをデータストアとして活用します。生徒の回答をリアルタイムで共有し、活発な議論を促進することを目的としています。本アプリケーションは、メインアプリケーションと独立した「管理者向けログ記録API」の2つの主要なGASプロジェクトで構成されています。

## 2. 主要コンポーネント

### 2.1. メインアプリケーション (GASプロジェクト)

ユーザーが直接アクセスするウェブアプリケーションです。`src/` ディレクトリ内のコードで構成されます。

*   **`Code.gs`**:
    *   アプリケーションのコアロジックを担います。
    *   ユーザー認証と権限管理（管理者/一般ユーザー）。
    *   Googleスプレッドシートとの連携（データの読み書き、シートの切り替え）。
    *   Googleフォームとの連携（フォーム情報の取得）。
    *   管理機能（アプリの公開/非公開、表示設定）。
    *   ウェブアプリケーションのエントリーポイント (`doGet`) として機能し、URLパラメータに基づいて異なるHTMLページをレンダリングします。
    *   XSS対策、レート制限、エラーハンドリングなどのセキュリティ機能を提供します。
*   **`config.gs`**:
    *   各回答ボード（スプレッドシートのシート）の設定を管理します。
    *   スプレッドシート内の「Config」シートに設定を保存・読み込みます。
    *   シートのヘッダーから自動的に設定項目（質問、回答、理由、名前、クラスの列）を推測する機能を提供します。
*   **`ErrorHandling.gs`**:
    *   アプリケーション全体で利用される汎用的なエラー処理ユーティリティを提供します。
*   **`SetupCode.gs`**:
    *   アプリケーションの初回セットアッププロセスを管理します。
    *   「管理者向けログ記録API」のURL設定と、メインデータベース（ユーザー情報が保存されるスプレッドシート）の作成・連携を行います。
*   **HTMLテンプレート (`AdminPanel.html`, `Page.html`, `Registration.html`, `SetupPage.html`, `Unpublished.html`)**:
    *   Google Apps Scriptの`HtmlService`によってレンダリングされるユーザーインターフェースを提供します。
    *   クライアントサイドのJavaScriptとCSSを含み、動的な表示とインタラクションを実現します。

### 2.2. 管理者向けログ記録API (GASプロジェクト)

メインアプリケーションとは独立してデプロイされるGASプロジェクトです。`Admin Logger API/` ディレクトリ内のコードで構成されます。

*   **`AdminLogger_Setup.gs`**:
    *   ユーザーデータと監査ログを保存するための専用スプレッドシートを管理します。
    *   メインアプリケーションからのAPIリクエスト（ユーザーの作成、更新、検索など）を処理します。
    *   `doPost` エンドポイントを通じて構造化されたAPIリクエストを受け付けます。
    *   ユーザー情報（`userId`, `adminEmail`, `spreadsheetId`, `configJson` など）をデータベースに保存・管理します。
    *   デバッグおよび管理用のユーティリティ関数（データベースの初期化、テスト、クリアなど）を提供します。

## 3. データフローと相互作用

1.  **初回セットアップ**:
    *   管理者はまず「管理者向けログ記録API」をデプロイし、そのウェブアプリURLを取得します。
    *   次に、メインアプリケーションをデプロイし、セットアップページ (`SetupPage.html`) から取得したLogger APIのURLを設定します。この際、ユーザー情報が保存されるメインデータベース（スプレッドシート）が作成または指定されます。
2.  **ユーザー登録**:
    *   新規ユーザーがメインアプリケーションにアクセスすると、`Registration.html`が表示されます。
    *   ユーザーは自身のGoogleアカウントでログインし、メインアプリケーションはLogger APIを通じてユーザー情報をメインデータベースに登録します。
3.  **回答ボードの利用**:
    *   管理者はメインアプリケーションの管理パネル (`AdminPanel.html`) から新しい回答ボードを作成したり、既存のスプレッドシートをボードとして設定したりします。
    *   生徒はボードのURLにアクセスし、`Page.html`を通じて回答を閲覧・投稿します。
    *   回答データは、各ボードに対応するGoogleスプレッドシートに保存されます。
    *   リアクション（いいね！など）やハイライトなどの操作もスプレッドシートに反映されます。
4.  **設定と管理**:
    *   管理者は管理パネルから、表示設定（名前の表示/非表示、リアクション数の表示/非表示）やアクティブシートの切り替えなどを行います。これらの設定は、メインデータベースのユーザー情報 (`configJson`) またはスプレッドシートの「Config」シートに保存されます。
5.  **セキュリティと監査**:
    *   すべてのアクセスと重要な操作は、Logger APIを通じてメインデータベースにログとして記録されます。
    *   ドメインベースのアクセス制御により、指定されたドメインのユーザーのみがアプリケーションにアクセスできます。
    *   公開されたボードは、セキュリティのため一定時間後に自動的に非公開になります。

## 4. データ構造

### 4.1. メインデータベース (Admin Logger APIが管理するスプレッドシート)

ユーザーごとの設定とメタデータを保存します。

| カラム名         | 説明                                       |
| :--------------- | :----------------------------------------- |
| `userId`         | 各ユーザーに割り当てられる一意のID         |
| `adminEmail`     | ユーザーの管理者メールアドレス             |
| `spreadsheetId`  | ユーザーが使用する回答ボードのスプレッドシートID |
| `spreadsheetUrl` | ユーザーが使用する回答ボードのスプレッドシートURL |
| `createdAt`      | ユーザーが作成された日時                   |
| `accessToken`    | （現在未使用または将来の拡張用）           |
| `configJson`     | ユーザー固有の設定（JSON形式）             |
| `lastAccessedAt` | 最終アクセス日時                           |
| `isActive`       | ユーザーがアクティブかどうか               |

### 4.2. 回答ボードスプレッドシート (メインアプリケーションが管理)

各回答ボードに対応するスプレッドシートです。

*   **回答データシート**:
    *   Googleフォームからの回答が記録されるシートです。
    *   ヘッダーはユーザーが自由に設定できますが、アプリケーションは`config.gs`のロジックに基づいて「質問」「回答」「理由」「名前」「クラス」などの列を推測します。
    *   リアクション（「なるほど！」「いいね！」「もっと知りたい！」）のデータもこのシートに記録されます。
*   **`Config`シート**:
    *   各回答ボードのシートごとの表示設定を保存します。
    *   `config.gs`によって管理されます。

| カラム名         | 説明                                       |
| :--------------- | :----------------------------------------- |
| `表示シート名`   | 設定が適用されるシートの名前               |
| `問題文ヘッダー` | 問題文が記述されている列のヘッダー名       |
| `回答ヘッダー`   | 回答が記述されている列のヘッダー名         |
| `理由ヘッダー`   | 回答の理由が記述されている列のヘッダー名   |
| `名前列ヘッダー` | 回答者の名前が記述されている列のヘッダー名 |
| `クラス列ヘッダー` | 回答者のクラスが記述されている列のヘッダー名 |

## 5. セキュリティ

*   **ドメイン制限**: アプリケーションは、デプロイユーザーと同じGoogle Workspaceドメイン内のユーザーのみがアクセスできるように設定できます。
*   **自動非公開**: 公開された回答ボードは、セキュリティのため6時間後に自動的に非公開になります。
*   **XSS対策**: ユーザー入力は`sanitizeInput`関数によってサニタイズされ、クロスサイトスクリプティング攻撃を防ぎます。
*   **レート制限**: API呼び出しには基本的なレート制限が適用されます。
*   **権限分離**: メインアプリケーションとLogger APIは異なるGASプロジェクトとしてデプロイされ、それぞれの役割に応じた最小限の権限で実行されます。Logger APIは`USER_DEPLOYING`権限で実行され、データベースへのアクセスは管理者のみに制限されます。
*   **監査ログ**: すべての重要な操作はLogger APIを通じて記録され、管理者が不正アクセスや異常な活動を追跡できるようにします。

## 6. 開発とデプロイ

*   Google Apps Scriptのウェブアプリとしてデプロイされます。
*   `clasp` (Command Line Apps Script Project) を使用して、ローカルファイルとGASプロジェクトを同期できます。
*   `package.json` には開発スクリプトと依存関係が定義されています。
*   `tests/` ディレクトリには単体テストが含まれており、変更の検証に利用されます。
