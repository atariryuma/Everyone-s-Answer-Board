# StudyQuest - みんなの回答ボード: セットアップガイド

このガイドでは、「StudyQuest - みんなの回答ボード」の**新しいサービスアカウントモデル**のセットアップ手順を詳細に説明します。新アーキテクチャでは、**単一のGoogle Apps Scriptプロジェクト**のみでセットアップが完了し、従来の複雑な2プロジェクト構成から大幅に簡素化されています。

## 🎯 新アーキテクチャの利点

### ✅ 簡素化されたセットアップ
- **従来**: 2つのGASプロジェクト（メイン + Admin Logger API）
- **現在**: **単一のGASプロジェクトのみ**

### ✅ 403エラー完全解決
- **Google Workspace管理者の設定変更不要**
- **ユーザー自身がファイル所有権を持つ**
- **サービスアカウントによる安全な中央DB管理**

## 1. 前提条件

*   **Googleアカウント**（個人アカウントまたはGoogle Workspace）
*   **Google Cloud Console**へのアクセス（サービスアカウント作成のため）
*   **Google Apps Script**の基本的な知識
*   **`clasp`** (Command Line Apps Script Project) のインストール（任意ですが推奨）
    ```bash
    npm install -g @google/clasp
    ```

## 2. サービスアカウントの作成

### 2.1 Google Cloud Projectの準備

1. [Google Cloud Console](https://console.cloud.google.com) にアクセス
2. 新しいプロジェクトを作成、または既存のプロジェクトを選択
3. **APIとサービス** → **ライブラリ** で以下のAPIを有効化：
   - **Google Sheets API**
   - **Google Drive API**

### 2.2 サービスアカウントの作成

1. **IAMと管理** → **サービスアカウント** に移動
2. **サービスアカウントを作成** をクリック
3. サービスアカウント情報を入力：
   - **名前**: `StudyQuest-Service-Account`
   - **説明**: `StudyQuest回答ボード用のサービスアカウント`
4. **作成して続行** をクリック
5. ロールの設定：
   - **編集者** ロールを追加（または最小限の権限として **Sheets API 使用者** + **Drive API 使用者**）
6. **完了** をクリック

### 2.3 サービスアカウントキーの作成

1. 作成したサービスアカウントをクリック
2. **キー** タブに移動
3. **キーを追加** → **新しいキーを作成**
4. **JSON** 形式を選択して **作成**
5. **JSONファイルがダウンロードされます** - このファイルを安全に保管してください

## 3. 中央データベーススプレッドシートの作成

### 3.1 データベース用スプレッドシートの作成

1. [Google Sheets](https://sheets.google.com) で新しいスプレッドシートを作成
2. スプレッドシート名を「`StudyQuest Central Database`」に変更
3. **スプレッドシートIDをコピー**（URLから取得）
   - 例: `https://docs.google.com/spreadsheets/d/【ここがスプレッドシートID】/edit`

### 3.2 サービスアカウントに権限付与

1. スプレッドシートの **共有** ボタンをクリック
2. **ダウンロードしたJSONファイル内の `client_email` の値**を入力
   - 例: `studyquest-service-account@your-project.iam.gserviceaccount.com`
3. **編集者** 権限で共有

## 4. Google Apps Scriptプロジェクトのセットアップ

### 4.1 新しいGASプロジェクトの作成

1. [Google Apps Script](https://script.google.com) にアクセス
2. **新しいプロジェクト** を作成
3. プロジェクト名を「`StudyQuest - みんなの回答ボード`」に変更

### 4.2 ソースコードのコピー

1. このリポジトリの `src/` ディレクトリから以下のファイルをコピー：

#### **スクリプトファイル (.gs)**
- `Code.gs` → GASエディタの `コード.gs` に貼り付け
- `SetupCode.gs` → 新しいスクリプトファイルとして作成
- `config.gs` → 新しいスクリプトファイルとして作成
   - `ErrorHandling.gs` → 新しいスクリプトファイルとして作成

#### **HTMLファイル (.html)**
- `AdminPanel.html` → 新しいHTMLファイルとして作成
- `Page.html` → 新しいHTMLファイルとして作成
- `Registration.html` → 新しいHTMLファイルとして作成
- `SetupPage.html` → 新しいHTMLファイルとして作成
- `Unpublished.html` → 新しいHTMLファイルとして作成

#### **設定ファイル**
- `appsscript.json` → プロジェクト設定で「マニフェストファイルをエディタで表示」を有効にして貼り付け

### 4.3 アプリケーションの初期化

1. GASエディタで `SetupCode.gs` を開く
2. **関数選択ドロップダウン**から `setupApplication` を選択
3. **実行**する前に、以下の引数を準備：
   - **credsJson**: ダウンロードしたJSONファイルの内容（文字列として）
   - **dbId**: 中央データベーススプレッドシートのID

4. **実行方法**:
   ```javascript
   // 例: setupApplication関数の実行
   function runSetup() {
     const credsJson = '{"type":"service_account",...}'; // JSONファイルの内容
     const dbId = '1BcD3fGhIjKlMnOpQrStUvWxYz0123456789ABCDEFGH'; // スプレッドシートID
     
     setupApplication(credsJson, dbId);
   }
   ```

5. **初回実行時**: 必要な権限の承認を求められるので、画面の指示に従って承認
6. **実行成功**: 中央データベースに「Users」シートが作成され、初期化完了

## 5. ウェブアプリとしてデプロイ

### 5.1 デプロイ設定

1. GASエディタで **デプロイ** → **新しいデプロイ** を選択
2. **種類の選択** で **ウェブアプリ** を選択
3. デプロイ設定：
   ```
   説明: StudyQuest - みんなの回答ボード
   実行者: 自分
   アクセスできるユーザー: 組織内のユーザー (または「全員」でテスト)
   ```
4. **デプロイ** をクリック
5. **認証プロセス**を完了
6. **ウェブアプリURL**が表示されるので、**コピーして保管**

## 6. 動作確認とテスト

### 6.1 基本動作確認

1. **管理画面へのアクセス**:
   ```
   https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec?mode=admin
   ```

2. **セットアップ状態の確認**:
   - 管理画面で「ダッシュボード情報」が正常に表示されることを確認
   - 「サービスアカウント認証」が成功していることを確認

### 6.2 新しい回答ボードの作成テスト

1. 管理画面で「**新しいボードを作成して公開**」をクリック
2. 新しいスプレッドシートとGoogleフォームが作成されることを確認
3. **回答ボードURL**で回答が正常に表示されることを確認

## 7. セキュリティ設定（推奨）

### 7.1 アクセス制御

```javascript
// Code.gs内で以下のような設定が推奨されます
const ALLOWED_DOMAINS = ['your-school.edu', 'example.org'];
```

### 7.2 サービスアカウントキーの保護

- **JSONキーファイルを安全に管理**
- **不要になったキーは削除**
- **定期的なキーローテーション**の実施

## 8. トラブルシューティング

### 8.1 よくある問題と解決策

#### **🔒 認証エラー**
```
エラー: "Service account authentication failed"
解決策:
1. JSONキーファイルの内容が正しいかチェック
2. サービスアカウントに必要なAPI権限があるかチェック
3. 中央データベーススプレッドシートの共有設定を確認
```

#### **📊 データベース接続エラー**
```
エラー: "Database spreadsheet not accessible"
解決策:
1. スプレッドシートIDが正しいかチェック（44文字）
2. サービスアカウントがスプレッドシートに編集者権限で追加されているかチェック
3. Google Sheets APIが有効化されているかチェック
```

#### **🚫 403 Forbidden エラー**
```
新アーキテクチャでは403エラーは発生しません！
もし発生した場合:
1. appsscript.jsonのexecuteAsが"USER_ACCESSING"になっているかチェック
2. ユーザーが自分のスプレッドシートにアクセスしているかチェック
```

### 8.2 デバッグ用関数

```javascript
// SetupCode.gs内のデバッグ関数を使用
function testSetup() {
  // セットアップ状態の詳細診断
}

function showSetupInfo() {
  // 現在の設定情報表示
}

function checkDatabaseStatus() {
  // データベース接続状態確認
}
```

## 9. 本番環境への展開

### 9.1 本番チェックリスト

- [ ] サービスアカウント認証が正常動作
- [ ] 中央データベースアクセスが正常
- [ ] 新しい回答ボード作成が正常
- [ ] リアクション・ハイライト機能が正常
- [ ] テストユーザーでの動作確認完了

### 9.2 スケーリング考慮事項

- **ユーザー数**: 1000+ユーザーまで対応可能
- **同時接続**: 100+同時接続まで対応可能
- **データ量**: スプレッドシート1つあたり10,000回答まで推奨

## 10. 次のステップ

### 🎓 授業での活用

1. **教師トレーニング**: 管理画面の使い方
2. **生徒ガイダンス**: 回答方法とリアクション機能
3. **活用事例共有**: 効果的な授業での使い方

### 🚀 将来の拡張

新しいサービスアカウントアーキテクチャにより、以下の拡張が容易になりました：
- **多言語対応**
- **リアルタイム通知**
- **高度な分析機能**
- **AI統合機能**

---

## 🎉 セットアップ完了！

新しいサービスアカウントモデルにより、「StudyQuest - みんなの回答ボード」は**より簡単**で**より安全**で**より高性能**なアプリケーションとして生まれ変わりました。教育現場での活発な議論と学習促進のためのツールとしてご活用ください！

**問題や質問がある場合は、[Issues](https://github.com/your-repo/issues) でお気軽にお聞かせください。**