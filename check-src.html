<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>実際の/srcファイル検証</title>
  <style>
    body { font-family: monospace; background: #1e1e1e; color: #fff; padding: 20px; }
    .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
    .success { background: #0d4f3b; }
    .warning { background: #4a3a00; }
    .error { background: #4a1414; }
    button { background: #007acc; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; }
    .console { background: #000; padding: 15px; border-radius: 5px; margin: 10px 0; max-height: 600px; overflow-y: scroll; }
  </style>
</head>
<body>
  <h1>🔍 /src ファイル実地検証</h1>
  
  <div>
    <button onclick="checkHtmlFiles()">HTMLファイルチェック</button>
    <button onclick="checkJsFiles()">JavaScriptファイルチェック</button>
    <button onclick="checkGasFiles()">GASファイルチェック</button>
    <button onclick="checkAll()">全ファイルチェック</button>
    <button onclick="clearLog()">ログクリア</button>
  </div>

  <div id="console" class="console"></div>
  <div id="results"></div>

  <script>
    function log(message, type) {
      const console = document.getElementById('console');
      const time = new Date().toLocaleTimeString();
      const emoji = type === 'success' ? '✅' : type === 'error' ? '❌' : '📝';
      console.innerHTML += emoji + ' [' + time + '] ' + message + '\n';
      console.scrollTop = console.scrollHeight;
    }

    function addResult(name, status, details) {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = 'result ' + status;
      div.innerHTML = '<strong>' + name + '</strong>: ' + details;
      results.appendChild(div);
    }

    async function loadFile(filename) {
      try {
        const response = await fetch('/src/' + filename);
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        return await response.text();
      } catch (error) {
        log('❌ ' + filename + ' 読み込み失敗: ' + error.message, 'error');
        return null;
      }
    }

    async function checkHtmlFiles() {
      log('🗂️ HTMLファイルチェック開始', 'info');
      
      const files = ['AdminPanel.html', 'AppSetupPage.html', 'LoginPage.html', 'Page.html'];
      
      for (const file of files) {
        const content = await loadFile(file);
        if (!content) {
          addResult(file, 'error', '読み込み失敗');
          continue;
        }

        let score = 0;
        let checks = [];
        
        // 基本HTML構造
        if (content.includes('<!DOCTYPE html>')) { score += 25; checks.push('DOCTYPE'); }
        if (content.includes('<html')) { score += 25; checks.push('HTML'); }
        if (content.includes('<head>')) { score += 25; checks.push('HEAD'); }
        if (content.includes('<body>')) { score += 25; checks.push('BODY'); }

        // ファイル固有チェック
        if (file === 'AdminPanel.html') {
          if (content.includes('save') || content.includes('publish')) { score += 20; checks.push('保存機能'); }
          if (content.includes('sheet') || content.includes('select')) { score += 20; checks.push('シート選択'); }
          if (content.includes('history')) { score += 10; checks.push('履歴'); }
        } else if (file === 'LoginPage.html') {
          if (content.includes('login') || content.includes('email')) { score += 30; checks.push('ログイン機能'); }
        } else if (file === 'AppSetupPage.html') {
          if (content.includes('setup') || content.includes('config')) { score += 30; checks.push('セットアップ機能'); }
        }

        const status = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'error';
        log(file + ': ' + score + '% (' + checks.join(', ') + ')', status);
        addResult(file, status, score + '% - ' + checks.length + '項目確認');
      }
    }

    async function checkJsFiles() {
      log('📜 JavaScriptファイルチェック開始', 'info');
      
      const files = [
        'adminPanel-core.js.html',
        'adminPanel-api.js.html', 
        'adminPanel-events.js.html',
        'page.js.html'
      ];
      
      for (const file of files) {
        const content = await loadFile(file);
        if (!content) {
          addResult(file, 'error', '読み込み失敗');
          continue;
        }

        let score = 0;
        let functions = [];
        
        // 関数の検出
        const functionMatches = content.match(/function\s+([a-zA-Z_$][a-zA-Z0-9_$]*)/g) || [];
        functions = functionMatches.map(f => f.replace('function ', ''));
        score += Math.min(functions.length * 10, 50);

        // エラーハンドリング
        if (content.includes('try') && content.includes('catch')) {
          score += 20;
          functions.push('エラー処理');
        }

        // ファイル固有の関数チェック
        if (file.includes('core')) {
          if (content.includes('adminLog') || content.includes('log')) { 
            score += 15; functions.push('ログ関数'); 
          }
        } else if (file.includes('api')) {
          if (content.includes('runGasWithUserId') || content.includes('api')) { 
            score += 15; functions.push('API関数'); 
          }
        } else if (file.includes('events')) {
          if (content.includes('addEventListener') || content.includes('event')) { 
            score += 15; functions.push('イベント関数'); 
          }
        }

        const status = score >= 70 ? 'success' : score >= 40 ? 'warning' : 'error';
        log(file + ': ' + score + '% (' + functions.length + '個の機能)', status);
        addResult(file, status, score + '% - ' + functions.join(', '));
      }
    }

    async function checkGasFiles() {
      log('⚙️ GASファイルチェック開始', 'info');
      
      const files = ['main.gs', 'Core.gs', 'database.gs', 'config.gs'];
      
      for (const file of files) {
        const content = await loadFile(file);
        if (!content) {
          addResult(file, 'error', '読み込み失敗');
          continue;
        }

        let score = 0;
        let features = [];
        
        // 基本的なGAS機能
        if (content.includes('function')) { score += 20; features.push('関数定義'); }
        if (content.includes('SpreadsheetApp') || content.includes('SheetsApi')) { 
          score += 20; features.push('Sheets API'); 
        }
        if (content.includes('HtmlService')) { score += 20; features.push('HTML Service'); }
        if (content.includes('PropertiesService')) { score += 15; features.push('Properties'); }

        // ファイル固有の重要関数
        const criticalFunctions = {
          'main.gs': ['doGet', 'include'],
          'Core.gs': ['verifyUserAccess', 'getPublishedSheetData'],
          'database.gs': ['createUser', 'updateUser'],
          'config.gs': ['getConfig']
        };

        const required = criticalFunctions[file] || [];
        let found = 0;
        required.forEach(func => {
          if (content.includes('function ' + func)) {
            found++;
            features.push(func);
          }
        });
        
        if (required.length > 0) {
          score += (found / required.length) * 25;
        } else {
          score += 25; // config.gs等の場合
        }

        const status = score >= 75 ? 'success' : score >= 50 ? 'warning' : 'error';
        log(file + ': ' + score + '% (' + found + '/' + required.length + ' 重要関数)', status);
        addResult(file, status, Math.round(score) + '% - ' + features.join(', '));
      }
    }

    async function checkAll() {
      document.getElementById('results').innerHTML = '';
      log('🚀 全ファイル検証開始', 'info');
      
      await checkHtmlFiles();
      await checkJsFiles(); 
      await checkGasFiles();
      
      log('📊 全ファイル検証完了', 'success');
    }

    function clearLog() {
      document.getElementById('console').innerHTML = '';
      document.getElementById('results').innerHTML = '';
    }

    // 初期化
    window.addEventListener('DOMContentLoaded', () => {
      log('🔍 実際の/srcファイル検証システム起動', 'success');
      log('💡 各ボタンをクリックして検証を開始してください', 'info');
    });
  </script>
</body>
</html>