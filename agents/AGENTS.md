承知いたしました。
要件定義書の内容をマークダウン形式で作成します。

---

# 要件定義書：みんなの回答ボード (Ver. 2.0)

**改訂履歴**

| 版 | 日付 | 改訂者 | 概要 |
| :--- | :--- | :--- | :--- |
| 1.0 | 2025/07/04 | Gemini | 初期バージョンの作成 |
| 2.0 | 2025/07/05 | Gemini | 機能要件の拡充、非機能要件（アクセシビリティ、プライバシー等）の追加、画面フローの明記 |

### 1. 概要

本ドキュメントは、Google Apps Script (GAS) と Google Workspace を活用したWebアプリケーション「みんなの回答ボード」のシステム要件を定義するものです。本システムは、教育現場において、生徒の回答をリアルタイムで共有し、双方向のコミュニケーションを促進することを目的としています。

**主な特徴:**

* Googleフォームまたはスプレッドシートからのリアルタイム回答共有
* 生徒によるリアクション機能（いいね！、なるほど！、もっと知りたい！）
* 教師による重要回答のハイライト機能
* サービスアカウントモデルを採用し、セキュリティと安定性を向上
* アクセシビリティ（WCAG 2.1準拠）とプライバシー保護への配慮

### 2. プロジェクトの目的と背景

本プロジェクトは、従来のシステムで発生していた403エラー問題を根本的に解決し、Google Workspace管理者の設定変更を不要にすることを目的としています。単一のGASプロジェクト構成に移行することで、コードベースを約60%削減し、保守性と拡張性を大幅に向上させています。Ver. 2.0では、より多くの教育現場で安心して利用できるよう、機能の拡充と非機能要件の強化を行います。

### 3. システムアーキテクチャ

本システムは、サーバーレスアーキテクチャを採用し、Google Workspaceのサービス群を最大限に活用しています。

* **バックエンド**: **Google Apps Script (GAS)** を利用し、V8ランタイムで動作します。ビジネスロジック、データ処理、API連携を担います。
* **フロントエンド**: **HTML/CSS/JavaScript** で構築されています。UIのスタイリングには**Tailwind CSS**のCDNが利用されます。GASバックエンドとの通信は `google.script.run` 非同期APIを介して行われます。
* **データベース**: **Google Sheets** を主要なデータストアとして使用します。ユーザー情報や設定を管理する中央データベースと、各ユーザーの回答データを保存するスプレッドシートで構成されます。Sheets API v4を直接呼び出すことで高速なデータアクセスを実現しています。
* **認証**:
    * **ユーザー認証**: Googleアカウントによる認証。
    * **API認証**: **サービスアカウントモデル**を採用し、JWT（JSON Web Token）を用いてGoogleの各種APIへ安全にアクセスします。

### 4. 機能要件

#### 4.1. ユーザー管理機能

* **新規ユーザー登録**:
    * ユーザーは初回アクセス時に、自身のGoogleアカウントでシステムに登録できます。
    * 登録プロセスでは、ユーザー専用のGoogleフォームとスプレッドシートが自動で作成されます。
    * 登録が完了すると、ユーザー専用の固定URLが発行され、管理画面へアクセスできるようになります。
* **アクセス制御**:
    * システムは指定されたGoogle Workspaceドメイン内のユーザーのみにアクセスを制限できます。
    * 管理者権限を持つユーザーは、管理機能へのアクセスが許可されます。

#### 4.2. 回答ボード機能 (生徒・閲覧者向け)

* **回答の表示**:
    * 教師が設定したスプレッドシートから回答データを取得し、カード形式で一覧表示します。
    * 表示される回答は、新着順、ランダム順、スコア順などで並び替えが可能です。
    * クラスごとに回答を絞り込んで表示するフィルター機能を有します。
* **リアクション機能**:
    * 各回答カードに対して、「いいね！」「なるほど！」「もっと知りたい！」の3種類のリアクションができます。
    * 自身がリアクションしたボタンはハイライト表示されます。
    * リアクションの総数に応じて、カードの枠線のスタイルが変化します。
* **ハイライト表示**:
    * 教師がハイライト設定した回答は、特別な装飾（枠の色やアイコン）で強調表示されます。
* **モーダル表示**:
    * 回答カードをクリックすると、回答の詳細内容がモーダルウィンドウで表示されます。
* **新着通知**:
    * ボードを表示中に新しい回答が投稿されると、画面上部にバナーで通知されます。

#### 4.3. 管理者機能

* **ボードの作成と管理**:
    * 管理者は、新しい回答ボード（Googleフォームと連携したスプレッドシート）をワンクリックで作成できます。
    * 既存のGoogleスプレッドシートのURLを指定して、回答ボードとして利用することも可能です。
* **公開設定**:
    * 管理者は、回答ボードの公開・非公開を切り替えることができます。
    * 複数のシート（ボード）が存在する場合、生徒に表示するシートを選択できます。
* **表示設定**:
    * **表示モード**: 回答者の名前を表示する「記名モード」と、表示しない「匿名モード」を切り替えられます。
    * **リアクション数**: リアクション数の表示・非表示を切り替えられます。
    * **並び順**: デフォルトの並び順（スコア順、新着順など）を設定できます。
* **列マッピング**:
    * スプレッドシートのどの列を「回答」「理由」「名前」として表示するかを設定画面でマッピングできます。
* **投稿管理**: **(新規)**
    * **投稿の受付制御**: 教師は回答の受付を「開始」「停止」する機能を持つ。停止中はフォームからの投稿ができなくなる。
    * **回答の承認制**: 新しい回答を一旦保留し、教師が承認したものだけをボードに表示させるオプション機能。

### 5. 画面仕様

本システムは、主に以下の4つのHTMLファイルでUIが構成されています。

* **`Page.html`**: 生徒や一般閲覧者向けのメインの回答ボード画面。
* **`AdminPanel.html`**: 教師向けの管理画面。
* **`Registration.html`**: 新規ユーザー登録画面。
* **`SetupPage.html`**: 初回システムセットアップ画面。

#### 5.1. 画面フローと主要な関数

ユーザーの状況に応じて、以下のフローで画面と機能が連携します。すべてのフローはGASの `doGet(e)` 関数を起点とします。

**フロー1: 初回システムセットアップ（システム管理者）**

1.  **アクセス**: 管理者がWebアプリのURLに初めてアクセスする。
2.  **判定**: `doGet(e)` は、システムが未セットアップであると判断し、`showSetupPage()` を呼び出す。
3.  **表示**: `SetupPage.html` が表示される。
4.  **入力**: 管理者はサービスアカウントのJSONキーと中央データベースのスプレッドシートIDを入力する。
5.  **実行**: フォームを送信すると、クライアントサイドJSが `google.script.run` を介してバックエンドの `setupApplication()` を実行し、システムプロパティを保存する。

**フロー2: 新規ユーザー登録（教師）**

1.  **アクセス**: 新規の教師ユーザーがWebアプリのURLにアクセスする。
2.  **判定**: `doGet(e)` は、ユーザーが未登録であると判断し、`showRegistrationPage()` を呼び出す。
3.  **表示**: `Registration.html` が表示される。
4.  **確認**: 画面表示後、クライアントサイドJSが `getExistingBoard()` を呼び出し、登録済みでないことを確認する。
5.  **実行**: ユーザーが「登録して開始」ボタンをクリックすると、`registerNewUser()` が実行され、ユーザー専用のスプレッドシートとフォームが作成される。
6.  **遷移**: 登録完了後、ユーザーは管理画面 (`AdminPanel.html`) にリダイレクトされる。

**フロー3: 管理画面の操作（教師）**

1.  **アクセス**: 登録済みの教師がURLにアクセスする（または登録フローから遷移）。
2.  **判定**: `doGet(e)` は、ユーザーが管理者であると判断し、`showAdminPanel()` を呼び出す。
3.  **表示**: `AdminPanel.html` が表示される。
4.  **情報取得**: 画面表示後、クライアントサイドJSが `getStatus()` を呼び出し、現在のボードの状態（シート一覧、公開設定など）を取得して表示する。
5.  **操作**:
    * **ボード作成**: 「新しいボードを作成」ボタンで `createBoardFromAdmin()` を実行。
    * **シート追加**: URLを入力し、「追加」ボタンで `addSpreadsheetUrl()` を実行。
    * **シート公開**: 公開したいシートを選択し、「このシートをアクティブにする」ボタンで `switchToSheet()` を実行。
    * **設定保存**: 列マッピングを設定し、「設定を保存」ボタンで `saveSheetConfig()` を実行。

**フロー4: 回答ボードの閲覧（生徒・閲覧者）**

1.  **アクセス**: 生徒が教師から共有されたボードのURL（`?userId=...` パラメータ付き）にアクセスする。
2.  **判定**: `doGet(e)` は `userId` を基に `getUserInfo()` でユーザー情報を取得し、ボードが公開中か判断する。
3.  **分岐**:
    * **公開中**: `showBoardPage(userInfo)` を呼び出し、`Page.html` を表示する。
        * 画面表示後、クライアントサイドの `StudyQuestApp` クラスが `getPublishedSheetData()` を実行し、回答データを取得・描画する。
        * 生徒がリアクションすると、`addReaction()` が実行される。
    * **非公開中**: `showUnpublishedPage()` を呼び出し、`Unpublished.html` を表示する。

### 6. データ要件

* **中央データベース (`Users`シート)**: システム全体のユーザー情報を管理するスプレッドシート。以下の情報が含まれます。
    * `userId`: ユーザー固有のID
    * `adminEmail`: ユーザーのメールアドレス
    * `spreadsheetId`: ユーザーが所有する回答データ用スプレッドシートのID
    * `configJson`: ユーザーごとの設定（公開シート名、表示モードなど）
* **回答データシート**: 各ユーザーが所有し、生徒の回答が記録されるスプレッドシート。Googleフォームからの回答が自動的に記録されます。最低限、以下の列が含まれます。
    * タイムスタンプ
    * メールアドレス
    * 回答内容
    * （オプション）クラス、氏名、理由など
    * （システム追加）なるほど！、いいね！、もっと知りたい！、ハイライト

### 7. 非機能要件

#### 7.1. パフォーマンス

* **初期ロード**: 回答ボードの初期表示は**1〜2秒**以内を目指します。
* **データ更新**: リアクションやハイライトなどの操作は**0.5〜1秒**以内に画面に反映されることを目指します。
* **最適化**: バックエンドでは`CacheService`とインメモリキャッシュを組み合わせた多層キャッシュシステムを導入し、API呼び出しを最小限に抑えます。フロントエンドでは、仮想スクロールや遅延読み込み、各種処理の非同期化により、大量データでも軽快な動作を実現します。

#### 7.2. セキュリティ

* **認証**: Googleアカウントによる安全な認証を必須とします。
* **権限管理**: サービスアカウントモデルにより、システムが必要とする最小限の権限（`https://www.googleapis.com/auth/spreadsheets` など）で動作します。ユーザーのデータはユーザー自身が所有し、システムは許可された範囲でのみアクセスします。
* **脆弱性対策**: `HtmlService` のコンテキストエスケープや、全てのユーザー入力の検証により、XSS（クロスサイトスクリプティング）などの脆弱性を防止します。

#### 7.3. 安定性・信頼性

* **エラーハンドリング**: すべての機能において、予期せぬエラーが発生した場合でもシステムが停止しないよう、堅牢なエラーハンドリングを実装します。
* **監視**: `monitor.gs`により、システムのパフォーマンスメトリクスを収集し、問題の早期発見に努めます。
* **自己回復**: `stability.gs`に実装されたサーキットブレーカーやリトライ機構により、一時的な障害からの自動回復を目指します。

### 8. その他の非機能要件 (新規)

#### 8.1. アクセシビリティ (Accessibility)

* **WCAG 2.1準拠**: Web Content Accessibility Guidelines (WCAG) 2.1のレベルAAに準拠することを目指します。
* **キーボード操作**: マウスを使わずに、キーボードのみで全ての主要な操作（回答の閲覧、リアクション、設定変更など）が完結できるようにします。
* **スクリーンリーダー対応**: `aria-label`や`role`属性を適切に使用し、スクリーンリーダー利用者がコンテンツの構造や意味を正確に理解できるようにします。
* **コントラスト比**: テキストと背景のコントラスト比を4.5:1以上に保ち、視認性を確保します。

#### 8.2. 国際化と地域化 (i18n / L10n)

* **多言語対応**: UI上のテキスト（ボタン、ラベル、メッセージなど）を外部リソースファイル（例: JSON形式）で管理し、将来的には英語などの他言語へ容易に対応できる構造とします。
* **タイムゾーン**: 日時表示は、`appsscript.json`で設定されたタイムゾーン（`Asia/Tokyo`）に基づき、一貫性のある形式で表示します。

#### 8.3. プライバシーとデータ管理

* **プライバシーポリシー**: アプリケーション内で、収集するデータの内容、利用目的、保存期間などを明記したプライバシーポリシーを閲覧できるようにします。
* **データ所有権**: ユーザーが作成したスプレッドシートやフォームの所有権は、常にユーザー自身にあることを明確にします。
* **データ削除**: ユーザーが自身の回答データを削除する手順を提供します（例: スプレッドシートからの行削除）。

### 9. 既知の制約事項と今後の課題

* **クライアントサイドの関数呼び出しエラー**: `google.script.run`でサーバーサイド関数を呼び出す際に、デプロイやキャッシュの問題で `TypeError: ... is not a function` エラーが発生することがあります。これは、GASプロジェクトの再デプロイやブラウザキャッシュのクリアで解決されます。
* **今後の機能拡張案**:
    * AI/MLを活用したコンテンツの要約やキーワード抽出機能
    * ボードの利用状況に関する高度な分析機能
    * リアルタイム共同編集機能（例: 他のユーザーのカーソル表示）

---