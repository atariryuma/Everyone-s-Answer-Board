承知いたしました。
提供された「Developer Documentation」と既存の「要件定義書」を統合し、指定されたセクションを除外した上で、完全な要件定義書をMarkdown形式で作成します。

---

# **要件定義書：みんなの回答ボード**

### 1. 概要

本ドキュメントは、Google Apps Script (GAS) と Google Workspace を活用したWebアプリケーション「みんなの回答ボード」のシステム要件を定義するものです。本システムは、教育現場において、生徒の回答をリアルタイムで共有し、双方向のコミュニケーションを促進することを目的としています。

#### 1.1. 基本理念と設計原則

アプリケーションの成功は、ユーザーを最優先する強い理念に基づいています。

* **ユーザーの安全性と信頼**: ユーザーが安心して情報を共有し、対話できる安全な環境を構築します。
* **包括性**: 多様なユーザー層を考慮し、誰にとってもアクセシブルで使いやすいデザインを目指します。
* **共感的なインタラクション**: 明確で、前向きかつ繊細なコミュニケーションを可能にする機能を実装します。
* **直感的なUI/UX**:
    * **シンプルさ**: 不要な複雑さを避け、クリーンで分かりやすいインターフェースを提供します。
    * **視覚的階層**: 「グラスモーフィズム」のようなモダンなデザイン技術を用いて奥行きを演出し、ユーザーの視線を誘導します（例: `.glass-panel` クラス）。
    * **アクセシビリティ**: 全てのユーザーをサポートするため、高いコントラスト、可読性の高いフォント、キーボード操作の可能性を確保します。

### 2. プロジェクトの目的と背景

本プロジェクトは、従来のシステムで発生していた403エラー問題を根本的に解決し、Google Workspace管理者の設定変更を不要にすることを目的としています。 単一のGASプロジェクト構成に移行することで、コードベースを約60%削減し、保守性と拡張性を大幅に向上させています。

### 3. システムアーキテクチャ

本システムは、サーバーレスアーキテクチャを採用し、Google Workspaceのサービス群を最大限に活用しています。

* **バックエンド**: **Google Apps Script (GAS)** を利用し、V8ランタイムで動作します。ビジネスロジック、データ処理、API連携を担います。
* **フロントエンド**: **HTML/CSS/JavaScript** で構築されています。UIのスタイリングには**Tailwind CSS**のCDNが利用されます。 GASバックエンドとの通信は `google.script.run` 非同期APIを介して行われ、`ClientOptimizer.html` によって最適化されています。
* **データベース**: **Google Sheets** を主要なデータストアとして使用します。 ユーザー情報や設定を管理する中央データベースと、各ユーザーの回答データを保存するスプレッドシートで構成されます。Sheets API v4を直接呼び出すことで高速なデータアクセスを実現しています。
* **認証**:
    * **ユーザー認証**: Googleアカウントによる認証。
    * **API認証**: **サービスアカウントモデル**を採用し、JWT（JSON Web Token）を用いてGoogleの各種APIへ安全にアクセスします。これにより、従来の403エラーを解決し、単一GASプロジェクトへのデプロイを簡素化しています。
* **開発ツール**:
    * **`clasp`**: GASプロジェクトをローカルで管理するための公式コマンドラインツール。
    * **`jest`**: クライアントサイドのロジックの信頼性を確保するためのJavaScriptテストフレームワーク。

### 4. 機能要件

#### 4.1. ユーザー管理機能

* **新規ユーザー登録**:
    * ユーザーは初回アクセス時に、自身のGoogleアカウントでシステムに登録できます。
    * 登録プロセスでは、ユーザー専用のGoogleフォームとスプレッドシートが自動で作成されます。
    * 登録が完了すると、ユーザー専用の固定URLが発行され、管理画面へアクセスできるようになります。
    * １人のユーザーに対して、1つの固定URLを付与します。
* **アクセス制御**:
    * システムは指定されたGoogle Workspaceドメイン内のユーザーのみにアクセスを制限できます。
    * 管理者権限を持つユーザーは、管理機能へのアクセスが許可されます。

#### 4.2. 回答ボード機能 (生徒・閲覧者向け)

* **回答の表示**:
    * 教師が設定したスプレッドシートから回答データを取得し、カード形式で一覧表示します。
    * 表示される回答は、新着順、ランダム順、スコア順などで並び替えが可能です。
    * クラスごとに回答を絞り込んで表示するフィルター機能を有します。
* **リアクション機能**:
    * 各回答カードに対して、「いいね！」「なるほど！」「もっと知りたい！」の3種類のリアクションができます。
    * 自身がリアクションしたボタンはハイライト表示されます。
    * リアクションの総数に応じて、カードの枠線のスタイルが変化します。
* **ハイライト表示**:
    * 教師がハイライト設定した回答は、特別な装飾（枠の色やアイコン）で強調表示されます。
* **モーダル表示**:
    * 回答カードをクリックすると、回答の詳細内容がモーダルウィンドウで表示されます。
* **新着通知**:
    * ボードを表示中に新しい回答が投稿されると、画面上部にバナーで通知されます。

#### 4.3. 管理者機能

* **ボードの作成と管理**:
    * 管理者は、新しい回答ボード（Googleフォームと連携したスプレッドシート）をワンクリックで作成できます。
    * 既存のGoogleスプレッドシートのURLを指定して、回答ボードとして利用することも可能です。
* **公開設定**:
    * 管理者は、回答ボードの公開・非公開を切り替えることができます。
    * 複数のシート（ボード）が存在する場合、生徒に表示するシートを選択できます。
* **表示設定**:
    * **表示モード**: 回答者の名前を表示する「記名モード」と、表示しない「匿名モード」を切り替えられます。
    * **リアクション数**: リアクション数の表示・非表示を切り替えられます。
    * **並び順**: デフォルトの並び順（スコア順、新着順など）を設定できます。
* **列マッピング**:
    * スプレッドシートのどの列を「回答」「理由」「名前」として表示するかを設定画面でマッピングできます。

### 5. 画面仕様

本システムは、主に以下の4つのHTMLファイルでUIが構成されています。

* **`Page.html`**: 生徒や一般閲覧者向けのメインの回答ボード画面です。
* **`AdminPanel.html`**: 教師向けの管理画面です。
* **`Registration.html`**: 新規ユーザー登録画面です。
* **`SetupPage.html`**: 初回システムセットアップ画面です。

#### 5.1. 画面フローと主要な関数

ユーザーの状況に応じて、以下のフローで画面と機能が連携します。すべてのフローはGASの `doGet(e)` 関数を起点とします。

**フロー1: 初回システムセットアップ（システム管理者）**

1.  **アクセス**: 管理者がWebアプリのURLに初めてアクセスする。
2.  **判定**: `doGet(e)` は、システムが未セットアップであると判断し、`SetupPage.html` を表示する。
3.  **実行**: 管理者がサービスアカウント情報を入力し送信すると、クライアントサイドJSが `google.script.run` を介して `setupApplication()` を実行する。

**フロー2: 新規ユーザー登録（教師）**

1.  **アクセス**: 新規の教師ユーザーがWebアプリのURLにアクセスする。
2.  **判定**: `doGet(e)` は、ユーザーが未登録であると判断し、`Registration.html` を表示する。
3.  **確認**: 画面表示後、クライアントサイドJSが `getExistingBoard()` を呼び出し、登録済みでないことを確認する。
4.  **実行**: ユーザーが「登録して開始」ボタンをクリックすると、`registerNewUser()` が実行される。
5.  **遷移**: 登録完了後、管理画面 (`AdminPanel.html`) にリダイレクトされる。

**フロー3: 管理画面の操作（教師）**

1.  **アクセス**: 登録済みの教師がURLにアクセスする。
2.  **判定**: `doGet(e)` は、ユーザーが管理者であると判断し、`AdminPanel.html` を表示する。
3.  **情報取得**: 画面表示後、クライアントサイドJSが `getStatus()` を呼び出し、現在のボードの状態を取得して表示する。
4.  **操作**:
    * **ボード作成**: `createBoardFromAdmin()` を実行。
    * **シート追加**: `addSpreadsheetUrl()` を実行。
    * **シート公開**: `switchToSheet()` を実行。
    * **設定保存**: `saveSheetConfig()` を実行。

**フロー4: 回答ボードの閲覧（生徒・閲覧者）**

1.  **アクセス**: 生徒が教師から共有されたボードのURLにアクセスする。
2.  **判定**: `doGet(e)` はボードが公開中か判断する。
3.  **分岐**:
    * **公開中**: `Page.html` を表示する。
        * クライアントサイドの `StudyQuestApp` クラスが `getPublishedSheetData()` を実行し回答データを取得・描画する。
        * 生徒がリアクションすると、`addReaction()` が実行される。
    * **非公開中**: `Unpublished.html` を表示する。

### 6. データ要件

* **中央データベース (`Users`シート)**: システム全体のユーザー情報を管理するスプレッドシート。
    * `userId`: ユーザー固有のID
    * `adminEmail`: ユーザーのメールアドレス
    * `spreadsheetId`: ユーザーが所有する回答データ用スプレッドシートのID
    * `configJson`: ユーザーごとの設定（公開シート名、表示モードなど）
* **回答データシート**: 各ユーザーが所有し、生徒の回答が記録されるスプレッドシート。
    * 必須列: タイムスタンプ, メールアドレス, 回答内容
    * オプション列: クラス, 氏名, 理由など
    * システム追加列: なるほど！, いいね！, もっと知りたい！, ハイライト

### 7. 非機能要件

#### 7.1. パフォーマンス

* **高速なレスポンス**:
    * 初期ロード: **1〜2秒**
    * データ更新: **0.5〜1秒**
* **最適化**:
    * バックエンドでは`CacheService`とインメモリキャッシュを組み合わせた多層キャッシュシステムを導入し、API呼び出しを最小限に抑えます。
    * フロントエンドでは、仮想スクロール、遅延読み込み、非同期処理により、大量データでも軽快な動作を実現します。

#### 7.2. セキュリティ

* **認証**: Googleアカウントによる安全な認証を必須とします。
* **権限管理**: サービスアカウントモデルにより、システムが必要とする最小限の権限で動作します。ユーザーデータはユーザー自身が所有します。
* **脆弱性対策**: `HtmlService` のコンテキストエスケープや、全てのユーザー入力の検証により、XSS（クロスサイトスクリプティング）などの脆弱性を防止します。
* **シークレット管理**: APIキーなどの機密情報は `PropertiesService` を使用して安全に保管し、コード内に直接記述しません。

#### 7.3. 安定性・信頼性

* **エラーハンドリング**: すべての機能において、堅牢なエラーハンドリングを実装し、ユーザーフレンドリーなメッセージを表示します。
* **監視**: `monitor.gs`により、システムのパフォーマンスメトリクスを収集し、問題の早期発見に努めます。
* **自己回復**: `stability.gs`に実装されたサーキットブレーカーやリトライ機構により、一時的な障害からの自動回復を目指します。

### 8. その他の非機能要件

#### 8.1. アクセシビリティ (Accessibility)

* **WCAG 2.1準拠**: レベルAAを目標とします。
* **キーボード操作**: 全ての主要な操作をキーボードのみで完結できるようにします。
* **スクリーンリーダー対応**: `aria-label`や`role`属性を適切に使用し、コンテンツの構造と意味が伝わるようにします。
* **コントラスト比**: テキストと背景のコントラスト比を確保し、視認性を高めます。

#### 8.2. 国際化と地域化 (i18n / L10n)

* **多言語対応**: UI上のテキストを外部リソースファイルで管理し、他言語への対応が容易な構造とします。
* **タイムゾーン**: 日時表示は `appsscript.json` で設定されたタイムゾーン（`Asia/Tokyo`）に統一します。

#### 8.3. プライバシーとデータ管理

* **プライバシーポリシー**: アプリケーション内で、収集データの内容、利用目的、保存期間などを明記したポリシーを閲覧できるようにします。
* **データ所有権**: ユーザーが作成したスプレッドシートやフォームの所有権は、常にユーザー自身にあることを明確にします。
* **データ削除**: ユーザーが自身のデータを削除する手順を提供します。

### 9. 既知の制約事項と今後の課題

* **クライアントサイドの関数呼び出しエラー**: `google.script.run`でサーバーサイド関数を呼び出す際に、デプロイやキャッシュの問題で `TypeError: ...[funcName] is not a function` エラーが発生することがあります。これは、GASプロジェクトの再デプロイやブラウザキャッシュのクリアで解決されます。
* **今後の機能拡張案**:
    * AI/MLを活用したコンテンツの要約やキーワード抽出機能
    * ボードの利用状況に関する高度な分析機能

---