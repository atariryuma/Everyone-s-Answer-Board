承知いたしました。
要件定義書（Ver. 3.0）のすべての内容を、標準のマークダウン形式で作成します。

---

# 要件定義書：みんなの回答ボード (Ver. 3.0)

**改訂履歴**

| 版 | 日付 | 改訂者 | 概要 |
| :--- | :--- | :--- | :--- |
| 1.0 | 2025/07/04 | Gemini | 初期バージョンの作成 |
| 2.0 | 2025/07/05 | Gemini | 機能要件の拡充、非機能要件の追加、画面フローの明記 |
| 2.1 | 2025/07/05 | Gemini | フロー4（回答ボード閲覧）の詳細化 |
| 3.0 | 2025/07/05 | Gemini | 開発者向けに、ユーザー体験向上と運用保守性強化のための要件を網羅的に追加 |

### 1. 概要

本ドキュメントは、Google Apps Script (GAS) と Google Workspace を活用したWebアプリケーション「みんなの回答ボード」のシステム要件を定義するものです。本システムは、教育現場において、生徒の回答をリアルタイムで共有し、双方向のコミュニケーションを促進することを目的としています。

#### 1.1. 基本理念と設計原則

アプリケーションの成功は、ユーザーを最優先する強い理念に基づいています。

* **ユーザーの安全性と信頼**: ユーザーが安心して情報を共有し、対話できる安全な環境を構築します。
* **包括性**: 多様なユーザー層を考慮し、誰にとってもアクセシブルで使いやすいデザインを目指します。
* **共感的なインタラクション**: 明確で、前向きかつ繊細なコミュニケーションを可能にする機能を実装します。
* **直感的なUI/UX**:
    * **シンプルさ**: 不要な複雑さを避け、クリーンで分かりやすいインターフェースを提供します。
    * **視覚的階層**: 「グラスモーフィズム」のようなモダンなデザイン技術を用いて奥行きを演出し、ユーザーの視線を誘導します（例: `.glass-panel` クラス）。
    * **アクセシビリティ**: 全てのユーザーをサポートするため、高いコントラスト、可読性の高いフォント、キーボード操作の可能性を確保します。

### 2. プロジェクトの目的と背景

本プロジェクトは、従来のシステムで発生していた403エラー問題を根本的に解決し、Google Workspace管理者の設定変更を不要にすることを目的としています。 単一のGASプロジェクト構成に移行することで、コードベースを約60%削減し、保守性と拡張性を大幅に向上させています。Ver. 3.0では、開発者視点からアプリケーションの価値を最大化するため、パーソナライゼーション、運用性、スケーラビリティに関する要件を強化します。

### 3. システムアーキテクチャ

本システムは、サーバーレスアーキテクチャを採用し、Google Workspaceのサービス群を最大限に活用しています。

* **バックエンド**: **Google Apps Script (GAS)** を利用し、V8ランタイムで動作します。ビジネスロジック、データ処理、API連携を担います。
* **フロントエンド**: **HTML/CSS/JavaScript** で構築されています。UIのスタイリングには**Tailwind CSS**のCDNが利用されます。 GASバックエンドとの通信は `google.script.run` 非同期APIを介して行われ、`ClientOptimizer.html` によって最適化されています。
* **データベース**: **Google Sheets** を主要なデータストアとして使用します。 ユーザー情報や設定を管理する中央データベースと、各ユーザーの回答データを保存するスプレッドシートで構成されます。Sheets API v4を直接呼び出すことで高速なデータアクセスを実現しています。
* **認証**:
    * **ユーザー認証**: Googleアカウントによる認証。
    * **API認証**: **サービスアカウントモデル**を採用し、JWT（JSON Web Token）を用いてGoogleの各種APIへ安全にアクセスします。

### 4. 機能要件

#### 4.1. ユーザー管理機能

* **新規ユーザー登録**:
    * ユーザーは初回アクセス時に、自身のGoogleアカウントでシステムに登録できます。
    * 登録プロセスでは、ユーザー専用のGoogleフォームとスプレッドシートが自動で作成されます。
    * 登録が完了すると、ユーザー専用の固定URLが発行され、管理画面へアクセスできるようになります。
* **アクセス制御**:
    * システムは指定されたGoogle Workspaceドメイン内のユーザーのみにアクセスを制限できます。
    * 管理者権限を持つユーザーは、管理機能へのアクセスが許可されます。
* **アカウント管理 (新規)**:
    * **アカウント情報表示**: ユーザーは自身の登録情報（メールアドレス、登録日など）を管理画面で確認できる。
    * **アカウントの無効化**: ユーザーは自身の判断でアカウントを無効化（論理削除）できる機能。再有効化も可能とする。

#### 4.2. 回答ボード機能 (生徒・閲覧者向け)

* **回答の表示**:
    * 教師が設定したスプレッドシートから回答データを取得し、カード形式で一覧表示します。
    * 表示される回答は、新着順、ランダム順、スコア順などで並び替えが可能です。
    * クラスごとに回答を絞り込んで表示するフィルター機能を有します。
* **リアクション機能**:
    * 各回答カードに対して、「いいね！」「なるほど！」「もっと知りたい！」の3種類のリアクションができます。
    * 自身がリアクションしたボタンはハイライト表示されます。
    * リアクションの総数に応じて、カードの枠線のスタイルが変化します。
* **ハイライト表示**:
    * 教師がハイライト設定した回答は、特別な装飾（枠の色やアイコン）で強調表示されます。
* **モーダル表示**:
    * 回答カードをクリックすると、回答の詳細内容がモーダルウィンドウで表示されます。
* **新着通知**:
    * ボードを表示中に新しい回答が投稿されると、画面上部にバナーで通知されます。
* **回答の検索機能 (新規)**:
    * 回答カード内のテキスト（回答、理由など）を対象としたキーワード検索機能を実装する。検索結果はリアルタイムでフィルタリング表示される。

#### 4.3. 管理者機能

* **ボードの作成と管理**:
    * 管理者は、新しい回答ボード（Googleフォームと連携したスプレッドシート）をワンクリックで作成できます。
    * 既存のGoogleスプレッドシートのURLを指定して、回答ボードとして利用することも可能です。
* **公開設定**:
    * 管理者は、回答ボードの公開・非公開を切り替えることができます。
    * 複数のシート（ボード）が存在する場合、生徒に表示するシートを選択できます。
* **表示設定**:
    * **表示モード**: 回答者の名前を表示する「記名モード」と、表示しない「匿名モード」を切り替えられます。
    * **リアクション数**: リアクション数の表示・非表示を切り替えられます。
    * **並び順**: デフォルトの並び順（スコア順、新着順など）を設定できます。
* **列マッピング**:
    * スプレッドシートのどの列を「回答」「理由」「名前」として表示するかを設定画面でマッピングできます。

### 5. 画面仕様とフロントエンドフロー

本システムは、主に以下の4つのHTMLファイルでUIが構成されています。

* **`SetupPage.html`**: 初回システムセットアップ画面。
* **`Registration.html`**: 新規ユーザー登録画面。
* **`AdminPanel.html`**: 教師向けの管理画面。
* **`Page.html`**: 生徒や一般閲覧者向けのメインの回答ボード画面。

#### 5.1. 画面フロー概要

ユーザーの状況に応じて、以下のフローで画面と機能が連携します。すべてのフローはGASの `doGet(e)` 関数を起点とします。

* **フロー1 (初回セットアップ)**: `doGet()` -> `SetupPage.html` -> `setupApplication()`
* **フロー2 (新規ユーザー登録)**: `doGet()` -> `Registration.html` -> `registerNewUser()` -> `AdminPanel.html` へ遷移
* **フロー3 (管理者操作)**: `doGet()` -> `AdminPanel.html` -> `getStatus()`, `switchToSheet()` 等
* **フロー4 (生徒の閲覧)**: `doGet()` -> `Page.html` -> `getPublishedSheetData()`

#### 5.2. 設定（コンフィグ）の管理フロー

各シート（ボード）の列マッピング設定は、中央データベースに保存され、必要に応じて読み出されます。

**設定の保存フロー (`saveSheetConfig`)**

1.  **トリガー**: 教師が `AdminPanel.html` で特定のシートに対する列のマッピング（回答、理由、名前、クラス列）を選択し、「設定を保存」ボタンをクリックします。
2.  **クライアントサイド処理**:
    a. `saveConfig()` 関数が実行されます。
    b. `google.script.run.saveSheetConfig(sheetName, configObject)` を呼び出し、選択されたシート名と設定オブジェクトをサーバーに送信します。
3.  **サーバーサイド処理 (`saveSheetConfig`)**:
    a. 現在のユーザーIDを基に、中央データベース（`Users`シート）から該当ユーザーの行を特定します。
    b. 既存の `configJson` を取得し、新しい設定で更新します。
    c. 更新された設定オブジェクト全体を `JSON.stringify` で文字列に変換します。
    d. 中央データベースの該当ユーザー行にある `configJson` 列を、新しいJSON文字列で上書き保存します。

**設定の読み取りフロー (`getConfig`)**

1.  **トリガー**: `Page.html`（ボード表示時）または `AdminPanel.html`（管理画面表示時）のデータ読み込み時に実行されます。
2.  **サーバーサイド処理**:
    a. `doGet`、`getStatus`、`getPublishedSheetData` などの関数が、まず `getUserInfo(userId)` を呼び出して中央データベースからユーザー情報を取得します。この情報には `configJson` が含まれています。
    b. `getConfig(sheetName)` 関数が、この `configJson` を `JSON.parse` で解析し、引数で指定されたシート名に対応する設定オブジェクト（列マッピング情報）を返します。
3.  **利用場面**:
    * **`AdminPanel.html`**: `loadConfigForSelected()` が `getConfig` を呼び出し、返された設定オブジェクトを使ってUIのドロップダウンの選択状態を復元します。
    * **`Page.html`**: `getPublishedSheetData` が内部で `getConfig` を利用し、どの列から回答、理由、名前などのデータを取得すべきかを判断し、スプレッドシートから正しいデータを取得します。

#### 5.3. 詳細フロントエンドフロー

**フロー1: 初回システムセットアップ (`SetupPage.html`)**

1.  **サーバーサイド**: `doGet(e)` はシステムプロパティが存在しないことを確認し、`SetupPage.html` を返します。
2.  **クライアントサイド**: 管理者がサービスアカウント情報とDBのIDを入力し、`google.script.run.setupApplication()` を実行します。
    * **キャッシュ/リアルタイム**: このフローは一回限りのため、キャッシュやリアルタイム更新は行いません。

**フロー2: 新規ユーザー登録 (`Registration.html`)**

1.  **サーバーサイド**: `doGet(e)` はユーザーが未登録と判断し、`Registration.html` を返します。
2.  **クライアントサイド**: `google.script.run.getExistingBoard()` を実行し、未登録であることを確認します。
    * **キャッシュ**: `getExistingBoard` はサーバーサイドでユーザー情報をキャッシュし、DBへの不要なアクセスを削減します。
    * **リアルタイム**: `registerNewUser()` 実行後、管理画面へリダイレクトされます。リアルタイム通知は行いません。

**フロー3: 管理画面 (`AdminPanel.html`)**

1.  **サーバーサイド**: `doGet(e)` はユーザーが管理者と判断し、`AdminPanel.html` を返します。
2.  **クライアントサイド (初期化)**:
    * `google.script.run.getStatus()` を呼び出し、システム状態を一括取得します。
    * **キャッシュ**: `getStatus()` はサーバーサイドで変更頻度の低いデータ（シート一覧など）をキャッシュから取得し、レスポンスを高速化します。
3.  **クライアントサイド (操作)**:
    * **シート切り替え/設定保存**: `switchToSheet()` や `saveSheetConfig()` を実行後、`loadStatus()` を再度呼び出して画面全体を最新情報に更新します。
    * **キャッシュ**: 管理画面での操作は常にサーバーの最新情報を正とするため、クライアントサイドでのデータキャッシュは行いません。
    * **リアルタイム**: 管理画面での操作は、生徒側の画面には次回のポーリング時に変更が検知されます。

**フロー4: 回答ボード閲覧 (`Page.html`)**

1.  **サーバーサイド**: `doGet(e)` はボードが公開中であることを確認し、`Page.html` を動的に生成して返します。
2.  **クライアントサイド (初期化)**:
    * `StudyQuestApp` クラスが初期化されます。
    * **非同期データ取得**: `google.script.run.getPublishedSheetData()` を呼び出します。
    * **キャッシュ (サーバー)**: `getPublishedSheetData` は、ヘッダー情報などのメタデータをサーバーキャッシュから読み込みます。回答データ自体は都度スプレッドシートから取得します。
    * **初期描画**: データ取得を待つ間、スケルトンUIを表示します。
3.  **クライアントサイド (描画)**:
    * **キャッシュ (クライアント)**: `createAnswerCard()` は、一度生成したカードのHTMLをクライアントキャッシュに保存し、データが変更されていないカードは再利用して描画を高速化します。
4.  **クライアントサイド (ユーザー操作とリアルタイム更新)**:
    * **リアクション/ハイライト**: `handleReaction()` / `handleHighlight()` が実行されます。
        * **楽観的UI**: ユーザーのアクションは即座にUIに反映されます。
        * **非同期更新**: バックグラウンドで `addReaction()` / `toggleHighlight()` が実行され、サーバー上のデータを更新します。
    * **新着通知 (ポーリング)**:
        * 15〜30秒ごとに `checkForNewContent()` が実行されます。
        * **リアルタイム**: この関数は回答数のみを比較し、新着があった場合のみユーザーに更新を促すバナーを表示します。ボードの自動リロードは行いません。

### 6. データ要件

* **中央データベース (`Users`シート)**: `userId`, `adminEmail`, `spreadsheetId`, `configJson`
    * `configJson` には、各シートの設定に加え、カスタマイズ機能（テーマカラー、カスタムリアクション）の設定もJSON形式で保存する。
* **回答データシート**: タイムスタンプ, メールアドレス, 回答内容, （オプション）クラス, 氏名, 理由, （システム追加）各リアクション列, ハイライト列

### 7. 非機能要件

#### 7.1. パフォーマンス

* **初期ロード**: **1〜2秒**以内
* **データ更新**: **0.5〜1秒**以内
* **最適化**: サーバー/クライアント両サイドでのキャッシュ、仮想スクロール、非同期処理。

#### 7.2. セキュリティ

* **認証**: Googleアカウント認証
* **権限管理**: サービスアカウントモデルによる最小権限の原則
* **脆弱性対策**: XSS対策、入力値検証

#### 7.3. 安定性・信頼性

* **エラーハンドリング**: 堅牢なエラーハンドリングとユーザーへのフィードバック
* **監視**: パフォーマンスメトリクスの収集
* **自己回復**: サーキットブレーカー、リトライ機構

#### 7.4. 拡張性と保守性 (新規)

* **モジュール性**: 機能ごとにGASファイルを分割（`core.gs`, `database.gs`など）し、疎結合を維持する。
* **コーディング規約**: Google JavaScript Style Guideに準拠し、コードの可読性と一貫性を保つ。
* **ドキュメンテーション**: JSDoc形式で関数やクラスの仕様をコード内に記述し、ドキュメントの自動生成を可能にする。

#### 7.5. バックアップとリカバリ (新規)

* **設定のバックアップ**: 中央データベースのスプレッドシートは、Google Driveの機能によりバージョン履歴が自動で保存される。重要な変更前には、手動でのコピー作成を推奨プロセスとする。
* **リカバリ**: 重大な障害発生時は、スプレッドシートのバージョン履歴から特定時点の設定に復元する手順をドキュメント化する。

### 8. その他の非機能要件

#### 8.1. アクセシビリティ (Accessibility)

* **WCAG 2.1準拠**: レベルAAを目標。
* **キーボード操作**: 全ての主要な操作がキーボードのみで可能。
* **スクリーンリーダー対応**: `aria-label`や`role`属性の適切な使用。
* **コントラスト比**: 4.5:1以上を確保。

#### 8.2. 国際化と地域化 (i18n / L10n)

* **多言語対応**: UIテキストを外部リソースファイルで管理。
* **タイムゾーン**: `appsscript.json`の設定に基づき日時を統一。

#### 8.3. プライバシーとデータ管理

* **プライバシーポリシー**: アプリ内で閲覧可能にする。
* **データ所有権**: ユーザーが所有権を持つことを明記。
* **データ削除**: ユーザーがデータを削除する手順を提供。

### 9. 既知の制約事項と今後の課題

* **クライアントサイドの関数呼び出しエラー**: GASのデプロイ/キャッシュに起因するエラー。再デプロイやキャッシュクリアで対応。
