<? if (typeof title !== 'undefined' && title) { ?>
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><?= title || 'ã‚¨ãƒ©ãƒ¼' ?> - ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰</title>
    <?!= HtmlService.createHtmlOutputFromFile('UnifiedStyles.css').getContent(); ?>
    <script>
      // âœ… ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰è‡ªå·±å®Œçµæ–¹å¼: SharedUtilitiesæ´»ç”¨ + å®Œå…¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      function safeReload() {
        // SharedUtilitiesãŒåˆ©ç”¨å¯èƒ½ãªã‚‰å„ªå…ˆä½¿ç”¨
        if (window.sharedUtilities?.page?.safeReload) {
          return window.sharedUtilities.page.safeReload();
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªå®‰å…¨ãƒªãƒ­ãƒ¼ãƒ‰
        try {
          localStorage.removeItem('current_user_info');
          sessionStorage.clear();
          window.location.reload(true);
        } catch (e) {
          window.location.href = window.location.href;
        }
      }

      function redirectToLogin() {
        // SharedUtilitiesãŒåˆ©ç”¨å¯èƒ½ãªã‚‰å„ªå…ˆä½¿ç”¨
        if (window.sharedUtilities?.auth?.logout) {
          return window.sharedUtilities.auth.logout();
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        try {
          const url = new URL(window.location.href);
          url.searchParams.set('mode', 'login');
          url.searchParams.delete('userId');
          window.location.href = url.toString();
        } catch (e) {
          window.location.href = window.location.origin + window.location.pathname + '?mode=login';
        }
      }

      // ã‚·ãƒ³ãƒ—ãƒ«ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆErrorBoundaryç‰ˆï¼‰
      function showSimpleError(message) {
        if (!message) return;

        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤
        const existingModal = document.getElementById('simple-error-modal');
        if (existingModal) existingModal.remove();

        // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«
        const modalHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="simple-error-modal">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 text-white">
              <div class="flex items-center mb-4">
                <span class="text-2xl mr-3">âŒ</span>
                <h3 class="text-lg font-semibold">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
              </div>
              <p class="text-gray-300 mb-6">${message}</p>
              <div class="text-right">
                <button onclick="document.getElementById('simple-error-modal').remove()"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                  OK
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
      window.showSimpleError = showSimpleError;
    </script>
  </head>
  <body style="background: var(--brand-background); color: var(--brand-text);" class="font-sans error-page">
    <!-- Notification Container for unified notification system -->
    <div id="notification-container" class="fixed top-4 right-4 z-[10000] space-y-2"></div>
    <div class="error-container">
      <div class="error-icon">âš ï¸</div>
      <h1 class="error-title"><?= htmlEncode(title || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ') ?></h1>
      <p class="error-message">
        <?= htmlEncode(message || 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚') ?>
      </p>

      <div class="error-actions">
        <button type="button" class="btn btn-primary" onclick="try { safeReload(); } catch(e) { location.reload(); }">
          ğŸ”„ å†èª­ã¿è¾¼ã¿
        </button>
        <? if (!hideLoginButton) { ?>
        <button type="button" class="btn btn-secondary" onclick="try { redirectToLogin(); } catch(e) { location.href='?mode=login'; }">
          ğŸ  ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
        </button>
        <? } ?>
      </div>

      <? if (typeof debugInfo !== 'undefined' && debugInfo) { ?>
      <div class="debug-info">
        <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br />
        <?= htmlEncode(debugInfo) ?>
      </div>
      <? } ?>

      <div class="timestamp">ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚åˆ»: <?= new Date().toLocaleString('ja-JP') ?></div>
    </div>
  </body>
</html>
<? } ?>