<!-- Comprehensive Error Boundary System -->
<script>
(function() {
  // Global error boundary configuration
  const ERROR_BOUNDARY_CONFIG = {
    maxRetries: 3,
    retryDelay: 1000,
    enableReporting: true,
    fallbackUI: true,
    autoRecover: true
  };
  
  // Error categories
  const ERROR_CATEGORIES = {
    NETWORK: 'network',
    AUTHENTICATION: 'authentication',
    PERMISSION: 'permission',
    API: 'api',
    JAVASCRIPT: 'javascript',
    TEMPLATE: 'template',
    GOOGLE_SCRIPT: 'google_script',
    TIMEOUT: 'timeout',
    UNKNOWN: 'unknown'
  };
  
  // Error boundary state
  let errorBoundaryState = {
    errors: [],
    retryCount: 0,
    lastError: null,
    recoveryMode: false
  };
  
  // Categorize errors based on message and context
  const categorizeError = (error, context) => {
    const message = error.message || error.toString();
    const lowerMessage = message.toLowerCase();
    
    if (lowerMessage.includes('network') || lowerMessage.includes('fetch')) {
      return ERROR_CATEGORIES.NETWORK;
    } else if (lowerMessage.includes('auth') || lowerMessage.includes('token') || lowerMessage.includes('credential')) {
      return ERROR_CATEGORIES.AUTHENTICATION;
    } else if (lowerMessage.includes('permission') || lowerMessage.includes('access')) {
      return ERROR_CATEGORIES.PERMISSION;
    } else if (lowerMessage.includes('api') || lowerMessage.includes('googleapis')) {
      return ERROR_CATEGORIES.API;
    } else if (lowerMessage.includes('timeout') || lowerMessage.includes('timed out')) {
      return ERROR_CATEGORIES.TIMEOUT;
    } else if (lowerMessage.includes('google.script') || lowerMessage.includes('apps script')) {
      return ERROR_CATEGORIES.GOOGLE_SCRIPT;
    } else if (lowerMessage.includes('template') || lowerMessage.includes('include')) {
      return ERROR_CATEGORIES.TEMPLATE;
    } else if (error instanceof TypeError || error instanceof ReferenceError) {
      return ERROR_CATEGORIES.JAVASCRIPT;
    } else {
      return ERROR_CATEGORIES.UNKNOWN;
    }
  };
  
  // Enhanced error handler with recovery strategies
  const handleError = (error, context, recoveryOptions = {}) => {
    const errorInfo = {
      timestamp: new Date().toISOString(),
      message: error.message || error.toString(),
      category: categorizeError(error, context),
      context: context || 'unknown',
      stack: error.stack,
      userAgent: navigator.userAgent,
      url: window.location.href,
      sessionId: getSessionId(),
      recovery: recoveryOptions
    };
    
    // Store error in boundary state
    errorBoundaryState.errors.push(errorInfo);
    errorBoundaryState.lastError = errorInfo;
    
    // Detailed logging
    console.group('🚨 Error Boundary Triggered');
    console.error('Error:', error);
    console.log('Category:', errorInfo.category);
    console.log('Context:', errorInfo.context);
    console.log('Recovery Options:', recoveryOptions);
    console.groupEnd();
    
    // Attempt recovery based on error category
    attemptRecovery(errorInfo, recoveryOptions);
    
    // Report error if enabled
    if (ERROR_BOUNDARY_CONFIG.enableReporting) {
      reportError(errorInfo);
    }
    
    return errorInfo;
  };
  
  // Recovery strategies based on error category
  const attemptRecovery = (errorInfo, recoveryOptions) => {
    const { category } = errorInfo;
    
    switch (category) {
      case ERROR_CATEGORIES.NETWORK:
        return handleNetworkError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.AUTHENTICATION:
        return handleAuthError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.GOOGLE_SCRIPT:
        return handleGoogleScriptError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.TIMEOUT:
        return handleTimeoutError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.JAVASCRIPT:
        return handleJavaScriptError(errorInfo, recoveryOptions);
      default:
        return handleGenericError(errorInfo, recoveryOptions);
    }
  };
  
  // Network error recovery
  const handleNetworkError = (errorInfo, recoveryOptions) => {
    console.log('🔄 Attempting network error recovery...');
    
    if (errorBoundaryState.retryCount < ERROR_BOUNDARY_CONFIG.maxRetries) {
      errorBoundaryState.retryCount++;
      
      setTimeout(() => {
        if (recoveryOptions.retryCallback) {
          console.log('🔄 Retrying network operation...');
          recoveryOptions.retryCallback();
        } else {
          console.log('🔄 Reloading page for network recovery...');
          window.location.reload();
        }
      }, ERROR_BOUNDARY_CONFIG.retryDelay * errorBoundaryState.retryCount);
      
      return true;
    }
    
    showErrorUI('ネットワークエラーが発生しました。接続を確認してください。', 'network');
    return false;
  };
  
  // Authentication error recovery
  const handleAuthError = (errorInfo, recoveryOptions) => {
    console.log('🔄 Attempting authentication error recovery...');
    
    if (recoveryOptions.reauthenticate) {
      console.log('🔄 Triggering re-authentication...');
      recoveryOptions.reauthenticate();
      return true;
    }
    
    showErrorUI('認証エラーが発生しました。再度ログインしてください。', 'auth');
    return false;
  };
  
  // Google Apps Script error recovery
  const handleGoogleScriptError = (errorInfo, recoveryOptions) => {
    console.log('🔄 Attempting Google Apps Script error recovery...');
    
    // Try to reload Google Apps Script context
    if (typeof google !== 'undefined' && google.script) {
      console.log('🔄 Google Apps Script context available, retrying...');
      
      setTimeout(() => {
        if (recoveryOptions.retryCallback) {
          recoveryOptions.retryCallback();
        }
      }, ERROR_BOUNDARY_CONFIG.retryDelay);
      
      return true;
    }
    
    showErrorUI('Google Apps Scriptエラーが発生しました。ページを再読み込みしてください。', 'google-script');
    return false;
  };
  
  // Timeout error recovery
  const handleTimeoutError = (errorInfo, recoveryOptions) => {
    console.log('🔄 Attempting timeout error recovery...');
    
    if (errorBoundaryState.retryCount < ERROR_BOUNDARY_CONFIG.maxRetries) {
      errorBoundaryState.retryCount++;
      
      setTimeout(() => {
        if (recoveryOptions.retryCallback) {
          console.log('🔄 Retrying after timeout...');
          recoveryOptions.retryCallback();
        }
      }, ERROR_BOUNDARY_CONFIG.retryDelay * 2); // Longer delay for timeouts
      
      return true;
    }
    
    showErrorUI('処理がタイムアウトしました。再試行してください。', 'timeout');
    return false;
  };
  
  // JavaScript error recovery
  const handleJavaScriptError = (errorInfo, recoveryOptions) => {
    console.log('🔄 Attempting JavaScript error recovery...');
    
    // Try to recover from common JavaScript errors
    if (errorInfo.message.includes('undefined') || errorInfo.message.includes('null')) {
      console.log('🔄 Attempting to recover from null/undefined error...');
      
      if (recoveryOptions.fallbackCallback) {
        recoveryOptions.fallbackCallback();
        return true;
      }
    }
    
    showErrorUI('JavaScriptエラーが発生しました。ページを再読み込みしてください。', 'javascript');
    return false;
  };
  
  // Generic error recovery
  const handleGenericError = (errorInfo, recoveryOptions) => {
    console.log('🔄 Attempting generic error recovery...');
    
    if (recoveryOptions.fallbackCallback) {
      recoveryOptions.fallbackCallback();
      return true;
    }
    
    showErrorUI('エラーが発生しました。ページを再読み込みしてください。', 'generic');
    return false;
  };
  
  // Show error UI to user
  const showErrorUI = (message, category) => {
    if (!ERROR_BOUNDARY_CONFIG.fallbackUI) return;
    
    // Remove existing error UI
    const existingError = document.getElementById('error-boundary-ui');
    if (existingError) {
      existingError.remove();
    }
    
    // Create error UI
    const errorUI = document.createElement('div');
    errorUI.id = 'error-boundary-ui';
    errorUI.innerHTML = `
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: #fee2e2;
        color: #dc2626;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #fecaca;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10000;
        max-width: 400px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span style="font-size: 18px;">⚠️</span>
          <strong>エラーが発生しました</strong>
        </div>
        <p style="margin: 0 0 12px 0; font-size: 14px;">${message}</p>
        <div style="display: flex; gap: 8px;">
          <button onclick="window.location.reload()" style="
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
          ">再読み込み</button>
          <button onclick="document.getElementById('error-boundary-ui').remove()" style="
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
          ">閉じる</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(errorUI);
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
      if (document.getElementById('error-boundary-ui')) {
        document.getElementById('error-boundary-ui').remove();
      }
    }, 10000);
  };
  
  // Report error to server (if available)
  const reportError = (errorInfo) => {
    try {
      // Only report if Google Apps Script is available
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withFailureHandler((error) => {
            console.warn('Failed to report error to server:', error);
          })
          .reportClientError && google.script.run.reportClientError(errorInfo);
      }
    } catch (e) {
      console.warn('Error reporting failed:', e);
    }
  };
  
  // Get or create session ID
  const getSessionId = () => {
    let sessionId = sessionStorage.getItem('error-boundary-session');
    if (!sessionId) {
      sessionId = Date.now().toString(36) + Math.random().toString(36).substr(2);
      sessionStorage.setItem('error-boundary-session', sessionId);
    }
    return sessionId;
  };
  
  // Enhanced Promise wrapper with error boundary
  const wrapWithErrorBoundary = (promise, context, recoveryOptions = {}) => {
    return promise.catch(error => {
      return handleError(error, context, recoveryOptions);
    });
  };
  
  // Enhanced function wrapper with error boundary
  const wrapFunctionWithErrorBoundary = (fn, context, recoveryOptions = {}) => {
    return function(...args) {
      try {
        const result = fn.apply(this, args);
        
        // Handle promise results
        if (result && typeof result.then === 'function') {
          return wrapWithErrorBoundary(result, context, recoveryOptions);
        }
        
        return result;
      } catch (error) {
        return handleError(error, context, recoveryOptions);
      }
    };
  };
  
  // Set up global error handlers
  const setupGlobalErrorHandlers = () => {
    // Global unhandled error handler
    window.addEventListener('error', (event) => {
      handleError(event.error || new Error(event.message), 'global', {
        retryCallback: () => console.log('Global error retry not implemented')
      });
    });
    
    // Global unhandled promise rejection handler
    window.addEventListener('unhandledrejection', (event) => {
      handleError(event.reason || new Error('Unhandled promise rejection'), 'promise', {
        retryCallback: () => console.log('Promise rejection retry not implemented')
      });
    });
    
    // Google Apps Script specific error handler
    if (typeof google !== 'undefined' && google.script) {
      const originalRun = google.script.run;
      google.script.run = new Proxy(originalRun, {
        get: function(target, prop) {
          if (typeof target[prop] === 'function') {
            return wrapFunctionWithErrorBoundary(target[prop], 'google-script', {
              retryCallback: () => console.log('Google Script retry triggered')
            });
          }
          return target[prop];
        }
      });
    }
  };
  
  // Initialize error boundary system
  const initErrorBoundary = () => {
    console.log('🛡️ Error Boundary System initialized');
    setupGlobalErrorHandlers();
  };
  
  // Expose error boundary utilities globally
  window.ErrorBoundary = {
    handleError,
    wrapWithErrorBoundary,
    wrapFunctionWithErrorBoundary,
    state: errorBoundaryState,
    config: ERROR_BOUNDARY_CONFIG,
    categories: ERROR_CATEGORIES
  };
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initErrorBoundary);
  } else {
    initErrorBoundary();
  }
})();
</script>