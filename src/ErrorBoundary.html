<!-- Comprehensive Error Boundary System -->
<script>
(function() {
  // Global error boundary configuration
  const ERROR_BOUNDARY_CONFIG = {
    maxRetries: 3,
    retryDelay: 1000,
    enableReporting: true,
    fallbackUI: true,
    autoRecover: true
  };
  
  // Error categories
  const ERROR_CATEGORIES = {
    NETWORK: 'network',
    AUTHENTICATION: 'authentication',
    PERMISSION: 'permission',
    API: 'api',
    JAVASCRIPT: 'javascript',
    TEMPLATE: 'template',
    GOOGLE_SCRIPT: 'google_script',
    TIMEOUT: 'timeout',
    UNKNOWN: 'unknown'
  };
  
  // Error boundary state
  let errorBoundaryState = {
    errors: [],
    retryCount: 0,
    lastError: null,
    recoveryMode: false
  };
  
  // Categorize errors based on message and context
  const categorizeError = (error, context) => {
    const message = error.message || error.toString();
    const lowerMessage = message.toLowerCase();
    
    if (lowerMessage.includes('network') || lowerMessage.includes('fetch')) {
      return ERROR_CATEGORIES.NETWORK;
    } else if (lowerMessage.includes('auth') || lowerMessage.includes('token') || lowerMessage.includes('credential')) {
      return ERROR_CATEGORIES.AUTHENTICATION;
    } else if (lowerMessage.includes('permission') || lowerMessage.includes('access')) {
      return ERROR_CATEGORIES.PERMISSION;
    } else if (lowerMessage.includes('api') || lowerMessage.includes('googleapis')) {
      return ERROR_CATEGORIES.API;
    } else if (lowerMessage.includes('timeout') || lowerMessage.includes('timed out')) {
      return ERROR_CATEGORIES.TIMEOUT;
    } else if (lowerMessage.includes('google.script') || lowerMessage.includes('apps script')) {
      return ERROR_CATEGORIES.GOOGLE_SCRIPT;
    } else if (lowerMessage.includes('template') || lowerMessage.includes('include')) {
      return ERROR_CATEGORIES.TEMPLATE;
    } else if (error instanceof TypeError || error instanceof ReferenceError) {
      return ERROR_CATEGORIES.JAVASCRIPT;
    } else {
      return ERROR_CATEGORIES.UNKNOWN;
    }
  };
  
  // Enhanced error handler with recovery strategies
  const handleError = (error, context, recoveryOptions = {}) => {
    const errorInfo = {
      timestamp: new Date().toISOString(),
      message: error.message || error.toString(),
      category: categorizeError(error, context),
      context: context || 'unknown',
      stack: error.stack,
      userAgent: navigator.userAgent,
      url: window.location.href,
      sessionId: getSessionId(),
      recovery: recoveryOptions
    };
    
    // Store error in boundary state
    errorBoundaryState.errors.push(errorInfo);
    errorBoundaryState.lastError = errorInfo;
    
    // Detailed logging
    console.group('ğŸš¨ Error Boundary Triggered');
    console.error('Error:', error);
    console.log('Category:', errorInfo.category);
    console.log('Context:', errorInfo.context);
    console.log('Recovery Options:', recoveryOptions);
    console.groupEnd();
    
    // Attempt recovery based on error category
    attemptRecovery(errorInfo, recoveryOptions);
    
    // Report error if enabled
    if (ERROR_BOUNDARY_CONFIG.enableReporting) {
      reportError(errorInfo);
    }
    
    return errorInfo;
  };
  
  // Recovery strategies based on error category
  const attemptRecovery = (errorInfo, recoveryOptions) => {
    const { category } = errorInfo;
    
    switch (category) {
      case ERROR_CATEGORIES.NETWORK:
        return handleNetworkError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.AUTHENTICATION:
        return handleAuthError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.GOOGLE_SCRIPT:
        return handleGoogleScriptError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.TIMEOUT:
        return handleTimeoutError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.JAVASCRIPT:
        return handleJavaScriptError(errorInfo, recoveryOptions);
      default:
        return handleGenericError(errorInfo, recoveryOptions);
    }
  };
  
  // Network error recovery
  const handleNetworkError = (errorInfo, recoveryOptions) => {
    console.log('ğŸ”„ Attempting network error recovery...');
    
    if (errorBoundaryState.retryCount < ERROR_BOUNDARY_CONFIG.maxRetries) {
      errorBoundaryState.retryCount++;
      
      setTimeout(() => {
        if (recoveryOptions.retryCallback) {
          console.log('ğŸ”„ Retrying network operation...');
          recoveryOptions.retryCallback();
        } else {
          console.log('ğŸ”„ Reloading page for network recovery...');
          window.location.reload();
        }
      }, ERROR_BOUNDARY_CONFIG.retryDelay * errorBoundaryState.retryCount);
      
      return true;
    }
    
    showErrorUI('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'network');
    return false;
  };
  
  // Authentication error recovery
  const handleAuthError = (errorInfo, recoveryOptions) => {
    console.log('ğŸ”„ Attempting authentication error recovery...');
    
    if (recoveryOptions.reauthenticate) {
      console.log('ğŸ”„ Triggering re-authentication...');
      recoveryOptions.reauthenticate();
      return true;
    }
    
    showErrorUI('èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'auth');
    return false;
  };
  
  // Google Apps Script error recovery
  const handleGoogleScriptError = (errorInfo, recoveryOptions) => {
    console.log('ğŸ”„ Attempting Google Apps Script error recovery...');
    
    // Try to reload Google Apps Script context
    if (typeof google !== 'undefined' && google.script) {
      console.log('ğŸ”„ Google Apps Script context available, retrying...');
      
      setTimeout(() => {
        if (recoveryOptions.retryCallback) {
          recoveryOptions.retryCallback();
        }
      }, ERROR_BOUNDARY_CONFIG.retryDelay);
      
      return true;
    }
    
    showErrorUI('Google Apps Scriptã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'google-script');
    return false;
  };
  
  // Timeout error recovery
  const handleTimeoutError = (errorInfo, recoveryOptions) => {
    console.log('ğŸ”„ Attempting timeout error recovery...');
    
    if (errorBoundaryState.retryCount < ERROR_BOUNDARY_CONFIG.maxRetries) {
      errorBoundaryState.retryCount++;
      
      setTimeout(() => {
        if (recoveryOptions.retryCallback) {
          console.log('ğŸ”„ Retrying after timeout...');
          recoveryOptions.retryCallback();
        }
      }, ERROR_BOUNDARY_CONFIG.retryDelay * 2); // Longer delay for timeouts
      
      return true;
    }
    
    showErrorUI('å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚', 'timeout');
    return false;
  };
  
  // JavaScript error recovery
  const handleJavaScriptError = (errorInfo, recoveryOptions) => {
    console.log('ğŸ”„ Attempting JavaScript error recovery...');
    
    // Try to recover from common JavaScript errors
    if (errorInfo.message.includes('undefined') || errorInfo.message.includes('null')) {
      console.log('ğŸ”„ Attempting to recover from null/undefined error...');
      
      if (recoveryOptions.fallbackCallback) {
        recoveryOptions.fallbackCallback();
        return true;
      }
    }
    
    showErrorUI('JavaScriptã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'javascript');
    return false;
  };
  
  // Generic error recovery
  const handleGenericError = (errorInfo, recoveryOptions) => {
    console.log('ğŸ”„ Attempting generic error recovery...');
    
    if (recoveryOptions.fallbackCallback) {
      recoveryOptions.fallbackCallback();
      return true;
    }
    
    showErrorUI('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'generic');
    return false;
  };
  
  // Show error UI to user
  const showErrorUI = (message, category) => {
    if (!ERROR_BOUNDARY_CONFIG.fallbackUI) return;
    
    // Remove existing error UI
    const existingError = document.getElementById('error-boundary-ui');
    if (existingError) {
      existingError.remove();
    }
    
    // Create error UI
    const errorUI = document.createElement('div');
    errorUI.id = 'error-boundary-ui';
    errorUI.innerHTML = `
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: #fee2e2;
        color: #dc2626;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #fecaca;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10000;
        max-width: 400px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span style="font-size: 18px;">âš ï¸</span>
          <strong>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong>
        </div>
        <p style="margin: 0 0 12px 0; font-size: 14px;">${message}</p>
        <div style="display: flex; gap: 8px;">
          <button onclick="window.location.reload()" style="
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
          ">å†èª­ã¿è¾¼ã¿</button>
          <button onclick="document.getElementById('error-boundary-ui').remove()" style="
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
          ">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(errorUI);
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
      if (document.getElementById('error-boundary-ui')) {
        document.getElementById('error-boundary-ui').remove();
      }
    }, 10000);
  };
  
  // Report error to server (if available)
  const reportError = (errorInfo) => {
    try {
      // Only report if Google Apps Script is available
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withFailureHandler((error) => {
            console.warn('Failed to report error to server:', error);
          })
          .reportClientError && google.script.run.reportClientError(errorInfo);
      }
    } catch (e) {
      console.warn('Error reporting failed:', e);
    }
  };
  
  // Get or create session ID
  const getSessionId = () => {
    let sessionId = sessionStorage.getItem('error-boundary-session');
    if (!sessionId) {
      sessionId = Date.now().toString(36) + Math.random().toString(36).substr(2);
      sessionStorage.setItem('error-boundary-session', sessionId);
    }
    return sessionId;
  };
  
  // Enhanced Promise wrapper with error boundary
  const wrapWithErrorBoundary = (promise, context, recoveryOptions = {}) => {
    return promise.catch(error => {
      return handleError(error, context, recoveryOptions);
    });
  };
  
  // Enhanced function wrapper with error boundary
  const wrapFunctionWithErrorBoundary = (fn, context, recoveryOptions = {}) => {
    return function(...args) {
      try {
        const result = fn.apply(this, args);
        
        // Handle promise results
        if (result && typeof result.then === 'function') {
          return wrapWithErrorBoundary(result, context, recoveryOptions);
        }
        
        return result;
      } catch (error) {
        return handleError(error, context, recoveryOptions);
      }
    };
  };
  
  // Set up global error handlers
  const setupGlobalErrorHandlers = () => {
    // Global unhandled error handler
    window.addEventListener('error', (event) => {
      handleError(event.error || new Error(event.message), 'global', {
        retryCallback: () => console.log('Global error retry not implemented')
      });
    });
    
    // Global unhandled promise rejection handler
    window.addEventListener('unhandledrejection', (event) => {
      handleError(event.reason || new Error('Unhandled promise rejection'), 'promise', {
        retryCallback: () => console.log('Promise rejection retry not implemented')
      });
    });
    
    // Google Apps Script specific error handler
    if (typeof google !== 'undefined' && google.script) {
      const originalRun = google.script.run;
      google.script.run = new Proxy(originalRun, {
        get: function(target, prop) {
          if (typeof target[prop] === 'function') {
            return wrapFunctionWithErrorBoundary(target[prop], 'google-script', {
              retryCallback: () => console.log('Google Script retry triggered')
            });
          }
          return target[prop];
        }
      });
    }
  };
  
  // Initialize error boundary system
  const initErrorBoundary = () => {
    console.log('ğŸ›¡ï¸ Error Boundary System initialized');
    setupGlobalErrorHandlers();
  };
  
  // Expose error boundary utilities globally
  window.ErrorBoundary = {
    handleError,
    wrapWithErrorBoundary,
    wrapFunctionWithErrorBoundary,
    state: errorBoundaryState,
    config: ERROR_BOUNDARY_CONFIG,
    categories: ERROR_CATEGORIES
  };
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initErrorBoundary);
  } else {
    initErrorBoundary();
  }
})();
</script>

<!-- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºéƒ¨åˆ† -->
<? if (typeof title !== 'undefined' && title) { ?>
<? var loginUrl = getWebAppUrl(); ?>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= title || 'ã‚¨ãƒ©ãƒ¼' ?> - StudyQuest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }
        .error-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        .error-title {
            font-size: 24px;
            font-weight: bold;
            color: #e53e3e;
            margin-bottom: 16px;
        }
        .error-message {
            font-size: 16px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 24px;
        }
        .error-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        .btn-secondary:hover {
            background: #edf2f7;
        }
        .debug-info {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            text-align: left;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #495057;
            max-height: 200px;
            overflow-y: auto;
        }
        .timestamp {
            color: #6c757d;
            font-size: 12px;
            margin-top: 16px;
        }
    </style>
    <script>
        // å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹é–¢æ•°
        function forceLogoutAndRedirect() {
            console.log('ğŸ”„ å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’é–‹å§‹...');
            console.log('ğŸ“ ç¾åœ¨ã®URL:', window.location.href);
            
            // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼šæ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã„ã‚‹å ´åˆã¯å˜ç´”ã«ãƒªãƒ­ãƒ¼ãƒ‰
            if (window.location.href.includes('mode=login')) {
                console.log('âš ï¸ æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
                window.location.reload();
                return;
            }
            
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
            const logoutBtn = event.target;
            const originalText = logoutBtn.innerHTML;
            logoutBtn.disabled = true;
            logoutBtn.innerHTML = 'ğŸ”„ å‡¦ç†ä¸­...';
            
            try {
                // Google Apps Script ã® resetUserAuthentication ã‚’å‘¼ã³å‡ºã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
                google.script.run
                    .withSuccessHandler(function(loginUrl) {
                        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢æˆåŠŸ:', loginUrl);
                        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢å¾Œã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                        if (loginUrl) {
                            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºå®Ÿã«è¿½åŠ 
                            const finalLoginUrl = ensureLoginMode(loginUrl);
                            console.log('ğŸ”§ æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³URL:', finalLoginUrl);
                            performFrameAwareRedirect(finalLoginUrl);
                        } else {
                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç¾åœ¨ã®URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                            handleLogoutFallback();
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.warn('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢ã«å¤±æ•—:', error);
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
                        handleLogoutFallback();
                    })
                    .resetUserAuthentication();
                    
            } catch (error) {
                console.error('âŒ å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
                handleLogoutFallback();
            }
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºå®Ÿã«è¿½åŠ ã™ã‚‹é–¢æ•°
        function ensureLoginMode(url) {
            try {
                const urlObj = new URL(url);
                
                // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®ã¾ã¾è¿”ã™
                if (urlObj.searchParams.has('mode')) {
                    console.log('ğŸ” æ—¢å­˜ã®modeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', urlObj.searchParams.get('mode'));
                    return url;
                }
                
                // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                urlObj.searchParams.set('mode', 'login');
                const finalUrl = urlObj.toString();
                console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’è¿½åŠ :', finalUrl);
                return finalUrl;
                
            } catch (urlError) {
                console.warn('âš ï¸ URLè§£æã«å¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†:', urlError);
                // URLè§£æã«å¤±æ•—ã—ãŸå ´åˆã¯ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ã§è¿½åŠ 
                const separator = url.includes('?') ? '&' : '?';
                return url + separator + 'mode=login';
            }
        }
        
        // iframeå¯¾å¿œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆé–¢æ•°ï¼ˆGoogle Apps Script Sandboxåˆ¶é™å¯¾å¿œï¼‰
        function performFrameAwareRedirect(url) {
            console.log('ğŸ”„ ãƒ•ãƒ¬ãƒ¼ãƒ å¯¾å¿œãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œ...', url);
            
            // Google Apps Scriptç’°å¢ƒã‚’æ¤œå‡º
            const isGoogleAppsScript = window.location.hostname.includes('script.google.com') ||
                                     window.location.href.includes('script.googleusercontent.com') ||
                                     typeof google !== 'undefined' && google.script;
            
            if (isGoogleAppsScript) {
                console.log('ğŸ”§ Google Apps Scriptç’°å¢ƒã‚’æ¤œå‡º - æœ€é©åŒ–ã•ã‚ŒãŸãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                // Google Apps Scriptç’°å¢ƒã§ã¯éšå±¤çš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥ã‚’ä½¿ç”¨
                performGASOptimizedRedirect(url);
            } else {
                console.log('ğŸŒ é€šå¸¸ç’°å¢ƒ - æ¨™æº–ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                try {
                    window.location.href = url;
                } catch (error) {
                    console.warn('âš ï¸ é€šå¸¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«å¤±æ•—:', error);
                    performGASOptimizedRedirect(url);
                }
            }
        }
        
        // Google Apps Scriptæœ€é©åŒ–ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆéšå±¤çš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        function performGASOptimizedRedirect(url) {
            console.log('ğŸ¯ GASæœ€é©åŒ–ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œ...', url);
            
            // ç¬¬1å€™è£œ: window.top.location.hrefï¼ˆæœ€ã‚‚å®‰å…¨ã§æ¨å¥¨ã•ã‚Œã‚‹æ–¹æ³•ï¼‰
            try {
                console.log('ğŸ” Top frameã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè©¦è¡Œ');
                window.top.location.href = url;
                return;
            } catch (topError) {
                console.warn('âš ï¸ Top frameé·ç§»ã«å¤±æ•—:', topError);
            }
            
            // ç¬¬2å€™è£œ: window.parent.location.href
            try {
                if (window.parent !== window) {
                    console.log('ğŸ‘† Parent frameã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè©¦è¡Œ');
                    window.parent.location.href = url;
                    return;
                }
            } catch (parentError) {
                console.warn('âš ï¸ Parent frameé·ç§»ã«å¤±æ•—:', parentError);
            }
            
            // ç¬¬3å€™è£œ: ç¾åœ¨ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ç›´æ¥ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            try {
                console.log('ğŸ”„ Current windowã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè©¦è¡Œ');
                window.location.href = url;
                return;
            } catch (currentError) {
                console.warn('âš ï¸ Current windowé·ç§»ã«å¤±æ•—:', currentError);
            }
            
            // ç¬¬4å€™è£œ: æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
            try {
                console.log('ğŸ†• æ–°ã—ã„ã‚¿ãƒ–ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    // æ–°ã—ã„ã‚¿ãƒ–ãŒé–‹ã‘ãŸå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
                    setTimeout(() => {
                        if (confirm('æ–°ã—ã„ã‚¿ãƒ–ã§ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’é–‹ãã¾ã—ãŸã€‚ã“ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã¾ã™ã‹ï¼Ÿ')) {
                            window.close();
                        }
                    }, 1000);
                } else {
                    throw new Error('æ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ï¼Ÿï¼‰');
                }
                return;
            } catch (openError) {
                console.error('âŒ æ–°ã—ã„ã‚¿ãƒ–ã§ã®é·ç§»ã‚‚å¤±æ•—:', openError);
            }
            
            // æœ€çµ‚æ‰‹æ®µ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰‹å‹•æ“ä½œã‚’æ±‚ã‚ã‚‹
            console.error('âŒ å…¨ã¦ã®è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹æ³•ãŒå¤±æ•—');
            const userAction = confirm(
                'ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ã®è‡ªå‹•ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n' +
                'ä»¥ä¸‹ã®æ–¹æ³•ã‚’ãŠè©¦ã—ãã ã•ã„ï¼š\n' +
                'â€¢ [OK] ã‚’ã‚¯ãƒªãƒƒã‚¯: URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¦æ‰‹å‹•ã§ç§»å‹•\n' +
                'â€¢ [ã‚­ãƒ£ãƒ³ã‚»ãƒ«] ã‚’ã‚¯ãƒªãƒƒã‚¯: ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿\n\n' +
                'URL: ' + url
            );
            
            if (userAction) {
                // URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ï¼ˆå¯èƒ½ã§ã‚ã‚Œã°ï¼‰
                try {
                    navigator.clipboard.writeText(url).then(() => {
                        alert('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚\næ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã„ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                    }).catch(() => {
                        prompt('ä»¥ä¸‹ã®URLã‚’æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã„ã¦ãã ã•ã„:', url);
                    });
                } catch (clipboardError) {
                    prompt('ä»¥ä¸‹ã®URLã‚’æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã„ã¦ãã ã•ã„:', url);
                }
            } else {
                window.location.reload();
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ï¼šç›´æ¥ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        function handleLogoutFallback() {
            console.log('ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè¡Œ...');
            try {
                // ç¾åœ¨ã®URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒ™ãƒ¼ã‚¹URLã‚’å–å¾—
                const baseUrl = window.location.origin + window.location.pathname;
                console.log('ğŸ“ ãƒ™ãƒ¼ã‚¹URL:', baseUrl);
                
                // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºå®Ÿã«è¿½åŠ 
                const loginUrl = ensureLoginMode(baseUrl);
                console.log('ğŸ“ æœ€çµ‚ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆ:', loginUrl);
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                if (typeof sessionStorage !== 'undefined') {
                    sessionStorage.clear();
                }
                if (typeof localStorage !== 'undefined') {
                    localStorage.clear();
                }
                
                // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                performFrameAwareRedirect(loginUrl);
                
            } catch (fallbackError) {
                console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã§ã‚‚ã‚¨ãƒ©ãƒ¼:', fallbackError);
                // æœ€çµ‚æ‰‹æ®µï¼šãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰
                alert('ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
                window.location.reload();
            }
        }
    </script>
</head>
<body>
    <div class="error-container">
        <div class="error-icon">âš ï¸</div>
        <h1 class="error-title"><?= htmlEncode(title || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ') ?></h1>
        <p class="error-message"><?= htmlEncode(message || 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚') ?></p>
        
        <div class="error-actions">
            <button class="btn btn-primary" onclick="location.reload()">
                ğŸ”„ å†èª­ã¿è¾¼ã¿
            </button>
            <button class="btn btn-secondary" onclick="forceLogoutAndRedirect()">
                ğŸ  ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
            </button>
        </div>
        
        <? if (typeof debugInfo !== 'undefined' && debugInfo) { ?>
        <div class="debug-info">
            <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
            <?= htmlEncode(debugInfo) ?>
        </div>
        <? } ?>
        
        <div class="timestamp">
            ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚åˆ»: <?= new Date().toLocaleString('ja-JP') ?>
        </div>
    </div>
</body>
</html>
<? } ?>