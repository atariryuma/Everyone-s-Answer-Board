<!-- Comprehensive Error Boundary System -->
<script>
(function() {
  // Global error boundary configuration
  const ERROR_BOUNDARY_CONFIG = {
    maxRetries: 3,
    retryDelay: 1000,
    enableReporting: true,
    fallbackUI: true,
    autoRecover: true
  };
  
  // Error categories
  const ERROR_CATEGORIES = {
    NETWORK: 'network',
    AUTHENTICATION: 'authentication',
    PERMISSION: 'permission',
    API: 'api',
    JAVASCRIPT: 'javascript',
    TEMPLATE: 'template',
    GOOGLE_SCRIPT: 'google_script',
    TIMEOUT: 'timeout',
    UNKNOWN: 'unknown'
  };
  
  // Error boundary state
  let errorBoundaryState = {
    errors: [],
    retryCount: 0,
    lastError: null,
    recoveryMode: false
  };
  
  // Categorize errors based on message and context
  const categorizeError = (error, context) => {
    const message = error.message || error.toString();
    const lowerMessage = message.toLowerCase();
    
    if (lowerMessage.includes('network') || lowerMessage.includes('fetch')) {
      return ERROR_CATEGORIES.NETWORK;
    } else if (lowerMessage.includes('auth') || lowerMessage.includes('token') || lowerMessage.includes('credential')) {
      return ERROR_CATEGORIES.AUTHENTICATION;
    } else if (lowerMessage.includes('permission') || lowerMessage.includes('access')) {
      return ERROR_CATEGORIES.PERMISSION;
    } else if (lowerMessage.includes('api') || lowerMessage.includes('googleapis')) {
      return ERROR_CATEGORIES.API;
    } else if (lowerMessage.includes('timeout') || lowerMessage.includes('timed out')) {
      return ERROR_CATEGORIES.TIMEOUT;
    } else if (lowerMessage.includes('google.script') || lowerMessage.includes('apps script')) {
      return ERROR_CATEGORIES.GOOGLE_SCRIPT;
    } else if (lowerMessage.includes('template') || lowerMessage.includes('include')) {
      return ERROR_CATEGORIES.TEMPLATE;
    } else if (error instanceof TypeError || error instanceof ReferenceError) {
      return ERROR_CATEGORIES.JAVASCRIPT;
    } else {
      return ERROR_CATEGORIES.UNKNOWN;
    }
  };
  
  // Enhanced error handler with recovery strategies
  const handleError = (error, context, recoveryOptions = {}) => {
    const errorInfo = {
      timestamp: new Date().toISOString(),
      message: error.message || error.toString(),
      category: categorizeError(error, context),
      context: context || 'unknown',
      stack: error.stack,
      userAgent: navigator.userAgent,
      url: window.location.href,
      sessionId: getSessionId(),
      recovery: recoveryOptions
    };
    
    // Store error in boundary state
    errorBoundaryState.errors.push(errorInfo);
    errorBoundaryState.lastError = errorInfo;
    
    // Detailed logging
    console.group('ğŸš¨ Error Boundary Triggered');
    console.error('Error:', error);
    console.log('Category:', errorInfo.category);
    console.log('Context:', errorInfo.context);
    console.log('Recovery Options:', recoveryOptions);
    console.groupEnd();
    
    // Attempt recovery based on error category
    attemptRecovery(errorInfo, recoveryOptions);
    
    // Report error if enabled
    if (ERROR_BOUNDARY_CONFIG.enableReporting) {
      reportError(errorInfo);
    }
    
    return errorInfo;
  };
  
  // Recovery strategies based on error category
  const attemptRecovery = (errorInfo, recoveryOptions) => {
    const { category } = errorInfo;
    
    switch (category) {
      case ERROR_CATEGORIES.NETWORK:
        return handleNetworkError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.AUTHENTICATION:
        return handleAuthError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.GOOGLE_SCRIPT:
        return handleGoogleScriptError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.TIMEOUT:
        return handleTimeoutError(errorInfo, recoveryOptions);
      case ERROR_CATEGORIES.JAVASCRIPT:
        return handleJavaScriptError(errorInfo, recoveryOptions);
      default:
        return handleGenericError(errorInfo, recoveryOptions);
    }
  };
  
  // Network error recovery
  const handleNetworkError = (errorInfo, recoveryOptions) => {
    console.log('ğŸ”„ Attempting network error recovery...');
    
    if (errorBoundaryState.retryCount < ERROR_BOUNDARY_CONFIG.maxRetries) {
      errorBoundaryState.retryCount++;
      
      setTimeout(() => {
        if (recoveryOptions.retryCallback) {
          console.log('ğŸ”„ Retrying network operation...');
          recoveryOptions.retryCallback();
        } else {
          console.log('ğŸ”„ Reloading page for network recovery...');
          window.location.reload();
        }
      }, ERROR_BOUNDARY_CONFIG.retryDelay * errorBoundaryState.retryCount);
      
      return true;
    }
    
    showErrorUI('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'network');
    return false;
  };
  
  // Authentication error recovery
  const handleAuthError = (errorInfo, recoveryOptions) => {
    console.log('ğŸ”„ Attempting authentication error recovery...');
    
    if (recoveryOptions.reauthenticate) {
      console.log('ğŸ”„ Triggering re-authentication...');
      recoveryOptions.reauthenticate();
      return true;
    }
    
    showErrorUI('èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'auth');
    return false;
  };
  
  // Google Apps Script error recovery
  const handleGoogleScriptError = (errorInfo, recoveryOptions) => {
    if (typeof logInfo === 'function') {
      logInfo('Attempting Google Apps Script error recovery...');
    } else {
      console.log('ğŸ”„ Attempting Google Apps Script error recovery...');
    }
    
    // Try to reload Google Apps Script context
    if (typeof google !== 'undefined' && google.script) {
      if (typeof logInfo === 'function') {
        logInfo('Google Apps Script context available, retrying...');
      } else {
        console.log('ğŸ”„ Google Apps Script context available, retrying...');
      }
      
      setTimeout(() => {
        if (recoveryOptions.retryCallback) {
          recoveryOptions.retryCallback();
        }
      }, ERROR_BOUNDARY_CONFIG.retryDelay);
      
      return true;
    }
    
    showErrorUI('Google Apps Scriptã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'google-script');
    return false;
  };
  
  // Timeout error recovery
  const handleTimeoutError = (errorInfo, recoveryOptions) => {
    if (typeof logInfo === 'function') {
      logInfo('Attempting timeout error recovery...');
    } else {
      console.log('ğŸ”„ Attempting timeout error recovery...');
    }
    
    if (errorBoundaryState.retryCount < ERROR_BOUNDARY_CONFIG.maxRetries) {
      errorBoundaryState.retryCount++;
      
      setTimeout(() => {
        if (recoveryOptions.retryCallback) {
          if (typeof logInfo === 'function') {
            logInfo('Retrying after timeout...');
          } else {
            console.log('ğŸ”„ Retrying after timeout...');
          }
          recoveryOptions.retryCallback();
        }
      }, ERROR_BOUNDARY_CONFIG.retryDelay * 2); // Longer delay for timeouts
      
      return true;
    }
    
    showErrorUI('å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚', 'timeout');
    return false;
  };
  
  // JavaScript error recovery
  const handleJavaScriptError = (errorInfo, recoveryOptions) => {
    if (typeof logInfo === 'function') {
      logInfo('Attempting JavaScript error recovery...');
    } else {
      console.log('ğŸ”„ Attempting JavaScript error recovery...');
    }
    
    // Try to recover from common JavaScript errors
    if (errorInfo.message.includes('undefined') || errorInfo.message.includes('null')) {
      if (typeof logInfo === 'function') {
        logInfo('Attempting to recover from null/undefined error...');
      } else {
        console.log('ğŸ”„ Attempting to recover from null/undefined error...');
      }
      
      if (recoveryOptions.fallbackCallback) {
        recoveryOptions.fallbackCallback();
        return true;
      }
    }
    
    showErrorUI('JavaScriptã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'javascript');
    return false;
  };
  
  // Generic error recovery
  const handleGenericError = (errorInfo, recoveryOptions) => {
    if (typeof logInfo === 'function') {
      logInfo('Attempting generic error recovery...');
    } else {
      console.log('ğŸ”„ Attempting generic error recovery...');
    }
    
    if (recoveryOptions.fallbackCallback) {
      recoveryOptions.fallbackCallback();
      return true;
    }
    
    showErrorUI('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'generic');
    return false;
  };
  
  // Show error UI to user
  const showErrorUI = (message, category) => {
    if (!ERROR_BOUNDARY_CONFIG.fallbackUI) return;
    
    // Remove existing error UI
    const existingError = document.getElementById('error-boundary-ui');
    if (existingError) {
      existingError.remove();
    }
    
    // Create error UI
    const errorUI = document.createElement('div');
    errorUI.id = 'error-boundary-ui';
    errorUI.innerHTML = "<div style=\"position: fixed; top: 20px; right: 20px; background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; border: 1px solid #fecaca; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 10000; max-width: 400px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\"><div style=\"display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">  <span style=\"font-size: 18px;">âš ï¸</span>  <strong>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong></div><p style=\"margin: 0 0 12px 0; font-size: 14px;">${message}</p><div style=\"display: flex; gap: 8px;">  <button onclick=\"window.location.reload()\" style=\"background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;\">å†èª­ã¿è¾¼ã¿</button>  <button onclick=\"document.getElementById('error-boundary-ui').remove()\" style=\"background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;\">é–‰ã˜ã‚‹</button></div></div>";
    
    document.body.appendChild(errorUI);
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
      if (document.getElementById('error-boundary-ui')) {
        document.getElementById('error-boundary-ui').remove();
      }
    }, 10000);
  };
  
  // Report error to server (if available)
  const reportError = (errorInfo) => {
    try {
      // Only report if Google Apps Script is available
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withFailureHandler((error) => {
            console.warn('Failed to report error to server:', error);
          })
          .reportClientError && google.script.run.reportClientError(errorInfo);
      }
    } catch (e) {
      console.warn('Error reporting failed:', e);
    }
  };
  
  // Get or create session ID
  const getSessionId = () => {
    let sessionId = sessionStorage.getItem('error-boundary-session');
    if (!sessionId) {
      sessionId = Date.now().toString(36) + Math.random().toString(36).substr(2);
      sessionStorage.setItem('error-boundary-session', sessionId);
    }
    return sessionId;
  };
  
  // Enhanced Promise wrapper with error boundary
  const wrapWithErrorBoundary = (promise, context, recoveryOptions = {}) => {
    return promise.catch(error => {
      return handleError(error, context, recoveryOptions);
    });
  };
  
  // Enhanced function wrapper with error boundary
  const wrapFunctionWithErrorBoundary = (fn, context, recoveryOptions = {}) => {
    return function(...args) {
      try {
        const result = fn.apply(this, args);
        
        // Handle promise results
        if (result && typeof result.then === 'function') {
          return wrapWithErrorBoundary(result, context, recoveryOptions);
        }
        
        return result;
      } catch (error) {
        return handleError(error, context, recoveryOptions);
      }
    };
  };
  
  // Set up global error handlers
  const setupGlobalErrorHandlers = () => {
    // Global unhandled error handler
    window.addEventListener('error', (event) => {
      handleError(event.error || new Error(event.message), 'global', {
        retryCallback: () => console.log('Global error retry not implemented')
      });
    });
    
    // Global unhandled promise rejection handler
    window.addEventListener('unhandledrejection', (event) => {
      handleError(event.reason || new Error('Unhandled promise rejection'), 'promise', {
        retryCallback: () => console.log('Promise rejection retry not implemented')
      });
    });
    
    // Google Apps Script specific error handler
    if (typeof google !== 'undefined' && google.script) {
      const originalRun = google.script.run;
      google.script.run = new Proxy(originalRun, {
        get: function(target, prop) {
          if (typeof target[prop] === 'function') {
            return wrapFunctionWithErrorBoundary(target[prop], 'google-script', {
              retryCallback: () => console.log('Google Script retry triggered')
            });
          }
          return target[prop];
        }
      });
    }
  };
  
  // Initialize error boundary system
  const initErrorBoundary = () => {
    console.log('ğŸ›¡ï¸ Error Boundary System initialized');
    setupGlobalErrorHandlers();
  };
  
  // Expose error boundary utilities globally
  window.ErrorBoundary = {
    handleError,
    wrapWithErrorBoundary,
    wrapFunctionWithErrorBoundary,
    state: errorBoundaryState,
    config: ERROR_BOUNDARY_CONFIG,
    categories: ERROR_CATEGORIES
  };
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initErrorBoundary);
  } else {
    initErrorBoundary();
  }
})();
</script>

<!-- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºéƒ¨åˆ† -->
<? if (typeof title !== 'undefined' && title) { ?>
<? var loginUrl = ScriptApp.getService().getUrl(); ?>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= title || 'ã‚¨ãƒ©ãƒ¼' ?> - StudyQuest</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; color: #333; }
        .error-container { background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); padding: 40px; max-width: 800px; width: 95%; text-align: center; position: relative; }
        .error-icon { font-size: 64px; margin-bottom: 20px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
        .error-title { font-size: 24px; font-weight: bold; color: #e53e3e; margin-bottom: 16px; }
        .error-message { font-size: 16px; color: #666; line-height: 1.6; margin-bottom: 24px; word-break: break-word; overflow-wrap: break-word; white-space: pre-wrap; max-height: 300px; overflow-y: auto; text-align: left; padding: 0 10px; }
        .error-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; text-decoration: none; transition: all 0.3s ease; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd8; transform: translateY(-2px); }
        .btn-secondary { background: #f7fafc; color: #4a5568; border: 1px solid #e2e8f0; }
        .btn-secondary:hover { background: #edf2f7; }
        .debug-info { margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8; text-align: left; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; color: #495057; max-height: 200px; overflow-y: auto; }
        .timestamp { color: #6c757d; font-size: 12px; margin-top: 16px; }
        
        /* ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
        .error-container.error-critical { border-left: 6px solid #dc3545; }
        .error-container.error-access { border-left: 6px solid #fd7e14; }
        .error-container.error-validation { border-left: 6px solid #ffc107; }
        .error-container.error-network { border-left: 6px solid #17a2b8; }
        .error-container.error-user { border-left: 6px solid #6c757d; }
        
        /* è©³ç´°æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .diagnostic-section { margin-top: 20px; text-align: left; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8; padding: 16px; max-height: 400px; overflow-y: auto; }
        
        .diagnostic-toggle { background: #e9ecef; border: 1px solid #dee2e6; border-radius: 6px; padding: 8px 16px; margin-bottom: 16px; cursor: pointer; font-size: 14px; transition: background-color 0.3s ease; }
        
        .diagnostic-toggle:hover { background: #dee2e6; }
        
        .diagnostic-content { display: none; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; line-height: 1.4; }
        
        .diagnostic-summary { margin-bottom: 16px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #dee2e6; }
        
        .diagnostic-summary h4 { margin: 0 0 8px 0; font-size: 14px; color: #495057; }
        
        .diagnostic-summary p { margin: 4px 0; font-size: 13px; }
        
        .diagnostic-properties { margin-top: 12px; padding: 12px; background: #f1f3f4; border-radius: 6px; font-size: 11px; max-height: 200px; overflow-y: auto; }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) { .error-container { width: 98%; padding: 20px; margin: 10px; } .error-title { font-size: 20px; } .error-message { font-size: 14px; padding: 0 5px; } .error-actions { flex-direction: column; gap: 8px; } .btn { width: 100%; } }
        @media (max-width: 480px) { .error-container { padding: 15px; } .error-icon { font-size: 48px; } .error-title { font-size: 18px; } .diagnostic-section { padding: 12px; } }
    </style>
    <script>
        // å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹é–¢æ•°ï¼ˆç°¡ç´ åŒ–ç‰ˆï¼‰
        function forceLogoutAndRedirect() {
            console.log('ğŸ”„ ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–‹å§‹...');
            console.log('ğŸ“ ç¾åœ¨ã®URL:', window.location.href);
            
            // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼šæ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ã„ã‚‹å ´åˆã¯å˜ç´”ã«ãƒªãƒ­ãƒ¼ãƒ‰
            if (window.location.href.includes('mode=login')) {
                console.log('âš ï¸ æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
                window.location.reload();
                return;
            }
            
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
            const logoutBtn = event.target;
            if (logoutBtn) {
                logoutBtn.disabled = true;
                logoutBtn.innerHTML = 'ğŸ”„ å‡¦ç†ä¸­...';
            }
            
            try {
                // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆé–¢æ•°ã‚’å‘¼ã³å‡ºã—ï¼ˆå…¨ã¦ã®åˆ¶ç´„ã‚’å›é¿ï¼‰
                google.script.run
                    .withSuccessHandler(function(htmlOutput) {
                        console.log('âœ… ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå–å¾—æˆåŠŸ');
                        console.log('ğŸ” Response type:', typeof htmlOutput);
                        console.log('ğŸ” Response value:', htmlOutput);
                        console.log('ğŸ” Response length:', htmlOutput ? htmlOutput.length : 'N/A');
                        console.log('ğŸ” Response preview:', htmlOutput ? htmlOutput.substring(0, 200) : 'NO CONTENT');
                        
                        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸHTMLã‚’ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã«è¨­å®šï¼ˆè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œï¼‰
                        if (htmlOutput && htmlOutput.trim()) {
                            console.log('âœ… Valid HTML received, applying...');
                            document.open();
                            document.write(htmlOutput);
                            document.close();
                        } else {
                            console.warn('âš ï¸ ç©ºã®HTMLOutputã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ');
                            console.warn('  - htmlOutput:', htmlOutput);
                            console.warn('  - Trimmed:', htmlOutput ? htmlOutput.trim() : 'N/A');
                            fallbackReload();
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('âŒ ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¤±æ•—:', error);
                        fallbackReload();
                    })
                    .forceLogoutAndRedirectToLogin();
                    
            } catch (error) {
                console.error('âŒ å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
                fallbackReload();
            }
        }
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
        function fallbackReload() {
            console.log('ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ');
            const confirmMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';
            if (confirm(confirmMessage)) {
                window.location.reload();
            }
        }
        
        // ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°
        function testServerFunction() {
            console.log('ğŸ§ª Testing server function...');
            
            // é–¢æ•°å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if (typeof google !== 'undefined' && 
                google.script && 
                google.script.run) {
                
                try {
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('ğŸ§ª Test Success:', result);
                            console.log('ğŸ§ª Test Result Type:', typeof result);
                            console.log('ğŸ§ª Test Result Length:', result ? result.length : 'N/A');
                            alert('ãƒ†ã‚¹ãƒˆæˆåŠŸ: ' + (result ? 'å†…å®¹ã‚ã‚Š (' + result.length + ' chars)' : 'ç©ºã®çµæœ'));
                        })
                        .withFailureHandler(function(error) {
                            console.error('ğŸ§ª Test Error:', error);
                            alert('ãƒ†ã‚¹ãƒˆå¤±æ•—: ' + error.message);
                        })
                        .testForceLogoutRedirect();
                } catch (funcError) {
                    console.warn('âš ï¸ testForceLogoutRedirecté–¢æ•°ã®å‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼:', funcError);
                    alert('ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + funcError.message);
                }
            } else {
                console.warn('âš ï¸ Google Apps Scriptãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                alert('ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚');
            }
        }
    </script>
</head>
<body>
    <div class="error-container <?= typeof errorType !== 'undefined' ? 'error-' + errorType : '' ?>">
        <div class="error-icon"><?= typeof errorIcon !== 'undefined' ? errorIcon : 'âš ï¸' ?></div>
        <h1 class="error-title"><?= htmlEncode(title || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ') ?></h1>
        <p class="error-message"><?= htmlEncode(message || 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚') ?></p>
        
        <!-- æ§‹é€ åŒ–ã•ã‚ŒãŸè¨ºæ–­æƒ…å ±è¡¨ç¤º -->
        <? if (typeof diagnosticInfo !== 'undefined' && diagnosticInfo) { ?>
        <div class="diagnostic-section">
            <div class="diagnostic-toggle" onclick="toggleDiagnosticInfo()">
                ğŸ“Š è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º <span id="diagnostic-arrow">â–¼</span>
            </div>
            <div class="diagnostic-content" id="diagnostic-content">
                <? if (diagnosticInfo.summary && diagnosticInfo.summary.length > 0) { ?>
                <div class="diagnostic-summary">
                    <h4>ğŸ“‹ åŸºæœ¬æƒ…å ±</h4>
                    <? diagnosticInfo.summary.forEach(function(item) { ?>
                        <p><?= htmlEncode(item) ?></p>
                    <? }); ?>
                </div>
                <? } ?>
                
                <? if (diagnosticInfo.technical && diagnosticInfo.technical.length > 0) { ?>
                <div class="diagnostic-summary">
                    <h4>ğŸ”§ æŠ€è¡“è©³ç´°</h4>
                    <? diagnosticInfo.technical.forEach(function(item) { ?>
                        <p><?= htmlEncode(item) ?></p>
                    <? }); ?>
                </div>
                <? } ?>
                
                <? if (diagnosticInfo.properties) { ?>
                <div class="diagnostic-properties">
                    <h4>ğŸ—‚ï¸ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h4>
                    <pre><?= htmlEncode(JSON.stringify(diagnosticInfo.properties, null, 2)) ?></pre>
                </div>
                <? } ?>
                
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #dee2e6;">
                    <button type="button" class="btn btn-secondary" onclick="copyDiagnosticInfo()" style="font-size: 12px;">
                        ğŸ“‹ è¨ºæ–­æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼
                    </button>
                </div>
            </div>
        </div>
        <? } ?>
        
        <div class="error-actions">
            <button type="button" class="btn btn-primary" onclick="location.reload()">
                ğŸ”„ ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°
            </button>
            <? if (typeof isRegisteredUser !== 'undefined' && isRegisteredUser) { ?>
            <button type="button" class="btn btn-secondary" onclick="forceLogoutAndRedirect()">
                ğŸ  ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
            </button>
            <? } ?>
            <button type="button" class="btn btn-secondary" onclick="testServerFunction()" style="font-size: 12px;">
                ğŸ§ª æ¥ç¶šãƒ†ã‚¹ãƒˆ
            </button>
        </div>
        
        <!-- å¾“æ¥ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºè€…å‘ã‘ï¼‰ -->
        <? if (typeof debugInfo !== 'undefined' && debugInfo) { ?>
        <div class="debug-info">
            <div class="diagnostic-toggle" onclick="toggleDebugInfo()" style="margin-bottom: 8px;">
                ğŸ” é–‹ç™ºè€…å‘ã‘æƒ…å ± <span id="debug-arrow">â–¼</span>
            </div>
            <div id="debug-content" style="display: none;">
                <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
                <?= htmlEncode(debugInfo) ?>
            </div>
        </div>
        <? } ?>
        
        <div class="timestamp">
            ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚åˆ»: <?= new Date().toLocaleString('ja-JP') ?>
        </div>
    </div>

    <script>
        // è©³ç´°è¨ºæ–­æƒ…å ±ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleDiagnosticInfo() {
            const content = document.getElementById('diagnostic-content');
            const arrow = document.getElementById('diagnostic-arrow');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                arrow.textContent = 'â–²';
            } else {
                content.style.display = 'none';
                arrow.textContent = 'â–¼';
            }
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleDebugInfo() {
            const content = document.getElementById('debug-content');
            const arrow = document.getElementById('debug-arrow');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                arrow.textContent = 'â–²';
            } else {
                content.style.display = 'none';
                arrow.textContent = 'â–¼';
            }
        }
        
        // è¨ºæ–­æƒ…å ±ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyDiagnosticInfo() {
            try {
                let copyText = '=== ã‚¨ãƒ©ãƒ¼è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ ===\n\n';
                copyText += 'ã‚¿ã‚¤ãƒˆãƒ«: <?= htmlEncode(title || "Unknown") ?>\n';
                copyText += 'ç™ºç”Ÿæ™‚åˆ»: <?= new Date().toLocaleString("ja-JP") ?>\n';
                
                // DOM ã‹ã‚‰è¨ºæ–­æƒ…å ±ã‚’ç›´æ¥å–å¾—
                const diagnosticSections = document.querySelectorAll('.diagnostic-summary');
                diagnosticSections.forEach((section) => {
                    const heading = section.querySelector('h4');
                    if (heading && heading.textContent.includes('ğŸ“‹ åŸºæœ¬æƒ…å ±')) {
                        const summaryItems = section.querySelectorAll('p');
                        if (summaryItems.length > 0) {
                            copyText += '\nã€åŸºæœ¬æƒ…å ±ã€‘\n';
                            summaryItems.forEach((item) => {
                                copyText += item.textContent.trim() + '\n';
                            });
                        }
                    } else if (heading && heading.textContent.includes('ğŸ”§ æŠ€è¡“è©³ç´°')) {
                        const technicalItems = section.querySelectorAll('p');
                        if (technicalItems.length > 0) {
                            copyText += '\nã€æŠ€è¡“è©³ç´°ã€‘\n';
                            technicalItems.forEach((item) => {
                                copyText += item.textContent.trim() + '\n';
                            });
                        }
                    }
                });
                
                const propertiesSection = document.querySelector('.diagnostic-properties pre');
                if (propertiesSection) {
                    copyText += '\nã€ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã€‘\n';
                    copyText += propertiesSection.textContent.trim() + '\n';
                }
                
                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«æ›¸ãè¾¼ã¿
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(copyText).then(function() {
                        alert('ğŸ“‹ è¨ºæ–­æƒ…å ±ãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸ');
                    }).catch(function() {
                        fallbackCopy(copyText);
                    });
                } else {
                    fallbackCopy(copyText);
                }
                
            } catch (error) {
                console.error('Copy failed:', error);
                alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('ğŸ“‹ è¨ºæ–­æƒ…å ±ãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸ');
            } catch (err) {
                alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                console.error('Fallback copy failed:', err);
            }
            document.body.removeChild(textArea);
        }
    </script>
</body>
</html>
<? } ?>