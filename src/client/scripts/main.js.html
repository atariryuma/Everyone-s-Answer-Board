<script>
// 全体共通スクリプト
/*
全ページで共通して使用するJavaScript機能

主な内容:
- ユーティリティ関数
- 共通イベントリスナー
- API通信の基底クラス
- エラーハンドリング
- ローディング表示
- 共通UI操作
*/

// グローバルエラーハンドリング
window.addEventListener('error', function(event) {
  console.error('Global error caught:', event.error);
  // document.writeエラーの場合は特別な処理
  if (event.error && event.error.message && event.error.message.includes('document.write')) {
    console.warn('document.write エラーが検出されました。安全なDOM操作に切り替えています。');
    event.preventDefault();
  }
});

// Promise rejection のキャッチ
window.addEventListener('unhandledrejection', function(event) {
  console.error('Unhandled promise rejection:', event.reason);
  event.preventDefault();
});

// 共通ユーティリティ関数
function escapeHtml(str) {
  if (!str) return '';
  return str.toString()
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// セキュリティ強化: 入力バリデーション関数
function validateInput(value, type) {
  if (!value || typeof value !== 'string') return false;
  
  switch (type) {
    case 'email':
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
    case 'method':
      return ['auto', 'manual'].includes(value);
    default:
      return value.length > 0 && value.length < 1000;
  }
}

// Enhanced message system with duplicate detection and auto-cleanup
const MESSAGE_TYPES = {
  info: { bgColor: 'bg-blue-500', icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
  success: { bgColor: 'bg-green-500', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z', extraClass: 'success-pulse' },
  error: { bgColor: 'bg-red-500', icon: 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z', extraClass: 'error-shake' },
  warning: { bgColor: 'bg-yellow-500', icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z', extraClass: 'text-black' },
  green: { bgColor: 'bg-green-500', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' },
  blue: { bgColor: 'bg-blue-500', icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
  yellow: { bgColor: 'bg-yellow-500', icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z', extraClass: 'text-black' }
};

function sanitizeMessage(message) {
  if (typeof message !== 'string') {
    try {
      message = String(message);
    } catch (e) {
      return 'メッセージ表示エラー';
    }
  }
  
  // Remove control characters and limit length
  return message
    .replace(/[\u0000-\u001F\u007F]/g, '')
    .replace(/['"\\]/g, '')
    .substring(0, 200);
}

function handleDuplicateMessage(messageArea, message) {
  const existingMessages = Array.from(messageArea.children);
  for (let i = 0; i < existingMessages.length; i++) {
    const existing = existingMessages[i];
    const spanElement = existing.querySelector('span');
    const existingText = spanElement ? spanElement.textContent : null;
    if (existingText === message) {
      // Highlight existing message
      existing.style.transform = 'scale(1.05)';
      setTimeout(() => { existing.style.transform = 'scale(1)'; }, 200);
      return true;
    }
  }
  return false;
}

function cleanupOldMessages(messageArea) {
  while (messageArea.children.length >= 5) {
    messageArea.children[0].remove();
  }
}

function createMessageElement(messageId, message, type) {
  const typeConfig = MESSAGE_TYPES[type] || MESSAGE_TYPES.info;
  const messageElement = document.createElement('div');
  messageElement.id = messageId;
  messageElement.className = `p-4 mb-3 rounded-lg shadow-md flex items-center justify-between text-white transform transition-all duration-300 ease-out slide-up ${typeConfig.bgColor}`;
  
  if (typeConfig.extraClass) {
    messageElement.classList.add(typeConfig.extraClass);
  }
  
  // Create message container with icon and text
  const messageContainer = document.createElement('div');
  messageContainer.className = 'flex items-center';
  const iconContainer = document.createElement('div');
  iconContainer.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${typeConfig.icon}"></path></svg>`;
  
  const messageSpan = document.createElement('span');
  messageSpan.className = 'ml-2 text-sm font-medium';
  messageSpan.textContent = message;
  messageContainer.appendChild(iconContainer);
  messageContainer.appendChild(messageSpan);
  
  // Create close button
  const closeButton = document.createElement('button');
  closeButton.className = 'ml-4 text-white opacity-70 hover:opacity-100 focus:outline-none';
  closeButton.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
  closeButton.onclick = () => removeMessage(messageId);
  
  messageElement.appendChild(messageContainer);
  messageElement.appendChild(closeButton);
  
  return messageElement;
}

function setupMessageAutoRemoval(messageId, type) {
  const timeout = type === 'error' ? 5000 : 2500;
  return setTimeout(() => {
    const msgEl = document.getElementById(messageId);
    if (msgEl && msgEl.parentNode) {
      msgEl.classList.remove('slide-up');
      msgEl.classList.add('fade-out');
      
      const fallbackTimer = setTimeout(() => {
        if (msgEl && msgEl.parentNode) {
          msgEl.remove();
        }
      }, 500);
      
      msgEl.addEventListener('transitionend', () => {
        clearTimeout(fallbackTimer);
        if (msgEl && msgEl.parentNode) {
          msgEl.remove();
        }
      }, { once: true });
    }
  }, timeout);
}

function removeMessage(messageId) {
  const msgEl = document.getElementById(messageId);
  if (msgEl) {
    // Clear auto timer
    if (msgEl.removeTimer) {
      clearTimeout(msgEl.removeTimer);
    }
    // Remove immediately
    msgEl.remove();
  }
}

// Enhanced message display function
function showMessage(message, type) {
  try {
    type = type || 'info';
    message = sanitizeMessage(message);
    
    const messageArea = document.getElementById('message-area');
    if (!messageArea) return;
    
    // Check for duplicates
    if (handleDuplicateMessage(messageArea, message)) {
      return;
    }
    
    // Clean up old messages
    cleanupOldMessages(messageArea);
    
    // Create and display new message
    const messageId = 'msg-' + Date.now();
    const messageElement = createMessageElement(messageId, message, type);
    messageArea.appendChild(messageElement);
    
    // Set up auto-removal
    messageElement.removeTimer = setupMessageAutoRemoval(messageId, type);
    
  } catch (error) {
    try {
      console.error('showMessage function error:', error);
    } catch (e) {
      // Silently fail if even logging fails
    }
  }
}

// クリップボードにコピー（現代的なAPIを使用）
async function copyToClipboard(elementId) {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  const button = element.parentElement.querySelector('button');
  const originalText = button ? button.textContent : '';
  
  try {
    // 現代的なClipboard APIを使用
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(element.value);
    } else {
      // フォールバック: 従来の方法
      element.select();
      element.setSelectionRange(0, 99999); // モバイル対応
      document.execCommand('copy');
    }
    
    // コピー完了の視覚的フィードバック
    if (button) {
      button.textContent = '✓ コピー済み';
      button.classList.add('bg-green-700');
      
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('bg-green-700');
      }, 2000);
    }
  } catch (error) {
    console.error('コピーに失敗しました:', error);
    if (button) {
      button.textContent = '✗ コピー失敗';
      button.classList.add('bg-red-700');
      
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('bg-red-700');
      }, 2000);
    }
  }
}

// ===== 共通ドメイン情報処理関数 =====
// 複数のページで共通使用

/**
 * ドメイン情報を取得して表示する共通関数
 * @param {Function} onSuccess - 成功時のコールバック（オプション）
 * @param {Function} onError - エラー時のコールバック（オプション）
 */
function loadDomainInfo(onSuccess, onError) {
  google.script.run
    .withSuccessHandler(info => {
      displayDomainInfo(info);
      if (onSuccess) onSuccess(info);
    })
    .withFailureHandler(error => {
      console.error('ドメイン情報の取得に失敗しました:', error);
      displayDomainInfo({ error: error.message || error });
      if (onError) onError(error);
    })
    .getDeployUserDomainInfo();
}

/**
 * ドメイン情報を表示する共通関数
 * @param {Object} info - ドメイン情報オブジェクト
 */
function displayDomainInfo(info) {
  const headerDomainMatch = document.getElementById('header-domain-match');
  const headerDomainMismatch = document.getElementById('header-domain-mismatch');
  const headerDomainInitial = document.getElementById('header-domain-initial');
  const headerDomainMatchText = document.getElementById('header-domain-match-text');
  const headerDomainMismatchText = document.getElementById('header-domain-mismatch-text');

  // 全ての表示を一旦非表示にする
  if (headerDomainMatch) headerDomainMatch.classList.add('hidden');
  if (headerDomainMismatch) headerDomainMismatch.classList.add('hidden');
  if (headerDomainInitial) headerDomainInitial.classList.add('hidden');
  
  if (!info || info.error) {
    console.warn('ドメイン情報エラー:', info?.error);
    if (headerDomainInitial) headerDomainInitial.classList.remove('hidden');
    return;
  }

  if (info.isDomainMatch) {
    // ドメインが一致している場合
    if (headerDomainMatch && headerDomainMatchText) {
      headerDomainMatch.classList.remove('hidden');
      if (info.deployDomain) {
        headerDomainMatchText.textContent = `${info.deployDomain} ドメイン`;
      } else {
        headerDomainMatchText.textContent = 'グローバルアクセス';
      }
    }
  } else {
    // ドメイン不一致の場合
    if (headerDomainMismatch && headerDomainMismatchText) {
      headerDomainMismatch.classList.remove('hidden');
      headerDomainMismatchText.textContent = info.currentDomain;
    }
  }
}

// セキュリティ強化: 認証状態の検証
async function verifyAuthentication() {
  return new Promise((resolve, reject) => {
    // タイムアウト処理を追加
    const timeoutId = setTimeout(() => {
      reject(new Error('認証確認がタイムアウトしました'));
    }, 10000); // 10秒でタイムアウト

    google.script.run
      .withSuccessHandler(result => {
        clearTimeout(timeoutId);
        if (result && result.authenticated && result.email) {
          resolve(result);
        } else {
          reject(new Error('認証が必要です'));
        }
      })
      .withFailureHandler(error => {
        clearTimeout(timeoutId);
        reject(error);
      })
      .verifyUserAuthentication();
  });
}

// クライアントサイドキャッシュクリア関数
function clearClientSideCache() {
  try {
    // ローカルストレージをクリア（treat_as_new_account以外）
    const treatAsNewAccount = sessionStorage.getItem('treat_as_new_account');
    sessionStorage.clear();
    localStorage.clear();
    if (treatAsNewAccount) {
      sessionStorage.setItem('treat_as_new_account', treatAsNewAccount);
    }
    
    // Service Worker キャッシュをクリア
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => {
          caches.delete(name);
        });
      });
    }
    
    // Cookie のクリア（可能な範囲）
    document.cookie.split(";").forEach(function(c) { 
      document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });
    
    console.log('クライアントサイドキャッシュをクリアしました');
  } catch (error) {
    console.warn('クライアントサイドキャッシュクリアでエラーが発生:', error);
  }
}

// Enterキー対応の共通処理
function setupEnterKeyHandler(buttonId) {
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const button = document.getElementById(buttonId);
      if (button && !button.disabled) {
        button.click();
      }
    }
  });
}

'''// === 共通モーダル管理システム ===
function showModal(modalId, focusElement = null) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('hidden');
    if (focusElement) {
      setTimeout(() => focusElement.focus(), 100);
    }
  }
}

function hideModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('hidden');
  }
}

function showPrivacyModal(onContinue) {
    var modal = document.getElementById('privacy-modal');
    if (!modal) {
    console.error('プライバシーモーダルが見つかりません');
    return;
    }
    
    modal.classList.remove('hidden');
    
    // イベントリスナーを設定（重複を防ぐため一度クリア）
    var continueBtn = document.getElementById('privacy-modal-continue');
    var cancelBtn = document.getElementById('privacy-modal-cancel');
    
    // 既存のリスナーを削除
    if (continueBtn) {
    var newContinueBtn = continueBtn.cloneNode(true);
    continueBtn.parentNode.replaceChild(newContinueBtn, continueBtn);
    newContinueBtn.addEventListener('click', function() {
        hidePrivacyModal();
        if (onContinue) onContinue();
    });
    }
    
    if (cancelBtn) {
    var newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', hidePrivacyModal);
    }
    
    // Escapeキーでモーダルを閉じる
    var escapeHandler = function(e) {
    if (e.key === 'Escape') {
        hidePrivacyModal();
        document.removeEventListener('keydown', escapeHandler);
    }
    };
    document.addEventListener('keydown', escapeHandler);
}

function hidePrivacyModal() {
    var modal = document.getElementById('privacy-modal');
    if (modal) {
    modal.classList.add('hidden');
    }
}

function showConfirmationModal(title, message, onConfirm) {
    var modal = document.getElementById('confirmation-modal');
    var modalTitle = document.getElementById('modal-title');
    var modalMessage = document.getElementById('modal-message');
    
    if (modalTitle) modalTitle.textContent = title;
    if (modalMessage) modalMessage.textContent = message;
    
    if (!modal) {
    console.error('確認モーダルが見つかりません');
    return;
    }
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');

    var confirmBtn = document.getElementById('modal-confirm-btn');
    var cancelBtn = document.getElementById('modal-cancel-btn');

    var confirmHandler = function() {
    onConfirm();
    hideConfirmationModal();
    confirmBtn.removeEventListener('click', confirmHandler);
    cancelBtn.removeEventListener('click', cancelHandler);
    };

    var cancelHandler = function() {
    hideConfirmationModal();
    confirmBtn.removeEventListener('click', confirmHandler);
    cancelBtn.removeEventListener('click', cancelHandler);
    };

    confirmBtn.addEventListener('click', confirmHandler);
    cancelBtn.addEventListener('click', cancelHandler);
}

function hideConfirmationModal() {
    var modal = document.getElementById('confirmation-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

function showDigitalCitizenshipModal() {
    var modal = document.getElementById('digital-citizenship-modal');
    if (!modal) {
    console.error('デジタルシティズンシップモーダルが見つかりません');
    return;
    }
    
    modal.classList.remove('hidden');
    
    // 閉じるボタンのイベントリスナーを設定
    var closeBtn = document.getElementById('digital-citizenship-modal-close');
    var closeBtnBottom = document.getElementById('digital-citizenship-modal-close-btn');
    
    if (closeBtn) {
    closeBtn.onclick = hideDigitalCitizenshipModal;
    }
    
    if (closeBtnBottom) {
    closeBtnBottom.onclick = hideDigitalCitizenshipModal;
    }
    
    // Escapeキーでモーダルを閉じる
    var escapeHandler = function(e) {
    if (e.key === 'Escape') {
        hideDigitalCitizenshipModal();
        document.removeEventListener('keydown', escapeHandler);
    }
    };
    document.addEventListener('keydown', escapeHandler);
    
    // モーダルの背景をクリックしたときに閉じる
    modal.onclick = function(e) {
    if (e.target === modal) {
        hideDigitalCitizenshipModal();
    }
    };
}

function hideDigitalCitizenshipModal() {
    var modal = document.getElementById('digital-citizenship-modal');
    if (modal) {
    modal.classList.add('hidden');
    }
}

// === 共通イベント委譲システム ===''
function setupEventDelegation(container, selector, event, handler) {
  container.addEventListener(event, (e) => {
    if (e.target.closest(selector)) {
      handler(e);
    }
  });
}

// === 統一キャッシュシステム ===
class UnifiedCache {
  constructor() {
    this.cache = new Map();
    this.elementCache = new Map();
  }
  
  set(key, value, ttl = 300000) {
    this.cache.set(key, {
      value,
      expiry: Date.now() + ttl
    });
  }
  
  get(key) {
    const item = this.cache.get(key);
    if (!item) return null;
    if (Date.now() > item.expiry) {
      this.cache.delete(key);
      return null;
    }
    return item.value;
  }
  
  getElementById(id) {
    if (!this.elementCache.has(id)) {
      this.elementCache.set(id, document.getElementById(id));
    }
    return this.elementCache.get(id);
  }
  
  clear() {
    this.cache.clear();
    this.elementCache.clear();
  }
}

// グローバルキャッシュインスタンス
window.unifiedCache = new UnifiedCache();

// === グローバル初期化 ===
document.addEventListener('DOMContentLoaded', () => {
  // ESCキーでモーダルを閉じる共通処理
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const modals = document.querySelectorAll('.modal:not(.hidden)');
      modals.forEach(modal => modal.classList.add('hidden'));
    }
  });
});
</script>