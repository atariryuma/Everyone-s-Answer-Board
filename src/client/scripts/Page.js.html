<script>
// 回答ボードページ専用スクリプト

// Global error handling for document.write and other issues
window.addEventListener('error', function(event) {
  if (event.error && event.error.message) {
    if (event.error.message.includes('document.write') ||
        event.error.message.includes('Unexpected token')) {
      console.warn('Document.write or syntax error caught and handled:', event.error.message);
      event.preventDefault();
      return false;
    }
  }
});

// Handle unhandled promise rejections
window.addEventListener('unhandledrejection', function(event) {
  console.warn('Unhandled promise rejection:', event.reason);
  event.preventDefault();
});

// TailwindCSS configuration to suppress production warnings
window.tailwind = {
  config: {
    mode: 'jit',
    corePlugins: { preflight: false }
  }
};

const DEBUG_MODE = true;
function debugLog() {
  if (DEBUG_MODE && console && console.log) {
    try {
      // 引数を安全に処理
      const args = Array.from(arguments).map(arg => {
        if (typeof arg === 'object' && arg !== null) {
          return safeDebugStringify(arg);
        }
        return arg;
      });
      console.log.apply(console, args);
    } catch (error) {
      console.warn('debugLog error:', error.message);
    }
  }
}

function safeDebugStringify(obj, maxDepth = 2, currentDepth = 0) {
  if (currentDepth > maxDepth) return '[Max Depth Reached]';
  
  try {
    if (obj === null || obj === undefined) return obj;
    if (typeof obj !== 'object') return obj;
    
    // DOM要素の安全な表示
    if (obj instanceof HTMLElement) {
      return `[${obj.tagName}${obj.id ? '#' + obj.id : ''}${obj.className ? '.' + obj.className.split(' ').slice(0, 2).join('.') : ''}]`;
    }
    
    // 配列の安全な表示
    if (Array.isArray(obj)) {
      if (obj.length > 5) {
        return `[Array(${obj.length}): first 3 items + ${obj.length - 3} more]`;
      }
      return obj.map(item => safeDebugStringify(item, maxDepth, currentDepth + 1));
    }
    
    // オブジェクトの安全な表示
    const result = {};
    let count = 0;
    for (const key in obj) {
      if (count >= 8) {
        result['...'] = `[${Object.keys(obj).length - 8} more properties]`;
        break;
      }
      result[key] = safeDebugStringify(obj[key], maxDepth, currentDepth + 1);
      count++;
    }
    return result;
  } catch (error) {
    return '[Stringify Error: ' + error.message + ']';
  }
}

const __SHOW_COUNTS__ = '<?= typeof showCounts !== "undefined" ? showCounts : false ?>';
const __DISPLAY_MODE__ = '<?= typeof displayMode !== "undefined" ? displayMode : "anonymous" ?>';
const __SHEET_NAME__ = '<?= typeof sheetName !== "undefined" ? sheetName : "" ?>';
const __MAPPING__ = '<?= typeof mapping !== "undefined" ? JSON.stringify(mapping) : "{}" ?>';
const __USER_ID__ = '<?= typeof userId !== "undefined" ? userId : "" ?>';
const __SPREADSHEET_ID__ = '<?= typeof spreadsheetId !== "undefined" ? spreadsheetId : "" ?>';
const __OWNER_NAME__ = '<?= typeof ownerName !== "undefined" ? ownerName : "" ?>';
const __OPINION_HEADER__ = '<?= typeof opinionHeader !== "undefined" ? opinionHeader : "お題" ?>';
const __SHOW_ADMIN_FEATURES__ = '<?= typeof showAdminFeatures !== "undefined" ? showAdminFeatures : false ?>';
const __SHOW_HIGHLIGHT_TOGGLE__ = '<?= typeof showHighlightToggle !== "undefined" ? showHighlightToggle : false ?>';
const __SHOW_SCORE_SORT__ = '<?= typeof showScoreSort !== "undefined" ? showScoreSort : false ?>';
const __IS_STUDENT_MODE__ = '<?= typeof isStudentMode !== "undefined" ? isStudentMode : true ?>';
const __IS_ADMIN_USER__ = '<?= typeof isAdminUser !== "undefined" ? isAdminUser : false ?>';
window.showCounts = parseBoolean(__SHOW_COUNTS__, false);
window.displayMode = parseString(__DISPLAY_MODE__, 'anonymous');
window.showAdminFeatures = parseBoolean(__SHOW_ADMIN_FEATURES__, false);
window.showHighlightToggle = parseBoolean(__SHOW_HIGHLIGHT_TOGGLE__, false);
window.showScoreSort = parseBoolean(__SHOW_SCORE_SORT__, false);
window.isStudentMode = parseBoolean(__IS_STUDENT_MODE__, true);
window.isAdminUser = parseBoolean(__IS_ADMIN_USER__, false);
const SHEET_NAME = parseString(__SHEET_NAME__, 'テストシート');
const USER_ID = parseString(__USER_ID__, '');
const OWNER_NAME = parseString(__OWNER_NAME__, '');
let MAPPING;
try {
  if (typeof __MAPPING__ === 'string' && !__MAPPING__.startsWith('<?=')) {
    MAPPING = JSON.parse(__MAPPING__);
  } else {
    MAPPING = {};
  }
} catch (e) {
  console.warn('Failed to parse MAPPING:', e);
  MAPPING = {};
}

function parseBoolean(value, defaultValue) {
  if (typeof value === 'string' && value.startsWith('<?=')) return defaultValue;
  return value === 'true';
}

function parseString(value, defaultValue) {
  if (typeof value === 'string' && value.startsWith('<?=')) return defaultValue;
  return value;
}

// Optimize initial render
const RENDER_BATCH_SIZE = 10;
const VIEWPORT_BUFFER = 200; // Viewport buffer for virtual scrolling
const PERFORMANCE_BUDGET = 16; // Maximum ms per frame
const CHUNK_SIZE = 5; // DOM operations per chunk
const IDLE_TIMEOUT = 5000; // Idle timeout for cleanup
const ICONS = {