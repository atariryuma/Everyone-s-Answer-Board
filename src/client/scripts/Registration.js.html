<script>
// Registration Page å°‚ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

let userEmail = '';
let currentStep = 1;
let domainInfo = null;

// Registration page specific domain info display - extends the common function

// Registration-specific domain info display
function displayRegistrationDomainInfo(info) {
  const section = document.getElementById('domain-info-section');
  const matchPanel = document.getElementById('domain-match-panel');
  const mismatchPanel = document.getElementById('domain-mismatch-panel');
  
  if (!info || info.error) {
    console.warn('ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', info?.error);
    return;
  }

  if (section) section.classList.remove('hidden');

  if (info.isDomainMatch) {
    // ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒä¸€è‡´ã—ã¦ã„ã‚‹å ´åˆ
    if (matchPanel) matchPanel.classList.remove('hidden');
    if (mismatchPanel) mismatchPanel.classList.add('hidden');
    const domainMatchText = document.getElementById('domain-match-text');
    if (domainMatchText) {
      domainMatchText.textContent = 
        `ã“ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã¯ ${info.deployDomain} ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨ã§ã™ã€‚ã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ${info.currentDomain}ï¼‰ã§åˆ©ç”¨ã§ãã¾ã™ã€‚`;
    }
  } else {
    // ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒä¸ä¸€è‡´ã®å ´åˆ
    if (matchPanel) matchPanel.classList.add('hidden');
    if (mismatchPanel) mismatchPanel.classList.remove('hidden');
    const domainMismatchText = document.getElementById('domain-mismatch-text');
    const deployDomain = document.getElementById('deploy-domain');
    if (domainMismatchText) {
      domainMismatchText.textContent = 
        `ã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆ${info.currentDomain}ï¼‰ã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`;
    }
    if (deployDomain) deployDomain.textContent = info.deployDomain;
  }
}

// Scroll to registration function
function scrollToRegistration() {
  document.getElementById('section-3').scrollIntoView({ 
    behavior: 'smooth', 
    block: 'start' 
  });
  updateStep(3);
}

// Update step progress
function updateStep(step) {
  currentStep = step;
  
  // Update progress bar with performance optimization
  const progressBar = document.getElementById('progress-bar');
  requestAnimationFrame(() => {
    progressBar.style.width = `${(step / 3) * 100}%`;
  });
  
  // Update step indicators
  for (let i = 1; i <= 3; i++) {
    const stepElement = document.getElementById(`step-${i}`);
    const stepIndicator = document.getElementById(`step-${i}`);
    
    if (stepElement) {
      if (i <= step) {
        stepElement.classList.add('completed');
        const stepCircle = stepElement.querySelector('div');
        if (stepCircle) {
          stepCircle.className = 'w-8 h-8 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm relative z-10';
        }
        const stepLabel = stepElement.querySelector('span');
        if (stepLabel) {
          stepLabel.className = 'text-xs mt-2 block text-cyan-400';
        }
      } else {
        stepElement.classList.remove('completed');
        const stepCircle = stepElement.querySelector('div');
        if (stepCircle) {
          stepCircle.className = 'w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm relative z-10';
        }
        const stepLabel = stepElement.querySelector('span');
        if (stepLabel) {
          stepLabel.className = 'text-xs mt-2 block text-gray-400';
        }
      }
    }
    
    // Update section-specific icons (for steps 2 and 3)
    const iconElement = document.getElementById(`step-${i}-icon`);
    if (iconElement) {
      if (i <= step) {
        iconElement.className = 'w-6 h-6 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm';
      } else {
        iconElement.className = 'w-6 h-6 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm';
      }
    }
  }
}

// verifyAuthenticationé–¢æ•°ã¯main.js.htmlã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™

// æ—¢å­˜ãƒœãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°ï¼ˆè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç”¨ï¼‰
function checkExistingBoard() {
  return new Promise((resolve, reject) => {
    const timeoutId = setTimeout(() => {
      reject(new Error('æ—¢å­˜ãƒœãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
    }, 5000);

    google.script.run
      .withSuccessHandler(result => {
        clearTimeout(timeoutId);
        resolve(result);
      })
      .withFailureHandler(error => {
        clearTimeout(timeoutId);
        console.error('æ—¢å­˜ãƒœãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦æ‰±ã†
        resolve({ status: 'new_user' });
      })
      .getExistingBoard();
  });
}

// loadDomainInfoé–¢æ•°ã¨displayDomainInfoé–¢æ•°ã¯main.js.htmlã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
window.addEventListener('DOMContentLoaded', async () => {
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  showMessage('èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...', 'info');
  
  // ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—
  loadDomainInfo();
  
  // scrollToRegistrationã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  const scrollToRegistrationBtn = document.querySelector('button[aria-label="æ–°è¦ç™»éŒ²ã«é€²ã‚€"]');
  if (scrollToRegistrationBtn) {
    scrollToRegistrationBtn.addEventListener('click', scrollToRegistration);
  }

  try {
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
    const authResult = await verifyAuthentication();
    const email = authResult.email;
    
    userEmail = email;
    document.getElementById('user-email').textContent = email || 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã§ãã¾ã›ã‚“';

    if (email) {
      // è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ©Ÿèƒ½: ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚§ãƒƒã‚¯
      const existingBoardResult = await checkExistingBoard();
      
      if (existingBoardResult && existingBoardResult.status === 'existing_user') {
        showMessage('æ—¢å­˜ã®èªè¨¼æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ç®¡ç†ãƒ‘ãƒãƒ«ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™...', 'success');
        // 1ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã‚€æ™‚é–“ã‚’ç¢ºä¿ï¼‰
        setTimeout(() => {
          window.location.replace(existingBoardResult.adminUrl);
        }, 1000);
        return; // ä»¥é™ã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
      }
      
      updateStep(2); // Account verification step
      
      // æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ‰±ã„ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
      const treatAsNewAccount = sessionStorage.getItem('treat_as_new_account') === 'true';
      
      if (treatAsNewAccount) {
        // æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ‰±ã„ã®å ´åˆã¯æ—¢å­˜ãƒœãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—
        sessionStorage.removeItem('treat_as_new_account'); // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
        updateStep(3);
        document.getElementById('register-btn').disabled = false;
        showMessage('æ–°ã—ã„èªè¨¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ç™»éŒ²ã‚’é–‹å§‹ã§ãã¾ã™ã€‚', 'success');
      } else {
        // é€šå¸¸ã®æ—¢å­˜ãƒœãƒ¼ãƒ‰æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
        google.script.run
          .withSuccessHandler((result) => {
            if (result && result.status) {
              switch (result.status) {
                case 'setup_required':
                  updateStep(3);
                  showMessage('ã‚·ã‚¹ãƒ†ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã™ã€‚ç®¡ç†è€…ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§ã®åˆæœŸè¨­å®šã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚', 'warning');
                  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
                  google.script.run
                    .withSuccessHandler((appUrl) => {
                      const setupUrl = appUrl + '?setup=true';
                      showMessage(`ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸: <a href="${setupUrl}" target="_blank" style="color: #8be9fd;">ã“ã¡ã‚‰</a>`, 'info');
                    })
                    .withFailureHandler(() => {
                      const setupUrl = window.location.href.split('?')[0] + '?setup=true';
                      showMessage(`ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸: <a href="${setupUrl}" target="_blank" style="color: #8be9fd;">ã“ã¡ã‚‰</a>`, 'info');
                    })
                    .getWebAppUrl();
                  break;
                case 'existing_user':
                  updateStep(3);
                  document.getElementById('register-btn').disabled = true;
                  showMessage('æ—¢å­˜ã®èªè¨¼æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚', 'info');
                  if (result.adminUrl) {
                    const messageArea = document.getElementById('message-area');
                    messageArea.innerHTML += `<div class="mt-2"><a href="${result.adminUrl}" target="_blank" class="text-cyan-400 hover:text-cyan-300 underline">ç®¡ç†ç”»é¢ã‚’é–‹ã</a></div>`;
                  }
                  break;
                case 'new_user':
                  updateStep(3);
                  document.getElementById('register-btn').disabled = false;
                  showMessage('èªè¨¼ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ•™è‚²ç”¨å›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹å§‹ã§ãã¾ã™ã€‚', 'success');
                  break;
                case 'auth_required':
                  showMessage('Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
                  break;
                default:
                  updateStep(3);
                  document.getElementById('register-btn').disabled = false;
                  showMessage('èªè¨¼ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸã€‚StudyQuestã‚’é–‹å§‹ã§ãã¾ã™ã€‚', 'success');
                  break;
              }
            } else {
              // ãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼ã®å¯¾å¿œ
              if (result && result.userId) {
                updateStep(3);
                document.getElementById('register-btn').disabled = true;
                showMessage('æ—¢å­˜ã®èªè¨¼æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚', 'info');
                if (result.adminUrl) {
                  const messageArea = document.getElementById('message-area');
                  messageArea.innerHTML += `<div class="mt-2"><a href="${result.adminUrl}" target="_blank" class="text-cyan-400 hover:text-cyan-300 underline">ç®¡ç†ç”»é¢ã‚’é–‹ã</a></div>`;
                }
              } else {
                updateStep(3);
                document.getElementById('register-btn').disabled = false;
                showMessage('èªè¨¼ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ•™è‚²ç”¨å›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹å§‹ã§ãã¾ã™ã€‚', 'success');
              }
            }
          })
        .withFailureHandler((error) => {
          console.warn('æ—¢å­˜ãƒœãƒ¼ãƒ‰ç¢ºèªã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
          updateStep(3);
          document.getElementById('register-btn').disabled = false;
          showMessage('èªè¨¼ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸã€‚StudyQuestã‚’é–‹å§‹ã§ãã¾ã™ã€‚', 'success');
        })
        .getExistingBoard();
      }
    } else {
      showMessage('Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
    }
  } catch (error) {
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å®‰å…¨ãªå‡¦ç†
    console.warn('èªè¨¼ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    document.getElementById('user-email').textContent = 'èªè¨¼ã‚¨ãƒ©ãƒ¼';
    showMessage('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
  }
});

// Enterã‚­ãƒ¼å¯¾å¿œï¼ˆç™»éŒ²ãƒœã‚¿ãƒ³ç”¨ï¼‰
document.addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && !document.getElementById('register-btn').disabled) {
    // Registration page doesn't have URL input field, so just trigger registration if focused
    const registerBtn = document.getElementById('register-btn');
    if (registerBtn && !registerBtn.disabled) {
      registerBtn.click();
    }
  }
});

// ç™»éŒ²å‡¦ç†
document.getElementById('register-btn').addEventListener('click', async () => {
  const btn = document.getElementById('register-btn');
  const messageArea = document.getElementById('message-area');
  
  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: å…¥åŠ›æ¤œè¨¼
  if (!userEmail || !validateInput(userEmail, 'email')) {
    showMessage('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¿…è¦ã§ã™ã€‚', 'error');
    return;
  }
  
  // çµ±åˆç‰ˆã§ã¯å¸¸ã«è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  const setupMethod = 'auto';
  const spreadsheetUrl = 'AUTO_CREATE';
  
  // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
  btn.disabled = true;
  btn.innerHTML = `
    <svg class="w-5 h-5 spinner inline-block mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
    </svg>
    ç™»éŒ²å‡¦ç†ä¸­...
  `;
  showMessage('å›ç­”ãƒœãƒ¼ãƒ‰ã‚’æº–å‚™ä¸­ã§ã™...', 'info');
  
  // ç™»éŒ²å‡¦ç†ã‚’å®Ÿè¡Œ
  google.script.run
    .withSuccessHandler(result => {
      showMessage(result.message || 'ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');

      const resultArea = document.getElementById('result-area');
      resultArea.innerHTML = `
        <div class="glass-panel rounded-lg p-6 space-y-6">
          <div class="text-center">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="font-bold text-2xl text-green-400 mb-2">ğŸ‰ ç™»éŒ²å®Œäº†ï¼</h3>
            <p class="text-gray-300">ã‚ãªãŸå°‚ç”¨ã®å›ç­”ãƒœãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¾ã—ãŸ</p>
          </div>
          
          <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é¸æŠç”»é¢ -->
          <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg p-6 border border-purple-400/30">
            <h4 class="font-bold text-white mb-4 text-center">ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„</h4>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
              <div class="bg-gradient-to-br from-green-500/30 to-cyan-500/30 rounded-lg p-4 border border-green-400/50 hover:border-green-400 transition-all cursor-pointer" id="quickstart-option">
                <div class="text-center">
                  <div class="text-3xl mb-2">ğŸš€</div>
                  <h5 class="font-bold text-green-300 mb-2">ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ</h5>
                  <div class="bg-green-500/20 px-2 py-1 rounded text-xs text-green-200 mb-3">æ¨å¥¨ãƒ»ç°¡å˜</div>
                </div>
                <ul class="text-sm text-green-200 space-y-1 mb-4">
                  <li>âœ“ Googleãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•ä½œæˆ</li>
                  <li>âœ“ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº</li>
                  <li>âœ“ ãƒœãƒ¼ãƒ‰å³åº§å…¬é–‹</li>
                  <li>âœ“ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šé©ç”¨</li>
                </ul>
                <div class="text-center">
                  <div class="text-xs text-green-300 mb-2">â±ï¸ ç´„30ç§’ã§å®Œäº†</div>
                  <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-colors" onclick="startQuickSetup()">
                    ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆé–‹å§‹
                  </button>
                </div>
              </div>
              
              <!-- æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
              <div class="bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-lg p-4 border border-blue-400/50 hover:border-blue-400 transition-all cursor-pointer" id="manual-option">
                <div class="text-center">
                  <div class="text-3xl mb-2">ğŸ”§</div>
                  <h5 class="font-bold text-blue-300 mb-2">æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h5>
                  <div class="bg-blue-500/20 px-2 py-1 rounded text-xs text-blue-200 mb-3">ä¸Šç´šè€…å‘ã‘</div>
                </div>
                <ul class="text-sm text-blue-200 space-y-1 mb-4">
                  <li>âœ“ è©³ç´°è¨­å®šã®èª¿æ•´</li>
                  <li>âœ“ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½</li>
                  <li>âœ“ æ®µéšçš„ãªè¨­å®š</li>
                  <li>âœ“ å®Œå…¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</li>
                </ul>
                <div class="text-center">
                  <div class="text-xs text-blue-300 mb-2">â±ï¸ è¨­å®šæ¬¡ç¬¬</div>
                  <button class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors" onclick="openManualSetup()">
                    ç®¡ç†ç”»é¢ã‚’é–‹ã
                  </button>
                </div>
              </div>
            </div>
            
            <div class="text-center">
              <p class="text-xs text-gray-400">
                ğŸ’¡ å¾Œã‹ã‚‰ã„ã¤ã§ã‚‚è¨­å®šå¤‰æ›´å¯èƒ½ã§ã™
              </p>
            </div>
          </div>
          
          <!-- é€²è¡ŒçŠ¶æ³è¡¨ç¤ºï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
          <div id="quickstart-progress" class="bg-gradient-to-r from-green-500/20 to-blue-500/20 rounded-lg p-4 border border-green-400/30 hidden">
            <h4 class="font-bold text-white mb-2">ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œä¸­...</h4>
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <div class="spinner-small"></div>
                <span class="text-sm text-green-200" id="progress-text">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’æº–å‚™ä¸­...</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%" id="progress-bar"></div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      resultArea.classList.remove('hidden');
      btn.style.display = 'none';
      
      // æ—¢å­˜ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
      const existingInput = document.getElementById('spreadsheet-url');
      if (existingInput) {
        existingInput.disabled = true;
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ç™»éŒ²çµæœã‚’ä¿å­˜ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆç”¨ï¼‰
      window.lastRegistrationResult = result;
      
      
    })
    .withFailureHandler(error => {
      showMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ'}`, 'error');
      btn.disabled = false;
      btn.textContent = 'èªè¨¼ã‚’ç¢ºèªã—ã¦é–‹å§‹ã™ã‚‹';
    })
    .registerNewUser(userEmail);
});

// æ—¢å­˜ãƒœãƒ¼ãƒ‰æƒ…å ±ã®è¡¨ç¤º

// showMessageé–¢æ•°ã¯main.js.htmlã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™

// copyToClipboardé–¢æ•°ã¯main.js.htmlã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™

// é‡è¤‡ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆæ©Ÿèƒ½
function startQuickSetup() {
  // é¸æŠç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã¦é€²è¡ŒçŠ¶æ³ã‚’è¡¨ç¤º
  document.querySelector('.bg-gradient-to-r.from-purple-500\\/20').style.display = 'none';
  document.getElementById('quickstart-progress').classList.remove('hidden');
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—
  const userId = window.lastRegistrationResult?.userId;
  if (!userId) {
    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }
  
  // é€²è¡ŒçŠ¶æ³ã®æ›´æ–°
  updateProgress(10, 'Googleãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆä¸­...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.status === 'success') {
        updateProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼');
        setTimeout(() => {
          showQuickSetupComplete(result);
        }, 1000);
      } else {
        showMessage('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message, 'error');
        showFallbackOptions();
      }
    })
    .withFailureHandler(function(error) {
      console.error('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
      showMessage('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
      showFallbackOptions();
    })
    .quickStartSetup(userId);
}

function openManualSetup() {
  const userId = window.lastRegistrationResult?.userId;
  const adminUrl = window.lastRegistrationResult?.adminUrl;
  
  if (adminUrl) {
    window.open(adminUrl, '_blank');
  } else {
    showMessage('ç®¡ç†ç”»é¢URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
  }
}

function updateProgress(percentage, text) {
  document.getElementById('progress-bar').style.width = percentage + '%';
  document.getElementById('progress-text').textContent = text;
}

function showQuickSetupComplete(result) {
  const progressDiv = document.getElementById('quickstart-progress');
  progressDiv.innerHTML = `
    <div class="text-center space-y-4">
      <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h4 class="font-bold text-green-400 text-xl">ğŸ‰ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†ï¼</h4>
      <p class="text-green-200">å›ç­”ãƒœãƒ¼ãƒ‰ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸ</p>
      
      <div class="bg-green-500/20 rounded-lg p-4 space-y-3">
        <h5 class="font-semibold text-green-300">ğŸ“‹ ä½œæˆã•ã‚ŒãŸã‚‚ã®</h5>
        <ul class="text-sm text-green-200 space-y-1">
          <li>âœ“ ç”Ÿå¾’å›ç­”ç”¨Googleãƒ•ã‚©ãƒ¼ãƒ </li>
          <li>âœ“ è‡ªå‹•é€£æºã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</li>
          <li>âœ“ å…¬é–‹æ¸ˆã¿å›ç­”ãƒœãƒ¼ãƒ‰</li>
          <li>âœ“ åŸºæœ¬è¨­å®šã®é©ç”¨</li>
        </ul>
      </div>
      
      <div class="space-y-2">
        <a href="${result.adminUrl}" target="_blank" 
           class="block w-full px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-colors">
          ğŸš€ ç®¡ç†ç”»é¢ã‚’é–‹ã
        </a>
        <a href="${result.viewUrl}" target="_blank" 
           class="block w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors">
          ğŸ‘€ å›ç­”ãƒœãƒ¼ãƒ‰ã‚’è¦‹ã‚‹
        </a>
        <a href="${result.formUrl}" target="_blank" 
           class="block w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors">
          ğŸ“ Googleãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
        </a>
        <a href="${result.spreadsheetUrl}" target="_blank" 
           class="block w-full px-4 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-semibold transition-colors">
          ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
        </a>
      </div>
    </div>
  `;
}

function showFallbackOptions() {
  // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
  document.getElementById('quickstart-progress').classList.add('hidden');
  document.querySelector('.bg-gradient-to-r.from-purple-500\\/20').style.display = 'block';
  showMessage('æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚', 'info');
}

// ãƒ‡ã‚¸ã‚¿ãƒ«ã‚·ãƒ†ã‚£ã‚ºãƒ³ã‚·ãƒƒãƒ—æ•™è‚²ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showTeacherGuideModal() {
  const modal = document.getElementById('teacherGuideModal');
  modal.classList.remove('hidden');
  
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†
  setTimeout(() => {
    const firstFocusable = modal.querySelector('h2') || modal.querySelector('button');
    if (firstFocusable) firstFocusable.focus();
  }, 100);
}

function hideTeacherGuideModal() {
  const modal = document.getElementById('teacherGuideModal');
  modal.classList.add('hidden');
}

// ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const modal = document.getElementById('teacherGuideModal');
    if (!modal.classList.contains('hidden')) {
      hideTeacherGuideModal();
    }
  }
});

// clearClientSideCacheé–¢æ•°ã¯main.js.htmlã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™

function reloadPageForNewAccount() {
  sessionStorage.setItem('treat_as_new_account', 'true');
  google.script.run
    .withSuccessHandler(function(url) {
      const newUrl = new URL(url);
      newUrl.searchParams.set('t', Date.now());
      window.top.location.href = newUrl.toString();
    })
    .withFailureHandler(function(error) {
      console.error('URLå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      const currentUrl = window.location.href.split('?')[0];
      window.top.location.href = currentUrl + '?t=' + Date.now();
    })
    .getWebAppUrl();
}

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ‰±ã„ã«ã™ã‚‹
function checkForNewAccountFlag() {
  const urlParams = new URLSearchParams(window.location.search);
  const isNewAccount = urlParams.get('new_account') === 'true' || urlParams.get('force_account_selection') === 'true';
  
  if (isNewAccount) {
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    const cleanUrl = window.location.href.split('?')[0];
    history.replaceState({}, document.title, cleanUrl);
    
    // æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ‰±ã„ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    sessionStorage.setItem('treat_as_new_account', 'true');
    showMessage('æ–°ã—ã„èªè¨¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ç™»éŒ²æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚', 'success');
  }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
document.addEventListener('DOMContentLoaded', function() {
  checkForNewAccountFlag();
});
</script>