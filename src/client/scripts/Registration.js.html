<script>
// Registration Page 専用スクリプト

let userEmail = '';
let currentStep = 1;
let domainInfo = null;

// Registration page specific domain info display - extends the common function

// Registration-specific domain info display
function displayRegistrationDomainInfo(info) {
  const section = document.getElementById('domain-info-section');
  const matchPanel = document.getElementById('domain-match-panel');
  const mismatchPanel = document.getElementById('domain-mismatch-panel');
  
  if (!info || info.error) {
    console.warn('ドメイン情報の取得エラー:', info?.error);
    return;
  }

  if (section) section.classList.remove('hidden');

  if (info.isDomainMatch) {
    // ドメインが一致している場合
    if (matchPanel) matchPanel.classList.remove('hidden');
    if (mismatchPanel) mismatchPanel.classList.add('hidden');
    const domainMatchText = document.getElementById('domain-match-text');
    if (domainMatchText) {
      domainMatchText.textContent = 
        `このウェブアプリは ${info.deployDomain} ドメイン用です。あなたのアカウント（${info.currentDomain}）で利用できます。`;
    }
  } else {
    // ドメインが不一致の場合
    if (matchPanel) matchPanel.classList.add('hidden');
    if (mismatchPanel) mismatchPanel.classList.remove('hidden');
    const domainMismatchText = document.getElementById('domain-mismatch-text');
    const deployDomain = document.getElementById('deploy-domain');
    if (domainMismatchText) {
      domainMismatchText.textContent = 
        `あなたのアカウントのドメイン（${info.currentDomain}）とは異なります。機能が制限される可能性があります。`;
    }
    if (deployDomain) deployDomain.textContent = info.deployDomain;
  }
}

// Scroll to registration function
function scrollToRegistration() {
  document.getElementById('section-3').scrollIntoView({ 
    behavior: 'smooth', 
    block: 'start' 
  });
  updateStep(3);
}

// Update step progress
function updateStep(step) {
  currentStep = step;
  
  // Update progress bar with performance optimization
  const progressBar = document.getElementById('progress-bar');
  requestAnimationFrame(() => {
    progressBar.style.width = `${(step / 3) * 100}%`;
  });
  
  // Update step indicators
  for (let i = 1; i <= 3; i++) {
    const stepElement = document.getElementById(`step-${i}`);
    const stepIndicator = document.getElementById(`step-${i}`);
    
    if (stepElement) {
      if (i <= step) {
        stepElement.classList.add('completed');
        const stepCircle = stepElement.querySelector('div');
        if (stepCircle) {
          stepCircle.className = 'w-8 h-8 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm relative z-10';
        }
        const stepLabel = stepElement.querySelector('span');
        if (stepLabel) {
          stepLabel.className = 'text-xs mt-2 block text-cyan-400';
        }
      } else {
        stepElement.classList.remove('completed');
        const stepCircle = stepElement.querySelector('div');
        if (stepCircle) {
          stepCircle.className = 'w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm relative z-10';
        }
        const stepLabel = stepElement.querySelector('span');
        if (stepLabel) {
          stepLabel.className = 'text-xs mt-2 block text-gray-400';
        }
      }
    }
    
    // Update section-specific icons (for steps 2 and 3)
    const iconElement = document.getElementById(`step-${i}-icon`);
    if (iconElement) {
      if (i <= step) {
        iconElement.className = 'w-6 h-6 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm';
      } else {
        iconElement.className = 'w-6 h-6 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm';
      }
    }
  }
}

// verifyAuthentication関数はmain.js.htmlで定義されています

// 既存ボードをチェックする関数（自動リダイレクト用）
function checkExistingBoard() {
  return new Promise((resolve, reject) => {
    const timeoutId = setTimeout(() => {
      reject(new Error('既存ボードチェックタイムアウト'));
    }, 5000);

    google.script.run
      .withSuccessHandler(result => {
        clearTimeout(timeoutId);
        resolve(result);
      })
      .withFailureHandler(error => {
        clearTimeout(timeoutId);
        console.error('既存ボードチェックエラー:', error);
        // エラーの場合は新規ユーザーとして扱う
        resolve({ status: 'new_user' });
      })
      .getExistingBoard();
  });
}

// loadDomainInfo関数とdisplayDomainInfo関数はmain.js.htmlで定義されています

// ユーザーメールアドレスを取得
window.addEventListener('DOMContentLoaded', async () => {
  // ローディング表示
  showMessage('認証状態を確認中...', 'info');
  
  // ドメイン情報を取得
  loadDomainInfo();
  
  // scrollToRegistrationのイベントリスナーを設定
  const scrollToRegistrationBtn = document.querySelector('button[aria-label="新規登録に進む"]');
  if (scrollToRegistrationBtn) {
    scrollToRegistrationBtn.addEventListener('click', scrollToRegistration);
  }

  try {
    // セキュリティ強化: 認証状態を確認
    const authResult = await verifyAuthentication();
    const email = authResult.email;
    
    userEmail = email;
    document.getElementById('user-email').textContent = email || 'メールアドレスを取得できません';

    if (email) {
      // 自動リダイレクト機能: 登録済みユーザーチェック
      const existingBoardResult = await checkExistingBoard();
      
      if (existingBoardResult && existingBoardResult.status === 'existing_user') {
        showMessage('既存の認証済みアカウントが見つかりました。管理パネルにリダイレクトします...', 'success');
        // 1秒後にリダイレクト（ユーザーがメッセージを読む時間を確保）
        setTimeout(() => {
          window.location.replace(existingBoardResult.adminUrl);
        }, 1000);
        return; // 以降の処理をスキップ
      }
      
      updateStep(2); // Account verification step
      
      // 新規アカウント扱いフラグをチェック
      const treatAsNewAccount = sessionStorage.getItem('treat_as_new_account') === 'true';
      
      if (treatAsNewAccount) {
        // 新規アカウント扱いの場合は既存ボードチェックをスキップ
        sessionStorage.removeItem('treat_as_new_account'); // フラグをクリア
        updateStep(3);
        document.getElementById('register-btn').disabled = false;
        showMessage('新しい認証アカウントでの登録を開始できます。', 'success');
      } else {
        // 通常の既存ボード情報をチェック
        google.script.run
          .withSuccessHandler((result) => {
            if (result && result.status) {
              switch (result.status) {
                case 'setup_required':
                  updateStep(3);
                  showMessage('システムセットアップが必要です。管理者にセットアップページでの初期設定を依頼してください。', 'warning');
                  // セットアップページへのリンクを表示
                  google.script.run
                    .withSuccessHandler((appUrl) => {
                      const setupUrl = appUrl + '?setup=true';
                      showMessage(`セットアップページ: <a href="${setupUrl}" target="_blank" style="color: #8be9fd;">こちら</a>`, 'info');
                    })
                    .withFailureHandler(() => {
                      const setupUrl = window.location.href.split('?')[0] + '?setup=true';
                      showMessage(`セットアップページ: <a href="${setupUrl}" target="_blank" style="color: #8be9fd;">こちら</a>`, 'info');
                    })
                    .getWebAppUrl();
                  break;
                case 'existing_user':
                  updateStep(3);
                  document.getElementById('register-btn').disabled = true;
                  showMessage('既存の認証済みアカウントが見つかりました。管理画面にアクセスしてください。', 'info');
                  if (result.adminUrl) {
                    const messageArea = document.getElementById('message-area');
                    messageArea.innerHTML += `<div class="mt-2"><a href="${result.adminUrl}" target="_blank" class="text-cyan-400 hover:text-cyan-300 underline">管理画面を開く</a></div>`;
                  }
                  break;
                case 'new_user':
                  updateStep(3);
                  document.getElementById('register-btn').disabled = false;
                  showMessage('認証確認が完了しました。教育用回答ボードを開始できます。', 'success');
                  break;
                case 'auth_required':
                  showMessage('Googleアカウントでログインしてください。', 'error');
                  break;
                default:
                  updateStep(3);
                  document.getElementById('register-btn').disabled = false;
                  showMessage('認証確認が完了しました。StudyQuestを開始できます。', 'success');
                  break;
              }
            } else {
              // レガシー形式の対応
              if (result && result.userId) {
                updateStep(3);
                document.getElementById('register-btn').disabled = true;
                showMessage('既存の認証済みアカウントが見つかりました。管理画面にアクセスしてください。', 'info');
                if (result.adminUrl) {
                  const messageArea = document.getElementById('message-area');
                  messageArea.innerHTML += `<div class="mt-2"><a href="${result.adminUrl}" target="_blank" class="text-cyan-400 hover:text-cyan-300 underline">管理画面を開く</a></div>`;
                }
              } else {
                updateStep(3);
                document.getElementById('register-btn').disabled = false;
                showMessage('認証確認が完了しました。教育用回答ボードを開始できます。', 'success');
              }
            }
          })
        .withFailureHandler((error) => {
          console.warn('既存ボード確認で問題が発生しました:', error);
          updateStep(3);
          document.getElementById('register-btn').disabled = false;
          showMessage('認証確認が完了しました。StudyQuestを開始できます。', 'success');
        })
        .getExistingBoard();
      }
    } else {
      showMessage('Googleアカウントでログインしてください。', 'error');
    }
  } catch (error) {
    // セキュリティ強化: 認証エラーの安全な処理
    console.warn('認証確認中にエラーが発生しました');
    document.getElementById('user-email').textContent = '認証エラー';
    showMessage('認証が必要です。Googleアカウントでログインしてください。', 'error');
  }
});

// Enterキー対応（登録ボタン用）
document.addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && !document.getElementById('register-btn').disabled) {
    // Registration page doesn't have URL input field, so just trigger registration if focused
    const registerBtn = document.getElementById('register-btn');
    if (registerBtn && !registerBtn.disabled) {
      registerBtn.click();
    }
  }
});

// 登録処理
document.getElementById('register-btn').addEventListener('click', async () => {
  const btn = document.getElementById('register-btn');
  const messageArea = document.getElementById('message-area');
  
  // セキュリティ強化: 入力検証
  if (!userEmail || !validateInput(userEmail, 'email')) {
    showMessage('有効なメールアドレスが必要です。', 'error');
    return;
  }
  
  // 統合版では常に自動セットアップ
  const setupMethod = 'auto';
  const spreadsheetUrl = 'AUTO_CREATE';
  
  // ボタンを無効化
  btn.disabled = true;
  btn.innerHTML = `
    <svg class="w-5 h-5 spinner inline-block mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
    </svg>
    登録処理中...
  `;
  showMessage('回答ボードを準備中です...', 'info');
  
  // 登録処理を実行
  google.script.run
    .withSuccessHandler(result => {
      showMessage(result.message || '登録が完了しました！', 'success');

      const resultArea = document.getElementById('result-area');
      resultArea.innerHTML = `
        <div class="glass-panel rounded-lg p-6 space-y-6">
          <div class="text-center">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="font-bold text-2xl text-green-400 mb-2">🎉 登録完了！</h3>
            <p class="text-gray-300">あなた専用の回答ボードが作成されました</p>
          </div>
          
          <!-- セットアップ選択画面 -->
          <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg p-6 border border-purple-400/30">
            <h4 class="font-bold text-white mb-4 text-center">🚀 次のステップを選択してください</h4>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- クイックスタートオプション -->
              <div class="bg-gradient-to-br from-green-500/30 to-cyan-500/30 rounded-lg p-4 border border-green-400/50 hover:border-green-400 transition-all cursor-pointer" id="quickstart-option">
                <div class="text-center">
                  <div class="text-3xl mb-2">🚀</div>
                  <h5 class="font-bold text-green-300 mb-2">クイックスタート</h5>
                  <div class="bg-green-500/20 px-2 py-1 rounded text-xs text-green-200 mb-3">推奨・簡単</div>
                </div>
                <ul class="text-sm text-green-200 space-y-1 mb-4">
                  <li>✓ Googleフォーム自動作成</li>
                  <li>✓ スプレッドシート連携</li>
                  <li>✓ ボード即座公開</li>
                  <li>✓ デフォルト設定適用</li>
                </ul>
                <div class="text-center">
                  <div class="text-xs text-green-300 mb-2">⏱️ 約30秒で完了</div>
                  <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-colors" onclick="startQuickSetup()">
                    クイックスタート開始
                  </button>
                </div>
              </div>
              
              <!-- 手動セットアップオプション -->
              <div class="bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-lg p-4 border border-blue-400/50 hover:border-blue-400 transition-all cursor-pointer" id="manual-option">
                <div class="text-center">
                  <div class="text-3xl mb-2">🔧</div>
                  <h5 class="font-bold text-blue-300 mb-2">手動セットアップ</h5>
                  <div class="bg-blue-500/20 px-2 py-1 rounded text-xs text-blue-200 mb-3">上級者向け</div>
                </div>
                <ul class="text-sm text-blue-200 space-y-1 mb-4">
                  <li>✓ 詳細設定の調整</li>
                  <li>✓ カスタマイズ可能</li>
                  <li>✓ 段階的な設定</li>
                  <li>✓ 完全コントロール</li>
                </ul>
                <div class="text-center">
                  <div class="text-xs text-blue-300 mb-2">⏱️ 設定次第</div>
                  <button class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors" onclick="openManualSetup()">
                    管理画面を開く
                  </button>
                </div>
              </div>
            </div>
            
            <div class="text-center">
              <p class="text-xs text-gray-400">
                💡 後からいつでも設定変更可能です
              </p>
            </div>
          </div>
          
          <!-- 進行状況表示（初期は非表示） -->
          <div id="quickstart-progress" class="bg-gradient-to-r from-green-500/20 to-blue-500/20 rounded-lg p-4 border border-green-400/30 hidden">
            <h4 class="font-bold text-white mb-2">🚀 クイックスタート実行中...</h4>
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <div class="spinner-small"></div>
                <span class="text-sm text-green-200" id="progress-text">セットアップを準備中...</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%" id="progress-bar"></div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      resultArea.classList.remove('hidden');
      btn.style.display = 'none';
      
      // 既存スプレッドシート入力を無効化
      const existingInput = document.getElementById('spreadsheet-url');
      if (existingInput) {
        existingInput.disabled = true;
      }

      // グローバル変数に登録結果を保存（クイックスタート用）
      window.lastRegistrationResult = result;
      
      
    })
    .withFailureHandler(error => {
      showMessage(`エラー: ${error.message || '登録に失敗しました'}`, 'error');
      btn.disabled = false;
      btn.textContent = '認証を確認して開始する';
    })
    .registerNewUser(userEmail);
});

// 既存ボード情報の表示

// showMessage関数はmain.js.htmlで定義されています

// copyToClipboard関数はmain.js.htmlで定義されています

// 重複するイベントリスナーは削除されました

// クイックスタート機能
function startQuickSetup() {
  // 選択画面を非表示にして進行状況を表示
  document.querySelector('.bg-gradient-to-r.from-purple-500\\/20').style.display = 'none';
  document.getElementById('quickstart-progress').classList.remove('hidden');
  
  // グローバル変数から必要な情報を取得
  const userId = window.lastRegistrationResult?.userId;
  if (!userId) {
    showMessage('ユーザーIDが見つかりません。ページを再読み込みしてください。', 'error');
    return;
  }
  
  // 進行状況の更新
  updateProgress(10, 'Googleフォームを作成中...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.status === 'success') {
        updateProgress(100, 'セットアップ完了！');
        setTimeout(() => {
          showQuickSetupComplete(result);
        }, 1000);
      } else {
        showMessage('クイックスタートに失敗しました: ' + result.message, 'error');
        showFallbackOptions();
      }
    })
    .withFailureHandler(function(error) {
      console.error('クイックスタートエラー:', error);
      showMessage('クイックスタートに失敗しました。手動セットアップをお試しください。', 'error');
      showFallbackOptions();
    })
    .quickStartSetup(userId);
}

function openManualSetup() {
  const userId = window.lastRegistrationResult?.userId;
  const adminUrl = window.lastRegistrationResult?.adminUrl;
  
  if (adminUrl) {
    window.open(adminUrl, '_blank');
  } else {
    showMessage('管理画面URLが見つかりません。ページを再読み込みしてください。', 'error');
  }
}

function updateProgress(percentage, text) {
  document.getElementById('progress-bar').style.width = percentage + '%';
  document.getElementById('progress-text').textContent = text;
}

function showQuickSetupComplete(result) {
  const progressDiv = document.getElementById('quickstart-progress');
  progressDiv.innerHTML = `
    <div class="text-center space-y-4">
      <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h4 class="font-bold text-green-400 text-xl">🎉 クイックスタート完了！</h4>
      <p class="text-green-200">回答ボードの準備が整いました</p>
      
      <div class="bg-green-500/20 rounded-lg p-4 space-y-3">
        <h5 class="font-semibold text-green-300">📋 作成されたもの</h5>
        <ul class="text-sm text-green-200 space-y-1">
          <li>✓ 生徒回答用Googleフォーム</li>
          <li>✓ 自動連携スプレッドシート</li>
          <li>✓ 公開済み回答ボード</li>
          <li>✓ 基本設定の適用</li>
        </ul>
      </div>
      
      <div class="space-y-2">
        <a href="${result.adminUrl}" target="_blank" 
           class="block w-full px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-colors">
          🚀 管理画面を開く
        </a>
        <a href="${result.viewUrl}" target="_blank" 
           class="block w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors">
          👀 回答ボードを見る
        </a>
        <a href="${result.formUrl}" target="_blank" 
           class="block w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors">
          📝 Googleフォームを開く
        </a>
        <a href="${result.spreadsheetUrl}" target="_blank" 
           class="block w-full px-4 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-semibold transition-colors">
          📊 スプレッドシートを開く
        </a>
      </div>
    </div>
  `;
}

function showFallbackOptions() {
  // エラー時のフォールバックオプションを表示
  document.getElementById('quickstart-progress').classList.add('hidden');
  document.querySelector('.bg-gradient-to-r.from-purple-500\\/20').style.display = 'block';
  showMessage('手動セットアップをお試しください。', 'info');
}

// デジタルシティズンシップ教育ガイドモーダル表示
function showTeacherGuideModal() {
  const modal = document.getElementById('teacherGuideModal');
  modal.classList.remove('hidden');
  
  // フォーカス管理
  setTimeout(() => {
    const firstFocusable = modal.querySelector('h2') || modal.querySelector('button');
    if (firstFocusable) firstFocusable.focus();
  }, 100);
}

function hideTeacherGuideModal() {
  const modal = document.getElementById('teacherGuideModal');
  modal.classList.add('hidden');
}

// ESCキーでモーダルを閉じる
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const modal = document.getElementById('teacherGuideModal');
    if (!modal.classList.contains('hidden')) {
      hideTeacherGuideModal();
    }
  }
});

// clearClientSideCache関数はmain.js.htmlで定義されています

function reloadPageForNewAccount() {
  sessionStorage.setItem('treat_as_new_account', 'true');
  google.script.run
    .withSuccessHandler(function(url) {
      const newUrl = new URL(url);
      newUrl.searchParams.set('t', Date.now());
      window.top.location.href = newUrl.toString();
    })
    .withFailureHandler(function(error) {
      console.error('URL取得に失敗しました:', error);
      const currentUrl = window.location.href.split('?')[0];
      window.top.location.href = currentUrl + '?t=' + Date.now();
    })
    .getWebAppUrl();
}

// URLパラメータをチェックして新規アカウント扱いにする
function checkForNewAccountFlag() {
  const urlParams = new URLSearchParams(window.location.search);
  const isNewAccount = urlParams.get('new_account') === 'true' || urlParams.get('force_account_selection') === 'true';
  
  if (isNewAccount) {
    // URLパラメータをクリーンアップ
    const cleanUrl = window.location.href.split('?')[0];
    history.replaceState({}, document.title, cleanUrl);
    
    // 新規アカウント扱いフラグを設定
    sessionStorage.setItem('treat_as_new_account', 'true');
    showMessage('新しい認証アカウントでの登録準備が整いました。', 'success');
  }
}

// ページ読み込み時にフラグをチェック
document.addEventListener('DOMContentLoaded', function() {
  checkForNewAccountFlag();
});
</script>