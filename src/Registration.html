<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <title>StudyQuest - 登録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <style>
    /* GAS IFRAME FIX: Maximum CSS specificity and priority */
    html[lang="ja"], html {
      background: linear-gradient(135deg, #1a1b26 0%, #0f172a 50%, #1e1b4b 100%) !important;
      min-height: 100vh !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    body {
      background: linear-gradient(135deg, #1a1b26 0%, #0f172a 50%, #1e1b4b 100%) !important;
      min-height: 100vh !important;
      margin: 0 !important;
      padding: 20px !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      overflow-x: hidden !important;
      width: 100% !important;
    }

    html, body, div, span, h1, h2, h3, h4, h5, h6, p, button, a {
      box-sizing: border-box !important;
    }
    
    body::before {
      content: '' !important;
      position: fixed !important;
      top: 0 !important; left: 0 !important;
      width: 100% !important; height: 100% !important;
      background: radial-gradient(ellipse at top left, rgba(6, 182, 212, 0.1) 0%, transparent 70%),
                  radial-gradient(ellipse at bottom right, rgba(168, 85, 247, 0.08) 0%, transparent 70%) !important;
      z-index: -1 !important;
    }

    .glass-container {
      background: rgba(255, 255, 255, 0.08) !important;
      -webkit-backdrop-filter: blur(20px) !important;
      backdrop-filter: blur(20px) !important;
      border-radius: 24px !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      width: 100% !important;
      max-width: 420px !important;
      padding: 40px 32px !important;
      position: relative !important;
      z-index: 1 !important;
      text-align: center !important;
      animation: fadeIn 0.6s ease-out;
      /* Prevent creating a new stacking context that blocks modals */
      isolation: auto !important;
    }

    .header { margin-bottom: 40px !important; }
    .logo {
      width: 56px !important; height: 56px !important;
      background: linear-gradient(135deg, #06b6d4 0%, #a855f7 100%) !important;
      border-radius: 16px !important;
      margin: 0 auto 16px !important;
      display: flex !important; align-items: center !important; justify-content: center !important;
      font-size: 24px !important; color: white !important; font-weight: 600 !important;
    }
    .title { font-size: 28px !important; font-weight: 700 !important; color: white !important; margin-bottom: 8px !important; }
    .subtitle { font-size: 16px !important; color: rgba(255, 255, 255, 0.7) !important; margin-bottom: 0 !important; }

    .status-card {
      background: rgba(255, 255, 255, 0.05) !important;
      border-radius: 16px !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      padding: 20px !important;
      margin-bottom: 32px !important;
    }
    .status-text { font-size: 14px !important; color: rgba(255, 255, 255, 0.8) !important; margin-bottom: 8px !important; }
    .user-email { font-size: 16px !important; font-weight: 600 !important; color: white !important; word-break: break-all !important; }

    .register-btn {
      width: 100% !important;
      background: linear-gradient(135deg, #06b6d4 0%, #a855f7 100%) !important;
      border: none !important;
      border-radius: 12px !important;
      padding: 16px 24px !important;
      font-size: 16px !important;
      font-weight: 600 !important;
      color: white !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      margin-bottom: 24px !important;
    }
    .register-btn:hover:not(:disabled) { transform: translateY(-1px) !important; box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4) !important; }
    .register-btn:disabled { opacity: 0.6 !important; cursor: not-allowed !important; }
    .spinner {
      width: 20px !important; height: 20px !important;
      border: 2px solid rgba(255, 255, 255, 0.3) !important;
      border-top: 2px solid white !important;
      border-radius: 50% !important;
      animation: spin 1s linear infinite !important;
      display: inline-block !important; vertical-align: middle !important; margin-right: 8px !important;
    }

    .message-area { min-height: 24px !important; display: flex !important; align-items: center !important; justify-content: center !important; margin-bottom: 24px !important; font-size: 14px !important; color: rgba(255, 255, 255, 0.8) !important; }
    .message-area.error { color: #ef4444 !important; }
    .message-area.success { color: #10b981 !important; }
    .message-area.warning { color: #f59e0b !important; }

    .footer { text-align: center !important; font-size: 12px !important; color: rgba(255, 255, 255, 0.5) !important; margin-top: 8px !important; }
    .footer a { color: rgba(255, 255, 255, 0.7) !important; text-decoration: none !important; border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important; transition: color 0.2s ease !important; cursor: pointer !important; }
    .footer a:hover { color: white !important; }

    .success-container { display: none; /* Initially hidden */ }
    .success-icon { width: 64px !important; height: 64px !important; background: #10b981 !important; border-radius: 50% !important; margin: 0 auto 24px !important; display: flex !important; align-items: center !important; justify-content: center !important; font-size: 28px !important; color: white !important; }
    .action-btn { display: block !important; padding: 14px 24px !important; border-radius: 10px !important; border: none !important; font-size: 15px !important; font-weight: 600 !important; text-decoration: none !important; color: white !important; margin-top: 12px !important; cursor: pointer !important; }
    .action-btn.primary { background: linear-gradient(135deg, #06b6d4 0%, #a855f7 100%) !important; }
    .action-btn.secondary { background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ドメイン情報表示のスタイル */
    .domain-info {
      width: 100% !important;
      text-align: center !important;
    }

    .glass-panel {
      background: rgba(255, 255, 255, 0.05) !important;
      border-radius: 12px !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      transition: all 0.3s ease !important;
    }

    .hidden {
      display: none !important;
    }

    .flex {
      display: flex !important;
    }

    .items-center {
      align-items: center !important;
    }

    .gap-2 {
      gap: 8px !important;
    }

    /* グラデーション背景の調整 */
    .bg-gradient-to-r {
      background: linear-gradient(90deg, var(--tw-gradient-from), var(--tw-gradient-to)) !important;
    }

    .from-green-500\/10 {
      --tw-gradient-from: rgba(34, 197, 94, 0.1) !important;
    }

    .to-emerald-500\/10 {
      --tw-gradient-to: rgba(16, 185, 129, 0.1) !important;
    }

    .from-yellow-500\/10 {
      --tw-gradient-from: rgba(234, 179, 8, 0.1) !important;
    }

    .to-orange-500\/10 {
      --tw-gradient-to: rgba(249, 115, 22, 0.1) !important;
    }

    .from-blue-500\/10 {
      --tw-gradient-from: rgba(59, 130, 246, 0.1) !important;
    }

    .to-purple-500\/10 {
      --tw-gradient-to: rgba(168, 85, 247, 0.1) !important;
    }

    /* ボーダーカラー */
    .border-green-400\/30 {
      border-color: rgba(74, 222, 128, 0.3) !important;
    }

    .border-yellow-400\/30 {
      border-color: rgba(251, 191, 36, 0.3) !important;
    }

    .border-blue-400\/30 {
      border-color: rgba(96, 165, 250, 0.3) !important;
    }

    /* テキストカラー */
    .text-green-400 {
      color: rgba(74, 222, 128, 1) !important;
    }

    .text-yellow-400 {
      color: rgba(251, 191, 36, 1) !important;
    }

    .text-blue-400 {
      color: rgba(96, 165, 250, 1) !important;
    }

    .text-sm {
      font-size: 14px !important;
    }

    .font-semibold {
      font-weight: 600 !important;
    }

    .w-4 {
      width: 16px !important;
    }

    .h-4 {
      height: 16px !important;
    }

    .p-3 {
      padding: 12px !important;
    }


    /* ================================================= */
    /* ★★★ 教師向けシンプル情報アクセス ★★★ */
    /* ================================================= */
    .registration-page .teacher-info-access {
      margin-top: 16px;
      text-align: center;
    }

    .registration-page .security-details {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }

    .registration-page .info-summary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      cursor: pointer;
      user-select: none;
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .registration-page .security-details:hover .info-summary {
      background: rgba(255, 255, 255, 0.05);
      color: white;
    }

    .registration-page .info-chevron {
      transition: transform 0.3s ease;
      font-size: 12px;
    }

    .registration-page .security-details[open] .info-chevron {
      transform: rotate(180deg);
    }

    .registration-page .info-content {
      padding: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .registration-page .info-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      text-decoration: none;
      color: rgba(255, 255, 255, 0.8);
      font-size: 13px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.02);
    }

    .registration-page .info-link:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
      transform: translateX(2px);
    }

    /* 教師向けレスポンシブ対応 */
    @media (max-width: 640px) {
      .registration-page .teacher-info-access {
        margin-top: 12px;
      }
      
      .registration-page .info-summary {
        padding: 10px 12px;
        font-size: 13px;
      }
      
      .registration-page .info-content {
        padding: 12px;
      }
      
      .registration-page .info-link {
        padding: 6px 10px;
        font-size: 12px;
      }
      
      .registration-page .footer {
        font-size: 11px;
      }
    }
  </style>

  <?!= include('UnifiedStyles'); ?>

  <?!= include('SharedUtilities'); ?>
</head>
<body class="registration-page">

  <div class="glass-container" id="main-container">
    <div class="header">
      <div class="logo">S</div>
      <h1 class="title">StudyQuest</h1>
      <p class="subtitle">教育用回答ボードシステム</p>
      
      <!-- ドメイン情報表示 -->
      <div class="domain-info" id="domain-info" style="margin-top: 16px;">
        <!-- ドメイン一致表示 -->
        <div id="header-domain-match" class="glass-panel bg-gradient-to-r from-green-500/10 to-emerald-500/10 rounded-lg p-3 border border-green-400/30 hidden">
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-green-400 font-semibold text-sm" id="header-domain-match-text">G Suite ドメイン</div>
          </div>
        </div>
        
        <!-- ドメイン不一致表示 -->
        <div id="header-domain-mismatch" class="glass-panel bg-gradient-to-r from-yellow-500/10 to-orange-500/10 rounded-lg p-3 border border-yellow-400/30 hidden">
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <div class="text-yellow-400 font-semibold text-sm" id="header-domain-mismatch-text">ドメイン不一致</div>
          </div>
        </div>
        
        <!-- 初期状態/ローディング表示 -->
        <div id="header-domain-initial" class="glass-panel bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-lg p-3 border border-blue-400/30">
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-blue-400 font-semibold text-sm" id="header-domain-name-initial">ドメイン確認中</div>
          </div>
        </div>
      </div>
    </div>

    <div class="status-card">
      <div class="status-text" id="status-text">認証情報を確認中</div>
      <div class="user-email" id="user-email"></div>
    </div>


    <div class="message-area" id="message-area"></div>

    <button class="register-btn" id="register-btn" disabled>
      <span id="btn-content">回答ボードを作成</span>
    </button>

    <!-- シンプルフッター（教師向け） -->
    <div class="footer teacher-footer">
      <span class="footer-text">
        システムの
        <a data-modal-trigger="enhanced-privacy" class="footer-link">セキュリティ詳細</a>
        と
        <a data-modal-trigger="enhanced-digital-citizenship" class="footer-link">指導ガイドライン</a>
        について
      </span>
    </div>
  </div>

  <div class="glass-container success-container" id="success-container">
    <div class="success-icon">✓</div>
    <h2 class="title">登録完了</h2>
    <p class="subtitle">回答ボードが正常に作成されました</p>
    <a href="#" class="action-btn primary" id="admin-panel-btn">管理画面を開く</a>
  </div>

  <!-- 統合モーダルシステムを使用 -->
  <?!= include('SharedModals'); ?>


  <script>
    // -------------------------------------------
    // ★★★ 登録処理とモーダル制御のスクリプト ★★★
    // -------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {

      // --- 要素の取得 ---
      const mainContainer = document.getElementById('main-container');
      const successContainer = document.getElementById('success-container');
      const registerBtn = document.getElementById('register-btn');
      const btnContent = document.getElementById('btn-content');
      const statusTextEl = document.getElementById('status-text');
      const userEmailEl = document.getElementById('user-email');
      const messageAreaEl = document.getElementById('message-area');
      const adminPanelBtn = document.getElementById('admin-panel-btn');

      let userEmail = '';
      let isRegistrationInProgress = false;
      let selectedAgeGroup = '';
      let uiInitialized = false;

      // --- 関数定義 ---
      const showMessage = (message, type = 'info') => {
        messageAreaEl.textContent = message;
        messageAreaEl.className = `message-area ${type}`;
      };

      const updateUserDisplay = (email) => {
        userEmail = email;
        statusTextEl.textContent = '認証済み';
        userEmailEl.textContent = email;
        registerBtn.disabled = false;
        showMessage('回答ボードを作成できます', 'success');
        
        // 認証成功後にUIを段階的に表示
        initializeEnhancedUI();
      };

      // --- 新しいUI関数 ---
      const initializeEnhancedUI = () => {
        if (uiInitialized) return;
        uiInitialized = true;

        // 情報カードを段階的に表示
        setTimeout(() => showInfoCards(), 300);
        
        // 年齢層選択を表示（オプション）
        setTimeout(() => showAgeSelector(), 600);
        
        // ヘルプシステムを表示
        setTimeout(() => showHelpSystem(), 900);
        
        // 強化されたフッターを表示
        setTimeout(() => showEnhancedFooter(), 1200);
        
        // 年齢グループの自動判定を試行
        detectAndSetAgeGroup();
      };

      const showInfoCards = () => {
        const infoCardsContainer = document.getElementById('info-cards-container');
        if (infoCardsContainer) {
          infoCardsContainer.style.display = 'grid';
          setTimeout(() => infoCardsContainer.classList.add('show'), 50);
        }
      };

      const showAgeSelector = () => {
        // URLパラメータで年齢層が指定されていない場合のみ表示
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.get('ageGroup')) {
          const ageSelectorContainer = document.getElementById('age-selector-container');
          if (ageSelectorContainer) {
            ageSelectorContainer.style.display = 'block';
            setTimeout(() => ageSelectorContainer.classList.add('show'), 50);
          }
        }
      };

      const showHelpSystem = () => {
        const helpSystem = document.getElementById('help-system');
        if (helpSystem) {
          helpSystem.style.display = 'block';
          setTimeout(() => helpSystem.classList.add('show'), 50);
        }
      };

      const showEnhancedFooter = () => {
        const enhancedFooter = document.getElementById('enhanced-footer');
        const legacyFooter = document.getElementById('legacy-footer');
        
        if (enhancedFooter) {
          enhancedFooter.style.display = 'block';
          setTimeout(() => enhancedFooter.classList.add('show'), 50);
          
          // レガシーフッターを非表示
          if (legacyFooter) {
            legacyFooter.style.display = 'none';
          }
        }
      };

      const detectAndSetAgeGroup = () => {
        // URLパラメータから年齢グループを取得
        const urlParams = new URLSearchParams(window.location.search);
        const ageFromUrl = urlParams.get('ageGroup');
        
        if (ageFromUrl) {
          selectedAgeGroup = ageFromUrl;
          const gradeSelect = document.getElementById('grade-select');
          if (gradeSelect) {
            gradeSelect.value = ageFromUrl;
          }
          console.log('Age group detected from URL:', ageFromUrl);
        } else {
          // デフォルト値を設定
          selectedAgeGroup = 'elementary-upper';
        }
      };

      const handleAgeGroupChange = (newAgeGroup) => {
        selectedAgeGroup = newAgeGroup;
        console.log('Age group changed to:', newAgeGroup);
        
        // 将来的に年齢層に応じてUIをカスタマイズする場合はここに追加
        showMessage(`${getAgeGroupDisplayName(newAgeGroup)}向けの内容で表示します`, 'info');
      };

      const getAgeGroupDisplayName = (ageGroup) => {
        const displayNames = {
          'elementary-lower': '小学校低学年',
          'elementary-upper': '小学校高学年',
          'junior-high': '中学校',
          'high-school': '高等学校',
          'teacher': '教師'
        };
        return displayNames[ageGroup] || '一般';
      };


      const showSuccessResult = (result) => {
        mainContainer.style.display = 'none';
        successContainer.style.display = 'block';
        if (result?.adminUrl && result?.userId) {
          adminPanelBtn.href = result.adminUrl;
          
          console.log('Registration complete, verifying user before navigation:', { 
            adminUrl: result.adminUrl, 
            userId: result.userId 
          });
          
          // Verify user exists before navigation
          google.script.run
            .withSuccessHandler(userExists => {
              console.log('User verification result:', userExists);
              if (userExists && userExists.found) {
                console.log('User verified, proceeding with navigation');
                
                // Show manual navigation dialog for reliability
                setTimeout(() => {
                  window.sharedUtilities.navigation.showManualNavigationDialog(
                    result.adminUrl, 
                    '登録完了！管理パネルに移動します'
                  );
                }, 2000);
                
                // Also try automatic navigation
                google.script.run
                  .withSuccessHandler(navResult => {
                    if (navResult && navResult.success) {
                      console.log('Server navigation prepared:', navResult.redirectUrl);
                      try {
                        if (window.parent && window.parent.location) {
                          window.parent.location.replace(navResult.redirectUrl);
                        } else {
                          window.open(navResult.redirectUrl, '_top');
                        }
                      } catch (e) {
                        console.log('Automatic navigation failed, user will use manual dialog');
                      }
                    }
                  })
                  .withFailureHandler(error => {
                    console.warn('Server navigation failed:', error);
                  })
                  .navigateToAdminPanel(result.userId);
              } else {
                console.error('User verification failed, showing error message');
                showMessage('アカウント作成は完了しましたが、データベースでの確認ができませんでした。しばらく待ってから管理パネルにアクセスしてください。', 'warning');
                
                // Still show navigation option but with delay
                setTimeout(() => {
                  window.sharedUtilities.navigation.showManualNavigationDialog(
                    result.adminUrl, 
                    'データベース同期待ち - 管理パネルにアクセス'
                  );
                }, 5000);
              }
            })
            .withFailureHandler(error => {
              console.error('User verification error:', error);
              showMessage('ユーザー確認でエラーが発生しました。管理パネルに直接アクセスしてください。', 'error');
              
              setTimeout(() => {
                window.sharedUtilities.navigation.showManualNavigationDialog(
                  result.adminUrl, 
                  'エラー発生 - 管理パネルにアクセス'
                );
              }, 3000);
            })
            .verifyUserExists(result.userId);
        }
      };
      
      const executeRegistration = () => {
        if (isRegistrationInProgress || !userEmail) return;

        isRegistrationInProgress = true;
        registerBtn.disabled = true;
        btnContent.innerHTML = '<span class="spinner"></span>登録処理中...';
        showMessage('', 'info');

        google.script.run
          .withSuccessHandler(showSuccessResult)
          .withFailureHandler(error => {
            console.error('Registration error:', error);
            showMessage(error.message || '登録に失敗しました', 'error');
            registerBtn.disabled = false;
            btnContent.textContent = '回答ボードを作成';
            isRegistrationInProgress = false;
          })
          .quickStartSetup();
      };
      
      const initializePage = () => {
        google.script.run
          .withSuccessHandler(result => {
            if (result?.status === 'existing_user') {
              if (result?.userId) {
                // Use server-side navigation for existing users too
                google.script.run
                  .withSuccessHandler(navResult => {
                    if (navResult && navResult.success) {
                      window.location.href = navResult.redirectUrl;
                    } else {
                      window.sharedUtilities.navigation.goToAdminPanel(result.adminUrl, 1000);
                    }
                  })
                  .withFailureHandler(() => {
                    window.sharedUtilities.navigation.goToAdminPanel(result.adminUrl, 1000);
                  })
                  .navigateToAdminPanel(result.userId);
              } else {
                window.sharedUtilities.navigation.goToAdminPanel(result.adminUrl, 1000);
              }
              return;
            }
            google.script.run
              .withSuccessHandler(authResult => {
                if (authResult?.email || authResult?.userEmail) {
                  updateUserDisplay(authResult.email || authResult.userEmail);
                } else {
                  throw new Error('メールアドレスが取得できませんでした');
                }
              })
              .withFailureHandler(err => {
                statusTextEl.textContent = '認証エラー';
                showMessage('ページの再読み込みが必要です', 'error');
                console.error(err);
              })
              .verifyUserAuthentication();
          })
          .getExistingBoard();
      };
      
      // --- 統合モーダル制御 ---
      const setupModalTriggers = () => {
        const modalTriggers = document.querySelectorAll('[data-modal-trigger]');
        modalTriggers.forEach(trigger => {
          trigger.addEventListener('click', (e) => {
            e.preventDefault();
            const modalType = trigger.getAttribute('data-modal-trigger');
            
            // 教師向け固定
            const ageGroup = 'teacher';
            
            console.log(`Opening modal: ${modalType} for age group: ${ageGroup}`);
            
            // SharedModalsの統合システムを使用
            if (modalType === 'enhanced-privacy') {
              window.showEnhancedPrivacyModal && window.showEnhancedPrivacyModal(ageGroup);
            } else if (modalType === 'enhanced-digital-citizenship') {
              window.showEnhancedDigitalCitizenshipModal && window.showEnhancedDigitalCitizenshipModal(ageGroup);
            }
          });
        });
      };


      // --- 登録前確認プロセスの強化 ---
      const executeRegistrationWithConfirmation = () => {
        if (isRegistrationInProgress || !userEmail) return;

        // 年齢に応じたモーダルを先に表示
        const ageGroup = selectedAgeGroup || 'elementary-upper';
        
        if (window.showAgeAppropriateModals) {
          // 統合モーダルシステムを使用
          window.showAgeAppropriateModals(() => {
            executeRegistration();
          });
        } else {
          // フォールバック: 直接登録実行
          executeRegistration();
        }
      };

      // --- 初期化とイベントリスナーの設定 ---
      const initializeEventListeners = () => {
        // 基本的なイベントリスナー
        registerBtn.addEventListener('click', executeRegistrationWithConfirmation);
        
        // 新しいUI要素のイベントリスナー
        setupModalTriggers();
        
        console.log('Enhanced UI event listeners initialized');
      };

      // --- ドメイン情報取得・表示関数 ---
      const fetchAndDisplayDomainInfo = () => {
        google.script.run
          .withSuccessHandler(displayDomainInfo)
          .withFailureHandler(error => {
            console.error('ドメイン情報の取得に失敗しました:', error);
          })
          .getDeployUserDomainInfo();
      };

      const displayDomainInfo = (info) => {
        const headerDomainMatch = document.getElementById('header-domain-match');
        const headerDomainMismatch = document.getElementById('header-domain-mismatch');
        const headerDomainInitial = document.getElementById('header-domain-initial');
        const headerDomainMatchText = document.getElementById('header-domain-match-text');
        const headerDomainMismatchText = document.getElementById('header-domain-mismatch-text');

        // 全てのドメイン表示を非表示
        if (headerDomainMatch) headerDomainMatch.classList.add('hidden');
        if (headerDomainMismatch) headerDomainMismatch.classList.add('hidden');
        if (headerDomainInitial) headerDomainInitial.classList.add('hidden');

        if (!info || info.error) {
          console.warn('ドメイン情報エラー:', info?.error || 'Unknown error');
          return;
        }

        if (info.userDomain === info.deployDomain) {
          // ドメインが一致している場合
          if (headerDomainMatch && headerDomainMatchText) {
            headerDomainMatch.classList.remove('hidden');
            headerDomainMatchText.textContent = `${info.deployDomain} ドメイン`;
          }
        } else {
          // ドメイン不一致の場合
          if (headerDomainMismatch && headerDomainMismatchText) {
            headerDomainMismatch.classList.remove('hidden');
            headerDomainMismatchText.textContent = `外部アクセス (User: ${info.userDomain} | Deploy: ${info.deployDomain})`;
          }
        }
      };

      // --- メイン初期化 ---
      initializePage();
      initializeEventListeners();
      
      // ドメイン情報を取得
      fetchAndDisplayDomainInfo();
    });
  </script>
</body>
</html>