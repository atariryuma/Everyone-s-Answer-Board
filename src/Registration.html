<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <title>教育現場のためのインタラクティブ回答ボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- セキュリティ注意: 外部CDN依存。本番環境ではローカル化を推奨 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --color-primary: #8be9fd;
      --color-background: #1a1b26;
      --color-surface: rgba(26, 27, 38, 0.7);
      --color-text: #c0caf5;
      --color-border: rgba(255, 255, 255, 0.1);
      --color-success: #10b981;
      --color-error: #ef4444;
      --color-warning: #f59e0b;
    }
    
    .glass-panel {
      background: var(--color-surface);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      border: 1px solid var(--color-border);
      transition: all 0.3s ease;
    }
    .glass-panel:hover {
      border-color: rgba(255, 255, 255, 0.2);
      transform: translate3d(0, -2px, 0);
    }
    
    button:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    button:not(:disabled):hover {
      transform: translate3d(0, -2px, 0);
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
    button:active:not(:disabled) {
      transform: translate3d(0, 0, 0);
    }
    
    :focus-visible { 
      outline: 3px solid var(--color-primary); 
      outline-offset: 2px; 
      border-radius: 4px; 
    }
    
    .spinner {
      animation: spin 1s linear infinite;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(139, 233, 253, 0.3);
      border-top: 2px solid var(--color-primary);
      border-radius: 50%;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    
    .step-indicator {
      text-align: center;
      position: relative;
      z-index: 10;
      transition: all 0.3s ease;
    }
    .step-indicator.completed .step-number {
      background-color: var(--color-primary);
      color: #000;
      box-shadow: 0 0 10px rgba(139, 233, 253, 0.5);
    }
    .step-indicator.active .step-number {
      background-color: var(--color-warning);
      color: #000;
      animation: pulse 2s infinite;
    }
    
    #progress-bar {
      transition: width 0.8s ease-in-out;
      background: linear-gradient(90deg, var(--color-primary), #50fa7b);
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    .shake {
      animation: shake 0.5s ease-out;
    }
    
    .feature-card {
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }
    .feature-card:hover {
      border-color: var(--color-primary);
      transform: translate3d(0, -4px, 0);
      box-shadow: 0 12px 24px rgba(139, 233, 253, 0.1);
    }
    
    .cta-button {
      position: relative;
      overflow: hidden;
    }
    .cta-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .cta-button:hover::before {
      left: 100%;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 27, 38, 0.9);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; will-change: opacity; }
      to { opacity: 1; }
    }
    @keyframes slideIn {
      from { opacity: 0; will-change: opacity; }
      to { opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { will-change: transform; }
      50% { transform: scale3d(1.05, 1.05, 1); }
    }
    @keyframes shake {
      0%, 100% { will-change: transform; }
      25% { transform: translate3d(-5px, 0, 0); }
      75% { transform: translate3d(5px, 0, 0); }
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
      .glass-panel {
        margin: 1rem;
        padding: 1.5rem;
      }
      .step-indicator .step-number {
        width: 1.5rem;
        height: 1.5rem;
        font-size: 0.75rem;
      }
    }
    
    /* Performance optimizations */
    .fade-in, .slide-in, .pulse, .shake {
      will-change: auto;
    }
    
    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Low-end device optimizations */
    @media (max-width: 768px) and (max-resolution: 150dpi) {
      .glass-panel {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        background: rgba(26, 27, 38, 0.95);
      }
      .feature-card:hover {
        transform: none;
        box-shadow: 0 4px 8px rgba(139, 233, 253, 0.1);
      }
    }
  </style>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans min-h-screen flex items-center justify-center p-4">
  <div class="glass-panel rounded-xl p-8 max-w-2xl w-full shadow-2xl">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-yellow-300 mb-2">StudyQuest -みんなの回答ボード-</h1>
      <p class="text-gray-400">教育現場のためのインタラクティブ回答ボード</p>
    </div>
    
    <!-- Domain Information -->
    <div id="domain-info-section" class="mb-6 hidden">
      <div id="domain-match-panel" class="glass-panel bg-gradient-to-r from-green-500/10 to-emerald-500/10 rounded-lg p-4 border border-green-400/30 mb-4 hidden">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <p class="text-green-400 text-sm font-semibold">対応ドメイン</p>
            <p class="text-green-200 text-xs" id="domain-match-text"></p>
          </div>
        </div>
      </div>
      
      <div id="domain-mismatch-panel" class="glass-panel bg-gradient-to-r from-yellow-500/10 to-orange-500/10 rounded-lg p-4 border border-yellow-400/30 mb-4 hidden">
        <div class="flex items-start">
          <svg class="w-5 h-5 text-yellow-400 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          <div>
            <p class="text-yellow-400 text-sm font-semibold">ドメイン不一致の警告</p>
            <p class="text-yellow-200 text-xs mb-2" id="domain-mismatch-text"></p>
            <p class="text-yellow-100 text-xs">このウェブアプリは <span id="deploy-domain" class="font-semibold"></span> ドメイン用にデプロイされています。</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Hero Section with CTA -->
    <div class="mb-8 text-center fade-in">
      <div class="glass-panel bg-gradient-to-r from-cyan-500/20 to-blue-500/20 rounded-xl p-6 border border-cyan-400/30 mb-6 feature-card">
        <h2 class="text-2xl font-bold text-white mb-2">無料でみんなの回答ボードを始めよう！</h2>
        <p class="text-cyan-200 mb-4">数ステップであなた専用のボードを作成。セキュリティを重視した設計で、安心して授業で活用できます。</p>
        <button type="button" 
                class="cta-button px-8 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold rounded-lg transition-all transform hover:scale-105 shadow-lg text-lg focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-2 focus:ring-offset-gray-800"
                aria-label="新規登録に進む">
          いますぐ始める →
        </button>
      </div>
    </div>

    <!-- Progress Steps -->
    <div class="mb-8 slide-in">
      <div class="flex items-center justify-between relative">
        <div class="absolute top-4 left-0 right-0 h-0.5 bg-gray-600 rounded-full"></div>
        <div class="absolute top-4 left-0 h-0.5 bg-gradient-to-r from-cyan-400 to-blue-400 transition-all duration-500 rounded-full" id="progress-bar"></div>
        
        <div class="step-indicator completed" id="step-1" role="progressbar" aria-valuenow="1" aria-valuemin="1" aria-valuemax="3" aria-label="ステップ1: 理解">
          <div class="step-number w-8 h-8 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm relative z-10 transition-all">1</div>
          <span class="text-xs mt-2 block text-cyan-400">理解</span>
        </div>
        <div class="step-indicator" id="step-2" role="progressbar" aria-valuenow="2" aria-valuemin="1" aria-valuemax="3" aria-label="ステップ2: 確認">
          <div class="step-number w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm relative z-10 transition-all">2</div>
          <span class="text-xs mt-2 block text-gray-400">確認</span>
        </div>
        <div class="step-indicator" id="step-3" role="progressbar" aria-valuenow="3" aria-valuemin="1" aria-valuemax="3" aria-label="ステップ3: 開始">
          <div class="step-number w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm relative z-10 transition-all">3</div>
          <span class="text-xs mt-2 block text-gray-400">開始</span>
        </div>
      </div>
    </div>

    <div class="space-y-6">
      <!-- ステップ1: 説明 -->
      <article class="glass-panel rounded-lg p-6 feature-card fade-in" id="section-1">
        <h2 class="text-xl font-semibold mb-4 text-cyan-400 flex items-center gap-2">
          <div class="w-6 h-6 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm">1</div>
          みんなの回答ボードとは
        </h2>
        <ul class="text-sm text-gray-300 space-y-3 mb-6" role="list">
          <li class="flex items-start gap-3 slide-in">
            <span class="text-green-400 text-lg" role="img" aria-label="チェックマーク">✓</span>
            <span>Googleスプレッドシートの回答を、美しいボード形式で表示します</span>
          </li>
          <li class="flex items-start gap-3 slide-in">
            <span class="text-green-400 text-lg" role="img" aria-label="チェックマーク">✓</span>
            <span>生徒同士で「いいね！」「なるほど！」「もっと知りたい！」のリアクションができます</span>
          </li>
          <li class="flex items-start gap-3 slide-in">
            <span class="text-green-400 text-lg" role="img" aria-label="チェックマーク">✓</span>
            <span>先生は重要な回答をハイライトできます</span>
          </li>
        </ul>

        <!-- Digital Citizenship Education Section -->
        <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mb-4">
          <div class="flex items-start gap-3">
            <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.168 18.477 18.582 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
              </svg>
            </div>
            <div>
              <p class="text-sm font-semibold text-blue-200 mb-2">デジタル・シティズンシップ教育をサポート</p>
              <p class="text-xs text-blue-300 leading-relaxed">
                みんなの回答ボードは、デジタル社会で良い市民となるための学習を支援します。オンライン空間でも互いを尊重し、建設的な対話を育む環境を提供します。
              </p>
            </div>
          </div>
        </div>

        <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <div class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
              </svg>
            </div>
            <div>
              <p class="text-sm font-semibold text-green-200 mb-2">心理的安全性を重視した設計</p>
              <ul class="text-xs text-green-300 leading-relaxed space-y-1">
                <li>• <strong>匿名性のサポート</strong>：生徒が安心して意見を表現できます</li>
                <li>• <strong>数値の非表示</strong>：競争より協力を重視した環境を作ります</li>
                <li>• <strong>色による識別</strong>：数を気にせずリアクションの種類を把握できます</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- StudyQuestのセキュリティ -->
        <div class="mt-6 p-4 bg-purple-900/20 border border-purple-500/30 rounded-lg glass-panel">
          <h3 class="font-semibold text-purple-400 mb-2 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            みんなの回答ボードのセキュリティ
          </h3>
          <ul class="text-sm text-purple-200 space-y-2" role="list">
            <li>• <strong>データ分離</strong>: 生徒の回答データは、メインアプリとは別の安全なデータベースで管理されます。</li>
            <li>• <strong>厳格なアクセス制御</strong>: あなたのGoogle Workspaceドメイン内からのアクセスに限定し、不正なアクセスを防ぎます。</li>
            <li>• <strong>XSS対策</strong>: 悪意のあるスクリプトの埋め込みを防ぐため、全てのユーザー入力を厳重にチェックしています。</li>
            <li>• <strong>レート制限</strong>: 短時間での連続操作を制限し、システムへの負荷や悪用を防ぎます。</li>
            <li>• <strong>自動非公開機能</strong>: 公開されたボードは一定時間で自動的に非公開になり、意図しない情報公開を防ぎます。</li>
            <li>• <strong>Googleのセキュリティ機能活用</strong>: Google Apps Scriptの組み込みセキュリティ機能（例: クリックジャッキング対策）を最大限に活用しています。</li>
          </ul>
        </div>
      </article>
      
      <!-- ステップ2: セットアップ方法 -->
      <article class="glass-panel rounded-lg p-6 feature-card fade-in" id="section-2">
        <h2 class="text-xl font-semibold mb-4 text-cyan-400 flex items-center gap-2">
          <div class="w-6 h-6 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm" id="step-2-icon">2</div>
          セットアップ方法
        </h2>
        <div class="border border-cyan-500 rounded-lg p-4 bg-cyan-900/20 glass-panel">
          <div class="flex items-start gap-3">
            <svg class="w-6 h-6 text-cyan-400 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            <div>
              <div class="font-semibold text-white mb-2">安全で簡単なセットアップ</div>
              <div class="text-sm text-gray-300 leading-relaxed">
                あなた専用のGoogleフォームとスプレッドシートを自動で作成します。これらの設定には、Googleのセキュリティ機能との連携が含まれるため、<strong>完了まで1分ほどかかる場合があります</strong>。完了後、あなた専用の固定URLの回答ボードが作成され、複数のスプレッドシートを切り替えて使用できます。
              </div>
            </div>
          </div>
        </div>
        
        <!-- 重要な注意事項 -->
        <div class="mt-4 p-4 bg-yellow-900/30 border border-yellow-600/50 rounded-lg glass-panel">
          <h3 class="font-semibold text-yellow-400 mb-2 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            重要なお知らせ
          </h3>
          <ul class="text-sm text-yellow-200 space-y-2" role="list">
            <li class="slide-in">• 一度登録すると、<strong>固定URLの回答ボード</strong>があなた専用で作成されます</li>
            <li class="slide-in">• 登録後は<strong>管理画面でスプレッドシートのURLを追加</strong>して使用できます</li>
            <li class="slide-in">• 生徒には<strong>同じURLを共有</strong>し続けることができ、授業ごとにURLを変える必要がありません</li>
          </ul>
        </div>
      </article>
      
      <!-- ステップ3: アカウント確認 -->
      <article class="glass-panel rounded-lg p-6 feature-card fade-in" id="section-3">
        <h2 class="text-xl font-semibold mb-4 text-cyan-400 flex items-center gap-2">
          <div class="w-6 h-6 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm" id="step-3-icon">3</div>
          アカウント確認
        </h2>
        <div class="bg-gray-800 rounded-lg p-4 glass-panel">
          <p class="text-sm text-gray-400 mb-1">登録するアカウント:</p>
          <p id="user-email" class="text-white font-semibold flex items-center gap-2">
            <svg class="w-4 h-4 spinner" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
            </svg>
            確認中...
          </p>
        </div>
      </article>
      
      <!-- 登録ボタン -->
      <button
        type="button"
        id="register-btn"
        class="cta-button w-full py-3 px-6 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none shadow-lg focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-2 focus:ring-offset-gray-800 fade-in"
        disabled
        aria-label="みんなの回答ボードの登録を開始する"
      >
        みんなの回答ボードを開始する
      </button>
      
      <!-- メッセージエリア -->
      <div id="message-area" class="text-center min-h-[24px]" role="alert" aria-live="polite"></div>

      <!-- Existing board info -->
      <div id="existing-board-area" class="hidden"></div>

      <!-- 結果表示エリア -->
      <div id="result-area" class="hidden"></div>
    </div>
    
    <!-- フッター -->
    <footer class="text-center mt-8 text-xs text-gray-500 fade-in">
      <p>&copy; 2025 StudyQuest. All rights reserved.</p>
    </footer>
  </div>
  
  <script>
    let userEmail = '';
    let currentStep = 1;
    let domainInfo = null;

    function escapeHtml(str) {
      if (!str) return '';
      return str.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ドメイン情報を取得して表示
    function loadDomainInfo() {
      google.script.run
        .withSuccessHandler(displayDomainInfo)
        .withFailureHandler(error => {
          console.error('ドメイン情報の取得に失敗:', error);
        })
        .getDeployUserDomainInfo();
    }

    // ドメイン情報の表示
    function displayDomainInfo(info) {
      domainInfo = info;
      const section = document.getElementById('domain-info-section');
      const matchPanel = document.getElementById('domain-match-panel');
      const mismatchPanel = document.getElementById('domain-mismatch-panel');
      
      if (!info || info.error) {
        console.warn('ドメイン情報の取得エラー:', info?.error);
        return;
      }

      section.classList.remove('hidden');

      if (info.isDomainMatch) {
        // ドメインが一致している場合
        matchPanel.classList.remove('hidden');
        mismatchPanel.classList.add('hidden');
        document.getElementById('domain-match-text').textContent = 
          `このウェブアプリは ${info.deployDomain} ドメイン用です。あなたのアカウント（${info.currentDomain}）で利用できます。`;
      } else {
        // ドメインが不一致の場合
        matchPanel.classList.add('hidden');
        mismatchPanel.classList.remove('hidden');
        document.getElementById('domain-mismatch-text').textContent = 
          `あなたのアカウントのドメイン（${info.currentDomain}）とは異なります。機能が制限される可能性があります。`;
        document.getElementById('deploy-domain').textContent = info.deployDomain;
      }
    }
    
    // Scroll to registration function
    function scrollToRegistration() {
      document.getElementById('section-3').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
      updateStep(3);
    }
    
    // Update step progress
    function updateStep(step) {
      currentStep = step;
      
      // Update progress bar with performance optimization
      const progressBar = document.getElementById('progress-bar');
      requestAnimationFrame(() => {
        progressBar.style.width = `${(step / 3) * 100}%`;
      });
      
      // Update step indicators
      for (let i = 1; i <= 3; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        const stepIndicator = document.getElementById(`step-${i}`);
        
        if (stepElement) {
          if (i <= step) {
            stepElement.classList.add('completed');
            const stepCircle = stepElement.querySelector('div');
            if (stepCircle) {
              stepCircle.className = 'w-8 h-8 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm relative z-10';
            }
            const stepLabel = stepElement.querySelector('span');
            if (stepLabel) {
              stepLabel.className = 'text-xs mt-2 block text-cyan-400';
            }
          } else {
            stepElement.classList.remove('completed');
            const stepCircle = stepElement.querySelector('div');
            if (stepCircle) {
              stepCircle.className = 'w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm relative z-10';
            }
            const stepLabel = stepElement.querySelector('span');
            if (stepLabel) {
              stepLabel.className = 'text-xs mt-2 block text-gray-400';
            }
          }
        }
        
        // Update section-specific icons (for steps 2 and 3)
        const iconElement = document.getElementById(`step-${i}-icon`);
        if (iconElement) {
          if (i <= step) {
            iconElement.className = 'w-6 h-6 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm';
          } else {
            iconElement.className = 'w-6 h-6 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm';
          }
        }
      }
    }
    
    // セキュリティ強化: 認証状態の検証
    async function verifyAuthentication() {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(result => {
            if (result && result.authenticated && result.email) {
              resolve(result);
            } else {
              reject(new Error('認証が必要です'));
            }
          })
          .withFailureHandler(reject)
          .verifyUserAuthentication();
      });
    }

    // ユーザーメールアドレスを取得
    window.addEventListener('DOMContentLoaded', async () => {
      // scrollToRegistrationのイベントリスナーを設定
      const scrollToRegistrationBtn = document.querySelector('button[aria-label="新規登録に進む"]');
      if (scrollToRegistrationBtn) {
        scrollToRegistrationBtn.addEventListener('click', scrollToRegistration);
      }

      try {
        // セキュリティ強化: 認証状態を確認
        const authResult = await verifyAuthentication();
        const email = authResult.email;
        
        userEmail = email;
        document.getElementById('user-email').textContent = email || 'メールアドレスを取得できません';

        if (email) {
          updateStep(2); // Account verification step
          
          // まず既存ボード情報をチェック
          google.script.run
            .withSuccessHandler((existingBoard) => {
              // userIdが無効な場合は既存ボードがないとして扱う
              if (existingBoard && existingBoard.userId && existingBoard.userId !== 'undefined' && existingBoard.userId !== '' && existingBoard.userId !== null) {
                // 有効な既存ボードがある場合
                updateStep(3);
                showExistingBoard(existingBoard);
              } else {
                // 既存ボードがない、または無効なuserIdの場合はボタンを有効化
                updateStep(3);
                document.getElementById('register-btn').disabled = false;
                showMessage('アカウント確認が完了しました。みんなの回答ボードを開始できます。', 'success');
              }
            })
            .withFailureHandler((error) => {
              // セキュリティ強化: エラーメッセージをサニタイズ
              console.warn('既存ボード確認で問題が発生しました');
              
              // エラーが発生した場合もボタンを有効化（新規登録として扱う）
              document.getElementById('register-btn').disabled = false;
              showMessage('アカウント確認が完了しました。StudyQuestを開始できます。', 'success');
            })
            .getExistingBoard();
        } else {
          showMessage('Googleアカウントでログインしてください。', 'error');
        }
      } catch (error) {
        // セキュリティ強化: 認証エラーの安全な処理
        console.warn('認証確認中にエラーが発生しました');
        document.getElementById('user-email').textContent = '認証エラー';
        showMessage('認証が必要です。Googleアカウントでログインしてください。', 'error');
      }
    });
    
    // セットアップ方法の切り替え（統合版では自動セットアップのみ）
    // document.querySelectorAll('input[name="setup-method"]').forEach(radio => {
    //   radio.addEventListener('change', (e) => {
    //     const existingInput = document.getElementById('existing-sheet-input');
    //     if (e.target.value === 'existing') {
    //       existingInput.style.display = 'block';
    //     } else {
    //       existingInput.style.display = 'none';
    //     }
    //   });
    // });

    // Enterキー対応（登録ボタン用）
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !document.getElementById('register-btn').disabled) {
        // Registration page doesn't have URL input field, so just trigger registration if focused
        const registerBtn = document.getElementById('register-btn');
        if (registerBtn && !registerBtn.disabled) {
          registerBtn.click();
        }
      }
    });
    
    // セキュリティ強化: 入力バリデーション関数
    function validateInput(value, type) {
      if (!value || typeof value !== 'string') return false;
      
      switch (type) {
        case 'email':
          return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
        case 'method':
          return ['auto', 'manual'].includes(value);
        default:
          return value.length > 0 && value.length < 1000;
      }
    }

    // 登録処理
    document.getElementById('register-btn').addEventListener('click', async () => {
      const btn = document.getElementById('register-btn');
      const messageArea = document.getElementById('message-area');
      
      // セキュリティ強化: 入力検証
      if (!userEmail || !validateInput(userEmail, 'email')) {
        showMessage('有効なメールアドレスが必要です。', 'error');
        return;
      }
      
      // 統合版では常に自動セットアップ
      const setupMethod = 'auto';
      const spreadsheetUrl = 'AUTO_CREATE';
      
      // ボタンを無効化
      btn.disabled = true;
      btn.innerHTML = `
        <svg class="w-5 h-5 spinner inline-block mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
        </svg>
        登録処理中...
      `;
      showMessage('回答ボードを準備中です...', 'info');
      
      // 登録処理を実行
      google.script.run

        .withSuccessHandler(result => {
          showMessage(result.message || '登録が完了しました！', 'success');

          const adminUrl = result.adminUrl || '';
          const viewUrl = result.viewUrl || '';
          
          if (!adminUrl || !viewUrl) {
            showMessage('エラー: 無効なURLが生成されました。ページを更新してから再度お試しください。', 'error');
            console.error('URL generation failed:', { adminUrl, viewUrl, result });
            
            // ページを自動的にリロードして再試行
            setTimeout(() => {
              showMessage('ページを自動的に更新しています...', 'info');
              window.location.reload();
            }, 3000);
            return;
          }
          
          // 結果表示エリアにURLを表示
          const resultArea = document.getElementById('result-area');
          const adminUrlInput = document.createElement('input');
          adminUrlInput.type = 'text';
          adminUrlInput.value = adminUrl;
          adminUrlInput.readOnly = true;
          adminUrlInput.id = 'admin-url';
          adminUrlInput.className = 'flex-1 p-2 bg-gray-800 border border-gray-600 rounded text-sm cursor-pointer hover:bg-gray-700';
          adminUrlInput.onclick = function() { this.select(); };
          
          const viewUrlInput = document.createElement('input');
          viewUrlInput.type = 'text';
          viewUrlInput.value = viewUrl;
          viewUrlInput.readOnly = true;
          viewUrlInput.id = 'view-url';
          viewUrlInput.className = 'flex-1 p-2 bg-gray-800 border border-gray-600 rounded text-sm cursor-pointer hover:bg-gray-700';
          viewUrlInput.onclick = function() { this.select(); };
          
          const adminLink = document.createElement('a');
          adminLink.href = adminUrl;
          adminLink.target = '_blank';
          adminLink.className = 'block w-full text-center px-4 py-3 bg-cyan-600 hover:bg-cyan-700 rounded-lg font-semibold transition-colors';
          adminLink.textContent = '管理画面を開く →';
          
          resultArea.innerHTML = `
            <div class="glass-panel rounded-lg p-6 space-y-6">
              <div class="text-center">
                <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <h3 class="font-bold text-2xl text-green-400 mb-2">🎉 登録完了！</h3>
                <p class="text-gray-300">あなた専用の回答ボードが作成されました</p>
              </div>
              
              <div class="bg-gradient-to-r from-green-500/20 to-blue-500/20 rounded-lg p-4 border border-green-400/30">
                <h4 class="font-bold text-white mb-2">✨ 次のステップ</h4>
                <p class="text-sm text-green-200 mb-3" id="setup-guidance">
                  まずは、ボードのタイトルや質問を設定しましょう。準備ができたら、生徒にURLを共有して回答を募集できます。
                </p>
                <div class="text-center">
                  <div class="inline-block px-4 py-2 bg-white/10 rounded-lg">
                    <span class="text-xs text-gray-300">⏱️ セットアップには数秒から数十秒かかる場合があります。</span>
                  </div>
                </div>
              </div>
              
              <div class="space-y-3">
                <div>
                  <label class="text-sm text-gray-400 block mb-1">管理画面URL（先生用）:</label>
                  <div class="flex gap-2" id="admin-url-container">
                    <button onclick="copyToClipboard('admin-url')"
                      class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
                      コピー
                    </button>
                  </div>
                </div>
                
                <div>
                  <label class="text-sm text-gray-400 block mb-1">生徒用URL:</label>
                  <div class="flex gap-2" id="view-url-container">
                    <button onclick="copyToClipboard('view-url')"
                      class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
                      コピー
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="pt-4 space-y-3" id="admin-link-container">
                <div class="text-center">
                  <p class="text-sm text-gray-400 mb-3">管理画面を開いて、最初のスプレッドシートを追加しましょう！</p>
                </div>
                <button onclick="location.reload()"
                  class="block w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                  別のアカウントで登録
                </button>
              </div>
            </div>
          `;
          
          // 安全にDOM要素を追加
          const adminContainer = document.getElementById('admin-url-container');
          adminContainer.insertBefore(adminUrlInput, adminContainer.firstChild);
          
          const viewContainer = document.getElementById('view-url-container');
          viewContainer.insertBefore(viewUrlInput, viewContainer.firstChild);
          
          const linkContainer = document.getElementById('admin-link-container');
          linkContainer.insertBefore(adminLink, linkContainer.firstChild);
          
          // 自動作成の場合はフォーム・スプレッドシートURLも表示
          if (result.autoCreated) {
            const additionalContainer = document.createElement('div');
            additionalContainer.className = 'space-y-3';
            
            // Googleフォーム（生徒回答用）
            if (result.formUrl) {
              const formContainer = document.createElement('div');
              formContainer.innerHTML = `
                <label class="text-sm text-gray-400 block mb-1">生徒回答用Googleフォーム:</label>
                <div class="flex gap-2">
                  <input type="text" value="${escapeHtml(result.formUrl)}" readonly
                    id="created-form-url"
                    class="flex-1 p-2 bg-gray-800 border border-gray-600 rounded text-sm cursor-pointer hover:bg-gray-700"
                    onclick="this.select()">
                  <button onclick="copyToClipboard('created-form-url')"
                    class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
                    コピー
                  </button>
                  <a href="${escapeHtml(result.formUrl)}" target="_blank" rel="noopener noreferrer"
                    class="px-3 py-2 bg-blue-700 hover:bg-blue-600 rounded text-sm transition-colors">
                    開く
                  </a>
                </div>
              `;
              additionalContainer.appendChild(formContainer);
            }
            
            // フォーム編集用URL
            if (result.editFormUrl) {
              const editFormContainer = document.createElement('div');
              editFormContainer.innerHTML = `
                <label class="text-sm text-gray-400 block mb-1">フォーム編集用URL（先生用）:</label>
                <div class="flex gap-2">
                  <input type="text" value="${escapeHtml(result.editFormUrl)}" readonly
                    id="edit-form-url"
                    class="flex-1 p-2 bg-gray-800 border border-gray-600 rounded text-sm cursor-pointer hover:bg-gray-700"
                    onclick="this.select()">
                  <button onclick="copyToClipboard('edit-form-url')"
                    class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
                    コピー
                  </button>
                  <a href="${escapeHtml(result.editFormUrl)}" target="_blank" rel="noopener noreferrer"
                    class="px-3 py-2 bg-green-700 hover:bg-green-600 rounded text-sm transition-colors">
                    編集
                  </a>
                </div>
              `;
              additionalContainer.appendChild(editFormContainer);
            }
            
            // スプレッドシート（データ確認用）
            if (result.spreadsheetUrl) {
              const spreadsheetContainer = document.createElement('div');
              spreadsheetContainer.innerHTML = `
                <label class="text-sm text-gray-400 block mb-1">回答データ（スプレッドシート）:</label>
                <div class="flex gap-2">
                  <input type="text" value="${escapeHtml(result.spreadsheetUrl)}" readonly
                    id="created-spreadsheet-url"
                    class="flex-1 p-2 bg-gray-800 border border-gray-600 rounded text-sm cursor-pointer hover:bg-gray-700"
                    onclick="this.select()">
                  <button onclick="copyToClipboard('created-spreadsheet-url')"
                    class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
                    コピー
                  </button>
                  <a href="${escapeHtml(result.spreadsheetUrl)}" target="_blank" rel="noopener noreferrer"
                    class="px-3 py-2 bg-green-700 hover:bg-green-600 rounded text-sm transition-colors">
                    確認
                  </a>
                </div>
              `;
              additionalContainer.appendChild(spreadsheetContainer);
            }
            
            // 管理画面URLの前に挿入
            const adminContainer = document.getElementById('admin-url-container').parentElement;
            adminContainer.parentElement.insertBefore(additionalContainer, adminContainer);
            
            // ガイダンスメッセージを更新
            if (result.formUrl) {
              document.getElementById('setup-guidance').textContent = 
                'Googleフォームが自動作成されました！生徒にフォームURLを共有して回答を収集し、回答ボードで結果を確認できます。';
            } else {
              document.getElementById('setup-guidance').textContent = 
                'スプレッドシートが自動作成されました。データを手動で入力するか、別途Googleフォームを作成してご利用ください。';
            }
          }
          
          resultArea.classList.remove('hidden');
          btn.style.display = 'none';
          
          // 既存スプレッドシート入力を無効化
          const existingInput = document.getElementById('spreadsheet-url');
          if (existingInput) {
            existingInput.disabled = true;
          }

          showMessage('登録が完了しました。管理画面を開いて設定を確認してください。', 'info');
        })
        .withFailureHandler(error => {
          showMessage(`エラー: ${error.message || '登録に失敗しました'}`, 'error');
          btn.disabled = false;
          btn.textContent = 'みんなの回答ボードを開始する';
        })
        .registerNewUser(userEmail);
    });
    
    // 既存ボード情報の表示
    function showExistingBoard(data) {
      if (!data) return;
      
      // 登録ボタンを非表示にする
      const registerBtn = document.getElementById('register-btn');
      registerBtn.style.display = 'none';
      
      const area = document.getElementById('existing-board-area');
      const adminInput = document.createElement('input');
      adminInput.type = 'text';
      adminInput.value = data.adminUrl;
      adminInput.readOnly = true;
      adminInput.id = 'existing-admin-url';
      adminInput.className = 'flex-1 p-2 bg-gray-800 border border-gray-600 rounded text-sm cursor-pointer hover:bg-gray-700';
      adminInput.onclick = function() { this.select(); };

      const viewInput = document.createElement('input');
      viewInput.type = 'text';
      viewInput.value = data.viewUrl;
      viewInput.readOnly = true;
      viewInput.id = 'existing-view-url';
      viewInput.className = 'flex-1 p-2 bg-gray-800 border border-gray-600 rounded text-sm cursor-pointer hover:bg-gray-700';
      viewInput.onclick = function() { this.select(); };

      const adminLink = document.createElement('a');
      adminLink.href = data.adminUrl;
      adminLink.target = '_blank';
      adminLink.className = 'block w-full text-center px-4 py-3 bg-cyan-600 hover:bg-cyan-700 rounded-lg font-semibold transition-colors';
      adminLink.textContent = '管理画面を開く →';

      area.innerHTML = `
        <div class="glass-panel rounded-lg p-6 space-y-6">
          <div class="text-center">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="font-bold text-2xl text-green-400 mb-2">✅ 既に登録済みです</h3>
            <p class="text-gray-300">あなたのアカウントには既にみんなの回答ボードが設定されています</p>
          </div>
          
          <div class="bg-gradient-to-r from-blue-500/20 to-cyan-500/20 rounded-lg p-4 border border-blue-400/30">
            <h4 class="font-bold text-white mb-2">📋 ご利用中のボード</h4>
            <p class="text-sm text-blue-200">以下のURLからいつでも管理画面にアクセスできます</p>
          </div>
          <div class="space-y-3">
            <div>
              <label class="text-sm text-gray-400 block mb-1">管理画面URL（先生用）:</label>
              <div class="flex gap-2" id="existing-admin-container">
                <button onclick="copyToClipboard('existing-admin-url')" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">コピー</button>
              </div>
            </div>
            <div>
              <label class="text-sm text-gray-400 block mb-1">生徒用URL:</label>
              <div class="flex gap-2" id="existing-view-container">
                <button onclick="copyToClipboard('existing-view-url')" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">コピー</button>
              </div>
            </div>
          </div>
          <div id="existing-admin-link-container"></div>
        </div>`;

      const adminContainer = document.getElementById('existing-admin-container');
      adminContainer.insertBefore(adminInput, adminContainer.firstChild);
      const viewContainer = document.getElementById('existing-view-container');
      viewContainer.insertBefore(viewInput, viewContainer.firstChild);
      const linkContainer = document.getElementById('existing-admin-link-container');
      linkContainer.appendChild(adminLink);

      area.classList.remove('hidden');
      
      // 成功メッセージを表示
      showMessage('既存の回答ボードが見つかりました。管理画面からスプレッドシートを追加できます。', 'success');
    }

    // メッセージ表示関数
    function showMessage(message, type) {
      const messageArea = document.getElementById('message-area');
      const icons = {
        error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
      };
      const colors = {
        error: 'text-red-400',
        success: 'text-green-400',
        info: 'text-blue-400'
      };
      
      messageArea.className = `text-center min-h-[24px] ${colors[type] || 'text-gray-400'} flex items-center justify-center gap-2`;
      messageArea.innerHTML = `${icons[type] || ''}<span>${escapeHtml(message)}</span>`;
    }
    
    // クリップボードにコピー（現代的なAPIを使用）
    async function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      const button = element.parentElement.querySelector('button');
      const originalText = button ? button.textContent : '';
      
      try {
        // 現代的なClipboard APIを使用
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(element.value);
        } else {
          // フォールバック: 従来の方法
          element.select();
          element.setSelectionRange(0, 99999); // モバイル対応
          document.execCommand('copy');
        }
        
        // コピー完了の視覚的フィードバック
        if (button) {
          button.textContent = '✓ コピー済み';
          button.classList.add('bg-green-700');
          
          setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-green-700');
          }, 2000);
        }
      } catch (error) {
        console.error('コピーに失敗しました:', error);
        if (button) {
          button.textContent = '✗ コピー失敗';
          button.classList.add('bg-red-700');
          
          setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-red-700');
          }, 2000);
        }
      }
    }

    // ページ読み込み時にドメイン情報を取得
    document.addEventListener('DOMContentLoaded', function() {
      loadDomainInfo();
    });
  </script>
</body>
</html>
