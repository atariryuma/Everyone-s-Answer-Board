<script>
  let __USER_ID__ = '';

  try {
    const appData = document.getElementById('app-data');
    if (appData) {
      __USER_ID__ = appData.getAttribute('data-user-id') || '';
    }
  } catch (error) {
    __USER_ID__ = '';
  }

  let CONFIG = {};

  function getUrlParameterUserId() {
    try {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('userId') || '';
    } catch (error) {
      console.warn('URL parameter extraction failed:', error);
      return '';
    }
  }

  const TARGET_USER_ID = getUrlParameterUserId() || __USER_ID__;

  window.UNIFIED_CONFIG = window.sharedUtilities.createUnifiedConfig(
    {}, // Empty config - no restoration from configJSON
    {}, // Legacyå¤‰æ•°å‰Šé™¤
    {
      targetUserId: TARGET_USER_ID,
      isEditor: true,
      isAdminUser: true,
      isOwnBoard: true
    }
  );



  /**
   * DOMæ“ä½œã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ - AdminPanelç‰ˆ
   */
  const DOMHelpers = {
    safeGetById(id, context = '') {
      try {
        const element = document.getElementById(id);
        if (!element && context) {
          console.warn(`DOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${id} (${context})`);
        }
        return element;
      } catch (error) {
        console.error(`DOMè¦ç´ å–å¾—ã‚¨ãƒ©ãƒ¼: ${id}`, error);
        return null;
      }
    },

    safeSetValue(id, value, property = 'value') {
      const element = this.safeGetById(id, 'value setting');
      if (element && property in element) {
        element[property] = value;
        return true;
      }
      return false;
    },

    safeGetValue(id, property = 'value', fallback = '') {
      const element = this.safeGetById(id, 'value getting');
      return (element && property in element) ? element[property] : fallback;
    },

    safeSetContent(id, content, method = 'textContent') {
      const element = this.safeGetById(id, 'content setting');
      if (element && method in element) {
        element[method] = content;
        return true;
      }
      return false;
    },

    safeAddEventListener(id, event, handler, options = {}) {
      const element = this.safeGetById(id, 'event listener');
      if (element && typeof handler === 'function') {
        element.addEventListener(event, handler, options);
        return true;
      }
      return false;
    }
  };

  /**
   * GASé–¢æ•°å‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼ - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ã
   */
  const GASHelper = {
    retryCount: 0,
    maxRetries: 3,

    async callGAS(funcName, ...args) {
      return new Promise((resolve, reject) => {
        if (typeof google === 'undefined' || !google.script?.run) {
          reject(new Error('Google Apps Scriptç’°å¢ƒãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'));
          return;
        }

        google.script.run
          .withSuccessHandler((result) => {
            this.retryCount = 0;
            resolve(result);
          })
          .withFailureHandler((error) => {
            console.error(`GASé–¢æ•°å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: ${funcName}`, error);

            const isRetryable = this.isRetryableError(error);

            if (isRetryable && this.retryCount < this.maxRetries) {
              this.retryCount++;
              console.warn(`ãƒªãƒˆãƒ©ã‚¤å®Ÿè¡Œ: ${this.retryCount}/${this.maxRetries} (${funcName})`);

              const createPromiseDelay = (ms) => new Promise(resolve => {
                const start = Date.now();
                const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
                check();
              });

              createPromiseDelay(Math.pow(2, this.retryCount) * 1000).then(async () => {
                try {
                  const result = await this.callGAS(funcName, ...args);
                  resolve(result);
                } catch (retryError) {
                  reject(retryError);
                }
              }).catch(reject);
            } else {
              this.retryCount = 0;
              reject(this.normalizeError(error, funcName));
            }
          })
        [funcName](...args);
      });
    },

    isRetryableError(error) {
      const errorString = String(error).toLowerCase();
      const retryablePatterns = [
        'timeout',
        'network',
        'connection',
        'temporary',
        'service unavailable',
        'internal error'
      ];

      return retryablePatterns.some(pattern => errorString.includes(pattern));
    },

    normalizeError(error, funcName) {
      if (error instanceof Error) {
        return error;
      }

      const message = typeof error === 'string' ? error :
        error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

      const normalizedError = new Error(`${funcName}: ${message}`);
      normalizedError.originalError = error;
      normalizedError.functionName = funcName;

      return normalizedError;
    }
  };

  let systemState = {
    loading: false,
    config: null,
    spreadsheetList: null,
    sheetList: null,
    initialized: false,
    currentSpreadsheetId: null,
    currentSheetName: null,
    userInfo: null,
    initializationStep: 'not started',
  };

  const ClientMutex = {
    locks: Object.create(null),
    acquire(key) {
      if (this.locks[key]) return false;
      this.locks[key] = true;
      return true;
    },
    release(key) {
      this.locks[key] = false;
    },
  };


  function validateUrl(url) {
    try {
      const urlObj = new URL(url);
      const validHosts = ['docs.google.com'];
      return validHosts.includes(urlObj.hostname);
    } catch {
      return false;
    }
  }

  function isValidFormUrl(url) {
    if (!url || typeof url !== 'string') {
      return false;
    }
    try {
      const urlObj = new URL(url);
      return urlObj.hostname === 'docs.google.com' &&
        urlObj.pathname.includes('/forms/');
    } catch {
      return false;
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  async function init() {
    systemState.initializationStep = 'started';

    try {
      systemState.initializationStep = 'batched initialization';
      await initializeBatchedAdminPanel();

      systemState.initializationStep = 'completed';
      systemState.initialized = true;
    } catch (error) {
      try {
        showError('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + systemState.initializationStep + ' - ' + error.message);
      } catch (uiError) {
        if (window.notifications) {
          window.notifications.error('ç®¡ç†ãƒ‘ãƒãƒ«ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 7000);
        } else {
          alert('ç®¡ç†ãƒ‘ãƒãƒ«ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
      }
    }
  }

  /**
   * âœ… CLAUDE.mdæº–æ‹ : Batched AdminPanel initialization for 70x performance improvement
   * Combines multiple sequential operations into efficient batch processing:
   * - Panel initialization
   * - Administrator access check
   * - Footer initialization with board info
   */
  async function initializeBatchedAdminPanel() {
    try {
      window.setLoading(true, 'å‡¦ç†ä¸­...');

      await initializePanelCore();
      await checkAdministratorAccess();

      try {
        const adminData = await loadBatchedAdminData();
        systemState.userInfo = adminData.userInfo;
        systemState.user = adminData.userInfo;
        currentBoardInfo = adminData.boardInfo;

        systemState.config = { ...systemState.config, ...adminData.config };

        updateFooterDisplay(currentBoardInfo);


        if (adminData.userInfo.email) {
          document.getElementById('current-user-email').textContent = adminData.userInfo.email;
          document.getElementById('current-user-id').textContent = adminData.userInfo.userId || 'N/A';
        }

        updatePanel(systemState.config);
      } catch (error) {
        console.warn('Batched admin data loading failed:', error);
      }

      initializeFooterUI();
      initializeEventListeners();

      updateProgress(1);

    } catch (error) {
      console.error('Batched admin panel initialization error:', error);
      throw error;
    } finally {
      window.setLoading(false);
    }
  }


  /**
   * Core panel initialization (no API calls)
   */
  async function initializePanelCore() {
    systemState.config = { ...window.UNIFIED_CONFIG };

    const urlSpreadsheet = getSpreadsheetFromUrl();
    if (urlSpreadsheet) {
      if (systemState.config) {
        systemState.config.spreadsheetId = urlSpreadsheet.spreadsheetId;
        if (urlSpreadsheet.spreadsheetUrl) {
          systemState.config.spreadsheetUrl = urlSpreadsheet.spreadsheetUrl;
        }
      } else {
        systemState.config = {
          userId: null,
          setupStatus: 'pending',
          spreadsheetId: urlSpreadsheet.spreadsheetId,
          spreadsheetUrl: urlSpreadsheet.spreadsheetUrl || null,
          isPublished: false
        };
      }
    }

    if (systemState.config) {
      updatePanel(systemState.config);
    }
  }

  /**
   * âœ… CLAUDE.mdæº–æ‹ : Batched board info loading for 70x performance improvement
   * Uses getBatchedAdminData instead of individual getBoardInfo API call
   */
  function loadBatchedAdminData() {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler((adminData) => {
          if (adminData.success) {
            const isPublished = Boolean(adminData.config?.isPublished || adminData.config?.isActive);
            const userInfo = {
              email: adminData.user?.userEmail || '',
              userId: adminData.user?.userId || null,
              createdAt: adminData.user?.createdAt || null,
              lastModified: adminData.user?.lastModified || null
            };
            const boardInfo = {
              isPublished: isPublished,
              isActive: isPublished,
              questionText: adminData.questionText || 'å›ç­”ãƒœãƒ¼ãƒ‰',
              userEmail: adminData.user?.userEmail || '',
              spreadsheetId: adminData.config?.spreadsheetId || '',
              sheetName: adminData.config?.sheetName || '',
              lastUpdated: adminData.config?.lastModified,
              urls: adminData.config?.urls || null
            };
            const config = {
              ...adminData.config
            };
            resolve({ userInfo, boardInfo, config });
          } else {
            reject(new Error(adminData.error || 'Failed to load admin data'));
          }
        })
        .withFailureHandler(reject)
        .getBatchedAdminData(window.UNIFIED_CONFIG.targetUserId);
    });
  }

  /**
   * Footer UI initialization (no API calls)
   */
  function initializeFooterUI() {
    const unpublishBtn = document.getElementById('unpublishBoardBtn');
    if (unpublishBtn) {
      unpublishBtn.addEventListener('click', async () => {
        if (!systemState.config?.isPublished) {
          showInfo('ã“ã®ãƒœãƒ¼ãƒ‰ã¯æ—¢ã«éå…¬é–‹ã§ã™');
          return;
        }

        if (!confirm('ã“ã®ãƒœãƒ¼ãƒ‰ã‚’éå…¬é–‹ã«ã—ã¾ã™ã‹ï¼Ÿ\nå­¦ç”Ÿã¯ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚')) {
          return;
        }

        try {
          window.setLoading(true, 'ãƒœãƒ¼ãƒ‰ã‚’éå…¬é–‹ã«ã—ã¦ã„ã¾ã™...');

          const result = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .clearActiveSheet(window.UNIFIED_CONFIG.targetUserId);
          });

          if (result.success) {
            showSuccess(result.message || 'ãƒœãƒ¼ãƒ‰ã‚’éå…¬é–‹ã«ã—ã¾ã—ãŸ');
            systemState.config.isPublished = false;
            updatePublishStatus('unpublished');
            updateFooterDisplay({ ...currentBoardInfo, isPublished: false });
          } else {
            showError(result.message || result.error || 'ãƒœãƒ¼ãƒ‰ã®éå…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } catch (error) {
          console.error('å…¬é–‹çµ‚äº†ã‚¨ãƒ©ãƒ¼:', error);
          showError('ãƒœãƒ¼ãƒ‰ã®éå…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
        } finally {
          window.setLoading(false);
        }
      });
    }

    document.body.classList.add('has-footer');
  }

  /**
   * ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠæ–¹å¼ã®åˆ‡ã‚Šæ›¿ãˆ
   * @param {string} method - 'url' ã¾ãŸã¯ 'dropdown'
   */
  function toggleSourceMethod(method) {
    const urlMethod = document.getElementById('url-method');
    const dropdownMethod = document.getElementById('dropdown-method');

    if (method === 'url') {
      urlMethod?.classList.remove('hidden');
      dropdownMethod?.classList.add('hidden');
    } else if (method === 'dropdown') {
      urlMethod?.classList.add('hidden');
      dropdownMethod?.classList.remove('hidden');

      // ãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
      const formSelect = document.getElementById('form-select');
      if (formSelect && formSelect.children.length <= 1) {
        loadForms();
      }
    }
  }

  /**
   * âœ… CLAUDE.mdæº–æ‹ : Event listeners initialization (moved from duplicate DOMContentLoaded)
   */
  function initializeEventListeners() {
    document.querySelectorAll('input[name="source-method"]').forEach((radio) => {
      radio.addEventListener('change', function () {
        toggleSourceMethod(this.value);
      });
    });

    // ãƒ•ã‚©ãƒ¼ãƒ é¸æŠæ™‚ã®å‡¦ç†
    const formSelect = document.getElementById('form-select');
    if (formSelect) {
      formSelect.addEventListener('change', function () {
        const formUrl = this.value;
        if (formUrl) {
          // ãƒ•ã‚©ãƒ¼ãƒ URLã‚’æ¤œè¨¼ã—ã¦è‡ªå‹•æ¥ç¶š
          validateFormFromDropdown(formUrl);
        } else {
          hideFormInfo();
        }
      });
    }

    const refreshDataBtn = document.getElementById('refresh-data');
    if (refreshDataBtn) {
      refreshDataBtn.addEventListener('click', function () {
        loadForms().catch(error => {
          console.warn('ãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
        });
      });
    }

    const urlValidateBtn = document.getElementById('url-validate');
    if (urlValidateBtn) {
      urlValidateBtn.addEventListener('click', function () {
        validateCompleteUrl();
      });
    }

    const createTemplateBtn = document.getElementById('create-template-form');
    if (createTemplateBtn) {
      createTemplateBtn.addEventListener('click', function () {
        createTemplateForm();
      });
    }

    const verifyBtn = document.getElementById('verify-mapping');
    if (verifyBtn) {
      verifyBtn.addEventListener('click', function () {
        if (window.sharedUtilities && window.sharedUtilities.debounce) {
          window.sharedUtilities.debounce.debounce(() => verifyColumnMapping(), 'verify-mapping', 500);
        } else {
          verifyColumnMapping();
        }
      });
    }

    const saveDraftBtn = document.getElementById('save-draft');
    if (saveDraftBtn) {
      saveDraftBtn.addEventListener('click', function () {
        if (window.sharedUtilities && window.sharedUtilities.debounce) {
          window.sharedUtilities.debounce.debounce(() => saveDraft(), 'save-draft', 500);
        } else {
          saveDraft();
        }
      });
    }

    const aiAnalyzeBtn = document.getElementById('ai-analyze-btn');
    if (aiAnalyzeBtn) {
      aiAnalyzeBtn.addEventListener('click', function () {
        if (window.sharedUtilities && window.sharedUtilities.debounce) {
          window.sharedUtilities.debounce.debounce(() => manualColumnAnalysis(), 'ai-analyze', 500);
        } else {
          manualColumnAnalysis();
        }
      });
    }

    const publishBtn = document.getElementById('publish-now');
    if (publishBtn) {
      publishBtn.addEventListener('click', function () {
        if (window.sharedUtilities && window.sharedUtilities.debounce) {
          window.sharedUtilities.debounce.debounce(() => publishApp(), 'publish-now', 800);
        } else {
          publishApp();
        }
      });
    }

  }


  async function initializeDropdowns() {
    const formSelect = document.getElementById('form-select');
    const formUrlInput = document.getElementById('form-url-input');

    try {
      const config = systemState.config;

      // æ—¢å­˜ã®è¨­å®šãŒã‚ã‚‹å ´åˆã€ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
      if (config?.spreadsheetId && config?.sheetName) {
        // URLå…¥åŠ›æ–¹å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«è¨­å®šã‚’ä¿æŒ
        if (formUrlInput) {
          formUrlInput.dataset.spreadsheetId = config.spreadsheetId;
          formUrlInput.dataset.sheetName = config.sheetName;
          formUrlInput.dataset.formTitle = config.formTitle || '';
          formUrlInput.dataset.formUrl = config.formUrl || '';
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ–¹å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«ã‚‚è¨­å®šã‚’ä¿æŒ
        if (formSelect) {
          formSelect.dataset.spreadsheetId = config.spreadsheetId;
          formSelect.dataset.sheetName = config.sheetName;
          formSelect.dataset.formTitle = config.formTitle || '';
          formSelect.dataset.formUrl = config.formUrl || '';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’è¡¨ç¤º
        if (config.formTitle) {
          showFormDetectionInfo({
            formTitle: config.formTitle,
            sheetName: config.sheetName,
            wasCreated: false
          });
        }
      }

      setupChangeEvents();

    } catch (error) {
      console.error('ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      showError('ç®¡ç†ãƒ‘ãƒãƒ«ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    }
  }

  async function setupColumns(spreadsheetId, sheetName) {
    clearColumnDropdowns();

    try {

      const analysisResult = await getColumnAnalysis(spreadsheetId, sheetName);

      if (!analysisResult || !analysisResult.success) {
        console.warn('âš ï¸ åˆ—åˆ†æã«å¤±æ•— - ç©ºç™½çŠ¶æ…‹ã‚’ç¶­æŒ');
        return;
      }

      if (!analysisResult.headers || !Array.isArray(analysisResult.headers) || analysisResult.headers.length === 0) {
        console.warn('âš ï¸ ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ãŒç„¡åŠ¹ - ç©ºç™½çŠ¶æ…‹ã‚’ç¶­æŒ');
        return;
      }

      fillColumnDropdowns(analysisResult.headers, analysisResult.mapping, analysisResult.confidence);

    } catch (error) {
      console.error('âŒ åˆ—è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  function clearColumnDropdowns() {
    const dropdownIds = ['answer-column-select', 'reason-column-select', 'class-column-select', 'name-column-select'];

    dropdownIds.forEach(id => {
      const dropdown = document.getElementById(id);
      if (dropdown) {
        dropdown.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„...</option>';
      }
    });

  }


  function setupChangeEvents() {
  }

  function resetSheetSelect() {
    // ãƒ•ã‚©ãƒ¼ãƒ çµ±ä¸€å¾Œã¯ä¸è¦ã ãŒã€å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™
  }

  /**
   * Googleãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
   */
  function loadForms() {
    return new Promise((resolve, reject) => {
      const select = document.getElementById('form-select');
      if (!select) {
        reject(new Error('form-select element not found'));
        return;
      }

      select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';
      setPartialLoading(true, 'Googleãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');

      google.script.run
        .withSuccessHandler(function (result) {
          setPartialLoading(false);

          if (!result || result.success === false) {
            select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
            reject(new Error(result?.error || 'ãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            return;
          }

          const forms = result.forms || [];
          select.innerHTML = '<option value="">ãƒ•ã‚©ãƒ¼ãƒ ã‚’é¸æŠ...</option>';

          if (forms.length > 0) {
            forms.forEach((form) => {
              const option = document.createElement('option');
              option.value = form.url; // URLã‚’å€¤ã¨ã—ã¦ä¿æŒ
              option.textContent = form.name;
              option.dataset.formId = form.id;
              select.appendChild(option);
            });
          } else {
            const noDataOption = document.createElement('option');
            noDataOption.value = '';
            noDataOption.textContent = 'ã‚ãªãŸãŒæ‰€æœ‰ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“';
            noDataOption.disabled = true;
            select.appendChild(noDataOption);
          }

          resolve(forms);
        })
        .withFailureHandler(function (error) {
          select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
          setPartialLoading(false);
          console.error('ğŸ“ getFormsé€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          reject(new Error('ãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message));
        })
        .getForms();
    });
  }

  // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™
  function loadSpreadsheets() {
    return loadForms();
  }

  function loadSpreadsheetList() {
    loadForms();
  }



  function getSpreadsheetFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);

    const spreadsheetId = urlParams.get('spreadsheetId');
    if (spreadsheetId) {
      return { spreadsheetId, source: 'url_param' };
    }

    const spreadsheetUrl = urlParams.get('url');
    if (spreadsheetUrl) {
      const match = spreadsheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if (match) {
        return {
          spreadsheetId: match[1],
          spreadsheetUrl: spreadsheetUrl,
          source: 'url_full'
        };
      }
    }

    return null;
  }


  // ãƒ•ã‚©ãƒ¼ãƒ çµ±ä¸€å¾Œã¯ä¸è¦ã ãŒã€å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ç©ºé–¢æ•°ã¨ã—ã¦æ®‹ã™
  async function autoSelectSpreadsheet(spreadsheetId) {
    return true;
  }

  async function autoSelectSheet(sheetName) {
    return true;
  }

  function updatePanel(config) {
    if (!config) return;
    applyConfig(config);
    updateResourceButtons(config);
    updateConfigSummary(config);
  }

  function applyConfig(config) {
    if (!config) return;

    try {
      // ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
      if (config.spreadsheetId && config.sheetName) {
        const formUrlInput = document.getElementById('form-url-input');
        const formSelect = document.getElementById('form-select');

        if (formUrlInput) {
          formUrlInput.dataset.spreadsheetId = config.spreadsheetId;
          formUrlInput.dataset.sheetName = config.sheetName;
          formUrlInput.dataset.formTitle = config.formTitle || '';
          formUrlInput.dataset.formUrl = config.formUrl || '';
        }

        if (formSelect) {
          formSelect.dataset.spreadsheetId = config.spreadsheetId;
          formSelect.dataset.sheetName = config.sheetName;
          formSelect.dataset.formTitle = config.formTitle || '';
          formSelect.dataset.formUrl = config.formUrl || '';
        }
      }

      if (config.displayMode) {
        const displayModeSelect = document.getElementById('display-mode');
        if (displayModeSelect) {
          displayModeSelect.value = config.displayMode;
        }
      }

      // ãƒ•ã‚©ãƒ¼ãƒ URLè¡¨ç¤ºã‚’æ›´æ–°
      const formUrlDisplay = document.getElementById('form-url');
      if (formUrlDisplay) {
        if (config.formUrl) {
          formUrlDisplay.textContent = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
          formUrlDisplay.href = config.formUrl;
          formUrlDisplay.className = 'text-blue-400 hover:underline text-xs';
        } else {
          formUrlDisplay.textContent = 'æœªè¨­å®š';
          formUrlDisplay.href = '#';
          formUrlDisplay.className = 'text-sm text-gray-400';
        }
      }

      const formTitleDisplay = document.getElementById('form-title');
      if (formTitleDisplay) {
        if (config.formTitle) {
          formTitleDisplay.textContent = config.formTitle;
          formTitleDisplay.className = 'text-sm text-white';
        } else {
          formTitleDisplay.textContent = 'æœªè¨­å®š';
          formTitleDisplay.className = 'text-sm text-gray-400';
        }
      }


    } catch (error) {
      console.error('âŒ è¨­å®šåæ˜ ã‚¨ãƒ©ãƒ¼:', error.message);
    }
  }

  function sanitizeInput(input) {
    if (!input || typeof input !== 'string') return '';
    return input.replace(/[<>\"'&]/g, '').trim();
  }

  function sanitizeFormData(data) {
    const sanitized = {};
    for (const key in data) {
      if (data.hasOwnProperty(key)) {
        if (typeof data[key] === 'string') {
          sanitized[key] = sanitizeInput(data[key]);
        } else {
          sanitized[key] = data[key];
        }
      }
    }
    return sanitized;
  }


  // ãƒ•ã‚©ãƒ¼ãƒ çµ±ä¸€å¾Œã¯ä¸è¦ã ãŒã€å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ç©ºé–¢æ•°ã¨ã—ã¦æ®‹ã™
  function loadSheets(spreadsheetId) {
    return Promise.resolve([]);
  }

  async function getColumnAnalysis(spreadsheetId, sheetName) {
    const gateKey = `getColumnAnalysis_${spreadsheetId}_${sheetName}`;

    if (!ClientMutex.acquire(gateKey)) {
      console.warn('getColumnAnalysis: æ—¢ã«å®Ÿè¡Œä¸­ã§ã™');
      return { success: false, error: 'Analysis already in progress' };
    }

    try {
      return new Promise((resolve, reject) => {

        google.script.run
          .withSuccessHandler(function (result) {
            ClientMutex.release(gateKey);
            resolve(result);
          })
          .withFailureHandler(function (error) {
            console.error('âŒ getColumnAnalysis direct error:', error);
            ClientMutex.release(gateKey);
            reject(error);
          })
          .getColumnAnalysis(spreadsheetId, sheetName);
      });
    } catch (error) {
      ClientMutex.release(gateKey);
      throw error;
    }
  }




  function openManualGuide() {
    if (window.notifications) {
      window.notifications.info('ğŸ“š ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã‚’é–‹ã„ã¦ã„ã¾ã™...', 2000);
    }

    google.script.run
      .withSuccessHandler(function (webAppUrl) {
        if (webAppUrl) {
          window.open(webAppUrl + '?mode=manual', '_blank');
        }
      })
      .withFailureHandler(function (error) {
        console.error('ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        if (window.notifications) {
          window.notifications.error('ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚', 3000);
        }
      })
      .getWebAppUrl();
  }

  function updateResourceButtons(config) {
    const spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
    const formBtn = document.getElementById('open-form-btn');
    const boardBtn = document.getElementById('open-board-btn');
    const statusDiv = document.getElementById('resource-status');


    const saveDraftBtn = document.getElementById('save-draft');
    const publishNowBtn = document.getElementById('publish-now');


    const hasColumnMapping = !!(config.columnMapping && Object.keys(config.columnMapping).length > 0);
    const hasSpreadsheetConfig = !!(config.spreadsheetId && config.sheetName);
    const isSetupComplete = config.setupStatus === 'completed' ||
      (hasSpreadsheetConfig && hasColumnMapping);


    if (saveDraftBtn) {
      if (hasSpreadsheetConfig) {
        saveDraftBtn.disabled = false;
        saveDraftBtn.textContent = hasColumnMapping ? 'ä¸‹æ›¸ãä¿å­˜' : 'ä¸‹æ›¸ãä¿å­˜ï¼ˆåˆ—è¨­å®šæ¨å¥¨ï¼‰';
        saveDraftBtn.classList.remove('opacity-50');
      } else {
        saveDraftBtn.disabled = true;
        saveDraftBtn.textContent = 'ä¸‹æ›¸ãä¿å­˜ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æœªæ¥ç¶šï¼‰';
        saveDraftBtn.classList.add('opacity-50');
      }
    }

    if (publishNowBtn) {
      if (hasSpreadsheetConfig && hasColumnMapping) {
        publishNowBtn.disabled = false;
        publishNowBtn.textContent = 'ä»Šã™ãå…¬é–‹';
        publishNowBtn.classList.remove('opacity-50');
      } else {
        publishNowBtn.disabled = true;
        if (!hasSpreadsheetConfig) {
          publishNowBtn.textContent = 'ä»Šã™ãå…¬é–‹ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æœªæ¥ç¶šï¼‰';
        } else {
          publishNowBtn.textContent = 'ä»Šã™ãå…¬é–‹ï¼ˆåˆ—è¨­å®šãŒå¿…è¦ï¼‰';
        }
        publishNowBtn.classList.add('opacity-50');
      }
    }

    const hasSpreadsheet = !!(config && config.spreadsheetId);
    if (spreadsheetBtn) {
      spreadsheetBtn.disabled = !hasSpreadsheet;
      spreadsheetBtn.dataset.spreadsheetId = hasSpreadsheet ? config.spreadsheetId : '';
      spreadsheetBtn.classList.toggle('opacity-50', !hasSpreadsheet);

      if (hasSpreadsheet) {
        spreadsheetBtn.onclick = () => {
          window.open('https://docs.google.com/spreadsheets/d/' + config.spreadsheetId + '/edit', '_blank');
        };
      }
    }

    const hasForm = !!(config && config.formUrl && isValidFormUrl(config.formUrl));
    if (formBtn) {
      formBtn.disabled = !hasForm;
      formBtn.dataset.formUrl = hasForm ? config.formUrl : '';
      formBtn.classList.toggle('opacity-50', !hasForm);

      if (hasForm) {
        formBtn.onclick = () => {
          window.open(config.formUrl, '_blank');
        };
      }
    }

    if (boardBtn) {
      if (config.isPublished) {
        boardBtn.classList.remove('hidden');
        boardBtn.disabled = false;
      } else {
        boardBtn.classList.add('hidden');
      }
    }

    if (statusDiv) {
      statusDiv.textContent = '';
      statusDiv.className = 'hidden';
    }

    updateAIAnalyzeButtonState(config);

    if (isSetupComplete && hasColumnMapping && hasSpreadsheetConfig) {
      const setupStatusDiv = document.getElementById('setup-status-feedback');
      if (setupStatusDiv) {
        setupStatusDiv.innerHTML = `
          <div class="flex items-center gap-2 p-3 bg-green-900/20 border border-green-500/30 rounded-lg text-green-400 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼ä¸‹æ›¸ãä¿å­˜ã¾ãŸã¯å…¬é–‹ã‚’å®Ÿè¡Œã§ãã¾ã™</span>
          </div>
        `;
      }
    }

    updateConfigSummary(config);
  }

  function updateAIAnalyzeButtonState(config) {
    const aiAnalyzeBtn = document.getElementById('ai-analyze-btn');
    if (!aiAnalyzeBtn) return;

    const hasSpreadsheetConfig = !!(config && config.spreadsheetId && config.sheetName);
    const hasHeaders = Array.isArray(window.currentHeaders) && window.currentHeaders.length > 0;
    const hasDropdownOptions = document.querySelectorAll('#answer-column-select option').length > 1; // "æœªé¸æŠ"ä»¥å¤–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    const canAnalyze = hasSpreadsheetConfig && (hasHeaders || hasDropdownOptions);

    if (canAnalyze) {
      aiAnalyzeBtn.disabled = false;
      aiAnalyzeBtn.textContent = 'ğŸ¤– AIåˆ—åˆ¤å®š';
      aiAnalyzeBtn.classList.remove('opacity-50');
    } else {
      aiAnalyzeBtn.disabled = true;
      if (!hasSpreadsheetConfig) {
        aiAnalyzeBtn.textContent = 'ğŸ¤– AIåˆ—åˆ¤å®šï¼ˆãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶šãŒå¿…è¦ï¼‰';
      } else {
        aiAnalyzeBtn.textContent = 'ğŸ¤– AIåˆ—åˆ¤å®šï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å–å¾—ãŒå¿…è¦ï¼‰';
      }
      aiAnalyzeBtn.classList.add('opacity-50');
    }
  }

  function updateSystemState(updates = {}) {
    const { spreadsheetId, sheetName, columnMapping, setupStatus, formUrl, formTitle, needsProgress = false } = updates;

    if (spreadsheetId || sheetName || columnMapping || setupStatus || formUrl || formTitle) {
      systemState.config = {
        ...systemState.config,
        ...(spreadsheetId && { spreadsheetId }),
        ...(sheetName && { sheetName }),
        ...(columnMapping && { columnMapping }),
        ...(setupStatus && { setupStatus }),
        ...(formUrl && { formUrl }),
        ...(formTitle && { formTitle })
      };
    }

    updateAIAnalyzeButtonState(systemState.config);
    updateResourceButtons(systemState.config);

    if (needsProgress) {
      const hasSpreadsheetConfig = systemState.config?.spreadsheetId && systemState.config?.sheetName;
      const hasColumnMapping = systemState.config?.columnMapping && Object.keys(systemState.config.columnMapping).length > 0;
      const step = hasSpreadsheetConfig && hasColumnMapping ? 3 : (hasSpreadsheetConfig ? 2 : 1);
      updateProgress(step);
    }
  }

  function getFormInfoContainer() {
    const urlMethodElement = document.getElementById('url-method');
    const isUrlMethod = urlMethodElement && !urlMethodElement.classList.contains('hidden');
    // URLæ–¹å¼: form-detection-info, ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ–¹å¼: form-info
    return isUrlMethod ?
      document.getElementById('form-detection-info') :
      document.getElementById('form-info');
  }

  function updateFormInfo(formData, options = {}) {
    const urlMethodElement = document.getElementById('url-method');
    const isUrlMethod = urlMethodElement && !urlMethodElement.classList.contains('hidden');

    const safeData = formData || {};

    if (isUrlMethod) {
      // URLæ–¹å¼ã®å ´åˆ: form-detection-info ã‚’ä½¿ç”¨ï¼ˆãƒªãƒ³ã‚¯ä»˜ãï¼‰
      const container = document.getElementById('form-detection-info');
      const formLink = document.getElementById('detected-form-link');
      const spreadsheetLink = document.getElementById('detected-spreadsheet-link');

      if (formLink) {
        formLink.textContent = safeData.formTitle || 'ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ãªã—';
        formLink.href = safeData.editUrl || safeData.formUrl || '#';
      }
      if (spreadsheetLink) {
        spreadsheetLink.textContent = safeData.sheetName || 'æ¤œå‡ºæ¸ˆã¿';
        spreadsheetLink.href = safeData.spreadsheetUrl || '#';
      }
      if (container) {
        container.classList.remove('hidden');
      }
    } else {
      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ–¹å¼ã®å ´åˆ: form-info ã‚’ä½¿ç”¨
      const container = document.getElementById('form-info');
      const titleElement = document.getElementById('form-title');
      const urlElement = document.getElementById('form-url');

      if (titleElement) {
        titleElement.textContent = safeData.formTitle || 'ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ãªã—';
      }
      if (urlElement) {
        if (safeData.formUrl) {
          urlElement.textContent = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
          urlElement.href = safeData.formUrl;
          urlElement.classList.remove('text-gray-500');
          urlElement.classList.add('text-blue-400');
        } else {
          urlElement.textContent = 'æœªé€£æº';
          urlElement.href = '#';
          urlElement.classList.add('text-gray-500');
          urlElement.classList.remove('text-blue-400');
        }
      }
      if (container) {
        container.classList.remove('hidden');
      }
    }
  }

  function displayFormInfo(formData, options = {}) {
    return updateFormInfo(formData, options);
  }



  function hideFormInfo() {
    const formInfo = document.getElementById('form-info');
    if (formInfo) {
      formInfo.classList.add('hidden');
      formInfo.removeAttribute('data-form-status');
      formInfo.removeAttribute('data-form-reason');
      formInfo.removeAttribute('data-form-diagnostics');
    }
  }

  /**
   * ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ ã‚’æ¤œè¨¼
   * @param {string} formUrl - ãƒ•ã‚©ãƒ¼ãƒ URL
   */
  function validateFormFromDropdown(formUrl) {
    const formSelect = document.getElementById('form-select');
    const formInfo = document.getElementById('form-info');
    const formTitle = document.getElementById('form-title');
    const formSpreadsheetStatus = document.getElementById('form-spreadsheet-status');
    const formUrlLink = document.getElementById('form-url');

    if (!formUrl) {
      hideFormInfo();
      return;
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    if (formInfo) {
      formInfo.classList.remove('hidden');
      if (formTitle) formTitle.textContent = 'æ¤œè¨¼ä¸­...';
      if (formSpreadsheetStatus) formSpreadsheetStatus.textContent = '-';
    }

    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’è¡¨ç¤º
          if (formTitle) formTitle.textContent = result.formTitle;
          if (formSpreadsheetStatus) {
            formSpreadsheetStatus.textContent = result.wasCreated
              ? 'æ–°è¦ä½œæˆã—ã¾ã—ãŸ'
              : result.sheetName;
          }
          if (formUrlLink) {
            formUrlLink.href = result.formUrl;
            formUrlLink.textContent = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
          }
          formInfo?.classList.remove('hidden');

          // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
          if (formSelect) {
            formSelect.dataset.spreadsheetId = result.spreadsheetId;
            formSelect.dataset.sheetName = result.sheetName;
            formSelect.dataset.formTitle = result.formTitle;
            formSelect.dataset.formUrl = result.formUrl;
          }

          if (result.wasCreated) {
            showSuccess('å›ç­”å…ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
          }

          // è‡ªå‹•çš„ã«æ¥ç¶šå‡¦ç†ã‚’å®Ÿè¡Œ
          setTimeout(() => connectToDataSource(), 300);
        } else {
          if (formTitle) formTitle.textContent = 'ã‚¨ãƒ©ãƒ¼';
          if (formSpreadsheetStatus) formSpreadsheetStatus.textContent = result.error || 'æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
          showError(result.error || 'æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .withFailureHandler(function (error) {
        if (formTitle) formTitle.textContent = 'ã‚¨ãƒ©ãƒ¼';
        if (formSpreadsheetStatus) formSpreadsheetStatus.textContent = error.message;
        showError(error.message || 'æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      })
      .processFormUrlInput(formUrl);
  }

  /**
   * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ
   */
  function createTemplateForm() {
    const btn = document.getElementById('create-template-form');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'ä½œæˆä¸­...';
    }

    google.script.run
      .withSuccessHandler(function (result) {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'âœ¨ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ';
        }

        if (result.success) {
          showSuccess(result.message || 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ');

          // URLå…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ãƒ URLã¨æ¥ç¶šæƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
          const formUrlInput = document.getElementById('form-url-input');
          if (formUrlInput) {
            formUrlInput.value = result.editUrl;
            // connectToDataSource()ã§ä½¿ç”¨ã™ã‚‹datasetã‚‚è¨­å®š
            formUrlInput.dataset.spreadsheetId = result.spreadsheetId;
            formUrlInput.dataset.sheetName = result.sheetName;
            formUrlInput.dataset.formTitle = result.formTitle;
            formUrlInput.dataset.formUrl = result.formUrl;
          }

          // ãƒ•ã‚©ãƒ¼ãƒ é¸æŠãƒ‡ãƒ¼ã‚¿ã‚‚ä¿æŒï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
          const formSelect = document.getElementById('form-select');
          if (formSelect) {
            formSelect.dataset.spreadsheetId = result.spreadsheetId;
            formSelect.dataset.sheetName = result.sheetName;
            formSelect.dataset.formTitle = result.formTitle;
            formSelect.dataset.formUrl = result.formUrl;
          }

          // æ¤œå‡ºæƒ…å ±ã‚’è¡¨ç¤ºï¼ˆãƒªãƒ³ã‚¯ä»˜ãï¼‰
          const detectionInfo = document.getElementById('form-detection-info');
          const detectedFormLink = document.getElementById('detected-form-link');
          const detectedSpreadsheetLink = document.getElementById('detected-spreadsheet-link');
          if (detectionInfo) detectionInfo.classList.remove('hidden');
          if (detectedFormLink) {
            detectedFormLink.textContent = result.formTitle;
            detectedFormLink.href = result.editUrl || '#';
          }
          if (detectedSpreadsheetLink) {
            detectedSpreadsheetLink.textContent = result.sheetName || 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ';
            detectedSpreadsheetLink.href = result.spreadsheetUrl || '#';
          }

          // ç·¨é›†ç”¨URLã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãï¼ˆä½œæˆå®Œäº†å¾Œã«é–‹ãï¼‰
          if (result.editUrl) {
            window.open(result.editUrl, '_blank');
          }

          // è‡ªå‹•çš„ã«æ¥ç¶šå‡¦ç†ã‚’å®Ÿè¡Œ
          setTimeout(() => connectToDataSource(), 500);
        } else {
          showError(result.error || 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .withFailureHandler(function (error) {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'âœ¨ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ';
        }
        showError(error.message || 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      })
      .createTemplateForm();
  }

  function processFormDetectionResult(formResult) {

    if (!formResult) {
      return null;
    }


    const normalizedData = formResult.formData || formResult;
    const confidence = normalizedData.detectionDetails?.confidence || 0;
    const hasFormUrl = !!normalizedData.formUrl;


    if (hasFormUrl) {

      return { status: 'linked', message: 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºã‚’ç¢ºèªã—ã¾ã—ãŸ' };
    }

    const isFormDetected = formResult.status === 'FORM_LINK_FOUND' ||
      (formResult.success && confidence >= 70);

    if (isFormDetected) {

      return { status: 'detected', message: 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºï¼ˆURLå–å¾—ä¸å¯ï¼‰' };
    }

    if (confidence >= 40) {
      return { status: 'possible', message: 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã—ã¾ã—ãŸ' };
    }

    return { status: 'missing', message: 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºãŒç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ' };
  }

  function checkSheetFormConnection(spreadsheetId, sheetName) {
    if (!spreadsheetId || !sheetName) {
      hideFormInfo();
      return;
    }

    setPartialLoading(true, 'ã‚·ãƒ¼ãƒˆé€£æºæƒ…å ±ã‚’ç¢ºèªä¸­...');

    google.script.run
      .withSuccessHandler((result) => {
        setPartialLoading(false);
        const normalizedResult = result && typeof result === 'object' ? result : null;
        const rawFormData = normalizedResult && typeof normalizedResult.formData === 'object' ? normalizedResult.formData : null;
        const derivedSpreadsheetName = rawFormData?.spreadsheetName || normalizedResult?.diagnostics?.spreadsheetName || '';
        const derivedSheetName = rawFormData?.sheetName || normalizedResult?.requestContext?.sheetName || sheetName;

        window.__formIntegrationLatestResponse = normalizedResult;


        if (normalizedResult && normalizedResult.success && rawFormData && rawFormData.formUrl) {
          displayFormInfo(
            {
              ...rawFormData,
              spreadsheetName: derivedSpreadsheetName,
              sheetName: derivedSheetName
            },
            {
              status: 'linked',
              message: normalizedResult.message || 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºã‚’ç¢ºèªã—ã¾ã—ãŸ',
              reason: normalizedResult.reason || '',
              diagnostics: normalizedResult.diagnostics || null,
              suggestions: Array.isArray(normalizedResult.suggestions) ? normalizedResult.suggestions : [],
              spreadsheetName: derivedSpreadsheetName,
              sheetName: derivedSheetName
            }
          );
          return;
        }

        const fallbackMessage = normalizedResult && normalizedResult.message
          ? normalizedResult.message
          : 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
        const fallbackSuggestions = normalizedResult && Array.isArray(normalizedResult.suggestions)
          ? normalizedResult.suggestions
          : [];

        console.warn('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ é€£æºæƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„:', {
          reason: normalizedResult ? normalizedResult.reason : 'ä¸æ˜',
          suggestions: fallbackSuggestions
        });

        if (fallbackSuggestions.length > 0) {
          const formattedSuggestions = fallbackSuggestions.map((s) => `â€¢ ${s}`).join('\n');
          showWarning(`${fallbackMessage}\n\næ¨å¥¨å¯¾å‡¦æ³•:\n${formattedSuggestions}`);
        } else {
          showWarning(fallbackMessage);
        }

        const fallbackFormData = {
          ...(rawFormData || {}),
          formUrl: rawFormData ? rawFormData.formUrl : null,
          formTitle: (rawFormData && rawFormData.formTitle) || derivedSpreadsheetName || derivedSheetName || 'ãƒ•ã‚©ãƒ¼ãƒ æœªé€£æº',
          spreadsheetName: derivedSpreadsheetName,
          sheetName: derivedSheetName
        };

        displayFormInfo(fallbackFormData, {
          status: 'missing',
          message: fallbackMessage,
          reason: normalizedResult ? normalizedResult.reason || 'FORM_INFO_UNAVAILABLE' : 'FORM_INFO_UNAVAILABLE',
          diagnostics: normalizedResult ? normalizedResult.diagnostics || null : null,
          suggestions: fallbackSuggestions,
          spreadsheetName: derivedSpreadsheetName,
          sheetName: derivedSheetName
        });
      })
      .withFailureHandler((error) => {
        setPartialLoading(false);
        console.error('âŒ ã‚·ãƒ¼ãƒˆé€£æºãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', {
          error: error,
          errorMessage: error.message,
          spreadsheetId: spreadsheetId,
          sheetName: sheetName,
        });
        const failureMessage = 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºæƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        showError(`${failureMessage}\n${error.message || ''}`);
        window.__formIntegrationLatestResponse = null;
        hideFormInfo();
      })
      .getFormInfo(spreadsheetId, sheetName);
  }

  function exportConfig() {
    try {
      if (!systemState.config) {
        showError('è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        return;
      }

      const config = systemState.config;
      const dataStr = JSON.stringify(config, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const exportFileDefaultName = 'studyquest-config.json';

      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();

      showSuccess('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
    } catch (error) {
      console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
      showError('è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  function checkAdministratorAccess() {
    google.script.run
      .withSuccessHandler(function (isAdmin) {
        const appSetupBtn = document.getElementById('app-setup-btn');
        if (appSetupBtn) {
          if (isAdmin) {
            appSetupBtn.style.display = 'block';
          } else {
            appSetupBtn.style.display = 'none';
          }
        }
      })
      .withFailureHandler(function (error) {
        console.warn('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
        const appSetupBtn = document.getElementById('app-setup-btn');
        if (appSetupBtn) {
          appSetupBtn.style.display = 'none';
        }
      })
      .isAdmin();
  }


  /**
   * ãƒ•ã‚©ãƒ¼ãƒ URLè‡ªå‹•è§£æï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
   * @param {string} fullUrl - å…¥åŠ›ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ URL
   */
  function autoAnalyzeFormUrl(fullUrl) {
    if (!fullUrl || fullUrl.trim() === '') {
      hideFormDetectionInfo();
      updateUrlValidationMessage('ğŸ’¡ Googleãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„', 'info');
      return;
    }

    const urlInfo = parseFormUrlClientSide(fullUrl);

    if (urlInfo.isValid) {
      updateUrlValidationMessage('âœ“ æœ‰åŠ¹ãªãƒ•ã‚©ãƒ¼ãƒ URLã§ã™ã€‚ã€Œæ¤œè¨¼ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’ç¢ºèª', 'success');
    } else {
      hideFormDetectionInfo();
      updateUrlValidationMessage('âš  Googleãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
    }
  }

  // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã®å‚ç…§ç”¨ï¼‰
  function autoAnalyzeUrl(fullUrl) {
    autoAnalyzeFormUrl(fullUrl);
  }

  /**
   * ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ URLè§£æ
   * @param {string} url - è§£æå¯¾è±¡URL
   * @returns {Object} è§£æçµæœ
   */
  function parseFormUrlClientSide(url) {
    try {
      // ãƒ•ã‚©ãƒ¼ãƒ URLå½¢å¼: /forms/d/{formId}/ ã¾ãŸã¯ forms.gle/{shortId}
      const formMatch = url.match(/\/forms\/d\/([a-zA-Z0-9-_]+)/);
      const shortMatch = url.match(/forms\.gle\/([a-zA-Z0-9]+)/);

      if (!formMatch && !shortMatch) {
        return { isValid: false };
      }

      return {
        isValid: true,
        formId: formMatch ? formMatch[1] : shortMatch[1],
        isShortUrl: !!shortMatch
      };
    } catch (error) {
      console.warn('parseFormUrlClientSide error:', error.message);
      return { isValid: false };
    }
  }

  // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™
  function parseUrlClientSide(url) {
    return parseFormUrlClientSide(url);
  }

  /**
   * URLæ¤œè¨¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
   */
  function updateUrlValidationMessage(message, type) {
    const messageEl = document.getElementById('url-validation-message');
    if (messageEl) {
      messageEl.textContent = message;
      messageEl.className = 'text-xs mt-1 ';
      if (type === 'success') {
        messageEl.className += 'text-green-400';
      } else if (type === 'warning') {
        messageEl.className += 'text-yellow-400';
      } else if (type === 'error') {
        messageEl.className += 'text-red-400';
      } else {
        messageEl.className += 'text-gray-400';
      }
    }
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºæƒ…å ±ã‚’è¡¨ç¤ºï¼ˆãƒªãƒ³ã‚¯ä»˜ãï¼‰
   * @param {Object} formData - ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±
   */
  function showFormDetectionInfo(formData) {
    const container = document.getElementById('form-detection-info');
    const formLink = document.getElementById('detected-form-link');
    const spreadsheetLink = document.getElementById('detected-spreadsheet-link');

    if (container && formLink && spreadsheetLink) {
      formLink.textContent = formData.formTitle || '-';
      formLink.href = formData.editUrl || formData.formUrl || '#';

      if (formData.wasCreated) {
        spreadsheetLink.textContent = formData.sheetName || 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ';
      } else {
        spreadsheetLink.textContent = formData.sheetName || 'æ¤œå‡ºæ¸ˆã¿';
      }
      spreadsheetLink.href = formData.spreadsheetUrl || '#';

      container.classList.remove('hidden');
    }
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºæƒ…å ±ã‚’éè¡¨ç¤º
   */
  function hideFormDetectionInfo() {
    const container = document.getElementById('form-detection-info');
    if (container) {
      container.classList.add('hidden');
    }
  }

  // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™
  function showAutoDetectionInfo(urlInfo) {
    // ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã«å¤‰æ›
  }

  function hideAutoDetectionInfo() {
    hideFormDetectionInfo();
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ URLæ¤œè¨¼ - processFormUrlInput APIä½¿ç”¨
   */
  function validateCompleteUrl() {
    const urlInput = document.getElementById('form-url-input');
    const validateBtn = document.getElementById('url-validate');

    if (!urlInput) {
      console.error('form-url-input element not found');
      return;
    }

    const formUrl = urlInput.value.trim();

    if (!formUrl) {
      showError('Googleãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
    const urlInfo = parseFormUrlClientSide(formUrl);
    if (!urlInfo.isValid) {
      showError('Googleãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    validateBtn.disabled = true;
    validateBtn.textContent = 'æ¤œè¨¼ä¸­...';

    google.script.run
      .withSuccessHandler(function (result) {
        validateBtn.disabled = false;
        validateBtn.textContent = 'ğŸ” æ¤œè¨¼ã—ã¦æ¥ç¶š';

        if (result.success) {
          // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’è¡¨ç¤º
          showFormDetectionInfo(result);

          // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
          urlInput.dataset.spreadsheetId = result.spreadsheetId;
          urlInput.dataset.sheetName = result.sheetName;
          urlInput.dataset.formTitle = result.formTitle;
          urlInput.dataset.formUrl = result.formUrl;

          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
          if (result.wasCreated) {
            showSuccess('å›ç­”å…ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
          }

          updateUrlValidationMessage('âœ“ æ¤œè¨¼å®Œäº†', 'success');

          // è‡ªå‹•çš„ã«æ¥ç¶šå‡¦ç†ã‚’å®Ÿè¡Œ
          setTimeout(() => connectToDataSource(), 300);
        } else {
          hideFormDetectionInfo();
          showError(result.error || 'æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
          updateUrlValidationMessage('âš  ' + (result.error || 'æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ'), 'error');
        }
      })
      .withFailureHandler(function (error) {
        validateBtn.disabled = false;
        validateBtn.textContent = 'ğŸ” æ¤œè¨¼ã—ã¦æ¥ç¶š';
        console.error('âŒ processFormUrlInput error:', error);
        showError(error.message || 'æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        updateUrlValidationMessage('âš  ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
      })
      .processFormUrlInput(formUrl);
  }


  async function manualColumnAnalysis() {
    const spreadsheetId = getCurrentSpreadsheetId();
    const sheetName = getCurrentSheetName();

    if (!spreadsheetId || !sheetName) {
      showError('å…ˆã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ¥ç¶šã—ã¦ãã ã•ã„');
      return;
    }

    try {
      window.setLoading(true, 'å‡¦ç†ä¸­...');
      showInfo('AIåˆ—åˆ¤å®šå®Ÿè¡Œä¸­...', 3000);

      await performColumnAnalysis(spreadsheetId, sheetName);

      const currentMapping = getColumnMapping();
      updateSystemState({
        spreadsheetId,
        sheetName,
        columnMapping: currentMapping,
        setupStatus: 'completed',
        needsProgress: true
      });

      showSuccess('AIåˆ—åˆ¤å®šå®Œäº†ï¼è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
    } catch (error) {
      console.error('æ‰‹å‹•AIåˆ—åˆ¤å®šã‚¨ãƒ©ãƒ¼:', error);
      showError('AIåˆ—åˆ¤å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„');
    } finally {
      window.setLoading(false);
    }
  }

  async function performColumnAnalysis(spreadsheetId, sheetName, retryCount = 0) {
    const maxRetries = 3;
    const retryDelay = Math.pow(2, retryCount) * 1000; // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•

    try {
      const analysisResult = await getColumnAnalysis(spreadsheetId, sheetName);

      const qualityCheck = validateAnalysisResult(analysisResult);

      if (!qualityCheck.isValid) {
        if (retryCount < maxRetries) {
          console.warn(`âš ï¸ åˆ†æå“è³ªä¸è¶³ã€ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™: ${qualityCheck.reason}`);
          showInfo(`åˆ†æå“è³ªå‘ä¸Šã®ãŸã‚å†è©¦è¡Œä¸­... (${retryCount + 2}/${maxRetries + 1})`, 3000);

          await new Promise(resolve => {
            const start = Date.now();
            const check = () => (Date.now() - start >= retryDelay) ? resolve() : Promise.resolve().then(check);
            check();
          });

          return performColumnAnalysis(spreadsheetId, sheetName, retryCount + 1);
        } else {
          console.error('ğŸš« æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«åˆ°é”ã€å“è³ªä¸è¶³ã®çµæœã‚’ä½¿ç”¨');
          showWarning('AIåˆ†æã®ç²¾åº¦ãŒæœŸå¾…å€¤ã‚’ä¸‹å›ã‚Šã¾ã—ãŸãŒã€åˆ©ç”¨å¯èƒ½ãªçµæœã‚’è¡¨ç¤ºã—ã¾ã™', 5000);
        }
      }

      if (!analysisResult || !analysisResult.success) {
        throw new Error('åˆ—åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      if (!analysisResult.headers || !Array.isArray(analysisResult.headers) || analysisResult.headers.length === 0) {
        throw new Error('ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }

      fillColumnDropdowns(analysisResult.headers, analysisResult.mapping, analysisResult.confidence);

      displayAnalysisQualityReport(analysisResult, qualityCheck);

      updateCompletionStatus();

    } catch (error) {
      console.error(`âŒ åˆ—åˆ†æã‚¨ãƒ©ãƒ¼ (è©¦è¡Œ ${retryCount + 1}):`, error);

      if (retryCount < maxRetries && isRetryableError(error)) {
        console.warn(`ğŸ”„ ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ã‚¨ãƒ©ãƒ¼ã€å†è©¦è¡Œã—ã¾ã™: ${error.message}`);
        showInfo(`æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®ãŸã‚å†è©¦è¡Œä¸­... (${retryCount + 2}/${maxRetries + 1})`, 3000);

        await new Promise(resolve => {
          const start = Date.now();
          const check = () => (Date.now() - start >= retryDelay) ? resolve() : Promise.resolve().then(check);
          check();
        });
        return performColumnAnalysis(spreadsheetId, sheetName, retryCount + 1);
      }

      console.error('ğŸš« åˆ—åˆ†æã®å…¨è©¦è¡ŒãŒå¤±æ•—ã—ã¾ã—ãŸ');

      try {
        await attemptEmergencyFallback(spreadsheetId, sheetName);
      } catch (fallbackError) {
        console.error('ğŸš« ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å¤±æ•—:', fallbackError.message);
        throw new Error(`åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ (å…¨${maxRetries + 1}å›è©¦è¡Œ): ${error.message}`);
      }
    }
  }

  /**
   * ğŸ” åˆ†æçµæœå“è³ªæ¤œè¨¼
   */
  function validateAnalysisResult(result) {
    if (!result || !result.success) {
      return { isValid: false, reason: 'APIå‘¼ã³å‡ºã—å¤±æ•—' };
    }

    const mapping = result.mapping || {};
    const confidence = result.confidence || {};

    const requiredFields = ['answer', 'name', 'class'];
    const detectedCount = requiredFields.filter(field =>
      mapping[field] !== undefined && confidence[field] > 30
    ).length;

    const avgConfidence = Object.values(confidence).length > 0
      ? Object.values(confidence).reduce((sum, c) => sum + c, 0) / Object.values(confidence).length
      : 0;

    const minDetectedFields = 2; // æœ€ä½2ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œå‡º
    const minAvgConfidence = 40; // å¹³å‡40%ä»¥ä¸Š

    const isValid = detectedCount >= minDetectedFields && avgConfidence >= minAvgConfidence;

    return {
      isValid,
      reason: !isValid ? `æ¤œå‡ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³: ${detectedCount}/${requiredFields.length}, å¹³å‡ä¿¡é ¼åº¦: ${avgConfidence.toFixed(1)}%` : 'OK',
      detectedCount,
      avgConfidence
    };
  }

  /**
   * ğŸ”„ ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ã‚¨ãƒ©ãƒ¼åˆ¤å®š
   */
  function isRetryableError(error) {
    const retryableMessages = [
      'network', 'timeout', 'connection', 'æ¥ç¶š', 'ã‚¢ã‚¯ã‚»ã‚¹',
      'temporary', 'busy', 'rate limit', 'ä¸€æ™‚çš„', 'ã‚µãƒ¼ãƒãƒ¼'
    ];

    const message = error.message.toLowerCase();
    return retryableMessages.some(pattern => message.includes(pattern));
  }

  /**
   * ğŸ†˜ ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
   */
  async function attemptEmergencyFallback(spreadsheetId, sheetName) {
    showWarning('AIåˆ†æã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚åŸºæœ¬çš„ãªãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã®ã¿å–å¾—ã—ã¾ã™ã€‚', 5000);

    try {
      const basicResult = await new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getSheetHeaders(spreadsheetId, sheetName); // ç°¡æ˜“ãƒ˜ãƒƒãƒ€ãƒ¼å–å¾—API
      });

      if (basicResult && basicResult.headers) {
        fillColumnDropdowns(basicResult.headers, {}, {});
        showWarning('æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚AIåˆ†æã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 8000);
      }

    } catch (basicError) {
      throw new Error('åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾—ã‚‚å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  /**
   * ğŸ“Š åˆ†æå“è³ªãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
   */
  function displayAnalysisQualityReport(result, quality) {
    const detectedFields = Object.keys(result.mapping || {}).length;
    const avgConfidence = quality.avgConfidence;

    let qualityLevel = 'excellent';
    if (avgConfidence < 60) qualityLevel = 'good';
    if (avgConfidence < 40) qualityLevel = 'fair';
    if (avgConfidence < 20) qualityLevel = 'poor';

    const qualityIcons = {
      excellent: 'ğŸ¯',
      good: 'âœ…',
      fair: 'âš ï¸',
      poor: 'ğŸ”'
    };

    const qualityMessages = {
      excellent: `é«˜ç²¾åº¦åˆ†æå®Œäº† (${detectedFields}ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œå‡º, å¹³å‡${avgConfidence.toFixed(1)}%ä¿¡é ¼åº¦)`,
      good: `è‰¯å¥½ãªåˆ†æçµæœ (${detectedFields}ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œå‡º, å¹³å‡${avgConfidence.toFixed(1)}%ä¿¡é ¼åº¦)`,
      fair: `åˆ†æå®Œäº† (${detectedFields}ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œå‡º, å¹³å‡${avgConfidence.toFixed(1)}%ä¿¡é ¼åº¦) - æ‰‹å‹•ç¢ºèªæ¨å¥¨`,
      poor: `åˆ†æçµæœãŒä¸ååˆ† (${detectedFields}ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œå‡º, å¹³å‡${avgConfidence.toFixed(1)}%ä¿¡é ¼åº¦) - æ‰‹å‹•è¨­å®šæ¨å¥¨`
    };

    const icon = qualityIcons[qualityLevel];
    const message = qualityMessages[qualityLevel];

    showSuccess(`${message}`, 6000);
  }

  function getCurrentSpreadsheetId() {
    // url-methodã®hiddençŠ¶æ…‹ã§åˆ¤å®šï¼ˆtoggleSourceMethodã¨åŒæœŸï¼‰
    const urlMethodElement = document.getElementById('url-method');
    const isUrlMethod = urlMethodElement && !urlMethodElement.classList.contains('hidden');

    if (isUrlMethod) {
      const urlInput = document.getElementById('form-url-input');
      return urlInput?.dataset.spreadsheetId || null;
    } else {
      const formSelect = document.getElementById('form-select');
      return formSelect?.dataset.spreadsheetId || null;
    }
  }

  function getCurrentSheetName() {
    // url-methodã®hiddençŠ¶æ…‹ã§åˆ¤å®šï¼ˆtoggleSourceMethodã¨åŒæœŸï¼‰
    const urlMethodElement = document.getElementById('url-method');
    const isUrlMethod = urlMethodElement && !urlMethodElement.classList.contains('hidden');

    if (isUrlMethod) {
      const urlInput = document.getElementById('form-url-input');
      return urlInput?.dataset.sheetName || null;
    } else {
      const formSelect = document.getElementById('form-select');
      return formSelect?.dataset.sheetName || null;
    }
  }

  function updateCompletionStatus() {
    const requiredColumns = ['answer']; // å¿…é ˆåˆ—ï¼šå›ç­”åˆ—ã®ã¿
    const optionalColumns = ['reason', 'class', 'name']; // ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆ—

    let requiredCompleted = 0;
    requiredColumns.forEach(type => {
      const select = document.getElementById(`${type}-column-select`);
      if (select && select.value) {
        requiredCompleted++;
      }
    });

    let optionalCompleted = 0;
    optionalColumns.forEach(type => {
      const select = document.getElementById(`${type}-column-select`);
      if (select && select.value) {
        optionalCompleted++;
      }
    });

    const statusElement = document.getElementById('completion-status');
    if (statusElement) {
      const isRequiredComplete = requiredCompleted === requiredColumns.length;
      const statusIcon = isRequiredComplete ? (optionalCompleted === optionalColumns.length ? 'ğŸŸ¢' : 'ğŸŸ¡') : 'âšª';
      statusElement.textContent = `${statusIcon} å¿…é ˆ: ${requiredCompleted}/${requiredColumns.length} ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ${optionalCompleted}/${optionalColumns.length}`;
    }

    const verifyButton = document.getElementById('verify-mapping');
    if (verifyButton) {
      const isAnswerSet = document.getElementById('answer-column-select')?.value;
      verifyButton.disabled = !isAnswerSet;
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ çµ±ä¸€å¾Œã¯ä¸è¦ã ãŒã€å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ç©ºé–¢æ•°ã¨ã—ã¦æ®‹ã™
  function loadSheetList(spreadsheetId) {
    // ãƒ•ã‚©ãƒ¼ãƒ æ–¹å¼ã§ã¯ processFormUrlInput() ã§ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚‚å–å¾—ã™ã‚‹ãŸã‚ä¸è¦
  }

  async function connectToDataSource() {
    const gateKey = 'connectToDataSource';
    if (!ClientMutex.acquire(gateKey)) {
      showInfo('ç¾åœ¨å‡¦ç†ä¸­ã§ã™â€¦å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    // å¤‰æ•°ã‚’tryãƒ–ãƒ­ãƒƒã‚¯å¤–ã§å®£è¨€ï¼ˆcatchãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼‰
    const urlMethodElement = document.getElementById('url-method');
    const isUrlMethod = urlMethodElement && !urlMethodElement.classList.contains('hidden');
    let spreadsheetId = '';
    let sheetName = '';

    try {

      if (isUrlMethod) {
        // URLå…¥åŠ›æ–¹å¼: ãƒ•ã‚©ãƒ¼ãƒ URLæ¤œè¨¼ã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        const urlInput = document.getElementById('form-url-input');
        if (!urlInput) {
          showError('ãƒ•ã‚©ãƒ¼ãƒ URLå…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          ClientMutex.release(gateKey);
          return;
        }

        spreadsheetId = urlInput.dataset.spreadsheetId;
        sheetName = urlInput.dataset.sheetName;

        if (!spreadsheetId || !sheetName) {
          showError('å…ˆã«ã€Œæ¤œè¨¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ¤œè¨¼ã—ã¦ãã ã•ã„');
          ClientMutex.release(gateKey);
          return;
        }
      } else {
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ–¹å¼: ãƒ•ã‚©ãƒ¼ãƒ é¸æŠã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        const formSelect = document.getElementById('form-select');
        if (!formSelect) {
          showError('ãƒ•ã‚©ãƒ¼ãƒ é¸æŠæ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          ClientMutex.release(gateKey);
          return;
        }

        spreadsheetId = formSelect.dataset.spreadsheetId;
        sheetName = formSelect.dataset.sheetName;

        if (!spreadsheetId || !sheetName) {
          showError('ãƒ•ã‚©ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„');
          ClientMutex.release(gateKey);
          return;
        }
      }

      window.setLoading(true, 'å‡¦ç†ä¸­...');

      const result = await processBatchOperations([
        { type: 'validateAccess', spreadsheetId, sheetName },
        { type: 'getFormInfo', spreadsheetId, sheetName },
        { type: 'connectDataSource', spreadsheetId, sheetName }
      ]);

      if (result.success) {
        const successDetails = [];
        successDetails.push('âœ… ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶šå®Œäº†');

        if (result.batchResults && result.batchResults.formInfo) {
          successDetails.push('ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ é€£æºç¢ºèªæ¸ˆã¿');
          displayFormInfo(result.batchResults.formInfo.formData, {
            status: 'linked',
            spreadsheetName: result.batchResults.formInfo.spreadsheetName
          });
        }

        showSuccess(successDetails.join(' | '));

        // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—
        const formInfo = result.batchResults?.formInfo?.formData || getCurrentFormInfoSafe();
        const formUrl = formInfo?.formUrl || null;
        const formTitle = formInfo?.formTitle || null;

        if (result.headers && result.mapping) {
          fillColumnDropdowns(result.headers, result.mapping, result.confidence);

          updateSystemState({
            spreadsheetId,
            sheetName,
            columnMapping: result.mapping,
            setupStatus: 'completed',
            formUrl,
            formTitle,
            needsProgress: true
          });

          showSuccess('æ¥ç¶šã¨AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        } else {
          showInfo('AIåˆ—åˆ¤å®šå®Ÿè¡Œä¸­...', 3000);
          try {
            await performColumnAnalysis(spreadsheetId, sheetName);

            const currentMapping = getColumnMapping();
            updateSystemState({
              spreadsheetId,
              sheetName,
              columnMapping: currentMapping,
              setupStatus: 'completed',
              formUrl,
              formTitle
            });

            showSuccess('AIåˆ—åˆ¤å®šå®Œäº†ï¼è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
          } catch (analysisError) {
            console.warn('AIåˆ—åˆ¤å®šã‚¨ãƒ©ãƒ¼:', analysisError);
            showWarning('AIåˆ—åˆ¤å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§è¨­å®šã™ã‚‹ã‹ã€ŒAIåˆ—åˆ¤å®šã€ãƒœã‚¿ãƒ³ã§å†å®Ÿè¡Œã—ã¦ãã ã•ã„');
          }
        }
      } else {
        handleConnectionError(result.message || result.error || 'ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ', { spreadsheetId, sheetName, method: isUrlMethod ? 'URL' : 'dropdown' });
      }
    } catch (error) {
      console.error('connectToDataSource ã‚¨ãƒ©ãƒ¼:', error);
      handleConnectionError(error.message || error, { spreadsheetId, sheetName, method: isUrlMethod ? 'URL' : 'dropdown' });
    } finally {
      window.setLoading(false);
      ClientMutex.release(gateKey);
    }
  }

  async function processBatchOperations(operations) {
    if (!operations || !Array.isArray(operations) || operations.length === 0) {
      throw new Error('Invalid operations array');
    }

    const firstOp = operations[0];
    const isConsistent = operations.every(op =>
      op.spreadsheetId === firstOp.spreadsheetId &&
      op.sheetName === firstOp.sheetName
    );

    if (!isConsistent) {
      throw new Error('All operations must have the same spreadsheetId and sheetName');
    }

    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .connectDataSource(firstOp.spreadsheetId, firstOp.sheetName, operations);
    });
  }


  function handleConnectionError(errorMessage, context) {
    console.error('Connection error details:', { errorMessage, context });

    let userMessage = 'ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
    let suggestions = [];

    if (context && context.validation && context.validation.details) {
      const validationDetails = context.validation.details;


      if (validationDetails.connectionVerified === false) {
        userMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”å…ˆã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        suggestions.push('ãƒ•ã‚©ãƒ¼ãƒ ã®ç·¨é›†æ¨©é™ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        suggestions.push('ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç·¨é›†è€…æ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');

        if (validationDetails.connectionError) {
          suggestions.push(`è©³ç´°: ${validationDetails.connectionError}`);
        }
      }

      if (validationDetails.formInfoVerified === false) {
        userMessage += ' ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã®å–å¾—ã«ã‚‚å¤±æ•—ã—ã¾ã—ãŸã€‚';
        suggestions.push('ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®é€£æºã‚’ç¢ºèªã—ã¦ãã ã•ã„');

        if (validationDetails.formInfoError) {
          suggestions.push(`ãƒ•ã‚©ãƒ¼ãƒ è©³ç´°: ${validationDetails.formInfoError}`);
        }
      }

      if (validationDetails.formUrlMatches === false && validationDetails.detectedFormUrl) {
        userMessage += ' å…¥åŠ›URLã¨ã‚·ã‚¹ãƒ†ãƒ æ¤œå‡ºURLãŒç•°ãªã‚Šã¾ã™ã€‚';
        suggestions.push(`æ¤œå‡ºã•ã‚ŒãŸURL: ${validationDetails.detectedFormUrl}`);
        suggestions.push('æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒ URLã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
      }
    } else {
      if (errorMessage.includes('Permission') || errorMessage.includes('æ¨©é™')) {
        suggestions.push('ãƒ•ã‚©ãƒ¼ãƒ ã®ç·¨é›†æ¨©é™ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        suggestions.push('å›ç­”å…ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
      } else if (errorMessage.includes('not found') || errorMessage.includes('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
        suggestions.push('æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ ã¾ãŸã¯å›ç­”ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
        suggestions.push('ã‚·ãƒ¼ãƒˆåãŒæ­£ç¢ºã‹ç¢ºèªã—ã¦ãã ã•ã„');
      } else if (errorMessage.includes('timeout') || errorMessage.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
        suggestions.push('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        suggestions.push('ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„');
      } else {
        suggestions.push('ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        suggestions.push('æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™');
      }
    }

    const fullMessage =
      userMessage + '\n\næ¨å¥¨å¯¾å‡¦æ³•:\n' + suggestions.map((s) => 'â€¢ ' + s).join('\n');
    showError(fullMessage);

    showInfo('ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ä½¿ç”¨ã—ã¦æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã§ãã¾ã™ã€‚');
  }


  function updateProgress(step) {
    const steps = document.querySelectorAll('.step');
    steps.forEach((stepEl, index) => {
      stepEl.classList.remove('completed', 'current');
      if (index < step - 1) {
        stepEl.classList.add('completed');
      } else if (index === step - 1) {
        stepEl.classList.add('current');
      }
    });
  }

  function updateColumnMapping(result) {

    if (!result || !result.success) {
      console.warn('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°çµæœãŒä¸æ­£ã§ã™');
      showError('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      return;
    }

    const mapping = result.mapping || {};
    const confidence = result.confidence || {};
    const headers = result.headers || [];


    fillColumnDropdowns(headers, mapping, confidence);
    try {
      window.currentHeaders = headers;
    } catch (_) { }

    displayAIDetectionInfo(mapping, confidence);


    showSuccess('åˆ—è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  }

  function fillColumnDropdowns(headers, mapping, confidence = {}) {

    try {
      if (!Array.isArray(headers) || headers.length === 0) {
        console.warn('âš ï¸ ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ãŒä¸æ­£ã§ã™');
        return;
      }

      if (!mapping || typeof mapping !== 'object') {
        mapping = {};
      }
      if (!confidence || typeof confidence !== 'object') {
        confidence = {};
      }

      const dropdowns = {
        answer: document.getElementById('answer-column-select'),
        reason: document.getElementById('reason-column-select'),
        class: document.getElementById('class-column-select'),
        name: document.getElementById('name-column-select'),
      };

      const missingDropdowns = Object.keys(dropdowns).filter((key) => !dropdowns[key]);
      if (missingDropdowns.length > 0) {
        console.warn('ä¸€éƒ¨ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', missingDropdowns);
      }

      Object.keys(dropdowns).forEach((columnType) => {
        const dropdown = dropdowns[columnType];
        if (!dropdown) {
          console.warn(`${columnType}ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
          return;
        }

        try {
          dropdown.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„...</option>';

          headers.forEach((header, index) => {
            if (header && header.trim()) {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = `${String.fromCharCode(65 + index)}åˆ—: ${header}`;
              dropdown.appendChild(option);
            }
          });
        } catch (error) {
          console.error(`${columnType}ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è¨­å®šã‚¨ãƒ©ãƒ¼:`, error);
        }
      });

      setAIDetectionSelections(mapping, dropdowns, confidence, headers);

      setupDropdownEventListeners(dropdowns);
    } catch (error) {
      console.error('fillColumnDropdowns ã‚¨ãƒ©ãƒ¼:', error);
      showError('ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    }
  }


  /**
   * ã‚·ãƒ³ãƒ—ãƒ«ç«¶åˆãƒã‚§ãƒƒã‚¯
   * @param {Object} mapping - AIæ¤œå‡ºãƒãƒƒãƒ”ãƒ³ã‚°
   * @param {Object} dropdowns - ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¦ç´ 
   * @returns {boolean} ç«¶åˆãŒã‚ã‚‹ã‹ã©ã†ã‹
   */
  function checkSimpleConflicts(mapping, dropdowns) {
    if (!mapping || !dropdowns) return false;

    const actualMapping = mapping?.mapping || mapping || {};

    for (const fieldType of Object.keys(dropdowns)) {
      const dropdown = dropdowns[fieldType];
      if (!dropdown) continue;

      const hasAI = actualMapping[fieldType] !== undefined;
      const hasManual = dropdown.value && dropdown.value !== '';

      if (hasAI && hasManual && actualMapping[fieldType] !== parseInt(dropdown.value)) {
        return true;
      }
    }
    return false;
  }


  function setAIDetectionSelections(mapping, dropdowns, confidence = {}, headers = []) {

    const hasConflicts = checkSimpleConflicts(mapping, dropdowns);
    if (hasConflicts) {
      console.warn('âš ï¸ AIæ¤œå‡ºã¨æ‰‹å‹•è¨­å®šã®ç«¶åˆãŒã‚ã‚Šã¾ã™ - æ‰‹å‹•é¸æŠãŒå„ªå…ˆã•ã‚Œã¾ã™');
    }

    if (!mapping || typeof mapping !== 'object') {
      return;
    }

    const actualMapping = mapping || {};

    const mappingDetails = {
      hasMapping: Object.keys(actualMapping).length > 0,
      hasConfidence: Object.keys(confidence).length > 0,
      mappingKeys: Object.keys(actualMapping),
      confidenceKeys: Object.keys(confidence),
      mappingContent: actualMapping,
      confidenceContent: confidence
    };

    const hasValidMapping = actualMapping && Object.keys(actualMapping).length > 0;
    const hasConfidenceData = confidence && Object.keys(confidence).length > 0;

    if (!hasValidMapping && !hasConfidenceData) {
      return;
    }

    if (!hasValidMapping && hasConfidenceData) {

    }

    window.currentAIMapping = mapping;

    const mappingKeys = {
      answer: ['answer'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: answer ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      reason: ['reason'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: reason ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      class: ['class'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: class ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      name: ['name'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: name ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

      timestamp: ['timestamp'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: timestamp ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      email: ['email'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: email ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

      understand: ['understand'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: understand ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      like: ['like'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: like ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      curious: ['curious'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: curious ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

      highlight: ['HIGHLIGHT'] // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: HIGHLIGHT ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    };

    let detectedCount = 0;
    let totalConfidenceInfo = [];

    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;

      let selectedIndex = null;
      let columnConfidence = 0;

      mappingKeys[columnType].forEach((key) => {
        if (actualMapping[key] !== null && actualMapping[key] !== undefined) {
          selectedIndex = actualMapping[key];
        }
        if (confidence && confidence[key] !== undefined) {
          columnConfidence = confidence[key];
        }
      });

      if (columnConfidence > 0) {
        totalConfidenceInfo.push(`${columnType}: ${columnConfidence}%`);
      }

      if (selectedIndex !== null) {
        dropdown.value = selectedIndex;
        dropdown.classList.add('has-ai-selection');

        showConfidenceBadge(columnType, columnConfidence, 'ai');


        detectedCount++;
      } else if (columnConfidence > 0) {
        const HIGH_PRECISION_THRESHOLDS = {
          answer: 75,   // è¤‡é›‘è³ªå•æ–‡ - ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œ
          reason: 70,   // ç†ç”±èª¬æ˜æ–‡ - ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯å¼·åŒ–
          name: 80,     // å˜ç´”è­˜åˆ¥å­ - é«˜ç²¾åº¦æœŸå¾…
          class: 85,    // æ˜ç¢ºãƒ‘ã‚¿ãƒ¼ãƒ³ - æœ€é«˜ç²¾åº¦æœŸå¾…
          email: 90     // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå›ºå®š - å®Œå…¨ä¸€è‡´æœŸå¾…
        };
        const threshold = HIGH_PRECISION_THRESHOLDS[columnType] || 75;

        let badgeType = 'low-confidence';
        let statusMessage = '';

        if (columnConfidence >= threshold) {
          badgeType = 'candidate';
          statusMessage = `å€™è£œ (é–¾å€¤${threshold}%é”æˆ)`;
        } else if (columnConfidence >= 50) {
          badgeType = 'fallback-candidate';
          statusMessage = `è¦ç¢ºèªå€™è£œ (${Math.round(columnConfidence)}% - é–¾å€¤${threshold}%æœªæº€)`;

          attemptFallbackDetection(columnType, dropdown, headers, actualMapping, confidence);
        } else if (columnConfidence >= 30) {
          badgeType = 'low-confidence';
          statusMessage = `æ¤œè¨å€™è£œ (${Math.round(columnConfidence)}% - æ‰‹å‹•ç¢ºèªæ¨å¥¨)`;

          provideLowConfidenceGuidance(columnType, dropdown);
        } else {
          badgeType = 'very-low';
          statusMessage = `ä¿¡é ¼åº¦ä¸è¶³ (${Math.round(columnConfidence)}% - æ‰‹å‹•è¨­å®šã‚’æ¨å¥¨)`;

          attemptAlternativeDetection(columnType, dropdown, headers);
        }


        showConfidenceBadge(columnType, columnConfidence, badgeType);
      }
    });

    if (detectedCount > 0) {
      const maxConfidence = Math.max(...Object.values(confidence));


    } else if (totalConfidenceInfo.length > 0) {
      const maxConfidence = Math.max(...Object.values(confidence));
      const avgConfidence = Object.values(confidence).reduce((a, b) => a + b, 0) / Object.values(confidence).length;


    }

    const aiInfo = document.getElementById('ai-detection-info');
    if (aiInfo) {
      aiInfo.classList.remove('hidden');
    }

    updateCompletionStatus();
  }


  /**
   * ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œå‡ºè©¦è¡Œ
   */
  function attemptFallbackDetection(columnType, dropdown, headers, mapping, confidence) {
    try {

      const alternativePatterns = {
        answer: ['å›ç­”', 'ç­”ãˆ', 'answer', 'æ„è¦‹', 'è€ƒãˆ', 'ã‚³ãƒ¡ãƒ³ãƒˆ'],
        reason: ['ç†ç”±', 'reason', 'æ ¹æ‹ ', 'èª¬æ˜', 'ãªãœ', 'ã©ã†ã—ã¦'],
        name: ['åå‰', 'name', 'æ°å', 'ãŠåå‰', 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ '],
        class: ['ã‚¯ãƒ©ã‚¹', 'class', 'çµ„', 'å­¦å¹´', 'ã‚°ãƒ¬ãƒ¼ãƒ‰']
      };

      const patterns = alternativePatterns[columnType] || [];
      let bestCandidate = null;
      let bestScore = 0;

      headers.forEach((header, index) => {
        if (!header) return;

        const normalizedHeader = header.toLowerCase();
        let score = 0;

        patterns.forEach(pattern => {
          if (normalizedHeader.includes(pattern.toLowerCase())) {
            score += 25;
          }
        });

        if (columnType === 'answer' && index < 3) score += 10;
        if (columnType === 'reason' && index >= 2 && index < 5) score += 10;
        if (columnType === 'name' && index >= headers.length - 3) score += 15;
        if (columnType === 'class' && index >= headers.length - 3) score += 15;

        if (score > bestScore) {
          bestScore = score;
          bestCandidate = index;
        }
      });

      if (bestCandidate !== null && bestScore >= 25) {

        const option = dropdown.querySelector(`option[value="${bestCandidate}"]`);
        if (option) {
          option.textContent = `ğŸ” ${option.textContent} (AIå€™è£œ)`;
          option.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
          option.style.fontWeight = 'bold';
        }

        showFallbackCandidateInfo(columnType, bestCandidate, bestScore, headers[bestCandidate]);
      }

    } catch (error) {
      console.error(`ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œå‡ºã‚¨ãƒ©ãƒ¼ (${columnType}):`, error);
    }
  }

  /**
   * ğŸ’¡ ä½ä¿¡é ¼åº¦æ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
   */
  function provideLowConfidenceGuidance(columnType, dropdown) {
    const guidanceMessages = {
      answer: 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ: è³ªå•ã«å¯¾ã™ã‚‹å­¦ç¿’è€…ã®å›ç­”ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹åˆ—ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚é€šå¸¸ã€æœ€ã‚‚é•·ã„æ–‡ç« ãŒå«ã¾ã‚Œã‚‹åˆ—ã§ã™ã€‚',
      reason: 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ: å›ç­”ã®ç†ç”±ã‚„èª¬æ˜ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹åˆ—ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚ã€Œãªãœã€ã€Œç†ç”±ã€ã¨ã„ã†è¨€è‘‰ã‚’å«ã‚€åˆ—åã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
      name: 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ: å›ç­”è€…ã®åå‰ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹åˆ—ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚é€šå¸¸ã€è¡¨ã®å³å´ã«ã‚ã‚‹çŸ­ã„ãƒ†ã‚­ã‚¹ãƒˆã®åˆ—ã§ã™ã€‚',
      class: 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ã‚¯ãƒ©ã‚¹ã‚„å­¦å¹´æƒ…å ±ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹åˆ—ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚ã€Œ3-Aã€ã€Œ1å¹´1çµ„ã€ã®ã‚ˆã†ãªå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€åˆ—ã§ã™ã€‚'
    };

    const message = guidanceMessages[columnType];
    if (message) {
      let guidanceEl = document.getElementById(`${columnType}-guidance`);
      if (!guidanceEl) {
        guidanceEl = document.createElement('div');
        guidanceEl.id = `${columnType}-guidance`;
        guidanceEl.className = 'text-xs text-blue-300 mt-1 p-2 bg-blue-500/10 rounded border-l-2 border-blue-400';
        dropdown.parentNode.appendChild(guidanceEl);
      }
      guidanceEl.textContent = message;

      const createPromiseDelay = (ms) => new Promise(resolve => {
        const start = Date.now();
        const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
        check();
      });

      createPromiseDelay(8000).then(() => {
        if (guidanceEl && guidanceEl.parentNode) {
          guidanceEl.parentNode.removeChild(guidanceEl);
        }
      }).catch(() => {
      });
    }
  }

  /**
   * ğŸ” ä»£æ›¿æ¤œå‡ºæ‰‹æ³•ã®è©¦è¡Œ
   */
  function attemptAlternativeDetection(columnType, dropdown, headers) {

    const candidates = [];

    headers.forEach((header, index) => {
      if (!header) return;

      let score = 0;
      const headerLower = header.toLowerCase();

      switch (columnType) {
        case 'answer':
          if (header.length > 20) score += 20; // é•·ã„åˆ—å = è³ªå•æ–‡ã®å¯èƒ½æ€§
          if (headerLower.includes('ï¼Ÿ') || headerLower.includes('?')) score += 30;
          break;
        case 'reason':
          if (headerLower.includes('ç†') || headerLower.includes('èª¬æ˜')) score += 25;
          break;
        case 'name':
          if (header.length < 15 && header.length > 1) score += 15; // çŸ­ã„åˆ—å
          break;
        case 'class':
          if (header.length < 10 && header.length > 1) score += 15; // çŸ­ã„åˆ—å
          break;
      }

      if (score > 0) {
        candidates.push({ index, score, header });
      }
    });

    if (candidates.length > 0) {
      candidates.sort((a, b) => b.score - a.score);
      const bestCandidate = candidates[0];

      if (bestCandidate.score >= 15) {
        const option = dropdown.querySelector(`option[value="${bestCandidate.index}"]`);
        if (option) {
          option.textContent = `â“ ${option.textContent} (æ¨æ¸¬å€™è£œ)`;
          option.style.backgroundColor = 'rgba(245, 158, 11, 0.1)';
        }

      }
    }
  }

  /**
   * ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€™è£œæƒ…å ±è¡¨ç¤º
   */
  function showFallbackCandidateInfo(columnType, index, score, header) {
    const message = `ğŸ” AIåˆ†æ: ${String.fromCharCode(65 + index)}åˆ—ã€Œ${header}ã€ãŒ${columnType}ã®å€™è£œã¨ã—ã¦æ¤œå‡ºã•ã‚Œã¾ã—ãŸ (ä¿¡é ¼åº¦: ${score}/100)`;
    showInfo(message, 5000);
  }


  /**
   * ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®åˆ—åˆ¤å®šçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
   */
  function runIntegratedColumnTest() {
    if (!ClientMutex.acquire('runIntegratedColumnTest')) {
      showInfo('çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­ã§ã™â€¦');
      return;
    }

    try {


      const currentConfig = getConfig();
      const headers = window.currentHeaders || [];
      const columnMapping = currentConfig.columnMapping || {};

      if (!headers.length) {
        showError('çµ±åˆãƒ†ã‚¹ãƒˆã«ã¯å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶šãŒå¿…è¦ã§ã™');
        ClientMutex.release('runIntegratedColumnTest');
        return;
      }

      const sampleData = generateTestSampleData(headers);

      google.script.run
        .withSuccessHandler(function (diagnosticsResult) {

          displayIntegratedTestResults(diagnosticsResult);
          ClientMutex.release('runIntegratedColumnTest');
        })
        .withFailureHandler(function (error) {
          console.error('âŒ çµ±åˆè¨ºæ–­ã‚¨ãƒ©ãƒ¼:', error);
          showError('çµ±åˆè¨ºæ–­ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          ClientMutex.release('runIntegratedColumnTest');
        })
        .performIntegratedColumnDiagnostics(headers, columnMapping, sampleData);

      showInfo('åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆè¨ºæ–­ã‚’å®Ÿè¡Œä¸­â€¦', 3000);

    } catch (error) {
      console.error('runIntegratedColumnTest ã‚¨ãƒ©ãƒ¼:', error);
      showError('çµ±åˆãƒ†ã‚¹ãƒˆã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
      ClientMutex.release('runIntegratedColumnTest');
    }
  }

  /**
   * ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
   * @param {Array} headers - ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—
   * @returns {Array} ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
   */
  function generateTestSampleData(headers) {
    const sampleData = [];

    try {
      const testRow = Array(headers.length).fill(null);

      headers.forEach((header, index) => {
        const headerLower = String(header).toLowerCase();

        if (headerLower.includes('timestamp') || headerLower.includes('æ—¥æ™‚')) {
          testRow[index] = '2025/09/20 10:30:00';
        } else if (headerLower.includes('email') || headerLower.includes('ãƒ¡ãƒ¼ãƒ«')) {
          testRow[index] = 'test@example.com';
        } else if (headerLower.includes('answer') || headerLower.includes('å›ç­”')) {
          testRow[index] = 'ãƒ†ã‚¹ãƒˆå›ç­”ãƒ‡ãƒ¼ã‚¿';
        } else if (headerLower.includes('reason') || headerLower.includes('ç†ç”±')) {
          testRow[index] = 'ãƒ†ã‚¹ãƒˆç†ç”±ãƒ‡ãƒ¼ã‚¿';
        } else if (headerLower.includes('class') || headerLower.includes('ã‚¯ãƒ©ã‚¹')) {
          testRow[index] = '1å¹´Açµ„';
        } else if (headerLower.includes('name') || headerLower.includes('åå‰')) {
          testRow[index] = 'ãƒ†ã‚¹ãƒˆå¤ªéƒ';
        } else {
          testRow[index] = `ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿${index + 1}`;
        }
      });

      sampleData.push(testRow);


      return sampleData;

    } catch (error) {
      console.error('generateTestSampleData ã‚¨ãƒ©ãƒ¼:', error);
      return [[]];
    }
  }

  /**
   * çµ±åˆãƒ†ã‚¹ãƒˆçµæœã®è¡¨ç¤º
   * @param {Object} diagnostics - è¨ºæ–­çµæœ
   */
  function displayIntegratedTestResults(diagnostics) {
    try {


      let resultsPanel = document.getElementById('integrated-test-results');
      if (!resultsPanel) {
        resultsPanel = createIntegratedTestResultsPanel();
      }

      const resultsHTML = generateTestResultsHTML(diagnostics);
      resultsPanel.innerHTML = resultsHTML;

      resultsPanel.classList.remove('hidden');

      if (diagnostics.summary.overallScore >= 90) {
        showSuccess(`åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼å®Œäº†ï¼ç·åˆã‚¹ã‚³ã‚¢: ${diagnostics.summary.overallScore}%`);
      } else if (diagnostics.summary.overallScore >= 70) {
        showInfo(`åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã«æ”¹å–„ä½™åœ°ã‚ã‚Šã€‚ç·åˆã‚¹ã‚³ã‚¢: ${diagnostics.summary.overallScore}%`);
      } else {
        showError(`åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç·åˆã‚¹ã‚³ã‚¢: ${diagnostics.summary.overallScore}%`);
      }

      if (diagnostics.recommendations.length > 0) {
        const criticalRecs = diagnostics.recommendations.filter(r => r.priority === 'critical');
        if (criticalRecs.length > 0) {
          showError(`é‡è¦: ${criticalRecs[0].message}`);
        }
      }

    } catch (error) {
      console.error('displayIntegratedTestResults ã‚¨ãƒ©ãƒ¼:', error);
      showError('ãƒ†ã‚¹ãƒˆçµæœã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  /**
   * çµ±åˆãƒ†ã‚¹ãƒˆçµæœãƒ‘ãƒãƒ«ã®ä½œæˆ
   * @returns {HTMLElement} çµæœãƒ‘ãƒãƒ«è¦ç´ 
   */
  function createIntegratedTestResultsPanel() {
    const panel = document.createElement('div');
    panel.id = 'integrated-test-results';
    panel.className = 'hidden mt-6 p-4 bg-gray-900/50 border border-gray-600 rounded-lg';

    const insertAfter = document.getElementById('ai-detection-info') ||
      document.querySelector('section[data-section="column-mapping"]') ||
      document.querySelector('.column-mapping-section');

    if (insertAfter && insertAfter.parentNode) {
      insertAfter.parentNode.insertBefore(panel, insertAfter.nextSibling);
    } else {
      document.body.appendChild(panel);
    }

    return panel;
  }

  /**
   * ãƒ†ã‚¹ãƒˆçµæœHTMLç”Ÿæˆ
   * @param {Object} diagnostics - è¨ºæ–­çµæœ
   * @returns {string} ç”Ÿæˆã•ã‚ŒãŸHTML
   */
  function generateTestResultsHTML(diagnostics) {
    const overallScore = diagnostics.summary.overallScore;
    const scoreColor = overallScore >= 90 ? 'green' : overallScore >= 70 ? 'yellow' : 'red';

    let html = `
      <div class="mb-4">
        <h3 class="text-lg font-semibold text-white mb-2">ğŸ” åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ çµ±åˆè¨ºæ–­çµæœ</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="bg-gray-800 p-3 rounded">
            <div class="text-sm text-gray-400">ç·åˆã‚¹ã‚³ã‚¢</div>
            <div class="text-xl font-bold text-${scoreColor}-400">${overallScore}%</div>
          </div>
          <div class="bg-gray-800 p-3 rounded">
            <div class="text-sm text-gray-400">é‡å¤§ãªå•é¡Œ</div>
            <div class="text-xl font-bold text-red-400">${diagnostics.summary.criticalIssues || 0}ä»¶</div>
          </div>
          <div class="bg-gray-800 p-3 rounded">
            <div class="text-sm text-gray-400">è­¦å‘Š</div>
            <div class="text-xl font-bold text-yellow-400">${diagnostics.summary.warnings || 0}ä»¶</div>
          </div>
        </div>
      </div>
    `;

    if (diagnostics.systemHealth) {
      html += generateSystemHealthHTML(diagnostics.systemHealth);
    }

    if (diagnostics.columnTests) {
      html += generateFieldTestsHTML(diagnostics.columnTests);
    }

    if (diagnostics.recommendations && diagnostics.recommendations.length > 0) {
      html += generateRecommendationsHTML(diagnostics.recommendations);
    }

    html += `
      <div class="text-xs text-gray-500 mt-4">
        è¨ºæ–­å®Ÿè¡Œæ™‚åˆ»: ${new Date(diagnostics.timestamp).toLocaleString()}
      </div>
    `;

    return html;
  }

  /**
   * ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§HTMLç”Ÿæˆ
   * @param {Object} systemHealth - ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§ãƒ‡ãƒ¼ã‚¿
   * @returns {string} HTML
   */
  function generateSystemHealthHTML(systemHealth) {
    const safeBackendStatus = window.sharedUtilities.security.escapeHtml(systemHealth.backend.status || '');
    const safeFrontendStatus = window.sharedUtilities.security.escapeHtml(systemHealth.frontend.status || '');
    const safeIntegrationStatus = window.sharedUtilities.security.escapeHtml(systemHealth.integration.status || '');

    return `
      <div class="mb-4">
        <h4 class="font-medium text-white mb-2">ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
          <div class="flex justify-between p-2 bg-gray-800 rounded">
            <span>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:</span>
            <span class="text-${getStatusColor(systemHealth.backend.status)}-400">
              ${Number(systemHealth.backend.score) || 0}% (${safeBackendStatus})
            </span>
          </div>
          <div class="flex justify-between p-2 bg-gray-800 rounded">
            <span>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:</span>
            <span class="text-${getStatusColor(systemHealth.frontend.status)}-400">
              ${Number(systemHealth.frontend.score) || 0}% (${safeFrontendStatus})
            </span>
          </div>
          <div class="flex justify-between p-2 bg-gray-800 rounded">
            <span>çµ±åˆ:</span>
            <span class="text-${getStatusColor(systemHealth.integration.status)}-400">
              ${Number(systemHealth.integration.score) || 0}% (${safeIntegrationStatus})
            </span>
          </div>
        </div>
      </div>
    `;
  }

  /**
   * ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆHTMLç”Ÿæˆ
   * @param {Object} columnTests - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆçµæœ
   * @returns {string} HTML
   */
  function generateFieldTestsHTML(columnTests) {
    let html = `
      <div class="mb-4">
        <h4 class="font-medium text-white mb-2">ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ¥ãƒ†ã‚¹ãƒˆçµæœ</h4>
        <div class="space-y-1 text-sm">
    `;

    Object.entries(columnTests).forEach(([field, test]) => {
      const statusIcon = test.resolved ? 'âœ…' : 'âŒ';
      const severityColor = test.severity === 'critical' ? 'red' : test.severity === 'warning' ? 'yellow' : 'green';
      const safeField = window.sharedUtilities.security.escapeHtml(field);
      const safeConfidence = Number(test.confidence) || 0;
      const safeMethod = window.sharedUtilities.security.escapeHtml(test.method || '');

      html += `
        <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
          <span>${statusIcon} ${safeField}</span>
          <span class="text-${severityColor}-400">
            ${test.resolved ? `${safeConfidence}% (${safeMethod})` : 'Not Resolved'}
          </span>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;

    return html;
  }

  /**
   * æ¨å¥¨äº‹é …HTMLç”Ÿæˆ
   * @param {Array} recommendations - æ¨å¥¨äº‹é …
   * @returns {string} HTML
   */
  function generateRecommendationsHTML(recommendations) {
    let html = `
      <div class="mb-4">
        <h4 class="font-medium text-white mb-2">æ¨å¥¨äº‹é …</h4>
        <div class="space-y-2 text-sm">
    `;

    recommendations.forEach(rec => {
      const priorityColor = rec.priority === 'critical' ? 'red' : rec.priority === 'high' ? 'orange' : 'yellow';
      const safePriority = window.sharedUtilities.security.escapeHtml(String(rec.priority || '').toUpperCase());
      const safeMessage = window.sharedUtilities.security.escapeHtml(rec.message || '');
      html += `
        <div class="p-2 bg-gray-800 rounded">
          <div class="text-${priorityColor}-400 font-medium">${safePriority}</div>
          <div class="text-gray-300">${safeMessage}</div>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;

    return html;
  }

  /**
   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¯¾å¿œã™ã‚‹è‰²ã‚’å–å¾—
   * @param {string} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
   * @returns {string} è‰²å
   */
  function getStatusColor(status) {
    switch (status) {
      case 'healthy': return 'green';
      case 'warning': return 'yellow';
      case 'critical': return 'red';
      case 'error': return 'red';
      default: return 'gray';
    }
  }




  function setupDropdownEventListeners(dropdowns) {
    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;

      dropdown.addEventListener('change', function () {
        handleDropdownChange(columnType, this);
      });
    });

    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.addEventListener('click', function () {
        resetToAIDetection();
      });
    }
  }

  function handleDropdownChange(columnType, dropdown) {
    const selectedValue = dropdown.value;

    dropdown.classList.remove('has-ai-selection', 'has-manual-selection');

    if (selectedValue === '') {
      hideConfidenceBadge(columnType);
    } else {
      dropdown.classList.add('has-manual-selection');
      showConfidenceBadge(columnType, 100, 'manual');

      const resetButton = document.getElementById('reset-to-ai');
      if (resetButton) {
        resetButton.style.display = 'inline-block';
      }

      const manualInfo = document.getElementById('manual-override-info');
      if (manualInfo) {
        manualInfo.classList.remove('hidden');
      }
    }

    updateSelectionStatus();

    updateCompletionStatus();

    const currentMapping = getColumnMapping();
    if (Object.keys(currentMapping).length > 0) {
      updateSystemState({
        columnMapping: currentMapping,
        setupStatus: 'completed'
      });
    }
  }

  const AI_CONFIDENCE_THRESHOLDS = {
    answer: 45,              // å¿…é ˆåˆ—: é–¾å€¤ã‚’ä¸‹ã’ã¦è¨­å®šã—ã‚„ã™ã
    reason: 60,              // ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆ—: å“è³ªç¶­æŒã®ãŸã‚é–¾å€¤ä¸Šã’
    name: 65, class: 65      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆ—: æ˜ç¢ºãªåˆ—ç¨®åˆ¥
  };

  function showConfidenceBadge(columnType, confidence, type) {
    if (!columnType || typeof confidence !== 'number' || !type) {
      console.warn('showConfidenceBadge: ä¸æ­£ãªå¼•æ•°', { columnType, confidence, type });
      return;
    }

    const confidenceDiv = document.getElementById(`${columnType}-confidence`);
    if (!confidenceDiv) {
      console.warn(`showConfidenceBadge: è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ${columnType}-confidence`);
      return;
    }

    const badge = confidenceDiv.querySelector('.confidence-badge');
    if (!badge) {
      console.warn(`showConfidenceBadge: ãƒãƒƒã‚¸è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ${columnType}`);
      return;
    }

    let badgeClass = '';
    let badgeText = '';

    switch (type) {
      case 'manual':
        badgeClass = 'manual';
        badgeText = 'âœ‹ æ‰‹å‹•è¨­å®š';
        break;
      case 'ai':
        badgeClass = 'high';
        badgeText = `ğŸ¯ AIåˆ¤å®š ${Math.round(confidence)}%`;
        break;
      case 'candidate':
        badgeClass = 'candidate';
        badgeText = `ğŸ” å€™è£œ ${Math.round(confidence)}%`;
        break;
      case 'low-confidence':
        badgeClass = 'low';
        badgeText = `ğŸ“Š æ¤œè¨ä¸­ ${Math.round(confidence)}%`;
        break;
      default:
        const threshold = AI_CONFIDENCE_THRESHOLDS[columnType] || 55;
        const roundedConfidence = Math.round(confidence);

        if (confidence >= threshold) {
          badgeClass = 'high';
          badgeText = `ğŸ¤– AIæ¤œå‡º ${roundedConfidence}%`;
        } else if (confidence >= Math.max(threshold * 0.7, 20)) {
          badgeClass = 'medium';
          badgeText = `ğŸ¤– AIæ¤œå‡º ${roundedConfidence}%`;
        } else {
          badgeClass = 'low';
          badgeText = `ğŸ¤– AIæ¤œå‡º ${roundedConfidence}%`;
        }
        break;
    }

    badge.className = `confidence-badge ${badgeClass}`;
    badge.textContent = badgeText;
    confidenceDiv.classList.remove('hidden');
  }

  function hideConfidenceBadge(columnType) {
    const confidenceDiv = document.getElementById(`${columnType}-confidence`);
    if (confidenceDiv) {
      confidenceDiv.classList.add('hidden');
    }
  }

  function displayAIDetectionInfo(mapping, confidence = {}) {
    const detailsDiv = document.getElementById('ai-detection-details');
    if (!detailsDiv) return;

    if (!mapping || typeof mapping !== 'object') {
      detailsDiv.innerHTML = '<div class="text-gray-400 text-sm">AIæ¤œå‡ºçµæœãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    const details = [];
    const columnNames = {
      answerer: 'å›ç­”åˆ—',
      reason: 'ç†ç”±åˆ—',
      class: 'ã‚¯ãƒ©ã‚¹åˆ—',
      name: 'åå‰åˆ—',
    };

    const actualMapping = mapping.mapping || {};
    Object.keys(columnNames).forEach((key) => {
      if (actualMapping[key] !== null && actualMapping[key] !== undefined) {
        const columnLabel = String.fromCharCode(65 + actualMapping[key]) + 'åˆ—';
        const columnConfidence = confidence[key] || 0;
        details.push(`${columnNames[key]}: ${columnLabel} (ä¿¡é ¼åº¦: ${Math.round(columnConfidence)}%)`);
      }
    });

    detailsDiv.innerHTML = '';
    details.forEach(detail => {
      const div = document.createElement('div');
      div.textContent = `â€¢ ${detail}`;
      detailsDiv.appendChild(div);
    });
  }

  function updateSelectionStatus() {
    const hasManualSelection =
      document.querySelectorAll('.modern-select.has-manual-selection').length > 0;
    const hasAISelection = document.querySelectorAll('.modern-select.has-ai-selection').length > 0;


    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.style.display = hasManualSelection ? 'inline-block' : 'none';
    }
  }

  function resetToAIDetection() {

    if (!window.currentAIMapping) {
      showError('AIæ¤œå‡ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    const dropdowns = {
      answer: document.getElementById('answer-column-select'),
      reason: document.getElementById('reason-column-select'),
      class: document.getElementById('class-column-select'),
      name: document.getElementById('name-column-select'),
    };

    setAIDetectionSelections(window.currentAIMapping, dropdowns, {}, window.currentHeaders || []);

    const manualInfo = document.getElementById('manual-override-info');
    if (manualInfo) {
      manualInfo.classList.add('hidden');
    }

    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.style.display = 'none';
    }

    showSuccess('AIæ¤œå‡ºçµæœã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  }

  function verifyColumnMapping() {
    if (!ClientMutex.acquire('verifyColumnMapping')) {
      showInfo('æ¤œè¨¼å‡¦ç†ã‚’å®Ÿè¡Œä¸­ã§ã™â€¦');
      return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼ã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
    const spreadsheetId = getCurrentSpreadsheetId();
    const sheetName = getCurrentSheetName();

    if (!spreadsheetId || !sheetName) {
      showError('æ¤œè¨¼ã™ã‚‹ã«ã¯ã¾ãšã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ¥ç¶šã—ã¦ãã ã•ã„');
      ClientMutex.release('verifyColumnMapping');
      return;
    }

    window.setLoading(true, 'å‡¦ç†ä¸­...');


    let headers = Array.isArray(window.currentHeaders) ? window.currentHeaders : [];
    if (!headers.length) {
      const options = document.querySelectorAll('#answer-column-select option');
      headers = Array.from(options)
        .map((opt) => {
          const txt = opt.textContent || '';
          const parts = txt.split(': ');
          return parts.length > 1 ? parts.slice(1).join(': ') : '';
        })
        .filter(Boolean);
    }

    const columnMapping = getColumnMapping();

    const confidence = {};
    ['answer', 'reason', 'class', 'name'].forEach((key) => {
      if (typeof columnMapping[key] === 'number') {
        const confidenceElement = document.getElementById(key + '-confidence');
        if (confidenceElement && !confidenceElement.classList.contains('hidden')) {
          const badge = confidenceElement.querySelector('.confidence-badge');
          if (badge) {
            const confidenceText = badge.textContent;
            const match = confidenceText.match(/(\d+)%/);
            if (match) {
              confidence[key] = parseInt(match[1]);
            }
          }
        }
      }
    });

    displayVerificationResults({ ok: true });

    const currentMapping = getColumnMapping();
    updateSystemState({
      spreadsheetId,
      sheetName,
      columnMapping: currentMapping,
      setupStatus: 'completed'
    });

    showSuccess('âœ… åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æ¤œè¨¼å®Œäº†');
    window.setLoading(false);
    ClientMutex.release('verifyColumnMapping');
  }

  function displayVerificationResults(headerIndices) {

    const requiredColumns = ['answer']; // å¿…é ˆåˆ—
    const optionalColumns = ['reason', 'class', 'name']; // ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆ—
    const allColumns = [...requiredColumns, ...optionalColumns];
    let badgesAdded = 0;

    const badgeElements = [];

    allColumns.forEach(columnType => {
      const dropdown = document.getElementById(`${columnType}-column-select`);
      const confidenceDiv = document.getElementById(`${columnType}-confidence`);

      if (!dropdown || dropdown.value === '') {
        return;
      }

      const existingBadge = dropdown.parentElement.querySelector('.verification-badge');
      if (existingBadge) {
        existingBadge.remove();
      }

      const verifiedBadge = document.createElement('span');
      verifiedBadge.className = 'verification-badge status-badge published';
      verifiedBadge.textContent = 'âœ“ æ¤œè¨¼æ¸ˆã¿';

      badgeElements.push({
        badge: verifiedBadge,
        container: confidenceDiv || dropdown.parentElement,
        columnType
      });
    });

    badgeElements.forEach(({ badge, container, columnType }) => {
      try {
        container.appendChild(badge);
        badgesAdded++;

      } catch (error) {
        console.warn(`æ¤œè¨¼ãƒãƒƒã‚¸è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${columnType}`, error);
      }
    });

    const sectionHeaders = document.querySelectorAll('section h2');
    let mappingSection = null;

    sectionHeaders.forEach(header => {
      const headerText = header.textContent || '';
      if (headerText.includes('AIåˆ—ãƒãƒƒãƒ”ãƒ³ã‚°') || headerText.includes('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°')) {
        mappingSection = header.closest('section');
      }
    });

    if (mappingSection) {
      const existingMark = mappingSection.querySelector('.section-verified-mark');
      if (existingMark) {
        existingMark.remove();
      }

      const sectionMark = document.createElement('div');
      sectionMark.className = 'section-verified-mark';
      sectionMark.innerHTML = `
        <div class="flex items-center gap-2 mt-4 p-3 bg-green-900/20 border border-green-500/30 rounded-lg">
          <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span class="text-green-400 font-medium">åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ</span>
        </div>
      `;

      const actionButtons = mappingSection.querySelector('.action-buttons');
      if (actionButtons) {
        actionButtons.parentElement.insertBefore(sectionMark, actionButtons);
      } else {
        mappingSection.appendChild(sectionMark);
      }
    }


  }


  /**
   * åˆ—è¨­å®šãƒ‡ãƒ¼ã‚¿ã®åŒ…æ‹¬çš„æ¤œè¨¼
   * @param {string} spreadsheetId - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
   * @param {string} sheetName - ã‚·ãƒ¼ãƒˆå
   * @param {Array} headers - ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—
   * @param {Object} columnMapping - åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«æ§‹é€ ï¼‰
   * @param {Object} confidence - ä¿¡é ¼åº¦ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   * @returns {Object} æ¤œè¨¼çµæœ
   */
  function validateColumnConfig(spreadsheetId, sheetName, headers, columnMapping, confidence = {}) {
    const validation = {
      isValid: true,
      errors: [],
      warnings: [],
      recommendations: []
    };

    try {
      if (!spreadsheetId || typeof spreadsheetId !== 'string' || spreadsheetId.trim() === '') {
        validation.errors.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒç„¡åŠ¹ã§ã™');
        validation.isValid = false;
      }

      if (!sheetName || typeof sheetName !== 'string' || sheetName.trim() === '') {
        validation.errors.push('ã‚·ãƒ¼ãƒˆåãŒç„¡åŠ¹ã§ã™');
        validation.isValid = false;
      }

      if (!Array.isArray(headers) || headers.length === 0) {
        validation.errors.push('ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—ãŒç„¡åŠ¹ã¾ãŸã¯ç©ºã§ã™');
        validation.isValid = false;
      } else {
        const emptyHeaders = headers.filter((h, i) => !h || String(h).trim() === '');
        if (emptyHeaders.length > 0) {
          validation.warnings.push(`${emptyHeaders.length}å€‹ã®ç©ºãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚ã‚Šã¾ã™`);
        }
      }

      if (!columnMapping || typeof columnMapping !== 'object') {
        validation.errors.push('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ãŒç„¡åŠ¹ã§ã™');
        validation.isValid = false;
      } else {
        const mappingData = columnMapping; // âœ… ç›´æ¥ã‚·ãƒ³ãƒ—ãƒ«æ§‹é€ ä½¿ç”¨
        const confidenceData = confidence; // âœ… åˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—

        const requiredFields = ['answer'];
        const missingRequired = requiredFields.filter(field =>
          mappingData[field] === undefined || mappingData[field] === null || mappingData[field] < 0
        );

        if (missingRequired.length > 0) {
          validation.errors.push(`å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³: ${missingRequired.join(', ')}`);
          validation.isValid = false;
        }

        Object.keys(mappingData).forEach(field => {
          const index = mappingData[field];
          if (typeof index === 'number') {
            if (index < 0) {
              validation.errors.push(`${field}ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè² ã®å€¤ã§ã™`);
              validation.isValid = false;
            } else if (headers && index >= headers.length) {
              validation.errors.push(`${field}ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(${index})ãŒãƒ˜ãƒƒãƒ€ãƒ¼ç¯„å›²å¤–ã§ã™`);
              validation.isValid = false;
            }
          }
        });

        const lowConfidenceFields = Object.keys(confidenceData).filter(field =>
          confidenceData[field] < 30
        );
        if (lowConfidenceFields.length > 0) {
          validation.warnings.push(`ä½ä¿¡é ¼åº¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: ${lowConfidenceFields.join(', ')}`);
          validation.recommendations.push('ç®¡ç†ãƒ‘ãƒãƒ«ã§æ‰‹å‹•èª¿æ•´ã‚’æ¤œè¨ã—ã¦ãã ã•ã„');
        }

        const usedIndices = Object.values(mappingData).filter(v => typeof v === 'number' && v >= 0);
        const duplicateIndices = usedIndices.filter((index, i, arr) => arr.indexOf(index) !== i);
        if (duplicateIndices.length > 0) {
          validation.warnings.push(`é‡è¤‡åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${duplicateIndices.join(', ')}`);
          validation.recommendations.push('ç•°ãªã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒåŒã˜åˆ—ã‚’æŒ‡ã—ã¦ã„ã¾ã™');
        }
      }

      if (validation.isValid) {
        validation.qualityScore = calculateConfigScore(headers, columnMapping, confidence);
        if (validation.qualityScore < 70) {
          validation.warnings.push(`è¨­å®šå“è³ªã‚¹ã‚³ã‚¢: ${validation.qualityScore}% - æ”¹å–„ä½™åœ°ã‚ã‚Š`);
        }
      }

      return validation;

    } catch (error) {
      console.error('validateColumnConfigurationData ã‚¨ãƒ©ãƒ¼:', error);
      return {
        isValid: false,
        errors: ['æ¤œè¨¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'],
        error: error.message
      };
    }
  }

  /**
   * è¨­å®šå“è³ªã‚¹ã‚³ã‚¢ç®—å‡º - âœ… CLAUDE.mdæº–æ‹ : ã‚·ãƒ³ãƒ—ãƒ«æ§‹é€ å¯¾å¿œ
   * @param {Array} headers - ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—
   * @param {Object} columnMapping - åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«æ§‹é€ ï¼‰
   * @param {Object} confidence - ä¿¡é ¼åº¦ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   * @returns {number} å“è³ªã‚¹ã‚³ã‚¢ (0-100)
   */
  function calculateConfigScore(headers, columnMapping, confidence = {}) {
    let score = 0;
    const maxScore = 100;

    try {
      const mappingData = columnMapping; // âœ… ç›´æ¥ã‚·ãƒ³ãƒ—ãƒ«æ§‹é€ ä½¿ç”¨
      const confidenceData = confidence; // âœ… åˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—

      const requiredFields = ['answer']; // å¿…é ˆåˆ—: 30ç‚¹
      const optionalFields = ['reason', 'class', 'name']; // ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆ—: 10ç‚¹

      const requiredCompleted = requiredFields.filter(field =>
        mappingData[field] !== undefined && mappingData[field] !== null && mappingData[field] >= 0
      );
      score += (requiredCompleted.length / requiredFields.length) * 30;

      const optionalCompleted = optionalFields.filter(field =>
        mappingData[field] !== undefined && mappingData[field] !== null && mappingData[field] >= 0
      );
      score += (optionalCompleted.length / optionalFields.length) * 10;

      const avgConfidence = Object.values(confidenceData).length > 0
        ? Object.values(confidenceData).reduce((sum, conf) => sum + conf, 0) / Object.values(confidenceData).length
        : 50;
      score += (avgConfidence / 100) * 30;

      const headerQuality = headers ?
        headers.filter(h => h && String(h).trim() !== '').length / headers.length * 100 : 0;
      score += (headerQuality / 100) * 20;

      const usedIndices = Object.values(mappingData).filter(v => typeof v === 'number' && v >= 0);
      const uniqueness = usedIndices.length > 0 ?
        new Set(usedIndices).size / usedIndices.length * 100 : 100;
      score += (uniqueness / 100) * 10;

      return Math.round(Math.max(0, Math.min(maxScore, score)));

    } catch (error) {
      console.error('calculateConfigurationQualityScore ã‚¨ãƒ©ãƒ¼:', error);
      return 50; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚³ã‚¢
    }
  }

  /**
   * è¨­å®šä¿å­˜ã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹
   * @param {Object} config - ä¿å­˜ã™ã‚‹è¨­å®š
   * @param {number} maxRetries - æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°
   * @returns {Promise} ä¿å­˜çµæœ
   */
  function saveConfigWithRetry(config, maxRetries = 3) {
    return new Promise((resolve, reject) => {
      let attempt = 0;

      function attemptSave() {
        attempt++;

        google.script.run
          .withSuccessHandler(function (result) {
            if (result.success) {

              resolve(result);
            } else {
              console.warn(`âš ï¸ è¨­å®šä¿å­˜å¤±æ•— (è©¦è¡Œ ${attempt}):`, result.message || result.error);
              if (attempt < maxRetries) {
                const delay = Math.pow(2, attempt) * 1000;
                new Promise(resolve => {
                  const startTime = Date.now();
                  const checkTime = () => {
                    if (Date.now() - startTime >= delay) {
                      resolve();
                    } else {
                      requestAnimationFrame(checkTime);
                    }
                  };
                  checkTime();
                }).then(attemptSave);
              } else {
                reject(new Error(result.message || result.error || 'è¨­å®šä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'));
              }
            }
          })
          .withFailureHandler(function (error) {
            console.error(`âŒ è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼ (è©¦è¡Œ ${attempt}):`, error);
            if (attempt < maxRetries) {
              const delay = Math.pow(2, attempt) * 1000;
              new Promise(resolve => {
                const startTime = Date.now();
                const checkTime = () => {
                  if (Date.now() - startTime >= delay) {
                    resolve();
                  } else {
                    requestAnimationFrame(checkTime);
                  }
                };
                checkTime();
              }).then(attemptSave);
            } else {
              reject(error);
            }
          })
          .saveConfig(config);
      }

      attemptSave();
    });
  }


  function saveColumnConfig(spreadsheetId, sheetName, headers, columnMapping, confidence = {}) {
    if (!ClientMutex.acquire('saveColumnConfig')) {
      showInfo('åˆ—è¨­å®šã®ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œä¸­ã§ã™â€¦');
      return;
    }

    try {
      const validationResult = validateColumnConfig(spreadsheetId, sheetName, headers, columnMapping, confidence);
      if (!validationResult.isValid) {
        showError(`åˆ—è¨­å®šã®æ¤œè¨¼ã«å¤±æ•—: ${validationResult.errors.join(', ')}`);
        ClientMutex.release('saveColumnConfig');
        return;
      }

      const timestamp = new Date().toISOString();

      // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’datasetã‹ã‚‰å–å¾—
      const formInfo = getCurrentFormInfoSafe();

      const baseConfig = {
        spreadsheetId,
        sheetName,
        formUrl: formInfo.formUrl || null,
        formTitle: formInfo.formTitle || null,
        displaySettings: getDisplaySettings(),
        verifiedAt: timestamp, // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯åˆ¥é€”ç®¡ç†
        confidence: confidence, // ä¿¡é ¼åº¦ãƒ‡ãƒ¼ã‚¿ã¯åˆ¥é€”ç®¡ç†
        setupComplete: true,
        setupStatus: 'completed',
        etag: (systemState && systemState.config && systemState.config.etag) || undefined,
      };

      const optimizedConfig = systemState && systemState.config ? {
        ...baseConfig, // æ–°ã—ã„è¨­å®šã‚’åŸºæœ¬ã¨ã™ã‚‹
        userId: systemState.config.userId,
        setupStatus: systemState.config.setupStatus,
        isPublished: systemState.config.isPublished,
        publishedAt: systemState.config.publishedAt,
        displaySettings: getDisplaySettings(),
        spreadsheetId,
        sheetName,
        formUrl: formInfo.formUrl || null,
        formTitle: formInfo.formTitle || null,
        headers,
        columnMapping: {
          ...columnMapping,
          headers: headers,
          verifiedAt: timestamp // çµ±ä¸€ã•ã‚ŒãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
        }
      } : baseConfig;

      const isSpreadsheetChanged = systemState?.config?.spreadsheetId
        ? optimizedConfig.spreadsheetId !== systemState.config.spreadsheetId
        : true; // åˆå›è¨­å®šæ™‚ã¯å¸¸ã«æ–°è¦æ‰±ã„
      if (isSpreadsheetChanged) {
        optimizedConfig.sourceKey = 'sheet_' + optimizedConfig.spreadsheetId + '_' + Date.now();

        optimizedConfig.spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/' + optimizedConfig.spreadsheetId + '/edit';

        // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã¯æ—¢ã«datasetã‹ã‚‰å–å¾—æ¸ˆã¿ãªã®ã§ã€nullåŒ–ã—ãªã„
      }


      if (!optimizedConfig.formUrl) {


        google.script.run
          .withSuccessHandler(function (formResult) {
            if (formResult.success && formResult.formData && formResult.formData.formUrl) {
              optimizedConfig.formUrl = formResult.formData.formUrl;
              optimizedConfig.formTitle = formResult.formData.formTitle;
            } else {
            }
            executeConfigSave();
          })
          .withFailureHandler(function (error) {
            console.warn('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•æ¤œå‡ºã‚¨ãƒ©ãƒ¼ï¼ˆå®‰å…¨ã«ç¶™ç¶šï¼‰:', error.message);
            executeConfigSave();
          })
          .getFormInfo(spreadsheetId, sheetName);
        return;
      }

      executeConfigSave();

      function executeConfigSave() {
        const logData = {
          spreadsheetId: optimizedConfig.spreadsheetId,
          sheetName: optimizedConfig.sheetName,
          hasColumnMapping: !!optimizedConfig.columnMapping,
          setupComplete: optimizedConfig.setupComplete,
          configSize: JSON.stringify(optimizedConfig).length
        };

        if (optimizedConfig.sourceKey) logData.sourceKey = optimizedConfig.sourceKey;
        if (optimizedConfig.spreadsheetUrl) logData.spreadsheetUrl = optimizedConfig.spreadsheetUrl;
        if (optimizedConfig.formUrl) logData.formUrl = optimizedConfig.formUrl;
        if (optimizedConfig.formTitle) logData.formTitle = optimizedConfig.formTitle;


        google.script.run
          .withSuccessHandler(function (result) {
            if (result.success) {
              if (systemState && systemState.config) {
                systemState.config = {
                  ...systemState.config,
                  spreadsheetId: optimizedConfig.spreadsheetId,
                  sheetName: optimizedConfig.sheetName,
                  headers: optimizedConfig.headers,
                  columnMapping: optimizedConfig.columnMapping,
                  setupComplete: optimizedConfig.setupComplete,
                  lastModified: systemState.user?.lastModified || optimizedConfig.lastModified,
                  etag: result.etag || result.config?.etag || systemState.config?.etag
                };
              }

              updateResourceButtons(systemState.config);
              updateConfigSummary(systemState.config);
              showSuccess('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ');
            } else {
              if (result.error === 'etag_mismatch') {
                showInfo('è¨­å®šãŒä»–ã§æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚ç”»é¢ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                if (typeof loadAndApplyCurrentConfig === 'function') {
                  loadAndApplyCurrentConfig();
                }
              } else if (result.message || result.error) {
                console.warn('åˆ—è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', result.message || result.error);
              } else {
                console.warn('è¨­å®šä¿å­˜ã§äºˆæœŸã—ãªã„å¿œç­”:', result);
              }
            }
            ClientMutex.release('saveColumnConfig');
          })
          .withFailureHandler(function (error) {
            console.error('åˆ—è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            showError('åˆ—è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            ClientMutex.release('saveColumnConfig');
          })
          .saveConfig(optimizedConfig);
      }

    } catch (error) {
      console.error('åˆ—è¨­å®šä¿å­˜å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      showError('åˆ—è¨­å®šã®ä¿å­˜å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      ClientMutex.release('saveColumnConfig');
    }
  }

  function getValidatedConfig() {
    try {
      const config = getConfig();

      if (!config.spreadsheetId || !config.sheetName) {
        return {
          config: null,
          validationError: 'ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšãƒ•ã‚©ãƒ¼ãƒ ã‚’æ¥ç¶šã—ã¦ãã ã•ã„ã€‚'
        };
      }

      const columnMapping = getColumnMapping();
      if (!columnMapping.answer && columnMapping.answer !== 0) {
        return {
          config: null,
          validationError: 'å›ç­”åˆ—ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã§å›ç­”åˆ—ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚'
        };
      }

      let headers = Array.isArray(window.currentHeaders) ? window.currentHeaders : [];
      if (!headers.length) {
        const options = document.querySelectorAll('#answer-column-select option');
        headers = Array.from(options)
          .map((opt) => {
            const txt = opt.textContent || '';
            const parts = txt.split(': ');
            return parts.length > 1 ? parts.slice(1).join(': ') : '';
          })
          .filter(Boolean);
      }

      const confidence = {};
      ['answer', 'reason', 'class', 'name'].forEach((key) => {
        if (typeof columnMapping[key] === 'number') {
          const confidenceElement = document.getElementById(key + '-confidence');
          if (confidenceElement && !confidenceElement.classList.contains('hidden')) {
            const badge = confidenceElement.querySelector('.confidence-badge');
            if (badge) {
              const confidenceText = badge.textContent;
              const match = confidenceText.match(/(\d+)%/);
              if (match) {
                confidence[key] = parseInt(match[1]);
              }
            }
          }
        }
      });

      const timestamp = new Date().toISOString();
      const validatedConfig = {
        ...config,
        headers: headers,
        columnMapping: columnMapping,
        confidence: confidence,
        verifiedAt: timestamp,
        setupComplete: true,
        setupStatus: 'completed'
      };

      return { config: validatedConfig, validationError: null };

    } catch (error) {
      console.error('è¨­å®šæ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', error);
      return {
        config: null,
        validationError: 'è¨­å®šã®æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message
      };
    }
  }

  function saveDraft() {
    if (!ClientMutex.acquire('saveDraft')) {
      showInfo('ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œä¸­ã§ã™â€¦');
      return;
    }

    try {
      const { config, validationError } = getValidatedConfig();
      if (validationError) {
        showError(validationError);
        ClientMutex.release('saveDraft');
        return;
      }

      window.setLoading(true, 'è¨­å®šã‚’ä¿å­˜ä¸­...');

      if (!config.formUrl && config.spreadsheetId && config.sheetName) {
        google.script.run
          .withSuccessHandler(function (formResult) {
            if (formResult.success && formResult.formData && formResult.formData.formUrl) {
              config.formUrl = formResult.formData.formUrl;
              config.formTitle = formResult.formData.formTitle;

              systemState.config = { ...systemState.config, ...config };
              updateResourceButtons(systemState.config);
            }
            executeDraftSave(config);
          })
          .withFailureHandler(function (error) {
            console.warn('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•æ¤œå‡ºã‚¨ãƒ©ãƒ¼ï¼ˆå®‰å…¨ã«ç¶™ç¶šï¼‰:', error.message);
            executeDraftSave(config);
          })
          .getFormInfo(config.spreadsheetId, config.sheetName);
      } else {
        executeDraftSave(config);
      }

    } catch (error) {
      console.error('ä¸‹æ›¸ãä¿å­˜æº–å‚™ã‚¨ãƒ©ãƒ¼:', error);
      showError('è¨­å®šã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      ClientMutex.release('saveDraft');
    }

    function executeDraftSave(finalConfig) {
      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            showSuccess('ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ');

            systemState.config = { ...systemState.config, ...result.config };
            updateResourceButtons(systemState.config);
            updateConfigSummary(systemState.config);

            if (result.etag || result.config?.etag) {
              systemState.config.etag = result.etag || result.config.etag;
            }
          } else {
            showError(result.message || result.error || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          window.setLoading(false);
          ClientMutex.release('saveDraft');
        })
        .withFailureHandler(function (error) {
          console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          showError('ä¸‹æ›¸ãã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          window.setLoading(false);
          ClientMutex.release('saveDraft');
        })
        .saveConfig(finalConfig, { isDraft: true });
    }
  }

  function publishApp() {
    if (!ClientMutex.acquire('publishApp')) {
      showInfo('å…¬é–‹å‡¦ç†ã‚’å®Ÿè¡Œä¸­ã§ã™â€¦');
      return;
    }

    try {
      const { config, validationError } = getValidatedConfig();
      if (validationError) {
        showError(validationError);
        ClientMutex.release('publishApp');
        return;
      }

      window.setLoading(true, 'ã‚¢ãƒ—ãƒªã‚’å…¬é–‹ä¸­...');

      if (!config.formUrl && config.spreadsheetId && config.sheetName) {
        google.script.run
          .withSuccessHandler(function (formResult) {
            if (formResult.success && formResult.formData && formResult.formData.formUrl) {
              config.formUrl = formResult.formData.formUrl;
              config.formTitle = formResult.formData.formTitle;

              systemState.config = { ...systemState.config, ...config };
              updateResourceButtons(systemState.config);
            }
            executePublish(config);
          })
          .withFailureHandler(function (error) {
            console.warn('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•æ¤œå‡ºã‚¨ãƒ©ãƒ¼ï¼ˆå®‰å…¨ã«ç¶™ç¶šï¼‰:', error.message);
            executePublish(config);
          })
          .getFormInfo(config.spreadsheetId, config.sheetName);
      } else {
        executePublish(config);
      }

    } catch (error) {
      console.error('å…¬é–‹æº–å‚™ã‚¨ãƒ©ãƒ¼:', error);
      showError('å…¬é–‹ã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      ClientMutex.release('publishApp');
    }

    function executePublish(publishConfig) {


      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            showSuccess('ã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã—ã¾ã—ãŸï¼');
            updatePublishStatus('published');



            const updatedConfig = {
              ...systemState.config,
              isPublished: true,
              publishedAt: result.publishedAt || new Date().toISOString(),
              setupComplete: true
            };

            systemState.config = updatedConfig;

            updateResourceButtons(systemState.config);
            updateConfigSummary(systemState.config);

            if (result.etag || result.config?.etag) {
              systemState.config.etag = result.etag || result.config.etag;
            }

            (async () => {
              try {
                const adminData = await loadBatchedAdminData();
                if (adminData && adminData.boardInfo) {
                  currentBoardInfo = adminData.boardInfo;
                  updateFooterDisplay(adminData.boardInfo);
                }
              } catch (error) {
                console.warn('Footer refresh failed:', error);
              }
            })();
          } else {
            if (result.error === 'etag_mismatch') {
              showInfo('è¨­å®šãŒä»–ã§æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚ç”»é¢ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰å†åº¦å…¬é–‹ã—ã¦ãã ã•ã„ã€‚');
              if (typeof loadAndApplyCurrentConfig === 'function') {
                loadAndApplyCurrentConfig();
              }
            } else {
              showError(result.message || result.error || 'ã‚¢ãƒ—ãƒªã®å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          }
          window.setLoading(false);
          ClientMutex.release('publishApp');
        })
        .withFailureHandler(function (error) {
          console.error('å…¬é–‹ã‚¨ãƒ©ãƒ¼:', error);
          showError(
            'ã‚¢ãƒ—ãƒªã®å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          );
          window.setLoading(false);
          ClientMutex.release('publishApp');
        })
        .publishApp(publishConfig);
    }
  }

  function getCurrentFormInfoSafe() {
    try {
      const isUrlMethod = !document.getElementById('url-method')?.classList?.contains('hidden');

      // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰å–å¾—
      if (isUrlMethod) {
        const urlInput = document.getElementById('form-url-input');
        return {
          formUrl: urlInput?.dataset.formUrl || null,
          formTitle: urlInput?.dataset.formTitle || null
        };
      } else {
        const formSelect = document.getElementById('form-select');
        return {
          formUrl: formSelect?.dataset.formUrl || null,
          formTitle: formSelect?.dataset.formTitle || null
        };
      }
    } catch (error) {
      console.warn('getCurrentFormInfoSafe error:', error.message);
      return { formUrl: null, formTitle: null };
    }
  }


  function getDisplaySettings() {
    return {
      showNames: document.getElementById('show-names')?.checked || false,
      showReactions: document.getElementById('show-reactions')?.checked || false
    };
  }

  /**
   * ç¾åœ¨ã®è¨­å®šã‚’å†èª­ã¿è¾¼ã¿ã—ã¦é©ç”¨
   * etagä¸ä¸€è‡´æ™‚ã®ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†ã§ä½¿ç”¨
   */
  async function loadAndApplyCurrentConfig() {
    try {
      const adminData = await loadBatchedAdminData();
      if (adminData) {
        systemState.userInfo = adminData.userInfo;
        systemState.user = adminData.userInfo;
        systemState.config = { ...systemState.config, ...adminData.config };
        currentBoardInfo = adminData.boardInfo;

        updatePanel(systemState.config);
        updateFooterDisplay(adminData.boardInfo);
        showInfo('è¨­å®šã‚’æœ€æ–°ã®çŠ¶æ…‹ã«æ›´æ–°ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('è¨­å®šã®å†èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
      showError('è¨­å®šã®å†èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚');
    }
  }

  function getConfig() {
    // ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼ã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
    const spreadsheetId = getCurrentSpreadsheetId();
    const sheetName = getCurrentSheetName();

    const formInfo = getCurrentFormInfoSafe();
    const columnMapping = getColumnMapping();

    return {
      spreadsheetId,
      sheetName,
      displaySettings: getDisplaySettings(),
      formUrl: formInfo.formUrl,
      formTitle: formInfo.formTitle,
      columnMapping,
      etag: (systemState?.config?.etag) || undefined,
    };
  }

  function getColumnMapping() {
    const dropdowns = {
      answer: document.getElementById('answer-column-select'),
      reason: document.getElementById('reason-column-select'),
      class: document.getElementById('class-column-select'),
      name: document.getElementById('name-column-select'),
    };

    const columnMapping = {};

    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;
      const selectedValue = dropdown.value;
      if (selectedValue !== '') {
        columnMapping[columnType] = parseInt(selectedValue);
      }
    });

    return columnMapping;
  }

  function getColumnConfidence(columnType) {
    const elementId = columnType + '-confidence';
    const confidenceDiv = document.getElementById(elementId);
    if (!confidenceDiv || confidenceDiv.classList.contains('hidden')) {
      return 0;
    }

    const badge = confidenceDiv.querySelector('.confidence-badge');
    if (!badge) return 0;

    const text = badge.textContent;
    const match = text.match(/(\d+)%/);
    return match ? parseInt(match[1]) : badge.classList.contains('manual') ? 100 : 0;
  }


  function updatePublishStatus(status) {
    const badge = document.querySelector('.status-badge.unpublished') || document.querySelector('.status-badge.published');
    if (badge) {
      badge.className = 'status-badge ' + status;
      badge.textContent = status === 'published' ? 'å…¬é–‹ä¸­' : 'æœªå…¬é–‹';
    }
  }


  function updateConfigSummary(config) {
    if (!config) return;

    const isPublished = Boolean(config.isPublished);
    const publishBadge = document.getElementById('app-publish-status');
    if (publishBadge) {
      if (isPublished) {
        publishBadge.className = 'status-badge published';
        publishBadge.textContent = 'å…¬é–‹ä¸­';
      } else {
        publishBadge.className = 'status-badge unpublished';
        publishBadge.textContent = 'æœªå…¬é–‹';
      }
    }


    const sheetnameElement = document.getElementById('current-sheetname');
    if (sheetnameElement) {
      const sheetName = config.sheetName;
      if (sheetName) {
        sheetnameElement.textContent = sheetName;
        sheetnameElement.className = 'text-sm text-white';
      } else {
        sheetnameElement.textContent = 'æœªè¨­å®š';
        sheetnameElement.className = 'text-sm text-gray-400';
      }
    }

    const timeElement = document.getElementById('last-updated-time');
    if (timeElement) {
      const lastModified = systemState.user?.lastModified || config.lastModified;
      if (lastModified) {
        const date = new Date(lastModified);
        timeElement.textContent = date.toLocaleString('ja-JP', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
        });
        timeElement.className = 'text-sm text-white';
      } else {
        timeElement.textContent = '--:--';
        timeElement.className = 'text-sm text-gray-400';
      }
    }
  }


  let currentBoardInfo = null;


  function updateFooterDisplay(boardInfo) {
    const footer = document.getElementById('boardInfoFooter');
    const questionText = document.getElementById('currentQuestionText');
    const openBtn = document.getElementById('openBoardBtn');
    const copyBtn = document.getElementById('copyViewUrlBtn');
    const unpublishBtn = document.getElementById('unpublishBoardBtn');
    const statusText = document.getElementById('boardStatus');

    const isPublished = Boolean(boardInfo?.isPublished || boardInfo?.isActive);

    if (!isPublished) {
      footer.classList.add('hidden');
      return;
    }

    footer.classList.remove('hidden');

    questionText.textContent = boardInfo.questionText || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

    if (boardInfo.isActive && boardInfo.urls) {
      openBtn.style.display = 'block';
      copyBtn.style.display = 'block';
      if (unpublishBtn) unpublishBtn.style.display = 'block';

      openBtn.onclick = () => window.open(boardInfo.urls.view, '_blank');
      copyBtn.onclick = () => copyViewUrl(boardInfo.urls.view);

      if (statusText) {
        statusText.textContent = 'æœ€çµ‚æ›´æ–°: ' + (boardInfo.lastUpdated || 'ä¸æ˜');
      }
    } else {
      openBtn.style.display = 'none';
      copyBtn.style.display = 'none';
      if (unpublishBtn) unpublishBtn.style.display = 'none';
      if (statusText) {
        statusText.textContent = boardInfo.error || 'ãƒœãƒ¼ãƒ‰ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã™';
      }
    }
  }

  function formatDate(dateString) {
    if (!dateString) return '--';
    try {
      const date = new Date(dateString);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      });
    } catch (e) {
      return '--';
    }
  }

  function copyViewUrl(url) {
    if (!url) {
      showError('ã‚³ãƒ”ãƒ¼ã™ã‚‹URLãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard
        .writeText(url)
        .then(() => {
          showSuccess('é–²è¦§ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
          const btn = document.getElementById('copyViewUrlBtn');
          const originalText = btn.textContent;
          btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
          btn.disabled = true;

          const createPromiseDelay = (ms) => new Promise(resolve => {
            const start = Date.now();
            const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
            check();
          });

          createPromiseDelay(2000).then(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }).catch(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          });
        })
        .catch(() => {
          fallbackCopyUrl(url);
        });
    } else {
      fallbackCopyUrl(url);
    }
  }

  function fallbackCopyUrl(url) {
    const textarea = document.createElement('textarea');
    textarea.value = url;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      showSuccess('é–²è¦§ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
    } catch (err) {
      prompt('ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', url);
    }
    document.body.removeChild(textarea);
  }


  function openAnswerBoard() {
    google.script.run
      .withSuccessHandler(function (result) {
        if (result && result.appUrl) {
          window.open(result.appUrl, '_blank');
        } else {
          showError('å›ç­”ãƒœãƒ¼ãƒ‰ã®URLãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        }
      })
      .withFailureHandler(function (error) {
        showError('å›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: ' + error.message);
      })
      .getBoardInfo();
  }

  /**
   * ã‚¢ãƒ—ãƒªè¨­å®šURLã‚’ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒï¼ˆGAS iFrameå¯¾å¿œï¼‰
   * ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã€ãƒªãƒ³ã‚¯ã®hrefã‚’è¨­å®š
   */
  function prefetchAppSetupUrl() {
    const appSetupBtn = document.getElementById('app-setup-btn');
    if (!appSetupBtn) return;

    const targetUserId = window.UNIFIED_CONFIG?.targetUserId;

    google.script.run
      .withSuccessHandler(function (webAppUrl) {
        // ç„¡åŠ¹ãªURLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œè¨¼ï¼ˆOAuthåˆæœŸåŒ–ä¸­ã®URLï¼‰
        if (!webAppUrl || webAppUrl.includes('userCodeAppPanel') || !webAppUrl.includes('/exec')) {
          console.warn('prefetchAppSetupUrl: Invalid URL detected, link disabled');
          return;
        }

        const appSetupUrl = webAppUrl + '?mode=appSetup' + (targetUserId ? '&userId=' + targetUserId : '');
        appSetupBtn.href = appSetupUrl;
      })
      .withFailureHandler(function (error) {
        console.error('ã‚¢ãƒ—ãƒªè¨­å®šURLå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      })
      .getWebAppUrl();
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¢ãƒ—ãƒªè¨­å®šURLã‚’ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', prefetchAppSetupUrl);
  } else {
    prefetchAppSetupUrl();
  }

</script>