<script>
  // Safe template variable extraction from data attributes
  let __USER_ID__ = '';
  if (typeof __USER_ID__ !== 'undefined') {
    // __USER_ID__ is already defined
  }
  try {
    const appData = document.getElementById('app-data');
    if (appData) {
      __USER_ID__ = appData.getAttribute('data-user-id') || '';
    }
  } catch (error) {
    __USER_ID__ = '';
  }

  // === SECTION SEPARATOR ===
  
  /**
   * DOM操作のヘルパー関数群 - AdminPanel版
   */
  const DOMHelpers = Object.freeze({
    safeGetById(id, context = '') {
      try {
        const element = document.getElementById(id);
        if (!element && context) {
          console.warn(`DOM要素が見つかりません: ${id} (${context})`);
        }
        return element;
      } catch (error) {
        console.error(`DOM要素取得エラー: ${id}`, error);
        return null;
      }
    },

    safeSetValue(id, value, property = 'value') {
      const element = this.safeGetById(id, 'value setting');
      if (element && property in element) {
        element[property] = value;
        return true;
      }
      return false;
    },

    safeGetValue(id, property = 'value', fallback = '') {
      const element = this.safeGetById(id, 'value getting');
      return (element && property in element) ? element[property] : fallback;
    },

    safeSetContent(id, content, method = 'textContent') {
      const element = this.safeGetById(id, 'content setting');
      if (element && method in element) {
        element[method] = content;
        return true;
      }
      return false;
    },

    safeAddEventListener(id, event, handler, options = {}) {
      const element = this.safeGetById(id, 'event listener');
      if (element && typeof handler === 'function') {
        element.addEventListener(event, handler, options);
        return true;
      }
      return false;
    }
  });

  /**
   * GAS関数呼び出しヘルパー - エラーハンドリングとリトライ機能付き
   */
  const GASHelper = Object.freeze({
    retryCount: 0,
    maxRetries: 3,

    async callGAS(funcName, ...args) {
      return new Promise((resolve, reject) => {
        if (typeof google === 'undefined' || !google.script?.run) {
          reject(new Error('Google Apps Script環境が利用できません'));
          return;
        }

        google.script.run
          .withSuccessHandler((result) => {
            this.retryCount = 0;
            resolve(result);
          })
          .withFailureHandler((error) => {
            console.error(`GAS関数呼び出しエラー: ${funcName}`, error);
            
            const isRetryable = this.isRetryableError(error);
            
            if (isRetryable && this.retryCount < this.maxRetries) {
              this.retryCount++;
              console.warn(`リトライ実行: ${this.retryCount}/${this.maxRetries} (${funcName})`);
              
              setTimeout(() => {
                this.callGAS(funcName, ...args).then(resolve).catch(reject);
              }, Math.pow(2, this.retryCount) * 1000);
            } else {
              this.retryCount = 0;
              reject(this.normalizeError(error, funcName));
            }
          })
          [funcName](...args);
      });
    },

    isRetryableError(error) {
      const errorString = String(error).toLowerCase();
      const retryablePatterns = [
        'timeout',
        'network',
        'connection',
        'temporary',
        'service unavailable',
        'internal error'
      ];
      
      return retryablePatterns.some(pattern => errorString.includes(pattern));
    },

    normalizeError(error, funcName) {
      if (error instanceof Error) {
        return error;
      }
      
      const message = typeof error === 'string' ? error : 
                     error?.message || '不明なエラーが発生しました';
      
      const normalizedError = new Error(`${funcName}: ${message}`);
      normalizedError.originalError = error;
      normalizedError.functionName = funcName;
      
      return normalizedError;
    }
  });

  // 統一状態管理（一元化）
  let systemState = {
    loading: false,
    config: null,
    spreadsheetList: null,
    sheetList: null,
    initialized: false,
    currentSpreadsheetId: null,
    currentSheetName: null,
    userInfo: null,
    initializationStep: 'not started',
  };

  // ===== 冪等・重複防止（リクエストガード＆デバウンス） =====
  const RequestGate = {
    flags: Object.create(null),
    enter(key) {
      if (this.flags[key]) return false;
      this.flags[key] = true;
      return true;
    },
    exit(key) {
      this.flags[key] = false;
    },
  };

  const Debounce = (() => {
    const timers = new Map();
    return {
      run(key, delay, fn) {
        if (timers.has(key)) clearTimeout(timers.get(key));
        const id = setTimeout(() => {
          timers.delete(key);
          try {
            fn();
          } catch (e) {
            console.error('Debounce error', e);
          }
        }, delay);
        timers.set(key, id);
      },
    };
  })();


  // Wrap initialization in safe handler
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', safeInitialize);
  } else {
    // DOM already loaded, initialize immediately
    safeInitialize();
  }

  async function safeInitialize() {
    systemState.initializationStep = 'started';

    try {
      systemState.initializationStep = 'panel initialization';
      await initializePanel();

      systemState.initializationStep = 'admin check';
      checkSystemAdminAccess();

      systemState.initializationStep = 'footer initialization';
      initializeFooter();

      systemState.initializationStep = 'completed';
      systemState.initialized = true;
    } catch (error) {
      // Try to show error even if UI is not fully initialized
      try {
        showError('初期化エラー: ' + systemState.initializationStep + ' - ' + error.message);
      } catch (uiError) {
        alert('管理パネルの初期化に失敗しました。ページを再読み込みしてください。');
      }
    }
  }

  // フッター初期化
  function initializeFooter() {
    // 初回ボード情報ロード
    loadBoardInfo();

    // 更新ボタンのイベントハンドラ設定
    const refreshBtn = document.getElementById('refreshBoardInfo');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', loadBoardInfo);
    }

    // body padding調整（フッター分の余白を追加）
    document.body.classList.add('has-footer');
  }

  // パネル初期化（統一config取得版）
  async function initializePanel() {
    let step = 'starting';

    try {
      setLoading(true);

      // 1. ユーザー情報読み込み
      step = 'loading user info';
      systemState.userInfo = await loadUserInfoAsync();

      // 2. 設定データを1回だけ取得してsystemStateに保存
      step = 'loading config';
      const configResponse = await getConfigAsync();
      console.log('📊 initializePanel: 設定データ取得完了', configResponse);
      systemState.config = configResponse?.success ? configResponse.config : null;

      // 3. URL パラメータのチェックと適用
      step = 'checking URL params';
      const urlSpreadsheet = getSpreadsheetFromUrl();
      if (urlSpreadsheet) {
        // URL の情報を設定に統合
        if (systemState.config) {
          systemState.config.spreadsheetId = urlSpreadsheet.spreadsheetId;
          if (urlSpreadsheet.spreadsheetUrl) {
            systemState.config.spreadsheetUrl = urlSpreadsheet.spreadsheetUrl;
          }
        } else {
          // 設定がない場合は、URL 情報のみで最低限の設定を作成
          systemState.config = {
            spreadsheetId: urlSpreadsheet.spreadsheetId,
            spreadsheetUrl: urlSpreadsheet.spreadsheetUrl || null
          };
        }
      }

      // 4. 基本設定の反映
      step = 'applying config';
      if (systemState.config) {
        if (systemState.config.sheetName) {
          await autoSelectSheet(systemState.config.sheetName);
        }
        applyExistingConfig(systemState.config);
        updateProgressFromConfig(systemState.config);
      }

      // 5. リソースボタンとサマリー更新
      step = 'updating UI';
      updateResourceButtons(systemState.config);
      updateConfigSummary(systemState.config);

      // 6. ドロップダウンの初期化（systemState.configを使用）
      step = 'initializing dropdowns';
      await initializeDropdowns();

    } catch (error) {
      showError('画面の準備に失敗しました');
    } finally {
      setLoading(false);
    }
  }

  // シンプルなドロップダウン初期化（遅延読み込み対応）
  async function initializeDropdowns() {
    const spreadsheetSelect = document.getElementById('spreadsheet-select');
    const sheetSelect = document.getElementById('sheet-select');

    if (!spreadsheetSelect) return;

    try {
      // スプレッドシート一覧の読み込みはラジオボタン選択時まで遅延
      spreadsheetSelect.innerHTML = '<option value="">スプレッドシートを選択してください</option>';

      // systemStateから設定データを使用（重複取得を回避）
      const config = systemState.config;
      if (config && config.spreadsheetId) {
        // 既存の設定がある場合は、その項目だけを追加
        const option = document.createElement('option');
        option.value = config.spreadsheetId;
        option.textContent = '現在の設定: ' + (config.spreadsheetName || config.spreadsheetId);
        spreadsheetSelect.appendChild(option);
        spreadsheetSelect.value = config.spreadsheetId;

        // 設定されているスプレッドシートのシート一覧を読み込み
        if (config.spreadsheetId) {
          await loadSheetList(config.spreadsheetId);
          if (config.sheetName && sheetSelect) {
            sheetSelect.value = config.sheetName;
          }
        }
      }

      // シンプルなchangeイベントを設定
      setupChangeEvents();

      // データソース選択のラジオボタンイベントを設定
      setupDataSourceRadioEvents();

      // 7. 列設定ドロップダウンの初期化
      if (config && config.spreadsheetId && config.sheetName) {
        try {
          await setupColumns(config.spreadsheetId, config.sheetName, config.columnMapping);
        } catch (columnError) {
          console.error('列設定ドロップダウン初期化エラー:', columnError);
          showInfo('⚠️ 列設定の初期化に失敗しましたが、他の機能は利用できます。');
          // 列設定初期化に失敗しても他の処理は続行
        }
      }
    } catch (error) {
      console.error('ドロップダウン初期化エラー:', error);
      if (spreadsheetSelect) {
        spreadsheetSelect.innerHTML = '<option value="">初期化エラー - 再読み込みしてください</option>';
      }
      showError('管理パネルの初期化に失敗しました。ページを再読み込みしてください。');
    }
  }

  // 列設定ドロップダウン初期化関数
  async function setupColumns(spreadsheetId, sheetName, existingColumnMapping) {
    try {
      console.log('🔧 setupColumns: 列設定を初期化中:', { spreadsheetId, sheetName, existingColumnMapping });

      // 1. まず設定から復元を試行（既存設定がある場合）
      const userId = __USER_ID__;
      let analysisResult;

      if (existingColumnMapping?.mapping &&
          existingColumnMapping?.spreadsheetId === spreadsheetId &&
          Object.keys(existingColumnMapping.mapping).length > 0) {
        console.log('🔧 同一スプレッドシート設定検出 - 設定復元実行');
        analysisResult = await analyzeColumns(spreadsheetId, sheetName);
      }

      // 2. 設定復元に失敗した場合は基本ヘッダー取得
      if (!analysisResult || !analysisResult.success) {
        console.log('🔧 基本ヘッダー取得を実行');
        analysisResult = await analyzeColumns(spreadsheetId, sheetName);
      }

      // 3. 基本ヘッダー取得も失敗した場合はフル分析
      if (!analysisResult || !analysisResult.success) {
        console.log('🔧 フル列分析を実行');
        analysisResult = await analyzeColumns(spreadsheetId, sheetName);
      }

      if (!analysisResult || !analysisResult.success) {
        console.warn('⚠️ すべての列分析方法が失敗 - ダミーヘッダーを使用');
        useDummyColumns(existingColumnMapping);
        return;
      }

      if (!analysisResult.headers || !Array.isArray(analysisResult.headers) || analysisResult.headers.length === 0) {
        console.warn('⚠️ ヘッダー情報が無効です:', analysisResult);
        showError('ヘッダー行がありません');
        return;
      }

      // 2. ドロップダウンにヘッダー選択肢を設定
      fillColumnDropdowns(analysisResult.headers, analysisResult.columnMapping);

      // 3. 既存の設定がある場合は復元（既存関数使用）
      if (existingColumnMapping && existingColumnMapping.mapping) {
        const dropdowns = {
          answer: document.getElementById('answer-column-select'),
          reason: document.getElementById('reason-column-select'),
          class: document.getElementById('class-column-select'),
          name: document.getElementById('name-column-select'),
        };
        restoreColumnSelection(dropdowns);
      }

      console.log('✅ 列設定ドロップダウン初期化完了');
    } catch (error) {
      console.error('❌ 列設定ドロップダウン初期化エラー:', error);
    }
  }


  // データソース選択ラジオボタンのイベント設定
  function setupDataSourceRadioEvents() {
    const radioButtons = document.querySelectorAll('input[name="source-method"]');
    console.log('🔍 [setupDataSourceRadioEvents] Found radio buttons:', radioButtons.length);
    let spreadsheetListLoaded = false;

    if (radioButtons.length === 0) {
      console.warn('⚠️ [setupDataSourceRadioEvents] source-method radio buttons not found');
      return;
    }

    radioButtons.forEach((radio) => {
      radio.addEventListener('change', async function () {
        console.log('🔘 [RadioEvent] Changed to:', this.value, 'listLoaded:', spreadsheetListLoaded);
        if (this.value === 'dropdown' && !spreadsheetListLoaded) {
          // 「一覧から選択」が選択された時のみスプレッドシート一覧を読み込み
          console.log('スプレッドシート一覧を読み込み中...');
          setPartialLoading(true, 'スプレッドシート一覧を取得中...');
          try {
            await loadSpreadsheets();
            spreadsheetListLoaded = true;
          } catch (error) {
            console.error('スプレッドシート一覧の読み込みエラー:', error);
            showError('スプレッドシートが読み込めません');
          } finally {
            setPartialLoading(false);
          }
        }
      });
    });
  }

  // 🎯 シンプルなchangeイベント設定
  function setupChangeEvents() {
    // スプレッドシート選択時 → シート読み込み
    DOMHelpers.safeAddEventListener('spreadsheet-select', 'change', function () {
      const spreadsheetId = this.value;
      if (spreadsheetId) {
        loadSheetList(spreadsheetId);
      } else {
        resetSheetSelect();
      }
    });
  }

  // シート選択をリセット
  function resetSheetSelect() {
    const sheetSelect = DOMHelpers.safeGetById('sheet-select', 'sheet select reset');
    if (sheetSelect) {
      sheetSelect.innerHTML = '<option value="">スプレッドシートを選択してください</option>';
    }
  }

  // スプレッドシート一覧読み込み（非同期版）
  function loadSpreadsheets() {
    return new Promise((resolve, reject) => {
      const select = DOMHelpers.safeGetById('spreadsheet-select', 'spreadsheet list loading');
      if (!select) {
        reject(new Error('spreadsheet-select element not found'));
        return;
      }

      select.innerHTML = '<option value="">読み込み中...</option>';

      // オンデマンド読み込みは部分ローディング
      setPartialLoading(true, 'スプレッドシート一覧を読み込み中...');

      google.script.run
        .withSuccessHandler(function (result) {
          // ✅ Phase 2: レスポンス処理改善とnull対応強化
          console.log('📊 受信した生レスポンス:', result);
          console.log('📊 レスポンスの詳細:', {
            type: typeof result,
            isNull: result === null,
            isUndefined: result === undefined,
            isArray: Array.isArray(result),
            hasSpreadsheets: result && typeof result.spreadsheets !== 'undefined',
            spreadsheetsType: result && typeof result.spreadsheets,
            spreadsheetsLength: result && result.spreadsheets ? result.spreadsheets.length : 'undefined',
            success: result && result.success,
            keys: result ? Object.keys(result) : [],
            rawResultString: JSON.stringify(result)
          });

          // ✅ 強化されたnull/undefined対応
          if (result === null || result === undefined) {
            console.error('📊 null/undefinedレスポンスを受信 - google.script.run送信問題');
            select.innerHTML = '<option value="">通信エラー（null response）</option>';
            setPartialLoading(false);
            reject(new Error('サーバーからnullレスポンスが返されました。main.gs:getSheets()の実行を確認してください。'));
            return;
          }

          // ✅ レスポンス構造の厳密検証
          if (typeof result !== 'object') {
            console.error('📊 非オブジェクトレスポンス:', { resultType: typeof result, result });
            select.innerHTML = '<option value="">無効なレスポンス形式</option>';
            setPartialLoading(false);
            reject(new Error(`無効なレスポンス形式: ${typeof result}`));
            return;
          }

          // ✅ エラーレスポンスの処理
          if (result.success === false) {
            console.warn('📊 エラーレスポンス受信:', result.message || result.error);
            select.innerHTML = `<option value="">${result.message || 'サーバーエラー'}</option>`;
            setPartialLoading(false);
            reject(new Error(result.message || result.error || 'サーバーでエラーが発生しました'));
            return;
          }

          // ✅ レスポンス構造の確認（オブジェクトか配列か）
          const spreadsheets = Array.isArray(result)
            ? result
            : result && Array.isArray(result.spreadsheets)
              ? result.spreadsheets
              : result && Array.isArray(result.sheets)
                ? result.sheets
                : [];

          console.log('📊 スプレッドシート配列抽出完了:', {
            isDirectArray: Array.isArray(result),
            hasSpreadsheetsProp: result && Array.isArray(result.spreadsheets),
            hasSheetsProperty: result && Array.isArray(result.sheets),
            extractedLength: spreadsheets.length
          });

          // 🎯 既存の選択値を保持
          const currentValue = select.value;
          const wasPrePopulated = select.querySelector('[selected]');

          select.innerHTML = '<option value="">スプレッドシートを選択...</option>';

          // デバッグログ追加（null安全）
          console.log('📊 スプレッドシート一覧受信:', {
            resultType: Array.isArray(result) ? 'array' : typeof result,
            count: spreadsheets.length,
            cached: (result && result.cached) || false,
            executionTime: (result && result.executionTime) || 'N/A',
            ownerFiltered: true,
          });

          if (spreadsheets && Array.isArray(spreadsheets) && spreadsheets.length > 0) {
            spreadsheets.forEach((sheet) => {
              const option = document.createElement('option');
              option.value = sheet.id;
              option.textContent = sheet.name;

              // 🔄 事前入力されていた値を再選択
              if (currentValue && currentValue === sheet.id) {
                option.selected = true;
              }

              // フォーム情報をdata属性として保存
              if (sheet.formUrl) {
                option.dataset.formUrl = sheet.formUrl;
                option.dataset.formTitle = sheet.formTitle || 'フォーム';
              }

              select.appendChild(option);
            });

            // 📋 事前入力された設定がリストにない場合は追加
            if (wasPrePopulated && !select.querySelector(`option[value="${currentValue}"]`)) {
              const prePopulatedText = wasPrePopulated.textContent;
              const preserveOption = document.createElement('option');
              preserveOption.value = currentValue;
              preserveOption.textContent = prePopulatedText;
              preserveOption.selected = true;
              select.appendChild(preserveOption);
            }
          } else if (Array.isArray(spreadsheets) && spreadsheets.length === 0) {
            // ✅ 空配列の適切な処理
            const noDataOption = document.createElement('option');
            noDataOption.value = '';
            noDataOption.textContent = 'あなたが所有するスプレッドシートはありません';
            noDataOption.disabled = true;
            select.appendChild(noDataOption);
            console.log('📊 オーナーフィルタリング結果: 0件（空配列）');
          } else if (!Array.isArray(spreadsheets)) {
            // ✅ 配列でない場合のエラーハンドリング
            console.error('📊 spreadsheets が配列ではありません:', {
              spreadsheetsType: typeof spreadsheets,
              spreadsheets: spreadsheets,
              originalResult: result
            });
            const errorOption = document.createElement('option');
            errorOption.value = '';
            errorOption.textContent = 'データ構造エラー（配列でない）';
            errorOption.disabled = true;
            select.appendChild(errorOption);
          } else {
            // ✅ その他の予期しない状況
            console.error('📊 予期しないレスポンス構造:', {
              result,
              spreadsheets,
              spreadsheetsIsArray: Array.isArray(spreadsheets),
              spreadsheetsLength: spreadsheets ? spreadsheets.length : 'N/A'
            });
            const errorOption = document.createElement('option');
            errorOption.value = '';
            errorOption.textContent = 'データ構造エラー';
            errorOption.disabled = true;
            select.appendChild(errorOption);
          }

          setPartialLoading(false);
          resolve(spreadsheets);
        })
        .withFailureHandler(function (error) {
          select.innerHTML = '<option value="">読み込みエラー</option>';
          setPartialLoading(false);

          console.error('📊 getSheets通信エラー:', {
            error: error,
            errorMessage: error.message,
            errorType: typeof error,
            errorStack: error.stack
          });

          let detailedMessage;
          if (error.message && error.message.includes('not initialized')) {
            detailedMessage = 'システムの初期化中です。ページをリロードしてください。';
            console.warn('🔄 ServiceRegistry初期化エラー検出 - リロード推奨');
          } else {
            detailedMessage = 'スプレッドシートの読み込みに失敗しました: ' + error.message;
          }

          reject(new Error(detailedMessage));
        })
        .getSheets();
    });
  }

  function loadSpreadsheetList() {
    loadSpreadsheets();
  }

  // ユーザー情報読み込み（非同期版）
  function loadUserInfoAsync() {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(function (resp) {
          try {
            let email = '';
            if (resp && typeof resp === 'object') {
              email = resp.email || resp.value || '';
            } else if (typeof resp === 'string') {
              email = resp;
            }
            email = String(email || '').trim();

            if (email) {
              document.getElementById('current-user-email').textContent = email;

              // ユーザーIDを表示（__USER_ID__があれば使用）
              if (typeof __USER_ID__ !== 'undefined' && __USER_ID__) {
                document.getElementById('current-user-id').textContent = __USER_ID__;
              } else {
                document.getElementById('current-user-id').textContent = 'N/A';
              }

              resolve({ email, userId: __USER_ID__ || null });
            } else {
              document.getElementById('current-user-email').textContent = '取得中...';
              reject(new Error('ユーザー情報の取得に失敗しました'));
            }
          } catch (err) {
            console.error('loadUserInfoAsync parse error:', err);
            document.getElementById('current-user-email').textContent = '取得中...';
            reject(new Error('ユーザー情報の解析に失敗しました'));
          }
        })
        .withFailureHandler(function (error) {
          document.getElementById('current-user-email').textContent = 'エラー';
          reject(new Error('メールアドレス取得に失敗しました: ' + error.message));
        })
        .getUser('email');
    });
  }

  function loadUserInfo() {
    loadUserInfoAsync().catch((error) => {
      setTimeout(() => {
        loadUserInfoAsync().catch((retryError) => {
          showError('接続に問題があります。再読み込みしてください');
        });
      }, 2000);
    });
  }

  // 設定データの読み込みと完全自動反映（新実装）

  // シンプルなデバウンス機構
  const simpleDebounce = (fn, delay) => {
    let timeoutId;
    return (...args) => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => fn.apply(this, args), delay);
    };
  };

  // 設定データ取得（シンプル版）
  function getConfigAsync() {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .getConfig();
    });
  }

  function loadCurrentConfig() {
    // systemState.configを使用（既に読み込み済み）
    if (systemState.config) {
      applyExistingConfig(systemState.config);
      updateResourceButtons(systemState.config);
      updateConfigSummary(systemState.config);
    }
  }

  // ========== URL パラメータ解析 ==========

  // URL からスプレッドシート情報を取得
  function getSpreadsheetFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);

    // ?spreadsheetId=xxx 形式
    const spreadsheetId = urlParams.get('spreadsheetId');
    if (spreadsheetId) {
      return { spreadsheetId, source: 'url_param' };
    }

    // ?url=https://docs.google.com/spreadsheets/d/xxx 形式
    const spreadsheetUrl = urlParams.get('url');
    if (spreadsheetUrl) {
      const match = spreadsheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if (match) {
        return {
          spreadsheetId: match[1],
          spreadsheetUrl: spreadsheetUrl,
          source: 'url_full'
        };
      }
    }

    return null;
  }

  // ========== 自動反映機能群 ==========

  // スプレッドシート自動選択
  async function autoSelectSpreadsheet(spreadsheetId) {
    try {
      const select = document.getElementById('spreadsheet-select');
      if (!select) {
        throw new Error('スプレッドシート選択要素が見つかりません');
      }

      // オプションから該当するIDを探す
      const option = Array.from(select.options).find((opt) => opt.value === spreadsheetId);
      if (option) {
        select.value = spreadsheetId;

        // シート一覧も自動読み込み
        await loadSheets(spreadsheetId);
        return true;
      } else {
        // 直接URLで接続を試行
        showInfo('💡 設定済みスプレッドシートに直接接続を試行します');
        return false;
      }
    } catch (error) {
      throw error;
    }
  }

  // シート自動選択
  async function autoSelectSheet(sheetName) {
    try {
      const select = document.getElementById('sheet-select');
      if (!select) {
        throw new Error('シート選択要素が見つかりません');
      }

      // オプションから該当する名前を探す
      const option = Array.from(select.options).find((opt) => opt.textContent === sheetName);
      if (option) {
        select.value = option.value;
        return true;
      } else {
        // 現在のモードを確認
        const dropdownMethod = document.getElementById('dropdown-method');
        const isDropdownMode = dropdownMethod && !dropdownMethod.classList.contains('hidden');

        // 一覧選択モードでかつ実際にドロップダウンが読み込まれている場合のみ通知
        if (isDropdownMode && select.options.length > 1) {
          showInfo('💡 シート「' + sheetName + '」が見つかりません。手動で選択してください');
        }
        return false;
      }
    } catch (error) {
      throw error;
    }
  }

  // 設定の完全反映（拡張版）
  function applyExistingConfig(config) {
    if (!config) return;

    try {

      // 1. スプレッドシート選択の反映
      if (config.spreadsheetId) {
        const spreadsheetSelect = document.getElementById('spreadsheet-select');
        if (spreadsheetSelect) {
          spreadsheetSelect.value = config.spreadsheetId;
        } else {
          console.warn('⚠️ スプレッドシートセレクト (spreadsheet-select) が見つかりません');
        }
      }

      // 2. スプレッドシートURLの反映（URL直接入力フィールド）
      if (config.spreadsheetUrl) {
        const urlInput = document.getElementById('spreadsheet-url');
        if (urlInput) {
          urlInput.value = config.spreadsheetUrl;
        } else {
          console.warn('⚠️ URL入力フィールド (spreadsheet-url) が見つかりません');
        }
      }

      // 3. シート選択の反映
      if (config.sheetName) {
        const sheetSelect = document.getElementById('sheet-select');
        if (sheetSelect) {
          sheetSelect.value = config.sheetName;
        } else {
          console.warn('⚠️ シートセレクト (sheet-select) が見つかりません');
        }
      }

      // 4. 表示設定の反映（新形式・旧形式対応）
      const displaySettings = config.displaySettings || {};
      const showNames = displaySettings.showNames !== undefined ? displaySettings.showNames : config.showNames;
      const showReactions = displaySettings.showReactions !== undefined ? displaySettings.showReactions : config.showReactions;

      // 名前表示トグル
      const showNamesToggle = document.getElementById('show-names');
      if (showNamesToggle && typeof showNames === 'boolean') {
        showNamesToggle.checked = showNames;
      }

      // リアクション表示トグル
      const showReactionsToggle = document.getElementById('show-reactions');
      if (showReactionsToggle && typeof showReactions === 'boolean') {
        showReactionsToggle.checked = showReactions;
      }

      // 5. 表示モードの反映
      if (config.displayMode) {
        const displayModeSelect = document.getElementById('display-mode');
        if (displayModeSelect) {
          displayModeSelect.value = config.displayMode;
        }
      }

      // 6. フォーム情報の反映
      if (config.formUrl) {
        const formUrlDisplay = document.getElementById('form-url');
        if (formUrlDisplay) {
          formUrlDisplay.textContent = config.formUrl;
          formUrlDisplay.href = config.formUrl;
        }
      }

      if (config.formTitle) {
        const formTitleDisplay = document.getElementById('form-title');
        if (formTitleDisplay) {
          formTitleDisplay.textContent = config.formTitle;
        }
      }

      // 7. シート名入力フィールドの復元
      if (config.sheetName) {
        const sheetNameInput = document.getElementById('sheet-name-input');
        if (sheetNameInput) {
          sheetNameInput.value = config.sheetName;
        }
      }

    } catch (error) {
      console.error('❌ 設定反映エラー:', error.message);
    }
  }

  // ========== 基本セキュリティ関数 ==========

  // URL入力の基本検証
  function validateUrlInput(inputElement) {
    const url = inputElement.value.trim();
    const messageEl = document.getElementById('url-validation-message');

    if (!url) {
      messageEl.textContent = '💡 GoogleスプレッドシートのURLを貼り付けてください';
      messageEl.className = 'text-xs text-gray-400 mt-1';
      inputElement.classList.remove('border-red-500', 'border-green-500');
      return;
    }

    // 基本的なURL検証パターン
    const urlPattern = /^https:\/\/docs\.google\.com\/spreadsheets\/d\/[a-zA-Z0-9-_]+/;

    if (urlPattern.test(url)) {
      messageEl.textContent = '✅ 有効なスプレッドシートURLです';
      messageEl.className = 'text-xs text-green-400 mt-1';
      inputElement.classList.remove('border-red-500');
      inputElement.classList.add('border-green-500');
    } else {
      messageEl.textContent =
        '❌ 無効なURL形式です。Googleスプレッドシートの正しいURLを入力してください';
      messageEl.className = 'text-xs text-red-400 mt-1';
      inputElement.classList.remove('border-green-500');
      inputElement.classList.add('border-red-500');
    }
  }

  // 基本的なサニタイゼーション
  function sanitizeInput(input) {
    if (!input || typeof input !== 'string') {
      return '';
    }
    return input.replace(/[<>\"'&]/g, '').trim();
  }

  // フォーム送信時のデータサニタイゼーション
  function sanitizeFormData(data) {
    const sanitized = {};
    for (const key in data) {
      if (data.hasOwnProperty(key)) {
        if (typeof data[key] === 'string') {
          sanitized[key] = sanitizeInput(data[key]);
        } else {
          sanitized[key] = data[key];
        }
      }
    }
    return sanitized;
  }

  // 進捗ステップを設定から更新
  function updateProgressFromConfig(config) {
    try {
      let currentStep = 1;

      if (config.sheetName && config.spreadsheetId) {
        currentStep = 2; // データソース接続完了
      }

      if (config.columnMapping && config.columnMapping.mapping && Object.keys(config.columnMapping.mapping).length > 0) {
        currentStep = 3; // 列設定完了
      }

      if (config.setupStatus === 'completed') {
        currentStep = 3; // セットアップ完了確定
      }

      console.log('📈 Progress update:', { currentStep, hasSheet: !!(config.sheetName), hasMapping: !!(config.columnMapping), setupComplete: config.setupStatus === 'completed' });
      updateProgress(currentStep);
    } catch (error) {
      console.warn('updateProgressFromConfig error:', error);
    }
  }

  // 非同期版の補助関数群
  function loadSheets(spreadsheetId) {
    return new Promise((resolve, reject) => {
      const select = document.getElementById('sheet-select');
      select.innerHTML = '<option value="">読み込み中...</option>';

      google.script.run
        .withSuccessHandler(function (response) {
          select.innerHTML = '<option value="">シートを選択...</option>';
          const sheets = response?.success ? response.sheets : [];
          sheets.forEach((sheet) => {
            const option = document.createElement('option');
            option.value = sheet.name;

            // フォーム連携シートかどうかで表示を変える
            if (sheet.isFormResponseSheet && sheet.formConnected) {
              option.textContent = `📋 ${sheet.name} (フォーム回答)`;
              option.dataset.isFormSheet = 'true';
              option.dataset.formTitle = sheet.formTitle || '';
            } else {
              option.textContent = sheet.name;
              option.dataset.isFormSheet = 'false';
            }

            select.appendChild(option);
          });
          resolve(sheets);
        })
        .withFailureHandler(function (error) {
          select.innerHTML = '<option value="">読み込みエラー</option>';
          reject(new Error('シートの読み込みに失敗しました: ' + error.message));
        })
        .getSheetList(spreadsheetId);
    });
  }

  function analyzeColumns(spreadsheetId, sheetName) {
    return new Promise((resolve, reject) => {
      console.log('🔍 analyzeColumns called with:', { spreadsheetId, sheetName });

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('✅ analyzeColumns success:', result);
          resolve(result);
        })
        .withFailureHandler(function(error) {
          console.error('❌ analyzeColumns error:', error);

          if (error.message && error.message.includes('not initialized')) {
            console.warn('🔄 analyzeColumns ServiceRegistry初期化エラー検出');
            reject(new Error('システムの初期化中です。ページをリロードしてください。'));
          } else {
            reject(error);
          }
        })
        .analyzeColumns(spreadsheetId, sheetName);
    });
  }


  // ダミーヘッダーへのフォールバック処理
  function useDummyColumns(existingColumnMapping) {
    console.log('📋 ダミーヘッダーを使用してドロップダウンを初期化');
    const dummyHeaders = ['列1', '列2', '列3', '列4', '列5', '列6', '列7', '列8', '列9', '列10'];
    fillColumnDropdowns(dummyHeaders, {});

    if (existingColumnMapping && existingColumnMapping.mapping) {
      const dropdowns = {
        answer: document.getElementById('answer-column-select'),
        reason: document.getElementById('reason-column-select'),
        class: document.getElementById('class-column-select'),
        name: document.getElementById('name-column-select'),
      };
      restoreColumnSelection(dropdowns, existingColumnMapping.mapping);
    } else {
      showError('スプレッドシートが開けません');
    }
  }

  // ========== リソースボタン関連関数 ==========

  // スプレッドシートを新タブで開く
  function openSpreadsheet() {
    const btn = document.getElementById('open-spreadsheet-btn');
    const spreadsheetId = btn.dataset.spreadsheetId;

    if (!spreadsheetId) {
      showError('スプレッドシートを選択してください');
      return;
    }

    const spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/' + spreadsheetId + '/edit';
    window.open(spreadsheetUrl, '_blank');
  }

  // フォームを新タブで開く
  function openForm() {
    const btn = document.getElementById('open-form-btn');
    const formUrl = btn.dataset.formUrl;

    if (!formUrl) {
      showError('フォームURLを入力してください');
      return;
    }

    window.open(formUrl, '_blank');
  }

  // リソースボタンの表示状態を更新
  function updateResourceButtons(config) {
    const spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
    const formBtn = document.getElementById('open-form-btn');
    const boardBtn = document.getElementById('open-board-btn');
    const statusDiv = document.getElementById('resource-status');

    // 🎯 下書き保存・公開ボタンの状態管理
    const saveDraftBtn = document.getElementById('save-draft');
    const publishNowBtn = document.getElementById('publish-now');

    // 設定が無い場合の初期状態
    if (!config) {
      spreadsheetBtn.disabled = true;
      spreadsheetBtn.dataset.spreadsheetId = '';
      formBtn.classList.add('hidden');
      if (boardBtn) boardBtn.classList.add('hidden');
      statusDiv.textContent = '設定が見つかりません';

      // 下書き保存・公開ボタンを無効化
      if (saveDraftBtn) {
        saveDraftBtn.disabled = true;
        saveDraftBtn.textContent = '下書き保存（設定未完了）';
      }
      if (publishNowBtn) {
        publishNowBtn.disabled = true;
        publishNowBtn.textContent = '今すぐ公開（設定未完了）';
      }
      return;
    }

    // 🚀 列マッピング完了状態の判定
    const hasColumnMapping = !!(config.columnMapping && config.columnMapping.mapping);
    const hasSpreadsheetConfig = !!(config.spreadsheetId && config.sheetName);
    // setupStatusまたは、実際にマッピング要件が満たされている場合も完了とみなす
    const isSetupComplete = config.setupStatus === 'completed' ||
                          (hasSpreadsheetConfig && hasColumnMapping && config.setupStatus === 'completed');

    console.log('📋 ボタン状態更新:', {
      hasColumnMapping,
      hasSpreadsheetConfig,
      isSetupComplete,
      mappingKeys: hasColumnMapping ? Object.keys(config.columnMapping.mapping) : []
    });

    // 下書き保存ボタンの状態管理
    if (saveDraftBtn) {
      if (hasSpreadsheetConfig) {
        saveDraftBtn.disabled = false;
        saveDraftBtn.textContent = hasColumnMapping ? '下書き保存' : '下書き保存（列設定推奨）';
        saveDraftBtn.classList.remove('opacity-50');
      } else {
        saveDraftBtn.disabled = true;
        saveDraftBtn.textContent = '下書き保存（データソース未接続）';
        saveDraftBtn.classList.add('opacity-50');
      }
    }

    // 公開ボタンの状態管理
    if (publishNowBtn) {
      if (hasSpreadsheetConfig && hasColumnMapping) {
        publishNowBtn.disabled = false;
        publishNowBtn.textContent = '今すぐ公開';
        publishNowBtn.classList.remove('opacity-50');
      } else {
        publishNowBtn.disabled = true;
        if (!hasSpreadsheetConfig) {
          publishNowBtn.textContent = '今すぐ公開（データソース未接続）';
        } else {
          publishNowBtn.textContent = '今すぐ公開（列設定が必要）';
        }
        publishNowBtn.classList.add('opacity-50');
      }
    }

    // スプレッドシート情報はConfigurationManagerで管理されるため、API経由で取得
    spreadsheetBtn.disabled = true;
    statusDiv.textContent = 'スプレッドシート機能はConfigurationManager統合中';

    // フォームボタン（フォームURLが設定されている場合に表示）
    if (config.formUrl) {
      formBtn.classList.remove('hidden');
      formBtn.disabled = false;
      formBtn.dataset.formUrl = config.formUrl;
    } else {
      formBtn.classList.add('hidden');
    }

    // ステータス更新
    let statusParts = [];
    // スプレッドシートステータスはConfigurationManager経由で取得
    if (config.formUrl) statusParts.push('📝 フォーム');
    if (config.appPublished) statusParts.push('🎯 ボード');

    if (statusParts.length > 0) {
      statusDiv.textContent = '✅ 利用可能: ' + statusParts.join(', ');
      statusDiv.className = 'text-xs text-green-400 mt-2 text-center';
    } else {
      statusDiv.textContent = '💡 リソースの設定を開始してください';
      statusDiv.className = 'text-xs text-yellow-400 mt-2 text-center';
    }

    // 🎯 設定完了状態のフィードバック
    if (isSetupComplete && hasColumnMapping && hasSpreadsheetConfig) {
      // 設定完了時の特別フィードバック
      const setupStatusDiv = document.getElementById('setup-status-feedback');
      if (setupStatusDiv) {
        setupStatusDiv.innerHTML = `
          <div class="flex items-center gap-2 p-3 bg-green-900/20 border border-green-500/30 rounded-lg text-green-400 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>設定が完了しました！下書き保存または公開を実行できます</span>
          </div>
        `;
      }
    }

    // 設定サマリーも更新
    updateConfigSummary(config);
  }

  // ローディング状態設定 - UnifiedLoadingSystemを使用
  function setLoading(loading, message = '処理中...') {
    systemState.loading = loading;

    // UnifiedLoadingSystemを使用
    if (window.unifiedLoading) {
      if (loading) {
        window.unifiedLoading.show(message);
      } else {
        window.unifiedLoading.hide();
      }
    } else {
    }
  }

  // フォーム情報表示（改善版）
  function showFormInfo(formData, options = {}) {
    const safeData = formData || {};
    const status = options.status || (safeData.formUrl ? 'linked' : 'missing');
    const message = options.message || '';
    const reason = options.reason || '';
    const diagnostics = options.diagnostics || null;
    const suggestions = Array.isArray(options.suggestions) ? options.suggestions : [];
    const spreadsheetName = options.spreadsheetName || safeData.spreadsheetName || '';
    const sheetName = safeData.sheetName || options.sheetName || '';

    const formInfos = [
      {
        container: document.getElementById('form-info'),
        title: document.getElementById('form-title'),
        url: document.getElementById('form-url'),
        spreadsheet: document.getElementById('spreadsheet-name')
      },
      {
        container: document.getElementById('form-info-url'),
        title: document.getElementById('form-title-url'),
        url: document.getElementById('form-url-url'),
        spreadsheet: document.getElementById('spreadsheet-name-url')
      }
    ];

    const displayTitle = (safeData.formTitle && safeData.formTitle.trim())
      ? safeData.formTitle.trim()
      : (spreadsheetName || sheetName || 'フォーム未連携');
    const hasLink = status === 'linked' && !!safeData.formUrl;
    const linkText = hasLink ? safeData.formUrl : (message || 'フォームが連携されていません');
    const linkHref = hasLink ? safeData.formUrl : null;

    console.log('🔍 showFormInfo: 表示状態', {
      status,
      reason,
      hasLink,
      formData: safeData,
      diagnostics
    });

    formInfos.forEach((info) => {
      if (!info.container || !info.title || !info.url) {
        return;
      }

      info.title.textContent = displayTitle;

      if (linkHref) {
        info.url.href = linkHref;
        info.url.setAttribute('target', '_blank');
        info.url.textContent = linkText;
        info.url.classList.remove('text-yellow-400', 'cursor-not-allowed');
        info.url.classList.add('text-blue-400');
      } else {
        info.url.textContent = linkText;
        info.url.removeAttribute('href');
        info.url.removeAttribute('target');
        info.url.classList.remove('text-blue-400');
        info.url.classList.add('text-yellow-400', 'cursor-not-allowed');
      }

      if (info.spreadsheet && spreadsheetName) {
        info.spreadsheet.textContent = `スプレッドシート: ${spreadsheetName}`;
        info.spreadsheet.classList.remove('hidden');
      }

      info.container.classList.remove('hidden');
      info.container.dataset.formStatus = status;
      info.container.dataset.formReason = reason;
      info.container.dataset.formSheet = sheetName;

      if (diagnostics) {
        try {
          info.container.dataset.formDiagnostics = JSON.stringify(diagnostics);
        } catch (jsonError) {
          console.warn('formDiagnostics serialization failed:', jsonError);
        }
      } else {
        info.container.removeAttribute('data-form-diagnostics');
      }
    });

    window.__formIntegrationStatus = {
      status,
      reason,
      message,
      suggestions,
      diagnostics,
      formData: {
        ...safeData,
        spreadsheetName,
        sheetName
      }
    };
    console.log('📊 フォーム連携ステータス更新:', window.__formIntegrationStatus);
  }

  // フォーム情報非表示
  function hideFormInfo() {
    const formInfo = document.getElementById('form-info');
    const formInfoUrl = document.getElementById('form-info-url');
    if (formInfo) {
      formInfo.classList.add('hidden');
      formInfo.removeAttribute('data-form-status');
      formInfo.removeAttribute('data-form-reason');
      formInfo.removeAttribute('data-form-diagnostics');
    }
    if (formInfoUrl) {
      formInfoUrl.classList.add('hidden');
      formInfoUrl.removeAttribute('data-form-status');
      formInfoUrl.removeAttribute('data-form-reason');
      formInfoUrl.removeAttribute('data-form-diagnostics');
    }
  }

  // シート別フォーム連携情報をチェック・表示
  function checkSheetFormConnection(spreadsheetId, sheetName) {
    if (!spreadsheetId || !sheetName) {
      hideFormInfo();
      return;
    }

    setPartialLoading(true, 'シート連携情報を確認中...');

    google.script.run
      .withSuccessHandler((result) => {
        setPartialLoading(false);
        const normalizedResult = result && typeof result === 'object' ? result : null;
        const rawFormData = normalizedResult && typeof normalizedResult.formData === 'object' ? normalizedResult.formData : null;
        const derivedSpreadsheetName = rawFormData?.spreadsheetName || normalizedResult?.diagnostics?.spreadsheetName || '';
        const derivedSheetName = rawFormData?.sheetName || normalizedResult?.requestContext?.sheetName || sheetName;

        window.__formIntegrationLatestResponse = normalizedResult;

        console.log('🔍 getFormInfo APIレスポンス詳細:', {
          result: normalizedResult,
          hasResult: !!normalizedResult,
          isSuccess: normalizedResult && normalizedResult.success,
          hasFormData: rawFormData,
          formData: rawFormData,
          spreadsheetId,
          sheetName: derivedSheetName
        });

        if (normalizedResult && normalizedResult.success && rawFormData && rawFormData.formUrl) {
          showFormInfo(
            {
              ...rawFormData,
              spreadsheetName: derivedSpreadsheetName,
              sheetName: derivedSheetName
            },
            {
              status: 'linked',
              message: normalizedResult.message || 'フォーム連携を確認しました。',
              reason: normalizedResult.reason || '',
              diagnostics: normalizedResult.diagnostics || null,
              suggestions: Array.isArray(normalizedResult.suggestions) ? normalizedResult.suggestions : [],
              spreadsheetName: derivedSpreadsheetName,
              sheetName: derivedSheetName
            }
          );
          return;
        }

        const fallbackMessage = normalizedResult && normalizedResult.message
          ? normalizedResult.message
          : 'フォーム連携情報が見つかりませんでした。';
        const fallbackSuggestions = normalizedResult && Array.isArray(normalizedResult.suggestions)
          ? normalizedResult.suggestions
          : [];

        console.warn('⚠️ フォーム連携情報が見つからない:', {
          reason: normalizedResult ? normalizedResult.reason : '不明',
          suggestions: fallbackSuggestions
        });

        if (fallbackSuggestions.length > 0) {
          const formattedSuggestions = fallbackSuggestions.map((s) => `• ${s}`).join('\n');
          showWarning(`${fallbackMessage}\n\n推奨対処法:\n${formattedSuggestions}`);
        } else {
          showWarning(fallbackMessage);
        }

        const fallbackFormData = {
          ...(rawFormData || {}),
          formUrl: rawFormData ? rawFormData.formUrl : null,
          formTitle: (rawFormData && rawFormData.formTitle) || derivedSpreadsheetName || derivedSheetName || 'フォーム未連携',
          spreadsheetName: derivedSpreadsheetName,
          sheetName: derivedSheetName
        };

        showFormInfo(fallbackFormData, {
          status: 'missing',
          message: fallbackMessage,
          reason: normalizedResult ? normalizedResult.reason || 'FORM_INFO_UNAVAILABLE' : 'FORM_INFO_UNAVAILABLE',
          diagnostics: normalizedResult ? normalizedResult.diagnostics || null : null,
          suggestions: fallbackSuggestions,
          spreadsheetName: derivedSpreadsheetName,
          sheetName: derivedSheetName
        });
      })
      .withFailureHandler((error) => {
        setPartialLoading(false);
        console.error('❌ シート連携チェックエラー:', {
          error: error,
          errorMessage: error.message,
          spreadsheetId: spreadsheetId,
          sheetName: sheetName,
        });
        const failureMessage = 'フォーム連携情報の取得中にエラーが発生しました。';
        showError(`${failureMessage}\n${error.message || ''}`);
        window.__formIntegrationLatestResponse = null;
        hideFormInfo();
      })
      .getFormInfo(spreadsheetId, sheetName);
  }

  // 設定エクスポート
  function exportConfig() {
    google.script.run
      .withSuccessHandler(function (config) {
        const dataStr = JSON.stringify(config, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        const exportFileDefaultName = 'studyquest-config.json';

        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();

        showSuccess('設定をエクスポートしました');
      })
      .withFailureHandler(function (error) {
        console.error('エクスポートエラー:', error);
        showError('設定のエクスポートに失敗しました');
      })
      .getConfig();
  }

  // システム管理者アクセス確認
  function checkSystemAdminAccess() {
    google.script.run
      .withSuccessHandler(function (isAdmin) {
        const appSetupBtn = document.getElementById('app-setup-btn');
        if (appSetupBtn) {
          if (isAdmin) {
            console.log('システム管理者として認識されました');
            appSetupBtn.style.display = 'block';
          } else {
            console.log('一般ユーザーとして認識されました');
            appSetupBtn.style.display = 'none';
          }
        }
      })
      .withFailureHandler(function (error) {
        console.warn('システム管理者確認エラー:', error);
        const appSetupBtn = document.getElementById('app-setup-btn');
        if (appSetupBtn) {
          appSetupBtn.style.display = 'none';
        }
      })
      .isAdmin();
  }

  // フォーム作成インターフェース
  function createFormInterface() {
    // ユーザーIDの確認
    if (!__USER_ID__ || __USER_ID__.trim() === '') {
      showError('接続に問題があります。再読み込みしてください');
      return;
    }

    const formName = prompt(
      '作成するフォーム名を入力してください：\n例：アンケートフォーム、質問フォーム'
    );

    if (!formName || !formName.trim()) {
      showError('フォーム名を入力してください');
      return;
    }

    if (formName.trim().length > 50) {
      showError('50文字以内で入力してください');
      return;
    }

    // 基本的なフォーム設定
    const config = {
      title: formName.trim(),
      description: 'カスタムフォームが作成されました',
      fields: [
        {
          type: 'text',
          label: '名前',
          required: true,
        },
        {
          type: 'text',
          label: 'メッセージ',
          required: true,
        },
      ],
    };

    console.log('フォーム作成開始:', { userId: __USER_ID__, config });
    setPartialLoading(true, 'フォーム作成中...');

    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          showSuccess('フォーム「' + formName + '」を作成しました');
          if (result.formUrl) {
            const openForm = confirm('フォームが作成されました。今すぐ開きますか？');
            if (openForm) {
              window.open(result.formUrl, '_blank');
            }
          }
        } else {
          showError('フォーム作成に失敗しました');
        }
        setPartialLoading(false);
      })
      .withFailureHandler(function (error) {
        console.error('フォーム作成エラー:', error);
        showError('フォーム作成に失敗しました');
        setPartialLoading(false);
      })
      .createForm(__USER_ID__, config);
  }

  // アプリ設定画面へのナビゲーション
  function goToAppSetup() {
    setPartialLoading(true, '画面遷移中...');
    google.script.run
      .withSuccessHandler(function (webAppUrl) {
        const userId = __USER_ID__;
        const setupUrl = webAppUrl + '?mode=appSetup' + (userId ? '&userId=' + userId : '');
        window.open(setupUrl, '_top');
      })
      .withFailureHandler(function (error) {
        console.error('アプリ設定画面への遷移エラー:', error);
        showError('アプリ設定画面への移動に失敗しました');
        setPartialLoading(false);
      })
      .getWebAppUrl();
  }

  // データソース選択方式の切り替え
  function toggleSourceMethod(method) {
    const dropdownMethod = document.getElementById('dropdown-method');
    const urlMethod = document.getElementById('url-method');

    if (method === 'url') {
      dropdownMethod.classList.add('hidden');
      urlMethod.classList.remove('hidden');
    } else {
      dropdownMethod.classList.remove('hidden');
      urlMethod.classList.add('hidden');
    }
  }

  // スプレッドシートURL検証
  function validateSpreadsheetUrl() {
    const urlInput = document.getElementById('spreadsheet-url');
    const url = urlInput.value.trim();

    if (!url) {
      showError('URLを入力してください');
      return;
    }

    // GoogleスプレッドシートURLの基本的な検証
    const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
    const match = url.match(spreadsheetRegex);

    if (!match) {
      showError('URLをコピペしてください（例: docs.google.com/spreadsheets/...）');
      return;
    }

    const spreadsheetId = match[1];
    setPartialLoading(true, 'URL検証中...');

    // バックエンドでアクセス権限を確認
    google.script.run
      .withSuccessHandler(function (result) {
        setPartialLoading(false);
        if (result.success) {
          showSuccess('✅ スプレッドシートへのアクセスが確認できました');
          // スプレッドシートIDを隠しフィールドに保存
          urlInput.dataset.spreadsheetId = spreadsheetId;
          // シート一覧を取得してプルダウンを更新
          if (result.sheets && result.sheets.length > 0) {
            updateSheetNameSuggestions(result.sheets);

            // シート名が自動設定された場合、フォーム情報も取得
            const sheetNameInput = document.getElementById('sheet-name-input');
            if (sheetNameInput.value && sheetNameInput.value.trim() !== '') {
              console.log('validateAccessAPI成功後、フォーム情報を取得:', {
                spreadsheetId: spreadsheetId,
                sheetName: sheetNameInput.value
              });

              // フォーム情報を非同期で取得
              google.script.run
                .withSuccessHandler(function(formResult) {
                  console.log('validateAccessAPI後のフォーム情報取得成功:', formResult);
                  if (formResult && formResult.success && formResult.formData) {
                    showFormInfo(formResult.formData, {
                      status: 'linked',
                      message: 'フォーム連携が確認されました'
                    });
                  } else {
                    console.warn('フォーム情報取得失敗:', formResult);
                    showFormInfo({}, {
                      status: 'missing',
                      message: 'フォーム連携情報が見つかりませんでした'
                    });
                  }
                })
                .withFailureHandler(function(formError) {
                  console.warn('validateAccessAPI後のフォーム情報取得エラー:', formError);
                  showFormInfo({}, {
                    status: 'error',
                    message: 'フォーム情報の取得中にエラーが発生しました'
                  });
                })
                .getFormInfo(spreadsheetId, sheetNameInput.value);
            }
          }
        } else {
          showError('スプレッドシートが開けません');
        }
      })
      .withFailureHandler(function (error) {
        setPartialLoading(false);
        console.error('URL検証エラー:', error);
        showError('URLの確認に失敗しました');
      })
      .validateAccessAPI(spreadsheetId);
  }

  // シート名候補を更新し、空欄時は自動入力
  function updateSheetNameSuggestions(sheets) {
    const sheetNameInput = document.getElementById('sheet-name-input');
    if (sheets && sheets.length > 0) {
      // シート名が空欄の場合のみ自動入力
      if (!sheetNameInput.value || sheetNameInput.value.trim() === '') {
        // 優先順位でシート名を選択
        const preferredSheetName = selectBestSheetName(sheets);
        sheetNameInput.value = preferredSheetName;
        console.log('シート名を自動設定:', preferredSheetName);
      }

      // datalistで候補を表示（より良いUX）
      let datalist = document.getElementById('sheet-suggestions');
      if (!datalist) {
        datalist = document.createElement('datalist');
        datalist.id = 'sheet-suggestions';
        sheetNameInput.setAttribute('list', 'sheet-suggestions');
        sheetNameInput.parentNode.appendChild(datalist);
      }

      datalist.innerHTML = '';
      sheets.forEach((sheet) => {
        const option = document.createElement('option');
        option.value = sheet.name;
        option.text = `${sheet.name} (${sheet.rowCount}行)`;
        datalist.appendChild(option);
      });
    }
  }

  // 最適なシート名を選択する関数
  function selectBestSheetName(sheets) {
    // 1. 「回答」「answer」を含むシートを優先
    const answerSheets = sheets.filter(sheet =>
      /回答|answer|データ|data/i.test(sheet.name)
    );
    if (answerSheets.length > 0) {
      return answerSheets[0].name;
    }

    // 2. 行数が最も多いシート（データが入っていそう）
    const maxRowSheet = sheets.reduce((max, sheet) =>
      sheet.rowCount > max.rowCount ? sheet : max
    );
    if (maxRowSheet.rowCount > 1) {
      return maxRowSheet.name;
    }

    // 3. デフォルトで最初のシート
    return sheets[0].name;
  }

  // URL入力方式でのデータソース接続
  function connectToUrlSource() {
    const urlInput = document.getElementById('spreadsheet-url');
    const sheetNameInput = document.getElementById('sheet-name-input');

    const url = urlInput.value.trim();
    const sheetName = sheetNameInput.value.trim();

    if (!url) {
      showError('URLを入力してください');
      return;
    }

    if (!sheetName) {
      showError('シート名を入力してください');
      return;
    }

    // URLからスプレッドシートIDを抽出
    const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
    const match = url.match(spreadsheetRegex);

    if (!match) {
      showError('URLをコピペしてください（例: docs.google.com/spreadsheets/...）');
      return;
    }

    const spreadsheetId = match[1];

    console.log('URL入力方式で接続開始:', { spreadsheetId, sheetName });
    setPartialLoading(true, 'URL接続中...');

    // 初期化処理と同じフォールバック機能付きで処理を実行
    connectToSheet(spreadsheetId, sheetName);
  }

  // URL入力接続処理（簡素化版）
  async function connectToSheet(spreadsheetId, sheetName) {
    try {
      console.log('📋 connectToSheet: シート接続を開始:', { spreadsheetId, sheetName });

      // 1. フル列分析を実行（AI検出込み - 設定復元なし）
      let analysisResult = await analyzeColumns(spreadsheetId, sheetName);

      // 2. 列分析が失敗した場合は基本ヘッダーのみ取得を試行
      if (!analysisResult || !analysisResult.success) {
        console.log('🔧 connectToSheet: 基本ヘッダー取得を実行');
        analysisResult = await analyzeColumns(spreadsheetId, sheetName);
      }

      if (!analysisResult || !analysisResult.success) {
        console.warn('⚠️ connectToSheet: すべての列分析方法が失敗');
        showError('シートに接続できません');
        setPartialLoading(false);
        return;
      }

      if (!analysisResult.headers || !Array.isArray(analysisResult.headers) || analysisResult.headers.length === 0) {
        console.warn('⚠️ connectToSheet: ヘッダー情報が無効です:', analysisResult);
        showError('ヘッダー行がありません');
        setPartialLoading(false);
        return;
      }

      // 3. 成功時の処理
      console.log('✅ connectToSheet: シート接続成功');
      updateColumnMapping(analysisResult);
      updateProgress(2);
      setPartialLoading(false);

    } catch (error) {
      console.error('❌ connectToSheet: 接続処理エラー:', error);
      showError('シート接続に失敗しました');
      setPartialLoading(false);
    }
  }


  // イベントリスナー設定
  document.addEventListener('DOMContentLoaded', function () {
    // データソース選択方式の切り替え
    document.querySelectorAll('input[name="source-method"]').forEach((radio) => {
      radio.addEventListener('change', function () {
        toggleSourceMethod(this.value);
      });
    });

    // シート選択時（フォーム情報表示）
    document.getElementById('sheet-select').addEventListener('change', function () {
      const spreadsheetId = document.getElementById('spreadsheet-select').value;
      const sheetName = this.value;

      if (spreadsheetId && sheetName) {
        // シート別フォーム連携情報を取得・表示
        checkSheetFormConnection(spreadsheetId, sheetName);
      } else {
        hideFormInfo();
      }
    });

    // データ更新ボタン
    document.getElementById('refresh-data').addEventListener('click', function () {
      loadSpreadsheets();
    });

    // 接続ボタン（一覧選択）
    document.getElementById('connect-source').addEventListener('click', function () {
      Debounce.run('connect-source', 400, () => connectToSource());
    });

    // URL検証ボタン
    document.getElementById('url-validate').addEventListener('click', function () {
      validateSpreadsheetUrl();
    });

    // 接続ボタン（URL入力）
    document.getElementById('connect-url-source').addEventListener('click', function () {
      connectToUrlSource();
    });

    // 設定確認ボタン
    document.getElementById('verify-mapping').addEventListener('click', function () {
      Debounce.run('verify-mapping', 500, () => verifyColumnMapping());
    });

    // 下書き保存ボタン
    document.getElementById('save-draft').addEventListener('click', function () {
      Debounce.run('save-draft', 500, () => saveDraft());
    });

    // 公開ボタン
    document.getElementById('publish-now').addEventListener('click', function () {
      Debounce.run('publish-now', 800, () => publishApp());
    });
  });

  // シート一覧読み込み
  function loadSheetList(spreadsheetId) {
    const select = document.getElementById('sheet-select');
    if (!select) {
      console.error('❌ loadSheetList: sheet-select要素が見つかりません');
      showError('シート選択要素が見つかりません');
      return;
    }

    select.innerHTML = '<option value="">読み込み中...</option>';

    // シート読み込みは部分ローディング
    setPartialLoading(true, 'シート一覧を読み込み中...');

    google.script.run
      .withSuccessHandler(function (response) {
        select.innerHTML = '<option value="">シートを選択...</option>';

        // DataService.getSheetList() returns {success: true, sheets: [...]}
        const sheets = response?.success ? response.sheets : [];

        if (!sheets || sheets.length === 0) {
          const noSheetOption = document.createElement('option');
          noSheetOption.value = '';
          noSheetOption.textContent = '利用可能なシートがありません';
          noSheetOption.disabled = true;
          select.appendChild(noSheetOption);
        } else {
          sheets.forEach((sheet) => {
            const option = document.createElement('option');
            option.value = sheet.name;
            option.textContent = sheet.name;
            select.appendChild(option);
          });
        }

        // partial-loading-targetクラスを削除
        select.classList.remove('partial-loading-target');

        setPartialLoading(false);
        showSuccess(`✅ ${sheets?.length || 0}個のシートを読み込みました`);
      })
      .withFailureHandler(function (error) {
        console.error('❌ loadSheetList: シート読み込みエラー', {
          error: error.message || error,
          spreadsheetId: typeof spreadsheetId === 'string' && spreadsheetId ? `${spreadsheetId.substring(0, 10)}...` : `[${typeof spreadsheetId}]`,
          timestamp: new Date().toISOString(),
        });

        select.innerHTML = '<option value="">読み込みエラー - 再試行してください</option>';
        select.classList.remove('partial-loading-target');

        setPartialLoading(false);
        showError(`シート一覧の読み込みに失敗しました: ${error.message || error}`);
      })
      .getSheetList(spreadsheetId);
  }

  // データソース接続
  function connectToSource() {
    if (!RequestGate.enter('connectToSource')) {
      showInfo('現在処理中です…少し待ってから再試行してください。');
      return;
    }
    const spreadsheetId = document.getElementById('spreadsheet-select').value;
    const sheetName = document.getElementById('sheet-select').value;

    // 入力検証を詳細化
    if (!spreadsheetId) {
      showError(
        'スプレッドシートを選択してください。先に「更新」ボタンを押して一覧を読み込んでください。'
      );
      return;
    }

    if (!sheetName) {
      showError(
        'シートを選択してください。スプレッドシートを選択すると、シート一覧が表示されます。'
      );
      return;
    }

    setLoading(true);
    console.log('connectToSource: 接続開始', { spreadsheetId, sheetName });

    google.script.run
      .withSuccessHandler(function (result) {
        console.log('connectToSource: 接続結果', result);

        if (result.success) {
          showSuccess('データソースに接続しました');
          // 進捗更新
          updateProgress(2);

          // 新しいドロップダウン式列マッピングを更新
          updateColumnMapping(result);

          // 🚀 UX向上：AI判定の自動適用
          autoApplyAIDetection(result);

          // 🎯 UX向上：次ステップの案内
          showNextStepGuidance(result);
        } else {
          handleConnectionError(result.error, { spreadsheetId, sheetName });
        }
        setLoading(false);
        RequestGate.exit('connectToSource');
      })
      .withFailureHandler(function (error) {
        console.error('connectToSource 接続エラー:', error);
        handleConnectionError(error.message || error, { spreadsheetId, sheetName });
        setLoading(false);
        RequestGate.exit('connectToSource');
      })
      .connectDataSource(spreadsheetId, sheetName);
  }

  // 接続エラーハンドリング
  function handleConnectionError(errorMessage, context) {
    console.error('Connection error details:', { errorMessage, context });

    let userMessage = 'データソースへの接続に失敗しました。';
    let suggestions = [];

    // エラーメッセージに基づく詳細な診断
    if (errorMessage.includes('Permission') || errorMessage.includes('権限')) {
      suggestions.push('スプレッドシートへのアクセス権限を確認してください');
      suggestions.push('スプレッドシートを開いて、編集権限があることを確認してください');
    } else if (errorMessage.includes('not found') || errorMessage.includes('見つかりません')) {
      suggestions.push('指定されたスプレッドシートまたはシートが存在するか確認してください');
      suggestions.push('シート名が正確か確認してください');
    } else if (errorMessage.includes('timeout') || errorMessage.includes('タイムアウト')) {
      suggestions.push('ネットワーク接続を確認してください');
      suggestions.push('しばらく時間をおいて再試行してください');
    } else {
      suggestions.push('スプレッドシートが開けることを確認してください');
      suggestions.push('手動で列を設定することも可能です');
    }

    const fullMessage =
      userMessage + '\n\n推奨対処法:\n' + suggestions.map((s) => '• ' + s).join('\n');
    showError(fullMessage);

    // ドロップダウン式では手動設定は自動的に利用可能
    showInfo('💡 ドロップダウンを使用して手動で列を設定できます。');
  }


  // 進捗更新
  function updateProgress(step) {
    const steps = document.querySelectorAll('.step');
    steps.forEach((stepEl, index) => {
      stepEl.classList.remove('completed', 'current');
      if (index < step - 1) {
        stepEl.classList.add('completed');
      } else if (index === step - 1) {
        stepEl.classList.add('current');
      }
    });
  }

  // 列マッピング更新（ドロップダウン式）- シンプル版
  function updateColumnMapping(result) {
    console.log('Column mapping received:', result);

    if (!result || !result.success) {
      console.warn('列マッピング結果が不正です');
      showError('列マッピング情報の取得に失敗しました');
      return;
    }

    const mapping = result.columnMapping || result.mapping || {};
    const confidence = result.confidence || {};
    const headers = result.headers || [];

    console.log('Headers:', headers, 'Mapping:', mapping, 'Confidence:', confidence);

    // ドロップダウンにヘッダーオプションを設定
    fillColumnDropdowns(headers, mapping, confidence);
    // 現在のヘッダーをグローバルに保持（検証/保存で使用）
    try {
      window.currentHeaders = headers;
    } catch (_) {}

    // AI検出情報を表示
    displayAIDetectionInfo(mapping, confidence);

    // 接続時はAI検出結果を優先し、保存済み設定復元は行わない
    // AI検出が無い場合のみヘッダー情報を表示

    showSuccess('✅ 列設定を更新しました');
  }

  // ドロップダウンにヘッダーオプションを設定 - エラーハンドリング強化版
  function fillColumnDropdowns(headers, mapping, confidence = {}) {
    console.log('fillColumnDropdowns:', { headers, mapping, confidence });

    try {
      // 入力データの検証とフォールバック
      let actualHeaders = headers;
      if (!Array.isArray(headers) || headers.length === 0) {
        console.warn('⚠️ ヘッダー情報が不正です - ダミーヘッダーを使用');
        // フォールバック: ダミーヘッダーを提供
        actualHeaders = ['列1', '列2', '列3', '列4', '列5', '列6', '列7', '列8', '列9', '列10'];
        showInfo('💡 列分析が失敗したため、列番号で表示しています。適切な列を手動で選択してください。');
      }

      // 4つのドロップダウンを取得
      const dropdowns = {
        answer: document.getElementById('answer-column-select'),
        reason: document.getElementById('reason-column-select'),
        class: document.getElementById('class-column-select'),
        name: document.getElementById('name-column-select'),
      };

      // ドロップダウンの存在確認
      const missingDropdowns = Object.keys(dropdowns).filter((key) => !dropdowns[key]);
      if (missingDropdowns.length > 0) {
        console.warn('一部のドロップダウンが見つかりません:', missingDropdowns);
      }

      // 各ドロップダウンをクリアしてヘッダーオプションを追加
      Object.keys(dropdowns).forEach((columnType) => {
        const dropdown = dropdowns[columnType];
        if (!dropdown) {
          console.warn(`${columnType}ドロップダウンが見つかりません`);
          return;
        }

        try {
          // 既存のオプションをクリア
          dropdown.innerHTML = '<option value="">選択してください...</option>';

          // ヘッダーをオプションとして追加
          actualHeaders.forEach((header, index) => {
            if (header && header.trim()) {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = `${String.fromCharCode(65 + index)}列: ${header}`;
              dropdown.appendChild(option);
            }
          });
        } catch (error) {
          console.error(`${columnType}ドロップダウンの設定エラー:`, error);
        }
      });

      // AI検出結果をドロップダウンの初期選択として設定
      setAIDetectionSelections(mapping, dropdowns, confidence);

      // 保存済み設定の復元（オプション追加後に実行）
      restoreColumnSelection(dropdowns);

      // ドロップダウン変更イベントリスナーを設定
      setupDropdownEventListeners(dropdowns);
    } catch (error) {
      console.error('fillColumnDropdowns エラー:', error);
      showError('ドロップダウンの設定に失敗しました: ' + error.message);
    }
  }

  // 保存済み設定から列マッピングを復元（オプション追加後に実行）- 改良版（フォールバック対応）
  let lastMappingRestore = null;
  function restoreColumnSelection(dropdowns, fallbackMapping = null) {
    try {
      let savedMapping = null;

      // フォールバックマッピングが提供された場合（列分析失敗時）
      if (fallbackMapping) {
        savedMapping = fallbackMapping;
        console.log('📋 フォールバックマッピング使用:', savedMapping);
      } else {
        // 通常のconfig取得
        const config = systemState.config;
        if (!config || !config.columnMapping || !config.columnMapping.mapping) {
          console.log('📋 保存済み列マッピングなし - スキップ');
          return false;
        }
        savedMapping = config.columnMapping.mapping;
      }

      // 重複実行防止
      const mappingHash = JSON.stringify(savedMapping);
      if (lastMappingRestore === mappingHash) {
        console.log('📋 列マッピング復元: 重複実行をスキップ');
        return true;
      }
      lastMappingRestore = mappingHash;

      console.log('📋 保存済み列マッピング復元開始:', savedMapping);

      // 各列選択ドロップダウンに保存済み値を設定
      let restoredCount = 0;
      Object.keys(dropdowns).forEach((columnType) => {
        const dropdown = dropdowns[columnType];
        if (!dropdown) {
          console.warn(`⚠️ ${columnType}ドロップダウンが見つかりません`);
          return;
        }

        const savedValue = savedMapping[columnType];
        if (savedValue !== undefined) {
          // オプションの存在確認
          const option = dropdown.querySelector(`option[value="${savedValue}"]`);
          if (option) {
            dropdown.value = savedValue;
            console.log(`✅ ${columnType}列選択復元: ${savedValue}`);

            // ドロップダウンに視覚的フィードバックを追加
            dropdown.classList.add('has-manual-selection');
            restoredCount++;
          } else {
            console.warn(`⚠️ ${columnType}列選択: 保存値 ${savedValue} に対応するオプションが見つかりません`);
          }
        }
      });

      console.log(`✅ 保存済み列マッピング復元完了 (${restoredCount}件復元)`);
      return restoredCount > 0;
    } catch (error) {
      console.error('❌ 保存済み列マッピング復元エラー:', error.message);
      return false;
    }
  }

  // AI検出結果をドロップダウンの初期選択として設定
  function setAIDetectionSelections(mapping, dropdowns, confidence = {}) {
    console.log('setAIDetectionSelections:', mapping, 'confidence:', confidence);

    // 防御的チェック: mappingがundefined/nullの場合は早期リターン
    if (!mapping || typeof mapping !== 'object') {
      console.log('💡 AI検出結果がありません - 手動選択をお使いください');
      return;
    }

    // 詳細チェック: mapping構造の検証
    const mappingDetails = {
      hasMapping: mapping.hasOwnProperty('mapping') || Object.keys(mapping).length > 0,
      hasConfidence: Object.keys(confidence).length > 0,
      mappingKeys: mapping.mapping ? Object.keys(mapping.mapping) : Object.keys(mapping),
      confidenceKeys: Object.keys(confidence),
      mappingContent: mapping.mapping || mapping,
      confidenceContent: confidence
    };
    console.log('🔍 setAIDetectionSelections: mapping詳細分析', mappingDetails);

    // AI判定システム対応: mappingが空でも信頼度があれば処理継続
    const actualMapping = mapping.mapping || mapping;
    const hasValidMapping = actualMapping && Object.keys(actualMapping).length > 0;
    const hasConfidenceData = confidence && Object.keys(confidence).length > 0;

    if (!hasValidMapping && !hasConfidenceData) {
      console.log('💡 AI検出結果がありません - 手動選択をお使いください');
      return;
    }

    if (!hasValidMapping && hasConfidenceData) {
      console.log('🔍 AI判定システム: マッピングなし、信頼度データで処理継続', confidence);
    }

    // グローバル変数として現在のAI検出結果を保存
    window.currentAIMapping = mapping;

    // マッピングの対応関係（バックエンドのconvertIndicesToMappingと統一）
    const mappingKeys = {
      answer: ['answer'], // バックエンドのCONSTANTS.COLUMNS.OPINION → answer
      reason: ['reason'], // バックエンドのCONSTANTS.COLUMNS.REASON → reason
      class: ['class'], // バックエンドのCONSTANTS.COLUMNS.CLASS → class
      name: ['name'], // バックエンドのCONSTANTS.COLUMNS.NAME → name
    };

    let detectedCount = 0;
    let totalConfidenceInfo = [];

    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;

      // 対応するマッピングキーを探す
      let selectedIndex = null;
      let columnConfidence = 0;

      mappingKeys[columnType].forEach((key) => {
        if (actualMapping[key] !== null && actualMapping[key] !== undefined) {
          selectedIndex = actualMapping[key];
        }
        if (confidence && confidence[key] !== undefined) {
          columnConfidence = confidence[key];
        }
      });

      // 信頼度情報を記録（検出されなくても）
      if (columnConfidence > 0) {
        totalConfidenceInfo.push(`${columnType}: ${columnConfidence}%`);
      }

      if (selectedIndex !== null) {
        // ドロップダウンの選択を設定
        dropdown.value = selectedIndex;
        dropdown.classList.add('has-ai-selection');

        // 信頼度バッジを表示
        showConfidenceBadge(columnType, columnConfidence, 'ai');

        console.log(`✅ AI検出成功: ${columnType} → ${selectedIndex}列 (信頼度: ${columnConfidence}%)`);
        detectedCount++;
      } else if (columnConfidence > 0) {
        // AI判定システム: 動的閾値による判定
        const allConfidences = Object.values(confidence).filter(c => c > 0);
        const maxConfidence = Math.max(...allConfidences);
        const relativeThreshold = Math.max(maxConfidence * 0.7, 25); // 最高値の70%または25%

        let badgeType = 'low-confidence';
        let statusMessage = '';

        if (columnConfidence >= relativeThreshold) {
          badgeType = 'relative-candidate';
          statusMessage = `候補 (相対閾値${Math.round(relativeThreshold)}%達成)`;
        } else if (columnConfidence >= 20) {
          badgeType = 'low-confidence';
          statusMessage = `検討中 (${Math.round(columnConfidence)}%)`;
        } else {
          statusMessage = `信頼度不足 (${Math.round(columnConfidence)}%)`;
        }

        console.log(`🔍 AI判定: ${columnType}列 - ${statusMessage} (最高値: ${Math.round(maxConfidence)}%)`);
        showConfidenceBadge(columnType, columnConfidence, badgeType);
      }
    });

    // AI判定システム対応の改善されたフィードバックメッセージ
    if (detectedCount > 0) {
      const maxConfidence = Math.max(...Object.values(confidence));
      console.log(`🎯 AI判定検出: ${detectedCount}/4列を自動設定 (最高信頼度: ${Math.round(maxConfidence)}%)`);
      console.log(`📊 詳細: ${totalConfidenceInfo.join(', ')}`);
    } else if (totalConfidenceInfo.length > 0) {
      const maxConfidence = Math.max(...Object.values(confidence));
      const avgConfidence = Object.values(confidence).reduce((a, b) => a + b, 0) / Object.values(confidence).length;
      console.log(`📊 AI判定分析完了: 自動設定なし (最高: ${Math.round(maxConfidence)}%, 平均: ${Math.round(avgConfidence)}%)`);
      console.log(`🔍 各列信頼度: ${totalConfidenceInfo.join(', ')} - 手動選択をご利用ください`);
    } else {
      console.log('💡 AI検出結果がありません - 手動選択をお使いください');
    }

    // AI検出情報パネルを表示
    const aiInfo = document.getElementById('ai-detection-info');
    if (aiInfo) {
      aiInfo.classList.remove('hidden');
    }
  }

  // 🚀 UX向上：AI判定の自動適用機能（データ構造修正版）
  function autoApplyAIDetection(result) {
    if (!result?.success || !result?.columnMapping?.mapping) {
      console.log('🔍 autoApplyAIDetection: データ不足のためスキップ');
      return;
    }

    // 正しいデータ構造へのアクセス
    const mapping = result.columnMapping.mapping; // ✅ 正しいパス
    const confidence = result.columnMapping.confidence; // ✅ 正しいパス

    console.log('🔍 autoApplyAIDetection: データ構造確認', {
      columnMapping: result.columnMapping,
      mapping: mapping,
      confidence: confidence,
    });

    let autoAppliedCount = 0;
    let highConfidenceCount = 0;

    // 適応的閾値による自動適用（列種別最適化）
    const adaptiveThresholds = {
      name: 65,    // 明確な列種別
      class: 65,   // 明確な列種別
      answer: 55,  // 文脈依存列
      reason: 55   // 文脈依存列
    };

    Object.keys(mapping).forEach((columnType) => {
      // リアクション列はスキップ（UIドロップダウンが存在しない）
      if (['highlight', 'curious', 'like', 'understand'].includes(columnType)) {
        return;
      }

      const columnIndex = mapping[columnType];
      const confidenceValue = confidence?.[columnType] || 0;
      const threshold = adaptiveThresholds[columnType] || 60; // デフォルト閾値

      console.log(`🔍 ${columnType}: columnIndex=${columnIndex}, confidence=${confidenceValue}, threshold=${threshold}`);

      if (confidenceValue >= threshold && columnIndex !== undefined && columnIndex !== null) {
        highConfidenceCount++;
        const dropdown = document.getElementById(`${columnType}-column-select`);

        if (dropdown) {
          dropdown.value = columnIndex;
          dropdown.classList.add('has-auto-applied');
          dropdown.classList.remove('has-manual-selection');

          // 信頼度バッジを更新（関数が存在する場合のみ）
          if (typeof showConfidenceBadge === 'function') {
            showConfidenceBadge(columnType, confidenceValue, 'auto-applied');
          }

          autoAppliedCount++;
          console.log(
            `🤖 AI自動適用成功: ${columnType} → ${columnIndex}列 (信頼度: ${confidenceValue}%)`
          );
        } else {
          console.warn(`❌ ドロップダウンが見つかりません: ${columnType}-column-select`);
        }
      }
    });

    // ユーザーフィードバック
    if (autoAppliedCount > 0) {
      showSuccess(`🤖 高精度AI判定を${autoAppliedCount}項目自動適用しました！`);
      updateProgress(3); // 列設定完了まで進める
    } else if (highConfidenceCount === 0) {
      showInfo('💡 AI判定の信頼度が低めです。ドロップダウンで手動設定してください。');
    } else {
      console.log('🔍 高信頼度の項目はあるが、ドロップダウン設定に失敗');
    }
  }

  // 🎯 UX向上：次ステップ案内機能
  function showNextStepGuidance(result) {
    if (!result || !result.success) return;

    const mapping = result.columnMapping || {};
    const hasAutoApplied = Object.values(mapping).some((detection) => {
      const confidence = typeof detection?.confidence === 'number' ? detection.confidence : 0;
      return confidence >= 80;
    });

    setTimeout(() => {
      if (hasAutoApplied) {
        showSuccess('✨ AI判定を自動適用済み。「設定を確認」で完了できます！');
      } else {
        showInfo('💡 ドロップダウンで列を手動設定してから「設定を確認」してください');
      }
    }, 1500); // 他のメッセージの後に表示
  }

  // ドロップダウンの変更イベントリスナーを設定
  function setupDropdownEventListeners(dropdowns) {
    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;

      dropdown.addEventListener('change', function () {
        handleDropdownChange(columnType, this);
      });
    });

    // AI検出に戻すボタンのイベントリスナー
    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.addEventListener('click', function () {
        resetToAIDetection();
      });
    }
  }

  // ドロップダウン変更の処理
  function handleDropdownChange(columnType, dropdown) {
    const selectedValue = dropdown.value;
    console.log(`ドロップダウン変更: ${columnType} → ${selectedValue}`);

    // 既存のCSSクラスを削除
    dropdown.classList.remove('has-ai-selection', 'has-manual-selection');

    if (selectedValue === '') {
      // 選択解除
      hideConfidenceBadge(columnType);
    } else {
      // 手動選択
      dropdown.classList.add('has-manual-selection');
      showConfidenceBadge(columnType, 100, 'manual');

      // AI検出に戻すボタンを表示
      const resetButton = document.getElementById('reset-to-ai');
      if (resetButton) {
        resetButton.style.display = 'inline-block';
      }

      // 手動設定情報を表示
      const manualInfo = document.getElementById('manual-override-info');
      if (manualInfo) {
        manualInfo.classList.remove('hidden');
      }
    }

    // 選択状況を更新
    updateSelectionStatus();
  }

  // 信頼度バッジを表示
  function showConfidenceBadge(columnType, confidence, type) {
    const confidenceDiv = document.getElementById(`${columnType}-confidence`);
    const badge = confidenceDiv.querySelector('.confidence-badge');

    if (!confidenceDiv || !badge) return;

    let badgeClass = '';
    let badgeText = '';

    if (type === 'manual') {
      badgeClass = 'manual';
      badgeText = '✋ 手動設定';
    } else if (type === 'ai') {
      // AI判定システムで自動設定された場合
      badgeClass = 'high';
      badgeText = `🎯 AI判定 ${Math.round(confidence)}%`;
    } else if (type === 'relative-candidate') {
      // AI判定で候補として検出された場合
      badgeClass = 'candidate';
      badgeText = `🔍 候補 ${Math.round(confidence)}%`;
    } else if (type === 'low-confidence') {
      // 信頼度が低い場合
      badgeClass = 'low';
      badgeText = `📊 検討中 ${Math.round(confidence)}%`;
    } else {
      // 従来のAI検出（フォールバック）
      if (confidence >= 80) {
        badgeClass = 'high';
        badgeText = `🤖 AI検出 ${Math.round(confidence)}%`;
      } else if (confidence >= 50) {
        badgeClass = 'medium';
        badgeText = `🤖 AI検出 ${Math.round(confidence)}%`;
      } else {
        badgeClass = 'low';
        badgeText = `🤖 AI検出 ${Math.round(confidence)}%`;
      }
    }

    badge.className = `confidence-badge ${badgeClass}`;
    badge.textContent = badgeText;
    confidenceDiv.classList.remove('hidden');
  }

  // 信頼度バッジを非表示
  function hideConfidenceBadge(columnType) {
    const confidenceDiv = document.getElementById(`${columnType}-confidence`);
    if (confidenceDiv) {
      confidenceDiv.classList.add('hidden');
    }
  }

  // AI検出情報を表示
  function displayAIDetectionInfo(mapping, confidence = {}) {
    const detailsDiv = document.getElementById('ai-detection-details');
    if (!detailsDiv) return;

    // 防御的チェック: mappingがundefined/nullの場合は早期リターン
    if (!mapping || typeof mapping !== 'object') {
      console.log('💡 AI検出結果がありません - displayAIDetectionInfo');
      detailsDiv.innerHTML = '<div class="text-gray-400 text-sm">AI検出結果がありません</div>';
      return;
    }

    const details = [];
    const columnNames = {
      answerer: '回答列',
      reason: '理由列',
      class: 'クラス列',
      name: '名前列',
    };

    const actualMapping = mapping.mapping || mapping;
    Object.keys(columnNames).forEach((key) => {
      if (actualMapping[key] !== null && actualMapping[key] !== undefined) {
        const columnLabel = String.fromCharCode(65 + actualMapping[key]) + '列';
        const columnConfidence = confidence[key] || 0;
        details.push(`${columnNames[key]}: ${columnLabel} (信頼度: ${Math.round(columnConfidence)}%)`);
      }
    });

    // XSS対策: DOM操作で安全に詳細情報を設定
    detailsDiv.innerHTML = '';
    details.forEach(detail => {
      const div = document.createElement('div');
      div.textContent = `• ${detail}`;
      detailsDiv.appendChild(div);
    });
  }

  // 選択状況を更新
  function updateSelectionStatus() {
    const hasManualSelection =
      document.querySelectorAll('.modern-select.has-manual-selection').length > 0;
    const hasAISelection = document.querySelectorAll('.modern-select.has-ai-selection').length > 0;

    console.log('選択状況:', { hasManualSelection, hasAISelection });

    // AI検出情報とリセットボタンの表示制御
    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.style.display = hasManualSelection ? 'inline-block' : 'none';
    }
  }

  // AI検出結果に戻す
  function resetToAIDetection() {
    console.log('AI検出結果にリセット');

    if (!window.currentAIMapping) {
      showError('AI検出データがありません');
      return;
    }

    // 全てのドロップダウンをリセット
    const dropdowns = {
      answer: document.getElementById('answer-column-select'),
      reason: document.getElementById('reason-column-select'),
      class: document.getElementById('class-column-select'),
      name: document.getElementById('name-column-select'),
    };

    // AI検出結果を再設定
    setAIDetectionSelections(window.currentAIMapping, dropdowns);

    // 手動設定情報を非表示
    const manualInfo = document.getElementById('manual-override-info');
    if (manualInfo) {
      manualInfo.classList.add('hidden');
    }

    // リセットボタンを非表示
    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.style.display = 'none';
    }

    showSuccess('✅ AI検出結果にリセットしました');
  }

  // 列マッピング確認
  function verifyColumnMapping() {
    if (!RequestGate.enter('verifyColumnMapping')) {
      showInfo('検証処理を実行中です…');
      return;
    }

    // 接続方式に応じて適切な方法でスプレッドシート情報を取得
    const sourceMethod = document.querySelector('input[name="source-method"]:checked').value;
    let spreadsheetId, sheetName;

    if (sourceMethod === 'url') {
      // URL入力方式
      const urlInput = document.getElementById('spreadsheet-url');
      const url = urlInput.value.trim();
      const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
      const match = url.match(spreadsheetRegex);

      if (match) {
        spreadsheetId = match[1];
      }
      sheetName = document.getElementById('sheet-name-input').value.trim();
    } else {
      // 一覧選択方式
      spreadsheetId = document.getElementById('spreadsheet-select').value;
      sheetName = document.getElementById('sheet-select').value;
    }

    if (!spreadsheetId || !sheetName) {
      showError('検証するにはまず、スプレッドシートとシートを接続してください');
      return;
    }

    setLoading(true);

    console.log('verifyColumnMapping: 列マッピング検証開始', { spreadsheetId, sheetName });

    // ヘッダーは接続時に保持したものを使用（なければ最小化）
    let headers = Array.isArray(window.currentHeaders) ? window.currentHeaders : [];
    if (!headers.length) {
      const options = document.querySelectorAll('#answer-column-select option');
      headers = Array.from(options)
        .map((opt) => {
          const txt = opt.textContent || '';
          const parts = txt.split(': ');
          return parts.length > 1 ? parts.slice(1).join(': ') : '';
        })
        .filter(Boolean);
    }

    // ドロップダウンからマッピングを収集
    const selections = gatherColumnSelections();
    const mapping = { mapping: {}, confidence: {} };
    ['answer', 'reason', 'class', 'name'].forEach((key) => {
      const sel = selections[key];
      if (sel && typeof sel.columnIndex === 'number') {
        mapping.mapping[key] = sel.columnIndex;
        if (typeof sel.confidence === 'number') mapping.confidence[key] = sel.confidence;
      }
    });

    // 表示用に検証結果を描画
    displayVerificationResults({ ok: true });

    // 設定を保存（headers + columnMapping で統一）
    saveColumnConfiguration(spreadsheetId, sheetName, headers, mapping);

    showSuccess('列マッピングの検証が完了しました');
    updateProgress(3);
    setLoading(false);
    RequestGate.exit('verifyColumnMapping');
  }

  // 検証結果の表示
  function displayVerificationResults(headerIndices) {
    console.log('検証結果の表示を開始:', headerIndices);

    // 🎯 実際のUIドロップダウン要素に検証済みバッジを追加
    const columnTypes = ['answer', 'reason', 'class', 'name'];
    let badgesAdded = 0;

    columnTypes.forEach(columnType => {
      const dropdown = document.getElementById(`${columnType}-column-select`);
      const confidenceDiv = document.getElementById(`${columnType}-confidence`);

      if (dropdown && dropdown.value !== '') {
        // 既存の検証済みバッジを削除（重複防止）
        const existingBadge = dropdown.parentElement.querySelector('.verification-badge');
        if (existingBadge) {
          existingBadge.remove();
        }

        // 新しい検証済みバッジを作成
        const verifiedBadge = document.createElement('span');
        verifiedBadge.className = 'verification-badge status-badge published';
        verifiedBadge.textContent = '✓ 検証済み';
        verifiedBadge.style.fontSize = '0.75rem';
        verifiedBadge.style.marginLeft = '0.5rem';
        verifiedBadge.style.display = 'inline-flex';
        verifiedBadge.style.alignItems = 'center';

        // ドロップダウンの親要素に追加
        if (confidenceDiv) {
          confidenceDiv.appendChild(verifiedBadge);
        } else {
          dropdown.parentElement.appendChild(verifiedBadge);
        }

        badgesAdded++;
        console.log(`✅ 検証済みバッジを追加: ${columnType}列`);
      }
    });

    // 🎯 列マッピングセクション全体に検証完了マークを追加
    const sectionHeaders = document.querySelectorAll('section h2');
    let mappingSection = null;

    sectionHeaders.forEach(header => {
      const headerText = header.textContent || '';
      if (headerText.includes('AI列マッピング') || headerText.includes('列マッピング')) {
        mappingSection = header.closest('section');
      }
    });

    if (mappingSection) {
      // 既存の検証完了マークを削除
      const existingMark = mappingSection.querySelector('.section-verified-mark');
      if (existingMark) {
        existingMark.remove();
      }

      // セクション検証完了マークを追加
      const sectionMark = document.createElement('div');
      sectionMark.className = 'section-verified-mark';
      sectionMark.innerHTML = `
        <div class="flex items-center gap-2 mt-4 p-3 bg-green-900/20 border border-green-500/30 rounded-lg">
          <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span class="text-green-400 font-medium">列マッピング設定が完了しました</span>
        </div>
      `;

      const actionButtons = mappingSection.querySelector('.action-buttons');
      if (actionButtons) {
        actionButtons.parentElement.insertBefore(sectionMark, actionButtons);
      } else {
        mappingSection.appendChild(sectionMark);
      }
    }

    console.log(`✅ 検証結果を表示しました: ${badgesAdded}個のバッジを追加`);
  }

  // 列設定の保存
  function saveColumnConfiguration(spreadsheetId, sheetName, headers, columnMapping) {
    // 🎯 ConfigJson最適化: 重複防止の単一責任設計
    const timestamp = new Date().toISOString();

    const optimizedConfig = {
      spreadsheetId,
      sheetName,
      headers: headers, // トップレベルheaders（UI表示用）
      columnMapping: {
        ...columnMapping,
        headers: headers, // columnMapping内headers（システム利用）
        verifiedAt: timestamp // 検証時刻は論理的にmapping内のみ
      },
      setupComplete: true,
      etag: (systemState && systemState.config && systemState.config.etag) || undefined,
    };

    if (systemState && systemState.config) {
      Object.assign(optimizedConfig, systemState.config);
      // 最新のUI状態を最終的に適用（重複なし単一責任設計）
      optimizedConfig.spreadsheetId = spreadsheetId;
      optimizedConfig.sheetName = sheetName;
      optimizedConfig.headers = headers;
      optimizedConfig.columnMapping = {
        ...columnMapping,
        headers: headers,
        verifiedAt: timestamp // 統一されたタイムスタンプ
      };

      // 🎯 ConfigJson完全同期: Derived Fields自動更新
      const isSpreadsheetChanged = optimizedConfig.spreadsheetId !== systemState.config.spreadsheetId;
      if (isSpreadsheetChanged) {
        console.log('🔄 SpreadsheetId変更検出 - Derived Fields更新開始:', {
          oldId: systemState.config.spreadsheetId,
          newId: optimizedConfig.spreadsheetId
        });

        // sourceKey自動生成 (UserService.gsロジック準拠)
        optimizedConfig.sourceKey = 'sheet_' + optimizedConfig.spreadsheetId + '_' + Date.now();

        // spreadsheetUrl自動生成
        optimizedConfig.spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/' + optimizedConfig.spreadsheetId + '/edit';

        // 古いフォーム情報をクリア（新しいスプレッドシートでは異なる可能性）
        optimizedConfig.formUrl = null;
        optimizedConfig.formTitle = null;

        console.log('✅ Derived Fields更新完了:', {
          sourceKey: optimizedConfig.sourceKey,
          spreadsheetUrl: optimizedConfig.spreadsheetUrl,
          formCleared: 'フォーム情報クリア済み'
        });
      }

      // 🎯 Object.assign残存分クリーンアップ（最小限）
      if (optimizedConfig.verifiedAt) {
        delete optimizedConfig.verifiedAt; // columnMapping.verifiedAtのみ使用
      }

      // 🔗 フォーム自動連携: 既存フォーム検出・統合（安全版）
      if (!optimizedConfig.formUrl) {
        console.log('🔍 フォーム連携なし - 自動検出開始');

        google.script.run
          .withSuccessHandler(function(formResult) {
            if (formResult.success && formResult.formData && formResult.formData.formUrl) {
              optimizedConfig.formUrl = formResult.formData.formUrl;
              optimizedConfig.formTitle = formResult.formData.formTitle;
              console.log('✅ フォーム自動連携完了:', {
                formUrl: optimizedConfig.formUrl,
                formTitle: optimizedConfig.formTitle
              });
            } else {
              console.log('ℹ️ フォーム連携なし（通常状態）');
            }
            executeConfigSave();
          })
          .withFailureHandler(function(error) {
            console.warn('⚠️ フォーム自動検出エラー（安全に継続）:', error.message);
            executeConfigSave();
          })
          .getFormInfo(spreadsheetId, sheetName);
        return;
      }
    }

    // 通常の保存処理実行
    executeConfigSave();

    function executeConfigSave() {

    console.log('📋 完全同期Config保存準備:', {
      spreadsheetId: optimizedConfig.spreadsheetId,
      sheetName: optimizedConfig.sheetName,
      sourceKey: optimizedConfig.sourceKey,
      spreadsheetUrl: optimizedConfig.spreadsheetUrl,
      formUrl: optimizedConfig.formUrl || 'なし',
      formTitle: optimizedConfig.formTitle || 'なし',
      hasColumnMapping: !!optimizedConfig.columnMapping,
      setupComplete: optimizedConfig.setupComplete,
      configSize: JSON.stringify(optimizedConfig).length
    });

    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          console.log('✅ ConfigJson完全同期保存成功:', {
            spreadsheetId: optimizedConfig.spreadsheetId,
            sourceKey: optimizedConfig.sourceKey,
            spreadsheetUrl: optimizedConfig.spreadsheetUrl,
            formUrl: optimizedConfig.formUrl || 'なし',
            savedHeaders: headers.length,
            hasMapping: !!columnMapping,
            setupComplete: true,
            completeSyncStatus: '全フィールド更新完了'
          });

          // systemStateを更新
          if (systemState) {
            systemState.config = { ...systemState.config, ...optimizedConfig };
          }

          // UI状態を更新
          updateResourceButtons(optimizedConfig);
          showSuccess('✅ 列マッピング設定が完了しました');
        } else {
          if (result.error === 'etag_mismatch') {
            showInfo('設定が他で更新されました。画面を更新しました。もう一度保存してください。');
            if (typeof loadAndApplyCurrentConfig === 'function') {
              loadAndApplyCurrentConfig();
            }
          } else {
            console.warn('列設定の保存に失敗:', result.error);
          }
        }
      })
      .withFailureHandler(function (error) {
        console.error('列設定保存エラー:', error);
        showError('列設定の保存に失敗しました');
      })
      .saveDraftConfiguration(optimizedConfig);
    }
  }

  // 下書き保存
  function saveDraft() {
    if (!RequestGate.enter('saveDraft')) {
      showInfo('保存処理を実行中です…');
      return;
    }
    const config = gatherConfiguration();

    setLoading(true);
    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          showSuccess('下書きを保存しました');
          updateResourceButtons(result.config);
        } else {
          showError(result.error);
        }
        setLoading(false);
        RequestGate.exit('saveDraft');
      })
      .withFailureHandler(function (error) {
        console.error('保存エラー:', error);
        showError('下書きの保存に失敗しました');
        setLoading(false);
        RequestGate.exit('saveDraft');
      })
      .saveDraftConfiguration(config);
  }

  // アプリ公開（getConfig依存を削除して重複保存防止版）
  function publishApp() {
    if (!RequestGate.enter('publishApp')) {
      showInfo('公開処理を実行中です…');
      return;
    }

    setLoading(true);

    try {
      // 🔧 根本的修正: UI状態を直接使用（getConfig依存を削除して上書き競合回避）
      const config = gatherConfiguration();

      console.log('📋 publishApp: UI状態から設定収集:', {
        hasSpreadsheetId: !!config.spreadsheetId,
        hasSheetName: !!config.sheetName,
        configKeys: Object.keys(config)
      });

      if (!config || !config.spreadsheetId) {
        console.error('❌ publishApp: UI設定データが不完全:', {
          hasConfig: !!config,
          hasSpreadsheetId: !!(config?.spreadsheetId),
        });
        showError('まずデータソースを設定してください。');
        setLoading(false);
        RequestGate.exit('publishApp');
        return;
      }

      // 🚀 UI状態に基づく公開設定作成
      const sourceMethod = document.querySelector('input[name="source-method"]:checked')?.value || 'list';

      // 列マッピングを現在のsystemStateから取得（UI保存済みのもの）
      const columnMapping = (systemState && systemState.config && systemState.config.columnMapping) || {};

      const publishConfig = {
        // 🎯 UIの現在状態を反映
        spreadsheetId: config.spreadsheetId,
        sheetName: config.sheetName,
        columnMapping: columnMapping,
        etag: config.etag,

        // 🎯 UI設定（統一displaySettings形式）
        displaySettings: config.displaySettings,
      };

      console.log('📋 publishApp: UI状態反映publishConfig作成', {
        sourceMethod,
        spreadsheetId: config.spreadsheetId,
        sheetName: config.sheetName,
        hasColumnMapping: !!columnMapping,
        publishConfigKeys: Object.keys(publishConfig)
      });

      // 完全な設定でpublishApplicationを呼び出し
      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            showSuccess('アプリを公開しました！');
            updatePublishStatus('published');

            // 公開後に最新の設定を取得してボタン状態を更新
            console.log('📋 公開成功 - 最新設定を取得してボタン状態を更新');

            // 公開が成功したので、最新の設定を取得し直してボタン状態を更新
            google.script.run
              .withSuccessHandler(function(latestConfigResponse) {
                console.log('📋 最新設定取得結果:', latestConfigResponse);
                if (latestConfigResponse && latestConfigResponse.success && latestConfigResponse.config) {
                  updateResourceButtons(latestConfigResponse.config);
                } else {
                  // フォールバック: 手動で設定を構築
                  const updatedConfig = {
                    ...publishConfig,
                    appPublished: true,
                    publishedAt: result.publishedAt || new Date().toISOString(),
                    setupComplete: true
                  };
                  updateResourceButtons(updatedConfig);
                }
              })
              .withFailureHandler(function(error) {
                console.warn('最新設定取得に失敗:', error);
                // フォールバック: 手動で設定を構築
                const updatedConfig = {
                  ...publishConfig,
                  appPublished: true,
                  publishedAt: result.publishedAt || new Date().toISOString(),
                  setupComplete: true
                };
                updateResourceButtons(updatedConfig);
              })
              .getConfig();

            // ✅ 公開成功後：即座にフッターを更新（UX向上）
            setTimeout(() => {
              loadBoardInfo(); // フッター情報を再読み込み
            }, 500);
          } else {
            if (result.error === 'etag_mismatch') {
              showInfo('設定が他で更新されました。画面を更新してから再度公開してください。');
              if (typeof loadAndApplyCurrentConfig === 'function') {
                loadAndApplyCurrentConfig();
              }
            } else {
              showError(result.error);
            }
          }
          setLoading(false);
          RequestGate.exit('publishApp');
        })
        .withFailureHandler(function (error) {
          console.error('公開エラー:', error);
          showError(
            'アプリの公開に失敗しました。データソースが正しく設定されているか確認してください。'
          );
          setLoading(false);
          RequestGate.exit('publishApp');
        })
        .publishApplication(publishConfig);

    } catch (error) {
      console.error('❌ publishApp: UI設定収集エラー:', error);
      showError('設定の収集に失敗しました: ' + error.message);
      setLoading(false);
      RequestGate.exit('publishApp');
    }
  }

  // 設定収集（ドロップダウン式対応）
  function gatherConfiguration() {
    const sourceMethod = document.querySelector('input[name="source-method"]:checked').value;

    let spreadsheetId, sheetName;

    if (sourceMethod === 'url') {
      // URL入力方式
      const urlInput = document.getElementById('spreadsheet-url');
      const url = urlInput.value.trim();
      const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
      const match = url.match(spreadsheetRegex);

      if (match) {
        spreadsheetId = match[1];
      }
      sheetName = document.getElementById('sheet-name-input').value.trim();
    } else {
      // 一覧選択方式
      spreadsheetId = document.getElementById('spreadsheet-select').value;
      sheetName = document.getElementById('sheet-select').value;
    }

    console.log('📋 gatherConfiguration result:', {
      sourceMethod,
      spreadsheetId,
      sheetName,
      spreadsheetUrlValue: sourceMethod === 'url' ? document.getElementById('spreadsheet-url').value : 'N/A',
      spreadsheetSelectValue: sourceMethod === 'list' ? document.getElementById('spreadsheet-select').value : 'N/A'
    });

    // 🎯 必須データのみ送信（送信データ大幅削減）
    return {
      spreadsheetId,
      sheetName,
      displaySettings: {
        showNames: document.getElementById('show-names').checked,
        showReactions: document.getElementById('show-reactions').checked
      },
      etag: (systemState && systemState.config && systemState.config.etag) || undefined,
    };
  }

  // ドロップダウンから列選択情報を収集
  function gatherColumnSelections() {
    const dropdowns = {
      answer: document.getElementById('answer-column-select'),
      reason: document.getElementById('reason-column-select'),
      class: document.getElementById('class-column-select'),
      name: document.getElementById('name-column-select'),
    };

    const selections = {};
    let hasAnySelection = false;

    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;

      const selectedValue = dropdown.value;
      const isAI = dropdown.classList.contains('has-ai-selection');
      const isManual = dropdown.classList.contains('has-manual-selection');

      if (selectedValue !== '') {
        selections[columnType] = {
          columnIndex: parseInt(selectedValue),
          columnLabel: String.fromCharCode(65 + parseInt(selectedValue)) + '列',
          selectionType: isManual ? 'manual' : 'ai',
          confidence: getColumnConfidence(columnType),
        };
        hasAnySelection = true;
      }
    });

    // AI検出の元データも含める
    if (window.currentAIMapping) {
      selections._aiMapping = window.currentAIMapping;
    }

    selections._hasSelections = hasAnySelection;

    console.log('gatherColumnSelections:', selections);
    return selections;
  }

  // Get column confidence level
  function getColumnConfidence(columnType) {
    const elementId = columnType + '-confidence';
    const confidenceDiv = document.getElementById(elementId);
    if (!confidenceDiv || confidenceDiv.classList.contains('hidden')) {
      return 0;
    }

    const badge = confidenceDiv.querySelector('.confidence-badge');
    if (!badge) return 0;

    const text = badge.textContent;
    const match = text.match(/(\d+)%/);
    return match ? parseInt(match[1]) : badge.classList.contains('manual') ? 100 : 0;
  }

  // 旧updateConfigDisplay関数は削除済み - updateResourceButtons()を使用

  // 公開ステータス更新
  function updatePublishStatus(status) {
    const badge = document.querySelector('.status-badge.unpublished') || document.querySelector('.status-badge.published');
    if (badge) {
      badge.className = 'status-badge ' + status;
      badge.textContent = status === 'published' ? '公開中' : '未公開';
    }
  }

  // 設定サマリー更新（重複実行防止機能付き）
  let lastConfigUpdate = null;
  function updateConfigSummary(config) {
    try {
      // 同一の設定データでの重複実行を防ぐ
      const configHash = config ? JSON.stringify({
        appPublished: config.appPublished,
        spreadsheetId: config.spreadsheetId,
        spreadsheetName: config.spreadsheetName,
        sheetName: config.sheetName,
        lastModified: config.lastModified
      }) : 'null';

      if (lastConfigUpdate === configHash) {
        return;
      }
      lastConfigUpdate = configHash;

      // 公開ステータス更新
      const appPublished = config?.appPublished === true || config?.appPublished === 'true';
      const publishBadge = document.getElementById('app-publish-status');
      if (publishBadge) {
        if (appPublished) {
          publishBadge.className = 'status-badge published';
          publishBadge.textContent = '公開中';
        } else {
          publishBadge.className = 'status-badge unpublished';
          publishBadge.textContent = '未公開';
        }
      }

      // データソース更新
      const datasourceElement = document.getElementById('current-datasource');
      if (datasourceElement) {
        if (config?.spreadsheetId) {
          const name = config.spreadsheetName || 'スプレッドシート';
          datasourceElement.textContent = name;
          datasourceElement.className = 'text-sm text-cyan-400';
        } else {
          datasourceElement.textContent = '未設定';
          datasourceElement.className = 'text-sm text-gray-400';
        }
      }

      // シート名更新
      const sheetnameElement = document.getElementById('current-sheetname');
      if (sheetnameElement) {
        if (config?.sheetName) {
          sheetnameElement.textContent = config.sheetName;
          sheetnameElement.className = 'text-sm text-cyan-400';
        } else {
          sheetnameElement.textContent = '未設定';
          sheetnameElement.className = 'text-sm text-gray-400';
        }
      }

      // 最終更新時刻更新
      const lastUpdated = config?.lastModified || config?.updatedAt;
      const timeElement = document.getElementById('last-updated-time');
      if (timeElement) {
        if (lastUpdated) {
          try {
            const date = new Date(lastUpdated);
            const timeString = date.toLocaleString('ja-JP', {
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
            });
            timeElement.textContent = timeString;
            timeElement.className = 'text-sm text-gray-300';
          } catch (e) {
            timeElement.textContent = '--:--';
          }
        } else {
          timeElement.textContent = '--:--';
        }
      }

      // スプレッドシートリンク更新（リソースセクション用）
      const openSheetBtn = document.getElementById('open-spreadsheet-btn');
      if (openSheetBtn && config?.spreadsheetId) {
        openSheetBtn.disabled = false;
        openSheetBtn.onclick = () => {
          const spreadsheetUrl =
            'https://docs.google.com/spreadsheets/d/' + config.spreadsheetId + '/edit';
          window.open(spreadsheetUrl, '_blank');
              };
        openSheetBtn.style.pointerEvents = 'auto';
      } else if (openSheetBtn) {
        openSheetBtn.onclick = (e) => {
          e.preventDefault();
          showError('スプレッドシートを選択してください');
        };
        openSheetBtn.style.opacity = '0.5';
        openSheetBtn.style.pointerEvents = 'auto';
      }
    } catch (error) {
      console.error('updateConfigSummary エラー:', error);
    }
  }

  // =============================================================================
  // フッター：現在のボード情報表示機能
  // =============================================================================

  // グローバル変数
  let currentBoardInfo = null;

  // ボード情報ロード
  function loadBoardInfo() {
    google.script.run
      .withSuccessHandler(function (boardInfo) {
        currentBoardInfo = boardInfo;
        updateFooterDisplay(boardInfo);
      })
      .withFailureHandler(function (error) {
        console.error('ボード情報取得エラー:', error);
        updateFooterDisplay({
          isActive: false,
          questionText: '情報取得エラー',
          error: error.message,
        });
      })
      .getBoardInfo();
  }

  // フッター表示更新
  function updateFooterDisplay(boardInfo) {
    const footer = document.getElementById('boardInfoFooter');
    const questionText = document.getElementById('currentQuestionText');
    const openBtn = document.getElementById('openBoardBtn');
    const copyBtn = document.getElementById('copyViewUrlBtn');
    const statusText = document.getElementById('boardStatus');

    // ✅ configJSON中心型：統一データソースからの公開状態チェック
    const isPublished = Boolean(
      boardInfo.appPublished === true ||
        boardInfo.appPublished === 'true' ||
        boardInfo.appPublished === '1' ||
        boardInfo.isActive === true
    );

    console.log('🔍 フッター表示判定:', {
      appPublished: boardInfo.appPublished,
      isActive: boardInfo.isActive,
      isPublished: isPublished,
      timestamp: new Date().toISOString(),
    });

    if (!isPublished) {
      footer.classList.add('hidden');
      return;
    }

    // 公開時はフッターを表示
    footer.classList.remove('hidden');

    // 問題文設定
    questionText.textContent = boardInfo.questionText || 'エラーが発生しました';

    if (boardInfo.isActive && boardInfo.urls) {
      // ボタン表示・機能設定
      openBtn.style.display = 'block';
      copyBtn.style.display = 'block';

      openBtn.onclick = () => window.open(boardInfo.urls.view, '_blank');
      copyBtn.onclick = () => copyViewUrl(boardInfo.urls.view);

      // ステータス更新
      if (statusText) {
        statusText.textContent = '最終更新: ' + (boardInfo.lastUpdated || '不明');
      }
    } else {
      // 非アクティブ状態
      openBtn.style.display = 'none';
      copyBtn.style.display = 'none';
      if (statusText) {
        statusText.textContent = boardInfo.error || 'ボードが非アクティブです';
      }
    }
  }

  // 日時フォーマット関数
  function formatDate(dateString) {
    if (!dateString) return '--';
    try {
      const date = new Date(dateString);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      });
    } catch (e) {
      return '--';
    }
  }

  // URLコピー機能（実用重視）
  function copyViewUrl(url) {
    if (!url) {
      showError('コピーするURLがありません');
      return;
    }

    // クリップボードにコピー
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard
        .writeText(url)
        .then(() => {
          showSuccess('閲覧用URLをコピーしました！');
          // ボタンを一時的に変更してフィードバック
          const btn = document.getElementById('copyViewUrlBtn');
          const originalText = btn.textContent;
          btn.textContent = '✅ コピー完了';
          btn.disabled = true;
          setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }, 2000);
        })
        .catch(() => {
          fallbackCopyUrl(url);
        });
    } else {
      fallbackCopyUrl(url);
    }
  }

  // フォールバック（古いブラウザ用）
  function fallbackCopyUrl(url) {
    const textarea = document.createElement('textarea');
    textarea.value = url;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      showSuccess('閲覧用URLをコピーしました！');
    } catch (err) {
      // 最終手段：URLを表示して手動コピーを促す
      prompt('以下のURLをコピーしてください:', url);
    }
    document.body.removeChild(textarea);
  }

  // アプリケーション名自動生成機能は削除（CLAUDE.md準拠）

  // 回答ボードを開く
  function openAnswerBoard() {
    google.script.run
      .withSuccessHandler(function (result) {
        if (result && result.appUrl) {
          window.open(result.appUrl, '_blank');
        } else {
          showError('回答ボードのURLが取得できませんでした');
        }
      })
      .withFailureHandler(function (error) {
        showError('回答ボードを開けませんでした: ' + error.message);
      })
      .getBoardInfo();
  }

  // アプリ設定画面を開く
  function openAppSetup() {
    try {
      setPartialLoading(true, 'アプリ設定画面に移動中...');

      // Google Apps Script WebApp URL取得してappSetupモードで遷移
      google.script.run
        .withSuccessHandler(function (webAppUrl) {
          const setupUrl = webAppUrl + '?mode=appSetup';
          console.log('アプリ設定画面への遷移:', setupUrl);

          // Google Apps Script環境では window.open(_top) を使用
          window.open(setupUrl, '_top');
        })
        .withFailureHandler(function (error) {
          console.error('WebApp URL取得エラー:', error);
          setPartialLoading(false);
          showError('アプリ設定画面への移動に失敗しました');

          // フォールバック: 現在のURLベースで遷移
          try {
            const currentUrl = new URL(window.location.href);
            const baseUrl = currentUrl.origin + currentUrl.pathname;
            const setupUrl = baseUrl + '?mode=appSetup';
            console.log('フォールバック遷移:', setupUrl);
            window.open(setupUrl, '_top');
          } catch (fallbackError) {
            console.error('フォールバック遷移も失敗:', fallbackError);
          }
        })
        .getWebAppUrl();

    } catch (error) {
      console.error('openAppSetup error:', error);
      showError('アプリ設定画面への移動に失敗しました');
      setPartialLoading(false);
    }
  }

</script>
