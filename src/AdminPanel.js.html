<script>
  // Safe template variable extraction from data attributes
  let __USER_ID__ = '';
  if (typeof __USER_ID__ !== 'undefined') {
    // __USER_ID__ is already defined
  }
  try {
    const appData = document.getElementById('app-data');
    if (appData) {
      __USER_ID__ = appData.getAttribute('data-user-id') || '';
    }
  } catch (error) {
    __USER_ID__ = '';
  }

  // === SECTION SEPARATOR ===

  /**
   * CLAUDE.mdæº–æ‹ : Promise-based delay utility
   * setTimeout/setIntervalã®ä»£æ›¿ã¨ã—ã¦ä½¿ç”¨
   */
  const createPromiseDelay = (ms) => {
    return new Promise(resolve => {
      if (typeof requestIdleCallback !== 'undefined') {
        requestIdleCallback(() => resolve(), { timeout: ms });
      } else {
        // Fallback for environments without requestIdleCallback
        const start = Date.now();
        const checkTime = () => {
          if (Date.now() - start >= ms) {
            resolve();
          } else {
            // Use a minimal recursion with immediate callback
            Promise.resolve().then(checkTime);
          }
        };
        checkTime();
      }
    });
  };

  /**
   * è¨­å®šå€¤æ¨™æº–åŒ–ãƒ˜ãƒ«ãƒ‘ãƒ¼ - å‹æ•´åˆæ€§ä¿è¨¼
   */
  const ConfigHelpers = {
    /**
     * è¨­å®šãƒ–ãƒ¼ãƒ«å€¤ã®çµ±ä¸€ãƒã‚§ãƒƒã‚¯
     * æ–‡å­—åˆ—ãƒ»æ•°å€¤ãƒ»ãƒ–ãƒ¼ãƒ«ã®æ··åœ¨ã«å¯¾å¿œ
     */
    isConfigTrue(value) {
      return Boolean(value === true || value === 'true' || value === '1' || value === 1);
    },

    /**
     * è¨­å®šãƒ–ãƒ¼ãƒ«å€¤ã®çµ±ä¸€ãƒã‚§ãƒƒã‚¯ï¼ˆå…¬é–‹çŠ¶æ…‹å°‚ç”¨ï¼‰
     */
    isPublished(config) {
      return this.isConfigTrue(config?.isPublished) || this.isConfigTrue(config?.isActive);
    }
  };

  /**
   * DOMæ“ä½œã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ - AdminPanelç‰ˆ
   */
  const DOMHelpers = {
    safeGetById(id, context = '') {
      try {
        const element = document.getElementById(id);
        if (!element && context) {
          console.warn(`DOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${id} (${context})`);
        }
        return element;
      } catch (error) {
        console.error(`DOMè¦ç´ å–å¾—ã‚¨ãƒ©ãƒ¼: ${id}`, error);
        return null;
      }
    },

    safeSetValue(id, value, property = 'value') {
      const element = this.safeGetById(id, 'value setting');
      if (element && property in element) {
        element[property] = value;
        return true;
      }
      return false;
    },

    safeGetValue(id, property = 'value', fallback = '') {
      const element = this.safeGetById(id, 'value getting');
      return (element && property in element) ? element[property] : fallback;
    },

    safeSetContent(id, content, method = 'textContent') {
      const element = this.safeGetById(id, 'content setting');
      if (element && method in element) {
        element[method] = content;
        return true;
      }
      return false;
    },

    safeAddEventListener(id, event, handler, options = {}) {
      const element = this.safeGetById(id, 'event listener');
      if (element && typeof handler === 'function') {
        element.addEventListener(event, handler, options);
        return true;
      }
      return false;
    }
  };

  /**
   * GASé–¢æ•°å‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼ - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ã
   */
  const GASHelper = {
    retryCount: 0,
    maxRetries: 3,

    async callGAS(funcName, ...args) {
      return new Promise((resolve, reject) => {
        if (typeof google === 'undefined' || !google.script?.run) {
          reject(new Error('Google Apps Scriptç’°å¢ƒãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'));
          return;
        }

        google.script.run
          .withSuccessHandler((result) => {
            this.retryCount = 0;
            resolve(result);
          })
          .withFailureHandler((error) => {
            console.error(`GASé–¢æ•°å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: ${funcName}`, error);
            
            const isRetryable = this.isRetryableError(error);
            
            if (isRetryable && this.retryCount < this.maxRetries) {
              this.retryCount++;
              console.warn(`ãƒªãƒˆãƒ©ã‚¤å®Ÿè¡Œ: ${this.retryCount}/${this.maxRetries} (${funcName})`);
              
              // âœ… CLAUDE.mdæº–æ‹ : Promise-based exponential backoff
              (async () => {
                try {
                  await createPromiseDelay(Math.pow(2, this.retryCount) * 1000);
                  const result = await this.callGAS(funcName, ...args);
                  resolve(result);
                } catch (retryError) {
                  reject(retryError);
                }
              })();
            } else {
              this.retryCount = 0;
              reject(this.normalizeError(error, funcName));
            }
          })
          [funcName](...args);
      });
    },

    isRetryableError(error) {
      const errorString = String(error).toLowerCase();
      const retryablePatterns = [
        'timeout',
        'network',
        'connection',
        'temporary',
        'service unavailable',
        'internal error'
      ];
      
      return retryablePatterns.some(pattern => errorString.includes(pattern));
    },

    normalizeError(error, funcName) {
      if (error instanceof Error) {
        return error;
      }
      
      const message = typeof error === 'string' ? error : 
                     error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      
      const normalizedError = new Error(`${funcName}: ${message}`);
      normalizedError.originalError = error;
      normalizedError.functionName = funcName;
      
      return normalizedError;
    }
  };

  // çµ±ä¸€çŠ¶æ…‹ç®¡ç†ï¼ˆä¸€å…ƒåŒ–ï¼‰
  let systemState = {
    loading: false,
    config: null,
    spreadsheetList: null,
    sheetList: null,
    initialized: false,
    currentSpreadsheetId: null,
    currentSheetName: null,
    userInfo: null,
    initializationStep: 'not started',
  };

  // ===== å†ªç­‰ãƒ»é‡è¤‡é˜²æ­¢ï¼ˆãƒ¢ãƒ€ãƒ³ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒŸãƒ¥ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹ï¼‰ =====
  const ClientMutex = {
    locks: Object.create(null),
    acquire(key) {
      if (this.locks[key]) return false;
      this.locks[key] = true;
      return true;
    },
    release(key) {
      this.locks[key] = false;
    },
  };

  // âœ… CLAUDE.mdæº–æ‹ : Promise-based debounce mechanism
  const Debounce = (() => {
    const promises = new Map();
    const cancellations = new Map();

    return {
      async run(key, delay, fn) {
        // Cancel existing operation for this key
        if (cancellations.has(key)) {
          cancellations.get(key)();
          cancellations.delete(key);
        }

        // Create cancellation flag
        let isCancelled = false;
        cancellations.set(key, () => { isCancelled = true; });

        // Create new promise-based delay
        const promise = createPromiseDelay(delay).then(async () => {
          cancellations.delete(key);
          promises.delete(key);

          if (!isCancelled) {
            try {
              if (typeof fn === 'function') {
                await fn();
              }
            } catch (e) {
              console.error('Debounce error', e);
            }
          }
        });

        promises.set(key, promise);
        return promise;
      },
    };
  })();

  // URLæ¤œè¨¼é–¢æ•°
  function isValidFormUrl(url) {
    if (!url || typeof url !== 'string') return false;
    try {
      const urlObj = new URL(url.trim());
      if (urlObj.protocol !== 'https:') return false;
      const validHosts = ['docs.google.com', 'forms.gle'];
      if (urlObj.hostname === 'docs.google.com') {
        // Match backend logic: support both /forms/ and /viewform for comprehensive Google Forms URL support
        return urlObj.pathname.includes('/forms/') || urlObj.pathname.includes('/viewform');
      }
      return validHosts.includes(urlObj.hostname);
    } catch {
      return false;
    }
  }

  // Wrap initialization in safe handler
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', safeInitialize);
  } else {
    // DOM already loaded, initialize immediately
    safeInitialize();
  }

  async function safeInitialize() {
    systemState.initializationStep = 'started';

    try {
      systemState.initializationStep = 'panel initialization';
      await initializePanel();

      systemState.initializationStep = 'admin check';
      checkAdministratorAccess();

      systemState.initializationStep = 'footer initialization';
      initializeFooter();

      systemState.initializationStep = 'completed';
      systemState.initialized = true;
    } catch (error) {
      // Try to show error even if UI is not fully initialized
      try {
        showError('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + systemState.initializationStep + ' - ' + error.message);
      } catch (uiError) {
        alert('ç®¡ç†ãƒ‘ãƒãƒ«ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }
    }
  }

  // ãƒ•ãƒƒã‚¿ãƒ¼åˆæœŸåŒ–
  function initializeFooter() {
    // åˆå›ãƒœãƒ¼ãƒ‰æƒ…å ±ãƒ­ãƒ¼ãƒ‰
    loadBoardInfo();

    // æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©è¨­å®š
    const refreshBtn = document.getElementById('refreshBoardInfo');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', loadBoardInfo);
    }

    // body paddingèª¿æ•´ï¼ˆãƒ•ãƒƒã‚¿ãƒ¼åˆ†ã®ä½™ç™½ã‚’è¿½åŠ ï¼‰
    document.body.classList.add('has-footer');
  }

  // ãƒ‘ãƒãƒ«åˆæœŸåŒ–ï¼ˆçµ±ä¸€configå–å¾—ç‰ˆï¼‰
  async function initializePanel() {
    let step = 'starting';

    try {
      setLoading(true);

      // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿
      step = 'loading user info';
      systemState.userInfo = await loadUserInfoAsync();

      // 2. è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’1å›ã ã‘å–å¾—ã—ã¦systemStateã«ä¿å­˜
      step = 'loading config';
      const configResponse = await getConfigAsync();
      console.log('ğŸ“Š initializePanel: è¨­å®šãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†', configResponse);
      // ğŸ”§ CLAUDE.mdæº–æ‹ : å®‰å…¨ãªè¨­å®šçŠ¶æ…‹æ›´æ–°
      systemState.config = configResponse?.success ? { ...configResponse.config } : null;

      // 3. URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯ã¨é©ç”¨
      step = 'checking URL params';
      const urlSpreadsheet = getSpreadsheetFromUrl();
      if (urlSpreadsheet) {
        // URL ã®æƒ…å ±ã‚’è¨­å®šã«çµ±åˆ
        if (systemState.config) {
          systemState.config.spreadsheetId = urlSpreadsheet.spreadsheetId;
          if (urlSpreadsheet.spreadsheetUrl) {
            systemState.config.spreadsheetUrl = urlSpreadsheet.spreadsheetUrl;
          }
        } else {
          // ğŸ”§ CLAUDE.mdæº–æ‹ : æœ€ä½é™è¨­å®šã®å®‰å…¨ãªä½œæˆ
          systemState.config = {
            userId: null, // å¾Œã§è¨­å®šã•ã‚Œã‚‹
            setupStatus: 'pending',
            spreadsheetId: urlSpreadsheet.spreadsheetId,
            spreadsheetUrl: urlSpreadsheet.spreadsheetUrl || null,
            isPublished: false
          };
        }
      }

      // 4. åŸºæœ¬è¨­å®šã®åæ˜ 
      step = 'applying config';
      if (systemState.config) {
        if (systemState.config.sheetName) {
          await autoSelectSheet(systemState.config.sheetName);
        }
        applyExistingConfig(systemState.config);
        updateProgressFromConfig(systemState.config);
      }

      // 5. ãƒªã‚½ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ã¨ã‚µãƒãƒªãƒ¼æ›´æ–°
      step = 'updating UI';
      updateResourceButtons(systemState.config);
      updateConfigSummary(systemState.config);

      // 6. ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®åˆæœŸåŒ–ï¼ˆsystemState.configã‚’ä½¿ç”¨ï¼‰
      step = 'initializing dropdowns';
      await initializeDropdowns();

    } catch (error) {
      showError('ç”»é¢ã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  }

  // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ï¼ˆé…å»¶èª­ã¿è¾¼ã¿å¯¾å¿œï¼‰
  async function initializeDropdowns() {
    const spreadsheetSelect = document.getElementById('spreadsheet-select');
    const sheetSelect = document.getElementById('sheet-select');

    if (!spreadsheetSelect) return;

    try {
      // systemStateã‹ã‚‰è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼ˆé‡è¤‡å–å¾—ã‚’å›é¿ï¼‰
      const config = systemState.config;

      // ğŸš€ æœ€é©åŒ–: è¨­å®šæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è»½é‡å¾©å…ƒãƒ¢ãƒ¼ãƒ‰
      if (config?.spreadsheetId && config?.sheetName && config?.columnMapping?.mapping) {
        console.log('ğŸ“‹ è¨­å®šæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼: è»½é‡å¾©å…ƒãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ');

        // æ—¢å­˜è¨­å®šã®ç›´æ¥å¾©å…ƒï¼ˆé‡ã„APIå‘¼ã³å‡ºã—ãªã—ï¼‰
        // ğŸ”§ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: å˜ä¸€innerHTMLæ“ä½œã§DOM reflowå‰Šæ¸›
        const spreadsheetName = config.spreadsheetName || config.spreadsheetId;
        spreadsheetSelect.innerHTML = `
          <option value="">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="${config.spreadsheetId}" selected>ç¾åœ¨ã®è¨­å®š: ${spreadsheetName}</option>
        `;
        spreadsheetSelect.value = config.spreadsheetId;

        // ğŸ”§ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ã‚·ãƒ¼ãƒˆé¸æŠã‚‚å˜ä¸€innerHTMLæ“ä½œã§æœ€é©åŒ–
        if (sheetSelect) {
          sheetSelect.innerHTML = `
            <option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="${config.sheetName}" selected>${config.sheetName}</option>
          `;
          sheetSelect.value = config.sheetName;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        setupChangeEvents();
        setupDataSourceRadioEvents();

        // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶šã«ã‚ˆã‚‹åˆ—è¨­å®šåˆæœŸåŒ–
        await setupColumns(config.spreadsheetId, config.sheetName);
        return; // é‡ã„å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦çµ‚äº†
      }

      // æœªè¨­å®šãƒ¦ãƒ¼ã‚¶ãƒ¼: å¾“æ¥ã®ãƒ•ãƒ«åˆæœŸåŒ–
      console.log('ğŸ”„ æœªè¨­å®šãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ•ãƒ«åˆæœŸåŒ–å®Ÿè¡Œ');
      spreadsheetSelect.innerHTML = '<option value="">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

      if (config && config.spreadsheetId) {
        // æ—¢å­˜ã®è¨­å®šãŒã‚ã‚‹å ´åˆã¯ã€ãã®é …ç›®ã ã‘ã‚’è¿½åŠ 
        const option = document.createElement('option');
        option.value = config.spreadsheetId;
        option.textContent = 'ç¾åœ¨ã®è¨­å®š: ' + (config.spreadsheetName || config.spreadsheetId);
        spreadsheetSelect.appendChild(option);
        spreadsheetSelect.value = config.spreadsheetId;

        // è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        if (config.spreadsheetId) {
          await loadSheetList(config.spreadsheetId);
          if (config.sheetName && sheetSelect) {
            sheetSelect.value = config.sheetName;
          }
        }
      }

      // ã‚·ãƒ³ãƒ—ãƒ«ãªchangeã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      setupChangeEvents();

      // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      setupDataSourceRadioEvents();

      // 7. åˆ—è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®åˆæœŸåŒ–
      if (config && config.spreadsheetId && config.sheetName) {
        try {
          await setupColumns(config.spreadsheetId, config.sheetName);
        } catch (columnError) {
          console.error('åˆ—è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', columnError);
          showInfo('âš ï¸ åˆ—è¨­å®šã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ä»–ã®æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã™ã€‚');
          // åˆ—è¨­å®šåˆæœŸåŒ–ã«å¤±æ•—ã—ã¦ã‚‚ä»–ã®å‡¦ç†ã¯ç¶šè¡Œ
        }
      }
    } catch (error) {
      console.error('ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      if (spreadsheetSelect) {
        spreadsheetSelect.innerHTML = '<option value="">åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ - å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„</option>';
      }
      showError('ç®¡ç†ãƒ‘ãƒãƒ«ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    }
  }

  // åˆ—è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–é–¢æ•° - ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ
  async function setupColumns(spreadsheetId, sheetName) {
    // äº‹å‰ã«ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢
    clearColumnDropdowns();

    try {
      console.log('ğŸ”§ setupColumns: åˆ—è¨­å®šã‚’åˆæœŸåŒ–ä¸­:', { spreadsheetId, sheetName });

      // ã‚·ãƒ³ãƒ—ãƒ«ãƒ•ãƒ­ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶š â†’ åˆ—æƒ…å ±å–å¾— â†’ UIåæ˜ 
      const analysisResult = await getColumnAnalysis(spreadsheetId, sheetName);

      if (!analysisResult || !analysisResult.success) {
        console.warn('âš ï¸ åˆ—åˆ†æã«å¤±æ•— - ç©ºç™½çŠ¶æ…‹ã‚’ç¶­æŒ');
        return;
      }

      if (!analysisResult.headers || !Array.isArray(analysisResult.headers) || analysisResult.headers.length === 0) {
        console.warn('âš ï¸ ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ãŒç„¡åŠ¹ - ç©ºç™½çŠ¶æ…‹ã‚’ç¶­æŒ');
        return;
      }

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ãƒ˜ãƒƒãƒ€ãƒ¼é¸æŠè‚¢ã‚’è¨­å®š
      fillColumnDropdowns(analysisResult.headers, analysisResult.mapping, analysisResult.confidence);

      console.log('âœ… åˆ—è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–å®Œäº†');
    } catch (error) {
      console.error('âŒ åˆ—è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // åˆ—ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç©ºç™½çŠ¶æ…‹ã«ã‚¯ãƒªã‚¢
  function clearColumnDropdowns() {
    const dropdownIds = ['answer-column-select', 'reason-column-select', 'class-column-select', 'name-column-select'];

    dropdownIds.forEach(id => {
      const dropdown = document.getElementById(id);
      if (dropdown) {
        dropdown.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„...</option>';
      }
    });

    console.log('ğŸ“‹ åˆ—ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç©ºç™½çŠ¶æ…‹ã«ã‚¯ãƒªã‚¢');
  }

  // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  function setupDataSourceRadioEvents() {
    const radioButtons = document.querySelectorAll('input[name="source-method"]');
    console.log('ğŸ” [setupDataSourceRadioEvents] Found radio buttons:', radioButtons.length);
    let spreadsheetListLoaded = false;

    if (radioButtons.length === 0) {
      console.warn('âš ï¸ [setupDataSourceRadioEvents] source-method radio buttons not found');
      return;
    }

    radioButtons.forEach((radio) => {
      radio.addEventListener('change', async function () {
        console.log('ğŸ”˜ [RadioEvent] Changed to:', this.value, 'listLoaded:', spreadsheetListLoaded);
        if (this.value === 'dropdown' && !spreadsheetListLoaded) {
          // ã€Œä¸€è¦§ã‹ã‚‰é¸æŠã€ãŒé¸æŠã•ã‚ŒãŸæ™‚ã®ã¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
          console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');
          setPartialLoading(true, 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—ä¸­...');
          try {
            await loadSpreadsheets();
            spreadsheetListLoaded = true;
          } catch (error) {
            console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“');
          } finally {
            setPartialLoading(false);
          }
        }
      });
    });
  }

  // ğŸ¯ ã‚·ãƒ³ãƒ—ãƒ«ãªchangeã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  function setupChangeEvents() {
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé¸æŠæ™‚ â†’ ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
    DOMHelpers.safeAddEventListener('spreadsheet-select', 'change', function () {
      const spreadsheetId = this.value;
      if (spreadsheetId) {
        loadSheetList(spreadsheetId);
      } else {
        resetSheetSelect();
      }
    });
  }

  // ã‚·ãƒ¼ãƒˆé¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
  function resetSheetSelect() {
    const sheetSelect = DOMHelpers.safeGetById('sheet-select', 'sheet select reset');
    if (sheetSelect) {
      sheetSelect.innerHTML = '<option value="">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    }
  }

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿ï¼ˆéåŒæœŸç‰ˆï¼‰
  function loadSpreadsheets() {
    return new Promise((resolve, reject) => {
      const select = DOMHelpers.safeGetById('spreadsheet-select', 'spreadsheet list loading');
      if (!select) {
        reject(new Error('spreadsheet-select element not found'));
        return;
      }

      select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';

      // ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰èª­ã¿è¾¼ã¿ã¯éƒ¨åˆ†ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
      setPartialLoading(true, 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');

      google.script.run
        .withSuccessHandler(function (result) {
          // âœ… Phase 2: ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†æ”¹å–„ã¨nullå¯¾å¿œå¼·åŒ–
          console.log('ğŸ“Š å—ä¿¡ã—ãŸç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
          console.log('ğŸ“Š ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°:', {
            type: typeof result,
            isNull: result === null,
            isUndefined: result === undefined,
            isArray: Array.isArray(result),
            hasSpreadsheets: result && typeof result.spreadsheets !== 'undefined',
            spreadsheetsType: result && typeof result.spreadsheets,
            spreadsheetsLength: result && result.spreadsheets ? result.spreadsheets.length : 'undefined',
            success: result && result.success,
            keys: result ? Object.keys(result) : [],
            rawResultString: JSON.stringify(result)
          });

          // âœ… å¼·åŒ–ã•ã‚ŒãŸnull/undefinedå¯¾å¿œ
          if (result === null || result === undefined) {
            console.error('ğŸ“Š null/undefinedãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ - google.script.runé€ä¿¡å•é¡Œ');
            select.innerHTML = '<option value="">é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆnull responseï¼‰</option>';
            setPartialLoading(false);
            reject(new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰nullãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚main.gs:getSheets()ã®å®Ÿè¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'));
            return;
          }

          // âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã®å³å¯†æ¤œè¨¼
          if (typeof result !== 'object') {
            console.error('ğŸ“Š éã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹:', { resultType: typeof result, result });
            select.innerHTML = '<option value="">ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼</option>';
            setPartialLoading(false);
            reject(new Error(`ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼: ${typeof result}`));
            return;
          }

          // âœ… ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‡¦ç†
          if (result.success === false) {
            console.warn('ğŸ“Š ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', result.message || result.error);
            select.innerHTML = `<option value="">${result.message || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼'}</option>`;
            setPartialLoading(false);
            reject(new Error(result.message || result.error || 'ã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
            return;
          }

          // âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã®ç¢ºèªï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹é…åˆ—ã‹ï¼‰
          const spreadsheets = Array.isArray(result)
            ? result
            : result && Array.isArray(result.spreadsheets)
              ? result.spreadsheets
              : result && Array.isArray(result.sheets)
                ? result.sheets
                : [];

          console.log('ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé…åˆ—æŠ½å‡ºå®Œäº†:', {
            isDirectArray: Array.isArray(result),
            hasSpreadsheetsProp: result && Array.isArray(result.spreadsheets),
            hasSheetsProperty: result && Array.isArray(result.sheets),
            extractedLength: spreadsheets.length
          });

          // ğŸ¯ æ—¢å­˜ã®é¸æŠå€¤ã‚’ä¿æŒ
          const currentValue = select.value;
          const wasPrePopulated = select.querySelector('[selected]');

          select.innerHTML = '<option value="">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';

          // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼ˆnullå®‰å…¨ï¼‰
          console.log('ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§å—ä¿¡:', {
            resultType: Array.isArray(result) ? 'array' : typeof result,
            count: spreadsheets.length,
            cached: (result && result.cached) || false,
            executionTime: (result && result.executionTime) || 'N/A',
            editorFiltered: true,
          });

          if (spreadsheets && Array.isArray(spreadsheets) && spreadsheets.length > 0) {
            spreadsheets.forEach((sheet) => {
              const option = document.createElement('option');
              option.value = sheet.id;
              option.textContent = sheet.name;

              // ğŸ”„ äº‹å‰å…¥åŠ›ã•ã‚Œã¦ã„ãŸå€¤ã‚’å†é¸æŠ
              if (currentValue && currentValue === sheet.id) {
                option.selected = true;
              }

              // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’dataå±æ€§ã¨ã—ã¦ä¿å­˜
              if (sheet.formUrl) {
                option.dataset.formUrl = sheet.formUrl;
                option.dataset.formTitle = sheet.formTitle || 'ãƒ•ã‚©ãƒ¼ãƒ ';
              }

              select.appendChild(option);
            });

            // ğŸ“‹ äº‹å‰å…¥åŠ›ã•ã‚ŒãŸè¨­å®šãŒãƒªã‚¹ãƒˆã«ãªã„å ´åˆã¯è¿½åŠ 
            if (wasPrePopulated && !select.querySelector(`option[value="${currentValue}"]`)) {
              const prePopulatedText = wasPrePopulated.textContent;
              const preserveOption = document.createElement('option');
              preserveOption.value = currentValue;
              preserveOption.textContent = prePopulatedText;
              preserveOption.selected = true;
              select.appendChild(preserveOption);
            }
          } else if (Array.isArray(spreadsheets) && spreadsheets.length === 0) {
            // âœ… ç©ºé…åˆ—ã®é©åˆ‡ãªå‡¦ç†
            const noDataOption = document.createElement('option');
            noDataOption.value = '';
            noDataOption.textContent = 'ã‚ãªãŸãŒæ‰€æœ‰ã™ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“';
            noDataOption.disabled = true;
            select.appendChild(noDataOption);
            console.log('ğŸ“Š ã‚ªãƒ¼ãƒŠãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœ: 0ä»¶ï¼ˆç©ºé…åˆ—ï¼‰');
          } else if (!Array.isArray(spreadsheets)) {
            // âœ… é…åˆ—ã§ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            console.error('ğŸ“Š spreadsheets ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', {
              spreadsheetsType: typeof spreadsheets,
              spreadsheets: spreadsheets,
              originalResult: result
            });
            const errorOption = document.createElement('option');
            errorOption.value = '';
            errorOption.textContent = 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚¨ãƒ©ãƒ¼ï¼ˆé…åˆ—ã§ãªã„ï¼‰';
            errorOption.disabled = true;
            select.appendChild(errorOption);
          } else {
            // âœ… ãã®ä»–ã®äºˆæœŸã—ãªã„çŠ¶æ³
            console.error('ğŸ“Š äºˆæœŸã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ :', {
              result,
              spreadsheets,
              spreadsheetsIsArray: Array.isArray(spreadsheets),
              spreadsheetsLength: spreadsheets ? spreadsheets.length : 'N/A'
            });
            const errorOption = document.createElement('option');
            errorOption.value = '';
            errorOption.textContent = 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚¨ãƒ©ãƒ¼';
            errorOption.disabled = true;
            select.appendChild(errorOption);
          }

          setPartialLoading(false);
          resolve(spreadsheets);
        })
        .withFailureHandler(function (error) {
          select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
          setPartialLoading(false);

          console.error('ğŸ“Š getSheetsé€šä¿¡ã‚¨ãƒ©ãƒ¼:', {
            error: error,
            errorMessage: error.message,
            errorType: typeof error,
            errorStack: error.stack
          });

          let detailedMessage;
          if (error.message && error.message.includes('not initialized')) {
            detailedMessage = 'ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ä¸­ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
            console.warn('ğŸ”„ ServiceRegistryåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼æ¤œå‡º - ãƒªãƒ­ãƒ¼ãƒ‰æ¨å¥¨');
          } else {
            detailedMessage = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
          }

          reject(new Error(detailedMessage));
        })
        .getSheets();
    });
  }

  function loadSpreadsheetList() {
    loadSpreadsheets();
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿ï¼ˆéåŒæœŸç‰ˆï¼‰
  function loadUserInfoAsync() {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(function (resp) {
          try {
            let email = '';
            if (resp && typeof resp === 'object') {
              email = resp.email || resp.value || '';
            } else if (typeof resp === 'string') {
              email = resp;
            }
            email = String(email || '').trim();

            if (email) {
              document.getElementById('current-user-email').textContent = email;

              // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¡¨ç¤ºï¼ˆ__USER_ID__ãŒã‚ã‚Œã°ä½¿ç”¨ï¼‰
              if (typeof __USER_ID__ !== 'undefined' && __USER_ID__) {
                document.getElementById('current-user-id').textContent = __USER_ID__;
              } else {
                document.getElementById('current-user-id').textContent = 'N/A';
              }

              resolve({ email, userId: __USER_ID__ || null });
            } else {
              document.getElementById('current-user-email').textContent = 'å–å¾—ä¸­...';
              reject(new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            }
          } catch (err) {
            console.error('loadUserInfoAsync parse error:', err);
            document.getElementById('current-user-email').textContent = 'å–å¾—ä¸­...';
            reject(new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'));
          }
        })
        .withFailureHandler(function (error) {
          document.getElementById('current-user-email').textContent = 'ã‚¨ãƒ©ãƒ¼';
          reject(new Error('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message));
        })
        .getUser('email');
    });
  }

  // âœ… CLAUDE.mdæº–æ‹ : Promise-based retry with exponential backoff
  async function loadUserInfo() {
    try {
      await loadUserInfoAsync();
    } catch (error) {
      console.warn('Initial loadUserInfo failed, retrying...', error);

      try {
        // Exponential backoff retry pattern
        await createPromiseDelay(2000);
        await loadUserInfoAsync();
      } catch (retryError) {
        console.error('Retry failed:', retryError);
        showError('æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„');
      }
    }
  }

  // è¨­å®šãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨å®Œå…¨è‡ªå‹•åæ˜ ï¼ˆæ–°å®Ÿè£…ï¼‰

  // âœ… CLAUDE.mdæº–æ‹ : Promise-based simple debounce
  const simpleDebounce = (fn, delay) => {
    let isDebouncing = false;
    let currentPromise = null;

    return async (...args) => {
      // Cancel existing debounce
      if (isDebouncing) {
        isDebouncing = false;
      }

      isDebouncing = true;

      // Create new debounce promise
      currentPromise = createPromiseDelay(delay).then(async () => {
        if (isDebouncing) {
          isDebouncing = false;
          try {
            await fn.apply(this, args);
          } catch (error) {
            console.error('Debounced function error:', error);
          }
        }
      });

      return currentPromise;
    };
  };

  // è¨­å®šãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
  function getConfigAsync() {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .getConfig();
    });
  }

  function loadCurrentConfig() {
    // systemState.configã‚’ä½¿ç”¨ï¼ˆæ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ï¼‰
    if (systemState.config) {
      applyExistingConfig(systemState.config);
      updateResourceButtons(systemState.config);
      updateConfigSummary(systemState.config);
    }
  }

  // ========== URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ ==========

  // URL ã‹ã‚‰ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—
  function getSpreadsheetFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);

    // ?spreadsheetId=xxx å½¢å¼
    const spreadsheetId = urlParams.get('spreadsheetId');
    if (spreadsheetId) {
      return { spreadsheetId, source: 'url_param' };
    }

    // ?url=https://docs.google.com/spreadsheets/d/xxx å½¢å¼
    const spreadsheetUrl = urlParams.get('url');
    if (spreadsheetUrl) {
      const match = spreadsheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if (match) {
        return {
          spreadsheetId: match[1],
          spreadsheetUrl: spreadsheetUrl,
          source: 'url_full'
        };
      }
    }

    return null;
  }

  // ========== è‡ªå‹•åæ˜ æ©Ÿèƒ½ç¾¤ ==========

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè‡ªå‹•é¸æŠ
  async function autoSelectSpreadsheet(spreadsheetId) {
    try {
      const select = document.getElementById('spreadsheet-select');
      if (!select) {
        throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé¸æŠè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }

      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰è©²å½“ã™ã‚‹IDã‚’æ¢ã™
      const option = Array.from(select.options).find((opt) => opt.value === spreadsheetId);
      if (option) {
        select.value = spreadsheetId;

        // ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚‚è‡ªå‹•èª­ã¿è¾¼ã¿
        await loadSheets(spreadsheetId);
        return true;
      } else {
        // ç›´æ¥URLã§æ¥ç¶šã‚’è©¦è¡Œ
        showInfo('ğŸ’¡ è¨­å®šæ¸ˆã¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ç›´æ¥æ¥ç¶šã‚’è©¦è¡Œã—ã¾ã™');
        return false;
      }
    } catch (error) {
      throw error;
    }
  }

  // ã‚·ãƒ¼ãƒˆè‡ªå‹•é¸æŠ
  async function autoSelectSheet(sheetName) {
    try {
      const select = document.getElementById('sheet-select');
      if (!select) {
        throw new Error('ã‚·ãƒ¼ãƒˆé¸æŠè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }

      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰è©²å½“ã™ã‚‹åå‰ã‚’æ¢ã™
      const option = Array.from(select.options).find((opt) => opt.textContent === sheetName);
      if (option) {
        select.value = option.value;
        return true;
      } else {
        // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ç¢ºèª
        const dropdownMethod = document.getElementById('dropdown-method');
        const isDropdownMode = dropdownMethod && !dropdownMethod.classList.contains('hidden');

        // ä¸€è¦§é¸æŠãƒ¢ãƒ¼ãƒ‰ã§ã‹ã¤å®Ÿéš›ã«ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿é€šçŸ¥
        if (isDropdownMode && select.options.length > 1) {
          showInfo('ğŸ’¡ ã‚·ãƒ¼ãƒˆã€Œ' + sheetName + 'ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„');
        }
        return false;
      }
    } catch (error) {
      throw error;
    }
  }

  // è¨­å®šã®å®Œå…¨åæ˜ ï¼ˆæ‹¡å¼µç‰ˆï¼‰
  function applyExistingConfig(config) {
    if (!config) return;

    try {

      // 1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé¸æŠã®åæ˜ 
      if (config.spreadsheetId) {
        const spreadsheetSelect = document.getElementById('spreadsheet-select');
        if (spreadsheetSelect) {
          spreadsheetSelect.value = config.spreadsheetId;
        } else {
          console.warn('âš ï¸ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚»ãƒ¬ã‚¯ãƒˆ (spreadsheet-select) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      }

      // 2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã®åæ˜ ï¼ˆURLç›´æ¥å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
      if (config.spreadsheetUrl) {
        const urlInput = document.getElementById('spreadsheet-url');
        if (urlInput) {
          urlInput.value = config.spreadsheetUrl;
        } else {
          console.warn('âš ï¸ URLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (spreadsheet-url) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      }

      // 3. ã‚·ãƒ¼ãƒˆé¸æŠã®åæ˜ 
      if (config.sheetName) {
        const sheetSelect = document.getElementById('sheet-select');
        if (sheetSelect) {
          sheetSelect.value = config.sheetName;
        } else {
          console.warn('âš ï¸ ã‚·ãƒ¼ãƒˆã‚»ãƒ¬ã‚¯ãƒˆ (sheet-select) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      }

      // 4. è¡¨ç¤ºè¨­å®šã®åæ˜ ï¼ˆæ–°å½¢å¼ãƒ»æ—§å½¢å¼å¯¾å¿œï¼‰
      const displaySettings = config.displaySettings || {};
      const showNames = displaySettings.showNames !== undefined ? displaySettings.showNames : config.showNames;
      const showReactions = displaySettings.showReactions !== undefined ? displaySettings.showReactions : config.showReactions;

      // åå‰è¡¨ç¤ºãƒˆã‚°ãƒ«
      const showNamesToggle = document.getElementById('show-names');
      if (showNamesToggle && typeof showNames === 'boolean') {
        showNamesToggle.checked = showNames;
      }

      // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒˆã‚°ãƒ«
      const showReactionsToggle = document.getElementById('show-reactions');
      if (showReactionsToggle && typeof showReactions === 'boolean') {
        showReactionsToggle.checked = showReactions;
      }

      // 5. è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®åæ˜ 
      if (config.displayMode) {
        const displayModeSelect = document.getElementById('display-mode');
        if (displayModeSelect) {
          displayModeSelect.value = config.displayMode;
        }
      }

      // 6. ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã®åæ˜ 
      if (config.formUrl) {
        const formUrlDisplay = document.getElementById('form-url');
        if (formUrlDisplay) {
          formUrlDisplay.textContent = config.formUrl;
          formUrlDisplay.href = config.formUrl;
        }
      }

      if (config.formTitle) {
        const formTitleDisplay = document.getElementById('form-title');
        if (formTitleDisplay) {
          formTitleDisplay.textContent = config.formTitle;
        }
      }

      // 7. ã‚·ãƒ¼ãƒˆåå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¾©å…ƒ
      if (config.sheetName) {
        const sheetNameInput = document.getElementById('sheet-name-input');
        if (sheetNameInput) {
          sheetNameInput.value = config.sheetName;
        }
      }

    } catch (error) {
      console.error('âŒ è¨­å®šåæ˜ ã‚¨ãƒ©ãƒ¼:', error.message);
    }
  }

  // ========== åŸºæœ¬ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢æ•° ==========

  // URLå…¥åŠ›ã®åŸºæœ¬æ¤œè¨¼
  function validateUrlInput(inputElement) {
    const url = inputElement.value.trim();
    const messageEl = document.getElementById('url-validation-message');

    if (!url) {
      messageEl.textContent = 'ğŸ’¡ Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„';
      messageEl.className = 'text-xs text-gray-400 mt-1';
      inputElement.classList.remove('border-red-500', 'border-green-500');
      return;
    }

    // åŸºæœ¬çš„ãªURLæ¤œè¨¼ãƒ‘ã‚¿ãƒ¼ãƒ³
    const urlPattern = /^https:\/\/docs\.google\.com\/spreadsheets\/d\/[a-zA-Z0-9-_]+/;

    if (urlPattern.test(url)) {
      messageEl.textContent = 'âœ… æœ‰åŠ¹ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã§ã™';
      messageEl.className = 'text-xs text-green-400 mt-1';
      inputElement.classList.remove('border-red-500');
      inputElement.classList.add('border-green-500');
    } else {
      messageEl.textContent =
        'âŒ ç„¡åŠ¹ãªURLå½¢å¼ã§ã™ã€‚Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      messageEl.className = 'text-xs text-red-400 mt-1';
      inputElement.classList.remove('border-green-500');
      inputElement.classList.add('border-red-500');
    }
  }

  // åŸºæœ¬çš„ãªã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
  function sanitizeInput(input) {
    if (!input || typeof input !== 'string') {
      return '';
    }
    return input.replace(/[<>\"'&]/g, '').trim();
  }

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒ‡ãƒ¼ã‚¿ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
  function sanitizeFormData(data) {
    const sanitized = {};
    for (const key in data) {
      if (data.hasOwnProperty(key)) {
        if (typeof data[key] === 'string') {
          sanitized[key] = sanitizeInput(data[key]);
        } else {
          sanitized[key] = data[key];
        }
      }
    }
    return sanitized;
  }

  // é€²æ—ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¨­å®šã‹ã‚‰æ›´æ–°
  function updateProgressFromConfig(config) {
    try {
      let currentStep = 1;

      if (config.sheetName && config.spreadsheetId) {
        currentStep = 2; // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶šå®Œäº†
      }

      if (config.columnMapping && config.columnMapping.mapping && Object.keys(config.columnMapping.mapping).length > 0) {
        currentStep = 3; // åˆ—è¨­å®šå®Œäº†
      }

      if (config.setupStatus === 'completed') {
        currentStep = 3; // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ç¢ºå®š
      }

      console.log('ğŸ“ˆ Progress update:', { currentStep, hasSheet: !!(config.sheetName), hasMapping: !!(config.columnMapping), setupComplete: config.setupStatus === 'completed' });
      updateProgress(currentStep);
    } catch (error) {
      console.warn('updateProgressFromConfig error:', error);
    }
  }

  // éåŒæœŸç‰ˆã®è£œåŠ©é–¢æ•°ç¾¤
  function loadSheets(spreadsheetId) {
    return new Promise((resolve, reject) => {
      const select = document.getElementById('sheet-select');
      select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';

      google.script.run
        .withSuccessHandler(function (response) {
          select.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';
          const sheets = response?.success ? response.sheets : [];
          sheets.forEach((sheet) => {
            const option = document.createElement('option');
            option.value = sheet.name;

            // ãƒ•ã‚©ãƒ¼ãƒ é€£æºã‚·ãƒ¼ãƒˆã‹ã©ã†ã‹ã§è¡¨ç¤ºã‚’å¤‰ãˆã‚‹
            if (sheet.isFormResponseSheet && sheet.formConnected) {
              option.textContent = `ğŸ“‹ ${sheet.name} (ãƒ•ã‚©ãƒ¼ãƒ å›ç­”)`;
              option.dataset.isFormSheet = 'true';
              option.dataset.formTitle = sheet.formTitle || '';
            } else {
              option.textContent = sheet.name;
              option.dataset.isFormSheet = 'false';
            }

            select.appendChild(option);
          });
          resolve(sheets);
        })
        .withFailureHandler(function (error) {
          select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
          reject(new Error('ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message));
        })
        .getSheetList(spreadsheetId);
    });
  }

  // ğŸ¯ CLAUDE.mdæº–æ‹ : ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ä¸€è‡´ã—ãŸè‡ªç„¶ãªé–¢æ•°å
  async function getColumnAnalysis(spreadsheetId, sheetName) {
    const gateKey = `getColumnAnalysis_${spreadsheetId}_${sheetName}`;

    if (!ClientMutex.acquire(gateKey)) {
      console.warn('getColumnAnalysis: æ—¢ã«å®Ÿè¡Œä¸­ã§ã™');
      return { success: false, error: 'Analysis already in progress' };
    }

    try {
      return new Promise((resolve, reject) => {
        console.log('ğŸ” getColumnAnalysis: ãƒãƒƒãƒAPIå‘¼ã³å‡ºã—å®Ÿè¡Œ', { spreadsheetId, sheetName });

        // ğŸ¯ æœ€é©åŒ–: ãƒ¯ãƒ³ãƒ‘ã‚¹çµ±åˆå‡¦ç†ã§é‡è¤‡ã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Œå…¨å›é¿
        const operations = [
          { type: 'integratedAnalysis' }    // æ¥ç¶š+AIåˆ†æã‚’1å›ã§å®Ÿè¡Œ
        ];

        google.script.run
          .withSuccessHandler(function(result) {
            console.log('âœ… getColumnAnalysis batch success:', result);
            ClientMutex.release(gateKey);
            resolve(result);
          })
          .withFailureHandler(function(error) {
            console.error('âŒ getColumnAnalysis batch error:', error);
            ClientMutex.release(gateKey);
            reject(error);
          })
          .dsConnectDataSource(spreadsheetId, sheetName, operations);
      });
    } catch (error) {
      ClientMutex.release(gateKey);
      throw error;
    }
  }



  // ========== ãƒªã‚½ãƒ¼ã‚¹ãƒœã‚¿ãƒ³é–¢é€£é–¢æ•° ==========

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ–°ã‚¿ãƒ–ã§é–‹ã
  function openSpreadsheet() {
    const btn = document.getElementById('open-spreadsheet-btn');
    const spreadsheetId = btn.dataset.spreadsheetId;

    if (!spreadsheetId) {
      showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    const spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/' + spreadsheetId + '/edit';
    window.open(spreadsheetUrl, '_blank');
  }

  // ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ–°ã‚¿ãƒ–ã§é–‹ã
  function openForm() {
    const btn = document.getElementById('open-form-btn');
    const formUrl = btn.dataset.formUrl;

    if (!formUrl) {
      showError('ãƒ•ã‚©ãƒ¼ãƒ URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    window.open(formUrl, '_blank');
  }

  // ãƒªã‚½ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
  function updateResourceButtons(config) {
    const spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
    const formBtn = document.getElementById('open-form-btn');
    const boardBtn = document.getElementById('open-board-btn');
    const statusDiv = document.getElementById('resource-status');

    // ğŸ¯ ä¸‹æ›¸ãä¿å­˜ãƒ»å…¬é–‹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ç®¡ç†
    const saveDraftBtn = document.getElementById('save-draft');
    const publishNowBtn = document.getElementById('publish-now');

    // è¨­å®šãŒç„¡ã„å ´åˆã®åˆæœŸçŠ¶æ…‹
    if (!config) {
      spreadsheetBtn.disabled = true;
      spreadsheetBtn.dataset.spreadsheetId = '';
      formBtn.classList.add('hidden');
      if (boardBtn) boardBtn.classList.add('hidden');
      statusDiv.textContent = 'è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';

      // ä¸‹æ›¸ãä¿å­˜ãƒ»å…¬é–‹ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      if (saveDraftBtn) {
        saveDraftBtn.disabled = true;
        saveDraftBtn.textContent = 'ä¸‹æ›¸ãä¿å­˜ï¼ˆè¨­å®šæœªå®Œäº†ï¼‰';
      }
      if (publishNowBtn) {
        publishNowBtn.disabled = true;
        publishNowBtn.textContent = 'ä»Šã™ãå…¬é–‹ï¼ˆè¨­å®šæœªå®Œäº†ï¼‰';
      }
      return;
    }

    // ğŸš€ åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°å®Œäº†çŠ¶æ…‹ã®åˆ¤å®š
    const hasColumnMapping = !!(config.columnMapping && config.columnMapping.mapping);
    const hasSpreadsheetConfig = !!(config.spreadsheetId && config.sheetName);
    // setupStatusã¾ãŸã¯ã€å®Ÿéš›ã«ãƒãƒƒãƒ”ãƒ³ã‚°è¦ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã‚‹å ´åˆã‚‚å®Œäº†ã¨ã¿ãªã™
    const isSetupComplete = config.setupStatus === 'completed' ||
                          (hasSpreadsheetConfig && hasColumnMapping && config.setupStatus === 'completed');

    console.log('ğŸ“‹ ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°:', {
      hasColumnMapping,
      hasSpreadsheetConfig,
      isSetupComplete,
      mappingKeys: hasColumnMapping ? Object.keys(config.columnMapping.mapping) : []
    });

    // ä¸‹æ›¸ãä¿å­˜ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ç®¡ç†
    if (saveDraftBtn) {
      if (hasSpreadsheetConfig) {
        saveDraftBtn.disabled = false;
        saveDraftBtn.textContent = hasColumnMapping ? 'ä¸‹æ›¸ãä¿å­˜' : 'ä¸‹æ›¸ãä¿å­˜ï¼ˆåˆ—è¨­å®šæ¨å¥¨ï¼‰';
        saveDraftBtn.classList.remove('opacity-50');
      } else {
        saveDraftBtn.disabled = true;
        saveDraftBtn.textContent = 'ä¸‹æ›¸ãä¿å­˜ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æœªæ¥ç¶šï¼‰';
        saveDraftBtn.classList.add('opacity-50');
      }
    }

    // å…¬é–‹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ç®¡ç†
    if (publishNowBtn) {
      if (hasSpreadsheetConfig && hasColumnMapping) {
        publishNowBtn.disabled = false;
        publishNowBtn.textContent = 'ä»Šã™ãå…¬é–‹';
        publishNowBtn.classList.remove('opacity-50');
      } else {
        publishNowBtn.disabled = true;
        if (!hasSpreadsheetConfig) {
          publishNowBtn.textContent = 'ä»Šã™ãå…¬é–‹ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æœªæ¥ç¶šï¼‰';
        } else {
          publishNowBtn.textContent = 'ä»Šã™ãå…¬é–‹ï¼ˆåˆ—è¨­å®šãŒå¿…è¦ï¼‰';
        }
        publishNowBtn.classList.add('opacity-50');
      }
    }

    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã¯ConfigurationManagerã§ç®¡ç†ã•ã‚Œã‚‹ãŸã‚ã€APIçµŒç”±ã§å–å¾—
    spreadsheetBtn.disabled = true;
    statusDiv.textContent = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ©Ÿèƒ½ã¯ConfigurationManagerçµ±åˆä¸­';

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒœã‚¿ãƒ³ï¼ˆæœ‰åŠ¹ãªãƒ•ã‚©ãƒ¼ãƒ URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã«è¡¨ç¤ºï¼‰
    const shouldShowForm = config.formUrl && isValidFormUrl(config.formUrl);
    if (shouldShowForm) {
      formBtn.classList.remove('hidden');
      formBtn.disabled = false;
      formBtn.dataset.formUrl = config.formUrl;
    } else {
      formBtn.classList.add('hidden');
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    let statusParts = [];
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ConfigurationManagerçµŒç”±ã§å–å¾—
    if (config.formUrl) statusParts.push('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ ');
    if (config.isPublished) statusParts.push('ğŸ¯ ãƒœãƒ¼ãƒ‰');

    if (statusParts.length > 0) {
      statusDiv.textContent = 'âœ… åˆ©ç”¨å¯èƒ½: ' + statusParts.join(', ');
      statusDiv.className = 'text-xs text-green-400 mt-2 text-center';
    } else {
      statusDiv.textContent = 'ğŸ’¡ ãƒªã‚½ãƒ¼ã‚¹ã®è¨­å®šã‚’é–‹å§‹ã—ã¦ãã ã•ã„';
      statusDiv.className = 'text-xs text-yellow-400 mt-2 text-center';
    }

    // ğŸ¯ è¨­å®šå®Œäº†çŠ¶æ…‹ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    if (isSetupComplete && hasColumnMapping && hasSpreadsheetConfig) {
      // è¨­å®šå®Œäº†æ™‚ã®ç‰¹åˆ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      const setupStatusDiv = document.getElementById('setup-status-feedback');
      if (setupStatusDiv) {
        setupStatusDiv.innerHTML = `
          <div class="flex items-center gap-2 p-3 bg-green-900/20 border border-green-500/30 rounded-lg text-green-400 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼ä¸‹æ›¸ãä¿å­˜ã¾ãŸã¯å…¬é–‹ã‚’å®Ÿè¡Œã§ãã¾ã™</span>
          </div>
        `;
      }
    }

    // è¨­å®šã‚µãƒãƒªãƒ¼ã‚‚æ›´æ–°
    updateConfigSummary(config);
  }

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è¨­å®š - UnifiedLoadingSystemã‚’ä½¿ç”¨
  function setLoading(loading, message = 'å‡¦ç†ä¸­...') {
    systemState.loading = loading;

    // UnifiedLoadingSystemã‚’ä½¿ç”¨
    if (window.unifiedLoading) {
      if (loading) {
        window.unifiedLoading.show(message);
      } else {
        window.unifiedLoading.hide();
      }
    } else {
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚³ãƒ³ãƒ†ãƒŠå–å¾— (Zero-Dependency UIçµ±åˆ)
  function getFormInfoContainer() {
    const isUrlMethod = !document.getElementById('url-method').classList.contains('hidden');
    return isUrlMethod ?
      document.getElementById('url-form-info') :
      document.getElementById('form-info');
  }

  // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±çµ±ä¸€æ›´æ–° (CLAUDE.mdæº–æ‹  - æ—¢å­˜é–¢æ•°åãƒ‘ã‚¿ãƒ¼ãƒ³)
  function updateFormInfo(formData, options = {}) {
    const container = getFormInfoContainer();
    if (!container) {
      console.warn('updateFormInfo: ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    const safeData = formData || {};
    const status = options.status || (safeData.formUrl ? 'linked' : 'missing');

    // çµ±ä¸€çš„ãªãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±è¡¨ç¤º
    const isUrlMethod = !document.getElementById('url-method').classList.contains('hidden');
    const titleElement = isUrlMethod ?
      document.getElementById('url-form-title') :
      document.getElementById('form-title');
    const urlElement = isUrlMethod ?
      document.getElementById('url-form-url') :
      document.getElementById('form-url');

    if (titleElement) {
      titleElement.textContent = safeData.formTitle || 'ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ãªã—';
    }

    if (urlElement) {
      if (safeData.formUrl) {
        urlElement.textContent = safeData.formUrl;
        urlElement.href = safeData.formUrl;
        urlElement.classList.remove('text-gray-500');
        urlElement.classList.add('text-blue-400');
      } else {
        urlElement.textContent = 'æœªé€£æº';
        urlElement.href = '#';
        urlElement.classList.add('text-gray-500');
        urlElement.classList.remove('text-blue-400');
      }
    }

    // ã‚³ãƒ³ãƒ†ãƒŠè¡¨ç¤º
    container.classList.remove('hidden');

    console.log('updateFormInfo: çµ±ä¸€è¡¨ç¤ºå®Œäº†', {
      method: isUrlMethod ? 'url' : 'dropdown',
      status,
      hasFormUrl: !!safeData.formUrl,
      formTitle: safeData.formTitle
    });
  }

  // æ—¢å­˜é–¢æ•°ã¨ã®äº’æ›æ€§ç¶­æŒ (API Compatibility)
  // âœ… ç°¡ç´ åŒ–ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºé–¢æ•° - updateFormInfo()ã¸ã®å®Œå…¨å§”è­²
  function displayFormInfo(formData, options = {}) {
    return updateFormInfo(formData, options);
  }



  // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±éè¡¨ç¤º
  function hideFormInfo() {
    const formInfo = document.getElementById('form-info');
    if (formInfo) {
      formInfo.classList.add('hidden');
      formInfo.removeAttribute('data-form-status');
      formInfo.removeAttribute('data-form-reason');
      formInfo.removeAttribute('data-form-diagnostics');
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºçµæœã‚’å‡¦ç†ã—ã€é©åˆ‡ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã‚’è¿”ã™
  function processFormDetectionResult(formResult) {
    console.log('ğŸ” processFormDetectionResult å®Ÿè¡Œ:', formResult);

    // ğŸ›¡ï¸ CLAUDE.mdæº–æ‹ : V8ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å¯¾å¿œã®æŸ”è»Ÿãªãƒ‡ãƒ¼ã‚¿æ§‹é€ åˆ¤å®š
    if (!formResult || !formResult.success) {
      console.log('âŒ formResult ãŒä¸æ­£ã¾ãŸã¯å¤±æ•—:', { formResult, success: !!formResult?.success });
      return null;
    }

    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ­£è¦åŒ–ï¼ˆå¾Œæ–¹äº’æ›æ€§ç¶­æŒï¼‰
    const normalizedData = formResult.formData || formResult;
    const confidence = normalizedData.detectionDetails?.confidence || 0;
    const hasFormUrl = !!normalizedData.formUrl;

    console.log('ğŸ” æ¤œå‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', {
      success: formResult.success,
      confidence,
      hasFormUrl,
      status: formResult.status
    });

    // ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚ã‚‹å ´åˆã¯å®Œå…¨ãªé€£æº
    if (hasFormUrl) {
      console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ URLæ¤œå‡ºæˆåŠŸ');
      return { status: 'linked', message: 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºã‚’ç¢ºèªã—ã¾ã—ãŸ' };
    }

    // successãƒ•ãƒ©ã‚°ã¾ãŸã¯é«˜ä¿¡é ¼åº¦ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
    if (formResult.success || confidence >= 70) {
      console.log('âœ… é«˜ä¿¡é ¼åº¦ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º');
      return { status: 'detected', message: 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºï¼ˆURLå–å¾—ä¸å¯ï¼‰' };
    }

    // ä¸­ç¨‹åº¦ä¿¡é ¼åº¦ã§ã®æ¤œå‡º
    if (confidence >= 40) {
      console.log('âš ï¸ ä¸­ç¨‹åº¦ä¿¡é ¼åº¦ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º');
      return { status: 'possible', message: 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã—ã¾ã—ãŸ' };
    }

    // æ¤œå‡ºãªã—
    console.log('âŒ ãƒ•ã‚©ãƒ¼ãƒ é€£æºãƒ‘ã‚¿ãƒ¼ãƒ³ãªã—');
    return { status: 'missing', message: 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºãŒç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ' };
  }

  // ã‚·ãƒ¼ãƒˆåˆ¥ãƒ•ã‚©ãƒ¼ãƒ é€£æºæƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯ãƒ»è¡¨ç¤º
  function checkSheetFormConnection(spreadsheetId, sheetName) {
    if (!spreadsheetId || !sheetName) {
      hideFormInfo();
      return;
    }

    setPartialLoading(true, 'ã‚·ãƒ¼ãƒˆé€£æºæƒ…å ±ã‚’ç¢ºèªä¸­...');

    google.script.run
      .withSuccessHandler((result) => {
        setPartialLoading(false);
        const normalizedResult = result && typeof result === 'object' ? result : null;
        const rawFormData = normalizedResult && typeof normalizedResult.formData === 'object' ? normalizedResult.formData : null;
        const derivedSpreadsheetName = rawFormData?.spreadsheetName || normalizedResult?.diagnostics?.spreadsheetName || '';
        const derivedSheetName = rawFormData?.sheetName || normalizedResult?.requestContext?.sheetName || sheetName;

        window.__formIntegrationLatestResponse = normalizedResult;

        console.log('ğŸ” getFormInfo APIãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°:', {
          result: normalizedResult,
          hasResult: !!normalizedResult,
          isSuccess: normalizedResult && normalizedResult.success,
          hasFormData: rawFormData,
          formData: rawFormData,
          spreadsheetId,
          sheetName: derivedSheetName
        });

        if (normalizedResult && normalizedResult.success && rawFormData && rawFormData.formUrl) {
          displayFormInfo(
            {
              ...rawFormData,
              spreadsheetName: derivedSpreadsheetName,
              sheetName: derivedSheetName
            },
            {
              status: 'linked',
              message: normalizedResult.message || 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºã‚’ç¢ºèªã—ã¾ã—ãŸ',
              reason: normalizedResult.reason || '',
              diagnostics: normalizedResult.diagnostics || null,
              suggestions: Array.isArray(normalizedResult.suggestions) ? normalizedResult.suggestions : [],
              spreadsheetName: derivedSpreadsheetName,
              sheetName: derivedSheetName
            }
          );
          return;
        }

        const fallbackMessage = normalizedResult && normalizedResult.message
          ? normalizedResult.message
          : 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
        const fallbackSuggestions = normalizedResult && Array.isArray(normalizedResult.suggestions)
          ? normalizedResult.suggestions
          : [];

        console.warn('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ é€£æºæƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„:', {
          reason: normalizedResult ? normalizedResult.reason : 'ä¸æ˜',
          suggestions: fallbackSuggestions
        });

        if (fallbackSuggestions.length > 0) {
          const formattedSuggestions = fallbackSuggestions.map((s) => `â€¢ ${s}`).join('\n');
          showWarning(`${fallbackMessage}\n\næ¨å¥¨å¯¾å‡¦æ³•:\n${formattedSuggestions}`);
        } else {
          showWarning(fallbackMessage);
        }

        const fallbackFormData = {
          ...(rawFormData || {}),
          formUrl: rawFormData ? rawFormData.formUrl : null,
          formTitle: (rawFormData && rawFormData.formTitle) || derivedSpreadsheetName || derivedSheetName || 'ãƒ•ã‚©ãƒ¼ãƒ æœªé€£æº',
          spreadsheetName: derivedSpreadsheetName,
          sheetName: derivedSheetName
        };

        displayFormInfo(fallbackFormData, {
          status: 'missing',
          message: fallbackMessage,
          reason: normalizedResult ? normalizedResult.reason || 'FORM_INFO_UNAVAILABLE' : 'FORM_INFO_UNAVAILABLE',
          diagnostics: normalizedResult ? normalizedResult.diagnostics || null : null,
          suggestions: fallbackSuggestions,
          spreadsheetName: derivedSpreadsheetName,
          sheetName: derivedSheetName
        });
      })
      .withFailureHandler((error) => {
        setPartialLoading(false);
        console.error('âŒ ã‚·ãƒ¼ãƒˆé€£æºãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', {
          error: error,
          errorMessage: error.message,
          spreadsheetId: spreadsheetId,
          sheetName: sheetName,
        });
        const failureMessage = 'ãƒ•ã‚©ãƒ¼ãƒ é€£æºæƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        showError(`${failureMessage}\n${error.message || ''}`);
        window.__formIntegrationLatestResponse = null;
        hideFormInfo();
      })
      .getFormInfo(spreadsheetId, sheetName);
  }

  // è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
  function exportConfig() {
    google.script.run
      .withSuccessHandler(function (config) {
        const dataStr = JSON.stringify(config, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        const exportFileDefaultName = 'studyquest-config.json';

        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();

        showSuccess('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
      })
      .withFailureHandler(function (error) {
        console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        showError('è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      })
      .getConfig();
  }

  // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
  function checkAdministratorAccess() {
    google.script.run
      .withSuccessHandler(function (isAdmin) {
        const appSetupBtn = document.getElementById('app-setup-btn');
        if (appSetupBtn) {
          if (isAdmin) {
            console.log('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã—ãŸ');
            appSetupBtn.style.display = 'block';
          } else {
            console.log('ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã—ãŸ');
            appSetupBtn.style.display = 'none';
          }
        }
      })
      .withFailureHandler(function (error) {
        console.warn('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
        const appSetupBtn = document.getElementById('app-setup-btn');
        if (appSetupBtn) {
          appSetupBtn.style.display = 'none';
        }
      })
      .isAdmin();
  }

  // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
  function createFormInterface() {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ç¢ºèª
    if (!__USER_ID__ || __USER_ID__.trim() === '') {
      showError('æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„');
      return;
    }

    const formName = prompt(
      'ä½œæˆã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\nä¾‹ï¼šã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€è³ªå•ãƒ•ã‚©ãƒ¼ãƒ '
    );

    if (!formName || !formName.trim()) {
      showError('ãƒ•ã‚©ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    if (formName.trim().length > 50) {
      showError('50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    // åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ è¨­å®š
    const config = {
      title: formName.trim(),
      description: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ',
      fields: [
        {
          type: 'text',
          label: 'åå‰',
          required: true,
        },
        {
          type: 'text',
          label: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
          required: true,
        },
      ],
    };

    console.log('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆé–‹å§‹:', { userId: __USER_ID__, config });
    setPartialLoading(true, 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆä¸­...');

    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          showSuccess('ãƒ•ã‚©ãƒ¼ãƒ ã€Œ' + formName + 'ã€ã‚’ä½œæˆã—ã¾ã—ãŸ');
          if (result.formUrl) {
            const openForm = confirm('ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚ä»Šã™ãé–‹ãã¾ã™ã‹ï¼Ÿ');
            if (openForm) {
              window.open(result.formUrl, '_blank');
            }
          }
        } else {
          showError(`ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
        }
        setPartialLoading(false);
      })
      .withFailureHandler(function (error) {
        console.error('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        showError(`ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆä¸­ã«ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message || 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼'}`);
        setPartialLoading(false);
      })
      .createForm(__USER_ID__, config);
  }

  // ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  function goToAppSetup() {
    setPartialLoading(true, 'ç”»é¢é·ç§»ä¸­...');
    google.script.run
      .withSuccessHandler(function (webAppUrl) {
        const userId = __USER_ID__;
        const setupUrl = webAppUrl + '?mode=appSetup' + (userId ? '&userId=' + userId : '');
        window.open(setupUrl, '_top');
      })
      .withFailureHandler(function (error) {
        console.error('ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®é·ç§»ã‚¨ãƒ©ãƒ¼:', error);
        showError('ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
        setPartialLoading(false);
      })
      .getWebAppUrl();
  }

  // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠæ–¹å¼ã®åˆ‡ã‚Šæ›¿ãˆ
  function toggleSourceMethod(method) {
    const dropdownMethod = document.getElementById('dropdown-method');
    const urlMethod = document.getElementById('url-method');

    if (method === 'url') {
      dropdownMethod.classList.add('hidden');
      urlMethod.classList.remove('hidden');
    } else {
      dropdownMethod.classList.remove('hidden');
      urlMethod.classList.add('hidden');
    }
  }

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLæ¤œè¨¼
  function validateSpreadsheetUrl() {
    const urlInput = document.getElementById('spreadsheet-url');
    const url = urlInput.value.trim();

    if (!url) {
      showError('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã®åŸºæœ¬çš„ãªæ¤œè¨¼
    const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
    const match = url.match(spreadsheetRegex);

    if (!match) {
      showError('URLã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ï¼ˆä¾‹: docs.google.com/spreadsheets/...ï¼‰');
      return;
    }

    const spreadsheetId = match[1];
    setPartialLoading(true, 'URLæ¤œè¨¼ä¸­...');

    // validateFormLink()ã«ã‚ˆã‚‹åŒ…æ‹¬çš„æ¤œè¨¼ (Zero-Dependency)
    const sheetNameInput = document.getElementById('sheet-name-input');
    const sheetName = sheetNameInput.value.trim() || 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1';

    // åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ -ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    if (typeof validateFormLink === 'function') {
      try {
        const linkValidation = validateFormLink(url, spreadsheetId);
        console.log('validateFormLinkçµæœ:', linkValidation);

        if (!linkValidation.isValid) {
          setPartialLoading(false);
          showError(`URLæ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${linkValidation.errors.join(', ')}`);
          return;
        }

        // è©³ç´°æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
        if (linkValidation.details) {
          console.log('ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼è©³ç´°:', {
            formId: linkValidation.details.formId,
            spreadsheetId: linkValidation.details.spreadsheetId,
            consistent: linkValidation.consistent,
            connectionVerified: linkValidation.details.connectionVerified,
            formInfoVerified: linkValidation.details.formInfoVerified
          });
        }
      } catch (validationError) {
        console.warn('validateFormLinkå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', validationError.message);
        // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶™ç¶šï¼ˆæ—¢å­˜ã®å‡¦ç†ã‚’ç¶­æŒï¼‰
      }
    }

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèª
    google.script.run
      .withSuccessHandler(function (result) {
        setPartialLoading(false);
        if (result.success) {
          showSuccess('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒç¢ºèªã§ãã¾ã—ãŸ');
          // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜
          urlInput.dataset.spreadsheetId = spreadsheetId;
          // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±æ›´æ–°ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          document.getElementById('refresh-url-form-info').classList.remove('hidden');
          // ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
          if (result.sheets && result.sheets.length > 0) {
            updateSheetNameSuggestions(result.sheets);

            // ã‚·ãƒ¼ãƒˆåãŒè‡ªå‹•è¨­å®šã•ã‚ŒãŸå ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚‚å–å¾—
            const sheetNameInput = document.getElementById('sheet-name-input');
            if (sheetNameInput.value && sheetNameInput.value.trim() !== '') {
              console.log('validateAccessAPIæˆåŠŸå¾Œã€ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—:', {
                spreadsheetId: spreadsheetId,
                sheetName: sheetNameInput.value
              });

              // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’éåŒæœŸã§å–å¾—
              google.script.run
                .withSuccessHandler(function(formResult) {
                  console.log('validateAccessAPIå¾Œã®ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±å–å¾—æˆåŠŸ:', formResult);
                  const statusInfo = processFormDetectionResult(formResult);
                  if (statusInfo) {
                    displayFormInfo(formResult.formData, statusInfo);
                  } else {
                    console.warn('ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±å–å¾—å¤±æ•—:', formResult);
                    displayFormInfo({}, {
                      status: 'error',
                      message: 'ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'
                    });
                  }
                })
                .withFailureHandler(function(formError) {
                  console.warn('validateAccessAPIå¾Œã®ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', formError);
                  displayFormInfo({}, {
                    status: 'error',
                    message: 'ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'
                  });
                })
                .getFormInfo(spreadsheetId, sheetNameInput.value);
            }
          }
        } else {
          showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒé–‹ã‘ã¾ã›ã‚“');
        }
      })
      .withFailureHandler(function (error) {
        setPartialLoading(false);
        console.error('URLæ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', error);
        showError('URLã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
      })
      .validateAccessAPI(spreadsheetId);
  }

  // URLå…¥åŠ›æ–¹å¼ã§ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’æ‰‹å‹•æ›´æ–°
  function refreshUrlFormInfo() {
    const urlInput = document.getElementById('spreadsheet-url');
    const sheetNameInput = document.getElementById('sheet-name-input');
    const refreshBtn = document.getElementById('refresh-url-form-info');

    const spreadsheetId = urlInput.dataset.spreadsheetId;
    const sheetName = sheetNameInput.value.trim();

    if (!spreadsheetId) {
      showError('å…ˆã«URLæ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
      return;
    }

    if (!sheetName) {
      showError('ã‚·ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    refreshBtn.disabled = true;
    refreshBtn.textContent = 'ğŸ”„ æ›´æ–°ä¸­...';

    console.log('ğŸ”„ URLæ–¹å¼ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±æ‰‹å‹•æ›´æ–°:', {
      spreadsheetId,
      sheetName
    });

    google.script.run
      .withSuccessHandler(function(formResult) {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±æ›´æ–°';

        console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±æ‰‹å‹•æ›´æ–°æˆåŠŸ:', formResult);

        const statusInfo = processFormDetectionResult(formResult);
        if (statusInfo) {
          displayFormInfo(formResult.formData, statusInfo);
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if (statusInfo.status === 'linked' || statusInfo.status === 'detected') {
            showSuccess('ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          } else if (statusInfo.status === 'possible') {
            showSuccess('ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆå¯èƒ½æ€§æ¤œå‡ºï¼‰');
          } else {
            showSuccess('ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆé€£æºãªã—ï¼‰');
          }
        } else {
          displayFormInfo({}, {
            status: 'error',
            message: 'ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'
          });
        }
      })
      .withFailureHandler(function(error) {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±æ›´æ–°';
        console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±æ‰‹å‹•æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        showError('ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      })
      .getFormInfo(spreadsheetId, sheetName);
  }

  // ã‚·ãƒ¼ãƒˆåå€™è£œã‚’æ›´æ–°ã—ã€ç©ºæ¬„æ™‚ã¯è‡ªå‹•å…¥åŠ›
  function updateSheetNameSuggestions(sheets) {
    const sheetNameInput = document.getElementById('sheet-name-input');
    if (sheets && sheets.length > 0) {
      // ã‚·ãƒ¼ãƒˆåãŒç©ºæ¬„ã®å ´åˆã®ã¿è‡ªå‹•å…¥åŠ›
      if (!sheetNameInput.value || sheetNameInput.value.trim() === '') {
        // å„ªå…ˆé †ä½ã§ã‚·ãƒ¼ãƒˆåã‚’é¸æŠ
        const preferredSheetName = selectBestSheetName(sheets);
        sheetNameInput.value = preferredSheetName;
        console.log('ã‚·ãƒ¼ãƒˆåã‚’è‡ªå‹•è¨­å®š:', preferredSheetName);
      }

      // datalistã§å€™è£œã‚’è¡¨ç¤ºï¼ˆã‚ˆã‚Šè‰¯ã„UXï¼‰
      let datalist = document.getElementById('sheet-suggestions');
      if (!datalist) {
        datalist = document.createElement('datalist');
        datalist.id = 'sheet-suggestions';
        sheetNameInput.setAttribute('list', 'sheet-suggestions');
        sheetNameInput.parentNode.appendChild(datalist);
      }

      datalist.innerHTML = '';
      sheets.forEach((sheet) => {
        const option = document.createElement('option');
        option.value = sheet.name;
        option.text = `${sheet.name} (${sheet.rowCount}è¡Œ)`;
        datalist.appendChild(option);
      });
    }
  }

  // æœ€é©ãªã‚·ãƒ¼ãƒˆåã‚’é¸æŠã™ã‚‹é–¢æ•°
  function selectBestSheetName(sheets) {
    // 1. ã€Œå›ç­”ã€ã€Œanswerã€ã‚’å«ã‚€ã‚·ãƒ¼ãƒˆã‚’å„ªå…ˆ
    const answerSheets = sheets.filter(sheet =>
      /å›ç­”|answer|ãƒ‡ãƒ¼ã‚¿|data/i.test(sheet.name)
    );
    if (answerSheets.length > 0) {
      return answerSheets[0].name;
    }

    // 2. è¡Œæ•°ãŒæœ€ã‚‚å¤šã„ã‚·ãƒ¼ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ãã†ï¼‰
    const maxRowSheet = sheets.reduce((max, sheet) =>
      sheet.rowCount > max.rowCount ? sheet : max
    );
    if (maxRowSheet.rowCount > 1) {
      return maxRowSheet.name;
    }

    // 3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã®ã‚·ãƒ¼ãƒˆ
    return sheets[0].name;
  }

  // URLå…¥åŠ›æ–¹å¼ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶š

  // âœ… LEGACY REMOVED: connectToSheet() - connectToDataSource()ã«çµ±åˆæ¸ˆã¿


  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  document.addEventListener('DOMContentLoaded', function () {
    // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠæ–¹å¼ã®åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('input[name="source-method"]').forEach((radio) => {
      radio.addEventListener('change', function () {
        toggleSourceMethod(this.value);
      });
    });

    // ã‚·ãƒ¼ãƒˆé¸æŠæ™‚ï¼ˆãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±è¡¨ç¤ºï¼‰
    document.getElementById('sheet-select').addEventListener('change', function () {
      const spreadsheetId = document.getElementById('spreadsheet-select').value;
      const sheetName = this.value;

      if (spreadsheetId && sheetName) {
        // ã‚·ãƒ¼ãƒˆåˆ¥ãƒ•ã‚©ãƒ¼ãƒ é€£æºæƒ…å ±ã‚’å–å¾—ãƒ»è¡¨ç¤º
        checkSheetFormConnection(spreadsheetId, sheetName);
      } else {
        hideFormInfo();
      }
    });

    // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒœã‚¿ãƒ³
    document.getElementById('refresh-data').addEventListener('click', function () {
      loadSpreadsheets();
    });

    // æ¥ç¶šãƒœã‚¿ãƒ³ï¼ˆä¸€è¦§é¸æŠï¼‰
    document.getElementById('connect-source').addEventListener('click', function () {
      Debounce.run('connect-source', 400, () => connectToDataSource());
    });

    // URLæ¤œè¨¼ãƒœã‚¿ãƒ³
    document.getElementById('url-validate').addEventListener('click', function () {
      validateSpreadsheetUrl();
    });

    // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±æ›´æ–°ãƒœã‚¿ãƒ³ï¼ˆURLå…¥åŠ›ç”¨ï¼‰
    document.getElementById('refresh-url-form-info').addEventListener('click', function () {
      refreshUrlFormInfo();
    });

    // æ¥ç¶šãƒœã‚¿ãƒ³ï¼ˆURLå…¥åŠ›ï¼‰
    document.getElementById('connect-url-source').addEventListener('click', function () {
      connectToDataSource();
    });

    // è¨­å®šç¢ºèªãƒœã‚¿ãƒ³
    document.getElementById('verify-mapping').addEventListener('click', function () {
      Debounce.run('verify-mapping', 500, () => verifyColumnMapping());
    });

    // ä¸‹æ›¸ãä¿å­˜ãƒœã‚¿ãƒ³
    document.getElementById('save-draft').addEventListener('click', function () {
      Debounce.run('save-draft', 500, () => saveDraft());
    });

    // å…¬é–‹ãƒœã‚¿ãƒ³
    document.getElementById('publish-now').addEventListener('click', function () {
      Debounce.run('publish-now', 800, () => publishApp());
    });
  });

  // ã‚·ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
  function loadSheetList(spreadsheetId) {
    const select = document.getElementById('sheet-select');
    if (!select) {
      console.error('âŒ loadSheetList: sheet-selectè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      showError('ã‚·ãƒ¼ãƒˆé¸æŠè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';

    // ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã¯éƒ¨åˆ†ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
    setPartialLoading(true, 'ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');

    google.script.run
      .withSuccessHandler(function (response) {
        select.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';

        // DataService.getSheetList() returns {success: true, sheets: [...]}
        const sheets = response?.success ? response.sheets : [];

        if (!sheets || sheets.length === 0) {
          const noSheetOption = document.createElement('option');
          noSheetOption.value = '';
          noSheetOption.textContent = 'åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“';
          noSheetOption.disabled = true;
          select.appendChild(noSheetOption);
        } else {
          sheets.forEach((sheet) => {
            const option = document.createElement('option');
            option.value = sheet.name;
            option.textContent = sheet.name;
            select.appendChild(option);
          });
        }

        // partial-loading-targetã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        select.classList.remove('partial-loading-target');

        setPartialLoading(false);
        showSuccess(`âœ… ${sheets?.length || 0}å€‹ã®ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      })
      .withFailureHandler(function (error) {
        console.error('âŒ loadSheetList: ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', {
          error: error.message || error,
          spreadsheetId: typeof spreadsheetId === 'string' && spreadsheetId ? `${spreadsheetId.substring(0, 10)}...` : `[${typeof spreadsheetId}]`,
          timestamp: new Date().toISOString(),
        });

        select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ - å†è©¦è¡Œã—ã¦ãã ã•ã„</option>';
        select.classList.remove('partial-loading-target');

        setPartialLoading(false);
        showError(`ã‚·ãƒ¼ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`);
      })
      .getSheetList(spreadsheetId);
  }

  // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶š
  // âœ… çµ±ä¸€ã•ã‚ŒãŸæ¥ç¶šå‡¦ç†é–¢æ•° - ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ»URLä¸¡æ–¹å¼å¯¾å¿œ
  async function connectToDataSource() {
    const gateKey = 'connectToDataSource';
    if (!ClientMutex.acquire(gateKey)) {
      showInfo('ç¾åœ¨å‡¦ç†ä¸­ã§ã™â€¦å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    try {
      // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å…¥åŠ›æ–¹å¼ã®åˆ¤å®š
      const isUrlMethod = !document.getElementById('url-method').classList.contains('hidden');
      let spreadsheetId, sheetName;

      if (isUrlMethod) {
        // URLæ–¹å¼
        const urlInput = document.getElementById('spreadsheet-url');
        const sheetNameInput = document.getElementById('sheet-name-input');
        const url = urlInput.value.trim();
        sheetName = sheetNameInput.value.trim();

        if (!url) {
          showError('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        if (!sheetName) {
          showError('ã‚·ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        // URLã‹ã‚‰ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’æŠ½å‡º
        const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
        const match = url.match(spreadsheetRegex);
        if (!match) {
          showError('URLã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ï¼ˆä¾‹: docs.google.com/spreadsheets/...ï¼‰');
          return;
        }
        spreadsheetId = match[1];
      } else {
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ–¹å¼
        spreadsheetId = document.getElementById('spreadsheet-select').value;
        sheetName = document.getElementById('sheet-select').value;

        if (!spreadsheetId) {
          showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚å…ˆã«ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
          return;
        }
        if (!sheetName) {
          showError('ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€ã‚·ãƒ¼ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚');
          return;
        }
      }

      setLoading(true);
      console.log('connectToDataSource: çµ±ä¸€æ¥ç¶šé–‹å§‹', { spreadsheetId, sheetName, method: isUrlMethod ? 'URL' : 'dropdown' });

      // çœŸã®ãƒãƒƒãƒå‡¦ç†å®Ÿè£… (CLAUDE.mdæº–æ‹  - 70x Performance)
      const result = await processBatchOperations([
        { type: 'validateAccess', spreadsheetId, sheetName },
        { type: 'getFormInfo', spreadsheetId, sheetName },
        { type: 'connectDataSource', spreadsheetId, sheetName }
      ]);

      if (result.success) {
        // è©³ç´°ãªæˆåŠŸé€šçŸ¥ã§æ˜ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        const successDetails = [];
        successDetails.push('âœ… ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶šå®Œäº†');

        if (result.batchResults && result.batchResults.formInfo) {
          successDetails.push('ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ é€£æºç¢ºèªæ¸ˆã¿');
          displayFormInfo(result.batchResults.formInfo.formData, {
            status: 'linked',
            spreadsheetName: result.batchResults.formInfo.spreadsheetName
          });
        }

        if (result.mapping) {
          successDetails.push('ğŸ¤– AIåˆ—åˆ¤å®šå®Œäº†');
          showNextStepGuidance(result);
        }

        showSuccess(successDetails.join(' | '));

        // é€²æ—çŠ¶æ³ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ˜ç¤º
        showInfo('æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ç¢ºèªã—ã¦è¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„', 8000);
      } else {
        handleConnectionError(result.error, { spreadsheetId, sheetName, method: isUrlMethod ? 'URL' : 'dropdown' });
      }
    } catch (error) {
      console.error('connectToDataSource ã‚¨ãƒ©ãƒ¼:', error);
      handleConnectionError(error.message || error, { spreadsheetId, sheetName, method: isUrlMethod ? 'URL' : 'dropdown' });
    } finally {
      setLoading(false);
      ClientMutex.release(gateKey);
    }
  }

  // âœ… çœŸã®ãƒãƒƒãƒå‡¦ç†å®Ÿè£… - GAS APIå‘¼ã³å‡ºã—æœ€é©åŒ–
  async function processBatchOperations(operations) {
    if (!operations || !Array.isArray(operations) || operations.length === 0) {
      throw new Error('Invalid operations array');
    }

    // ã™ã¹ã¦ã®operationsãŒåŒã˜spreadsheetIdã¨sheetNameã‚’æŒã¤ã“ã¨ã‚’ç¢ºèª
    const firstOp = operations[0];
    const isConsistent = operations.every(op =>
      op.spreadsheetId === firstOp.spreadsheetId &&
      op.sheetName === firstOp.sheetName
    );

    if (!isConsistent) {
      throw new Error('All operations must have the same spreadsheetId and sheetName');
    }

    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .dsConnectDataSource(firstOp.spreadsheetId, firstOp.sheetName, operations);
    });
  }


  // æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° (validateFormLinkè©³ç´°æ´»ç”¨)
  function handleConnectionError(errorMessage, context) {
    console.error('Connection error details:', { errorMessage, context });

    let userMessage = 'ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
    let suggestions = [];

    // validateFormLinkçµæœã®æ´»ç”¨ (Zero-Dependency)
    if (context && context.validation && context.validation.details) {
      const validationDetails = context.validation.details;
      console.log('validateFormLinkè©³ç´°ã‚¨ãƒ©ãƒ¼è§£æ:', validationDetails);

      // æ¥ç¶šæ¤œè¨¼çµæœã®æ´»ç”¨
      if (validationDetails.connectionVerified === false) {
        userMessage = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        suggestions.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        suggestions.push('ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç·¨é›†è€…æ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');

        if (validationDetails.connectionError) {
          suggestions.push(`è©³ç´°: ${validationDetails.connectionError}`);
        }
      }

      // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±æ¤œè¨¼çµæœã®æ´»ç”¨
      if (validationDetails.formInfoVerified === false) {
        userMessage += ' ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã®å–å¾—ã«ã‚‚å¤±æ•—ã—ã¾ã—ãŸã€‚';
        suggestions.push('ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®é€£æºã‚’ç¢ºèªã—ã¦ãã ã•ã„');

        if (validationDetails.formInfoError) {
          suggestions.push(`ãƒ•ã‚©ãƒ¼ãƒ è©³ç´°: ${validationDetails.formInfoError}`);
        }
      }

      // URLä¸€è‡´ç¢ºèªçµæœã®æ´»ç”¨
      if (validationDetails.formUrlMatches === false && validationDetails.detectedFormUrl) {
        userMessage += ' å…¥åŠ›URLã¨ã‚·ã‚¹ãƒ†ãƒ æ¤œå‡ºURLãŒç•°ãªã‚Šã¾ã™ã€‚';
        suggestions.push(`æ¤œå‡ºã•ã‚ŒãŸURL: ${validationDetails.detectedFormUrl}`);
        suggestions.push('æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒ URLã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
      }
    } else {
      // å¾“æ¥ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è§£æ
      if (errorMessage.includes('Permission') || errorMessage.includes('æ¨©é™')) {
        suggestions.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        suggestions.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ã¦ã€ç·¨é›†æ¨©é™ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
      } else if (errorMessage.includes('not found') || errorMessage.includes('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
        suggestions.push('æŒ‡å®šã•ã‚ŒãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¾ãŸã¯ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
        suggestions.push('ã‚·ãƒ¼ãƒˆåãŒæ­£ç¢ºã‹ç¢ºèªã—ã¦ãã ã•ã„');
      } else if (errorMessage.includes('timeout') || errorMessage.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
        suggestions.push('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        suggestions.push('ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„');
      } else {
        suggestions.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒé–‹ã‘ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        suggestions.push('æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™');
      }
    }

    const fullMessage =
      userMessage + '\n\næ¨å¥¨å¯¾å‡¦æ³•:\n' + suggestions.map((s) => 'â€¢ ' + s).join('\n');
    showError(fullMessage);

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¼ã§ã¯æ‰‹å‹•è¨­å®šã¯è‡ªå‹•çš„ã«åˆ©ç”¨å¯èƒ½
    showInfo('ğŸ’¡ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ä½¿ç”¨ã—ã¦æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã§ãã¾ã™ã€‚');
  }


  // é€²æ—æ›´æ–°
  function updateProgress(step) {
    const steps = document.querySelectorAll('.step');
    steps.forEach((stepEl, index) => {
      stepEl.classList.remove('completed', 'current');
      if (index < step - 1) {
        stepEl.classList.add('completed');
      } else if (index === step - 1) {
        stepEl.classList.add('current');
      }
    });
  }

  // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æ›´æ–°ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¼ï¼‰- ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ
  function updateColumnMapping(result) {
    console.log('Column mapping received:', result);

    if (!result || !result.success) {
      console.warn('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°çµæœãŒä¸æ­£ã§ã™');
      showError('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      return;
    }

    const mapping = result.mapping || {};
    const confidence = result.confidence || {};
    const headers = result.headers || [];

    console.log('Headers:', headers, 'Mapping:', mapping, 'Confidence:', confidence);

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
    fillColumnDropdowns(headers, mapping, confidence);
    // ç¾åœ¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒï¼ˆæ¤œè¨¼/ä¿å­˜ã§ä½¿ç”¨ï¼‰
    try {
      window.currentHeaders = headers;
    } catch (_) {}

    // AIæ¤œå‡ºæƒ…å ±ã‚’è¡¨ç¤º
    displayAIDetectionInfo(mapping, confidence);

    // æ¥ç¶šæ™‚ã¯AIæ¤œå‡ºçµæœã‚’å„ªå…ˆã—ã€ä¿å­˜æ¸ˆã¿è¨­å®šå¾©å…ƒã¯è¡Œã‚ãªã„
    // AIæ¤œå‡ºãŒç„¡ã„å ´åˆã®ã¿ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º

    showSuccess('âœ… åˆ—è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  }

  // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆ
  function fillColumnDropdowns(headers, mapping, confidence = {}) {
    console.log('fillColumnDropdowns:', { headers, mapping, confidence });

    try {
      // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
      if (!Array.isArray(headers) || headers.length === 0) {
        console.warn('âš ï¸ ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ãŒä¸æ­£ã§ã™');
        return;
      }

      // mapping/confidenceæ¤œè¨¼ï¼ˆæ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      if (!mapping || typeof mapping !== 'object') {
        mapping = {};
      }
      if (!confidence || typeof confidence !== 'object') {
        confidence = {};
      }

      // 4ã¤ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å–å¾—
      const dropdowns = {
        answer: document.getElementById('answer-column-select'),
        reason: document.getElementById('reason-column-select'),
        class: document.getElementById('class-column-select'),
        name: document.getElementById('name-column-select'),
      };

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å­˜åœ¨ç¢ºèª
      const missingDropdowns = Object.keys(dropdowns).filter((key) => !dropdowns[key]);
      if (missingDropdowns.length > 0) {
        console.warn('ä¸€éƒ¨ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', missingDropdowns);
      }

      // å„ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      Object.keys(dropdowns).forEach((columnType) => {
        const dropdown = dropdowns[columnType];
        if (!dropdown) {
          console.warn(`${columnType}ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
          return;
        }

        try {
          // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
          dropdown.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„...</option>';

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¿½åŠ 
          headers.forEach((header, index) => {
            if (header && header.trim()) {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = `${String.fromCharCode(65 + index)}åˆ—: ${header}`;
              dropdown.appendChild(option);
            }
          });
        } catch (error) {
          console.error(`${columnType}ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è¨­å®šã‚¨ãƒ©ãƒ¼:`, error);
        }
      });

      // AIæ¤œå‡ºçµæœã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®åˆæœŸé¸æŠã¨ã—ã¦è¨­å®šï¼ˆçµ±åˆå‡¦ç†ï¼‰
      setAIDetectionSelections(mapping, dropdowns, confidence);

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      setupDropdownEventListeners(dropdowns);
    } catch (error) {
      console.error('fillColumnDropdowns ã‚¨ãƒ©ãƒ¼:', error);
      showError('ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    }
  }

  // ===========================================
  // ğŸ”§ AIæ¤œå‡ºã¨æ‰‹å‹•è¨­å®šã®ç«¶åˆè§£æ±ºã‚·ã‚¹ãƒ†ãƒ 
  // ===========================================

  /**
   * åˆ—é¸æŠã®ç«¶åˆçŠ¶æ…‹åˆ†æ
   * @param {Object} mapping - AIæ¤œå‡ºãƒãƒƒãƒ”ãƒ³ã‚°
   * @param {Object} dropdowns - ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¦ç´ 
   * @param {Object} confidence - AIä¿¡é ¼åº¦ãƒ‡ãƒ¼ã‚¿
   * @returns {Object} ç«¶åˆåˆ†æçµæœ
   */
  function analyzeColumnSelectionConflicts(mapping, dropdowns, confidence = {}) {
    const analysis = {
      hasConflicts: false,
      conflicts: [],
      recommendations: [],
      summary: {
        aiSelections: 0,
        manualSelections: 0,
        conflictingFields: []
      }
    };

    try {
      const actualMapping = mapping?.mapping || mapping || {};

      Object.keys(dropdowns).forEach(fieldType => {
        const dropdown = dropdowns[fieldType];
        if (!dropdown) return;

        const hasAISelection = actualMapping[fieldType] !== undefined && actualMapping[fieldType] !== null;
        const hasManualSelection = dropdown.value && dropdown.value !== '';
        const aiConfidence = confidence[fieldType] || 0;

        if (hasAISelection) analysis.summary.aiSelections++;
        if (hasManualSelection) analysis.summary.manualSelections++;

        // ç«¶åˆæ¤œå‡º: AIæ¤œå‡ºã¨æ‰‹å‹•é¸æŠãŒç•°ãªã‚‹å ´åˆ
        if (hasAISelection && hasManualSelection) {
          const aiIndex = actualMapping[fieldType];
          const manualIndex = parseInt(dropdown.value);

          if (aiIndex !== manualIndex) {
            analysis.hasConflicts = true;
            analysis.conflicts.push({
              field: fieldType,
              aiSelection: { index: aiIndex, confidence: aiConfidence },
              manualSelection: { index: manualIndex },
              severity: aiConfidence > 70 ? 'high' : 'medium'
            });
            analysis.summary.conflictingFields.push(fieldType);
          }
        }
      });

      // æ¨å¥¨äº‹é …ã®ç”Ÿæˆ
      if (analysis.hasConflicts) {
        analysis.recommendations = generateConflictResolutionRecommendations(analysis);
      }

      console.log('ğŸ” analyzeColumnSelectionConflictsçµæœ:', analysis);
      return analysis;

    } catch (error) {
      console.error('analyzeColumnSelectionConflicts ã‚¨ãƒ©ãƒ¼:', error);
      return { hasConflicts: false, conflicts: [], error: error.message };
    }
  }

  /**
   * ç«¶åˆè§£æ±ºã®æ¨å¥¨äº‹é …ç”Ÿæˆ
   * @param {Object} analysis - ç«¶åˆåˆ†æçµæœ
   * @returns {Array} æ¨å¥¨äº‹é …ãƒªã‚¹ãƒˆ
   */
  function generateConflictResolutionRecommendations(analysis) {
    const recommendations = [];

    analysis.conflicts.forEach(conflict => {
      if (conflict.severity === 'high') {
        recommendations.push({
          type: 'trust_ai',
          field: conflict.field,
          message: `${conflict.field}: AIæ¤œå‡ºã®ä¿¡é ¼åº¦ãŒé«˜ã„ãŸã‚(${conflict.aiSelection.confidence}%)ã€AIé¸æŠã‚’æ¨å¥¨`,
          action: 'use_ai_selection'
        });
      } else {
        recommendations.push({
          type: 'user_choice',
          field: conflict.field,
          message: `${conflict.field}: AIä¿¡é ¼åº¦ãŒä¸­ç¨‹åº¦ã®ãŸã‚ã€æ‰‹å‹•é¸æŠã‚’ç¶­æŒã¾ãŸã¯ç¢ºèªã—ã¦ãã ã•ã„`,
          action: 'confirm_manual_selection'
        });
      }
    });

    return recommendations;
  }

  /**
   * ç«¶åˆçŠ¶æ³ã®å‡¦ç†ã¨è§£æ±º
   * @param {Object} conflictStatus - ç«¶åˆçŠ¶æ…‹åˆ†æçµæœ
   * @param {Object} mapping - AIæ¤œå‡ºãƒãƒƒãƒ”ãƒ³ã‚°
   * @param {Object} dropdowns - ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¦ç´ 
   * @param {Object} confidence - AIä¿¡é ¼åº¦ãƒ‡ãƒ¼ã‚¿
   */
  function handleColumnSelectionConflicts(conflictStatus, mapping, dropdowns, confidence) {
    try {
      console.log('ğŸ”§ handleColumnSelectionConflicts: ç«¶åˆè§£æ±ºå‡¦ç†é–‹å§‹');

      // ğŸ¯ ç«¶åˆè§£æ±ºæˆ¦ç•¥: ä¿¡é ¼åº¦ãƒ™ãƒ¼ã‚¹è‡ªå‹•è§£æ±º + ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
      conflictStatus.conflicts.forEach(conflict => {
        const dropdown = dropdowns[conflict.field];
        if (!dropdown) return;

        if (conflict.severity === 'high') {
          // é«˜ä¿¡é ¼åº¦ã®AIæ¤œå‡º: è‡ªå‹•ã§AIé¸æŠã‚’æ¡ç”¨
          dropdown.value = conflict.aiSelection.index;
          dropdown.classList.add('auto-resolved-ai');

          console.log(`âœ… è‡ªå‹•è§£æ±º: ${conflict.field} â†’ AIé¸æŠ (ä¿¡é ¼åº¦: ${conflict.aiSelection.confidence}%)`);

          // ä¿¡é ¼åº¦ãƒãƒƒã‚¸ã‚’æ›´æ–°
          showConfidenceBadge(conflict.field, conflict.aiSelection.confidence, 'ai-auto');

        } else {
          // ä¸­ç¨‹åº¦ã®ä¿¡é ¼åº¦: æ‰‹å‹•é¸æŠã‚’ç¶­æŒã—ã€ç¢ºèªã‚’ä¿ƒã™
          dropdown.classList.add('needs-user-confirmation');

          console.log(`âš ï¸ ç¢ºèªè¦æ±‚: ${conflict.field} â†’ æ‰‹å‹•é¸æŠç¶­æŒã€ç¢ºèªæ¨å¥¨`);

          // ç¢ºèªãƒãƒƒã‚¸ã‚’è¡¨ç¤º
          showConfidenceBadge(conflict.field, 100, 'manual-confirm');
        }
      });

      // ğŸ¯ ç«¶åˆè§£æ±ºçµæœã®é€šçŸ¥
      displayConflictResolutionResults(conflictStatus);

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã®æ›´æ–°
      window.currentAIMapping = mapping;
      window.conflictResolutionStatus = conflictStatus;

    } catch (error) {
      console.error('handleColumnSelectionConflicts ã‚¨ãƒ©ãƒ¼:', error);
      showError('åˆ—è¨­å®šã®ç«¶åˆè§£æ±ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }

  /**
   * ç«¶åˆè§£æ±ºçµæœã®è¡¨ç¤º
   * @param {Object} conflictStatus - ç«¶åˆçŠ¶æ…‹åˆ†æçµæœ
   */
  function displayConflictResolutionResults(conflictStatus) {
    try {
      const autoResolved = conflictStatus.conflicts.filter(c => c.severity === 'high').length;
      const needsConfirmation = conflictStatus.conflicts.filter(c => c.severity === 'medium').length;

      let message = 'ğŸ”§ åˆ—è¨­å®šã®ç«¶åˆã‚’è§£æ±ºã—ã¾ã—ãŸ:\n';

      if (autoResolved > 0) {
        message += `â€¢ ${autoResolved}ä»¶ã‚’è‡ªå‹•è§£æ±ºï¼ˆé«˜ä¿¡é ¼åº¦AIæ¤œå‡ºæ¡ç”¨ï¼‰\n`;
      }

      if (needsConfirmation > 0) {
        message += `â€¢ ${needsConfirmation}ä»¶ã®ç¢ºèªãŒå¿…è¦ï¼ˆæ‰‹å‹•é¸æŠç¶­æŒï¼‰`;
      }

      showInfo(message, 8000);

      // è©³ç´°æƒ…å ±ãƒ‘ãƒãƒ«ã®æ›´æ–°
      updateConflictInfoPanel(conflictStatus);

    } catch (error) {
      console.error('displayConflictResolutionResults ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  /**
   * ç«¶åˆæƒ…å ±ãƒ‘ãƒãƒ«ã®æ›´æ–°
   * @param {Object} conflictStatus - ç«¶åˆçŠ¶æ…‹åˆ†æçµæœ
   */
  function updateConflictInfoPanel(conflictStatus) {
    try {
      const infoPanel = document.getElementById('column-conflict-info');
      if (!infoPanel) return;

      if (conflictStatus.hasConflicts) {
        infoPanel.classList.remove('hidden');
        infoPanel.innerHTML = `
          <div class="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4 mt-4">
            <h4 class="text-yellow-400 font-medium mb-2">ğŸ”§ åˆ—è¨­å®šç«¶åˆè§£æ±ºçŠ¶æ³</h4>
            <div class="text-sm text-yellow-200 space-y-1">
              ${conflictStatus.recommendations.map(rec =>
                `<div>â€¢ ${rec.message}</div>`
              ).join('')}
            </div>
          </div>
        `;
      } else {
        infoPanel.classList.add('hidden');
      }

    } catch (error) {
      console.error('updateConflictInfoPanel ã‚¨ãƒ©ãƒ¼:', error);
    }
  }


  // ğŸ¯ AIæ¤œå‡ºçµæœã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®åˆæœŸé¸æŠã¨ã—ã¦è¨­å®šï¼ˆç«¶åˆè§£æ±ºå¼·åŒ–ç‰ˆï¼‰
  function setAIDetectionSelections(mapping, dropdowns, confidence = {}) {
    console.log('ğŸ” setAIDetectionSelections: AIæ¤œå‡ºã¨æ‰‹å‹•è¨­å®šã®ç«¶åˆè§£æ±ºé–‹å§‹', { mapping, confidence });

    // ğŸ›¡ï¸ ç«¶åˆçŠ¶æ…‹ã®äº‹å‰ãƒã‚§ãƒƒã‚¯
    const conflictStatus = analyzeColumnSelectionConflicts(mapping, dropdowns, confidence);
    if (conflictStatus.hasConflicts) {
      console.warn('âš ï¸ AIæ¤œå‡ºã¨æ‰‹å‹•è¨­å®šã®ç«¶åˆæ¤œå‡º:', conflictStatus.conflicts);
      return handleColumnSelectionConflicts(conflictStatus, mapping, dropdowns, confidence);
    }

    // é˜²å¾¡çš„ãƒã‚§ãƒƒã‚¯: mappingãŒundefined/nullã®å ´åˆã¯æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
    if (!mapping || typeof mapping !== 'object') {
      console.log('ğŸ’¡ AIæ¤œå‡ºçµæœãŒã‚ã‚Šã¾ã›ã‚“ - æ‰‹å‹•é¸æŠã‚’ãŠä½¿ã„ãã ã•ã„');
      return;
    }

    // è©³ç´°ãƒã‚§ãƒƒã‚¯: mappingæ§‹é€ ã®æ¤œè¨¼
    const mappingDetails = {
      hasMapping: mapping.hasOwnProperty('mapping') || Object.keys(mapping).length > 0,
      hasConfidence: Object.keys(confidence).length > 0,
      mappingKeys: mapping.mapping ? Object.keys(mapping.mapping) : Object.keys(mapping),
      confidenceKeys: Object.keys(confidence),
      mappingContent: mapping.mapping || mapping,
      confidenceContent: confidence
    };
    console.log('ğŸ” setAIDetectionSelections: mappingè©³ç´°åˆ†æ', mappingDetails);

    // AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œ: mappingãŒç©ºã§ã‚‚ä¿¡é ¼åº¦ãŒã‚ã‚Œã°å‡¦ç†ç¶™ç¶š
    const actualMapping = mapping.mapping || mapping;
    const hasValidMapping = actualMapping && Object.keys(actualMapping).length > 0;
    const hasConfidenceData = confidence && Object.keys(confidence).length > 0;

    if (!hasValidMapping && !hasConfidenceData) {
      console.log('ğŸ’¡ AIæ¤œå‡ºçµæœãŒã‚ã‚Šã¾ã›ã‚“ - æ‰‹å‹•é¸æŠã‚’ãŠä½¿ã„ãã ã•ã„');
      return;
    }

    if (!hasValidMapping && hasConfidenceData) {
      console.log('ğŸ” AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ : ãƒãƒƒãƒ”ãƒ³ã‚°ãªã—ã€ä¿¡é ¼åº¦ãƒ‡ãƒ¼ã‚¿ã§å‡¦ç†ç¶™ç¶š', confidence);
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ç¾åœ¨ã®AIæ¤œå‡ºçµæœã‚’ä¿å­˜
    window.currentAIMapping = mapping;

    // ğŸ¯ çµ±ä¸€ãƒãƒƒãƒ”ãƒ³ã‚°ã‚­ãƒ¼ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®getHeaderPatterns()ã¨å®Œå…¨çµ±ä¸€ï¼‰
    const mappingKeys = {
      // åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆç®¡ç†ãƒ‘ãƒãƒ«å¯¾å¿œï¼‰
      answer: ['answer'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: answer ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      reason: ['reason'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: reason ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      class: ['class'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: class ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      name: ['name'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: name ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

      // æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå°†æ¥å¯¾å¿œãƒ»ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      timestamp: ['timestamp'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: timestamp ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      email: ['email'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: email ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

      // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ—ï¼ˆã‚·ã‚¹ãƒ†ãƒ å†…éƒ¨ç”¨ï¼‰
      understand: ['understand'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: understand ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      like: ['like'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: like ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      curious: ['curious'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: curious ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

      // ãƒã‚¤ãƒ©ã‚¤ãƒˆåˆ—ï¼ˆã‚·ã‚¹ãƒ†ãƒ å†…éƒ¨ç”¨ï¼‰
      highlight: ['highlight'] // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: highlight ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    };

    let detectedCount = 0;
    let totalConfidenceInfo = [];

    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;

      // å¯¾å¿œã™ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚­ãƒ¼ã‚’æ¢ã™
      let selectedIndex = null;
      let columnConfidence = 0;

      mappingKeys[columnType].forEach((key) => {
        if (actualMapping[key] !== null && actualMapping[key] !== undefined) {
          selectedIndex = actualMapping[key];
        }
        if (confidence && confidence[key] !== undefined) {
          columnConfidence = confidence[key];
        }
      });

      // ä¿¡é ¼åº¦æƒ…å ±ã‚’è¨˜éŒ²ï¼ˆæ¤œå‡ºã•ã‚Œãªãã¦ã‚‚ï¼‰
      if (columnConfidence > 0) {
        totalConfidenceInfo.push(`${columnType}: ${columnConfidence}%`);
      }

      if (selectedIndex !== null) {
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠã‚’è¨­å®š
        dropdown.value = selectedIndex;
        dropdown.classList.add('has-ai-selection');

        // ä¿¡é ¼åº¦ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
        showConfidenceBadge(columnType, columnConfidence, 'ai');

        console.log(`âœ… AIæ¤œå‡ºæˆåŠŸ: ${columnType} â†’ ${selectedIndex}åˆ— (ä¿¡é ¼åº¦: ${columnConfidence}%)`);
        detectedCount++;
      } else if (columnConfidence > 0) {
        // AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ : çµ±ä¸€çµ¶å¯¾é–¾å€¤ã«ã‚ˆã‚‹åˆ¤å®š
        const THRESHOLDS = {
          answer: 55, reason: 55,  // æ–‡è„ˆä¾å­˜åˆ—
          name: 65, class: 65      // æ˜ç¢ºãªåˆ—ç¨®åˆ¥
        };
        const threshold = THRESHOLDS[columnType] || 55;

        let badgeType = 'low-confidence';
        let statusMessage = '';

        if (columnConfidence >= threshold) {
          badgeType = 'candidate';
          statusMessage = `å€™è£œ (é–¾å€¤${threshold}%é”æˆ)`;
        } else if (columnConfidence >= 20) {
          badgeType = 'low-confidence';
          statusMessage = `æ¤œè¨ä¸­ (${Math.round(columnConfidence)}%)`;
        } else {
          statusMessage = `ä¿¡é ¼åº¦ä¸è¶³ (${Math.round(columnConfidence)}%)`;
        }

        console.log(`ğŸ” AIåˆ¤å®š: ${columnType}åˆ— - ${statusMessage} (ä¿¡é ¼åº¦: ${Math.round(columnConfidence)}%)`);
        showConfidenceBadge(columnType, columnConfidence, badgeType);
      }
    });

    // AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œã®æ”¹å–„ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if (detectedCount > 0) {
      const maxConfidence = Math.max(...Object.values(confidence));
      console.log(`ğŸ¯ AIåˆ¤å®šæ¤œå‡º: ${detectedCount}/4åˆ—ã‚’è‡ªå‹•è¨­å®š (æœ€é«˜ä¿¡é ¼åº¦: ${Math.round(maxConfidence)}%)`);
      console.log(`ğŸ“Š è©³ç´°: ${totalConfidenceInfo.join(', ')}`);
    } else if (totalConfidenceInfo.length > 0) {
      const maxConfidence = Math.max(...Object.values(confidence));
      const avgConfidence = Object.values(confidence).reduce((a, b) => a + b, 0) / Object.values(confidence).length;
      console.log(`ğŸ“Š AIåˆ¤å®šåˆ†æå®Œäº†: è‡ªå‹•è¨­å®šãªã— (æœ€é«˜: ${Math.round(maxConfidence)}%, å¹³å‡: ${Math.round(avgConfidence)}%)`);
      console.log(`ğŸ” å„åˆ—ä¿¡é ¼åº¦: ${totalConfidenceInfo.join(', ')} - æ‰‹å‹•é¸æŠã‚’ã”åˆ©ç”¨ãã ã•ã„`);
    } else {
      console.log('ğŸ’¡ AIæ¤œå‡ºçµæœãŒã‚ã‚Šã¾ã›ã‚“ - æ‰‹å‹•é¸æŠã‚’ãŠä½¿ã„ãã ã•ã„');
    }

    // AIæ¤œå‡ºæƒ…å ±ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
    const aiInfo = document.getElementById('ai-detection-info');
    if (aiInfo) {
      aiInfo.classList.remove('hidden');
    }
  }

  // ===========================================
  // ğŸ”— çµ±åˆãƒ†ã‚¹ãƒˆãƒ»æœ€çµ‚æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ 
  // ===========================================

  /**
   * ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®åˆ—åˆ¤å®šçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
   */
  function runIntegratedColumnTest() {
    if (!ClientMutex.acquire('runIntegratedColumnTest')) {
      showInfo('çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­ã§ã™â€¦');
      return;
    }

    try {
      console.log('ğŸ” runIntegratedColumnTest: çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹');

      // ç¾åœ¨ã®è¨­å®šã‚’åé›†
      const currentConfig = gatherConfiguration();
      const headers = window.currentHeaders || [];
      const columnMapping = currentConfig.columnMapping || {};

      if (!headers.length) {
        showError('çµ±åˆãƒ†ã‚¹ãƒˆã«ã¯å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶šãŒå¿…è¦ã§ã™');
        ClientMutex.release('runIntegratedColumnTest');
        return;
      }

      // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ
      const sampleData = generateTestSampleData(headers);

      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆè¨ºæ–­APIå‘¼ã³å‡ºã—
      google.script.run
        .withSuccessHandler(function(diagnosticsResult) {
          console.log('âœ… çµ±åˆè¨ºæ–­çµæœ:', diagnosticsResult);
          displayIntegratedTestResults(diagnosticsResult);
          ClientMutex.release('runIntegratedColumnTest');
        })
        .withFailureHandler(function(error) {
          console.error('âŒ çµ±åˆè¨ºæ–­ã‚¨ãƒ©ãƒ¼:', error);
          showError('çµ±åˆè¨ºæ–­ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          ClientMutex.release('runIntegratedColumnTest');
        })
        .performIntegratedColumnDiagnostics(headers, columnMapping, sampleData);

      showInfo('åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆè¨ºæ–­ã‚’å®Ÿè¡Œä¸­â€¦', 3000);

    } catch (error) {
      console.error('runIntegratedColumnTest ã‚¨ãƒ©ãƒ¼:', error);
      showError('çµ±åˆãƒ†ã‚¹ãƒˆã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
      ClientMutex.release('runIntegratedColumnTest');
    }
  }

  /**
   * ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
   * @param {Array} headers - ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—
   * @returns {Array} ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
   */
  function generateTestSampleData(headers) {
    const sampleData = [];

    try {
      // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ç”Ÿæˆ
      const testRow = Array(headers.length).fill(null);

      headers.forEach((header, index) => {
        const headerLower = String(header).toLowerCase();

        if (headerLower.includes('timestamp') || headerLower.includes('æ—¥æ™‚')) {
          testRow[index] = '2025/09/20 10:30:00';
        } else if (headerLower.includes('email') || headerLower.includes('ãƒ¡ãƒ¼ãƒ«')) {
          testRow[index] = 'test@example.com';
        } else if (headerLower.includes('answer') || headerLower.includes('å›ç­”')) {
          testRow[index] = 'ãƒ†ã‚¹ãƒˆå›ç­”ãƒ‡ãƒ¼ã‚¿';
        } else if (headerLower.includes('reason') || headerLower.includes('ç†ç”±')) {
          testRow[index] = 'ãƒ†ã‚¹ãƒˆç†ç”±ãƒ‡ãƒ¼ã‚¿';
        } else if (headerLower.includes('class') || headerLower.includes('ã‚¯ãƒ©ã‚¹')) {
          testRow[index] = '1å¹´Açµ„';
        } else if (headerLower.includes('name') || headerLower.includes('åå‰')) {
          testRow[index] = 'ãƒ†ã‚¹ãƒˆå¤ªéƒ';
        } else {
          testRow[index] = `ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿${index + 1}`;
        }
      });

      sampleData.push(testRow);
      console.log('ğŸ“Š generateTestSampleData: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†', sampleData);

      return sampleData;

    } catch (error) {
      console.error('generateTestSampleData ã‚¨ãƒ©ãƒ¼:', error);
      return [[]];
    }
  }

  /**
   * çµ±åˆãƒ†ã‚¹ãƒˆçµæœã®è¡¨ç¤º
   * @param {Object} diagnostics - è¨ºæ–­çµæœ
   */
  function displayIntegratedTestResults(diagnostics) {
    try {
      console.log('ğŸ“Š displayIntegratedTestResults: çµæœè¡¨ç¤ºé–‹å§‹');

      // çµæœãƒ‘ãƒãƒ«ã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
      let resultsPanel = document.getElementById('integrated-test-results');
      if (!resultsPanel) {
        resultsPanel = createIntegratedTestResultsPanel();
      }

      // çµæœã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç”Ÿæˆ
      const resultsHTML = generateTestResultsHTML(diagnostics);
      resultsPanel.innerHTML = resultsHTML;

      // ãƒ‘ãƒãƒ«è¡¨ç¤º
      resultsPanel.classList.remove('hidden');

      // çµæœã«å¿œã˜ãŸé€šçŸ¥
      if (diagnostics.summary.overallScore >= 90) {
        showSuccess(`âœ… åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼å®Œäº†ï¼ç·åˆã‚¹ã‚³ã‚¢: ${diagnostics.summary.overallScore}%`);
      } else if (diagnostics.summary.overallScore >= 70) {
        showInfo(`âš ï¸ åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã«æ”¹å–„ä½™åœ°ã‚ã‚Šã€‚ç·åˆã‚¹ã‚³ã‚¢: ${diagnostics.summary.overallScore}%`);
      } else {
        showError(`âŒ åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç·åˆã‚¹ã‚³ã‚¢: ${diagnostics.summary.overallScore}%`);
      }

      // æ¨å¥¨äº‹é …ã®è¡¨ç¤º
      if (diagnostics.recommendations.length > 0) {
        const criticalRecs = diagnostics.recommendations.filter(r => r.priority === 'critical');
        if (criticalRecs.length > 0) {
          showError(`é‡è¦: ${criticalRecs[0].message}`);
        }
      }

    } catch (error) {
      console.error('displayIntegratedTestResults ã‚¨ãƒ©ãƒ¼:', error);
      showError('ãƒ†ã‚¹ãƒˆçµæœã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  /**
   * çµ±åˆãƒ†ã‚¹ãƒˆçµæœãƒ‘ãƒãƒ«ã®ä½œæˆ
   * @returns {HTMLElement} çµæœãƒ‘ãƒãƒ«è¦ç´ 
   */
  function createIntegratedTestResultsPanel() {
    const panel = document.createElement('div');
    panel.id = 'integrated-test-results';
    panel.className = 'hidden mt-6 p-4 bg-gray-900/50 border border-gray-600 rounded-lg';

    // é©åˆ‡ãªæŒ¿å…¥ä½ç½®ã‚’è¦‹ã¤ã‘ã‚‹
    const insertAfter = document.getElementById('ai-detection-info') ||
                       document.querySelector('section[data-section="column-mapping"]') ||
                       document.querySelector('.column-mapping-section');

    if (insertAfter && insertAfter.parentNode) {
      insertAfter.parentNode.insertBefore(panel, insertAfter.nextSibling);
    } else {
      document.body.appendChild(panel);
    }

    return panel;
  }

  /**
   * ãƒ†ã‚¹ãƒˆçµæœHTMLç”Ÿæˆ
   * @param {Object} diagnostics - è¨ºæ–­çµæœ
   * @returns {string} ç”Ÿæˆã•ã‚ŒãŸHTML
   */
  function generateTestResultsHTML(diagnostics) {
    const overallScore = diagnostics.summary.overallScore;
    const scoreColor = overallScore >= 90 ? 'green' : overallScore >= 70 ? 'yellow' : 'red';

    let html = `
      <div class="mb-4">
        <h3 class="text-lg font-semibold text-white mb-2">ğŸ” åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ çµ±åˆè¨ºæ–­çµæœ</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="bg-gray-800 p-3 rounded">
            <div class="text-sm text-gray-400">ç·åˆã‚¹ã‚³ã‚¢</div>
            <div class="text-xl font-bold text-${scoreColor}-400">${overallScore}%</div>
          </div>
          <div class="bg-gray-800 p-3 rounded">
            <div class="text-sm text-gray-400">é‡å¤§ãªå•é¡Œ</div>
            <div class="text-xl font-bold text-red-400">${diagnostics.summary.criticalIssues || 0}ä»¶</div>
          </div>
          <div class="bg-gray-800 p-3 rounded">
            <div class="text-sm text-gray-400">è­¦å‘Š</div>
            <div class="text-xl font-bold text-yellow-400">${diagnostics.summary.warnings || 0}ä»¶</div>
          </div>
        </div>
      </div>
    `;

    // ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§
    if (diagnostics.systemHealth) {
      html += generateSystemHealthHTML(diagnostics.systemHealth);
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆçµæœ
    if (diagnostics.columnTests) {
      html += generateFieldTestsHTML(diagnostics.columnTests);
    }

    // æ¨å¥¨äº‹é …
    if (diagnostics.recommendations && diagnostics.recommendations.length > 0) {
      html += generateRecommendationsHTML(diagnostics.recommendations);
    }

    html += `
      <div class="text-xs text-gray-500 mt-4">
        è¨ºæ–­å®Ÿè¡Œæ™‚åˆ»: ${new Date(diagnostics.timestamp).toLocaleString()}
      </div>
    `;

    return html;
  }

  /**
   * ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§HTMLç”Ÿæˆ
   * @param {Object} systemHealth - ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§ãƒ‡ãƒ¼ã‚¿
   * @returns {string} HTML
   */
  function generateSystemHealthHTML(systemHealth) {
    return `
      <div class="mb-4">
        <h4 class="font-medium text-white mb-2">ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
          <div class="flex justify-between p-2 bg-gray-800 rounded">
            <span>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:</span>
            <span class="text-${getStatusColor(systemHealth.backend.status)}-400">
              ${systemHealth.backend.score}% (${systemHealth.backend.status})
            </span>
          </div>
          <div class="flex justify-between p-2 bg-gray-800 rounded">
            <span>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:</span>
            <span class="text-${getStatusColor(systemHealth.frontend.status)}-400">
              ${systemHealth.frontend.score}% (${systemHealth.frontend.status})
            </span>
          </div>
          <div class="flex justify-between p-2 bg-gray-800 rounded">
            <span>çµ±åˆ:</span>
            <span class="text-${getStatusColor(systemHealth.integration.status)}-400">
              ${systemHealth.integration.score}% (${systemHealth.integration.status})
            </span>
          </div>
        </div>
      </div>
    `;
  }

  /**
   * ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆHTMLç”Ÿæˆ
   * @param {Object} columnTests - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆçµæœ
   * @returns {string} HTML
   */
  function generateFieldTestsHTML(columnTests) {
    let html = `
      <div class="mb-4">
        <h4 class="font-medium text-white mb-2">ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ¥ãƒ†ã‚¹ãƒˆçµæœ</h4>
        <div class="space-y-1 text-sm">
    `;

    Object.entries(columnTests).forEach(([field, test]) => {
      const statusIcon = test.resolved ? 'âœ…' : 'âŒ';
      const severityColor = test.severity === 'critical' ? 'red' : test.severity === 'warning' ? 'yellow' : 'green';

      html += `
        <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
          <span>${statusIcon} ${field}</span>
          <span class="text-${severityColor}-400">
            ${test.resolved ? `${test.confidence}% (${test.method})` : 'Not Resolved'}
          </span>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;

    return html;
  }

  /**
   * æ¨å¥¨äº‹é …HTMLç”Ÿæˆ
   * @param {Array} recommendations - æ¨å¥¨äº‹é …
   * @returns {string} HTML
   */
  function generateRecommendationsHTML(recommendations) {
    let html = `
      <div class="mb-4">
        <h4 class="font-medium text-white mb-2">æ¨å¥¨äº‹é …</h4>
        <div class="space-y-2 text-sm">
    `;

    recommendations.forEach(rec => {
      const priorityColor = rec.priority === 'critical' ? 'red' : rec.priority === 'high' ? 'orange' : 'yellow';
      html += `
        <div class="p-2 bg-gray-800 rounded">
          <div class="text-${priorityColor}-400 font-medium">${rec.priority.toUpperCase()}</div>
          <div class="text-gray-300">${rec.message}</div>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;

    return html;
  }

  /**
   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¯¾å¿œã™ã‚‹è‰²ã‚’å–å¾—
   * @param {string} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
   * @returns {string} è‰²å
   */
  function getStatusColor(status) {
    switch (status) {
      case 'healthy': return 'green';
      case 'warning': return 'yellow';
      case 'critical': return 'red';
      case 'error': return 'red';
      default: return 'gray';
    }
  }



  // ğŸ¯ UXå‘ä¸Šï¼šæ¬¡ã‚¹ãƒ†ãƒƒãƒ—æ¡ˆå†…æ©Ÿèƒ½
  function showNextStepGuidance(result) {
    if (!result || !result.success) return;

    const mapping = result.mapping || {};
    const confidence = result.confidence || {};

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨çµ±ä¸€ã—ãŸé—¾å€¤ã‚·ã‚¹ãƒ†ãƒ 
    const THRESHOLDS = {
      answer: 55, reason: 55,  // æ–‡è„ˆä¾å­˜åˆ—
      name: 65, class: 65      // æ˜ç¢ºãªåˆ—ç¨®åˆ¥
    };

    const hasAutoApplied = Object.keys(mapping).some((columnType) => {
      const columnConfidence = confidence[columnType] || 0;
      const threshold = THRESHOLDS[columnType] || 55;
      return columnConfidence >= threshold;
    });

    // âœ… CLAUDE.mdæº–æ‹ : Promise-based UI feedback delay
    createPromiseDelay(1500).then(() => {
      if (hasAutoApplied) {
        showSuccess('âœ¨ AIåˆ¤å®šã‚’è‡ªå‹•é©ç”¨æ¸ˆã¿ã€‚ã€Œè¨­å®šã‚’ç¢ºèªã€ã§å®Œäº†ã§ãã¾ã™ï¼');
      } else {
        showInfo('ğŸ’¡ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§åˆ—ã‚’æ‰‹å‹•è¨­å®šã—ã¦ã‹ã‚‰ã€Œè¨­å®šã‚’ç¢ºèªã€ã—ã¦ãã ã•ã„');
      }
    }); // ä»–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¾Œã«è¡¨ç¤º
  }

  // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  function setupDropdownEventListeners(dropdowns) {
    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;

      dropdown.addEventListener('change', function () {
        handleDropdownChange(columnType, this);
      });
    });

    // AIæ¤œå‡ºã«æˆ»ã™ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.addEventListener('click', function () {
        resetToAIDetection();
      });
    }
  }

  // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤‰æ›´ã®å‡¦ç†
  function handleDropdownChange(columnType, dropdown) {
    const selectedValue = dropdown.value;
    console.log(`ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤‰æ›´: ${columnType} â†’ ${selectedValue}`);

    // æ—¢å­˜ã®CSSã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
    dropdown.classList.remove('has-ai-selection', 'has-manual-selection');

    if (selectedValue === '') {
      // é¸æŠè§£é™¤
      hideConfidenceBadge(columnType);
    } else {
      // æ‰‹å‹•é¸æŠ
      dropdown.classList.add('has-manual-selection');
      showConfidenceBadge(columnType, 100, 'manual');

      // AIæ¤œå‡ºã«æˆ»ã™ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      const resetButton = document.getElementById('reset-to-ai');
      if (resetButton) {
        resetButton.style.display = 'inline-block';
      }

      // æ‰‹å‹•è¨­å®šæƒ…å ±ã‚’è¡¨ç¤º
      const manualInfo = document.getElementById('manual-override-info');
      if (manualInfo) {
        manualInfo.classList.remove('hidden');
      }
    }

    // é¸æŠçŠ¶æ³ã‚’æ›´æ–°
    updateSelectionStatus();
  }

  // ä¿¡é ¼åº¦ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
  function showConfidenceBadge(columnType, confidence, type) {
    const confidenceDiv = document.getElementById(`${columnType}-confidence`);
    const badge = confidenceDiv.querySelector('.confidence-badge');

    if (!confidenceDiv || !badge) return;

    let badgeClass = '';
    let badgeText = '';

    if (type === 'manual') {
      badgeClass = 'manual';
      badgeText = 'âœ‹ æ‰‹å‹•è¨­å®š';
    } else if (type === 'ai') {
      // AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã§è‡ªå‹•è¨­å®šã•ã‚ŒãŸå ´åˆ
      badgeClass = 'high';
      badgeText = `ğŸ¯ AIåˆ¤å®š ${Math.round(confidence)}%`;
    } else if (type === 'candidate') {
      // AIåˆ¤å®šã§å€™è£œã¨ã—ã¦æ¤œå‡ºã•ã‚ŒãŸå ´åˆ
      badgeClass = 'candidate';
      badgeText = `ğŸ” å€™è£œ ${Math.round(confidence)}%`;
    } else if (type === 'low-confidence') {
      // ä¿¡é ¼åº¦ãŒä½ã„å ´åˆ
      badgeClass = 'low';
      badgeText = `ğŸ“Š æ¤œè¨ä¸­ ${Math.round(confidence)}%`;
    } else {
      // çµ±ä¸€é—¾å€¤ã‚·ã‚¹ãƒ†ãƒ ã§ã®AIæ¤œå‡ºåˆ¤å®š
      const THRESHOLDS = {
        answer: 55, reason: 55,  // æ–‡è„ˆä¾å­˜åˆ—
        name: 65, class: 65      // æ˜ç¢ºãªåˆ—ç¨®åˆ¥
      };
      const threshold = THRESHOLDS[columnType] || 55;

      if (confidence >= threshold) {
        badgeClass = 'high';
        badgeText = `ğŸ¤– AIæ¤œå‡º ${Math.round(confidence)}%`;
      } else if (confidence >= Math.max(threshold * 0.7, 20)) {
        badgeClass = 'medium';
        badgeText = `ğŸ¤– AIæ¤œå‡º ${Math.round(confidence)}%`;
      } else {
        badgeClass = 'low';
        badgeText = `ğŸ¤– AIæ¤œå‡º ${Math.round(confidence)}%`;
      }
    }

    badge.className = `confidence-badge ${badgeClass}`;
    badge.textContent = badgeText;
    confidenceDiv.classList.remove('hidden');
  }

  // ä¿¡é ¼åº¦ãƒãƒƒã‚¸ã‚’éè¡¨ç¤º
  function hideConfidenceBadge(columnType) {
    const confidenceDiv = document.getElementById(`${columnType}-confidence`);
    if (confidenceDiv) {
      confidenceDiv.classList.add('hidden');
    }
  }

  // AIæ¤œå‡ºæƒ…å ±ã‚’è¡¨ç¤º
  function displayAIDetectionInfo(mapping, confidence = {}) {
    const detailsDiv = document.getElementById('ai-detection-details');
    if (!detailsDiv) return;

    // é˜²å¾¡çš„ãƒã‚§ãƒƒã‚¯: mappingãŒundefined/nullã®å ´åˆã¯æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
    if (!mapping || typeof mapping !== 'object') {
      console.log('ğŸ’¡ AIæ¤œå‡ºçµæœãŒã‚ã‚Šã¾ã›ã‚“ - displayAIDetectionInfo');
      detailsDiv.innerHTML = '<div class="text-gray-400 text-sm">AIæ¤œå‡ºçµæœãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    const details = [];
    const columnNames = {
      answerer: 'å›ç­”åˆ—',
      reason: 'ç†ç”±åˆ—',
      class: 'ã‚¯ãƒ©ã‚¹åˆ—',
      name: 'åå‰åˆ—',
    };

    const actualMapping = mapping.mapping || mapping;
    Object.keys(columnNames).forEach((key) => {
      if (actualMapping[key] !== null && actualMapping[key] !== undefined) {
        const columnLabel = String.fromCharCode(65 + actualMapping[key]) + 'åˆ—';
        const columnConfidence = confidence[key] || 0;
        details.push(`${columnNames[key]}: ${columnLabel} (ä¿¡é ¼åº¦: ${Math.round(columnConfidence)}%)`);
      }
    });

    // XSSå¯¾ç­–: DOMæ“ä½œã§å®‰å…¨ã«è©³ç´°æƒ…å ±ã‚’è¨­å®š
    detailsDiv.innerHTML = '';
    details.forEach(detail => {
      const div = document.createElement('div');
      div.textContent = `â€¢ ${detail}`;
      detailsDiv.appendChild(div);
    });
  }

  // é¸æŠçŠ¶æ³ã‚’æ›´æ–°
  function updateSelectionStatus() {
    const hasManualSelection =
      document.querySelectorAll('.modern-select.has-manual-selection').length > 0;
    const hasAISelection = document.querySelectorAll('.modern-select.has-ai-selection').length > 0;

    console.log('é¸æŠçŠ¶æ³:', { hasManualSelection, hasAISelection });

    // AIæ¤œå‡ºæƒ…å ±ã¨ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.style.display = hasManualSelection ? 'inline-block' : 'none';
    }
  }

  // AIæ¤œå‡ºçµæœã«æˆ»ã™
  function resetToAIDetection() {
    console.log('AIæ¤œå‡ºçµæœã«ãƒªã‚»ãƒƒãƒˆ');

    if (!window.currentAIMapping) {
      showError('AIæ¤œå‡ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    // å…¨ã¦ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    const dropdowns = {
      answer: document.getElementById('answer-column-select'),
      reason: document.getElementById('reason-column-select'),
      class: document.getElementById('class-column-select'),
      name: document.getElementById('name-column-select'),
    };

    // AIæ¤œå‡ºçµæœã‚’å†è¨­å®š
    setAIDetectionSelections(window.currentAIMapping, dropdowns);

    // æ‰‹å‹•è¨­å®šæƒ…å ±ã‚’éè¡¨ç¤º
    const manualInfo = document.getElementById('manual-override-info');
    if (manualInfo) {
      manualInfo.classList.add('hidden');
    }

    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.style.display = 'none';
    }

    showSuccess('âœ… AIæ¤œå‡ºçµæœã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  }

  // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª
  function verifyColumnMapping() {
    if (!ClientMutex.acquire('verifyColumnMapping')) {
      showInfo('æ¤œè¨¼å‡¦ç†ã‚’å®Ÿè¡Œä¸­ã§ã™â€¦');
      return;
    }

    // æ¥ç¶šæ–¹å¼ã«å¿œã˜ã¦é©åˆ‡ãªæ–¹æ³•ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—
    const sourceMethod = document.querySelector('input[name="source-method"]:checked').value;
    let spreadsheetId, sheetName;

    if (sourceMethod === 'url') {
      // URLå…¥åŠ›æ–¹å¼
      const urlInput = document.getElementById('spreadsheet-url');
      const url = urlInput.value.trim();
      const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
      const match = url.match(spreadsheetRegex);

      if (match) {
        spreadsheetId = match[1];
      }
      sheetName = document.getElementById('sheet-name-input').value.trim();
    } else {
      // ä¸€è¦§é¸æŠæ–¹å¼
      spreadsheetId = document.getElementById('spreadsheet-select').value;
      sheetName = document.getElementById('sheet-select').value;
    }

    if (!spreadsheetId || !sheetName) {
      showError('æ¤œè¨¼ã™ã‚‹ã«ã¯ã¾ãšã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨ã‚·ãƒ¼ãƒˆã‚’æ¥ç¶šã—ã¦ãã ã•ã„');
      return;
    }

    setLoading(true);

    console.log('verifyColumnMapping: åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æ¤œè¨¼é–‹å§‹', { spreadsheetId, sheetName });

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã¯æ¥ç¶šæ™‚ã«ä¿æŒã—ãŸã‚‚ã®ã‚’ä½¿ç”¨ï¼ˆãªã‘ã‚Œã°æœ€å°åŒ–ï¼‰
    let headers = Array.isArray(window.currentHeaders) ? window.currentHeaders : [];
    if (!headers.length) {
      const options = document.querySelectorAll('#answer-column-select option');
      headers = Array.from(options)
        .map((opt) => {
          const txt = opt.textContent || '';
          const parts = txt.split(': ');
          return parts.length > 1 ? parts.slice(1).join(': ') : '';
        })
        .filter(Boolean);
    }

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’åé›†
    const selections = gatherColumnSelections();
    const mapping = { mapping: {}, confidence: {} };
    ['answer', 'reason', 'class', 'name'].forEach((key) => {
      const sel = selections[key];
      if (sel && typeof sel.columnIndex === 'number') {
        mapping.mapping[key] = sel.columnIndex;
        if (typeof sel.confidence === 'number') mapping.confidence[key] = sel.confidence;
      }
    });

    // è¡¨ç¤ºç”¨ã«æ¤œè¨¼çµæœã‚’æç”»
    displayVerificationResults({ ok: true });

    // è¨­å®šã‚’ä¿å­˜ï¼ˆheaders + columnMapping ã§çµ±ä¸€ï¼‰
    saveColumnConfiguration(spreadsheetId, sheetName, headers, mapping);

    showSuccess('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã®æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ');
    updateProgress(3);
    setLoading(false);
    ClientMutex.release('verifyColumnMapping');
  }

  // æ¤œè¨¼çµæœã®è¡¨ç¤º
  function displayVerificationResults(headerIndices) {
    console.log('æ¤œè¨¼çµæœã®è¡¨ç¤ºã‚’é–‹å§‹:', headerIndices);

    // ğŸ¯ å®Ÿéš›ã®UIãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¦ç´ ã«æ¤œè¨¼æ¸ˆã¿ãƒãƒƒã‚¸ã‚’è¿½åŠ 
    const columnTypes = ['answer', 'reason', 'class', 'name'];
    let badgesAdded = 0;

    columnTypes.forEach(columnType => {
      const dropdown = document.getElementById(`${columnType}-column-select`);
      const confidenceDiv = document.getElementById(`${columnType}-confidence`);

      if (dropdown && dropdown.value !== '') {
        // æ—¢å­˜ã®æ¤œè¨¼æ¸ˆã¿ãƒãƒƒã‚¸ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        const existingBadge = dropdown.parentElement.querySelector('.verification-badge');
        if (existingBadge) {
          existingBadge.remove();
        }

        // æ–°ã—ã„æ¤œè¨¼æ¸ˆã¿ãƒãƒƒã‚¸ã‚’ä½œæˆ
        const verifiedBadge = document.createElement('span');
        verifiedBadge.className = 'verification-badge status-badge published';
        verifiedBadge.textContent = 'âœ“ æ¤œè¨¼æ¸ˆã¿';
        verifiedBadge.style.fontSize = '0.75rem';
        verifiedBadge.style.marginLeft = '0.5rem';
        verifiedBadge.style.display = 'inline-flex';
        verifiedBadge.style.alignItems = 'center';

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è¦ªè¦ç´ ã«è¿½åŠ 
        if (confidenceDiv) {
          confidenceDiv.appendChild(verifiedBadge);
        } else {
          dropdown.parentElement.appendChild(verifiedBadge);
        }

        badgesAdded++;
        console.log(`âœ… æ¤œè¨¼æ¸ˆã¿ãƒãƒƒã‚¸ã‚’è¿½åŠ : ${columnType}åˆ—`);
      }
    });

    // ğŸ¯ åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã«æ¤œè¨¼å®Œäº†ãƒãƒ¼ã‚¯ã‚’è¿½åŠ 
    const sectionHeaders = document.querySelectorAll('section h2');
    let mappingSection = null;

    sectionHeaders.forEach(header => {
      const headerText = header.textContent || '';
      if (headerText.includes('AIåˆ—ãƒãƒƒãƒ”ãƒ³ã‚°') || headerText.includes('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°')) {
        mappingSection = header.closest('section');
      }
    });

    if (mappingSection) {
      // æ—¢å­˜ã®æ¤œè¨¼å®Œäº†ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤
      const existingMark = mappingSection.querySelector('.section-verified-mark');
      if (existingMark) {
        existingMark.remove();
      }

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ¤œè¨¼å®Œäº†ãƒãƒ¼ã‚¯ã‚’è¿½åŠ 
      const sectionMark = document.createElement('div');
      sectionMark.className = 'section-verified-mark';
      sectionMark.innerHTML = `
        <div class="flex items-center gap-2 mt-4 p-3 bg-green-900/20 border border-green-500/30 rounded-lg">
          <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span class="text-green-400 font-medium">åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ</span>
        </div>
      `;

      const actionButtons = mappingSection.querySelector('.action-buttons');
      if (actionButtons) {
        actionButtons.parentElement.insertBefore(sectionMark, actionButtons);
      } else {
        mappingSection.appendChild(sectionMark);
      }
    }

    console.log(`âœ… æ¤œè¨¼çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸ: ${badgesAdded}å€‹ã®ãƒãƒƒã‚¸ã‚’è¿½åŠ `);
  }

  // ===========================================
  // ğŸ›¡ï¸ åˆ—è¨­å®šä¿å­˜ã®æ¤œè¨¼ãƒ»å …ç‰¢åŒ–ã‚·ã‚¹ãƒ†ãƒ 
  // ===========================================

  /**
   * åˆ—è¨­å®šãƒ‡ãƒ¼ã‚¿ã®åŒ…æ‹¬çš„æ¤œè¨¼
   * @param {string} spreadsheetId - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
   * @param {string} sheetName - ã‚·ãƒ¼ãƒˆå
   * @param {Array} headers - ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—
   * @param {Object} columnMapping - åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°
   * @returns {Object} æ¤œè¨¼çµæœ
   */
  function validateColumnConfigurationData(spreadsheetId, sheetName, headers, columnMapping) {
    const validation = {
      isValid: true,
      errors: [],
      warnings: [],
      recommendations: []
    };

    try {
      // ğŸ” åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼
      if (!spreadsheetId || typeof spreadsheetId !== 'string' || spreadsheetId.trim() === '') {
        validation.errors.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒç„¡åŠ¹ã§ã™');
        validation.isValid = false;
      }

      if (!sheetName || typeof sheetName !== 'string' || sheetName.trim() === '') {
        validation.errors.push('ã‚·ãƒ¼ãƒˆåãŒç„¡åŠ¹ã§ã™');
        validation.isValid = false;
      }

      // ğŸ” ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—æ¤œè¨¼
      if (!Array.isArray(headers) || headers.length === 0) {
        validation.errors.push('ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—ãŒç„¡åŠ¹ã¾ãŸã¯ç©ºã§ã™');
        validation.isValid = false;
      } else {
        const emptyHeaders = headers.filter((h, i) => !h || String(h).trim() === '');
        if (emptyHeaders.length > 0) {
          validation.warnings.push(`${emptyHeaders.length}å€‹ã®ç©ºãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚ã‚Šã¾ã™`);
        }
      }

      // ğŸ” åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æ¤œè¨¼
      if (!columnMapping || typeof columnMapping !== 'object') {
        validation.errors.push('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ãŒç„¡åŠ¹ã§ã™');
        validation.isValid = false;
      } else {
        const mappingData = columnMapping.mapping || columnMapping;
        const confidenceData = columnMapping.confidence || {};

        // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç¢ºèª
        const requiredFields = ['answer'];
        const missingRequired = requiredFields.filter(field =>
          mappingData[field] === undefined || mappingData[field] === null || mappingData[field] < 0
        );

        if (missingRequired.length > 0) {
          validation.errors.push(`å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³: ${missingRequired.join(', ')}`);
          validation.isValid = false;
        }

        // åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å¦¥å½“æ€§ç¢ºèª
        Object.keys(mappingData).forEach(field => {
          const index = mappingData[field];
          if (typeof index === 'number') {
            if (index < 0) {
              validation.errors.push(`${field}ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè² ã®å€¤ã§ã™`);
              validation.isValid = false;
            } else if (headers && index >= headers.length) {
              validation.errors.push(`${field}ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(${index})ãŒãƒ˜ãƒƒãƒ€ãƒ¼ç¯„å›²å¤–ã§ã™`);
              validation.isValid = false;
            }
          }
        });

        // ä¿¡é ¼åº¦ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
        const lowConfidenceFields = Object.keys(confidenceData).filter(field =>
          confidenceData[field] < 30
        );
        if (lowConfidenceFields.length > 0) {
          validation.warnings.push(`ä½ä¿¡é ¼åº¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: ${lowConfidenceFields.join(', ')}`);
          validation.recommendations.push('ç®¡ç†ãƒ‘ãƒãƒ«ã§æ‰‹å‹•èª¿æ•´ã‚’æ¤œè¨ã—ã¦ãã ã•ã„');
        }

        // é‡è¤‡åˆ—æ¤œå‡º
        const usedIndices = Object.values(mappingData).filter(v => typeof v === 'number' && v >= 0);
        const duplicateIndices = usedIndices.filter((index, i, arr) => arr.indexOf(index) !== i);
        if (duplicateIndices.length > 0) {
          validation.warnings.push(`é‡è¤‡åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${duplicateIndices.join(', ')}`);
          validation.recommendations.push('ç•°ãªã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒåŒã˜åˆ—ã‚’æŒ‡ã—ã¦ã„ã¾ã™');
        }
      }

      // ğŸ¯ è¨­å®šå“è³ªã‚¹ã‚³ã‚¢ç®—å‡º
      if (validation.isValid) {
        validation.qualityScore = calculateConfigurationQualityScore(headers, columnMapping);
        if (validation.qualityScore < 70) {
          validation.warnings.push(`è¨­å®šå“è³ªã‚¹ã‚³ã‚¢: ${validation.qualityScore}% - æ”¹å–„ä½™åœ°ã‚ã‚Š`);
        }
      }

      console.log('ğŸ›¡ï¸ validateColumnConfigurationDataçµæœ:', validation);
      return validation;

    } catch (error) {
      console.error('validateColumnConfigurationData ã‚¨ãƒ©ãƒ¼:', error);
      return {
        isValid: false,
        errors: ['æ¤œè¨¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'],
        error: error.message
      };
    }
  }

  /**
   * è¨­å®šå“è³ªã‚¹ã‚³ã‚¢ç®—å‡º
   * @param {Array} headers - ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—
   * @param {Object} columnMapping - åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°
   * @returns {number} å“è³ªã‚¹ã‚³ã‚¢ (0-100)
   */
  function calculateConfigurationQualityScore(headers, columnMapping) {
    let score = 0;
    const maxScore = 100;

    try {
      const mappingData = columnMapping.mapping || columnMapping;
      const confidenceData = columnMapping.confidence || {};

      // åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å­˜åœ¨ (40ç‚¹)
      const basicFields = ['answer', 'reason', 'class', 'name'];
      const definedFields = basicFields.filter(field =>
        mappingData[field] !== undefined && mappingData[field] !== null && mappingData[field] >= 0
      );
      score += (definedFields.length / basicFields.length) * 40;

      // ä¿¡é ¼åº¦ã®é«˜ã• (30ç‚¹)
      const avgConfidence = Object.values(confidenceData).length > 0
        ? Object.values(confidenceData).reduce((sum, conf) => sum + conf, 0) / Object.values(confidenceData).length
        : 50;
      score += (avgConfidence / 100) * 30;

      // ãƒ˜ãƒƒãƒ€ãƒ¼å“è³ª (20ç‚¹)
      const headerQuality = headers ?
        headers.filter(h => h && String(h).trim() !== '').length / headers.length * 100 : 0;
      score += (headerQuality / 100) * 20;

      // ãƒãƒƒãƒ”ãƒ³ã‚°ä¸€æ„æ€§ (10ç‚¹)
      const usedIndices = Object.values(mappingData).filter(v => typeof v === 'number' && v >= 0);
      const uniqueness = usedIndices.length > 0 ?
        new Set(usedIndices).size / usedIndices.length * 100 : 100;
      score += (uniqueness / 100) * 10;

      return Math.round(Math.max(0, Math.min(maxScore, score)));

    } catch (error) {
      console.error('calculateConfigurationQualityScore ã‚¨ãƒ©ãƒ¼:', error);
      return 50; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚³ã‚¢
    }
  }

  /**
   * è¨­å®šä¿å­˜ã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹
   * @param {Object} config - ä¿å­˜ã™ã‚‹è¨­å®š
   * @param {number} maxRetries - æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°
   * @returns {Promise} ä¿å­˜çµæœ
   */
  function saveConfigurationWithRetry(config, maxRetries = 3) {
    return new Promise((resolve, reject) => {
      let attempt = 0;

      function attemptSave() {
        attempt++;
        console.log(`ğŸ”„ è¨­å®šä¿å­˜è©¦è¡Œ ${attempt}/${maxRetries}`);

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              console.log(`âœ… è¨­å®šä¿å­˜æˆåŠŸ (è©¦è¡Œ ${attempt})`);
              resolve(result);
            } else {
              console.warn(`âš ï¸ è¨­å®šä¿å­˜å¤±æ•— (è©¦è¡Œ ${attempt}):`, result.error);
              if (attempt < maxRetries) {
                // CLAUDE.mdæº–æ‹ : Promise-basedæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ• (setTimeoutä»£æ›¿)
                const delay = Math.pow(2, attempt) * 1000;
                new Promise(resolve => {
                  const startTime = Date.now();
                  const checkTime = () => {
                    if (Date.now() - startTime >= delay) {
                      resolve();
                    } else {
                      requestAnimationFrame(checkTime);
                    }
                  };
                  checkTime();
                }).then(attemptSave);
              } else {
                reject(new Error(result.error || 'è¨­å®šä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'));
              }
            }
          })
          .withFailureHandler(function(error) {
            console.error(`âŒ è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼ (è©¦è¡Œ ${attempt}):`, error);
            if (attempt < maxRetries) {
              // CLAUDE.mdæº–æ‹ : Promise-basedæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ• (setTimeoutä»£æ›¿)
              const delay = Math.pow(2, attempt) * 1000;
              new Promise(resolve => {
                const startTime = Date.now();
                const checkTime = () => {
                  if (Date.now() - startTime >= delay) {
                    resolve();
                  } else {
                    requestAnimationFrame(checkTime);
                  }
                };
                checkTime();
              }).then(attemptSave);
            } else {
              reject(error);
            }
          })
          .saveConfig(config);
      }

      attemptSave();
    });
  }


  // ğŸ”’ åˆ—è¨­å®šã®ä¿å­˜ï¼ˆå …ç‰¢åŒ–ç‰ˆï¼‰
  function saveColumnConfiguration(spreadsheetId, sheetName, headers, columnMapping) {
    // ğŸ”§ CLAUDE.mdæº–æ‹ : ClientMutexã§é‡è¤‡å®Ÿè¡Œé˜²æ­¢
    if (!ClientMutex.acquire('saveColumnConfiguration')) {
      showInfo('åˆ—è¨­å®šã®ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œä¸­ã§ã™â€¦');
      return;
    }

    try {
      // ğŸ›¡ï¸ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
      const validationResult = validateColumnConfigurationData(spreadsheetId, sheetName, headers, columnMapping);
      if (!validationResult.isValid) {
        showError(`åˆ—è¨­å®šã®æ¤œè¨¼ã«å¤±æ•—: ${validationResult.errors.join(', ')}`);
        ClientMutex.release('saveColumnConfiguration');
        return;
      }

      // ğŸ¯ ConfigJsonæœ€é©åŒ–: é‡è¤‡é˜²æ­¢ã®å˜ä¸€è²¬ä»»è¨­è¨ˆ
      const timestamp = new Date().toISOString();

    const baseConfig = {
      spreadsheetId,
      sheetName,
      headers: headers, // ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«headersï¼ˆUIè¡¨ç¤ºç”¨ï¼‰
      columnMapping: {
        ...columnMapping,
        headers: headers, // columnMappingå†…headersï¼ˆã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨ï¼‰
        verifiedAt: timestamp // æ¤œè¨¼æ™‚åˆ»ã¯è«–ç†çš„ã«mappingå†…ã®ã¿
      },
      setupComplete: true,
      etag: (systemState && systemState.config && systemState.config.etag) || undefined,
    };

    // ğŸ”§ CLAUDE.mdæº–æ‹ : constå†ä»£å…¥ã‚¨ãƒ©ãƒ¼å›é¿ - æ¡ä»¶åˆ†å²ã§å®‰å…¨ãªæ§‹ç¯‰
    const optimizedConfig = systemState && systemState.config ? {
      ...baseConfig, // æ–°ã—ã„è¨­å®šã‚’åŸºæœ¬ã¨ã™ã‚‹
      // æ—¢å­˜è¨­å®šã‹ã‚‰ä¿æŒã™ã¹ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æ˜ç¤ºçš„ã«å–å¾—
      userId: systemState.config.userId,
      setupStatus: systemState.config.setupStatus,
      isPublished: systemState.config.isPublished,
      publishedAt: systemState.config.publishedAt,
      userPermissions: systemState.config.userPermissions,
      displaySettings: systemState.config.displaySettings,
      // æ–°ã—ã„è¨­å®šã§æ˜ç¤ºçš„ã«ä¸Šæ›¸ãï¼ˆbaseConfigã§æ—¢ã«è¨­å®šæ¸ˆã¿ã ãŒæ˜ç¤ºçš„ã«ä¿è¨¼ï¼‰
      spreadsheetId,
      sheetName,
      headers,
      columnMapping: {
        ...columnMapping,
        headers: headers,
        verifiedAt: timestamp // çµ±ä¸€ã•ã‚ŒãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
      }
    } : baseConfig;

      // ğŸ¯ ConfigJsonå®Œå…¨åŒæœŸ: Derived Fieldsè‡ªå‹•æ›´æ–°
      const isSpreadsheetChanged = optimizedConfig.spreadsheetId !== systemState.config.spreadsheetId;
      if (isSpreadsheetChanged) {
        console.log('ğŸ”„ SpreadsheetIdå¤‰æ›´æ¤œå‡º - Derived Fieldsæ›´æ–°é–‹å§‹:', {
          oldId: systemState.config.spreadsheetId,
          newId: optimizedConfig.spreadsheetId
        });

        // sourceKeyè‡ªå‹•ç”Ÿæˆ (UserService.gsãƒ­ã‚¸ãƒƒã‚¯æº–æ‹ )
        optimizedConfig.sourceKey = 'sheet_' + optimizedConfig.spreadsheetId + '_' + Date.now();

        // spreadsheetUrlè‡ªå‹•ç”Ÿæˆ
        optimizedConfig.spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/' + optimizedConfig.spreadsheetId + '/edit';

        // å¤ã„ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ã¯ç•°ãªã‚‹å¯èƒ½æ€§ï¼‰
        optimizedConfig.formUrl = null;
        optimizedConfig.formTitle = null;

        console.log('âœ… Derived Fieldsæ›´æ–°å®Œäº†:', {
          sourceKey: optimizedConfig.sourceKey,
          spreadsheetUrl: optimizedConfig.spreadsheetUrl,
          formCleared: 'ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚¯ãƒªã‚¢æ¸ˆã¿'
        });
      }

      // ğŸ¯ Object.assignæ®‹å­˜åˆ†ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæœ€å°é™ï¼‰
      if (optimizedConfig.verifiedAt) {
        delete optimizedConfig.verifiedAt; // columnMapping.verifiedAtã®ã¿ä½¿ç”¨
      }

      // ğŸ”— ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•é€£æº: æ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºãƒ»çµ±åˆï¼ˆå®‰å…¨ç‰ˆï¼‰
      if (!optimizedConfig.formUrl) {
        console.log('ğŸ” ãƒ•ã‚©ãƒ¼ãƒ é€£æºãªã— - è‡ªå‹•æ¤œå‡ºé–‹å§‹');

        google.script.run
          .withSuccessHandler(function(formResult) {
            if (formResult.success && formResult.formData && formResult.formData.formUrl) {
              optimizedConfig.formUrl = formResult.formData.formUrl;
              optimizedConfig.formTitle = formResult.formData.formTitle;
              console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•é€£æºå®Œäº†:', {
                formUrl: optimizedConfig.formUrl,
                formTitle: optimizedConfig.formTitle
              });
            } else {
              console.log('â„¹ï¸ ãƒ•ã‚©ãƒ¼ãƒ é€£æºãªã—ï¼ˆé€šå¸¸çŠ¶æ…‹ï¼‰');
            }
            executeConfigSave();
          })
          .withFailureHandler(function(error) {
            console.warn('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•æ¤œå‡ºã‚¨ãƒ©ãƒ¼ï¼ˆå®‰å…¨ã«ç¶™ç¶šï¼‰:', error.message);
            executeConfigSave();
          })
          .getFormInfo(spreadsheetId, sheetName);
        return;
      }

    // é€šå¸¸ã®ä¿å­˜å‡¦ç†å®Ÿè¡Œ
    executeConfigSave();

    function executeConfigSave() {
      console.log('ğŸ“‹ å®Œå…¨åŒæœŸConfigä¿å­˜æº–å‚™:', {
        spreadsheetId: optimizedConfig.spreadsheetId,
        sheetName: optimizedConfig.sheetName,
        sourceKey: optimizedConfig.sourceKey,
        spreadsheetUrl: optimizedConfig.spreadsheetUrl,
        formUrl: optimizedConfig.formUrl || 'ãªã—',
        formTitle: optimizedConfig.formTitle || 'ãªã—',
        hasColumnMapping: !!optimizedConfig.columnMapping,
        setupComplete: optimizedConfig.setupComplete,
        configSize: JSON.stringify(optimizedConfig).length
      });

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            console.log('âœ… ConfigJsonå®Œå…¨åŒæœŸä¿å­˜æˆåŠŸ:', {
              spreadsheetId: optimizedConfig.spreadsheetId,
              sourceKey: optimizedConfig.sourceKey,
              spreadsheetUrl: optimizedConfig.spreadsheetUrl,
              formUrl: optimizedConfig.formUrl || 'ãªã—',
              savedHeaders: headers.length,
              hasMapping: !!columnMapping,
              setupComplete: true,
              completeSyncStatus: 'å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°å®Œäº†'
            });

            // ğŸ”§ CLAUDE.mdæº–æ‹ : systemStateå®‰å…¨æ›´æ–°ï¼ˆç«¶åˆå›é¿ï¼‰
            if (systemState && systemState.config) {
              // æ˜ç¤ºçš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒ¼ã‚¸ã§æ„å›³ã—ãªã„ä¸Šæ›¸ãã‚’é˜²æ­¢
              systemState.config = {
                ...systemState.config,
                // åˆ—è¨­å®šé–¢é€£ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æ›´æ–°
                spreadsheetId: optimizedConfig.spreadsheetId,
                sheetName: optimizedConfig.sheetName,
                headers: optimizedConfig.headers,
                columnMapping: optimizedConfig.columnMapping,
                setupComplete: optimizedConfig.setupComplete,
                lastModified: optimizedConfig.lastModified || systemState.config.lastModified,
                // ğŸ”§ æ¥½è¦³çš„ãƒ­ãƒƒã‚¯: æ–°ã—ã„ETagã‚’æ›´æ–°
                etag: result.etag || result.config?.etag || systemState.config.etag
              };
            }

            // UIçŠ¶æ…‹ã‚’æ›´æ–°
            updateResourceButtons(optimizedConfig);
            showSuccess('âœ… åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ');
          } else {
            if (result.error === 'etag_mismatch') {
              showInfo('è¨­å®šãŒä»–ã§æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚ç”»é¢ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
              if (typeof loadAndApplyCurrentConfig === 'function') {
                loadAndApplyCurrentConfig();
              }
            } else {
              console.warn('åˆ—è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', result.error);
            }
          }
          ClientMutex.release('saveColumnConfiguration');
        })
        .withFailureHandler(function (error) {
          console.error('åˆ—è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          showError('åˆ—è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          ClientMutex.release('saveColumnConfiguration');
        })
        .saveConfig(optimizedConfig);
    }

    } catch (error) {
      console.error('åˆ—è¨­å®šä¿å­˜å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      showError('åˆ—è¨­å®šã®ä¿å­˜å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      ClientMutex.release('saveColumnConfiguration');
    }
  }

  // ä¸‹æ›¸ãä¿å­˜
  function saveDraft() {
    if (!ClientMutex.acquire('saveDraft')) {
      showInfo('ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œä¸­ã§ã™â€¦');
      return;
    }
    const config = gatherConfiguration();

    setLoading(true);
    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          showSuccess('ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          updateResourceButtons(result.config);
          // ETagæ›´æ–° - æ¥½è¦³çš„ãƒ­ãƒƒã‚¯æ©Ÿæ§‹
          if (result.etag || result.config?.etag) {
            systemState.config.etag = result.etag || result.config.etag;
          }
        } else {
          showError(result.error);
        }
        setLoading(false);
        ClientMutex.release('saveDraft');
      })
      .withFailureHandler(function (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        showError('ä¸‹æ›¸ãã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        setLoading(false);
        ClientMutex.release('saveDraft');
      })
      .saveConfig(config, { isDraft: true });
  }

  // ã‚¢ãƒ—ãƒªå…¬é–‹ï¼ˆgetConfigä¾å­˜ã‚’å‰Šé™¤ã—ã¦é‡è¤‡ä¿å­˜é˜²æ­¢ç‰ˆï¼‰
  function publishApp() {
    if (!ClientMutex.acquire('publishApp')) {
      showInfo('å…¬é–‹å‡¦ç†ã‚’å®Ÿè¡Œä¸­ã§ã™â€¦');
      return;
    }

    setLoading(true);

    try {
      // ğŸ”§ UIçŠ¶æ…‹ã‹ã‚‰å®Œå…¨ãªè¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’åé›†
      const config = gatherConfiguration();

      console.log('ğŸ“‹ publishApp: å®Œå…¨è¨­å®šãƒ‡ãƒ¼ã‚¿åé›†:', {
        hasSpreadsheetId: !!config.spreadsheetId,
        hasSheetName: !!config.sheetName,
        hasFormUrl: !!config.formUrl,
        hasFormTitle: !!config.formTitle,
        hasColumnMapping: !!config.columnMapping,
        configKeys: Object.keys(config)
      });

      if (!config || !config.spreadsheetId) {
        console.error('âŒ publishApp: UIè¨­å®šãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨:', {
          hasConfig: !!config,
          hasSpreadsheetId: !!(config?.spreadsheetId),
        });
        showError('ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        setLoading(false);
        ClientMutex.release('publishApp');
        return;
      }

      // ğŸš€ å®Œå…¨ãªè¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼ˆgatherConfiguration()ã®çµæœã‚’å®Œå…¨ä¿¡é ¼ï¼‰
      const publishConfig = config;

      console.log('ğŸ“‹ publishApp: å…¬é–‹è¨­å®šãƒ‡ãƒ¼ã‚¿ç¢ºèª:', {
        spreadsheetId: publishConfig.spreadsheetId,
        sheetName: publishConfig.sheetName,
        formUrl: publishConfig.formUrl,
        formTitle: publishConfig.formTitle,
        hasColumnMapping: !!publishConfig.columnMapping,
        configSize: JSON.stringify(publishConfig).length
      });

      // å®Œå…¨ãªè¨­å®šã§publishApplicationã‚’å‘¼ã³å‡ºã—
      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            showSuccess('ã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã—ã¾ã—ãŸï¼');
            updatePublishStatus('published');

            // å…¬é–‹å¾Œã«æœ€æ–°ã®è¨­å®šã‚’å–å¾—ã—ã¦ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            console.log('ğŸ“‹ å…¬é–‹æˆåŠŸ - æœ€æ–°è¨­å®šã‚’å–å¾—ã—ã¦ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°');

            // å…¬é–‹ãŒæˆåŠŸã—ãŸã®ã§ã€æœ€æ–°ã®è¨­å®šã‚’å–å¾—ã—ç›´ã—ã¦ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            google.script.run
              .withSuccessHandler(function(latestConfigResponse) {
                console.log('ğŸ“‹ æœ€æ–°è¨­å®šå–å¾—çµæœ:', latestConfigResponse);
                if (latestConfigResponse && latestConfigResponse.success && latestConfigResponse.config) {
                  updateResourceButtons(latestConfigResponse.config);
                  // ETagæ›´æ–° - æ¥½è¦³çš„ãƒ­ãƒƒã‚¯æ©Ÿæ§‹
                  if (latestConfigResponse.config.etag) {
                    systemState.config.etag = latestConfigResponse.config.etag;
                  }
                } else {
                  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•ã§è¨­å®šã‚’æ§‹ç¯‰
                  const updatedConfig = {
                    ...publishConfig,
                    isPublished: true,
                    publishedAt: result.publishedAt || new Date().toISOString(),
                    setupComplete: true
                  };
                  updateResourceButtons(updatedConfig);
                  // ETagæ›´æ–° - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã‚‚å®Ÿè¡Œ
                  if (result.etag || result.config?.etag) {
                    systemState.config.etag = result.etag || result.config.etag;
                  }
                }
              })
              .withFailureHandler(function(error) {
                console.warn('æœ€æ–°è¨­å®šå–å¾—ã«å¤±æ•—:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•ã§è¨­å®šã‚’æ§‹ç¯‰
                const updatedConfig = {
                  ...publishConfig,
                  isPublished: true,
                  publishedAt: result.publishedAt || new Date().toISOString(),
                  setupComplete: true
                };
                updateResourceButtons(updatedConfig);
                // ETagæ›´æ–° - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã‚‚å®Ÿè¡Œ
                if (result.etag || result.config?.etag) {
                  systemState.config.etag = result.etag || result.config.etag;
                }
              })
              .getConfig();

            // âœ… CLAUDE.mdæº–æ‹  & å…¬é–‹æˆåŠŸå¾Œï¼šå³åº§ã«ãƒ•ãƒƒã‚¿ãƒ¼ã‚’æ›´æ–°ï¼ˆUXå‘ä¸Šï¼‰
            createPromiseDelay(500).then(() => {
              loadBoardInfo(); // ãƒ•ãƒƒã‚¿ãƒ¼æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
            });
          } else {
            if (result.error === 'etag_mismatch') {
              showInfo('è¨­å®šãŒä»–ã§æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚ç”»é¢ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰å†åº¦å…¬é–‹ã—ã¦ãã ã•ã„ã€‚');
              if (typeof loadAndApplyCurrentConfig === 'function') {
                loadAndApplyCurrentConfig();
              }
            } else {
              showError(result.error);
            }
          }
          setLoading(false);
          ClientMutex.release('publishApp');
        })
        .withFailureHandler(function (error) {
          console.error('å…¬é–‹ã‚¨ãƒ©ãƒ¼:', error);
          showError(
            'ã‚¢ãƒ—ãƒªã®å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          );
          setLoading(false);
          ClientMutex.release('publishApp');
        })
        .publishApplication(publishConfig);

    } catch (error) {
      console.error('âŒ publishApp: UIè¨­å®šåé›†ã‚¨ãƒ©ãƒ¼:', error);
      showError('è¨­å®šã®åé›†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      setLoading(false);
      ClientMutex.release('publishApp');
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã®å®‰å…¨ãªåé›†ï¼ˆZero-Dependency Architectureæº–æ‹ ï¼‰
  function getCurrentFormInfoSafe() {
    try {
      const isUrlMethod = !document.getElementById('url-method')?.classList?.contains('hidden');

      const titleElement = isUrlMethod ?
        document.getElementById('url-form-title') :
        document.getElementById('form-title');
      const urlElement = isUrlMethod ?
        document.getElementById('url-form-url') :
        document.getElementById('form-url');

      return {
        formUrl: (urlElement?.href !== '#' && urlElement?.href) || null,
        formTitle: (titleElement?.textContent !== '-' && titleElement?.textContent) || null
      };
    } catch (error) {
      console.warn('getCurrentFormInfoSafe error:', error.message);
      return { formUrl: null, formTitle: null };
    }
  }

  // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã®å®‰å…¨ãªåé›†ï¼ˆV8 Runtimeæœ€é©åŒ–æº–æ‹ ï¼‰
  function gatherColumnSelectionsSafe() {
    try {
      // âœ… æ—¢å­˜é–¢æ•°ã®æ‹¡å¼µï¼ˆç ´å£Šçš„å¤‰æ›´å›é¿ï¼‰
      const existing = gatherColumnSelections();

      // âœ… ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã®å®‰å…¨ãªåé›†
      const answerSelect = document.getElementById('answer-column-select');
      const headers = answerSelect ?
        Array.from(answerSelect.options).slice(1).map(opt => opt.textContent) :
        [];

      return {
        ...existing,
        headers,
        verifiedAt: new Date().toISOString()
      };
    } catch (error) {
      console.warn('gatherColumnSelectionsSafe error:', error.message);
      return { mapping: {}, confidence: {}, headers: [] };
    }
  }

  // è¨­å®šåé›†ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¼å¯¾å¿œï¼‰
  function gatherConfiguration() {
    const sourceMethod = document.querySelector('input[name="source-method"]:checked').value;

    let spreadsheetId, sheetName;

    if (sourceMethod === 'url') {
      // URLå…¥åŠ›æ–¹å¼
      const urlInput = document.getElementById('spreadsheet-url');
      const url = urlInput.value.trim();
      const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
      const match = url.match(spreadsheetRegex);

      if (match) {
        spreadsheetId = match[1];
      }
      sheetName = document.getElementById('sheet-name-input').value.trim();
    } else {
      // ä¸€è¦§é¸æŠæ–¹å¼
      spreadsheetId = document.getElementById('spreadsheet-select').value;
      sheetName = document.getElementById('sheet-select').value;
    }

    console.log('ğŸ“‹ gatherConfiguration result:', {
      sourceMethod,
      spreadsheetId,
      sheetName,
      spreadsheetUrlValue: sourceMethod === 'url' ? document.getElementById('spreadsheet-url').value : 'N/A',
      spreadsheetSelectValue: sourceMethod === 'list' ? document.getElementById('spreadsheet-select').value : 'N/A'
    });

    // âœ… å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿åé›†ï¼ˆæ—¢å­˜çµ±ä¸€APIæ´»ç”¨ï¼‰
    const formInfo = getCurrentFormInfoSafe();
    const columnMapping = gatherColumnSelectionsSafe();

    return {
      spreadsheetId,
      sheetName,
      displaySettings: {
        showNames: document.getElementById('show-names')?.checked || false,
        showReactions: document.getElementById('show-reactions')?.checked || false
      },
      // ğŸ”§ NEW: ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±è¿½åŠ ï¼ˆå®‰å…¨ãªåé›†ï¼‰
      formUrl: formInfo.formUrl,
      formTitle: formInfo.formTitle,
      // ğŸ”§ NEW: åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°è¿½åŠ ï¼ˆæ—¢å­˜é–¢æ•°æ´»ç”¨ï¼‰
      columnMapping,
      etag: (systemState?.config?.etag) || undefined,
    };
  }

  // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰åˆ—é¸æŠæƒ…å ±ã‚’åé›†
  function gatherColumnSelections() {
    const dropdowns = {
      answer: document.getElementById('answer-column-select'),
      reason: document.getElementById('reason-column-select'),
      class: document.getElementById('class-column-select'),
      name: document.getElementById('name-column-select'),
    };

    const selections = {};
    let hasAnySelection = false;

    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;

      const selectedValue = dropdown.value;
      const isAI = dropdown.classList.contains('has-ai-selection');
      const isManual = dropdown.classList.contains('has-manual-selection');

      if (selectedValue !== '') {
        selections[columnType] = {
          columnIndex: parseInt(selectedValue),
          columnLabel: String.fromCharCode(65 + parseInt(selectedValue)) + 'åˆ—',
          selectionType: isManual ? 'manual' : 'ai',
          confidence: getColumnConfidence(columnType),
        };
        hasAnySelection = true;
      }
    });

    // AIæ¤œå‡ºã®å…ƒãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚ã‚‹
    if (window.currentAIMapping) {
      selections._aiMapping = window.currentAIMapping;
    }

    selections._hasSelections = hasAnySelection;

    console.log('gatherColumnSelections:', selections);
    return selections;
  }

  // Get column confidence level
  function getColumnConfidence(columnType) {
    const elementId = columnType + '-confidence';
    const confidenceDiv = document.getElementById(elementId);
    if (!confidenceDiv || confidenceDiv.classList.contains('hidden')) {
      return 0;
    }

    const badge = confidenceDiv.querySelector('.confidence-badge');
    if (!badge) return 0;

    const text = badge.textContent;
    const match = text.match(/(\d+)%/);
    return match ? parseInt(match[1]) : badge.classList.contains('manual') ? 100 : 0;
  }


  // å…¬é–‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  function updatePublishStatus(status) {
    const badge = document.querySelector('.status-badge.unpublished') || document.querySelector('.status-badge.published');
    if (badge) {
      badge.className = 'status-badge ' + status;
      badge.textContent = status === 'published' ? 'å…¬é–‹ä¸­' : 'æœªå…¬é–‹';
    }
  }

  // è¨­å®šã‚µãƒãƒªãƒ¼æ›´æ–°ï¼ˆé‡è¤‡å®Ÿè¡Œé˜²æ­¢æ©Ÿèƒ½ä»˜ãï¼‰
  let lastConfigUpdate = null;
  function updateConfigSummary(config) {
    try {
      // åŒä¸€ã®è¨­å®šãƒ‡ãƒ¼ã‚¿ã§ã®é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
      const configHash = config ? JSON.stringify({
        isPublished: config.isPublished,
        spreadsheetId: config.spreadsheetId,
        spreadsheetName: config.spreadsheetName,
        sheetName: config.sheetName,
        lastModified: config.lastModified
      }) : 'null';

      if (lastConfigUpdate === configHash) {
        return;
      }
      lastConfigUpdate = configHash;

      // ğŸ”§ çµ±ä¸€è¨­å®šãƒã‚§ãƒƒã‚¯: ConfigHelpersä½¿ç”¨ã§å‹æ•´åˆæ€§ä¿è¨¼
      const isPublished = ConfigHelpers.isPublished(config);
      const publishBadge = document.getElementById('app-publish-status');
      if (publishBadge) {
        if (isPublished) {
          publishBadge.className = 'status-badge published';
          publishBadge.textContent = 'å…¬é–‹ä¸­';
        } else {
          publishBadge.className = 'status-badge unpublished';
          publishBadge.textContent = 'æœªå…¬é–‹';
        }
      }

      // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ›´æ–°
      const datasourceElement = document.getElementById('current-datasource');
      if (datasourceElement) {
        if (config?.spreadsheetId) {
          const name = config.spreadsheetName || 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ';
          datasourceElement.textContent = name;
          datasourceElement.className = 'text-sm text-cyan-400';
        } else {
          datasourceElement.textContent = 'æœªè¨­å®š';
          datasourceElement.className = 'text-sm text-gray-400';
        }
      }

      // ã‚·ãƒ¼ãƒˆåæ›´æ–°
      const sheetnameElement = document.getElementById('current-sheetname');
      if (sheetnameElement) {
        if (config?.sheetName) {
          sheetnameElement.textContent = config.sheetName;
          sheetnameElement.className = 'text-sm text-cyan-400';
        } else {
          sheetnameElement.textContent = 'æœªè¨­å®š';
          sheetnameElement.className = 'text-sm text-gray-400';
        }
      }

      // æœ€çµ‚æ›´æ–°æ™‚åˆ»æ›´æ–°
      const lastUpdated = config?.lastModified || config?.updatedAt;
      const timeElement = document.getElementById('last-updated-time');
      if (timeElement) {
        if (lastUpdated) {
          try {
            const date = new Date(lastUpdated);
            const timeString = date.toLocaleString('ja-JP', {
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
            });
            timeElement.textContent = timeString;
            timeElement.className = 'text-sm text-gray-300';
          } catch (e) {
            timeElement.textContent = '--:--';
          }
        } else {
          timeElement.textContent = '--:--';
        }
      }

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒªãƒ³ã‚¯æ›´æ–°ï¼ˆãƒªã‚½ãƒ¼ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨ï¼‰
      const openSheetBtn = document.getElementById('open-spreadsheet-btn');
      if (openSheetBtn && config?.spreadsheetId) {
        openSheetBtn.disabled = false;
        openSheetBtn.onclick = () => {
          const spreadsheetUrl =
            'https://docs.google.com/spreadsheets/d/' + config.spreadsheetId + '/edit';
          window.open(spreadsheetUrl, '_blank');
              };
        openSheetBtn.style.pointerEvents = 'auto';
      } else if (openSheetBtn) {
        openSheetBtn.onclick = (e) => {
          e.preventDefault();
          showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        };
        openSheetBtn.style.opacity = '0.5';
        openSheetBtn.style.pointerEvents = 'auto';
      }
    } catch (error) {
      console.error('updateConfigSummary ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // =============================================================================
  // ãƒ•ãƒƒã‚¿ãƒ¼ï¼šç¾åœ¨ã®ãƒœãƒ¼ãƒ‰æƒ…å ±è¡¨ç¤ºæ©Ÿèƒ½
  // =============================================================================

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let currentBoardInfo = null;

  // ãƒœãƒ¼ãƒ‰æƒ…å ±ãƒ­ãƒ¼ãƒ‰
  function loadBoardInfo() {
    google.script.run
      .withSuccessHandler(function (boardInfo) {
        currentBoardInfo = boardInfo;
        updateFooterDisplay(boardInfo);
      })
      .withFailureHandler(function (error) {
        console.error('ãƒœãƒ¼ãƒ‰æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        updateFooterDisplay({
          isActive: false,
          questionText: 'æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼',
          error: error.message,
        });
      })
      .getBoardInfo();
  }

  // ãƒ•ãƒƒã‚¿ãƒ¼è¡¨ç¤ºæ›´æ–°
  function updateFooterDisplay(boardInfo) {
    const footer = document.getElementById('boardInfoFooter');
    const questionText = document.getElementById('currentQuestionText');
    const openBtn = document.getElementById('openBoardBtn');
    const copyBtn = document.getElementById('copyViewUrlBtn');
    const statusText = document.getElementById('boardStatus');

    // ğŸ”§ çµ±ä¸€è¨­å®šãƒã‚§ãƒƒã‚¯: ConfigHelpersä½¿ç”¨ã§å‹æ•´åˆæ€§ä¿è¨¼
    const isPublished = ConfigHelpers.isPublished(boardInfo);

    console.log('ğŸ” ãƒ•ãƒƒã‚¿ãƒ¼è¡¨ç¤ºåˆ¤å®š:', {
      isPublished: boardInfo.isPublished,
      isActive: boardInfo.isActive,
      finalIsPublished: isPublished,
      timestamp: new Date().toISOString(),
    });

    if (!isPublished) {
      footer.classList.add('hidden');
      return;
    }

    // å…¬é–‹æ™‚ã¯ãƒ•ãƒƒã‚¿ãƒ¼ã‚’è¡¨ç¤º
    footer.classList.remove('hidden');

    // å•é¡Œæ–‡è¨­å®š
    questionText.textContent = boardInfo.questionText || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

    if (boardInfo.isActive && boardInfo.urls) {
      // ãƒœã‚¿ãƒ³è¡¨ç¤ºãƒ»æ©Ÿèƒ½è¨­å®š
      openBtn.style.display = 'block';
      copyBtn.style.display = 'block';

      openBtn.onclick = () => window.open(boardInfo.urls.view, '_blank');
      copyBtn.onclick = () => copyViewUrl(boardInfo.urls.view);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      if (statusText) {
        statusText.textContent = 'æœ€çµ‚æ›´æ–°: ' + (boardInfo.lastUpdated || 'ä¸æ˜');
      }
    } else {
      // éã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
      openBtn.style.display = 'none';
      copyBtn.style.display = 'none';
      if (statusText) {
        statusText.textContent = boardInfo.error || 'ãƒœãƒ¼ãƒ‰ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã™';
      }
    }
  }

  // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
  function formatDate(dateString) {
    if (!dateString) return '--';
    try {
      const date = new Date(dateString);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      });
    } catch (e) {
      return '--';
    }
  }

  // URLã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ï¼ˆå®Ÿç”¨é‡è¦–ï¼‰
  function copyViewUrl(url) {
    if (!url) {
      showError('ã‚³ãƒ”ãƒ¼ã™ã‚‹URLãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard
        .writeText(url)
        .then(() => {
          showSuccess('é–²è¦§ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
          // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«å¤‰æ›´ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
          const btn = document.getElementById('copyViewUrlBtn');
          const originalText = btn.textContent;
          btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
          btn.disabled = true;

          // âœ… CLAUDE.mdæº–æ‹ : Promise-based UI state restoration
          createPromiseDelay(2000).then(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          });
        })
        .catch(() => {
          fallbackCopyUrl(url);
        });
    } else {
      fallbackCopyUrl(url);
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼‰
  function fallbackCopyUrl(url) {
    const textarea = document.createElement('textarea');
    textarea.value = url;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      showSuccess('é–²è¦§ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
    } catch (err) {
      // æœ€çµ‚æ‰‹æ®µï¼šURLã‚’è¡¨ç¤ºã—ã¦æ‰‹å‹•ã‚³ãƒ”ãƒ¼ã‚’ä¿ƒã™
      prompt('ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', url);
    }
    document.body.removeChild(textarea);
  }

  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åè‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½ã¯å‰Šé™¤ï¼ˆCLAUDE.mdæº–æ‹ ï¼‰

  // å›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹ã
  function openAnswerBoard() {
    google.script.run
      .withSuccessHandler(function (result) {
        if (result && result.appUrl) {
          window.open(result.appUrl, '_blank');
        } else {
          showError('å›ç­”ãƒœãƒ¼ãƒ‰ã®URLãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        }
      })
      .withFailureHandler(function (error) {
        showError('å›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: ' + error.message);
      })
      .getBoardInfo();
  }

  // ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã‚’é–‹ã
  function openAppSetup() {
    try {
      setPartialLoading(true, 'ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã«ç§»å‹•ä¸­...');

      // Google Apps Script WebApp URLå–å¾—ã—ã¦appSetupãƒ¢ãƒ¼ãƒ‰ã§é·ç§»
      google.script.run
        .withSuccessHandler(function (webAppUrl) {
          const setupUrl = webAppUrl + '?mode=appSetup';
          console.log('ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®é·ç§»:', setupUrl);

          // Google Apps Scriptç’°å¢ƒã§ã¯ window.open(_top) ã‚’ä½¿ç”¨
          window.open(setupUrl, '_top');
        })
        .withFailureHandler(function (error) {
          console.error('WebApp URLå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          setPartialLoading(false);
          showError('ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');

          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç¾åœ¨ã®URLãƒ™ãƒ¼ã‚¹ã§é·ç§»
          try {
            const currentUrl = new URL(window.location.href);
            const baseUrl = currentUrl.origin + currentUrl.pathname;
            const setupUrl = baseUrl + '?mode=appSetup';
            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é·ç§»:', setupUrl);
            window.open(setupUrl, '_top');
          } catch (fallbackError) {
            console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é·ç§»ã‚‚å¤±æ•—:', fallbackError);
          }
        })
        .getWebAppUrl();

    } catch (error) {
      console.error('openAppSetup error:', error);
      showError('ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
      setPartialLoading(false);
    }
  }

</script>
