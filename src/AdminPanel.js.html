<script>
  // Safe template variable extraction from data attributes
  let __USER_ID__ = '';
  if (typeof __USER_ID__ !== 'undefined') {
    // __USER_ID__ is already defined
  }
  try {
    const appData = document.getElementById('app-data');
    if (appData) {
      __USER_ID__ = appData.getAttribute('data-user-id') || '';
    }
  } catch (error) {
    __USER_ID__ = '';
  }

  // === SECTION SEPARATOR ===
  // 簡素化された状態管理
  let systemState = {
    loading: false,
    config: null,
  };

  let initializationStep = 'not started';

  // Wrap initialization in safe handler
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', safeInitialize);
  } else {
    // DOM already loaded, initialize immediately
    safeInitialize();
  }

  async function safeInitialize() {
    initializationStep = 'started';

    try {
      initializationStep = 'panel initialization';
      await initializePanel();

      initializationStep = 'admin check';
      checkSystemAdminAccess();

      initializationStep = 'footer initialization';
      initializeFooter();

      initializationStep = 'completed';
    } catch (error) {
      // Try to show error even if UI is not fully initialized
      try {
        showError('初期化エラー: ' + initializationStep + ' - ' + error.message);
      } catch (uiError) {
        alert('管理パネルの初期化に失敗しました。ページを再読み込みしてください。');
      }
    }
  }

  // フッター初期化
  function initializeFooter() {
    // 初回ボード情報ロード
    loadBoardInfo();

    // 更新ボタンのイベントハンドラ設定
    const refreshBtn = document.getElementById('refreshBoardInfo');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', loadBoardInfo);
    }

    // body padding調整（フッター分の余白を追加）
    document.body.classList.add('has-footer');
  }

  // 🚀 パネル初期化 - オンデマンド読み込み対応版（パフォーマンス最適化）
  async function initializePanel() {
    let step = 'starting';

    try {
      setLoading(true);

      // 並行処理で基本データを読み込み（ノンブロッキング）
      step = 'loading user info';
      await loadUserInfoAsync();

      // ⚡ 最適化：スプレッドシート一覧の自動読み込みを停止
      // ドロップダウンの初期化
      step = 'initializing dropdowns';
      await initializeDropdowns();

      // 設定データを読み込んで完全に自動反映
      step = 'loading and applying config';
      await loadAndApplyCurrentConfig();

      showSuccess('✅ 管理パネルの初期化が完了しました（最適化済み）');
    } catch (error) {
      showError('初期化に失敗しました (' + step + '): ' + error.message);
    } finally {
      setLoading(false);
    }
  }

  // シンプルなドロップダウン初期化（初期化時にデータ一括読み込み）
  async function initializeDropdowns() {
    const spreadsheetSelect = document.getElementById('spreadsheet-select');
    const sheetSelect = document.getElementById('sheet-select');
    
    if (!spreadsheetSelect) return;

    try {
      // スプレッドシート一覧を初期化時に読み込み
      await loadSpreadsheetListAsync();
      
      // 現在の設定から既存データを取得・反映
      const config = await getCurrentConfigAsync();
      if (config && config.spreadsheetId) {
        spreadsheetSelect.value = config.spreadsheetId;
        
        // 設定されているスプレッドシートのシート一覧を読み込み
        if (config.spreadsheetId) {
          await loadSheetList(config.spreadsheetId);
          if (config.sheetName && sheetSelect) {
            sheetSelect.value = config.sheetName;
          }
        }
      }

      // シンプルなchangeイベントを設定
      setupSimpleChangeEvents();

    } catch (error) {
      console.error('ドロップダウン初期化エラー:', error);
      spreadsheetSelect.innerHTML = '<option value="">初期化エラー</option>';
    }
  }

  // 🎯 シンプルなchangeイベント設定
  function setupSimpleChangeEvents() {
    // スプレッドシート選択時 → シート読み込み
    document.getElementById('spreadsheet-select').addEventListener('change', function() {
      const spreadsheetId = this.value;
      if (spreadsheetId) {
        loadSheetList(spreadsheetId);
      } else {
        resetSheetSelect();
      }
    });
  }
  
  // シート選択をリセット
  function resetSheetSelect() {
    const sheetSelect = document.getElementById('sheet-select');
    if (sheetSelect) {
      sheetSelect.innerHTML = '<option value="">スプレッドシートを選択してください</option>';
    }
  }

  // スプレッドシート一覧読み込み（非同期版）
  function loadSpreadsheetListAsync() {
    return new Promise((resolve, reject) => {
      const select = document.getElementById('spreadsheet-select');
      if (!select) {
        reject(new Error('spreadsheet-select element not found'));
        return;
      }

      select.innerHTML = '<option value="">読み込み中...</option>';

      // オンデマンド読み込みは部分ローディング
      setPartialLoading(true, 'スプレッドシート一覧を読み込み中...');

      google.script.run
        .withSuccessHandler(function (result) {
          // レスポンス構造の確認（オブジェクトか配列か）
          const spreadsheets = Array.isArray(result) ? result : (result && result.spreadsheets ? result.spreadsheets : []);
          
          // 🎯 既存の選択値を保持
          const currentValue = select.value;
          const wasPrePopulated = select.querySelector('[selected]');
          
          select.innerHTML = '<option value="">スプレッドシートを選択...</option>';

          // デバッグログ追加
          console.log('📊 スプレッドシート一覧受信:', {
            resultType: Array.isArray(result) ? 'array' : typeof result,
            count: spreadsheets.length,
            cached: result.cached || false,
            executionTime: result.executionTime || 'N/A',
            ownerFiltered: true
          });

          if (spreadsheets && Array.isArray(spreadsheets) && spreadsheets.length > 0) {
            spreadsheets.forEach((sheet) => {
              const option = document.createElement('option');
              option.value = sheet.id;
              option.textContent = sheet.name;

              // 🔄 事前入力されていた値を再選択
              if (currentValue && currentValue === sheet.id) {
                option.selected = true;
              }

              // フォーム情報をdata属性として保存
              if (sheet.formUrl) {
                option.dataset.formUrl = sheet.formUrl;
                option.dataset.formTitle = sheet.formTitle || 'フォーム';
              }

              select.appendChild(option);
            });
            
            // 📋 事前入力された設定がリストにない場合は追加
            if (wasPrePopulated && !select.querySelector(`option[value="${currentValue}"]`)) {
              const prePopulatedText = wasPrePopulated.textContent;
              const preserveOption = document.createElement('option');
              preserveOption.value = currentValue;
              preserveOption.textContent = prePopulatedText;
              preserveOption.selected = true;
              select.appendChild(preserveOption);
            }
          } else if (spreadsheets && Array.isArray(spreadsheets) && spreadsheets.length === 0) {
            // オーナーのスプレッドシートが0件の場合
            const noDataOption = document.createElement('option');
            noDataOption.value = '';
            noDataOption.textContent = 'あなたが所有するスプレッドシートはありません';
            noDataOption.disabled = true;
            select.appendChild(noDataOption);
            console.log('📊 オーナーフィルタリング結果: 0件');
          } else {
            // データ構造が予期しない場合
            console.error('📊 予期しないレスポンス構造:', result);
            const errorOption = document.createElement('option');
            errorOption.value = '';
            errorOption.textContent = 'データ読み込みエラー';
            errorOption.disabled = true;
            select.appendChild(errorOption);
          }

          setPartialLoading(false);
          resolve(spreadsheets);
        })
        .withFailureHandler(function (error) {
          select.innerHTML = '<option value="">読み込みエラー</option>';
          setPartialLoading(false);

          const detailedMessage = 'スプレッドシートの読み込みに失敗しました: ' + error.message;

          reject(new Error(detailedMessage));
        })
        .getSpreadsheetList();
    });
  }

  // 旧版との互換性維持
  function loadSpreadsheetList() {
    loadSpreadsheetListAsync();
  }

  // ユーザー情報読み込み（非同期版）
  function loadUserInfoAsync() {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(function (email) {
          if (email && email.trim()) {
            document.getElementById('current-user-email').textContent = email;

            // ユーザーIDを表示（__USER_ID__があれば使用）
            if (typeof __USER_ID__ !== 'undefined' && __USER_ID__) {
              document.getElementById('current-user-id').textContent = __USER_ID__;
            } else {
              document.getElementById('current-user-id').textContent = 'N/A';
            }

            resolve({ email, userId: __USER_ID__ || null });
          } else {
            document.getElementById('current-user-email').textContent = '取得中...';
            reject(new Error('ユーザー情報の取得に失敗しました'));
          }
        })
        .withFailureHandler(function (error) {
          document.getElementById('current-user-email').textContent = 'エラー';
          reject(new Error('メールアドレス取得に失敗しました: ' + error.message));
        })
        .getUser('email');
    });
  }

  // 旧版との互換性維持（再試行機能付き）
  function loadUserInfo() {
    loadUserInfoAsync().catch((error) => {
      setTimeout(() => {
        loadUserInfoAsync().catch((retryError) => {
          showError('ユーザー情報の取得に失敗しました: ' + retryError.message);
        });
      }, 2000);
    });
  }

  // 設定データの読み込みと完全自動反映（新実装）
  async function loadAndApplyCurrentConfig() {
    try {
      // 設定データを非同期で取得
      const config = await getCurrentConfigAsync();

      // リソースボタンを更新
      updateResourceButtons(config);

      // 設定サマリーを更新
      updateConfigSummary(config);

      if (config && config.sheetName) {
        // 2. シート自動選択
        await autoSelectSheet(config.sheetName);

        // 3. 列設定の自動初期化
        await autoInitializeColumnSettings(config);

        // 4. 進捗ステップの更新
        updateProgressFromConfig(config);

        showSuccess('✅ 既存の設定を完全に反映しました');
      } else {
        showInfo('💡 新規セットアップを開始してください');
      }
    } catch (error) {
      showError('設定の自動反映に失敗しました: ' + error.message);
      // エラー時でもリソースボタンを初期状態で表示
      updateResourceButtons(null);
    }
  }

  // 設定データ取得（Promise版）
  function getCurrentConfigAsync() {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getCurrentConfig();
    });
  }

  // 旧版との互換性維持
  function loadCurrentConfig() {
    loadAndApplyCurrentConfig().catch((error) => {});
  }

  // ========== 自動反映機能群 ==========

  // スプレッドシート自動選択
  async function autoSelectSpreadsheet(spreadsheetId) {
    try {
      const select = document.getElementById('spreadsheet-select');
      if (!select) {
        throw new Error('スプレッドシート選択要素が見つかりません');
      }

      // オプションから該当するIDを探す
      const option = Array.from(select.options).find((opt) => opt.value === spreadsheetId);
      if (option) {
        select.value = spreadsheetId;

        // シート一覧も自動読み込み
        await loadSheetListAsync(spreadsheetId);
        return true;
      } else {
        // 直接URLで接続を試行
        showInfo('💡 設定済みスプレッドシートに直接接続を試行します');
        return false;
      }
    } catch (error) {
      throw error;
    }
  }

  // シート自動選択
  async function autoSelectSheet(sheetName) {
    try {
      const select = document.getElementById('sheet-select');
      if (!select) {
        throw new Error('シート選択要素が見つかりません');
      }

      // オプションから該当する名前を探す
      const option = Array.from(select.options).find((opt) => opt.textContent === sheetName);
      if (option) {
        select.value = option.value;
        return true;
      } else {
        showInfo('💡 シート「' + sheetName + '」が見つかりません。手動で選択してください');
        return false;
      }
    } catch (error) {
      throw error;
    }
  }

  // 列設定の自動初期化（フォールバック処理強化版）
  async function autoInitializeColumnSettings(config) {
    try {
      // スプレッドシートIDを取得: configから、または現在選択中のものから
      const spreadsheetSelect = document.getElementById('spreadsheet-select');
      const spreadsheetId = config.spreadsheetId || spreadsheetSelect?.value;
      let sheetName = config.sheetName;

      if (!spreadsheetId) {
        return;
      }

      // シート名が不足している場合の自動検出・選択
      if (!sheetName) {
        try {
          const sheets = await loadSheetListAsync(spreadsheetId);
          if (sheets && sheets.length > 0) {
            // 優先順位でシートを選択
            sheetName = detectBestSheetName(sheets);

            // UI更新: 自動選択されたシートを反映
            await autoSelectSheet(sheetName);
          } else {
            throw new Error('利用可能なシートが見つかりません');
          }
        } catch (sheetError) {
          sheetName = 'フォームの回答 1'; // フォールバック
          showInfo('💡 シート情報の自動検出に失敗しました。手動でシートを選択してください。');
          return;
        }
      }

      // 既存の列設定データがあるかチェック
      if (config.columnMapping || config.columnSelections) {
        // 既存データから列設定を復元
        await restoreColumnSettingsFromConfig(config, sheetName);
      } else {
        // 新規にAI分析実行
        await analyzeAndSetupColumns(spreadsheetId, sheetName);
      }
    } catch (error) {
      showError('列設定の初期化に失敗しました: ' + error.message);
    }
  }

  // 最適なシート名を検出（柔軟パターンマッチング対応）
  function detectBestSheetName(sheets) {
    // フォームレスポンス系のパターン（正規表現）
    const formResponsePatterns = [
      /^フォームの回答\s*\d*$/, // フォームの回答、フォームの回答 1, フォームの回答 7 など
      /^Form Responses?\s*\d*$/, // Form Response, Form Responses 1 など
      /^回答\s*\d*$/, // 回答、回答 1 など
      /^Responses?\s*\d*$/, // Response, Responses 1 など
    ];

    // 優先順位リスト（厳密マッチ）
    const priorities = ['フォームの回答 1', 'フォームの回答', 'Sheet1', 'シート1'];

    // 1. 優先名から厳密検索
    for (const priority of priorities) {
      const sheet = sheets.find((s) => s.name === priority);
      if (sheet && sheet.rowCount > 1) {
        return priority;
      }
    }

    // 2. フォームレスポンスパターンマッチング
    for (const pattern of formResponsePatterns) {
      const matchingSheets = sheets
        .filter((s) => pattern.test(s.name) && s.rowCount > 1)
        .sort((a, b) => b.rowCount - a.rowCount); // データが多い順

      if (matchingSheets.length > 0) {
        const selected = matchingSheets[0].name;
        return selected;
      }
    }

    // データが最も多いシートを選択
    const sheetsWithData = sheets
      .filter((s) => s.rowCount > 1)
      .sort((a, b) => b.rowCount - a.rowCount);

    if (sheetsWithData.length > 0) {
      const selected = sheetsWithData[0].name;
      return selected;
    }

    // フォールバック: 最初のシート
    const fallback = sheets[0].name;
    return fallback;
  }

  // 既存の列設定データから復元（引数更新版）
  async function restoreColumnSettingsFromConfig(config, sheetName) {
    try {
      // 有効なシート名を決定
      const targetSheetName = sheetName || config.sheetName;
      if (!targetSheetName) {
        throw new Error('復元に必要なシート名が不足しています');
      }

      // 既存の列マッピングがあれば使用、なければ簡易フォールバック
      if (config.columnMapping) {
        // 既存のマッピングから列設定を復元
        if (config.columnSelections) {
          applyPreviousColumnSelections(config.columnSelections);
        }
      }
    } catch (error) {
      throw error;
    }
  }

  // 新規AI分析と列設定
  async function analyzeAndSetupColumns(spreadsheetId, sheetName) {
    try {
      const result = await analyzeColumnsAsync(spreadsheetId, sheetName);

      if (result && result.success) {
        updateColumnMapping(result);
      } else {
        throw new Error(result.error || 'AI分析に失敗しました');
      }
    } catch (error) {
      throw error;
    }
  }

  // 以前の列選択を復元
  function applyPreviousColumnSelections(columnSelections) {
    Object.keys(columnSelections).forEach((columnType) => {
      if (columnType.startsWith('_')) return; // メタデータはスキップ

      const selection = columnSelections[columnType];
      const dropdown = document.getElementById(`${columnType}-column-select`);

      if (dropdown && selection && typeof selection.columnIndex === 'number') {
        dropdown.value = selection.columnIndex;

        // 選択タイプに応じたクラス設定
        if (selection.selectionType === 'manual') {
          dropdown.classList.add('has-manual-selection');
          showConfidenceBadge(columnType, 100, 'manual');
        } else {
          dropdown.classList.add('has-ai-selection');
          showConfidenceBadge(columnType, selection.confidence || 0, 'ai');
        }
      }
    });
  }

  // 進捗ステップを設定から更新
  function updateProgressFromConfig(config) {
    try {
      let currentStep = 1;

      if (config.sheetName) {
        currentStep = 2; // データソース接続完了
      }

      if (config.columnMapping || config.columnSelections) {
        currentStep = 2; // 列設定完了
      }

      if (config.setupComplete) {
        currentStep = 3; // セットアップ完了
      }

      updateProgress(currentStep);
    } catch (error) {}
  }

  // 非同期版の補助関数群
  function loadSheetListAsync(spreadsheetId) {
    return new Promise((resolve, reject) => {
      const select = document.getElementById('sheet-select');
      select.innerHTML = '<option value="">読み込み中...</option>';

      google.script.run
        .withSuccessHandler(function (sheets) {
          select.innerHTML = '<option value="">シートを選択...</option>';
          sheets.forEach((sheet) => {
            const option = document.createElement('option');
            option.value = sheet.name;

            // フォーム連携シートかどうかで表示を変える
            if (sheet.isFormResponseSheet && sheet.formConnected) {
              option.textContent = `📋 ${sheet.name} (フォーム回答)`;
              option.dataset.isFormSheet = 'true';
              option.dataset.formTitle = sheet.formTitle || '';
            } else {
              option.textContent = sheet.name;
              option.dataset.isFormSheet = 'false';
            }

            select.appendChild(option);
          });
          resolve(sheets);
        })
        .withFailureHandler(function (error) {
          select.innerHTML = '<option value="">読み込みエラー</option>';
          reject(new Error('シートの読み込みに失敗しました: ' + error.message));
        })
        .getSheetList(spreadsheetId);
    });
  }

  function analyzeColumnsAsync(spreadsheetId, sheetName) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .analyzeColumns(spreadsheetId, sheetName);
    });
  }

  // ========== リソースボタン関連関数 ==========

  // スプレッドシートを新タブで開く
  function openSpreadsheet() {
    const btn = document.getElementById('open-spreadsheet-btn');
    const spreadsheetId = btn.dataset.spreadsheetId;

    if (!spreadsheetId) {
      showError('スプレッドシートが設定されていません');
      return;
    }

    const spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/' + spreadsheetId + '/edit';
    window.open(spreadsheetUrl, '_blank');
    showSuccess('📊 スプレッドシートを開きました');
  }

  // フォームを新タブで開く
  function openForm() {
    const btn = document.getElementById('open-form-btn');
    const formUrl = btn.dataset.formUrl;

    if (!formUrl) {
      showError('フォームURLが設定されていません');
      return;
    }

    window.open(formUrl, '_blank');
    showSuccess('📝 フォームを開きました');
  }

  // リソースボタンの表示状態を更新
  function updateResourceButtons(config) {
    const spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
    const formBtn = document.getElementById('open-form-btn');
    const statusDiv = document.getElementById('resource-status');

    // 設定が無い場合の初期状態
    if (!config) {
      spreadsheetBtn.disabled = true;
      spreadsheetBtn.dataset.spreadsheetId = '';
      formBtn.classList.add('hidden');
      boardBtn.classList.add('hidden');
      statusDiv.textContent = '設定が見つかりません';
      return;
    }

    // スプレッドシート情報はConfigurationManagerで管理されるため、API経由で取得
    spreadsheetBtn.disabled = true;
    statusDiv.textContent = 'スプレッドシート機能はConfigurationManager統合中';

    // フォームボタン（フォーム作成済みの場合のみ表示）
    if (config.formCreated && config.formUrl) {
      formBtn.classList.remove('hidden');
      formBtn.disabled = false;
      formBtn.dataset.formUrl = config.formUrl;
    } else {
      formBtn.classList.add('hidden');
    }

    // ステータス更新
    let statusParts = [];
    // スプレッドシートステータスはConfigurationManager経由で取得
    if (config.formCreated) statusParts.push('📝 フォーム');
    if (config.appPublished) statusParts.push('🎯 ボード');

    if (statusParts.length > 0) {
      statusDiv.textContent = '✅ 利用可能: ' + statusParts.join(', ');
      statusDiv.className = 'text-xs text-green-400 mt-2 text-center';
    } else {
      statusDiv.textContent = '💡 リソースの設定を開始してください';
      statusDiv.className = 'text-xs text-yellow-400 mt-2 text-center';
    }

    // 設定サマリーも更新
    updateConfigSummary(config);
  }

  // ローディング状態設定 - UnifiedLoadingSystemを使用
  function setLoading(loading, message = '処理中...') {
    systemState.loading = loading;

    // UnifiedLoadingSystemを使用
    if (window.unifiedLoading) {
      if (loading) {
        window.unifiedLoading.showSimple(message);
      } else {
        window.unifiedLoading.hide();
      }
    } else {
    }
  }


  // フォーム情報表示
  function showFormInfo(formData) {
    const formInfo = document.getElementById('form-info');
    const formTitle = document.getElementById('form-title');
    const formUrl = document.getElementById('form-url');

    // 詳細デバッグ情報
    console.log('🔍 showFormInfo: 受信データ詳細', {
      formData: formData,
      hasFormTitle: formData.hasOwnProperty('formTitle'),
      formTitleValue: formData.formTitle,
      formTitleType: typeof formData.formTitle,
      formTitleLength: formData.formTitle ? formData.formTitle.length : 0,
      isEmpty: !formData.formTitle || formData.formTitle.trim() === '',
    });

    if (formInfo && formTitle && formUrl) {
      // フォームタイトル設定の詳細ログ
      const titleToSet = formData.formTitle || '（タイトルなし）';
      console.log('📝 フォームタイトル設定:', {
        originalTitle: formData.formTitle,
        settingTitle: titleToSet,
        element: formTitle,
      });

      formTitle.textContent = titleToSet;
      formUrl.href = formData.formUrl;
      formUrl.textContent = formData.formUrl;

      formInfo.classList.remove('hidden');
      console.log('✅ フォーム情報表示完了:', {
        title: formTitle.textContent,
        url: formData.formUrl,
      });
    } else {
      console.error('❌ DOM要素が見つかりません:', {
        formInfo: !!formInfo,
        formTitle: !!formTitle,
        formUrl: !!formUrl,
      });
    }
  }

  // フォーム情報非表示
  function hideFormInfo() {
    const formInfo = document.getElementById('form-info');
    if (formInfo) {
      formInfo.classList.add('hidden');
    }
  }

  // シート別フォーム連携情報をチェック・表示
  function checkSheetFormConnection(spreadsheetId, sheetName) {
    if (!spreadsheetId || !sheetName) {
      hideFormInfo();
      return;
    }

    setPartialLoading(true, 'シート連携情報を確認中...');

    google.script.run
      .withSuccessHandler((result) => {
        setPartialLoading(false);
        console.log('🔍 getFormInfo APIレスポンス詳細:', {
          result: result,
          hasResult: !!result,
          isSuccess: result && result.success,
          hasFormData: result && result.formData,
          formData: result ? result.formData : null,
          spreadsheetId: spreadsheetId,
          sheetName: sheetName,
        });

        if (result && result.success && result.formData) {
          showFormInfo(result.formData);
        } else {
          console.warn('⚠️ フォーム連携情報が見つからない:', {
            reason: result ? result.reason : '不明',
            suggestions: result ? result.suggestions : [],
          });
          hideFormInfo();
        }
      })
      .withFailureHandler((error) => {
        setPartialLoading(false);
        console.error('❌ シート連携チェックエラー:', {
          error: error,
          errorMessage: error.message,
          spreadsheetId: spreadsheetId,
          sheetName: sheetName,
        });
        hideFormInfo();
      })
      .getFormInfo(spreadsheetId, sheetName);
  }


  // 設定エクスポート
  function exportConfig() {
    google.script.run
      .withSuccessHandler(function (config) {
        const dataStr = JSON.stringify(config, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        const exportFileDefaultName = 'studyquest-config.json';

        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();

        showSuccess('設定をエクスポートしました');
      })
      .withFailureHandler(function (error) {
        console.error('エクスポートエラー:', error);
        showError('設定のエクスポートに失敗しました');
      })
      .getCurrentConfig();
  }

  // システム管理者アクセス確認
  function checkSystemAdminAccess() {
    google.script.run
      .withSuccessHandler(function (isAdmin) {
        if (isAdmin) {
          console.log('システム管理者として認識されました');
          document.getElementById('app-setup-btn').style.display = 'block';
        } else {
          console.log('一般ユーザーとして認識されました');
          document.getElementById('app-setup-btn').style.display = 'none';
        }
      })
      .withFailureHandler(function (error) {
        console.warn('システム管理者確認エラー:', error);
        document.getElementById('app-setup-btn').style.display = 'none';
      })
      .checkIsSystemAdmin();
  }

  // フォーム作成インターフェース
  function createFormInterface() {
    // ユーザーIDの確認
    if (!__USER_ID__ || __USER_ID__.trim() === '') {
      showError('ユーザー情報が取得できませんでした。ページを再読み込みしてください。');
      return;
    }

    const formName = prompt(
      '作成するフォーム名を入力してください：\n例：アンケートフォーム、質問フォーム'
    );

    if (!formName || !formName.trim()) {
      showError('フォーム名が入力されませんでした');
      return;
    }

    if (formName.trim().length > 50) {
      showError('フォーム名は50文字以内で入力してください');
      return;
    }

    // 基本的なフォーム設定
    const config = {
      title: formName.trim(),
      description: 'カスタムフォームが作成されました',
      fields: [
        {
          type: 'text',
          label: '名前',
          required: true,
        },
        {
          type: 'text',
          label: 'メッセージ',
          required: true,
        },
      ],
    };

    console.log('フォーム作成開始:', { userId: __USER_ID__, config });
    setPartialLoading(true, 'フォーム作成中...');

    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          showSuccess('フォーム「' + formName + '」を作成しました');
          if (result.formUrl) {
            const openForm = confirm('フォームが作成されました。今すぐ開きますか？');
            if (openForm) {
              window.open(result.formUrl, '_blank');
            }
          }
        } else {
          showError(result.error || 'フォーム作成に失敗しました');
        }
        setPartialLoading(false);
      })
      .withFailureHandler(function (error) {
        console.error('フォーム作成エラー:', error);
        showError('フォーム作成に失敗しました: ' + (error.message || 'Unknown error'));
        setPartialLoading(false);
      })
      .createForm(__USER_ID__, config);
  }

  // アプリ設定画面へのナビゲーション
  function goToAppSetup() {
    setPartialLoading(true, '画面遷移中...');
    google.script.run
      .withSuccessHandler(function (webAppUrl) {
        const setupUrl = webAppUrl + '?mode=appSetup';
        window.open(setupUrl, '_top');
      })
      .withFailureHandler(function (error) {
        console.error('アプリ設定画面への遷移エラー:', error);
        showError('アプリ設定画面への移動に失敗しました');
        setPartialLoading(false);
      })
      .getWebAppUrl();
  }

  // データソース選択方式の切り替え
  function toggleSourceMethod(method) {
    const dropdownMethod = document.getElementById('dropdown-method');
    const urlMethod = document.getElementById('url-method');

    if (method === 'url') {
      dropdownMethod.classList.add('hidden');
      urlMethod.classList.remove('hidden');
    } else {
      dropdownMethod.classList.remove('hidden');
      urlMethod.classList.add('hidden');
    }
  }

  // スプレッドシートURL検証
  function validateSpreadsheetUrl() {
    const urlInput = document.getElementById('spreadsheet-url');
    const url = urlInput.value.trim();

    if (!url) {
      showError('スプレッドシートURLを入力してください');
      return;
    }

    // GoogleスプレッドシートURLの基本的な検証
    const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
    const match = url.match(spreadsheetRegex);

    if (!match) {
      showError('有効なGoogleスプレッドシートのURLを入力してください');
      return;
    }

    const spreadsheetId = match[1];
    setPartialLoading(true, 'URL検証中...');

    // バックエンドでアクセス権限を確認
    google.script.run
      .withSuccessHandler(function (result) {
        setPartialLoading(false);
        if (result.success) {
          showSuccess('✅ スプレッドシートへのアクセスが確認できました');
          // スプレッドシートIDを隠しフィールドに保存
          urlInput.dataset.spreadsheetId = spreadsheetId;
          // シート一覧を取得してプルダウンを更新
          if (result.sheets && result.sheets.length > 0) {
            updateSheetNameSuggestions(result.sheets);
          }
        } else {
          showError('スプレッドシートにアクセスできません: ' + (result.error || 'Unknown error'));
        }
      })
      .withFailureHandler(function (error) {
        setPartialLoading(false);
        console.error('URL検証エラー:', error);
        showError('URL検証に失敗しました: ' + error.message);
      })
      .validateAccess(spreadsheetId);
  }

  // シート名候補を更新
  function updateSheetNameSuggestions(sheets) {
    const sheetNameInput = document.getElementById('sheet-name-input');
    if (sheets && sheets.length > 0) {
      // デフォルトで最初のシートを設定
      sheetNameInput.value = sheets[0].name;

      // datalistで候補を表示（より良いUX）
      let datalist = document.getElementById('sheet-suggestions');
      if (!datalist) {
        datalist = document.createElement('datalist');
        datalist.id = 'sheet-suggestions';
        sheetNameInput.setAttribute('list', 'sheet-suggestions');
        sheetNameInput.parentNode.appendChild(datalist);
      }

      datalist.innerHTML = '';
      sheets.forEach((sheet) => {
        const option = document.createElement('option');
        option.value = sheet.name;
        datalist.appendChild(option);
      });
    }
  }

  // URL入力方式でのデータソース接続
  function connectToUrlSource() {
    const urlInput = document.getElementById('spreadsheet-url');
    const sheetNameInput = document.getElementById('sheet-name-input');

    const url = urlInput.value.trim();
    const sheetName = sheetNameInput.value.trim();

    if (!url) {
      showError('スプレッドシートURLを入力してください');
      return;
    }

    if (!sheetName) {
      showError('シート名を入力してください');
      return;
    }

    // URLからスプレッドシートIDを抽出
    const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
    const match = url.match(spreadsheetRegex);

    if (!match) {
      showError('有効なGoogleスプレッドシートのURLを入力してください');
      return;
    }

    const spreadsheetId = match[1];

    console.log('URL入力方式で接続開始:', { spreadsheetId, sheetName });
    setPartialLoading(true, 'URL接続中...');

    // 既存のconnectToSource関数と同様の処理を実行
    google.script.run
      .withSuccessHandler(function (result) {
        console.log('URL入力接続成功:', result);
        if (result && result.success) {
          // 新しいドロップダウン式列マッピングを更新
          updateColumnMapping(result);
          updateProgress(2);
          showSuccess('URL入力方式でスプレッドシートに接続しました');
        } else {
          showError(result.error || 'スプレッドシートへの接続に失敗しました');
        }
        setPartialLoading(false);
      })
      .withFailureHandler(function (error) {
        console.error('URL入力接続エラー:', error);
        showError('スプレッドシートへの接続に失敗しました: ' + error.message);
        setPartialLoading(false);
      })
      .analyzeColumns(spreadsheetId, sheetName);
  }

  // イベントリスナー設定
  document.addEventListener('DOMContentLoaded', function () {
    // データソース選択方式の切り替え
    document.querySelectorAll('input[name="source-method"]').forEach((radio) => {
      radio.addEventListener('change', function () {
        toggleSourceMethod(this.value);
      });
    });


    // シート選択時（フォーム情報表示）
    document.getElementById('sheet-select').addEventListener('change', function () {
      const spreadsheetId = document.getElementById('spreadsheet-select').value;
      const sheetName = this.value;

      if (spreadsheetId && sheetName) {
        // シート別フォーム連携情報を取得・表示
        checkSheetFormConnection(spreadsheetId, sheetName);
      } else {
        hideFormInfo();
      }
    });

    // データ更新ボタン
    document.getElementById('refresh-data').addEventListener('click', function () {
      loadSpreadsheetList();
    });

    // 接続ボタン（一覧選択）
    document.getElementById('connect-source').addEventListener('click', function () {
      connectToSource();
    });

    // URL検証ボタン
    document.getElementById('url-validate').addEventListener('click', function () {
      validateSpreadsheetUrl();
    });

    // 接続ボタン（URL入力）
    document.getElementById('connect-url-source').addEventListener('click', function () {
      connectToUrlSource();
    });

    // 設定確認ボタン
    document.getElementById('verify-mapping').addEventListener('click', function () {
      verifyColumnMapping();
    });

    // 下書き保存ボタン
    document.getElementById('save-draft').addEventListener('click', function () {
      saveDraft();
    });

    // 公開ボタン
    document.getElementById('publish-now').addEventListener('click', function () {
      publishApp();
    });
  });

  // シート一覧読み込み
  function loadSheetList(spreadsheetId) {
    
    const select = document.getElementById('sheet-select');
    if (!select) {
      console.error('❌ loadSheetList: sheet-select要素が見つかりません');
      showError('シート選択要素が見つかりません');
      return;
    }
    
    select.innerHTML = '<option value="">読み込み中...</option>';

    // シート読み込みは部分ローディング
    setPartialLoading(true, 'シート一覧を読み込み中...');

    google.script.run
      .withSuccessHandler(function (sheets) {
        select.innerHTML = '<option value="">シートを選択...</option>';
        
        if (!sheets || sheets.length === 0) {
          const noSheetOption = document.createElement('option');
          noSheetOption.value = '';
          noSheetOption.textContent = '利用可能なシートがありません';
          noSheetOption.disabled = true;
          select.appendChild(noSheetOption);
        } else {
          sheets.forEach((sheet) => {
            const option = document.createElement('option');
            option.value = sheet.name;
            option.textContent = sheet.name;
            select.appendChild(option);
          });
        }
        
        // partial-loading-targetクラスを削除
        select.classList.remove('partial-loading-target');
        
        setPartialLoading(false);
        showSuccess(`✅ ${sheets?.length || 0}個のシートを読み込みました`);
      })
      .withFailureHandler(function (error) {
        console.error('❌ loadSheetList: シート読み込みエラー', {
          error: error.message || error,
          spreadsheetId: `${spreadsheetId?.substring(0, 10)}...`,
          timestamp: new Date().toISOString()
        });
        
        select.innerHTML = '<option value="">読み込みエラー - 再試行してください</option>';
        select.classList.remove('partial-loading-target');
        
        setPartialLoading(false);
        showError(`シート一覧の読み込みに失敗しました: ${error.message || error}`);
      })
      .getSheetList(spreadsheetId);
  }

  // データソース接続
  function connectToSource() {
    const spreadsheetId = document.getElementById('spreadsheet-select').value;
    const sheetName = document.getElementById('sheet-select').value;

    // 入力検証を詳細化
    if (!spreadsheetId) {
      showError(
        'スプレッドシートを選択してください。先に「更新」ボタンを押して一覧を読み込んでください。'
      );
      return;
    }

    if (!sheetName) {
      showError(
        'シートを選択してください。スプレッドシートを選択すると、シート一覧が表示されます。'
      );
      return;
    }

    setLoading(true);
    console.log('connectToSource: 接続開始', { spreadsheetId, sheetName });

    google.script.run
      .withSuccessHandler(function (result) {
        console.log('connectToSource: 接続結果', result);

        if (result.success) {
          showSuccess('データソースに接続しました');
          // 進捗更新
          updateProgress(2);

          // 新しいドロップダウン式列マッピングを更新
          updateColumnMapping(result);

          // 🚀 UX向上：AI判定の自動適用
          autoApplyAIDetection(result);

          // 🎯 UX向上：次ステップの案内
          showNextStepGuidance(result);
        } else {
          handleConnectionError(result.error, { spreadsheetId, sheetName });
        }
        setLoading(false);
      })
      .withFailureHandler(function (error) {
        console.error('connectToSource 接続エラー:', error);
        handleConnectionError(error.message || error, { spreadsheetId, sheetName });
        setLoading(false);
      })
      .connectDataSource(spreadsheetId, sheetName);
  }

  // 接続エラーハンドリング
  function handleConnectionError(errorMessage, context) {
    console.error('Connection error details:', { errorMessage, context });

    let userMessage = 'データソースへの接続に失敗しました。';
    let suggestions = [];

    // エラーメッセージに基づく詳細な診断
    if (errorMessage.includes('Permission') || errorMessage.includes('権限')) {
      suggestions.push('スプレッドシートへのアクセス権限を確認してください');
      suggestions.push('スプレッドシートを開いて、編集権限があることを確認してください');
    } else if (errorMessage.includes('not found') || errorMessage.includes('見つかりません')) {
      suggestions.push('指定されたスプレッドシートまたはシートが存在するか確認してください');
      suggestions.push('シート名が正確か確認してください');
    } else if (errorMessage.includes('timeout') || errorMessage.includes('タイムアウト')) {
      suggestions.push('ネットワーク接続を確認してください');
      suggestions.push('しばらく時間をおいて再試行してください');
    } else {
      suggestions.push('スプレッドシートが開けることを確認してください');
      suggestions.push('手動で列を設定することも可能です');
    }

    const fullMessage =
      userMessage + '\n\n推奨対処法:\n' + suggestions.map((s) => '• ' + s).join('\n');
    showError(fullMessage);

    // ドロップダウン式では手動設定は自動的に利用可能
    showInfo('💡 ドロップダウンを使用して手動で列を設定できます。');
  }

  // 手動設定オプションの表示（ドロップダウン式では不要 - 削除済み）
  // 手動列設定ダイアログ（ドロップダウン式では不要 - 削除済み）

  // 進捗更新
  function updateProgress(step) {
    const steps = document.querySelectorAll('.step');
    steps.forEach((stepEl, index) => {
      stepEl.classList.remove('completed', 'current');
      if (index < step - 1) {
        stepEl.classList.add('completed');
      } else if (index === step - 1) {
        stepEl.classList.add('current');
      }
    });
  }

  // 列マッピング更新（ドロップダウン式）- シンプル版
  function updateColumnMapping(result) {
    console.log('Column mapping received:', result);

    if (!result || !result.success) {
      console.warn('列マッピング結果が不正です');
      showError('列マッピング情報の取得に失敗しました');
      return;
    }

    const mapping = result.columnMapping;
    const headers = result.headers || [];
    
    // confidenceをmappingに追加（バックエンド統一形式対応）
    if (result.confidence) {
      mapping.confidence = result.confidence;
    }
    
    console.log('Headers:', headers, 'Mapping:', mapping);

    // ドロップダウンにヘッダーオプションを設定
    populateColumnDropdowns(headers, mapping);

    // AI検出情報を表示
    displayAIDetectionInfo(mapping);

    showSuccess('✅ 列設定を更新しました');
  }

  // ドロップダウンにヘッダーオプションを設定 - エラーハンドリング強化版
  function populateColumnDropdowns(headers, mapping) {
    console.log('populateColumnDropdowns:', { headers, mapping });

    try {
      // 入力データの検証
      if (!Array.isArray(headers) || headers.length === 0) {
        throw new Error('ヘッダー情報が不正です');
      }

      // 4つのドロップダウンを取得
      const dropdowns = {
        answer: document.getElementById('answer-column-select'),
        reason: document.getElementById('reason-column-select'),
        class: document.getElementById('class-column-select'),
        name: document.getElementById('name-column-select'),
      };

      // ドロップダウンの存在確認
      const missingDropdowns = Object.keys(dropdowns).filter(key => !dropdowns[key]);
      if (missingDropdowns.length > 0) {
        console.warn('一部のドロップダウンが見つかりません:', missingDropdowns);
      }

      // 各ドロップダウンをクリアしてヘッダーオプションを追加
      Object.keys(dropdowns).forEach((columnType) => {
        const dropdown = dropdowns[columnType];
        if (!dropdown) {
          console.warn(`${columnType}ドロップダウンが見つかりません`);
          return;
        }

        try {
          // 既存のオプションをクリア
          dropdown.innerHTML = '<option value="">選択してください...</option>';

          // ヘッダーをオプションとして追加
          headers.forEach((header, index) => {
            if (header && header.trim()) {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = `${String.fromCharCode(65 + index)}列: ${header}`;
              dropdown.appendChild(option);
            }
          });
        } catch (error) {
          console.error(`${columnType}ドロップダウンの設定エラー:`, error);
        }
      });

      // AI検出結果をドロップダウンの初期選択として設定
      setAIDetectionSelections(mapping, dropdowns);

      // ドロップダウン変更イベントリスナーを設定
      setupDropdownEventListeners(dropdowns);

    } catch (error) {
      console.error('populateColumnDropdowns エラー:', error);
      showError('ドロップダウンの設定に失敗しました: ' + error.message);
    }
  }


  // AI検出結果をドロップダウンの初期選択として設定
  function setAIDetectionSelections(mapping, dropdowns) {
    console.log('setAIDetectionSelections:', mapping);

    // グローバル変数として現在のAI検出結果を保存
    window.currentAIMapping = mapping;

    // マッピングの対応関係（バックエンドのconvertIndicesToMappingと統一）
    const mappingKeys = {
      answer: ['answer'], // バックエンドのCOLUMN_HEADERS.OPINION → answer
      reason: ['reason'], // バックエンドのCOLUMN_HEADERS.REASON → reason
      class: ['class'], // バックエンドのCOLUMN_HEADERS.CLASS → class
      name: ['name'], // バックエンドのCOLUMN_HEADERS.NAME → name
    };

    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;

      // 対応するマッピングキーを探す
      let selectedIndex = null;
      let confidence = 0;

      mappingKeys[columnType].forEach((key) => {
        if (mapping[key] !== null && mapping[key] !== undefined) {
          selectedIndex = mapping[key];
          confidence = mapping.confidence && mapping.confidence[key] ? mapping.confidence[key] : 0;
        }
      });

      if (selectedIndex !== null) {
        // ドロップダウンの選択を設定
        dropdown.value = selectedIndex;
        dropdown.classList.add('has-ai-selection');

        // 信頼度バッジを表示
        showConfidenceBadge(columnType, confidence, 'ai');

        console.log(`AI検出: ${columnType} → ${selectedIndex}列 (信頼度: ${confidence}%)`);
      }
    });

    // AI検出情報パネルを表示
    const aiInfo = document.getElementById('ai-detection-info');
    if (aiInfo) {
      aiInfo.classList.remove('hidden');
    }
  }

  // 🚀 UX向上：AI判定の自動適用機能（データ構造修正版）
  function autoApplyAIDetection(result) {
    if (!result?.success || !result?.columnMapping?.mapping) {
      console.log('🔍 autoApplyAIDetection: データ不足のためスキップ');
      return;
    }

    // 正しいデータ構造へのアクセス
    const mapping = result.columnMapping.mapping;      // ✅ 正しいパス
    const confidence = result.columnMapping.confidence; // ✅ 正しいパス
    
    console.log('🔍 autoApplyAIDetection: データ構造確認', {
      columnMapping: result.columnMapping,
      mapping: mapping,
      confidence: confidence
    });

    let autoAppliedCount = 0;
    let highConfidenceCount = 0;

    // 高信頼度(80%以上)の検出結果を自動適用（UI列のみ）
    Object.keys(mapping).forEach(columnType => {
      // リアクション列はスキップ（UIドロップダウンが存在しない）
      if (['highlight', 'curious', 'like', 'understand'].includes(columnType)) {
        return;
      }
      
      const columnIndex = mapping[columnType];
      const confidenceValue = confidence?.[columnType] || 0;
      
      console.log(`🔍 ${columnType}: columnIndex=${columnIndex}, confidence=${confidenceValue}`);

      if (confidenceValue >= 80 && columnIndex !== undefined && columnIndex !== null) {
        highConfidenceCount++;
        const dropdown = document.getElementById(`${columnType}-column-select`);
        
        if (dropdown) {
          dropdown.value = columnIndex;
          dropdown.classList.add('has-auto-applied');
          dropdown.classList.remove('has-manual-selection');
          
          // 信頼度バッジを更新（関数が存在する場合のみ）
          if (typeof showConfidenceBadge === 'function') {
            showConfidenceBadge(columnType, confidenceValue, 'auto-applied');
          }
          
          autoAppliedCount++;
          console.log(`🤖 AI自動適用成功: ${columnType} → ${columnIndex}列 (信頼度: ${confidenceValue}%)`);
        } else {
          console.warn(`❌ ドロップダウンが見つかりません: ${columnType}-column-select`);
        }
      }
    });

    // ユーザーフィードバック
    if (autoAppliedCount > 0) {
      showSuccess(`🤖 高精度AI判定を${autoAppliedCount}項目自動適用しました！`);
      updateProgress(3); // 列設定完了まで進める
    } else if (highConfidenceCount === 0) {
      showInfo('💡 AI判定の信頼度が低めです。ドロップダウンで手動設定してください。');
    } else {
      console.log('🔍 高信頼度の項目はあるが、ドロップダウン設定に失敗');
    }
  }

  // 🎯 UX向上：次ステップ案内機能  
  function showNextStepGuidance(result) {
    if (!result || !result.success) return;

    const mapping = result.columnMapping || {};
    const hasAutoApplied = Object.values(mapping).some(detection => {
      const confidence = typeof detection?.confidence === 'number' ? detection.confidence : 0;
      return confidence >= 80;
    });

    setTimeout(() => {
      if (hasAutoApplied) {
        showSuccess('✨ AI判定を自動適用済み。「設定を確認」で完了できます！');
      } else {
        showInfo('💡 ドロップダウンで列を手動設定してから「設定を確認」してください');
      }
    }, 1500); // 他のメッセージの後に表示
  }

  // ドロップダウンの変更イベントリスナーを設定
  function setupDropdownEventListeners(dropdowns) {
    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;

      dropdown.addEventListener('change', function () {
        handleDropdownChange(columnType, this);
      });
    });

    // AI検出に戻すボタンのイベントリスナー
    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.addEventListener('click', function () {
        resetToAIDetection();
      });
    }
  }

  // ドロップダウン変更の処理
  function handleDropdownChange(columnType, dropdown) {
    const selectedValue = dropdown.value;
    console.log(`ドロップダウン変更: ${columnType} → ${selectedValue}`);

    // 既存のCSSクラスを削除
    dropdown.classList.remove('has-ai-selection', 'has-manual-selection');

    if (selectedValue === '') {
      // 選択解除
      hideConfidenceBadge(columnType);
    } else {
      // 手動選択
      dropdown.classList.add('has-manual-selection');
      showConfidenceBadge(columnType, 100, 'manual');

      // AI検出に戻すボタンを表示
      const resetButton = document.getElementById('reset-to-ai');
      if (resetButton) {
        resetButton.style.display = 'inline-block';
      }

      // 手動設定情報を表示
      const manualInfo = document.getElementById('manual-override-info');
      if (manualInfo) {
        manualInfo.classList.remove('hidden');
      }
    }

    // 選択状況を更新
    updateSelectionStatus();
  }

  // 信頼度バッジを表示
  function showConfidenceBadge(columnType, confidence, type) {
    const confidenceDiv = document.getElementById(`${columnType}-confidence`);
    const badge = confidenceDiv.querySelector('.confidence-badge');

    if (!confidenceDiv || !badge) return;

    let badgeClass = '';
    let badgeText = '';

    if (type === 'manual') {
      badgeClass = 'manual';
      badgeText = '✋ 手動設定';
    } else {
      // AI検出の場合の信頼度による色分け
      if (confidence >= 80) {
        badgeClass = 'high';
        badgeText = `🤖 AI検出 ${Math.round(confidence)}%`;
      } else if (confidence >= 50) {
        badgeClass = 'medium';
        badgeText = `🤖 AI検出 ${Math.round(confidence)}%`;
      } else {
        badgeClass = 'low';
        badgeText = `🤖 AI検出 ${Math.round(confidence)}%`;
      }
    }

    badge.className = `confidence-badge ${badgeClass}`;
    badge.textContent = badgeText;
    confidenceDiv.classList.remove('hidden');
  }

  // 信頼度バッジを非表示
  function hideConfidenceBadge(columnType) {
    const confidenceDiv = document.getElementById(`${columnType}-confidence`);
    if (confidenceDiv) {
      confidenceDiv.classList.add('hidden');
    }
  }

  // AI検出情報を表示
  function displayAIDetectionInfo(mapping) {
    const detailsDiv = document.getElementById('ai-detection-details');
    if (!detailsDiv) return;

    const details = [];
    const columnNames = {
      answerer: '回答列',
      reason: '理由列',
      class: 'クラス列',
      name: '名前列',
    };

    Object.keys(columnNames).forEach((key) => {
      if (mapping[key] !== null && mapping[key] !== undefined) {
        const columnLabel = String.fromCharCode(65 + mapping[key]) + '列';
        const confidence =
          mapping.confidence && mapping.confidence[key] ? mapping.confidence[key] : 0;
        details.push(`${columnNames[key]}: ${columnLabel} (信頼度: ${Math.round(confidence)}%)`);
      }
    });

    detailsDiv.innerHTML = details.map((detail) => `<div>• ${detail}</div>`).join('');
  }

  // 選択状況を更新
  function updateSelectionStatus() {
    const hasManualSelection =
      document.querySelectorAll('.modern-select.has-manual-selection').length > 0;
    const hasAISelection = document.querySelectorAll('.modern-select.has-ai-selection').length > 0;

    console.log('選択状況:', { hasManualSelection, hasAISelection });

    // AI検出情報とリセットボタンの表示制御
    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.style.display = hasManualSelection ? 'inline-block' : 'none';
    }
  }

  // AI検出結果に戻す
  function resetToAIDetection() {
    console.log('AI検出結果にリセット');

    if (!window.currentAIMapping) {
      showError('AI検出データがありません');
      return;
    }

    // 全てのドロップダウンをリセット
    const dropdowns = {
      answer: document.getElementById('answer-column-select'),
      reason: document.getElementById('reason-column-select'),
      class: document.getElementById('class-column-select'),
      name: document.getElementById('name-column-select'),
    };

    // AI検出結果を再設定
    setAIDetectionSelections(window.currentAIMapping, dropdowns);

    // 手動設定情報を非表示
    const manualInfo = document.getElementById('manual-override-info');
    if (manualInfo) {
      manualInfo.classList.add('hidden');
    }

    // リセットボタンを非表示
    const resetButton = document.getElementById('reset-to-ai');
    if (resetButton) {
      resetButton.style.display = 'none';
    }

    showSuccess('✅ AI検出結果にリセットしました');
  }

  // 列マッピング確認
  function verifyColumnMapping() {
    const spreadsheetId = document.getElementById('spreadsheet-select').value;
    const sheetName = document.getElementById('sheet-select').value;

    if (!spreadsheetId || !sheetName) {
      showError('検証するにはまず、スプレッドシートとシートを接続してください');
      return;
    }

    setLoading(true);

    console.log('verifyColumnMapping: 列マッピング検証開始', { spreadsheetId, sheetName });

    // 既存のgetHeaderIndices関数を使用して検証
    google.script.run
      .withSuccessHandler(function (headerIndices) {
        console.log('verifyColumnMapping: ヘッダー検証成功', headerIndices);

        if (!headerIndices || Object.keys(headerIndices).length === 0) {
          showError('ヘッダー情報を取得できませんでした。シートの構造を確認してください');
          setLoading(false);
          return;
        }

        // 検証結果を表示
        displayVerificationResults(headerIndices);

        // 設定を保存
        saveColumnConfiguration(spreadsheetId, sheetName, headerIndices);

        showSuccess('列マッピングの検証が完了しました');
        updateProgress(3);
        setLoading(false);
      })
      .withFailureHandler(function (error) {
        console.error('verifyColumnMapping エラー:', error);
        showError('列マッピングの検証に失敗しました: ' + (error.message || 'Unknown error'));
        setLoading(false);
      })
      .getHeaderIndices(spreadsheetId, sheetName);
  }

  // 検証結果の表示
  function displayVerificationResults(headerIndices) {
    const columnsContainer = document.querySelector('.auto-detected-columns');
    if (!columnsContainer) return;

    // 既存の列表示に検証済みマークを追加
    const columnMatches = columnsContainer.querySelectorAll('.column-match');
    columnMatches.forEach((match) => {
      const verifiedBadge = document.createElement('span');
      verifiedBadge.className = 'status-badge published';
      verifiedBadge.textContent = '✓ 検証済み';
      verifiedBadge.style.fontSize = '0.75rem';
      verifiedBadge.style.marginLeft = '0.5rem';
      match.appendChild(verifiedBadge);
    });

    console.log('検証結果を表示しました:', headerIndices);
  }

  // 列設定の保存
  function saveColumnConfiguration(spreadsheetId, sheetName, headerIndices) {
    const config = {
      spreadsheetId: spreadsheetId,
      sheetName: sheetName,
      headerIndices: headerIndices,
      verifiedAt: new Date().toISOString(),
    };

    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          console.log('列設定を保存しました:', config);
        } else {
          console.warn('列設定の保存に失敗:', result.error);
        }
      })
      .withFailureHandler(function (error) {
        console.error('列設定保存エラー:', error);
      })
      .saveDraftConfiguration(config);
  }

  // 下書き保存
  function saveDraft() {
    const config = gatherConfiguration();

    setLoading(true);
    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          showSuccess('下書きを保存しました');
          updateResourceButtons(result.config);
        } else {
          showError(result.error);
        }
        setLoading(false);
      })
      .withFailureHandler(function (error) {
        console.error('保存エラー:', error);
        showError('下書きの保存に失敗しました');
        setLoading(false);
      })
      .saveDraftConfiguration(config);
  }

  // アプリ公開（appName削除版）
  function publishApp() {
    setLoading(true);

    // 🔧 根本的修正: 現在の完全な設定を取得してからpublishApplicationを呼び出し
    google.script.run
      .withSuccessHandler(function (currentConfig) {
        if (!currentConfig || !currentConfig.spreadsheetId) {
          showError('まずデータソースを設定してください。');
          setLoading(false);
          return;
        }

        // 🚀 最小限公開設定（送信データ最適化）
        const publishConfig = {
          // 🎯 必須データのみ：既存設定から最小限抽出
          spreadsheetId: currentConfig.spreadsheetId,
          sheetName: currentConfig.sheetName,
          columnMapping: currentConfig.columnMapping,
          
          // 🎯 必須データのみ：UI設定
          showNames: document.getElementById('show-names').checked,
          showReactions: document.getElementById('show-reactions').checked
        };

        console.log('📋 publishApp: 完全な設定でpublishApplication呼び出し', {
          hasFormUrl: !!publishConfig.formUrl,
          hasColumnMapping: !!publishConfig.columnMapping,
          hasSpreadsheetId: !!publishConfig.spreadsheetId,
          hasSheetName: !!publishConfig.sheetName,
        });

        // 完全な設定でpublishApplicationを呼び出し
        google.script.run
          .withSuccessHandler(function (result) {
            if (result.success) {
              showSuccess('アプリを公開しました！');
              updatePublishStatus('published');
              updateResourceButtons(result.config);
              
              // ✅ 公開成功後：即座にフッターを更新（UX向上）
              setTimeout(() => {
                loadBoardInfo(); // フッター情報を再読み込み
              }, 500);
            } else {
              showError(result.error);
            }
            setLoading(false);
          })
          .withFailureHandler(function (error) {
            console.error('公開エラー:', error);
            showError(
              'アプリの公開に失敗しました。データソースが正しく設定されているか確認してください。'
            );
            setLoading(false);
          })
          .publishApplication(publishConfig);
      })
      .withFailureHandler(function (error) {
        showError('現在の設定の取得に失敗しました: ' + error.message);
        setLoading(false);
      })
      .getCurrentConfig(); // 現在の完全な設定を先に取得
  }

  // 設定収集（ドロップダウン式対応）
  function gatherConfiguration() {
    const sourceMethod = document.querySelector('input[name="source-method"]:checked').value;

    let spreadsheetId, sheetName;

    if (sourceMethod === 'url') {
      // URL入力方式
      const urlInput = document.getElementById('spreadsheet-url');
      const url = urlInput.value.trim();
      const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
      const match = url.match(spreadsheetRegex);

      if (match) {
        spreadsheetId = match[1];
      }
      sheetName = document.getElementById('sheet-name-input').value.trim();
    } else {
      // 一覧選択方式
      spreadsheetId = document.getElementById('spreadsheet-select').value;
      sheetName = document.getElementById('sheet-select').value;
    }

    // 🎯 必須データのみ送信（送信データ大幅削減）
    return {
      spreadsheetId,
      sheetName,
      showNames: document.getElementById('show-names').checked,
      showReactions: document.getElementById('show-reactions').checked
    };
  }

  // ドロップダウンから列選択情報を収集
  function gatherColumnSelections() {
    const dropdowns = {
      answer: document.getElementById('answer-column-select'),
      reason: document.getElementById('reason-column-select'),
      class: document.getElementById('class-column-select'),
      name: document.getElementById('name-column-select'),
    };

    const selections = {};
    let hasAnySelection = false;

    Object.keys(dropdowns).forEach((columnType) => {
      const dropdown = dropdowns[columnType];
      if (!dropdown) return;

      const selectedValue = dropdown.value;
      const isAI = dropdown.classList.contains('has-ai-selection');
      const isManual = dropdown.classList.contains('has-manual-selection');

      if (selectedValue !== '') {
        selections[columnType] = {
          columnIndex: parseInt(selectedValue),
          columnLabel: String.fromCharCode(65 + parseInt(selectedValue)) + '列',
          selectionType: isManual ? 'manual' : 'ai',
          confidence: getColumnConfidence(columnType),
        };
        hasAnySelection = true;
      }
    });

    // AI検出の元データも含める
    if (window.currentAIMapping) {
      selections._aiMapping = window.currentAIMapping;
    }

    selections._hasSelections = hasAnySelection;

    console.log('gatherColumnSelections:', selections);
    return selections;
  }

  // 列の信頼度を取得
  function getColumnConfidence(columnType) {
    const confidenceDiv = document.getElementById(`${columnType}-confidence`);
    if (!confidenceDiv || confidenceDiv.classList.contains('hidden')) {
      return 0;
    }

    const badge = confidenceDiv.querySelector('.confidence-badge');
    if (!badge) return 0;

    const text = badge.textContent;
    const match = text.match(/(\d+)%/);
    return match ? parseInt(match[1]) : badge.classList.contains('manual') ? 100 : 0;
  }

  // 旧updateConfigDisplay関数は削除済み - updateResourceButtons()を使用

  // 公開ステータス更新
  function updatePublishStatus(status) {
    const badge =
      document.querySelector('.status-badge.unpublished') ||
      document.querySelector('.status-badge.published');
    if (badge) {
      badge.className = `status-badge ${status}`;
      badge.textContent = status === 'published' ? '公開中' : '未公開';
    }
  }

  // 設定サマリー更新
  function updateConfigSummary(config) {
    try {
      // セットアップステータス更新
      const setupStatus = config?.setupStatus || 'pending';
      const badge = document.querySelector('.config-summary .status-badge');
      if (badge) {
        const statusText = {
          completed: '公開準備完了',
          published: '公開中',
          pending: '設定中',
        };

        badge.className =
          'status-badge ' +
          (setupStatus === 'completed'
            ? 'published'
            : 'unpublished');
        badge.textContent = statusText[setupStatus] || '設定中';
      }

      // 最終更新時刻更新
      const lastUpdated = config?.lastModified || config?.updatedAt;
      const timeElement = document.querySelector(
        '.config-summary .config-item:last-child span:last-child'
      );
      if (timeElement && lastUpdated) {
        try {
          const date = new Date(lastUpdated);
          timeElement.textContent = date.toLocaleString('ja-JP', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
          });
          timeElement.className = 'text-sm text-gray-300';
        } catch (e) {
          timeElement.textContent = '--:--';
        }
      }

      // スプレッドシートリンク更新
      const openSheetBtn = document.getElementById('open-sheet');
      if (openSheetBtn && config?.spreadsheetId) {
        openSheetBtn.onclick = (e) => {
          e.preventDefault();
          const spreadsheetUrl =
            'https://docs.google.com/spreadsheets/d/' + config.spreadsheetId + '/edit';
          window.open(spreadsheetUrl, '_blank');
          showSuccess('📊 スプレッドシートを開きました');
        };
        openSheetBtn.style.opacity = '1';
        openSheetBtn.style.pointerEvents = 'auto';
      } else if (openSheetBtn) {
        openSheetBtn.onclick = (e) => {
          e.preventDefault();
          showError('スプレッドシートが設定されていません');
        };
        openSheetBtn.style.opacity = '0.5';
        openSheetBtn.style.pointerEvents = 'auto';
      }
    } catch (error) {
      console.error('updateConfigSummary エラー:', error);
    }
  }

  // =============================================================================
  // フッター：現在のボード情報表示機能
  // =============================================================================

  // グローバル変数
  let currentBoardInfo = null;

  // ボード情報ロード
  function loadBoardInfo() {
    google.script.run
      .withSuccessHandler(function (boardInfo) {
        currentBoardInfo = boardInfo;
        updateFooterDisplay(boardInfo);
      })
      .withFailureHandler(function (error) {
        console.error('ボード情報取得エラー:', error);
        updateFooterDisplay({
          isActive: false,
          questionText: '情報取得エラー',
          error: error.message,
        });
      })
      .getCurrentBoardInfoAndUrls();
  }

  // フッター表示更新
  function updateFooterDisplay(boardInfo) {
    const footer = document.getElementById('boardInfoFooter');
    const questionText = document.getElementById('currentQuestionText');
    const openBtn = document.getElementById('openBoardBtn');
    const copyBtn = document.getElementById('copyViewUrlBtn');
    const statusText = document.getElementById('boardStatus');

    // ✅ configJSON中心型：統一データソースからの公開状態チェック
    const isPublished = Boolean(
      boardInfo.appPublished === true ||
      boardInfo.appPublished === 'true' ||
      boardInfo.appPublished === '1' ||
      boardInfo.isActive === true
    );
    
    console.log('🔍 フッター表示判定:', {
      appPublished: boardInfo.appPublished,
      isActive: boardInfo.isActive,
      isPublished: isPublished,
      timestamp: new Date().toISOString()
    });

    if (!isPublished) {
      footer.classList.add('hidden');
      return;
    }

    // 公開時はフッターを表示
    footer.classList.remove('hidden');

    // 問題文設定
    questionText.textContent = boardInfo.questionText || 'エラーが発生しました';

    if (boardInfo.isActive && boardInfo.urls) {
      // ボタン表示・機能設定
      openBtn.style.display = 'block';
      copyBtn.style.display = 'block';

      openBtn.onclick = () => window.open(boardInfo.urls.view, '_blank');
      copyBtn.onclick = () => copyViewUrl(boardInfo.urls.view);

      // ステータス更新
      if (statusText) {
        statusText.textContent = '最終更新: ' + (boardInfo.lastUpdated || '不明');
      }
    } else {
      // 非アクティブ状態
      openBtn.style.display = 'none';
      copyBtn.style.display = 'none';
      if (statusText) {
        statusText.textContent = boardInfo.error || 'ボードが非アクティブです';
      }
    }
  }

  // 日時フォーマット関数
  function formatDate(dateString) {
    if (!dateString) return '--';
    try {
      const date = new Date(dateString);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      });
    } catch (e) {
      return '--';
    }
  }

  // URLコピー機能（実用重視）
  function copyViewUrl(url) {
    if (!url) {
      showError('コピーするURLがありません');
      return;
    }

    // クリップボードにコピー
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard
        .writeText(url)
        .then(() => {
          showSuccess('閲覧用URLをコピーしました！');
          // ボタンを一時的に変更してフィードバック
          const btn = document.getElementById('copyViewUrlBtn');
          const originalText = btn.textContent;
          btn.textContent = '✅ コピー完了';
          btn.disabled = true;
          setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }, 2000);
        })
        .catch(() => {
          fallbackCopyUrl(url);
        });
    } else {
      fallbackCopyUrl(url);
    }
  }

  // フォールバック（古いブラウザ用）
  function fallbackCopyUrl(url) {
    const textarea = document.createElement('textarea');
    textarea.value = url;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      showSuccess('閲覧用URLをコピーしました！');
    } catch (err) {
      // 最終手段：URLを表示して手動コピーを促す
      prompt('以下のURLをコピーしてください:', url);
    }
    document.body.removeChild(textarea);
  }

  // アプリケーション名自動生成機能は削除（CLAUDE.md準拠）
</script>
