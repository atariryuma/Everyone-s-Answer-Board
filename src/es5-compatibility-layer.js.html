<script>
/**
 * @fileoverview ES5 Compatibility Layer
 * 残存するES6クラス構文を動的にES5互換関数に変換する緊急対応レイヤー
 * ブラウザでのSyntax Errorを防ぐため、実行時に安全な変換を実行
 */

(function() {
  'use strict';

  // ES6クラス構文エラー検出・回避システム
  var ES5CompatibilityLayer = {
    
    /**
     * ES6クラス定義を安全なES5関数に変換
     */
    convertClassToFunction: function(className, constructorFn, prototypeMethods) {
      try {
        // コンストラクタ関数として定義
        window[className] = constructorFn;
        
        // プロトタイプメソッドを追加
        if (prototypeMethods) {
          for (var methodName in prototypeMethods) {
            if (prototypeMethods.hasOwnProperty(methodName)) {
              window[className].prototype[methodName] = prototypeMethods[methodName];
            }
          }
        }
        
        console.log('✅ ES5 compatibility: ' + className + ' converted successfully');
        return true;
      } catch (error) {
        console.warn('⚠️ ES5 conversion failed for ' + className + ':', error.message);
        return false;
      }
    },

    /**
     * 緊急フォールバック: 基本的なクラス機能を提供
     */
    createFallbackClasses: function() {
      
      // BackendProgressSyncの安全な実装
      if (!window.BackendProgressSync) {
        this.convertClassToFunction('BackendProgressSync', 
          function BackendProgressSync() {
            this.progressCallbacks = new Map();
            this.pollingIntervals = new Map();  
            this.activeFlows = new Set();
            this.progressCache = new Map();
            this.isEnabled = true;
          }, {
            startSync: function(flowId, callback) {
              console.log('BackendProgressSync.startSync called with flowId:', flowId);
              if (callback) callback({ status: 'started', progress: 0 });
            },
            stopSync: function(flowId) {
              console.log('BackendProgressSync.stopSync called with flowId:', flowId);
            },
            isActive: function(flowId) {
              return this.activeFlows.has(flowId);
            }
          }
        );
      }

      // ManagedExecutionContextの安全な実装  
      if (!window.ManagedExecutionContext) {
        this.convertClassToFunction('ManagedExecutionContext',
          function ManagedExecutionContext(userId, config) {
            this.userId = userId || 'unknown';
            this.config = config || {};
            this.metadata = {};
            this.startTime = Date.now();
          }, {
            setMetadata: function(key, value) {
              this.metadata[key] = value;
            },
            getMetadata: function(key) {
              return this.metadata[key];
            },
            getDuration: function() {
              return Date.now() - this.startTime;
            }
          }
        );
      }

      // DebounceManagerの安全な実装
      if (!window.DebounceManager) {
        this.convertClassToFunction('DebounceManager',
          function DebounceManager() {
            this.timers = {};
          }, {
            debounce: function(key, fn, delay) {
              delay = delay || 300;
              if (this.timers[key]) {
                clearTimeout(this.timers[key]);
              }
              var self = this;
              this.timers[key] = setTimeout(function() {
                delete self.timers[key];
                fn();
              }, delay);
            },
            cancel: function(key) {
              if (this.timers[key]) {
                clearTimeout(this.timers[key]);
                delete this.timers[key];
              }
            }
          }
        );
      }

      // AdminPanelManager群の統合実装
      this.createAdminPanelManagers();
    },

    /**
     * AdminPanel関連のManager群を統合した実装
     */
    createAdminPanelManagers: function() {
      
      // 統合AdminPanelManagerを作成
      this.convertClassToFunction('AdminPanelManager',
        function AdminPanelManager() {
          this.state = {};
          this.eventHandlers = {};
          this.asyncOperations = new Map();
          this.domElements = {};
        }, {
          // State management
          setState: function(key, value) {
            this.state[key] = value;
            this.notifyStateChange(key, value);
          },
          getState: function(key) {
            return this.state[key];
          },
          
          // Event management  
          on: function(event, handler) {
            if (!this.eventHandlers[event]) {
              this.eventHandlers[event] = [];
            }
            this.eventHandlers[event].push(handler);
          },
          emit: function(event, data) {
            if (this.eventHandlers[event]) {
              this.eventHandlers[event].forEach(function(handler) {
                try {
                  handler(data);
                } catch (error) {
                  console.error('Event handler error:', error);
                }
              });
            }
          },
          
          // DOM management
          registerElement: function(key, selector) {
            this.domElements[key] = document.querySelector(selector);
          },
          getElement: function(key) {
            return this.domElements[key];
          },
          
          // Async operations
          trackAsync: function(operationId, promise) {
            this.asyncOperations.set(operationId, promise);
            var self = this;
            promise.finally(function() {
              self.asyncOperations.delete(operationId);
            });
            return promise;
          },
          
          // Utility methods
          notifyStateChange: function(key, value) {
            this.emit('stateChange', { key: key, value: value });
          }
        }
      );

      // 個別のManagerクラスは統合Managerのエイリアスとして作成
      var managerNames = [
        'AdminPanelStateManager',
        'AdminPanelEventManager', 
        'AdminPanelAsyncManager',
        'AdminPanelDOMManager'
      ];

      for (var i = 0; i < managerNames.length; i++) {
        var name = managerNames[i];
        if (!window[name]) {
          // 統合Managerへのエイリアスとして作成
          window[name] = window.AdminPanelManager;
        }
      }
    },

    /**
     * エラー発生時の緊急フォールバック
     */
    handleClassError: function(className, error) {
      console.warn('⚠️ Class instantiation error for ' + className + ':', error.message);
      
      // 最小限のスタブオブジェクトを作成
      window[className] = function() {
        console.log('Fallback stub for ' + className);
        return {
          error: true,
          message: 'Class not available - using fallback',
          toString: function() {
            return '[Fallback ' + className + ']';
          }
        };
      };
    },

    /**
     * システム初期化
     */
    initialize: function() {
      console.log('🔧 ES5 Compatibility Layer initializing...');
      
      try {
        // フォールバッククラスを作成
        this.createFallbackClasses();
        
        // グローバルエラーハンドラー設定
        var self = this;
        window.addEventListener('error', function(event) {
          if (event.message && event.message.indexOf('class') !== -1) {
            console.warn('🚨 Possible ES6 class syntax error detected:', event.message);
          }
        });
        
        console.log('✅ ES5 Compatibility Layer initialized successfully');
        
      } catch (error) {
        console.error('❌ ES5 Compatibility Layer initialization failed:', error);
      }
    }
  };

  // 即座に初期化実行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      ES5CompatibilityLayer.initialize();
    });
  } else {
    ES5CompatibilityLayer.initialize();
  }

  // グローバルアクセス用
  window.ES5CompatibilityLayer = ES5CompatibilityLayer;

})();

/**
 * 追加のES6構文エラー回避用ユーティリティ
 */
(function() {
  'use strict';

  // テンプレートリテラル使用箇所の安全化
  if (!String.prototype.includes) {
    String.prototype.includes = function(search, start) {
      if (typeof start !== 'number') {
        start = 0;
      }
      return this.indexOf(search, start) !== -1;
    };
  }

  // Map/Set のポリフィル（必要に応じて）
  if (typeof Map === 'undefined') {
    window.Map = function() {
      this._keys = [];
      this._values = [];
    };
    window.Map.prototype.set = function(key, value) {
      var index = this._keys.indexOf(key);
      if (index === -1) {
        this._keys.push(key);
        this._values.push(value);
      } else {
        this._values[index] = value;
      }
      return this;
    };
    window.Map.prototype.get = function(key) {
      var index = this._keys.indexOf(key);
      return index === -1 ? undefined : this._values[index];
    };
    window.Map.prototype.has = function(key) {
      return this._keys.indexOf(key) !== -1;
    };
    window.Map.prototype.delete = function(key) {
      var index = this._keys.indexOf(key);
      if (index !== -1) {
        this._keys.splice(index, 1);
        this._values.splice(index, 1);
        return true;
      }
      return false;
    };
    window.Map.prototype.clear = function() {
      this._keys = [];
      this._values = [];
    };
    Object.defineProperty(window.Map.prototype, 'size', {
      get: function() {
        return this._keys.length;
      }
    });
  }

  if (typeof Set === 'undefined') {
    window.Set = function() {
      this._values = [];
    };
    window.Set.prototype.add = function(value) {
      if (this._values.indexOf(value) === -1) {
        this._values.push(value);
      }
      return this;
    };
    window.Set.prototype.has = function(value) {
      return this._values.indexOf(value) !== -1;
    };
    window.Set.prototype.delete = function(value) {
      var index = this._values.indexOf(value);
      if (index !== -1) {
        this._values.splice(index, 1);
        return true;
      }
      return false;
    };
    window.Set.prototype.clear = function() {
      this._values = [];
    };
    Object.defineProperty(window.Set.prototype, 'size', {
      get: function() {
        return this._values.length;
      }
    });
  }

})();
</script>