<script>
/**
 * @fileoverview ES5 Compatibility Layer
 * æ®‹å­˜ã™ã‚‹ES6ã‚¯ãƒ©ã‚¹æ§‹æ–‡ã‚’å‹•çš„ã«ES5äº’æ›é–¢æ•°ã«å¤‰æ›ã™ã‚‹ç·Šæ€¥å¯¾å¿œãƒ¬ã‚¤ãƒ¤ãƒ¼
 * ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®Syntax Errorã‚’é˜²ããŸã‚ã€å®Ÿè¡Œæ™‚ã«å®‰å…¨ãªå¤‰æ›ã‚’å®Ÿè¡Œ
 */

(function() {
  'use strict';

  // ES6ã‚¯ãƒ©ã‚¹æ§‹æ–‡ã‚¨ãƒ©ãƒ¼æ¤œå‡ºãƒ»å›é¿ã‚·ã‚¹ãƒ†ãƒ 
  var ES5CompatibilityLayer = {
    
    /**
     * ES6ã‚¯ãƒ©ã‚¹å®šç¾©ã‚’å®‰å…¨ãªES5é–¢æ•°ã«å¤‰æ›
     */
    convertClassToFunction: function(className, constructorFn, prototypeMethods) {
      try {
        // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿é–¢æ•°ã¨ã—ã¦å®šç¾©
        window[className] = constructorFn;
        
        // ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
        if (prototypeMethods) {
          for (var methodName in prototypeMethods) {
            if (prototypeMethods.hasOwnProperty(methodName)) {
              window[className].prototype[methodName] = prototypeMethods[methodName];
            }
          }
        }
        
        console.log('âœ… ES5 compatibility: ' + className + ' converted successfully');
        return true;
      } catch (error) {
        console.warn('âš ï¸ ES5 conversion failed for ' + className + ':', error.message);
        return false;
      }
    },

    /**
     * ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªã‚¯ãƒ©ã‚¹æ©Ÿèƒ½ã‚’æä¾›
     */
    createFallbackClasses: function() {
      
      // BackendProgressSyncã®å®‰å…¨ãªå®Ÿè£…
      if (!window.BackendProgressSync) {
        this.convertClassToFunction('BackendProgressSync', 
          function BackendProgressSync() {
            this.progressCallbacks = new Map();
            this.pollingIntervals = new Map();  
            this.activeFlows = new Set();
            this.progressCache = new Map();
            this.isEnabled = true;
          }, {
            startSync: function(flowId, callback) {
              console.log('BackendProgressSync.startSync called with flowId:', flowId);
              if (callback) callback({ status: 'started', progress: 0 });
            },
            stopSync: function(flowId) {
              console.log('BackendProgressSync.stopSync called with flowId:', flowId);
            },
            isActive: function(flowId) {
              return this.activeFlows.has(flowId);
            }
          }
        );
      }

      // ManagedExecutionContextã®å®‰å…¨ãªå®Ÿè£…  
      if (!window.ManagedExecutionContext) {
        this.convertClassToFunction('ManagedExecutionContext',
          function ManagedExecutionContext(userId, config) {
            this.userId = userId || 'unknown';
            this.config = config || {};
            this.metadata = {};
            this.startTime = Date.now();
          }, {
            setMetadata: function(key, value) {
              this.metadata[key] = value;
            },
            getMetadata: function(key) {
              return this.metadata[key];
            },
            getDuration: function() {
              return Date.now() - this.startTime;
            }
          }
        );
      }

      // DebounceManagerã®å®‰å…¨ãªå®Ÿè£…
      if (!window.DebounceManager) {
        this.convertClassToFunction('DebounceManager',
          function DebounceManager() {
            this.timers = {};
          }, {
            debounce: function(key, fn, delay) {
              delay = delay || 300;
              if (this.timers[key]) {
                clearTimeout(this.timers[key]);
              }
              var self = this;
              this.timers[key] = setTimeout(function() {
                delete self.timers[key];
                fn();
              }, delay);
            },
            cancel: function(key) {
              if (this.timers[key]) {
                clearTimeout(this.timers[key]);
                delete this.timers[key];
              }
            }
          }
        );
      }

      // AdminPanelManagerç¾¤ã®çµ±åˆå®Ÿè£…
      this.createAdminPanelManagers();
    },

    /**
     * AdminPanelé–¢é€£ã®Managerç¾¤ã‚’çµ±åˆã—ãŸå®Ÿè£…
     */
    createAdminPanelManagers: function() {
      
      // çµ±åˆAdminPanelManagerã‚’ä½œæˆ
      this.convertClassToFunction('AdminPanelManager',
        function AdminPanelManager() {
          this.state = {};
          this.eventHandlers = {};
          this.asyncOperations = new Map();
          this.domElements = {};
        }, {
          // State management
          setState: function(key, value) {
            this.state[key] = value;
            this.notifyStateChange(key, value);
          },
          getState: function(key) {
            return this.state[key];
          },
          
          // Event management  
          on: function(event, handler) {
            if (!this.eventHandlers[event]) {
              this.eventHandlers[event] = [];
            }
            this.eventHandlers[event].push(handler);
          },
          emit: function(event, data) {
            if (this.eventHandlers[event]) {
              this.eventHandlers[event].forEach(function(handler) {
                try {
                  handler(data);
                } catch (error) {
                  console.error('Event handler error:', error);
                }
              });
            }
          },
          
          // DOM management
          registerElement: function(key, selector) {
            this.domElements[key] = document.querySelector(selector);
          },
          getElement: function(key) {
            return this.domElements[key];
          },
          
          // Async operations
          trackAsync: function(operationId, promise) {
            this.asyncOperations.set(operationId, promise);
            var self = this;
            promise.finally(function() {
              self.asyncOperations.delete(operationId);
            });
            return promise;
          },
          
          // Utility methods
          notifyStateChange: function(key, value) {
            this.emit('stateChange', { key: key, value: value });
          }
        }
      );

      // å€‹åˆ¥ã®Managerã‚¯ãƒ©ã‚¹ã¯çµ±åˆManagerã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦ä½œæˆ
      var managerNames = [
        'AdminPanelStateManager',
        'AdminPanelEventManager', 
        'AdminPanelAsyncManager',
        'AdminPanelDOMManager'
      ];

      for (var i = 0; i < managerNames.length; i++) {
        var name = managerNames[i];
        if (!window[name]) {
          // çµ±åˆManagerã¸ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦ä½œæˆ
          window[name] = window.AdminPanelManager;
        }
      }
    },

    /**
     * ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
     */
    handleClassError: function(className, error) {
      console.warn('âš ï¸ Class instantiation error for ' + className + ':', error.message);
      
      // æœ€å°é™ã®ã‚¹ã‚¿ãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
      window[className] = function() {
        console.log('Fallback stub for ' + className);
        return {
          error: true,
          message: 'Class not available - using fallback',
          toString: function() {
            return '[Fallback ' + className + ']';
          }
        };
      };
    },

    /**
     * ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
     */
    initialize: function() {
      console.log('ğŸ”§ ES5 Compatibility Layer initializing...');
      
      try {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ
        this.createFallbackClasses();
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®š
        var self = this;
        window.addEventListener('error', function(event) {
          if (event.message && event.message.indexOf('class') !== -1) {
            console.warn('ğŸš¨ Possible ES6 class syntax error detected:', event.message);
          }
        });
        
        console.log('âœ… ES5 Compatibility Layer initialized successfully');
        
      } catch (error) {
        console.error('âŒ ES5 Compatibility Layer initialization failed:', error);
      }
    }
  };

  // å³åº§ã«åˆæœŸåŒ–å®Ÿè¡Œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      ES5CompatibilityLayer.initialize();
    });
  } else {
    ES5CompatibilityLayer.initialize();
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨
  window.ES5CompatibilityLayer = ES5CompatibilityLayer;

})();

/**
 * è¿½åŠ ã®ES6æ§‹æ–‡ã‚¨ãƒ©ãƒ¼å›é¿ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */
(function() {
  'use strict';

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«ä½¿ç”¨ç®‡æ‰€ã®å®‰å…¨åŒ–
  if (!String.prototype.includes) {
    String.prototype.includes = function(search, start) {
      if (typeof start !== 'number') {
        start = 0;
      }
      return this.indexOf(search, start) !== -1;
    };
  }

  // Map/Set ã®ãƒãƒªãƒ•ã‚£ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  if (typeof Map === 'undefined') {
    window.Map = function() {
      this._keys = [];
      this._values = [];
    };
    window.Map.prototype.set = function(key, value) {
      var index = this._keys.indexOf(key);
      if (index === -1) {
        this._keys.push(key);
        this._values.push(value);
      } else {
        this._values[index] = value;
      }
      return this;
    };
    window.Map.prototype.get = function(key) {
      var index = this._keys.indexOf(key);
      return index === -1 ? undefined : this._values[index];
    };
    window.Map.prototype.has = function(key) {
      return this._keys.indexOf(key) !== -1;
    };
    window.Map.prototype.delete = function(key) {
      var index = this._keys.indexOf(key);
      if (index !== -1) {
        this._keys.splice(index, 1);
        this._values.splice(index, 1);
        return true;
      }
      return false;
    };
    window.Map.prototype.clear = function() {
      this._keys = [];
      this._values = [];
    };
    Object.defineProperty(window.Map.prototype, 'size', {
      get: function() {
        return this._keys.length;
      }
    });
  }

  if (typeof Set === 'undefined') {
    window.Set = function() {
      this._values = [];
    };
    window.Set.prototype.add = function(value) {
      if (this._values.indexOf(value) === -1) {
        this._values.push(value);
      }
      return this;
    };
    window.Set.prototype.has = function(value) {
      return this._values.indexOf(value) !== -1;
    };
    window.Set.prototype.delete = function(value) {
      var index = this._values.indexOf(value);
      if (index !== -1) {
        this._values.splice(index, 1);
        return true;
      }
      return false;
    };
    window.Set.prototype.clear = function() {
      this._values = [];
    };
    Object.defineProperty(window.Set.prototype, 'size', {
      get: function() {
        return this._values.length;
      }
    });
  }

})();
</script>