<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>StudyQuest - みんなのかいとうボード</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      http-equiv="Permissions-Policy"
      content="camera=(), microphone=(), geolocation=(), ambient-light-sensor=(), speaker=(), vibrate=(), xr-spatial-tracking=()"
    />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript
      ><link
        href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
        rel="stylesheet"
    /></noscript>
    <link rel="dns-prefetch" href="//script.google.com" />
    <link rel="preconnect" href="https://script.google.com" crossorigin />

    <!-- GAS推奨: セキュリティヘッダー最優先 -->
    <?!= include('SharedSecurityHeaders'); ?>

    <!-- GAS推奨: CSS読み込みはhead内に集約 -->
    <?!= include('SharedTailwindConfig'); ?>
    <?!= include('page.css'); ?>

    <!-- GAS推奨: ライブラリスクリプトの事前読み込み -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
  </head>
  <body class="bg-[#1a1b26] text-gray-200 font-sans">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
      <div class="text-center">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-300">読み込み中...</p>
      </div>
    </div>

    <div id="main-container" class="w-full mx-auto px-4 pt-4 pb-4 md:px-6 md:pt-6 md:pb-6">
      <header
        id="main-header"
        class="glass-panel rounded-xl p-4 mb-4 flex flex-col lg:flex-row justify-between items-center gap-4 shadow-lg fade-in"
      >
        <!-- Left Section: Controls -->
        <div class="flex items-center gap-4 w-full lg:w-auto">
          <div id="answerCount" class="text-sm text-gray-400 flex items-center gap-2 flex-shrink-0">
            <svg
              class="w-4 h-4 text-blue-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
              ></path>
            </svg>
            <span id="answerCountText">0 件の回答</span>
          </div>

          <div class="flex items-center gap-2">
            <label for="classFilter" class="sr-only">クラス絞り込み</label>
            <select
              id="classFilter"
              class="hidden text-sm bg-gray-700 border border-gray-600 rounded px-2 py-1"
            ></select>

            <label for="sortOrder" class="sr-only">並び順</label>
            <div class="relative">
              <select
                id="sortOrder"
                class="text-sm bg-gray-700 border border-gray-600 rounded px-3 py-1 pr-8 appearance-none cursor-pointer"
              >
                <option value="newest" selected>新着順</option>
                <option value="random">ランダム順</option>
                <option value="score" id="scoreOption" class="hidden">スコア順</option>
              </select>
              <svg
                class="absolute right-2 top-1/2 transform -translate-y-1/2 w-3 h-3 text-gray-400 pointer-events-none"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                ></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- Center Section: Title -->
        <div class="flex-grow text-center w-full min-w-0 px-2">
          <h1
            id="siteTitle"
            class="game-font text-yellow-300 text-base md:text-lg lg:text-xl mb-2 truncate flex items-center justify-center gap-2"
          >
            <svg
              class="w-5 h-5 text-yellow-300"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              ></path>
            </svg>
            みんなの回答ボード
          </h1>
          <div
            id="headingLabel"
            class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold text-pink-400 leading-tight flex justify-center items-center min-h-[2rem]"
          >
            <svg
              class="w-5 h-5 md:w-6 md:h-6 animate-spin"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
                fill="currentColor"
              ></path>
            </svg>
          </div>
        </div>

        <!-- Right Section: Info & Admin Controls -->
        <div class="w-full lg:w-auto lg:min-w-[150px] text-right space-y-1 px-2">
          <p
            id="ownerNameText"
            class="text-xs text-gray-500 h-4 truncate flex items-center justify-end gap-1"
          >
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
          </p>
          <p
            id="sheetNameText"
            class="text-xs text-gray-400 h-4 truncate flex items-center justify-end gap-1"
          >
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>
          </p>
          <p id="modeLabel" class="text-xs text-gray-400 truncate"></p>
          <div class="flex justify-end gap-1 flex-wrap">
            <button
              type="button"
              id="endPublicationBtn"
              class="admin-toggle text-xs bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded hidden whitespace-nowrap transition-all flex items-center gap-1"
              hidden
              aria-label="公開終了"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636"
                ></path>
              </svg>
              公開終了
            </button>
            <button
              type="button"
              id="adminToggleBtn"
              class="admin-toggle text-xs text-gray-500 hover:text-cyan-400 transition-all opacity-60 hover:opacity-100 hidden whitespace-nowrap flex items-center gap-1 px-2 py-1 rounded"
              hidden
              aria-label="管理者モード切り替え"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </header>

      <!-- 新着通知バナー -->
      <div
        id="newContentBanner"
        class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-full shadow-lg hidden transition-all duration-300"
        role="alert"
        aria-live="polite"
      >
        <div class="flex items-center gap-3">
          <span id="newContentIcon" class="w-5 h-5 animate-pulse" aria-hidden="true">📋</span>
          <span id="newContentText">新しい意見が投稿されました</span>
          <button
            type="button"
            id="refreshContentBtn"
            class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full text-sm font-medium transition-colors"
            aria-label="新しいコンテンツを更新して表示"
          >
            更新して表示
          </button>
          <button
            type="button"
            id="dismissBannerBtn"
            class="text-white/70 hover:text-white w-5 h-5 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            aria-label="通知を閉じる"
          >
            ×
          </button>
        </div>
      </div>

      <main
        id="answers"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
        role="main"
        aria-live="polite"
        aria-label="回答一覧"
      ></main>
    </div>

    <!-- Answer Modal -->
    <div
      id="answerModalContainer"
      class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300"
      role="dialog"
      aria-modal="true"
    >
      <div
        id="answerModalCard"
        class="glass-panel rounded-xl p-6 flex flex-col shadow-2xl border-2 border-cyan-400/80 w-full max-w-5xl h-auto max-h-[85vh] transform scale-95 transition-transform duration-300"
        role="document"
        aria-labelledby="modalAnswer"
      >
        <button
          type="button"
          id="answerModalCloseBtn"
          class="absolute -top-3 -right-3 bg-red-600 rounded-full p-2 text-white hover:scale-110 transition-transform"
          aria-label="閉じる"
        >
          <span id="iconClose" class="w-6 h-6"></span>
        </button>
        <div id="modalAnswer" class="flex-grow min-h-[200px] mb-4 overflow-y-auto pr-4"></div>
        <div
          id="modalFooter"
          class="text-xs text-gray-400 pt-4 border-t-2 border-dashed border-cyan-400/80 flex justify-between items-center"
        >
          <div><span id="modalStudentName" class="font-bold text-2xl text-gray-200"></span></div>
          <div id="modalReactions" class="flex items-center gap-2"></div>
        </div>
      </div>
    </div>

    <!-- Info Modal -->
    <div
      id="infoModalContainer"
      class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300"
      role="dialog"
      aria-modal="true"
    >
      <div
        id="infoModalCard"
        class="glass-panel rounded-xl p-6 shadow-2xl border-2 border-cyan-400/80 w-full max-w-lg transform scale-95 transition-transform duration-300 relative"
        role="document"
      >
        <div class="space-y-4 text-gray-200 text-lg leading-relaxed">
          <p>みんなの意見を気持ちよく共有するために、リアクションのしかたをおぼえよう！</p>
          <ul class="space-y-2">
            <li class="flex items-center gap-2">
              <span id="infoIconLike" class="w-5 h-5 text-red-400"></span>いいね：すてきだと思ったときに押そう
            </li>
            <li class="flex items-center gap-2">
              <span id="infoIconUnderstand" class="w-5 h-5 text-yellow-400"></span>なるほど：参考になったときに押そう
            </li>
            <li class="flex items-center gap-2">
              <span id="infoIconCurious" class="w-5 h-5 text-green-400"></span>きになる：もっと知りたいときに押そう
            </li>
          </ul>
          <p class="flex items-center gap-2">
            <span id="infoIconHighlight" class="w-5 h-5 text-purple-400"></span>先生が注目してほしい意見につけています
          </p>
          <p>責任あるリアクションで、みんなで学びを深めよう！</p>
          <div class="text-center mt-6">
            <button
              id="infoModalConfirmBtn"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            >
              わかった
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Controls -->
    <footer id="controlsFooter" class="fixed bottom-0 left-0 right-0 z-40 p-4">
      <div class="glass-panel max-w-md mx-auto rounded-xl p-3 flex items-center justify-center gap-3">
        <input type="range" id="sizeSlider" min="2" max="6" value="4" class="w-1/2" aria-label="表示列数の変更">
        <div class="flex items-center gap-1">
          <span id="sliderValue" class="font-bold text-lg">4</span>
          <span id="footerIcon" class="w-4 h-4"></span>
        </div>
        <button type="button" id="modeToggleBtn" class="ml-4 px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm" title="プレビューモード切り替え">切替</button>
      </div>
    </footer>

    <!-- サーバーデータをクライアントサイドで利用可能にする -->
    <script>
      // サーバーから渡されたパラメータをwindowオブジェクトに設定
      // GAS Template: userId injection
      window.userId = <?!= JSON.stringify(data.userId || null) ?>;
      // GAS Template: userEmail injection
      window.userEmail = <?!= JSON.stringify(data.userEmail || null) ?>;

      // DISPLAY_MODES定数を追加（フロントエンドエラー修正）
      window.DISPLAY_MODES = {
        ANONYMOUS: 'anonymous',
        SHOW_NAME: 'show_name',
        SHOW_COUNTS: 'show_counts'
      };
    </script>

    <!-- GAS推奨: JavaScript読み込みは</body>直前に集約 -->
    <?!= include('SharedUtilities'); ?>
    <?!= include('SharedErrorHandling'); ?>
    <?!= include('page.js'); ?>

  </body>
</html>