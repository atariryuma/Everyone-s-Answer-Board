<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>StudyQuest - みんなのかいとうボード</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript
      ><link
        href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
        rel="stylesheet"
    /></noscript>
    <link rel="dns-prefetch" href="//script.google.com" />
    <link rel="preconnect" href="https://script.google.com" crossorigin />
    <?!= include('SharedTailwindConfig'); ?>
    <style>
      :root {
        --color-primary: #8be9fd;
        --color-background: #1a1b26;
        --color-surface: rgba(26, 27, 38, 0.95);
        --color-text: #c0caf5;
        --color-border: rgba(255, 255, 255, 0.1);
        --color-accent: #facc15;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.15);
        --color-success: #10b981;
        --color-error: #ef4444;
        --color-warning: #f59e0b;
        /* Performance variables */
        --transition-duration: 0.2s;
        --transition-easing: ease-out;
        --animation-duration: 0.3s;
        --backdrop-blur: 12px;
      }
      body {
        color: var(--color-text);
        background-color: var(--color-background);
        margin: 0;
        overflow-x: hidden;
      }
      .glass-panel {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        backdrop-filter: blur(var(--backdrop-blur));
        -webkit-backdrop-filter: blur(var(--backdrop-blur));
        transition: border-color var(--transition-duration) var(--transition-easing);
      }
      .glass-panel:hover {
        border-color: rgba(255, 255, 255, 0.2);
      }
      .game-font {
        font-family: 'Press Start 2P', cursive;
      }
      .game-btn {
        transition:
          transform var(--transition-duration) var(--transition-easing),
          box-shadow var(--transition-duration) var(--transition-easing),
          border-bottom-width var(--transition-duration) var(--transition-easing);
        border-radius: 0.75rem;
        border-bottom-width: 4px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
        position: relative;
        overflow: hidden;
      }
      .game-btn:not(:disabled):hover {
        transform: translate3d(0, -2px, 0);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      }
      .game-btn:active:not(:disabled) {
        transform: translate3d(0, 2px, 0);
        border-bottom-width: 2px;
      }
      .game-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }
      #classFilter,
      #sortOrder {
        background-color: #6272a4;
        border: 1px solid var(--color-border);
        color: var(--color-text);
        border-radius: 0.75rem;
        padding: 0.5rem 0.75rem;
        transition:
          border-color var(--transition-duration) var(--transition-easing),
          box-shadow var(--transition-duration) var(--transition-easing);
      }
      #classFilter:focus,
      #sortOrder:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(139, 233, 253, 0.1);
      }
      :focus-visible {
        outline: 3px solid var(--color-primary);
        outline-offset: 2px;
        border-radius: 0.75rem;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 50;
        contain: layout;
        backdrop-filter: blur(var(--backdrop-blur));
        -webkit-backdrop-filter: blur(var(--backdrop-blur));
      }
      .answer-card {
        transition:
          transform var(--animation-duration) var(--transition-easing),
          box-shadow var(--animation-duration) var(--transition-easing);
        border-radius: 1rem;
        contain: layout style;
        position: relative;
        overflow: hidden;
      }
      .answer-card.highlighted {
        border-image: linear-gradient(45deg, #9333ea, #c084fc, #9333ea) 1 !important;
        border-width: 4px !important;
        box-shadow:
          0 0 25px rgba(147, 51, 234, 0.6),
          inset 0 0 20px rgba(192, 132, 252, 0.1),
          0 8px 32px rgba(147, 51, 234, 0.2);
        transform: scale(1.02);
        position: relative;
      }
      .answer-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
      }
      .answer-card.loading {
        opacity: 0.7;
        pointer-events: none;
      }
      .reaction-btn {
        transition:
          transform var(--transition-duration) var(--transition-easing),
          background-color var(--transition-duration) var(--transition-easing),
          box-shadow var(--transition-duration) var(--transition-easing);
        position: relative;
        overflow: hidden;
      }
      .reaction-btn:hover {
        transform: scale(1.1);
      }
      .reaction-btn:active {
        transform: scale(0.95);
      }
      .reaction-btn.reacted {
        background-color: var(--color-primary) !important;
        color: #000 !important;
        box-shadow: 0 0 10px rgba(139, 233, 253, 0.5);
      }
      .reaction-btn.loading {
        opacity: 0.6;
        pointer-events: none;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }
      .slide-in {
        animation: slideIn 0.3s ease-out;
      }
      .pulse {
        animation: pulse 0.6s ease-out;
      }
      .shake {
        animation: shake 0.5s ease-out;
      }
      .admin-toggle {
        transition: background-color var(--animation-duration) var(--transition-easing);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      .admin-toggle:hover {
        background-color: rgba(139, 233, 253, 0.1);
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(26, 27, 38, 0.8);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(139, 233, 253, 0.3);
        border-top: 4px solid var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          will-change: opacity;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          will-change: opacity;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes pulse {
        0% {
          will-change: transform;
        }
        50% {
          transform: scale3d(1.05, 1.05, 1);
        }
        100% {
          transform: scale3d(1, 1, 1);
        }
      }
      @keyframes shake {
        0%,
        100% {
          will-change: transform;
        }
        25% {
          transform: translate3d(-5px, 0, 0);
        }
        75% {
          transform: translate3d(5px, 0, 0);
        }
      }
      @keyframes spin {
        100% {
          transform: rotate(360deg);
          will-change: transform;
        }
      }
      @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translate(-50%, 0) translateY(0);
        }
        40% {
          transform: translate(-50%, 0) translateY(-10px);
        }
        60% {
          transform: translate(-50%, 0) translateY(-5px);
        }
      }

      /* Performance optimizations */
      @media (max-width: 768px) and (max-resolution: 150dpi) {
        :root {
          --backdrop-blur: 0px;
          --transition-duration: 0.1s;
          --animation-duration: 0.15s;
        }

        .glass-panel {
          backdrop-filter: none;
          -webkit-backdrop-filter: none;
          background: var(--color-surface);
        }

        .answer-card:hover {
          transform: none;
        }

        .reaction-btn:hover {
          transform: scale(1.05);
        }
      }

      /* Low-end device optimizations */
      @media (max-width: 768px), (max-resolution: 120dpi) {
        :root {
          --backdrop-blur: 0px;
          --transition-duration: 0.1s;
          --animation-duration: 0.1s;
        }
      }

      /* High refresh rate display optimizations */
      @media (min-resolution: 120dpi) and (min-width: 1200px) {
        :root {
          --transition-duration: 0.15s;
          --animation-duration: 0.2s;
        }
      }

      /* Responsive improvements */
      @media (max-width: 768px) {
        .answer-card {
          margin-bottom: 1rem;
        }
        .game-btn {
          padding: 0.75rem 1rem;
          font-size: 0.875rem;
        }
        header {
          padding: 1rem;
        }
      }

      /* High contrast mode support */
      @media (prefers-contrast: high) {
        :root {
          --color-border: rgba(255, 255, 255, 0.3);
          --color-surface: rgba(26, 27, 38, 0.98);
        }
      }

      /* Reduced motion support */
      @media (prefers-reduced-motion: reduce) {
        :root {
          --transition-duration: 0.01ms;
          --animation-duration: 0.01ms;
          --backdrop-blur: 0px;
        }

        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
          transform: none !important;
        }

        .answer-card:hover,
        .reaction-btn:hover,
        .game-btn:hover {
          transform: none !important;
        }
      }

      /* Low performance mode styles */
      .low-performance .answer-card {
        contain: layout style paint;
      }

      .low-performance .answer-card:hover {
        transform: none;
        box-shadow: var(--shadow-sm);
      }

      .low-performance .glass-panel {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }

      /* Hidden card styles for virtual scrolling */
      .hidden-card {
        visibility: hidden;
        pointer-events: none;
      }

      .visible {
        visibility: visible;
        pointer-events: auto;
      }

      /* Optimize grid layout for performance */
      @supports (container-type: inline-size) {
        #answers {
          container-type: inline-size;
        }
      }

      /* Optimize for high DPI displays */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .answer-card {
          backface-visibility: hidden;
          perspective: 1000px;
        }
      }
      .answer-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
      }
      .answer-card.new-card {
        animation: fadeIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .highlight-badge {
        position: absolute;
        top: 0.25rem;
        right: 0.25rem;
        width: 1.5rem;
        height: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #facc15;
      }
      .answer-card.reaction-bg-like {
        border-color: #ef4444 !important;
      }
      .answer-card.reaction-bg-understand {
        border-color: #fbbf24 !important;
      }
      .answer-card.reaction-bg-curious {
        border-color: #10b981 !important;
      }
      .answer-card.reaction-bg-like-understand {
        border-image: linear-gradient(45deg, #ef4444, #fbbf24) 1 !important;
      }
      .answer-card.reaction-bg-like-curious {
        border-image: linear-gradient(45deg, #ef4444, #10b981) 1 !important;
      }
      .answer-card.reaction-bg-understand-curious {
        border-image: linear-gradient(45deg, #fbbf24, #10b981) 1 !important;
      }
      .answer-card.reaction-bg-like-understand-curious {
        border-image: linear-gradient(45deg, #ef4444, #fbbf24, #10b981) 1 !important;
      }
      .reaction-border-1 {
        border-width: 2px;
      }
      .reaction-border-2 {
        border-width: 4px;
      }
      .reaction-border-3 {
        border-width: 6px;
      }
      .answer-preview {
        display: -webkit-box;
        -webkit-line-clamp: 5;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 120px;
      }
      .like-btn svg {
        transition:
          fill var(--transition-duration) var(--transition-easing),
          transform var(--transition-duration) var(--transition-easing);
        fill: none;
      }
      .like-btn.liked svg {
        stroke: transparent;
        fill: currentColor;
        transform: scale(1.1);
      }
      .like-btn.loading {
        opacity: 0.7;
        position: relative;
        pointer-events: none;
      }
      .like-btn.loading::after {
        content: '';
        position: absolute;
        inset: 0;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        width: 16px;
        height: 16px;
        margin: auto;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .highlight-btn {
        transition:
          background var(--transition-duration) var(--transition-easing),
          transform var(--transition-duration) var(--transition-easing);
        border-radius: 4px;
        padding: 2px;
      }
      .highlight-btn:hover {
        background: rgba(147, 51, 234, 0.15);
        transform: scale(1.1);
      }
      .highlight-btn.liked {
        color: #9333ea;
        text-shadow: 0 0 8px rgba(147, 51, 234, 0.6);
      }
      #controlsFooter {
        pointer-events: none;
      }
      #controlsFooter > .glass-panel {
        pointer-events: auto;
      }
      .skeleton {
        position: relative;
        overflow: hidden;
        background-color: rgba(255, 255, 255, 0.05);
      }
      .skeleton::after {
        content: '';
        position: absolute;
        inset: 0;
        background-image: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 0.2),
          rgba(255, 255, 255, 0)
        );
        animation: skeleton-loading 1.5s infinite;
      }
      @keyframes skeleton-loading {
        0% {
          transform: translate3d(-100%, 0, 0);
          will-change: transform;
        }
        100% {
          transform: translate3d(100%, 0, 0);
        }
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      .modal-close-btn {
        position: absolute;
        top: -12px;
        right: -12px;
        transform: none;
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      /* モーダルでのリアクション装飾 */
      #answerModalCard.reaction-border-1 {
        border-width: 3px !important;
      }
      #answerModalCard.reaction-border-2 {
        border-width: 4px !important;
      }
      #answerModalCard.reaction-border-3 {
        border-width: 5px !important;
      }
      /* モーダルでのリアクション背景色 */
      #answerModalCard.reaction-bg-like {
        border-color: #ef4444 !important;
        border-image: none !important;
      }
      #answerModalCard.reaction-bg-understand {
        border-color: #fbbf24 !important;
        border-image: none !important;
      }
      #answerModalCard.reaction-bg-curious {
        border-color: #10b981 !important;
        border-image: none !important;
      }
      #answerModalCard.reaction-bg-like-understand {
        border-image: linear-gradient(45deg, #ef4444, #fbbf24) 1 !important;
        border-color: transparent !important;
      }
      #answerModalCard.reaction-bg-like-curious {
        border-image: linear-gradient(45deg, #ef4444, #10b981) 1 !important;
        border-color: transparent !important;
      }
      #answerModalCard.reaction-bg-understand-curious {
        border-image: linear-gradient(45deg, #fbbf24, #10b981) 1 !important;
        border-color: transparent !important;
      }
      #answerModalCard.reaction-bg-like-understand-curious {
        border-image: linear-gradient(45deg, #ef4444, #fbbf24, #10b981) 1 !important;
        border-color: transparent !important;
      }
      /* モーダルでのハイライト装飾（リアクション装飾より後に配置で優先） */
      #answerModalCard.highlighted {
        border-image: linear-gradient(45deg, #9333ea, #c084fc, #9333ea) 1 !important;
        border-width: 4px !important;
        box-shadow:
          0 0 25px rgba(147, 51, 234, 0.6),
          inset 0 0 20px rgba(192, 132, 252, 0.1) !important;
        position: relative;
      }
      .render-optimized {
        transform: translateZ(0);
      }
      .modal-fade {
        animation: modalFade 0.2s ease-out;
      }
      @keyframes modalFade {
        from {
          opacity: 0;
          will-change: opacity;
        }
        to {
          opacity: 1;
        }
      }
      .modal-scale {
        animation: modalScale 0.2s ease-out;
      }
      @keyframes modalScale {
        from {
          will-change: transform;
        }
        to {
          transform: scale3d(1, 1, 1);
        }
      }
    </style>
  </head>
  <body class="bg-[#1a1b26] text-gray-200 font-sans">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
      <div class="text-center">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-300">読み込み中...</p>
      </div>
    </div>

    <div id="main-container" class="w-full mx-auto px-4 pt-4 pb-4 md:px-6 md:pt-6 md:pb-6">
      <header
        id="main-header"
        class="glass-panel rounded-xl p-4 mb-4 flex flex-col lg:flex-row justify-between items-center gap-4 shadow-lg fade-in"
      >
        <!-- Left Section: Controls -->
        <div class="flex items-center gap-4 w-full lg:w-auto">
          <div id="answerCount" class="text-sm text-gray-400 flex items-center gap-2 flex-shrink-0">
            <svg
              class="w-4 h-4 text-blue-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
              ></path>
            </svg>
            <span id="answerCountText">0 件の回答</span>
          </div>

          <div class="flex items-center gap-2">
            <label for="classFilter" class="sr-only">クラス絞り込み</label>
            <select
              id="classFilter"
              class="hidden text-sm bg-gray-700 border border-gray-600 rounded px-2 py-1"
            ></select>

            <label for="sortOrder" class="sr-only">並び順</label>
            <div class="relative">
              <select
                id="sortOrder"
                class="text-sm bg-gray-700 border border-gray-600 rounded px-3 py-1 pr-8 appearance-none cursor-pointer"
              >
                <option value="newest" selected>新着順</option>
                <option value="random">ランダム順</option>
                <option value="score" id="scoreOption" class="hidden">スコア順</option>
              </select>
              <svg
                class="absolute right-2 top-1/2 transform -translate-y-1/2 w-3 h-3 text-gray-400 pointer-events-none"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                ></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- Center Section: Title -->
        <div class="flex-grow text-center w-full min-w-0 px-2">
          <h1
            id="siteTitle"
            class="game-font text-yellow-300 text-base md:text-lg lg:text-xl mb-2 truncate flex items-center justify-center gap-2"
          >
            <svg
              class="w-5 h-5 text-yellow-300"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              ></path>
            </svg>
            みんなの回答ボード
          </h1>
          <div
            id="headingLabel"
            class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold text-pink-400 leading-tight flex justify-center items-center min-h-[2rem]"
          >
            <svg
              class="w-5 h-5 md:w-6 md:h-6 animate-spin"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
                fill="currentColor"
              ></path>
            </svg>
          </div>
        </div>

        <!-- Right Section: Info & Admin Controls -->
        <div class="w-full lg:w-auto lg:min-w-[150px] text-right space-y-1 px-2">
          <p
            id="ownerNameText"
            class="text-xs text-gray-500 h-4 truncate flex items-center justify-end gap-1"
          >
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
          </p>
          <p
            id="sheetNameText"
            class="text-xs text-gray-400 h-4 truncate flex items-center justify-end gap-1"
          >
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>
          </p>
          <p id="modeLabel" class="text-xs text-gray-400 truncate"></p>
          <div class="flex justify-end gap-1 flex-wrap">
            <button
              type="button"
              id="formAnswerBtn"
              class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded whitespace-nowrap transition-all flex items-center gap-1"
              aria-label="フォームで回答"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                ></path>
              </svg>
              フォームで回答
            </button>
            <button
              type="button"
              id="endPublicationBtn"
              class="admin-toggle text-xs bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded hidden whitespace-nowrap transition-all flex items-center gap-1"
              hidden
              aria-label="公開終了"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636"
                ></path>
              </svg>
              公開終了
            </button>
            <button
              type="button"
              id="adminToggleBtn"
              class="admin-toggle text-xs text-gray-500 hover:text-cyan-400 transition-all opacity-60 hover:opacity-100 hidden whitespace-nowrap flex items-center gap-1 px-2 py-1 rounded"
              hidden
              aria-label="管理者モード切り替え"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </header>
      <!-- 新着通知バナー -->
      <div
        id="newContentBanner"
        class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-full shadow-lg hidden transition-all duration-300"
        role="alert"
        aria-live="polite"
      >
        <div class="flex items-center gap-3">
          <span id="newContentIcon" class="w-5 h-5 animate-pulse" aria-hidden="true">📋</span>
          <span id="newContentText">新しい意見が投稿されました</span>
          <button
            type="button"
            id="refreshContentBtn"
            class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full text-sm font-medium transition-colors"
            aria-label="新しいコンテンツを更新して表示"
          >
            更新して表示
          </button>
          <button
            type="button"
            id="dismissBannerBtn"
            class="text-white/70 hover:text-white w-5 h-5 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            aria-label="通知を閉じる"
          >
            ×
          </button>
        </div>
      </div>

      <main
        id="answers"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
        role="main"
        aria-live="polite"
        aria-label="回答一覧"
      ></main>
    </div>
    <div
      id="answerModalContainer"
      class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        id="answerModalCard"
        class="glass-panel rounded-xl p-6 flex flex-col shadow-2xl border-2 border-cyan-400/80 w-full max-w-5xl h-auto max-h-[85vh] relative"
        role="document"
        aria-labelledby="modalAnswer"
      >
        <button
          type="button"
          id="answerModalCloseBtn"
          class="modal-close-btn bg-red-600 rounded-full p-2 text-white hover:scale-110 transition-transform z-10"
          aria-label="閉じる"
        >
          <span id="iconClose" class="w-6 h-6"></span>
        </button>
        <div id="modalAnswer" class="flex-grow min-h-[200px] mb-4 overflow-y-auto pr-4"></div>
        <div
          id="modalFooter"
          class="text-xs text-gray-400 pt-4 border-t-2 border-dashed border-cyan-400/80 flex justify-between items-center"
        >
          <div><span id="modalStudentName" class="font-bold text-2xl text-gray-200"></span></div>
          <div id="modalReactions" class="flex items-center gap-2"></div>
        </div>
      </div>
    </div>
    <div
      id="infoModalContainer"
      class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        id="infoModalCard"
        class="glass-panel rounded-xl p-6 shadow-2xl border-2 border-cyan-400/80 w-full max-w-lg relative"
        role="document"
      >
        <div class="space-y-4 text-gray-200 text-lg leading-relaxed">
          <p>みんなの意見を気持ちよく共有するために、リアクションのしかたをおぼえよう！</p>
          <ul class="space-y-2">
            <li class="flex items-center gap-2">
              <span id="infoIconLike" class="w-5 h-5 text-red-400"></span
              >いいね：すてきだと思ったときに押そう
            </li>
            <li class="flex items-center gap-2">
              <span id="infoIconUnderstand" class="w-5 h-5 text-yellow-400"></span
              >なるほど：参考になったときに押そう
            </li>
            <li class="flex items-center gap-2">
              <span id="infoIconCurious" class="w-5 h-5 text-green-400"></span
              >きになる：もっと知りたいときに押そう
            </li>
          </ul>
          <p class="flex items-center gap-2">
            <span id="infoIconHighlight" class="w-5 h-5 text-purple-400"></span
            >先生が注目してほしい意見につけています
          </p>
          <p>責任あるリアクションで、みんなで学びを深めよう！</p>
          <div class="text-center mt-6">
            <button
              id="infoModalConfirmBtn"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            >
              わかった
            </button>
          </div>
        </div>
      </div>
    </div>
    <footer id="controlsFooter" class="fixed bottom-0 left-0 right-0 z-40 p-4">
      <div
        class="glass-panel max-w-md mx-auto rounded-xl p-3 flex items-center justify-center gap-3"
      >
        <input
          type="range"
          id="sizeSlider"
          min="2"
          max="6"
          value="4"
          class="w-1/2"
          aria-label="表示列数の変更"
        />
        <div class="flex items-center gap-1">
          <span id="sliderValue" class="font-bold text-lg">4</span>
          <span id="iconGrid" class="w-4 h-4"></span>
        </div>
      </div>
    </footer>
    <script>
      // テンプレート変数をJavaScriptグローバル変数として設定（エラーハンドリング強化）
      try {
        window.USER_ID = '<?= typeof userInfo !== "undefined" && userInfo && userInfo.userId ? userInfo.userId : "" ?>';
        // UserIDデバッグログ
        console.log('🔍 Page.html: USER_ID設定確認', {
          userId: window.USER_ID,
          userIdLength: window.USER_ID?.length,
          userIdType: typeof window.USER_ID
        });
      } catch (error) {
        console.error('❌ Page.html: USER_ID設定エラー:', error);
        window.USER_ID = '';
      }
      const SHEET_NAME = '<?= typeof sheetName !== "undefined" && sheetName ? sheetName : "" ?>';
      const __OPINION_HEADER__ =
        '<?= typeof __OPINION_HEADER__ !== "undefined" && __OPINION_HEADER__ ? __OPINION_HEADER__ : "お題" ?>';

      // 管理者権限変数をグローバル設定
      window.hasAdminCapability = <?= typeof hasAdminCapability !== "undefined" && hasAdminCapability === true ? "true" : "false" ?>;
      window.isAdminUser = <?= typeof isAdminUser !== "undefined" && isAdminUser === true ? "true" : "false" ?>;

      // DISPLAY_MODES定数をフロントエンドで利用可能にする
      window.DISPLAY_MODES = Object.freeze({
        ANONYMOUS: 'anonymous',
        NAMED: 'named',
        EMAIL: 'email',
      });

      // PERFORMANCE_BUDGET定数をフロントエンドで利用可能にする
      window.PERFORMANCE_BUDGET = 16; // 60FPS = 16.67ms/frame の閾値

      // DEBUG_MODE定数をフロントエンドで利用可能にする
      window.DEBUG_MODE = false; // 本番環境ではfalse、開発時はtrueに設定

      // デバッグログ制御関数
      window.debugLog = (...args) => {
        if (window.DEBUG_MODE) {
          console.log(...args);
        }
      };
      window.debugInfo = (...args) => {
        if (window.DEBUG_MODE) {
          console.info(...args);
        }
      };

      // デバッグログ（DEBUG_MODE時のみ）
      debugLog('Template variables:', {
        USER_ID,
        SHEET_NAME,
        __OPINION_HEADER__,
        DISPLAY_MODES,
        PERFORMANCE_BUDGET,
        DEBUG_MODE,
      });
    </script>
    <?!= include('page.js.html'); ?>
  </body>
</html>
