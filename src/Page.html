<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>GenericBoard - みんなのかいとうボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <?!= include('SharedSecurityHeaders'); ?>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript><link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" /></noscript>
  <link rel="dns-prefetch" href="//script.google.com" />
  <link rel="preconnect" href="https://script.google.com" crossorigin />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
  <?!= include('SharedTailwindConfig'); ?>
  <style>
:root{--color-primary:#8be9fd;--color-primary-dark:#6272a4;--color-background:#1a1b26;--color-surface:rgba(26,27,38,0.7);--color-text:#c0caf5;--color-text-secondary:#6272a4;--color-text-muted:rgba(255,255,255,0.6);--color-border:rgba(255,255,255,0.1);--color-accent:#facc15;--color-success:#50fa7b;--color-warning:#ffb86c;--color-error:#ff5555;--duration-fast:0.2s;--duration-normal:0.3s;--duration-slow:0.5s;--ease-out:cubic-bezier(0.25,0.46,0.45,0.94);--ease-in-out:cubic-bezier(0.645,0.045,0.355,1);--border-radius:0.75rem;--border-radius-lg:1rem;--shadow-sm:0 1px 2px rgba(0,0,0,0.05);--shadow-md:0 4px 6px rgba(0,0,0,0.1);--shadow-lg:0 10px 15px rgba(0,0,0,0.1);--shadow-glow:0 0 15px var(--color-primary);--glass-bg:var(--color-surface);--glass-border:1px solid var(--color-border);--glass-blur:blur(12px);--transition-duration:0.2s;--transition-easing:ease-out;--animation-duration:0.3s;--backdrop-blur:12px}body{color:var(--color-text);background-color:var(--color-background);margin:0;overflow-x:hidden}.glass-panel{background:var(--glass-bg);-webkit-backdrop-filter:var(--glass-blur);backdrop-filter:var(--glass-blur);border:var(--glass-border);transition:border-color var(--transition-duration) var(--transition-easing)}.glass-panel:hover{border-color:rgba(255,255,255,0.2)}.interactive-element{transition:all var(--duration-fast) var(--ease-out);border-radius:var(--border-radius)}.game-font{font-family:'Press Start 2P',cursive}.game-btn{transition:all var(--duration-fast) var(--ease-out);border-radius:var(--border-radius);border-bottom-width:4px;text-shadow:1px 1px 2px rgba(0,0,0,0.4);position:relative;overflow:hidden}.game-btn:not(:disabled):hover{transform:translateY(-2px) scale(1.02);box-shadow:var(--shadow-glow)}.game-btn:active:not(:disabled){transform:translateY(2px);border-bottom-width:2px;box-shadow:none}.game-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none!important}#classFilter,#sortOrder{background-color:var(--color-primary-dark);border:var(--glass-border);color:var(--color-text);border-radius:var(--border-radius);padding:0.25rem 0.5rem;transition:border-color var(--transition-duration) var(--transition-easing),box-shadow var(--transition-duration) var(--transition-easing)}#classFilter:focus,#sortOrder:focus{border-color:rgba(6,182,212,0.5);box-shadow:0 0 0 2px rgba(6,182,212,0.2);outline:none}:focus-visible{outline:3px solid var(--color-primary);outline-offset:2px;border-radius:var(--border-radius)}header{position:sticky;top:0;z-index:50;contain:layout;-webkit-backdrop-filter:blur(var(--backdrop-blur));backdrop-filter:blur(var(--backdrop-blur))}.line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}@media (min-width:768px) and (max-width:1023px){#headingLabel{font-size:1.25rem!important}}#formAnswerBtn{transition:all 0.2s ease-out}#formAnswerBtn:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.15)}#answerCount{transition:background-color 0.2s ease-out}#answerCount:hover{background-color:rgba(55,65,81,0.5)}.answer-card{will-change:transform,opacity;transition:all var(--duration-normal) var(--ease-out);border-radius:var(--border-radius-lg);contain:layout style;position:relative;overflow:hidden}.answer-card.highlighted{border:4px solid transparent;border-image:none!important;box-shadow:0 0 15px rgba(250,204,21,0.6);transform:scale(1.02);z-index:2;background:linear-gradient(var(--glass-bg),var(--glass-bg)) padding-box,linear-gradient(90deg,var(--color-accent),var(--color-primary)) border-box;background-clip:padding-box,border-box;position:relative}.answer-card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 8px 25px rgba(139,233,253,0.3)}.answer-card:focus-visible{transform:translateY(-4px) scale(1.02);box-shadow:0 8px 25px rgba(139,233,253,0.3)}.answer-card.highlighted:hover{transform:translateY(-4px) scale(1.04)}.answer-card.loading{opacity:0.7;pointer-events:none}.reaction-btn{transition:transform var(--transition-duration) var(--transition-easing),background-color var(--transition-duration) var(--transition-easing),box-shadow var(--transition-duration) var(--transition-easing);position:relative;overflow:hidden}.reaction-btn:hover{transform:scale(1.1)}.reaction-btn:active{transform:scale(0.95)}.reaction-btn.reacted{background-color:var(--color-primary)!important;color:#000!important;box-shadow:0 0 10px rgba(139,233,253,0.5)}.reaction-btn.liked{background-color:var(--color-primary)!important;color:#000!important;box-shadow:0 0 10px rgba(139,233,253,0.5)}.reaction-btn.loading{opacity:0.6;pointer-events:none}.fade-in{animation:fadeIn 0.5s ease-out}.slide-in{animation:slideIn 0.3s ease-out}.pulse{animation:pulse 0.6s ease-out}.shake{animation:shake 0.5s ease-out}.admin-toggle{transition:background-color var(--animation-duration) var(--transition-easing);-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px)}.admin-toggle:hover{background-color:rgba(139,233,253,0.1)}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(26,27,38,0.8);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000}.spinner{width:40px;height:40px;border:4px solid rgba(139,233,253,0.3);border-top:4px solid var(--color-primary);border-radius:50%;animation:spin 1s linear infinite}@keyframes fadeIn{from{opacity:0;will-change:opacity}to{opacity:1}}@keyframes slideIn{from{opacity:0;will-change:opacity}to{opacity:1}}@keyframes pulse{0%{will-change:transform}50%{transform:scale3d(1.05,1.05,1)}100%{transform:scale3d(1,1,1)}}@keyframes shake{0%,100%{will-change:transform}25%{transform:translate3d(-5px,0,0)}75%{transform:translate3d(5px,0,0)}}@keyframes spin{100%{transform:rotate(360deg);will-change:transform}}@keyframes bounce{0%,20%,50%,80%,100%{transform:translate(-50%,0) translateY(0)}40%{transform:translate(-50%,0) translateY(-10px)}60%{transform:translate(-50%,0) translateY(-5px)}}@media (min-resolution:120dpi) and (min-width:1200px){:root{--transition-duration:0.15s;--animation-duration:0.2s}}@media (prefers-contrast:high){:root{--color-border:rgba(255,255,255,0.3);--color-surface:rgba(26,27,38,0.98)}}@media (prefers-reduced-motion:reduce){:root{--transition-duration:0.01ms;--animation-duration:0.01ms;--backdrop-blur:0px}*,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important;transform:none!important}.answer-card:hover,.reaction-btn:hover,.game-btn:hover{transform:none!important}}.highlight-badge{position:absolute;top:0.25rem;right:0.25rem;width:1.5rem;height:1.5rem;display:flex;align-items:center;justify-content:center;color:#facc15;filter:drop-shadow(0 0 4px rgba(250,204,21,0.7))}.answer-card.reaction-bg-like{border-color:#ef4444!important;border-image:none!important}.answer-card.reaction-bg-understand{border-color:#fbbf24!important;border-image:none!important}.answer-card.reaction-bg-curious{border-color:#10b981!important;border-image:none!important}.reaction-bg-like-understand,.reaction-bg-like-curious,.reaction-bg-understand-curious,.reaction-bg-all{border-color:transparent;border-style:solid;background:var(--glass-bg);border-image-slice:1;border-image-source:linear-gradient(90deg,#ef4444,#fbbf24)}.reaction-bg-like-curious{border-image-source:linear-gradient(90deg,#ef4444,#10b981)}.reaction-bg-understand-curious{border-image-source:linear-gradient(90deg,#fbbf24,#10b981)}.reaction-bg-all{border-image-source:linear-gradient(90deg,#ef4444,#fbbf24,#10b981)}.reaction-border-1{border-width:2px}.reaction-border-2{border-width:4px}.reaction-border-3{border-width:6px}.answer-preview{display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;min-height:120px}.highlight-btn{transition:all 0.2s ease;border-radius:4px;padding:2px}.highlight-btn:hover{background:rgba(250,204,21,0.1);transform:scale(1.1)}.highlight-btn.liked{color:#facc15;filter:drop-shadow(0 0 4px rgba(250,204,21,0.7))}#controlsFooter{pointer-events:none}#controlsFooter>.glass-panel{pointer-events:auto}.skeleton{position:relative;overflow:hidden;background-color:rgba(255,255,255,0.05);color:transparent}.skeleton::after{content:"";position:absolute;inset:0;background-image:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,0.3),rgba(255,255,255,0));animation:skeleton-loading 1.2s infinite}@keyframes skeleton-loading{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans">
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="text-center">
      <div class="spinner"></div>
      <p class="mt-4 text-gray-300">読み込み中...</p>
    </div>
  </div>

  <div id="main-container" class="w-full mx-auto px-4 pt-4 pb-4 md:px-6 md:pt-6 md:pb-6">
    <header id="main-header" class="glass-panel rounded-xl p-4 mb-4 flex flex-col lg:flex-row justify-between items-center gap-4 shadow-lg">
      <div class="flex items-center gap-4 w-full lg:w-auto">
        <p id="answerCount" class="text-sm text-gray-400 flex items-center gap-2 flex-shrink-0"></p>
        <label for="classFilter" class="sr-only">クラス絞り込み</label>
        <select id="classFilter" class="hidden text-sm"></select>
        <label for="sortOrder" class="sr-only">並び順</label>
        <select id="sortOrder" class="text-sm">
          <option value="newest" selected>新着順</option>
          <option value="random">ランダム順</option>
          <option value="score" id="scoreOption" style="display: none;">スコア順</option>
        </select>
      </div>
      <div class="flex-grow text-center w-full min-w-0">
        <h1 id="siteTitle" class="game-font text-yellow-300 text-lg md:text-xl mb-1">みんなの回答ボード</h1>
        <p id="headingLabel" class="text-2xl md:text-3xl font-bold text-pink-400 leading-tight flex justify-center">
          <svg class="w-6 h-6 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
          </svg>
        </p>
      </div>
      <div class="w-full lg:w-auto lg:min-w-[150px] text-right space-y-1">
        <p id="sheetNameText" class="text-xs text-gray-400 h-4"></p>
        <p id="modeLabel" class="text-xs text-gray-400"></p>
        <button type="button" id="adminToggleBtn" class="text-xs text-cyan-400 underline hidden" hidden aria-label="管理者モード切り替え"></button>
      </div>
    </header>

    <main id="answers" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" role="main" aria-live="polite" aria-label="回答一覧"></main>
  </div>
  
  <div id="answerModalContainer" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300" role="dialog" aria-modal="true">
    <div id="answerModalCard" class="glass-panel rounded-xl p-6 flex flex-col shadow-2xl border-2 border-cyan-400/80 w-full max-w-5xl h-auto max-h-[85vh] transform scale-95 transition-transform duration-300" role="document" aria-labelledby="modalAnswer">
      <button id="answerModalCloseBtn" class="absolute -top-3 -right-3 bg-red-600 rounded-full p-2 text-white hover:scale-110 transition-transform" aria-label="閉じる"></button>
      <div id="modalAnswer" class="flex-grow min-h-[200px] mb-4 overflow-y-auto pr-4"></div>
      <div id="modalFooter" class="text-xs text-gray-400 pt-4 border-t-2 border-dashed border-cyan-400/80 flex justify-between items-center">
        <div><span id="modalStudentName" class="font-bold text-2xl text-gray-200"></span></div>
        <div id="modalReactions" class="flex items-center gap-2"></div>
      </div>
    </div>
  </div>

  <div id="infoModalContainer" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300" role="dialog" aria-modal="true">
    <div id="infoModalCard" class="glass-panel rounded-xl p-6 shadow-2xl border-2 border-cyan-400/80 w-full max-w-lg transform scale-95 transition-transform duration-300 relative" role="document">
      <div class="space-y-4 text-gray-200 text-lg leading-relaxed">
        <p>みんなの意見を気持ちよく共有するために、リアクションのしかたをおぼえよう！</p>
        <ul class="space-y-2">
          <li class="flex items-center gap-2"><span id="infoIconLike" class="w-5 h-5 text-red-400"></span>いいね：すてきだと思ったときに押そう</li>
          <li class="flex items-center gap-2"><span id="infoIconUnderstand" class="w-5 h-5 text-yellow-400"></span>なるほど：参考になったときに押そう</li>
          <li class="flex items-center gap-2"><span id="infoIconCurious" class="w-5 h-5 text-green-400"></span>きになる：もっと知りたいときに押そう</li>
        </ul>
        <p class="flex items-center gap-2"><span id="infoIconHighlight" class="w-5 h-5 text-yellow-300"></span>先生が注目してほしい意見につけています</p>
        <p>責任あるリアクションで、みんなで学びを深めよう！</p>
        <div class="text-center mt-6">
          <button id="infoModalConfirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">わかった</button>
        </div>
      </div>
    </div>
  </div>

  <footer id="controlsFooter" class="fixed bottom-0 left-0 right-0 z-40 p-4">
    <div class="glass-panel max-w-md mx-auto rounded-xl p-3 flex items-center justify-center gap-3">
      <input type="range" id="sizeSlider" min="2" max="6" value="4" class="w-1/2" aria-label="表示列数の変更">
      <div class="flex items-center gap-1">
        <span id="sliderValue" class="font-bold text-lg">4</span>
        <span id="footerIcon" class="w-4 h-4"></span>
      </div>
      <button type="button" id="modeToggleBtn" class="ml-4 px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm" title="プレビューモード切り替え">切替</button>
    </div>
  </footer>

  <script>
    // サーバーからの変数をJavaScriptの定数として利用（プレビューでは無視）
    // プレビューモードでは以下の変数は未定義になるが、window変数から参照
    let showAdminFeatures, showHighlightToggle, isAdminUser;
    try {
      // GAS環境でのみ実行される（プレビューではエラーになるが無視）
      showAdminFeatures = window.showAdminFeatures;
      showHighlightToggle = window.showHighlightToggle;
      isAdminUser = !window.isStudentMode;
    } catch (e) {
      // プレビューモードでは無視
    }
    
    // SVGアイコンの定義
    const ICONS = {
      'lightbulb-outline': '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6zM9 16.5h6v4H9v-4zm0 1h6zm0 1h6zM10.5 11l.5 2h2l.5-2m-3 1h3"/></svg>',
      'lightbulb-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6z M10.5 11.25 L11 13 L13 13 L13.5 11.25 H 10.5 Z"/><path d="M9 16.5h6v1H9z M9 18h6v1H9z M9 19.5h6v1H9z"/></svg>',
      'hand-thumb-up-outline': '<svg fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.338 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>',
      'hand-thumb-up-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z M6.5 10v12h1V10h-1z"/></svg>',
      'magnifying-glass-plus-outline': '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6"/></svg>',
      'magnifying-glass-plus-solid': '<svg viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z M9.75 7.5v2.25H7.5v1.5h2.25V13.5h1.5v-2.25H13.5v-1.5h-2.25V7.5h-1.5z" fill="currentColor"/><path d="M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15zM16.5 16.5l4.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
      'x': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
      'star-outline': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 8.5 22 9.3 17 14 18.2 21 12 17.8 5.8 21 7 14 2 9.3 9 8.5 12 2"/></svg>',
      'star-solid': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 8.5 22 9.3 17 14 18.2 21 12 17.8 5.8 21 7 14 2 9.3 9 8.5 12 2"/></svg>',
      'star': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 8.5 22 9.3 17 14 18.2 21 12 17.8 5.8 21 7 14 2 9.3 9 8.5 12 2"/></svg>',
      'grid-2x2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 12h18"/><path d="M12 3v18"/></svg>',
      'users': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>'
    };

    class GenericBoardApp {
      constructor() {
        // UI要素への参照を格納
        this.elements = {
          answersContainer: document.getElementById('answers'),
          sizeSlider: document.getElementById('sizeSlider'),
          sliderValue: document.getElementById('sliderValue'),
          headingLabel: document.getElementById('headingLabel'),
          sheetNameText: document.getElementById('sheetNameText'),
          modeLabel: document.getElementById('modeLabel'),
          adminToggleBtn: document.getElementById('adminToggleBtn'),
          answerCount: document.getElementById('answerCount'),
          answerModalContainer: document.getElementById('answerModalContainer'),
          answerModalCloseBtn: document.getElementById('answerModalCloseBtn'),
          answerModalCard: document.getElementById('answerModalCard'),
          modalAnswer: document.getElementById('modalAnswer'),
          modalStudentName: document.getElementById('modalStudentName'),
          modalReactionContainer: document.getElementById('modalReactions'),
          classFilter: document.getElementById('classFilter'),
          sortOrder: document.getElementById('sortOrder'),
          scoreOption: document.getElementById('scoreOption'),
          infoModalContainer: document.getElementById('infoModalContainer'),
          infoModalConfirmBtn: document.getElementById('infoModalConfirmBtn'),
          infoIconLike: document.getElementById('infoIconLike'),
          infoIconUnderstand: document.getElementById('infoIconUnderstand'),
          infoIconCurious: document.getElementById('infoIconCurious'),
          infoIconHighlight: document.getElementById('infoIconHighlight'),
          footerIcon: document.getElementById('footerIcon'),
          modeToggleBtn: document.getElementById('modeToggleBtn')
        };

        // アプリケーションの状態管理
        this.state = {
          currentAnswers: [],
          isLoading: false,
          lastFocusedElement: null
        };

        this.handlers = {}; // イベントハンドラ参照用

        // リアクションの種類とアイコンのマッピング
        this.reactionTypes = [
          { key: 'LIKE', icon: 'hand-thumb-up' },
          { key: 'UNDERSTAND', icon: 'lightbulb' },
          { key: 'CURIOUS', icon: 'magnifying-glass-plus' }
        ];
        
        this.init();
      }

      /**
       * アプリケーションの初期化処理
       */
      init() {
        this.renderIcons(); // アイコンのレンダリング
        this.setupEventListeners(); // イベントリスナーの設定
        this.loadInitialData(); // 初期データのロード
      }

      /**
       * イベントリスナーの設定
       */
      setupEventListeners() {
        // スライダーの変更
        this.handlers.onSizeSliderInput = () => {
          localStorage.setItem('boardColumns', this.elements.sizeSlider.value);
          this.renderBoard();
        };
        this.elements.sizeSlider.addEventListener('input', this.handlers.onSizeSliderInput);

        // クラスフィルターとソート順の変更
        this.handlers.onSortOrderChange = () => this.loadSheetData();
        this.elements.sortOrder.addEventListener('change', this.handlers.onSortOrderChange);

        // モーダルの閉じるボタン
        this.handlers.onAnswerModalCloseClick = () => this.hideAnswerModal();
        this.elements.answerModalCloseBtn.addEventListener('click', this.handlers.onAnswerModalCloseClick);
        
        // 保存された列数をローカルストレージからロード
        const savedCols = localStorage.getItem('boardColumns');
        if (savedCols && this.elements.sizeSlider && this.elements.sliderValue) {
          this.elements.sizeSlider.value = savedCols;
          this.elements.sliderValue.textContent = savedCols;
        }
      }

      /**
       * Google Apps Script関数を実行
       */
      runGas(funcName, ...args) {
        return new Promise((resolve, reject) => {
          // Google Apps Script環境で実行されているかチェック
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              [funcName](...args);
          } else {
            // GAS環境がない場合は、デバッグ用のモックデータを使用
            console.warn('Google Apps Script environment not detected. Using mock data.');
            this.getMockData(funcName, ...args).then(resolve).catch(reject);
          }
        });
      }

      /**
       * デバッグ用のモックデータを生成
       */
      getMockData(funcName, ...args) {
        return new Promise((resolve) => {
          setTimeout(() => {
            if (funcName === 'getPublishedSheetData') {
              resolve({
                header: 'テスト問題',
                sheetName: 'テストシート',
                rows: [
                  {
                    rowIndex: 1,
                    name: '田中太郎',
                    class: '3年A組',
                    opinion: 'これは素晴らしいアイデアだと思います。',
                    reason: '理由は簡潔で分かりやすく、実現可能性が高いからです。',
                    reactions: {
                      UNDERSTAND: { count: 5, reacted: false },
                      LIKE: { count: 2, reacted: false },
                      CURIOUS: { count: 1, reacted: false }
                    },
                    highlight: false
                  }
                ]
              });
            }
          }, 500);
        });
      }

      /**
       * 初期データをロード
       */
      async loadInitialData() {
        await this.loadSheetData();
      }

      /**
       * スプレッドシートデータをロード
       */
      async loadSheetData() {
        if (this.state.isLoading) return;
        this.state.isLoading = true;
        
        try {
          const selectedClass = 'すべて';
          const sortOrder = this.elements.sortOrder.value;
          const data = await this.runGas('getPublishedSheetData', selectedClass, sortOrder);
          
          this.state.currentAnswers = data.rows || [];
          this.elements.headingLabel.textContent = this.escapeHtml(data.header || '問題');
          
          if (this.elements.sheetNameText) {
            this.elements.sheetNameText.textContent = 'シート: ' + this.escapeHtml(data.sheetName || '不明');
          }
          
          this.renderBoard();
        } catch (error) {
          console.error('Error loading sheet data:', error);
          this.showError(error.message || 'データの読み込みに失敗しました');
        } finally {
          this.state.isLoading = false;
        }
      }

      /**
       * 回答ボードをレンダリング
       */
      renderBoard() {
        const container = this.elements.answersContainer;
        const newRows = this.state.currentAnswers;
        
        this.elements.sliderValue.textContent = this.elements.sizeSlider.value;
        // グリッド列数を更新
        container.className = 'grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-' + this.elements.sizeSlider.value;
        
        // 回答数表示の更新
        const userIcon = this.getIcon('users', 'w-4 h-4 inline-block -mt-1');
        this.elements.answerCount.innerHTML = userIcon + '<span>' + newRows.length + '件</span>';
        
        if (newRows.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-500 col-span-full mt-8">回答はありません。</p>';
        } else {
          const fragment = document.createDocumentFragment();
          newRows.forEach((row) => {
            const card = this.createAnswerCard(row);
            fragment.appendChild(card);
          });
          container.innerHTML = '';
          container.appendChild(fragment);
        }
      }

      /**
       * 回答カード要素を生成
       */
      createAnswerCard(data) {
        const card = document.createElement('div');
        const highlightClass = data.highlight ? ' highlighted' : '';
        card.className = 'relative answer-card glass-panel rounded-xl p-4 flex flex-col justify-between shadow-lg border-2 border-cyan-400/80 cursor-pointer' + highlightClass;
        card.dataset.rowIndex = data.rowIndex;
        card.setAttribute('role', 'article');
        card.setAttribute('tabindex', '0');

        const nameHtml = data.name ? '<div><span class="font-bold text-sm text-gray-200">' + this.escapeHtml(data.name) + '</span></div>' : '';
        const containerClass = nameHtml ? 'text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex justify-between items-center' : 'text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex justify-end items-center';

        // リアクションボタンのHTMLを生成
        const reactionButtonsHtml = this.reactionTypes.map(rt => {
          const info = data.reactions ? data.reactions[rt.key] : { count: 0, reacted: false };
          const cls = info.reacted ? 'liked' : '';
          const colorClass = rt.key === 'LIKE' ? 'text-red-500' : rt.key === 'UNDERSTAND' ? 'text-yellow-500' : 'text-green-500';
          
          return '<button type="button" class="reaction-btn like-btn flex items-center gap-1 ' + colorClass + ' ' + cls + '" data-row-index="' + data.rowIndex + '" data-reaction="' + rt.key + '">' +
                   this.getIcon(rt.icon, 'w-5 h-5', info.reacted) +
                   '</button>';
        }).join('');
        
        card.innerHTML =
          '<div class="relative flex-grow mb-3 answer-preview">' +
          '<h3 class="opinion-text text-cyan-200 whitespace-pre-wrap break-words text-xl md:text-2xl font-semibold leading-tight">' +
          this.escapeHtml(data.opinion || '') + '</h3>' +
          '<p class="text-gray-100 whitespace-pre-wrap break-words mt-4">' +
          this.escapeHtml(data.reason || '') + '</p>' +
          '</div>' +
          '<div class="' + containerClass + '">' +
          nameHtml + 
          '<div class="flex items-center gap-1" role="group">' +
          reactionButtonsHtml +
          '</div>' +
          '</div>';

        // ハイライトバッジを動的に追加
        if (data.highlight) {
          const badge = document.createElement('span');
          badge.className = 'highlight-badge';
          badge.innerHTML = this.getIcon('star', '', true);
          card.appendChild(badge);
        }
        
        return card;
      }

      /**
       * エラー表示
       */
      showError(message) {
        if (!this.elements.answersContainer) return;
        
        this.elements.answersContainer.innerHTML =
          '<div class="text-center text-red-400 col-span-full mt-8 p-4 bg-red-900/20 rounded-lg">' +
          '<p class="font-bold">データの読み込みに失敗しました。</p>' +
          '<p class="text-sm mt-2">' + this.escapeHtml(message) + '</p>' +
          '</div>';
      }

      /**
       * 回答モーダルを非表示
       */
      hideAnswerModal() {
        this.elements.answerModalContainer.classList.add('hidden');
      }

      /**
       * SVGアイコンのHTML文字列を取得
       */
      getIcon(name, classes = '', solid = false) {
        // アイコンキーの優先順位: solid版 > outline版 > プレーン版
        let key;
        if (solid && ICONS[name + '-solid']) {
          key = name + '-solid';
        } else if (ICONS[name + '-outline']) {
          key = name + '-outline';
        } else if (ICONS[name]) {
          key = name;
        } else {
          console.warn('Icon not found:', name);
          return '<span aria-hidden="true" class="' + classes + '">⭐</span>'; // フォールバック
        }
        // 存在するアイコンを返す
        return '<span aria-hidden="true" class="' + classes + '">' + ICONS[key] + '</span>';
      }
      
      /**
       * 主要なアイコンをレンダリング（初期設定）
       */
      renderIcons() {
        this.elements.answerModalCloseBtn.innerHTML = this.getIcon('x', 'w-6 h-6');
        this.elements.footerIcon.innerHTML = this.getIcon('grid-2x2');
        if (this.elements.infoIconLike) {
          this.elements.infoIconLike.innerHTML = this.getIcon('hand-thumb-up');
        }
        if (this.elements.infoIconUnderstand) {
          this.elements.infoIconUnderstand.innerHTML = this.getIcon('lightbulb');
        }
        if (this.elements.infoIconCurious) {
          this.elements.infoIconCurious.innerHTML = this.getIcon('magnifying-glass-plus');
        }
        if (this.elements.infoIconHighlight) {
          this.elements.infoIconHighlight.innerHTML = this.getIcon('star');
        }
      }

      /**
       * HTMLエスケープ処理
       */
      escapeHtml(str) {
        if (!str) return '';
        return str.toString()
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }
    }
    
    // アプリケーションインスタンスを作成
    try {
      if (window.genericBoardApp && typeof window.genericBoardApp.destroy === 'function') {
        window.genericBoardApp.destroy();
      }
      window.genericBoardApp = new GenericBoardApp();
    } catch (error) {
      console.error('Error creating GenericBoardApp instance:', error);
      
      // エラー時の緊急表示
      const container = document.getElementById('answers');
      if (container) {
        container.innerHTML = '<div class="text-red-400 p-4">アプリケーションの初期化に失敗しました: ' + error.message + '</div>';
      }
    }
  </script>
</body>
</html>