<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>StudyQuest - みんなのかいとうボード</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
const __SHOW_COUNTS__ = '<?= showCounts ?>';
const __DISPLAY_MODE__ = '<?= displayMode ?>';
const __SHEET_NAME__ = '<?= sheetName ?>';
const __MAPPING__ = '<?= JSON.stringify(mapping) ?>';
const __USER_ID__ = '<?= userId ?>';
const __OWNER_NAME__ = '<?= ownerName ?>';
const __SHOW_ADMIN_FEATURES__ = '<?= showAdminFeatures ?>';
const __SHOW_HIGHLIGHT_TOGGLE__ = '<?= showHighlightToggle ?>';
const __IS_ADMIN_USER__ = '<?= isAdminUser ?>';
window.showCounts = __SHOW_COUNTS__.startsWith('<') ? false : __SHOW_COUNTS__ === 'true';
window.displayMode = __DISPLAY_MODE__.startsWith('<') ? 'anonymous' : __DISPLAY_MODE__;
window.showAdminFeatures = __SHOW_ADMIN_FEATURES__.startsWith('<') ? false : __SHOW_ADMIN_FEATURES__ === 'true';
window.showHighlightToggle = __SHOW_HIGHLIGHT_TOGGLE__.startsWith('<') ? false : __SHOW_HIGHLIGHT_TOGGLE__ === 'true';
window.isAdminUser = __IS_ADMIN_USER__.startsWith('<') ? false : __IS_ADMIN_USER__ === 'true';
const SHEET_NAME = __SHEET_NAME__.startsWith('<') ? 'テストシート' : __SHEET_NAME__;
const USER_ID = __USER_ID__.startsWith('<') ? '' : __USER_ID__;
const OWNER_NAME = __OWNER_NAME__.startsWith('<') ? '' : __OWNER_NAME__;
let MAPPING;
try {
  MAPPING = __MAPPING__.startsWith('<') ? {} : JSON.parse(__MAPPING__);
} catch (e) {
  MAPPING = {};
}
</script>
<style>
:root {
  --color-primary: #8be9fd;
  --color-background: #1a1b26;
  --color-surface: rgba(26, 27, 38, 0.95);
  --color-text: #c0caf5;
  --color-border: rgba(255, 255, 255, 0.1);
  --color-accent: #facc15;
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.15);
}
body {
  color: var(--color-text);
  background-color: var(--color-background);
  margin: 0;
}
.glass-panel { 
  background: var(--color-surface);
  border: 1px solid var(--color-border);
}
.game-font {
  font-family: 'Press Start 2P', cursive;
}
.game-btn {
  transition: transform 0.15s ease-out;
  border-radius: 0.75rem;
  border-bottom-width: 4px;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
}
.game-btn:not(:disabled):hover { 
  transform: translateY(-2px); 
}
.game-btn:active:not(:disabled) { 
  transform: translateY(2px); 
  border-bottom-width: 2px; 
}
#classFilter, #sortOrder { 
  background-color: #6272a4; 
  border: 1px solid var(--color-border); 
  color: var(--color-text); 
  border-radius: 0.75rem; 
  padding: 0.25rem 0.5rem; 
}
:focus-visible { 
  outline: 3px solid var(--color-primary); 
  outline-offset: 2px; 
  border-radius: 0.75rem; 
}
header { position: sticky; top: 0; z-index: 5; }
.answer-card { 
  will-change: transform;
  transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
  border-radius: 1rem;
}
.answer-card.highlighted {
  border: 4px solid var(--color-accent) !important;
  box-shadow: 0 0 10px rgba(250,204,21,0.4);
}
.answer-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}
.answer-card.new-card {
  animation: fadeIn 0.3s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.highlight-badge {
  position: absolute;
  top: 0.25rem;
  right: 0.25rem;
  width: 1.5rem;
  height: 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #facc15;
}
.answer-card.reaction-bg-like { border-color:#ef4444 !important; }
.answer-card.reaction-bg-understand { border-color:#fbbf24 !important; }
.answer-card.reaction-bg-curious { border-color:#10b981 !important; }
.reaction-border-1 { border-width: 2px; }
.reaction-border-2 { border-width: 4px; }
.reaction-border-3 { border-width: 6px; }
.answer-preview { display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: 120px; }
.like-btn svg { transition: all 0.15s ease-in-out; fill: none; }
.like-btn.liked svg { stroke: transparent; fill: currentColor; transform: scale(1.1); }
.highlight-btn { transition: all 0.15s ease; border-radius: 4px; padding: 2px; }
.highlight-btn:hover { background: rgba(250, 204, 21, 0.1); transform: scale(1.1); }
.highlight-btn.liked { color: #facc15; }
#controlsFooter { pointer-events: none; }
#controlsFooter > .glass-panel { pointer-events: auto; }
.skeleton { position: relative; overflow: hidden; background-color: rgba(255,255,255,0.05); }
.skeleton::after { content: ""; position: absolute; inset: 0; background-image: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.2), rgba(255,255,255,0)); animation: skeleton-loading 1.5s infinite; }
@keyframes skeleton-loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
.modal-fade { animation: modalFade 0.2s ease-out; }
@keyframes modalFade { from { opacity: 0; } to { opacity: 1; } }
.modal-scale { animation: modalScale 0.2s ease-out; }
@keyframes modalScale { from { transform: scale(0.95); } to { transform: scale(1); } }
</style>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans">
<div id="main-container" class="w-full mx-auto px-4 pt-4 pb-4 md:px-6 md:pt-6 md:pb-6">
<header id="main-header" class="glass-panel rounded-xl p-4 mb-4 flex flex-col lg:flex-row justify-between items-center gap-4 shadow-lg">
<div class="flex items-center gap-4 w-full lg:w-auto">
<p id="answerCount" class="text-sm text-gray-400 flex items-center gap-2 flex-shrink-0"></p>
<label for="classFilter" class="sr-only">クラス絞り込み</label>
<select id="classFilter" class="hidden text-sm"></select>
<label for="sortOrder" class="sr-only">並び順</label>
<select id="sortOrder" class="text-sm">
<option value="newest" selected>新着順</option>
<option value="random">ランダム順</option>
<option value="score" id="scoreOption" style="display: none;">スコア順</option>
</select>
</div>
<div class="flex-grow text-center w-full min-w-0">
<h1 id="siteTitle" class="game-font text-yellow-300 text-lg md:text-xl mb-1">みんなの回答ボード</h1>
<p id="headingLabel" class="text-2xl md:text-3xl font-bold text-pink-400 leading-tight flex justify-center">
<svg class="w-6 h-6 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
<path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
</svg>
</p>
</div>
<div class="w-full lg:w-auto lg:min-w-[150px] text-right space-y-1">
<p id="ownerNameText" class="text-xs text-gray-500 h-4"></p>
<p id="sheetNameText" class="text-xs text-gray-400 h-4"></p>
<p id="modeLabel" class="text-xs text-gray-400"></p>
<div class="flex justify-end gap-2">
<button type="button" id="endPublicationBtn" class="text-xs bg-orange-600 hover:bg-orange-700 text-white px-2 py-1 rounded hidden" hidden aria-label="公開終了">公開終了</button>
<button type="button" id="adminPanelBtn" class="text-xs bg-cyan-600 hover:bg-cyan-700 text-white px-2 py-1 rounded hidden" hidden aria-label="管理画面を開く">管理画面</button>
<button type="button" id="adminToggleBtn" class="text-xs text-cyan-400 underline hidden" hidden aria-label="管理者モード切り替え"></button>
<button type="button" id="adminEndBtn" class="text-xs bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded hidden" hidden aria-label="管理モード終了">管理終了</button>
</div>
</div>
</header>
<main id="answers" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" role="main" aria-live="polite" aria-label="回答一覧"></main>
</div>
<div id="answerModalContainer" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true">
<div id="answerModalCard" class="glass-panel rounded-xl p-6 flex flex-col shadow-2xl border-2 border-cyan-400/80 w-full max-w-5xl h-auto max-h-[85vh] relative" role="document" aria-labelledby="modalAnswer">
<button type="button" id="answerModalCloseBtn" class="absolute top-2 right-2 bg-red-600 rounded-full p-2 text-white hover:scale-110 transition-transform" aria-label="閉じる">
  <span id="iconClose" class="w-6 h-6"></span>
</button>
<div id="modalAnswer" class="flex-grow min-h-[200px] mb-4 overflow-y-auto pr-4"></div>
<div id="modalFooter" class="text-xs text-gray-400 pt-4 border-t-2 border-dashed border-cyan-400/80 flex justify-between items-center">
<div><span id="modalStudentName" class="font-bold text-2xl text-gray-200"></span></div>
<div id="modalReactions" class="flex items-center gap-2"></div>
</div>
</div>
</div>
<div id="infoModalContainer" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true">
<div id="infoModalCard" class="glass-panel rounded-xl p-6 shadow-2xl border-2 border-cyan-400/80 w-full max-w-lg relative" role="document">
<div class="space-y-4 text-gray-200 text-lg leading-relaxed">
<p>みんなの意見を気持ちよく共有するために、リアクションのしかたをおぼえよう！</p>
<ul class="space-y-2">
<li class="flex items-center gap-2"><span id="infoIconLike" class="w-5 h-5 text-red-400"></span>いいね：すてきだと思ったときに押そう</li>
<li class="flex items-center gap-2"><span id="infoIconUnderstand" class="w-5 h-5 text-yellow-400"></span>なるほど：参考になったときに押そう</li>
<li class="flex items-center gap-2"><span id="infoIconCurious" class="w-5 h-5 text-green-400"></span>きになる：もっと知りたいときに押そう</li>
</ul>
<p class="flex items-center gap-2"><span id="infoIconHighlight" class="w-5 h-5 text-yellow-300"></span>先生が注目してほしい意見につけています</p>
<p>責任あるリアクションで、みんなで学びを深めよう！</p>
<div class="text-center mt-6">
<button id="infoModalConfirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">わかった</button>
</div>
</div>
</div>
</div>
<footer id="controlsFooter" class="fixed bottom-0 left-0 right-0 z-40 p-4">
<div class="glass-panel max-w-md mx-auto rounded-xl p-3 flex items-center justify-center gap-3">
<input type="range" id="sizeSlider" min="2" max="6" value="4" class="w-1/2" aria-label="表示列数の変更">
<div class="flex items-center gap-1">
<span id="sliderValue" class="font-bold text-lg">4</span>
<span id="iconGrid" class="w-4 h-4"></span>
</div>
</div>
</footer>
<script>
const ICONS = {
  'lightbulb-outline': '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6zM9 16.5h6v4H9v-4zm0 1h6zm0 1h6zM10.5 11l.5 2h2l.5-2m-3 1h3"/></svg>',
  'lightbulb-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6z M10.5 11.25 L11 13 L13 13 L13.5 11.25 H 10.5 Z"/><path d="M9 16.5h6v1H9z M9 18h6v1H9z M9 19.5h6v1H9z"/></svg>',
  'hand-thumb-up-outline': '<svg fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.338 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>',
  'hand-thumb-up-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z M6.5 10v12h1V10h-1z"/></svg>',
  'magnifying-glass-plus-outline': '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6"/></svg>',
  'magnifying-glass-plus-solid': '<svg viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z M9.75 7.5v2.25H7.5v1.5h2.25V13.5h1.5v-2.25H13.5v-1.5h-2.25V7.5h-1.5z" fill="currentColor"/><path d="M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15zM16.5 16.5l4.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
  'x': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
  'star-outline': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 8.5 22 9.3 17 14 18.2 21 12 17.8 5.8 21 7 14 2 9.3 9 8.5 12 2"/></svg>',
  'star-solid': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 8.5 22 9.3 17 14 18.2 21 12 17.8 5.8 21 7 14 2 9.3 9 8.5 12 2"/></svg>',
  'star': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 8.5 22 9.3 17 14 18.2 21 12 17.8 5.8 21 7 14 2 9.3 9 8.5 12 2"/></svg>',
  'grid-2x2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 12h18"/><path d="M12 3v18"/></svg>',
  'users': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>'
};
class StudyQuestApp {
  constructor() {
    this.simpleCache = new Map();
    this.elements = {
      body: document.body,
      mainContainer: document.getElementById('main-container'),
      answersContainer: document.getElementById('answers'),
      sizeSlider: document.getElementById('sizeSlider'),
      sliderValue: document.getElementById('sliderValue'),
      headingLabel: document.getElementById('headingLabel'),
      sheetNameText: document.getElementById('sheetNameText'),
      modeLabel: document.getElementById('modeLabel'),
      endPublicationBtn: document.getElementById('endPublicationBtn'),
      adminPanelBtn: document.getElementById('adminPanelBtn'),
      adminToggleBtn: document.getElementById('adminToggleBtn'),
      adminEndBtn: document.getElementById('adminEndBtn'),
      ownerNameText: document.getElementById('ownerNameText'),
      answerCount: document.getElementById('answerCount'),
      answerModalContainer: document.getElementById('answerModalContainer'),
      answerModalCloseBtn: document.getElementById('answerModalCloseBtn'),
      answerModalCard: document.getElementById('answerModalCard'),
      modalAnswer: document.getElementById('modalAnswer'),
      modalStudentName: document.getElementById('modalStudentName'),
      modalReactionContainer: document.getElementById('modalReactions'),
      modalFooter: document.getElementById('modalFooter'),
      infoModalContainer: document.getElementById('infoModalContainer'),
      infoModalCard: document.getElementById('infoModalCard'),
      infoModalConfirmBtn: document.getElementById('infoModalConfirmBtn'),
      infoIconLike: document.getElementById('infoIconLike'),
      infoIconUnderstand: document.getElementById('infoIconUnderstand'),
      infoIconCurious: document.getElementById('infoIconCurious'),
      infoIconHighlight: document.getElementById('infoIconHighlight'),
      iconClose: document.getElementById('iconClose'),
      iconGrid: document.getElementById('iconGrid'),
      classFilter: document.getElementById('classFilter'),
      sortOrder: document.getElementById('sortOrder'),
      scoreOption: document.getElementById('scoreOption'),
      footer: document.getElementById('controlsFooter')
    };
    if (this.elements.modeLabel) {
      this.elements.modeLabel.textContent = window.showAdminFeatures ? '管理モード' : '閲覧モード';
    }
    this.state = {
      currentAnswers: [],
      isLoading: false,
      lastFocusedElement: null,
      isStudentMode: window.isStudentMode,
      showCounts: window.showCounts,
      showAdminFeatures: window.showAdminFeatures,
      showHighlightToggle: window.showHighlightToggle,
      showScoreSort: window.showScoreSort,
      displayMode: window.displayMode,
      sheetName: SHEET_NAME
    };
    this.serverShowDetails = window.showCounts;
    this.pollingInterval = null;
    this.handlers = {};
    this.reactionTypes = [
      { key: 'LIKE', icon: 'hand-thumb-up' },
      { key: 'UNDERSTAND', icon: 'lightbulb' },
      { key: 'CURIOUS', icon: 'magnifying-glass-plus' }
    ];
    this.gas = {
      getPublishedSheetData: (sheetName, classFilter, sort) => this.runGas('getPublishedSheetData', sheetName, classFilter, sort),
      getAvailableSheets: () => this.runGas('getAvailableSheets'),
      addReaction: (rowIndex, reaction) => this.runGas('addReaction', rowIndex, reaction, this.state.sheetName),
      toggleHighlight: (rowIndex, current) => this.runGas('toggleHighlight', rowIndex, this.state.sheetName, current),
      checkAdmin: () => this.runGas('checkAdmin')
    };
    const savedCols = localStorage.getItem('boardColumns');
    if (savedCols && this.elements.sizeSlider && this.elements.sliderValue) {
      this.elements.sizeSlider.value = savedCols;
      this.elements.sliderValue.textContent = savedCols;
    }
    this.init();
  }
  init() {
    this.renderIcons();
    this.setupEventListeners();
    this.setupOwnerName();
    this.verifyAdmin();
    this.adjustLayout();
    this.loadInitialData();
    this.updateSortOptions();
    if (!localStorage.getItem('introSeen')) {
      this.showInfoModal();
    }
  }
  setupOwnerName() {
    if (OWNER_NAME && this.elements.ownerNameText) {
      this.elements.ownerNameText.textContent = `管理者: ${OWNER_NAME}`;
    }
  }
  setupEventListeners() {
    const debouncedRender = this.debounce(() => this.renderBoard(true), 200);
    this.handlers.onSizeSliderInput = () => {
      localStorage.setItem('boardColumns', this.elements.sizeSlider.value);
      debouncedRender();
    };
    if (this.elements.sizeSlider) {
      this.elements.sizeSlider.addEventListener('input', this.handlers.onSizeSliderInput);
    }
    this.setupEventDelegation();
    this.handlers.onAnswerModalCloseClick = () => this.hideAnswerModal();
    if (this.elements.answerModalCloseBtn) {
      this.elements.answerModalCloseBtn.addEventListener('click', this.handlers.onAnswerModalCloseClick);
    }
    this.handlers.onAnswerModalContainerClick = (e) => {
      if (e.target === e.currentTarget) {
        this.hideAnswerModal();
      }
    };
    if (this.elements.answerModalContainer) {
      this.elements.answerModalContainer.addEventListener('click', this.handlers.onAnswerModalContainerClick);
    }
    if (this.elements.infoModalConfirmBtn) {
      this.handlers.onInfoModalConfirmClick = () => this.hideInfoModal();
      this.elements.infoModalConfirmBtn.addEventListener('click', this.handlers.onInfoModalConfirmClick);
    }
    this.handlers.onModalReactionClick = (e) => {
      const btn = e.target.closest('.reaction-btn');
      if (btn) {
        const id = btn.dataset.rowIndex;
        const reaction = btn.dataset.reaction;
        if (id && reaction) {
          this.handleReaction(id, reaction);
        }
      }
    };
    if (this.elements.modalReactionContainer) {
      this.elements.modalReactionContainer.addEventListener('click', this.handlers.onModalReactionClick);
    }
    this.handlers.onSheetSelectorChange = () => this.switchSheet();
    this.handlers.onClassFilterChange = () => this.loadSheetData(true);
    this.handlers.onSortOrderChange = () => this.loadSheetData(true);
    if (this.elements.sheetSelector) {
      this.elements.sheetSelector.addEventListener('change', this.handlers.onSheetSelectorChange);
    }
    if (this.elements.classFilter) {
      this.elements.classFilter.addEventListener('change', this.handlers.onClassFilterChange);
    }
    if (this.elements.sortOrder) {
      this.elements.sortOrder.addEventListener('change', this.handlers.onSortOrderChange);
    }
    if (this.elements.endPublicationBtn) {
      this.handlers.onEndPublicationClick = () => this.endPublication();
      this.elements.endPublicationBtn.addEventListener('click', this.handlers.onEndPublicationClick);
    }
    if (this.elements.adminPanelBtn) {
      this.handlers.onAdminPanelClick = () => this.openAdminPanel();
      this.elements.adminPanelBtn.addEventListener('click', this.handlers.onAdminPanelClick);
    }
    if (this.elements.adminToggleBtn) {
      this.handlers.onAdminToggleClick = () => this.toggleAdminMode();
      this.elements.adminToggleBtn.addEventListener('click', this.handlers.onAdminToggleClick);
    }
    if (this.elements.adminEndBtn) {
      this.handlers.onAdminEndClick = () => this.endAdminMode();
      this.elements.adminEndBtn.addEventListener('click', this.handlers.onAdminEndClick);
    }
    this.handlers.onDocumentKeydown = (e) => {
      if (e.key === 'Escape') {
        this.hideAnswerModal();
      }
    };
    document.addEventListener('keydown', this.handlers.onDocumentKeydown);
    this.handlers.onWindowResize = this.debounce(() => this.adjustLayout(), 100);
    window.addEventListener('resize', this.handlers.onWindowResize);
    this.handlers.onVisibilityChange = () => {
      if (document.hidden) {
        this.stopPolling();
      } else {
        this.startPolling();
      }
    };
    document.addEventListener('visibilitychange', this.handlers.onVisibilityChange);
  }
  setupEventDelegation() {
    this.handlers.onAnswersContainerClick = (e) => {
      const answerCard = e.target.closest('.answer-card');
      if (!answerCard) return;
      const rowIndex = answerCard.dataset.rowIndex;
      if (!rowIndex) return;
      const reactionBtn = e.target.closest('.reaction-btn');
      if (reactionBtn) {
        e.stopPropagation();
        const reactionType = reactionBtn.dataset.reaction;
        if (reactionType) {
          this.handleReaction(rowIndex, reactionType);
        }
        return;
      }
      const highlightBtn = e.target.closest('.highlight-btn');
      if (highlightBtn) {
        e.stopPropagation();
        this.handleHighlight(rowIndex);
        return;
      }
      this.showAnswerModal(rowIndex);
    };
    if (this.elements.answersContainer) {
      this.elements.answersContainer.addEventListener('click', this.handlers.onAnswersContainerClick);
    }
    this.handlers.onDocumentClick = (e) => {
      if (e.target.matches('#retryLoadBtn')) {
        e.preventDefault();
        this.loadInitialData();
        return;
      }
    };
    document.addEventListener('click', this.handlers.onDocumentClick);
  }
  adjustLayout() {
    if (this.baseBodyPadding === undefined) {
      this.baseBodyPadding = parseFloat(getComputedStyle(this.elements.body).paddingBottom) || 0;
    }
    const footerHeight = this.elements.footer.offsetHeight;
    this.elements.body.style.paddingBottom = footerHeight + this.baseBodyPadding + 'px';
  }
  runGas(funcName, ...args) {
    return new Promise((resolve, reject) => {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        const userId = USER_ID || '';
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .withUserObject({ userId: userId })
          [funcName](...args);
      } else {
        console.warn('Google Apps Script environment not detected.');
        this.getMockData(funcName, ...args).then(resolve).catch(reject);
      }
    });
  }
  async verifyAdmin() {
    try {
      // サーバーから渡された管理者フラグを使用、フォールバックでcheckAdminを呼び出し
      let isAdmin = window.isAdminUser;
      if (!isAdmin) {
        isAdmin = await this.gas.checkAdmin();
      }
      
      if (isAdmin) {
        this.state.isAdminUser = true;
        
        // 管理画面ボタンを表示
        if (this.elements.adminPanelBtn) {
          this.elements.adminPanelBtn.classList.remove('hidden');
          this.elements.adminPanelBtn.removeAttribute('hidden');
        }
        
        // 管理モード切り替えボタンを表示
        if (this.elements.adminToggleBtn) {
          this.elements.adminToggleBtn.classList.remove('hidden');
          this.elements.adminToggleBtn.removeAttribute('hidden');
          this.elements.adminToggleBtn.textContent = this.state.showAdminFeatures ? '閲覧モード' : '管理モード';
        }
        
        if (this.elements.modeLabel) {
          this.elements.modeLabel.textContent = this.state.showAdminFeatures ? '管理モード' : '閲覧モード';
        }
      }
    } catch (e) {
      console.error('Admin check failed', e);
    }
  }
  getMockData(funcName, ...args) {
    return new Promise((resolve) => {
      setTimeout(() => {
        if (funcName === 'getPublishedSheetData') {
          const currentDisplayMode = window.displayMode || this.state.displayMode;
          const studentName1 = currentDisplayMode === 'named' ? '田中太郎' : '';
          const studentName2 = currentDisplayMode === 'named' ? '佐藤花子' : '';
          resolve({
            header: 'テスト問題',
            sheetName: 'テストシート',
            rows: [
              {
                rowIndex: 1,
                name: studentName1,
                class: '3年A組',
                opinion: 'これは素晴らしいアイデアだと思います。',
                reason: '理由は簡潔で分かりやすく、実現可能性が高いからです。',
                reactions: {
                  UNDERSTAND: { count: 5, reacted: false },
                  LIKE: { count: 2, reacted: false },
                  CURIOUS: { count: 1, reacted: false }
                },
                highlight: false
              },
              {
                rowIndex: 2,
                name: studentName2,
                class: '3年B組',
                opinion: '少し改善の余地があると考えます。',
                reason: 'より多くの人の意見を聞く必要があると思います。',
                reactions: {
                  UNDERSTAND: { count: 3, reacted: true },
                  LIKE: { count: 0, reacted: false },
                  CURIOUS: { count: 0, reacted: false }
                },
                highlight: true
              }
            ]
          });
        } else if (funcName === 'addReaction') {
          resolve({
            status: 'ok',
            reactions: {
              UNDERSTAND: { count: Math.floor(Math.random() * 5), reacted: Math.random() < 0.5 },
              LIKE: { count: Math.floor(Math.random() * 5), reacted: Math.random() < 0.5 },
              CURIOUS: { count: Math.floor(Math.random() * 5), reacted: Math.random() < 0.5 }
            }
          });
        } else if (funcName === 'toggleHighlight') {
          const currentHighlight = args[2] === undefined ? false : !args[2];
          resolve({
            status: 'ok',
            highlight: currentHighlight
          });
        } else if (funcName === 'checkAdmin') {
          resolve(true);
        }
      }, 300);
    });
  }
  startPolling() {
    if (this.pollingInterval) {
      clearInterval(this.pollingInterval);
    }
    this.pollingInterval = setInterval(() => this.loadSheetData(false), 15000);
  }
  stopPolling() {
    if (this.pollingInterval) {
      clearInterval(this.pollingInterval);
      this.pollingInterval = null;
    }
  }
  destroy() {
    this.stopPolling();
    if (this.elements.sizeSlider && this.handlers.onSizeSliderInput) {
      this.elements.sizeSlider.removeEventListener('input', this.handlers.onSizeSliderInput);
    }
    if (this.elements.answerModalCloseBtn && this.handlers.onAnswerModalCloseClick) {
      this.elements.answerModalCloseBtn.removeEventListener('click', this.handlers.onAnswerModalCloseClick);
    }
    if (this.elements.answerModalContainer && this.handlers.onAnswerModalContainerClick) {
      this.elements.answerModalContainer.removeEventListener('click', this.handlers.onAnswerModalContainerClick);
    }
    if (this.elements.infoModalConfirmBtn && this.handlers.onInfoModalConfirmClick) {
      this.elements.infoModalConfirmBtn.removeEventListener('click', this.handlers.onInfoModalConfirmClick);
    }
    if (this.elements.modalReactionContainer && this.handlers.onModalReactionClick) {
      this.elements.modalReactionContainer.removeEventListener('click', this.handlers.onModalReactionClick);
    }
    if (this.elements.classFilter && this.handlers.onClassFilterChange) {
      this.elements.classFilter.removeEventListener('change', this.handlers.onClassFilterChange);
    }
    if (this.elements.sortOrder && this.handlers.onSortOrderChange) {
      this.elements.sortOrder.removeEventListener('change', this.handlers.onSortOrderChange);
    }
    if (this.elements.adminToggleBtn && this.handlers.onAdminToggleClick) {
      this.elements.adminToggleBtn.removeEventListener('click', this.handlers.onAdminToggleClick);
    }
    if (this.handlers.onDocumentKeydown) {
      document.removeEventListener('keydown', this.handlers.onDocumentKeydown);
    }
    if (this.handlers.onWindowResize) {
      window.removeEventListener('resize', this.handlers.onWindowResize);
    }
    if (this.handlers.onVisibilityChange) {
      document.removeEventListener('visibilitychange', this.handlers.onVisibilityChange);
    }
    if (this.elements.answersContainer && this.handlers.onAnswersContainerClick) {
      this.elements.answersContainer.removeEventListener('click', this.handlers.onAnswersContainerClick);
    }
    if (this.handlers.onDocumentClick) {
      document.removeEventListener('click', this.handlers.onDocumentClick);
    }
  }
  async loadInitialData() {
    await this.loadAvailableSheets();
    await this.loadSheetData(true, true);
    this.startPolling();
  }
  async loadSheetData(showLoading = true, isInitialLoad = false, requestedSheetName = null) {
    if (this.state.isLoading && showLoading) return;
    this.state.isLoading = true;
    const selectedClass = isInitialLoad ? 'すべて' : this.elements.classFilter.value;
    const oldAnswers = [...this.state.currentAnswers];
    if (showLoading) {
      const count = parseInt(this.elements.sizeSlider.value, 10) * 2;
      const frag = document.createDocumentFragment();
      for (let i = 0; i < count; i++) {
        frag.appendChild(this.createSkeletonCard());
      }
      const container = this.elements.answersContainer;
      container.className = 'grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-' + this.elements.sizeSlider.value;
      container.innerHTML = '';
      container.appendChild(frag);
    }
    try {
      const sortOrder = this.elements.sortOrder.value;
      const data = await this.gas.getPublishedSheetData(requestedSheetName, selectedClass, sortOrder);
      this.state.sheetName = data.sheetName;
      if (typeof data.showDetails !== 'undefined') {
        this.serverShowDetails = data.showDetails;
        if (!this.state.showAdminFeatures) {
          window.showCounts = data.showDetails;
          window.displayMode = data.showDetails ? 'named' : 'anonymous';
          this.updateConfigFromGlobals();
        }
      }
      this.adjustLayout();
      if (!this.state.isAdminUser) {
        this.state.showAdminFeatures = false;
        this.state.showHighlightToggle = false;
      }
      if (isInitialLoad) {
        this.populateClassFilter(data.rows);
        this.elements.sheetNameText.textContent = 'シート: ' + this.escapeHtml(data.sheetName || '不明');
      }
      if (JSON.stringify(this.state.currentAnswers) !== JSON.stringify(data.rows)) {
        this.state.currentAnswers = data.rows;
        this.elements.headingLabel.textContent = this.escapeHtml(data.header || '問題');
        this.renderBoard(false, oldAnswers);
      }
    } catch (error) {
      console.error('Error loading sheet data:', error);
      const errorMessage = this.escapeHtml(error.message || 'Unknown error');
      this.elements.answersContainer.querySelectorAll('.skeleton').forEach(el => el.remove());
      this.elements.answersContainer.innerHTML = '<div class="text-center text-red-400 col-span-full mt-8 p-4 bg-red-900/20 rounded-lg">' + '<p class="font-bold">データの読み込みに失敗しました。</p>' + '<p class="text-sm mt-2">' + errorMessage + '</p>' + '<button id="retryLoadBtn" class="mt-4 game-btn bg-cyan-600 text-white px-4 py-2 rounded-lg font-bold border-cyan-800 hover:bg-cyan-500 text-sm">再試行</button>' + '</div>';
    } finally {
      this.state.isLoading = false;
    }
  }
  async loadAvailableSheets() {
    try {
      const sheetsData = await this.gas.getAvailableSheets();
      this.populateSheetSelector(sheetsData);
    } catch (error) {
      console.error('Failed to load available sheets:', error);
      this.elements.sheetSelector.innerHTML = '<option value="">エラー: シート読み込み失敗</option>';
    }
  }
  populateSheetSelector(sheetsData) {
    const selector = this.elements.sheetSelector;
    
    if (!sheetsData || !sheetsData.sheets || sheetsData.sheets.length === 0) {
      selector.innerHTML = '<option value="">利用可能なシートがありません</option>';
      selector.disabled = true;
      return;
    }
    
    // シート選択肢を構築
    const options = sheetsData.sheets.map(sheet => {
      const selected = sheet.isActive ? 'selected' : '';
      const activeLabel = sheet.isActive ? ' (現在のアクティブシート)' : '';
      return `<option value="${this.escapeHtml(sheet.name)}" ${selected}>${this.escapeHtml(sheet.name)}${activeLabel}</option>`;
    }).join('');
    
    selector.innerHTML = options;
    selector.disabled = false;
    
    // 現在のアクティブシートを記録
    this.state.currentActiveSheet = sheetsData.activeSheetName;
  }
  async switchSheet() {
    const selectedSheet = this.elements.sheetSelector.value;
    if (!selectedSheet || selectedSheet === this.state.currentActiveSheet) {
      return;
    }
    
    try {
      // 新しいシートのデータを読み込み
      await this.loadSheetData(true, false, selectedSheet);
      this.state.currentActiveSheet = selectedSheet;
      
      // UIを更新
      this.updateSheetSelectorLabels();
    } catch (error) {
      console.error('Failed to switch sheet:', error);
      // エラー時は元のシートに戻す
      this.elements.sheetSelector.value = this.state.currentActiveSheet || '';
    }
  }
  updateSheetSelectorLabels() {
    const selector = this.elements.sheetSelector;
    const options = Array.from(selector.options);
    
    options.forEach(option => {
      const sheetName = option.value;
      const isActive = sheetName === this.state.currentActiveSheet;
      const cleanName = sheetName.replace(/ \(現在のアクティブシート\)$/, '');
      
      if (isActive) {
        option.textContent = `${cleanName} (現在のアクティブシート)`;
      } else {
        option.textContent = cleanName;
      }
    });
  }
  populateClassFilter(rows) {
    const classFilter = this.elements.classFilter;
    const uniqueClasses = ['すべて', ...new Set(rows.map(r => r.class).filter(Boolean))];
    classFilter.innerHTML = uniqueClasses.map(c => '<option value="' + this.escapeHtml(c) + '">' + this.escapeHtml(c) + '</option>').join('');
    classFilter.value = 'すべて';
    classFilter.classList.remove('hidden');
  }
  renderBoard(isLayoutChange = false, oldRows = []) {
    const container = this.elements.answersContainer;
    container.querySelectorAll('.skeleton').forEach(el => el.remove());
    const newRows = this.state.currentAnswers;
    this.elements.sliderValue.textContent = this.elements.sizeSlider.value;
    container.className = 'grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-' + this.elements.sizeSlider.value;
    const userIcon = this.getIcon('users', 'w-4 h-4 inline-block -mt-1');
    this.elements.answerCount.innerHTML = userIcon + '<span>' + newRows.length + '件</span>';
    if (newRows.length === 0) {
      if (!container.querySelector('.no-answers')) {
        container.innerHTML = '';
        const p = document.createElement('p');
        p.className = 'text-center text-gray-500 col-span-full mt-8 no-answers';
        p.textContent = 'このクラスの回答はありません。';
        container.appendChild(p);
      }
    } else {
      const existingMap = new Map();
      container.querySelectorAll('.answer-card').forEach(card => {
        existingMap.set(card.dataset.rowIndex, card);
      });
      existingMap.forEach((card, id) => {
        if (!newRows.some(r => String(r.rowIndex) === id)) {
          card.remove();
          existingMap.delete(id);
        }
      });
      const changedItems = [];
      let prevNode = null;
      newRows.forEach((row) => {
        const rowId = String(row.rowIndex);
        let card = existingMap.get(rowId);
        const oldData = oldRows.find(r => r.rowIndex === row.rowIndex);
        if (!card) {
          card = this.createAnswerCard(row);
          card.classList.add('new-card');
          if (prevNode) {
            container.insertBefore(card, prevNode.nextSibling);
          } else {
            container.insertBefore(card, container.firstChild);
          }
          changedItems.push(row);
        } else {
          if (prevNode && card.previousSibling !== prevNode) {
            container.insertBefore(card, prevNode.nextSibling);
          } else if (!prevNode && card !== container.firstChild) {
            container.insertBefore(card, container.firstChild);
          }
          if (oldData) {
            if (oldData.opinion !== row.opinion) {
              const t = card.querySelector('.opinion-text');
              if (t) t.textContent = row.opinion;
            }
            if (oldData.reason !== row.reason) {
              const p = card.querySelector('.answer-preview p');
              if (p) p.textContent = row.reason;
            }
            if (oldData.name !== row.name) {
              const n = card.querySelector('.font-bold');
              if (n) n.textContent = row.name;
            }
            if (JSON.stringify(oldData.reactions) !== JSON.stringify(row.reactions) || oldData.highlight !== row.highlight) {
              changedItems.push(row);
            }
          }
        }
        prevNode = card;
      });
      if (changedItems.length) {
        this.applyUpdates(changedItems);
      }
    }
  }
  createAnswerCard(data) {
    const card = document.createElement('div');
    const highlightClass = data.highlight ? ' highlighted' : '';
    card.className = 'relative answer-card glass-panel rounded-xl p-4 flex flex-col justify-between shadow-lg border-2 border-cyan-400/80 cursor-pointer' + highlightClass;
    card.dataset.rowIndex = data.rowIndex;
    card.setAttribute('role', 'article');
    card.setAttribute('tabindex', '0');
    card.setAttribute('aria-label', '回答カード: ' + (data.opinion || '').substring(0, 50) + (data.opinion && data.opinion.length > 50 ? '...' : ''));
    const active = this.reactionTypes.filter(rt => data.reactions && data.reactions[rt.key] && data.reactions[rt.key].count > 0).map(rt => rt.key);
    if (active.length === 1) {
      if (active[0] === 'LIKE') card.classList.add('reaction-bg-like');
      if (active[0] === 'UNDERSTAND') card.classList.add('reaction-bg-understand');
      if (active[0] === 'CURIOUS') card.classList.add('reaction-bg-curious');
    }
    const totalReactions = this.reactionTypes.reduce((sum, rt) => sum + (data.reactions?.[rt.key]?.count || 0), 0);
    if (totalReactions >= 10) {
      card.classList.add('reaction-border-3');
    } else if (totalReactions >= 5) {
      card.classList.add('reaction-border-2');
    } else if (totalReactions > 0) {
      card.classList.add('reaction-border-1');
    }
    let highlightBtnHtml = '';
    if (this.state.showHighlightToggle) {
      const cls = data.highlight ? 'liked' : '';
      const highlightAriaLabel = data.highlight ? 'ハイライトを解除する' : 'ハイライトする';
      highlightBtnHtml = '<button type="button" class="highlight-btn like-btn text-yellow-400 ' + cls + '" aria-label="' + highlightAriaLabel + '" aria-pressed="' + data.highlight + '" data-row-index="' + data.rowIndex + '">' + this.getIcon('star', 'w-5 h-5', data.highlight) + '</button>';
    }
    const showName = this.state.displayMode === 'named';
    const nameHtml = showName ? '<div><span class="font-bold text-sm text-gray-200">' + this.escapeHtml(data.name) + '</span></div>' : '';
    const containerClass = nameHtml ? 'text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex justify-between items-center' : 'text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex justify-end items-center';
    const reactionButtonsHtml = this.reactionTypes.map(rt => {
      const info = data.reactions ? data.reactions[rt.key] : { count: 0, reacted: false };
      const cls = info.reacted ? 'liked' : '';
      const colorClass = rt.key === 'LIKE' ? 'text-red-500' : rt.key === 'UNDERSTAND' ? 'text-yellow-500' : 'text-green-500';
      const countSpan = this.state.showCounts ? '<span class="reaction-count font-bold text-lg text-gray-200" aria-hidden="true">' + (info.count || 0) + '</span>' : '';
      const reactionNames = { 'LIKE': 'いいね', 'UNDERSTAND': 'なるほど', 'CURIOUS': '気になる' };
      const reactionName = reactionNames[rt.key] || rt.key;
      const ariaLabel = `${reactionName}${info.reacted ? 'を取り消す' : 'する'}${this.state.showCounts ? ` (現在${info.count || 0}件)` : ''}`;
      return '<button type="button" class="reaction-btn like-btn flex items-center gap-1 ' + colorClass + ' ' + cls + '" data-row-index="' + data.rowIndex + '" data-reaction="' + rt.key + '" aria-label="' + ariaLabel + '" aria-pressed="' + info.reacted + '">' + this.getIcon(rt.icon, 'w-5 h-5', info.reacted) + countSpan + '</button>';
    }).join('');
    card.innerHTML = '<div class="relative flex-grow mb-3 answer-preview">' + '<h3 class="opinion-text text-cyan-200 whitespace-pre-wrap break-words text-xl md:text-2xl font-semibold leading-tight">' + this.escapeHtml(data.opinion || '') + '</h3>' + '<p class="text-gray-100 whitespace-pre-wrap break-words mt-4">' + this.escapeHtml(data.reason || '') + '</p>' + '</div>' + '<div class="' + containerClass + '">' + nameHtml + '<div class="flex items-center gap-1" role="group" aria-label="回答への反応">' + reactionButtonsHtml + highlightBtnHtml + '</div>' + '</div>';
    if (data.highlight) {
      const badge = document.createElement('span');
      badge.className = 'highlight-badge';
      badge.innerHTML = this.getIcon('star', '', true);
      card.appendChild(badge);
    }
    return card;
  }
  createSkeletonCard() {
    const card = document.createElement('div');
    card.className = 'answer-card glass-panel rounded-xl p-4 flex flex-col justify-between shadow-lg border-2 border-cyan-400/80 skeleton';
    card.innerHTML = '<div class="flex-1 space-y-3">' + '<div class="h-6 w-3/4 rounded bg-gray-500/30"></div>' + '<div class="h-4 w-full rounded bg-gray-500/20"></div>' + '<div class="h-4 w-5/6 rounded bg-gray-500/20"></div>' + '</div>' + '<div class="mt-4 h-8 rounded bg-gray-500/20"></div>';
    return card;
  }
  async handleReaction(rowIndex, reaction) {
    const btns = document.querySelectorAll('[data-row-index="' + rowIndex + '"][data-reaction="' + reaction + '"]');
    btns.forEach(btn => {
      btn.disabled = true;
      btn.setAttribute('aria-disabled', 'true');
    });
    try {
      const res = await this.gas.addReaction(rowIndex, reaction);
      if (res && res.status === 'ok') {
        const item = this.state.currentAnswers.find(i => i.rowIndex == rowIndex);
        if (item && res.reactions) {
          item.reactions = res.reactions;
          this.applyUpdates([item]);
        }
      } else if (res && res.message) {
        console.error('Failed to add reaction:', res.message);
      }
    } catch (error) {
      console.error('Failed to add reaction:', error);
    } finally {
      btns.forEach(btn => {
        btn.disabled = false;
        btn.setAttribute('aria-disabled', 'false');
      });
    }
  }
  async handleHighlight(rowIndex) {
    const btns = document.querySelectorAll('.highlight-btn[data-row-index="' + rowIndex + '"]');
    btns.forEach(btn => {
      btn.disabled = true;
      btn.setAttribute('aria-disabled', 'true');
    });
    try {
      const item = this.state.currentAnswers.find(i => i.rowIndex == rowIndex);
      const res = await this.gas.toggleHighlight(rowIndex, item.highlight);
      if (res && res.status === 'ok') {
        if (item) {
          item.highlight = res.highlight;
        }
        this.applyUpdates([item]);
      } else if (res && res.message) {
        console.error('Failed to toggle highlight:', res.message);
      }
    } catch (error) {
      console.error('Failed to toggle highlight:', error);
    } finally {
      btns.forEach(btn => {
        btn.disabled = false;
        btn.setAttribute('aria-disabled', 'false');
      });
    }
  }
  openAdminPanel() {
    // 管理画面URLを生成して開く
    const currentUrl = window.location.href;
    const url = new URL(currentUrl);
    url.searchParams.set('mode', 'admin');
    window.open(url.toString(), '_blank');
  }
  async toggleAdminMode() {
    const enable = !this.state.showAdminFeatures;
    if (enable) {
      try {
        const ok = await this.gas.checkAdmin();
        if (!ok) {
          console.warn('管理者権限がありません。');
          return;
        }
      } catch (e) {
        console.error('権限確認に失敗しました', e);
        return;
      }
    }
    window.showAdminFeatures = enable;
    window.showHighlightToggle = enable;
    window.showScoreSort = enable;
    if (enable) {
      window.showCounts = true;
      window.displayMode = 'named';
      window.isStudentMode = false;
    } else {
      window.showCounts = this.serverShowDetails;
      window.displayMode = this.serverShowDetails ? 'named' : 'anonymous';
      window.isStudentMode = true;
    }
    this.updateConfigFromGlobals();
    if (this.elements.adminToggleBtn) {
      this.elements.adminToggleBtn.textContent = enable ? '閲覧モード' : '管理モード';
    }
    if (this.elements.modeLabel) {
      this.elements.modeLabel.textContent = this.state.showAdminFeatures ? '管理モード' : '閲覧モード';
    }
    
    // 管理モード時に公開終了ボタンを表示
    if (this.elements.endPublicationBtn) {
      if (enable) {
        this.elements.endPublicationBtn.classList.remove('hidden');
        this.elements.endPublicationBtn.removeAttribute('hidden');
      } else {
        this.elements.endPublicationBtn.classList.add('hidden');
        this.elements.endPublicationBtn.setAttribute('hidden', '');
      }
    }
    this.updateSortOptions();
    this.loadSheetData(true, true);
  }
  async endPublication() {
    if (!confirm('公開を終了しますか？生徒は回答ボードにアクセスできなくなります。')) {
      return;
    }
    
    try {
      await this.runGas('clearActiveSheet');
      alert('公開を終了しました。管理画面に移動します。');
      this.endAdminMode();
    } catch (error) {
      console.error('公開終了に失敗しました:', error);
      alert('公開終了に失敗しました: ' + (error.message || error));
    }
  }
  endAdminMode() {
    // Redirect to admin URL with mode=admin parameter to show management interface
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('mode', 'admin');
    window.location.href = currentUrl.toString();
  }
  updateReactionButtonUI(rowIndex, reaction, count, reacted) {
    document.querySelectorAll('[data-row-index="' + rowIndex + '"][data-reaction="' + reaction + '"]').forEach(btn => {
      const countEl = btn.querySelector('.reaction-count');
      if (countEl && this.state.showCounts) {
        countEl.textContent = count;
      }
      const rt = this.reactionTypes.find(r => r.key === reaction);
      const svgEl = btn.querySelector('svg');
      if (svgEl && rt) {
        svgEl.outerHTML = this.getIcon(rt.icon, 'w-5 h-5', reacted);
      }
      const colorClass = reaction === 'LIKE' ? 'text-red-500' : reaction === 'UNDERSTAND' ? 'text-yellow-500' : 'text-green-500';
      btn.classList.remove('text-red-500', 'text-yellow-500', 'text-green-500');
      btn.classList.add(colorClass);
      btn.classList.toggle('liked', reacted);
      btn.setAttribute('aria-pressed', reacted.toString());
      const reactionNames = { 'LIKE': 'いいね', 'UNDERSTAND': 'なるほど', 'CURIOUS': '気になる' };
      const reactionName = reactionNames[reaction] || reaction;
      const ariaLabel = `${reactionName}${reacted ? 'を取り消す' : 'する'}${this.state.showCounts ? ` (現在${count}件)` : ''}`;
      btn.setAttribute('aria-label', ariaLabel);
    });
  }
  applyUpdates(items) {
    items.forEach(item => {
      this.reactionTypes.forEach(rt => {
        if (item.reactions && item.reactions[rt.key]) {
          this.updateReactionButtonUI(item.rowIndex, rt.key, item.reactions[rt.key].count, item.reactions[rt.key].reacted);
        }
      });
      const card = document.querySelector('.answer-card[data-row-index="' + item.rowIndex + '"]');
      if (card) {
        card.classList.toggle('highlighted', item.highlight);
        const active = this.reactionTypes.filter(rt => item.reactions && item.reactions[rt.key] && item.reactions[rt.key].count > 0).map(rt => rt.key);
        ['reaction-bg-like', 'reaction-bg-understand', 'reaction-bg-curious'].forEach(cls => card.classList.remove(cls));
        if (active.length === 1) {
          if (active[0] === 'LIKE') card.classList.add('reaction-bg-like');
          if (active[0] === 'UNDERSTAND') card.classList.add('reaction-bg-understand');
          if (active[0] === 'CURIOUS') card.classList.add('reaction-bg-curious');
        }
        const total = this.reactionTypes.reduce((sum, rt) => sum + (item.reactions?.[rt.key]?.count || 0), 0);
        ['reaction-border-1', 'reaction-border-2', 'reaction-border-3'].forEach(cls => card.classList.remove(cls));
        if (total >= 10) {
          card.classList.add('reaction-border-3');
        } else if (total >= 5) {
          card.classList.add('reaction-border-2');
        } else if (total > 0) {
          card.classList.add('reaction-border-1');
        }
        const highlightBtn = card.querySelector('.highlight-btn');
        if (highlightBtn) {
          highlightBtn.classList.toggle('liked', item.highlight);
          highlightBtn.setAttribute('aria-pressed', String(item.highlight));
          const label = item.highlight ? 'ハイライトを解除する' : 'ハイライトする';
          highlightBtn.setAttribute('aria-label', label);
          const svgEl = highlightBtn.querySelector('svg');
          if (svgEl) {
            svgEl.outerHTML = this.getIcon('star', 'w-5 h-5', item.highlight);
          }
        }
        let badge = card.querySelector('.highlight-badge');
        if (item.highlight && !badge) {
          badge = document.createElement('span');
          badge.className = 'highlight-badge';
          badge.innerHTML = this.getIcon('star', '', true);
          card.appendChild(badge);
        } else if (!item.highlight && badge) {
          badge.remove();
        }
      }
    });
  }
  showAnswerModal(rowIndex) {
    const data = this.state.currentAnswers.find(r => r.rowIndex == rowIndex);
    if (!data) return;
    this.state.lastFocusedElement = document.activeElement;
    this.elements.modalAnswer.innerHTML = '<p class="text-cyan-200 whitespace-pre-wrap break-words text-3xl md:text-4xl font-bold leading-tight">' + this.escapeHtml(data.opinion || '') + '</p>' + '<p class="text-gray-200 whitespace-pre-wrap break-words text-2xl md:text-3xl mt-6">' + this.escapeHtml(data.reason || '') + '</p>';
    const showName = this.state.displayMode === 'named';
    this.elements.modalStudentName.textContent = showName ? data.name : '';
    const footerBase = 'text-xs text-gray-400 pt-4 border-t-2 border-dashed border-cyan-400/80 flex';
    this.elements.modalFooter.className = footerBase + (showName ? ' justify-between items-center' : ' justify-end items-center');
    const reactionButtonsHtml = this.reactionTypes.map(rt => {
      const info = data.reactions?.[rt.key] || { count: 0, reacted: false };
      const cls = info.reacted ? 'liked' : '';
      const colorClass = rt.key === 'LIKE' ? 'text-red-500' : rt.key === 'UNDERSTAND' ? 'text-yellow-500' : 'text-green-500';
      const countSpan = this.state.showCounts ? '<span class="reaction-count font-bold text-2xl text-gray-200">' + info.count + '</span>' : '';
      return '<button type="button" class="reaction-btn like-btn flex items-center gap-1.5 ' + colorClass + ' ' + cls + '" ' + 'data-row-index="' + rowIndex + '" data-reaction="' + rt.key + '" aria-label="' + rt.key + '">' + this.getIcon(rt.icon, 'w-5 h-5', info.reacted) + countSpan + '</button>';
    }).join('');
    this.elements.modalReactionContainer.innerHTML = reactionButtonsHtml;
    this.elements.answerModalContainer.classList.remove('hidden');
    this.elements.answerModalContainer.classList.add('modal-fade');
    this.elements.answerModalCard.classList.add('modal-scale');
    this.elements.answerModalCloseBtn.focus();
  }
  hideAnswerModal() {
    this.elements.answerModalContainer.classList.add('hidden');
    this.elements.answerModalContainer.classList.remove('modal-fade');
    this.elements.answerModalCard.classList.remove('modal-scale');
    if (this.state.lastFocusedElement) {
      this.state.lastFocusedElement.focus();
    }
  }
  showInfoModal() {
    this.state.lastFocusedElement = document.activeElement;
    this.elements.infoModalContainer.classList.remove('hidden');
    this.elements.infoModalContainer.classList.add('modal-fade');
    this.elements.infoModalCard.classList.add('modal-scale');
    this.elements.infoModalConfirmBtn.focus();
  }
  hideInfoModal() {
    this.elements.infoModalContainer.classList.add('hidden');
    this.elements.infoModalContainer.classList.remove('modal-fade');
    this.elements.infoModalCard.classList.remove('modal-scale');
    localStorage.setItem('introSeen', '1');
    if (this.state.lastFocusedElement) {
      this.state.lastFocusedElement.focus();
    }
  }
  getIcon(name, classes = '', solid = false) {
    let key = name;
    if (ICONS[name + '-outline'] || ICONS[name + '-solid']) {
      key = solid ? name + '-solid' : name + '-outline';
    }
    const icon = ICONS[key];
    if (!icon) {
      console.warn('Icon not found:', key);
      return '<span aria-hidden="true" class="' + classes + '">⭐</span>';
    }
    return '<span aria-hidden="true" class="' + classes + '">' + icon + '</span>';
  }
  renderIcons() {
    if (this.elements.infoIconLike) {
      this.elements.infoIconLike.innerHTML = this.getIcon('hand-thumb-up');
    }
    if (this.elements.infoIconUnderstand) {
      this.elements.infoIconUnderstand.innerHTML = this.getIcon('lightbulb');
    }
    if (this.elements.infoIconCurious) {
      this.elements.infoIconCurious.innerHTML = this.getIcon('magnifying-glass-plus');
    }
    if (this.elements.infoIconHighlight) {
      this.elements.infoIconHighlight.innerHTML = this.getIcon('star');
    }
    if (this.elements.iconClose) {
      this.elements.iconClose.innerHTML = this.getIcon('x');
    }
    if (this.elements.iconGrid) {
      this.elements.iconGrid.innerHTML = this.getIcon('grid-2x2');
    }
  }
  debounce(func, delay) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }
  updateSortOptions() {
    if (this.elements.scoreOption) {
      if (this.state.showScoreSort) {
        this.elements.scoreOption.style.display = 'block';
      } else {
        this.elements.scoreOption.style.display = 'none';
        if (this.elements.sortOrder.value === 'score') {
          this.elements.sortOrder.value = 'newest';
        }
      }
    }
  }
  updateConfigFromGlobals() {
    this.state.isStudentMode = window.isStudentMode;
    this.state.showCounts = window.showCounts;
    this.state.showAdminFeatures = window.showAdminFeatures;
    this.state.showHighlightToggle = window.showHighlightToggle;
    this.state.showScoreSort = window.showScoreSort;
    this.state.showPublishControls = window.showPublishControls;
    this.state.displayMode = window.displayMode;
  }
  escapeHtml(str) {
    if (!str) return '';
    return str.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }
}
try {
  if (window.studyQuestApp && typeof window.studyQuestApp.destroy === 'function') {
    window.studyQuestApp.destroy();
  }
  window.studyQuestApp = new StudyQuestApp();
  window.addEventListener('beforeunload', () => {
    if (window.studyQuestApp && typeof window.studyQuestApp.destroy === 'function') {
      window.studyQuestApp.destroy();
    }
  });
} catch (error) {
  console.error('Error creating StudyQuestApp instance:', error);
  const container = document.getElementById('answers');
  if (container) {
    container.innerHTML = '<div class="text-red-400 p-4">アプリケーションの初期化に失敗しました: ' + error.message + '</div>';
  }
}
</script>
</body>
</html>
