<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>みんなの回答ボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Shared Security Headers -->
  <?!= include('SharedSecurityHeaders'); ?>
  
  <!-- Preload Google Fonts for better performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&amp;display=swap" rel="stylesheet">
  <!-- Global error handling and TailwindCSS setup -->
  <script>
    // Global error handling for document.write and other issues
    window.addEventListener('error', function(event) {
      if (event.error && event.error.message) {
        if (event.error.message.includes('document.write') ||
            event.error.message.includes('Unexpected token') ||
            event.error.message.includes('await is only valid in async functions') ||
            event.error.message.includes('await is only valid in async functions and the top level bodies of modules') ||
            event.error.message.includes('SyntaxError: await is only valid') ||
            event.error.message.includes('Failed to execute \'write\' on \'Document\'')) {
          console.warn('Document.write, syntax error, or async error caught and handled:', event.error.message);
          event.preventDefault();
          return false;
        }
      }
    });

    // Handle unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      console.warn('Unhandled promise rejection:', event.reason);
      event.preventDefault();
    });

  </script>
  
  <!-- Shared TailwindCSS Configuration -->
  <?!= include('SharedTailwindConfig'); ?>
  <script>
    const DEBUG_MODE = '<?= typeof DEBUG_MODE !== "undefined" ? DEBUG_MODE : "false" ?>' === 'true';
    function debugLog() {
      if (DEBUG_MODE && console && console.log) {
        try {
          // 引数を安全に処理
          const args = Array.from(arguments).map(arg => {
            if (typeof arg === 'object' && arg !== null) {
              return safeDebugStringify(arg);
            }
            return arg;
          });
          console.log.apply(console, args);
        } catch (error) {
          console.warn('debugLog error:', error.message);
        }
      }
    }

    function warnLog() {
      if (console && console.warn) {
        try {
          const args = Array.from(arguments).map(arg => {
            if (typeof arg === 'object' && arg !== null) {
              return safeDebugStringify(arg);
            }
            return arg;
          });
          console.warn.apply(console, args);
        } catch (error) {
          console.warn('warnLog error:', error.message);
        }
      }
    }

    function errorLog() {
      if (console && console.error) {
        try {
          const args = Array.from(arguments).map(arg => {
            if (typeof arg === 'object' && arg !== null) {
              return safeDebugStringify(arg);
            }
            return arg;
          });
          console.error.apply(console, args);
        } catch (error) {
          console.error('errorLog error:', error.message);
        }
      }
    }

    function safeDebugStringify(obj, maxDepth = 2, currentDepth = 0) {
      if (currentDepth > maxDepth) return '[Max Depth Reached]';
      
      try {
        if (obj === null || obj === undefined) return obj;
        if (typeof obj !== 'object') return obj;
        
        // DOM要素の安全な表示
        if (obj instanceof HTMLElement) {
          return `[${obj.tagName}${obj.id ? '#' + obj.id : ''}${obj.className ? '.' + obj.className.split(' ').slice(0, 2).join('.') : ''}]`;
        }
        
        // 配列の安全な表示
        if (Array.isArray(obj)) {
          if (obj.length > 5) {
            return `[Array(${obj.length}): first 3 items + ${obj.length - 3} more]`;
          }
          return obj.map(item => safeDebugStringify(item, maxDepth, currentDepth + 1));
        }
        
        // オブジェクトの安全な表示
        const result = {};
        let count = 0;
        for (const key in obj) {
          if (count >= 8) {
            result['...'] = `[${Object.keys(obj).length - 8} more properties]`;
            break;
          }
          result[key] = safeDebugStringify(obj[key], maxDepth, currentDepth + 1);
          count++;
        }
        return result;
      } catch (error) {
        return '[Stringify Error: ' + error.message + ']';
      }
    }

    // システム全体フロー表示機能
    function showSystemFlow() {
    }

    const __SHOW_COUNTS__ = '<?= typeof showCounts !== "undefined" ? showCounts : "false" ?>';
    const __DISPLAY_MODE__ = '<?= typeof displayMode !== "undefined" ? displayMode : "anonymous" ?>';
    const __SHEET_NAME__ = '<?= typeof sheetName !== "undefined" ? sheetName : "" ?>';
    const __MAPPING__ = '<?= typeof mapping !== "undefined" ? JSON.stringify(mapping) : "{}" ?>';
    const __USER_ID__ = '<?= typeof userId !== "undefined" ? userId : "" ?>';
    const __SPREADSHEET_ID__ = '<?= typeof spreadsheetId !== "undefined" ? spreadsheetId : "" ?>';
    const __OWNER_NAME__ = '<?= typeof ownerName !== "undefined" ? ownerName : "" ?>';
    const __OPINION_HEADER__ = '<?= typeof opinionHeader !== "undefined" ? opinionHeader : "質問" ?>';
    const __SHOW_ADMIN_FEATURES__ = '<?= typeof showAdminFeatures !== "undefined" ? showAdminFeatures : "false" ?>';
    const __SHOW_HIGHLIGHT_TOGGLE__ = '<?= typeof showHighlightToggle !== "undefined" ? showHighlightToggle : "false" ?>';
    const __SHOW_SCORE_SORT__ = '<?= typeof showScoreSort !== "undefined" ? showScoreSort : "false" ?>';
    const __IS_STUDENT_MODE__ = '<?= typeof isStudentMode !== "undefined" ? isStudentMode : "true" ?>';
    const __IS_ADMIN_USER__ = '<?= typeof isAdminUser !== "undefined" ? isAdminUser : "false" ?>';
    window.showCounts = __SHOW_COUNTS__.startsWith('<') ? false : __SHOW_COUNTS__ === 'true';
    window.displayMode = __DISPLAY_MODE__.startsWith('<') ? 'anonymous' : __DISPLAY_MODE__;
    // Store server-provided admin capability but always start in view mode
    window.hasAdminCapability = __SHOW_ADMIN_FEATURES__.startsWith('<') ? false : __SHOW_ADMIN_FEATURES__ === 'true';
    window.showAdminFeatures = false; // Always start in view mode
    window.showHighlightToggle = __SHOW_HIGHLIGHT_TOGGLE__.startsWith('<') ? false : __SHOW_HIGHLIGHT_TOGGLE__ === 'true';
    window.showScoreSort = __SHOW_SCORE_SORT__.startsWith('<') ? false : __SHOW_SCORE_SORT__ === 'true';
    window.isStudentMode = __IS_STUDENT_MODE__.startsWith('<') ? true : __IS_STUDENT_MODE__ === 'true';
    window.isAdminUser = __IS_ADMIN_USER__.startsWith('<') ? false : __IS_ADMIN_USER__ === 'true';

    // Server configuration processing completed
    const SHEET_NAME = __SHEET_NAME__.startsWith('<') ? 'テストシート' : __SHEET_NAME__;
    const USER_ID = __USER_ID__.startsWith('<') ? '' : __USER_ID__;
    const OWNER_NAME = __OWNER_NAME__.startsWith('<') ? '' : __OWNER_NAME__;
    let MAPPING;
    try {
      if (typeof __MAPPING__ === 'string' && !__MAPPING__.startsWith('<')) {
        MAPPING = JSON.parse(__MAPPING__);
      } else {
        MAPPING = {};
      }
    } catch (e) {
      console.warn('Failed to parse MAPPING:', e);
      MAPPING = {};
    }


    // Performance-optimized dynamic batch size calculation
    function getDynamicBatchSize(perf = {}) {
      const frameTime = perf.frameTime || 16;
      const perfLevel = window.getPerformanceLevel?.() || 'medium';

      if (perfLevel === 'high' && frameTime < 12) {
        return window.getBatchSize?.('high_perf') || 15;
      }

      if (perfLevel === 'low' || frameTime > 20) {
        return window.getBatchSize?.('low_perf') || 5;
      }

      return window.getBatchSize?.('base') || 10;
    }

    // Pre-calculate batch size for performance
    const RENDER_BATCH_SIZE = getDynamicBatchSize();

    // Static icon definitions
    const ICONS = {
      'lightbulb-outline': '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6zM9 16.5h6v4H9v-4zm0 1h6zm0 1h6zM10.5 11l.5 2h2l.5-2m-3 1h3"/></svg>',
      'lightbulb-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6z M10.5 11.25 L11 13 L13 13 L13.5 11.25 H 10.5 Z"/><path d="M9 16.5h6v1H9z M9 18h6v1H9z M9 19.5h6v1H9z"/></svg>',
      'hand-thumb-up-outline': '<svg fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.338 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>',
      'hand-thumb-up-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z M6.5 10v12h1V10h-1z"/></svg>',
      'magnifying-glass-plus-outline': '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6"/></svg>',
      'magnifying-glass-plus-solid': '<svg viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z M9.75 7.5v2.25H7.5v1.5h2.25V13.5h1.5v-2.25H13.5v-1.5h-2.25V7.5h-1.5z"/><path d="M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15zM16.5 16.5l4.5 4.5" fill="currentColor"/></svg>',
      'x': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
      'star-outline': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 8.5 22 9.3 17 14 18.2 21 12 17.8 5.8 21 7 14 2 9.3 9 8.5 12 2"/></svg>',
      'star-solid': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15 8.5 22 9.3 17 14 18.2 21 12 17.8 5.8 21 7 14 2 9.3 9 8.5 12 2"/></svg>',
      'grid-2x2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 12h18"/><path d="M12 3v18"/></svg>',
      'users': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>'
    };

    // Unified caching class for better performance
    class UnifiedCache {
      constructor() {
        this.data = new Map();
        this.timestamps = new Map();
      }

      set(key, value, ttl = 300000) {
        this.data.set(key, value);
        this.timestamps.set(key, Date.now() + ttl);
      }

      get(key) {
        if (!this.data.has(key)) return undefined;

        const expiry = this.timestamps.get(key);
        if (expiry && Date.now() > expiry) {
          this.delete(key);
          return undefined;
        }

        return this.data.get(key);
      }

      has(key) {
        return this.get(key) !== undefined;
      }

      delete(key) {
        this.data.delete(key);
        this.timestamps.delete(key);
      }

      clear() {
        this.data.clear();
        this.timestamps.clear();
      }

      cleanup() {
        const now = Date.now();
        for (const [key, expiry] of this.timestamps.entries()) {
          if (now > expiry) {
            this.delete(key);
          }
        }
      }

      get size() {
        return this.data.size;
      }
    }

    // Make global for access from page.js.html
    window.ICONS = ICONS;
    window.UnifiedCache = UnifiedCache;
    window.RENDER_BATCH_SIZE = RENDER_BATCH_SIZE;
    window.getDynamicBatchSize = getDynamicBatchSize;

  </script>

  <?!= include('SharedUtilities'); ?>
  <?!= include('UnifiedStyles.css'); ?>
  <?!= include('page.css'); ?>

</head>
<body style="background: var(--brand-background); color: var(--brand-text);" class="font-sans">
  <!-- UnifiedLoadingManager removed: Page.html uses independent skeleton loading -->

  <div id="main-container" class="w-full mx-auto px-4 pt-4 pb-4 md:px-6 md:pt-6 md:pb-6">
    <!-- コンパクトヘッダー -->
    <header id="main-header" class="glass-panel rounded-xl p-3 mb-4 shadow-lg fade-in">
      <!-- 上部: フォームリンク + ドメイン情報（横並び） -->
      <div class="flex items-center justify-between mb-3 text-xs">
        <!-- フォームリンク（左側） -->
        <a id="form-link-btn" href="#" target="_blank" class="group bg-cyan-500/10 border border-cyan-400/30 rounded-lg px-3 py-2 flex items-center gap-2 hover:bg-cyan-500/20 transition-all duration-200 text-cyan-400 hover:text-cyan-300 hidden focus:ring-2 focus:ring-cyan-400/50 focus:outline-none">
          <svg class="w-3 h-3 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          <span class="font-medium text-sm">📝 回答フォーム</span>
        </a>
        
        <!-- 管理モードボタンとドメイン情報（右側） -->
        <div class="flex-shrink-0 flex items-center gap-2">
          <!-- 管理モードボタン -->
          <button type="button" id="adminToggleBtn" class="admin-toggle group text-xs text-gray-500 hover:text-cyan-400 transition-all duration-200 opacity-60 hover:opacity-100 hidden whitespace-nowrap flex items-center gap-1 px-2 py-1 rounded-md hover:bg-cyan-500/10 focus:ring-2 focus:ring-cyan-400/50 focus:outline-none" hidden aria-label="管理者モード切り替え">
            <svg class="w-3 h-3 transition-transform group-hover:rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </button>
          
          <div>
            <!-- ドメイン一致表示 -->
            <div id="header-domain-match" class="bg-green-500/10 border border-green-400/30 rounded-lg px-3 py-1.5 hidden transition-all duration-200">
              <div class="flex items-center gap-1.5">
                <svg class="w-3 h-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-green-400 font-semibold text-xs" id="header-domain-match-text">学校ドメイン</span>
              </div>
            </div>

            <!-- ドメイン不一致表示 -->
            <div id="header-domain-mismatch" class="bg-yellow-500/10 border border-yellow-400/30 rounded-lg px-3 py-1.5 hidden transition-all duration-200">
              <div class="flex items-center gap-1.5">
                <svg class="w-3 h-3 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <span class="text-yellow-400 font-semibold text-xs" id="header-domain-mismatch-text">外部アクセス</span>
              </div>
            </div>

            <!-- 初期状態表示 -->
            <div id="header-domain-initial" class="bg-blue-500/10 border border-blue-400/30 rounded-lg px-3 py-1.5 transition-all duration-200">
              <div class="flex items-center gap-1.5">
                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                <span class="text-blue-400 font-semibold text-xs">確認中</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- メイン部分: 問題タイトル + コントロール -->
      <div class="flex flex-col lg:flex-row items-center gap-3">
        <!-- 左: コントロール -->
        <div class="flex items-center gap-3 text-xs">
          <div id="answerCount" class="flex items-center gap-1.5 text-gray-300/80 bg-gray-800/30 rounded-lg px-2.5 py-1.5 border border-gray-600/40">
            <svg class="w-3.5 h-3.5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            <span id="answerCountText" class="font-semibold">0件</span>
          </div>

          <select id="classFilter" class="hidden text-xs bg-gray-700/90 border border-gray-600 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-cyan-400/50 focus:outline-none transition-all duration-200" title="クラスフィルター" aria-label="クラスフィルター"></select>

          <div class="relative">
            <select id="sortOrder" class="text-xs bg-gray-700/90 border border-gray-600 rounded-lg px-3 py-1.5 pr-8 appearance-none focus:ring-2 focus:ring-cyan-400/50 focus:outline-none transition-all duration-200 cursor-pointer" title="並び順" aria-label="並び順">
              <option value="newest" selected>新着順</option>
              <option value="random">ランダム順</option>
              <option value="score" id="scoreOption" class="hidden">スコア順</option>
            </select>
            <svg class="absolute right-2 top-1/2 transform -translate-y-1/2 w-3 h-3 text-gray-400 pointer-events-none transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
        </div>

        <!-- 中央: 問題タイトル（最大） -->
        <div class="flex-grow text-center min-w-0">
          <div id="headingLabel" class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-bold text-pink-400 leading-tight">
            <svg class="w-5 h-5 md:w-6 md:h-6 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
            </svg>
          </div>
        </div>

      <!-- Right Section: Info & Admin Controls -->
      <div class="w-full lg:w-auto lg:min-w-[160px] text-right space-y-2">
        <p id="sheetNameText" class="text-xs text-gray-400 h-4 truncate flex items-center justify-end gap-1">
        </p>
        <div class="flex justify-end gap-2 flex-wrap">
          <button type="button" id="endPublicationBtn" class="admin-toggle group text-xs bg-orange-600/90 hover:bg-orange-700 text-white px-3 py-2 rounded-lg hidden whitespace-nowrap transition-all duration-200 flex items-center gap-1.5 focus:ring-2 focus:ring-orange-400/50 focus:outline-none shadow-sm" hidden aria-label="公開終了">
            <svg class="w-3 h-3 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636"></path>
            </svg>
            <span class="font-medium">公開終了</span>
          </button>
        </div>
      </div>
    </header>
    <!-- 新着通知バナー -->
    <div id="newContentBanner" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-full shadow-xl backdrop-blur-sm hidden transition-all duration-300 ease-out hover:shadow-2xl focus-within:ring-2 focus-within:ring-blue-300/50" role="alert" aria-live="polite">
      <div class="flex items-center gap-3">
        <span id="newContentIcon" class="w-5 h-5 animate-pulse text-yellow-200" aria-hidden="true">📋</span>
        <span id="newContentText" class="font-medium text-white">新しい意見が投稿されました</span>
        <button type="button" id="refreshContentBtn" class="bg-white/20 hover:bg-white/30 active:bg-white/40 px-3 py-1.5 rounded-full text-sm font-semibold transition-all duration-200 hover:scale-105 active:scale-95 focus:ring-2 focus:ring-white/50 focus:outline-none" aria-label="新しいコンテンツを更新して表示">
          更新して表示
        </button>
        <button type="button" id="dismissBannerBtn" class="text-white/70 hover:text-white active:text-white/90 w-6 h-6 flex items-center justify-center rounded-full hover:bg-white/20 active:bg-white/30 transition-all duration-200 hover:scale-110 active:scale-90 focus:ring-2 focus:ring-white/50 focus:outline-none" aria-label="通知を閉じる">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <main id="answers" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 transition-all duration-300 ease-in-out" role="main" aria-live="polite" aria-label="回答一覧"></main>
  </div>
  <div id="answerModalContainer" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden transition-all duration-300 ease-out" role="dialog" aria-modal="true">
    <div id="answerModalCard" class="glass-panel rounded-xl p-6 flex flex-col shadow-2xl border-2 border-cyan-400/80 w-full max-w-5xl h-auto max-h-[85vh] relative transition-all duration-300 ease-out scale-95 hover:scale-100" role="document" aria-labelledby="modalAnswer">
      <button type="button" id="answerModalCloseBtn" class="modal-close-btn bg-red-600 hover:bg-red-500 active:bg-red-700 rounded-full p-2 text-white hover:scale-110 active:scale-95 transition-all duration-200 z-10 focus:ring-2 focus:ring-red-400/50 focus:outline-none shadow-lg" aria-label="閉じる">
        <span id="iconClose" class="w-6 h-6"></span>
      </button>
      <div id="modalAnswer" class="flex-grow min-h-[200px] mb-4 overflow-y-auto pr-4 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800"></div>
      <div id="modalFooter" class="text-xs text-gray-400 pt-4 border-t-2 border-dashed border-cyan-400/80 flex justify-between items-center">
        <div><span id="modalStudentName" class="font-bold text-2xl text-gray-200 hover:text-cyan-300 transition-colors duration-200"></span></div>
        <div id="modalReactions" class="flex items-center gap-2"></div>
      </div>
    </div>
  </div>
  <div id="infoModalContainer" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden transition-all duration-300 ease-out" role="dialog" aria-modal="true">
    <div id="infoModalCard" class="glass-panel rounded-xl p-8 shadow-2xl border-2 border-cyan-400/80 w-full max-w-2xl relative transition-all duration-300 ease-out scale-95 hover:scale-100" role="document">
      <div class="space-y-5 text-gray-200 text-lg leading-relaxed">
        <!-- Digital Citizenship Education Section -->
        <div class="bg-gradient-to-r from-green-800/40 to-emerald-800/40 border border-green-400/50 rounded-lg p-4 mb-4 hover:from-green-800/50 hover:to-emerald-800/50 transition-all duration-300">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full flex items-center justify-center flex-shrink-0 mt-0.5 shadow-lg">
              <span class="text-lg" role="img" aria-label="教育アイコン">📚</span>
            </div>
            <div>
              <p class="text-base font-bold text-green-200 mb-3">デジタル・シティズンシップって何だろう？</p>
              <p class="text-sm text-green-100 leading-relaxed mb-2">
                <span class="text-green-200 font-semibold">デジタル・シティズンシップ</span>とは、コンピューターやタブレットを使うときに、<span class="text-green-200 font-semibold">やさしい心で相手のことを考える</span>ことです。
              </p>
              <p class="text-sm text-green-200 leading-relaxed mb-2">
                みんなの回答ボードでも、<span class="text-green-200 font-semibold">思いやりのある言葉</span>を選んで、みんなが気持ちよく参加できるようにしましょう。
              </p>
              <p class="text-sm text-green-200 leading-relaxed">
                友だちの意見を聞いて「そういう考えもあるんだね」と<span class="text-green-200 font-semibold">多様性を大切にする心</span>を育てましょう。
              </p>
            </div>
          </div>
        </div>

        <p>みんなの意見を気持ちよく共有するために、リアクションのしかたをおぼえよう！</p>
        <ul class="space-y-3">
          <li class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800/30 transition-colors duration-200"><span id="infoIconLike" class="w-5 h-5 text-red-400 flex-shrink-0"></span><span class="text-gray-200">いいね！：すてきだと思ったときに押そう</span></li>
          <li class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800/30 transition-colors duration-200"><span id="infoIconUnderstand" class="w-5 h-5 text-yellow-400 flex-shrink-0"></span><span class="text-gray-200">なるほど！：参考になったときに押そう</span></li>
          <li class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800/30 transition-colors duration-200"><span id="infoIconCurious" class="w-5 h-5 text-green-400 flex-shrink-0"></span><span class="text-gray-200">もっと知りたい！：もっと知りたいときに押そう</span></li>
        </ul>
        <p class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800/30 transition-colors duration-200"><span id="infoIconHighlight" class="w-5 h-5 text-purple-400 flex-shrink-0"></span><span class="text-gray-200">先生が注目してほしい意見につけています</span></p>
        <p>責任あるリアクションで、みんなで学びを深めよう！</p>


        <div class="text-center mt-6">
          <button type="button" id="infoModalConfirmBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white rounded-lg font-semibold transition-all duration-200 hover:scale-105 active:scale-95 focus:ring-2 focus:ring-blue-400/50 focus:outline-none shadow-lg">わかった</button>
        </div>
      </div>
    </div>
  </div>
  <footer id="controlsFooter" class="fixed bottom-0 left-0 right-0 z-40 p-4 pointer-events-none">
    <div class="glass-panel max-w-md mx-auto rounded-xl p-3 flex items-center justify-center gap-3 pointer-events-auto shadow-lg hover:shadow-xl transition-all duration-300">
      <input type="range" id="sizeSlider" min="2" max="6" value="4" class="w-1/2 h-2 bg-gray-600/50 rounded-lg appearance-none cursor-pointer focus:ring-2 focus:ring-cyan-400/50 focus:outline-none slider-thumb" aria-label="表示列数の変更">
      <div class="flex items-center gap-2">
        <span id="sliderValue" class="font-bold text-lg text-cyan-300 min-w-[1rem] text-center">4</span>
        <span id="iconGrid" class="w-4 h-4 text-gray-400"></span>
      </div>
    </div>
  </footer>
  <?!= include('page.js'); ?>
</body>
</html>