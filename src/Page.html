<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>StudyQuest - みんなのかいとうボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- deferを削除してGSAPを即座に利用可能にする -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script>
    window.userEmail = "<?= userEmail ?>";
    window.isAdminPage = <?= isAdmin ? 'true' : 'false' ?>;
  </script>
  <style>
    body { color: #c0caf5; }
    .glass-panel { background: rgba(26, 27, 38, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .game-btn { transition: all 0.2s ease; border-bottom-width: 4px; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); }
    .game-btn:not(:disabled):hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 0 15px rgba(139, 233, 253, 0.4); }
    .game-btn:active:not(:disabled) { transform: translateY(2px); border-bottom-width: 2px; box-shadow: none; }
    #classFilter, #sortMode { background-color: #2a2f4a; border: 1px solid #4a4f8a; color: #c0caf5; border-radius: 0.5rem; padding: 0.25rem 0.5rem; }
    :focus-visible { outline: 3px solid #8be9fd; outline-offset: 2px; border-radius: 4px; }
    header { position: sticky; top: 0; z-index: 5; }
    .answer-card { will-change: transform, opacity; }
    .answer-preview { display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: 120px; }
    .like-btn svg { transition: all 0.2s ease-in-out; fill: none; }
    .like-btn[data-reaction="LIKE"] svg { color: #ef4444; }
    .like-btn[data-reaction="UNDERSTAND"] svg { color: #fbbf24; }
    .like-btn[data-reaction="CURIOUS"] svg { color: #3b82f6; }
    .like-btn.liked[data-reaction="LIKE"] svg { stroke: transparent; fill: #ef4444; transform: scale(1.1); }
    .like-btn.liked[data-reaction="UNDERSTAND"] svg { stroke: transparent; fill: #fbbf24; transform: scale(1.1); }
    .like-btn.liked[data-reaction="CURIOUS"] svg { stroke: transparent; fill: #3b82f6; transform: scale(1.1); }
    .answer-card.highlighted { border-color: #facc15; box-shadow: 0 0 15px rgba(250, 204, 21, 0.4); }
    .highlight-badge { position: absolute; top: 0.25rem; right: 0.25rem; }
    .reaction-bg-like {
      border-color: #ef4444;
      border-image: linear-gradient(to bottom, #facc15, #fcd34d) 1;
    }

    .reaction-bg-understand {
      border-color: #fbbf24;
      border-image: linear-gradient(to bottom, #a3e635, #bef264) 1;
    }

    .reaction-bg-curious {
      border-color: #3b82f6;
      border-image: linear-gradient(to bottom, #38bdf8, #7dd3fc) 1;
    }

    .reaction-bg-mixed {
      border-color: #8b5cf6;
      border-image: linear-gradient(to bottom, #f59e0b, #10b981, #3b82f6) 1;
    }
    .reaction-bg-all {
      border-color: transparent;
      border-image: linear-gradient(90deg, #ef4444, #fbbf24, #3b82f6) 1;
    }

    .reaction-popular {
      box-shadow: 0 0 15px rgba(250, 204, 21, 0.6);
    }
    #controlsFooter { pointer-events: none; }
    #controlsFooter > .glass-panel { pointer-events: auto; }
  </style>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans">

  <div id="main-container" class="w-full mx-auto p-4 md:p-6">
    <header id="main-header" class="glass-panel rounded-xl p-4 mb-4 flex flex-col lg:flex-row justify-between items-center gap-4 shadow-lg">
        <div class="flex items-center gap-4 w-full lg:w-auto">
            <p id="answerCount" class="text-sm text-gray-400 flex items-center gap-2 flex-shrink-0"></p>
            <select id="classFilter" class="hidden text-sm"></select>
            <select id="sortMode" class="text-sm">
                <option value="newest" selected>新着順</option>
                <option value="random">ランダム</option>
            </select>
        </div>
        <div class="flex-grow text-center w-full min-w-0">
             <p id="headingLabel" class="text-2xl md:text-3xl font-bold text-pink-400 leading-tight">データを読み込んでいます...</p>
        </div>
        <div class="w-full lg:w-auto lg:min-w-[150px] text-right flex flex-col items-end gap-2">
            <p id="sheetNameText" class="text-xs text-gray-400 h-4"></p>
            <button id="unpublishBtn" class="hidden text-white font-bold py-1 px-3 rounded-md bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 text-xs">公開終了</button>
        </div>
    </header>

    <main id="answers" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></main>
  </div>
  
  <div id="answerModalContainer" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300" role="dialog" aria-modal="true">
      <div id="answerModalCard" class="glass-panel rounded-xl p-6 flex flex-col shadow-2xl border-2 border-cyan-400/80 w-full max-w-5xl h-auto max-h-[85vh] transform scale-95 transition-transform duration-300">
          <button id="answerModalCloseBtn" class="absolute -top-3 -right-3 bg-red-600 rounded-full p-2 text-white hover:scale-110 transition-transform" aria-label="閉じる"></button>
          <div id="modalAnswer" class="flex-grow min-h-[200px] mb-4 overflow-y-auto pr-4"></div>
          <div class="text-xs text-gray-400 pt-4 border-t-2 border-dashed border-cyan-400/80 flex justify-between items-center">
              <div><span id="modalStudentName" class="font-bold text-2xl text-gray-200"></span></div>
              <div id="modalReactionButtons" class="flex gap-3"></div>
          </div>
      </div>
  </div>

  <footer id="controlsFooter" class="fixed bottom-0 left-0 right-0 z-40 p-4">
      <div class="glass-panel max-w-md mx-auto rounded-xl p-3 flex items-center justify-center gap-3">
        <span id="footerIcon" class="w-5 h-5"></span>
        <input type="range" id="sizeSlider" min="2" max="6" value="4" class="w-1/2" aria-label="表示列数の変更">
        <span id="sliderValue" class="font-bold w-4 text-center text-lg">4</span>
      </div>
  </footer>

  <script>
    // 環境変数の安全な取得
    const userEmail = typeof window !== 'undefined' ? window.userEmail : "";
    const urlParams = new URLSearchParams(window.location.search);
    const adminMode = urlParams.get('admin') === '1';
    const isAdmin = adminMode && typeof window !== 'undefined' ? Boolean(window.isAdminPage) : false;

    class StudyQuestApp {
        constructor() {
            this.elements = {
                body: document.body,
                mainContainer: document.getElementById('main-container'),
                header: document.getElementById('main-header'),
                answersContainer: document.getElementById('answers'),
                sizeSlider: document.getElementById('sizeSlider'),
                sliderValue: document.getElementById('sliderValue'),
                headingLabel: document.getElementById('headingLabel'),
                sheetNameText: document.getElementById('sheetNameText'),
                answerCount: document.getElementById('answerCount'),
                answerModalContainer: document.getElementById('answerModalContainer'),
                answerModalCloseBtn: document.getElementById('answerModalCloseBtn'),
                answerModalCard: document.getElementById('answerModalCard'),
                modalAnswer: document.getElementById('modalAnswer'),
                modalStudentName: document.getElementById('modalStudentName'),
                modalReactionButtons: document.getElementById('modalReactionButtons'),
                classFilter: document.getElementById('classFilter'),
                sortMode: document.getElementById('sortMode'),
                footer: document.getElementById('controlsFooter'),
                unpublishBtn: document.getElementById('unpublishBtn'),
            };
            
            this.state = {
                currentAnswers: [],
                isLoading: false,
                lastFocusedElement: null
            };
            
            this.pollingInterval = null;
            
            this.reactionTypes = [
                { key: 'UNDERSTAND', icon: 'lightbulb', label: 'なるほど！' },
                { key: 'LIKE', icon: 'thumb-up', label: 'いいね！' },
                { key: 'CURIOUS', icon: 'magnifying-glass-plus', label: 'もっと知りたい！' }
            ];

            this.gas = {
                getPublishedSheetData: (classFilter, sortMode, isAdmin) => this.runGas('getPublishedSheetData', classFilter, sortMode, isAdmin),
                addReaction: (rowIndex, reaction) => this.runGas('addReaction', rowIndex, reaction),
                toggleHighlight: (rowIndex) => this.runGas('toggleHighlight', rowIndex),
                unpublishApp: () => this.runGas('unpublishApp')
            };
            
            // GSAPの読み込み確認
            this.waitForGSAP().then(() => {
                this.init();
            });
        }

        // GSAPの読み込み確認
        waitForGSAP() {
            return new Promise((resolve) => {
                if (typeof gsap !== 'undefined') {
                    resolve();
                } else {
                    const checkGSAP = () => {
                        if (typeof gsap !== 'undefined') {
                            resolve();
                        } else {
                            setTimeout(checkGSAP, 100);
                        }
                    };
                    checkGSAP();
                }
            });
        }

        init() {
            this.renderIcons();
            this.setupEventListeners();
            this.adjustLayout();
            this.loadInitialData();
            this.setupAdminButton();
        }

        setupEventListeners() {
            this.elements.sizeSlider.addEventListener('input', this.debounce(() => this.renderBoard(true), 200));
            this.elements.answerModalCloseBtn.addEventListener('click', () => this.hideAnswerModal());
            this.elements.answerModalContainer.addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    this.hideAnswerModal();
                }
            });
            this.elements.classFilter.addEventListener('change', () => this.loadSheetData(true));
            this.elements.sortMode.addEventListener('change', () => this.loadSheetData(true));
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.hideAnswerModal();
                }
            });
            window.addEventListener('resize', this.debounce(() => this.adjustLayout(), 100));
        }

        adjustLayout() {
            const headerHeight = this.elements.header.offsetHeight;
            const footerHeight = this.elements.footer.offsetHeight;
            this.elements.mainContainer.style.paddingTop = headerHeight + 'px';
            this.elements.body.style.paddingBottom = (footerHeight + 20) + 'px';
        }

        runGas(funcName, ...args) {
            return new Promise((resolve, reject) => {
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        [funcName](...args);
                } else {
                    // デバッグ用のモックデータ
                    console.warn('Google Apps Script environment not detected. Using mock data.');
                    this.getMockData(funcName, ...args).then(resolve).catch(reject);
                }
            });
        }
        
        // デバッグ用のモックデータ生成（エラーハンドリング改善）
        getMockData(funcName, ...args) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    try {
                        if (funcName === 'getPublishedSheetData') {
                            resolve({
                                header: 'テスト問題',
                                sheetName: 'テストシート',
                                rows: [
                                    {
                                        rowIndex: 1,
                                        name: '田中太郎',
                                        class: '3年A組',
                                        opinion: 'これは素晴らしいアイデアだと思います。',
                                        reason: '理由は簡潔で分かりやすく、実現可能性が高いからです。',
                                        reactions: {
                                            UNDERSTAND: { count: 5, reacted: false },
                                            LIKE: { count: 2, reacted: false },
                                            CURIOUS: { count: 1, reacted: false }
                                        }
                                    },
                                    {
                                        rowIndex: 2,
                                        name: '佐藤花子',
                                        class: '3年B組',
                                        opinion: '少し改善の余地があると考えます。',
                                        reason: 'より多くの人の意見を聞く必要があると思います。',
                                        reactions: {
                                            UNDERSTAND: { count: 3, reacted: true },
                                            LIKE: { count: 0, reacted: false },
                                            CURIOUS: { count: 0, reacted: false }
                                        }
                                    }
                                ]
                            });
                        } else if (funcName === 'addReaction') {
                            resolve({
                                status: 'ok',
                                reaction: args[1] || 'UNDERSTAND',
                                newScore: Math.floor(Math.random() * 10) + 1
                            });
                        } else if (funcName === 'unpublishApp') {
                            resolve('unpublished');
                        } else {
                            reject(new Error('Unknown function: ' + funcName));
                        }
                    } catch (error) {
                        reject(error);
                    }
                }, 500);
            });
        }
        
        async loadInitialData() {
            await this.loadSheetData(true, true);
            if (this.pollingInterval) {
                clearInterval(this.pollingInterval);
            }
            this.pollingInterval = setInterval(() => this.loadSheetData(false), 15000);
        }

        async loadSheetData(showLoading = true, isInitialLoad = false) {
            if (this.state.isLoading && showLoading) return;
            this.state.isLoading = true;
            
            const selectedClass = isInitialLoad ? 'すべて' : this.elements.classFilter.value;
            const selectedSort = this.elements.sortMode.value;
            const oldAnswers = [...this.state.currentAnswers];

            if (showLoading) {
                this.elements.answersContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full mt-8">データを読み込み中...</p>';
            }
            
            try {
                const data = await this.gas.getPublishedSheetData(selectedClass, selectedSort, isAdmin);
                this.adjustLayout();
                
                if (isInitialLoad) {
                    this.populateClassFilter(data.rows);
                    this.elements.sheetNameText.textContent = 'シート: ' + data.sheetName;
                }

                const changed = JSON.stringify(this.state.currentAnswers) !== JSON.stringify(data.rows);
                this.state.currentAnswers = data.rows;
                this.elements.headingLabel.textContent = data.header || '問題';
                if (changed || oldAnswers.length === 0) {
                    this.renderBoard(false, oldAnswers);
                }
            } catch (error) {
                console.error('Error loading sheet data:', error);
                const errorMessage = this.escapeHtml(error.message || 'Unknown error');
                this.elements.answersContainer.innerHTML = 
                    '<div class="text-center text-red-400 col-span-full mt-8 p-4 bg-red-900/20 rounded-lg">' +
                    '<p class="font-bold">データの読み込みに失敗しました。</p>' +
                    '<p class="text-sm mt-2">' + errorMessage + '</p>' +
                    '<button id="retryLoadBtn" class="mt-4 game-btn bg-cyan-600 text-white px-4 py-2 rounded-lg font-bold border-cyan-800 hover:bg-cyan-500 text-sm">再試行</button>' +
                    '</div>';
                
                const retryBtn = document.getElementById('retryLoadBtn');
                if (retryBtn) {
                    retryBtn.addEventListener('click', () => this.loadInitialData());
                }
            } finally {
                this.state.isLoading = false;
            }
        }

        populateClassFilter(rows) {
            const classFilter = this.elements.classFilter;
            const uniqueClasses = ['すべて', ...new Set(rows.map(r => r.class).filter(Boolean))];
            classFilter.innerHTML = uniqueClasses.map(c => 
                '<option value="' + this.escapeHtml(c) + '">' + this.escapeHtml(c) + '</option>'
            ).join('');
            classFilter.value = 'すべて';
            classFilter.classList.remove('hidden');
        }

        renderBoard(isLayoutChange = false, oldRows = this.state.currentAnswers) {
            const container = this.elements.answersContainer;
            const newRows = this.state.currentAnswers;
            const oldRowsMap = new Map(oldRows.map(r => [String(r.rowIndex), r]));
            const oldPositions = new Map();
            
            container.querySelectorAll('.answer-card').forEach(card => {
                oldPositions.set(card.dataset.rowIndex, card.getBoundingClientRect());
            });

            this.elements.sliderValue.textContent = this.elements.sizeSlider.value;
            container.className = 'grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-' + this.elements.sizeSlider.value;
            
            const userIcon = this.getIcon('users', 'w-4 h-4 inline-block -mt-1');
            this.elements.answerCount.innerHTML = userIcon + '<span>' + newRows.length + '件</span>';
            
            const fragment = document.createDocumentFragment();
            if (newRows.length === 0) {
                const p = document.createElement('p');
                p.className = 'text-center text-gray-500 col-span-full mt-8';
                p.textContent = 'このクラスの回答はありません。';
                fragment.appendChild(p);
            } else {
                newRows.forEach(r => fragment.appendChild(this.createAnswerCard(r)));
            }
            
            container.innerHTML = '';
            container.appendChild(fragment);

            // GSAPアニメーション（安全な実行）
            if (typeof gsap !== 'undefined') {
                container.querySelectorAll('.answer-card').forEach((card) => {
                    const rowIndex = card.dataset.rowIndex;
                    const oldPos = oldPositions.get(rowIndex);
                    
                    if (isLayoutChange || !oldPos) {
                        gsap.from(card, { opacity: 0, y: 30, duration: 0.5, ease: 'power3.out' });
                    } else {
                        const newPos = card.getBoundingClientRect();
                        const deltaX = oldPos.left - newPos.left;
                        const deltaY = oldPos.top - newPos.top;
                        gsap.set(card, { opacity: 1 });
                        
                        if (Math.abs(deltaX) > 1 || Math.abs(deltaY) > 1) {
                            gsap.fromTo(card, 
                                { x: deltaX, y: deltaY }, 
                                { x: 0, y: 0, duration: 0.7, ease: 'power3.inOut' }
                            );
                        }
                        
                        const oldData = oldRowsMap.get(rowIndex);
                        const newData = newRows.find(r => String(r.rowIndex) === rowIndex);
                        const oldTotal = oldData ? Object.values(oldData.reactions || {}).reduce((s, r) => s + r.count, 0) : 0;
                        const newTotal = newData ? Object.values(newData.reactions || {}).reduce((s, r) => s + r.count, 0) : 0;
                        if (oldData && newData && oldTotal !== newTotal) {
                            gsap.fromTo(card,
                                { backgroundColor: 'rgba(250, 204, 21, 0.4)' },
                                { backgroundColor: 'rgba(26, 27, 38, 0.7)', duration: 0.8, ease: 'expo.out' }
                            );
                        }
                    }
                });
            }
        }

        createAnswerCard(data) {
            const card = document.createElement('div');
            const highlightClass = (isAdmin && data.highlight) ? ' highlighted' : '';
            card.className = 'answer-card relative glass-panel rounded-xl p-4 flex flex-col justify-between shadow-lg border-2 border-cyan-400/80 cursor-pointer opacity-0' + highlightClass;
            card.dataset.rowIndex = data.rowIndex;

            const active = this.reactionTypes
                .filter(rt => data.reactions && data.reactions[rt.key] && data.reactions[rt.key].count > 0)
                .map(rt => rt.key);
            if (active.length === 1) {
                if (active[0] === 'LIKE') card.classList.add('reaction-bg-like');
                if (active[0] === 'UNDERSTAND') card.classList.add('reaction-bg-understand');
                if (active[0] === 'CURIOUS') card.classList.add('reaction-bg-curious');
            } else if (active.length === 2) {
                card.classList.add('reaction-bg-mixed');
            } else if (active.length > 2) {
                card.classList.add('reaction-bg-all');
            }

            const totalReactions = Object.values(data.reactions || {}).reduce((s, r) => s + (r.count || 0), 0);
            if (totalReactions >= 5) {
                card.classList.add('reaction-popular');
            }

            const showCount = isAdmin;
            const reactionButtons = this.reactionTypes.map(rt => {
                const rData = data.reactions ? data.reactions[rt.key] || { count: 0, reacted: false } : { count: 0, reacted: false };
                const btnClass = rData.reacted ? 'liked' : '';
                    return '<button type="button" class="reaction-btn like-btn ' + btnClass + '" aria-label="' + rt.label + '" data-row-index="' + data.rowIndex + '" data-reaction="' + rt.key + '">' +
                    this.getIcon(rt.icon, 'w-5 h-5', rData.reacted) +
                    (showCount ? '<span class="reaction-count font-bold text-lg text-gray-200">' + rData.count + '</span>' : '') +
                    '</button>';
            }).join(' ');

            let highlightBtn = '';
            if (isAdmin) {
                const cls = data.highlight ? 'liked' : '';
                highlightBtn = '<button type="button" class="highlight-btn like-btn ' + cls + '" aria-label="Highlight" data-row-index="' + data.rowIndex + '">' +
                    this.getIcon('star', 'w-5 h-5') +
                    '</button>';
            }

            const badge = (isAdmin && data.highlight) ? '<span class="highlight-badge">' + this.getIcon('star', 'w-5 h-5 fill-yellow-400 stroke-yellow-400') + '</span>' : '';

            card.innerHTML =
                badge +
                '<div class="flex-grow mb-3 answer-preview">' +
                '<p class="opinion-text text-cyan-200 whitespace-pre-wrap break-words text-xl md:text-2xl font-semibold leading-tight">' +
                this.escapeHtml(data.opinion || '') + '</p>' +
                '<p class="text-gray-100 whitespace-pre-wrap break-words mt-4">' +
                this.escapeHtml(data.reason || '') + '</p>' +
                '</div>' +
                '<div class="text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex justify-between items-center">' +
                (isAdmin ? '<div><span class="font-bold text-sm text-gray-200">' + this.escapeHtml(data.name) + '</span></div>' : '<div></div>') +
                '<div class="flex gap-2">' + reactionButtons + (isAdmin ? highlightBtn : '') + '</div>' +
                '</div>'; 

            card.addEventListener('click', (e) => {
                const reaction = e.target.closest('.reaction-btn');
                const highlightButton = e.target.closest('.highlight-btn');
                if (reaction) {
                    e.stopPropagation();
                    this.handleReaction(data.rowIndex, reaction.dataset.reaction);
                } else if (highlightButton) {
                    e.stopPropagation();
                    this.handleHighlight(data.rowIndex);
                } else {
                    this.showAnswerModal(data.rowIndex);
                }
            });

            return card;
        }

        async handleReaction(rowIndex, reaction) {
            const btns = document.querySelectorAll('[data-row-index="' + rowIndex + '"][data-reaction="' + reaction + '"]');
            
            // GSAPアニメーション（安全な実行）
            if (typeof gsap !== 'undefined') {
                btns.forEach(btn => {
                    gsap.fromTo(btn,
                        { scale: 1 },
                        { scale: 1.3, yoyo: true, repeat: 1, duration: 0.2, ease: 'power2.inOut' }
                    );
                });
            }

            try {
                const res = await this.gas.addReaction(rowIndex, reaction);
                if (res && res.status === 'ok') {
                    const oldAnswers = [...this.state.currentAnswers];
                    const item = this.state.currentAnswers.find(i => i.rowIndex == rowIndex);
                    if (item && item.reactions && item.reactions[reaction]) {
                        const previous = this.reactionTypes
                            .filter(rt => rt.key !== reaction && item.reactions[rt.key] && item.reactions[rt.key].reacted);

                        const rData = item.reactions[reaction];
                        const wasReacted = rData.reacted;
                        rData.count = res.newScore;
                        rData.reacted = !wasReacted;

                        previous.forEach(rt => {
                            const pr = item.reactions[rt.key];
                            if (pr && pr.reacted) {
                                pr.reacted = false;
                                if (pr.count > 0) pr.count -= 1;
                                this.updateReactionButtonUI(rowIndex, rt.key, pr.count, false);
                            }
                        });

                        const total = Object.values(item.reactions).reduce((sum, r) => sum + r.count, 0);
                        item.score = item.reason.length * (1 + total * 0.05);

                        // 並び替え機能のロジックをここに統合
                        const mode = this.elements.sortMode.value;
                        if (mode === 'newest') {
                            this.state.currentAnswers.sort((a, b) => b.rowIndex - a.rowIndex);
                        } else if (mode === 'random') {
                            this.state.currentAnswers.sort(() => Math.random() - 0.5);
                        }

                        this.updateReactionButtonUI(rowIndex, reaction, rData.count, rData.reacted);
                        this.renderBoard(false, oldAnswers);
                    }
                } else if (res && res.message) {
                    alert(res.message);
                }
            } catch (error) {
                console.error('Failed to add reaction:', error);
            }
        }

        async handleHighlight(rowIndex) {
            try {
                const res = await this.gas.toggleHighlight(rowIndex);
                if (res && res.status === 'ok') {
                    const item = this.state.currentAnswers.find(i => i.rowIndex == rowIndex);
                    if (item) {
                        item.highlight = res.highlight;
                    }
                    this.renderBoard();
                } else if (res && res.message) {
                    alert(res.message);
                }
            } catch (error) {
                console.error('Failed to toggle highlight:', error);
            }
        }

        updateReactionButtonUI(rowIndex, reaction, count, reacted) {
            document.querySelectorAll('[data-row-index="' + rowIndex + '"][data-reaction="' + reaction + '"]').forEach(btn => {
                const countEl = btn.querySelector('.reaction-count');
                if (countEl) {
                    countEl.textContent = count;
                }
                const rt = this.reactionTypes.find(r => r.key === reaction);
                const svgEl = btn.querySelector('svg');
                if (svgEl && rt) {
                    svgEl.outerHTML = this.getIcon(rt.icon, svgEl.getAttribute('class') || 'w-5 h-5', reacted);
                }
                btn.classList.toggle('liked', reacted);
            });
        }
        
        showAnswerModal(rowIndex) {
            const data = this.state.currentAnswers.find(r => r.rowIndex == rowIndex);
            if (!data) return;
            
            this.state.lastFocusedElement = document.activeElement;
            
            this.elements.modalAnswer.innerHTML = 
                '<p class="text-cyan-200 whitespace-pre-wrap break-words text-3xl md:text-4xl font-bold leading-tight">' + 
                this.escapeHtml(data.opinion || '') + '</p>' +
                '<p class="text-gray-100 whitespace-pre-wrap break-words mt-6 text-xl">' +
                this.escapeHtml(data.reason || '') + '</p>';
                this.elements.modalStudentName.textContent = isAdmin ? data.name : '';

            const showCount = isAdmin;
            const reactionButtons = this.reactionTypes.map(rt => {
                const rData = data.reactions ? data.reactions[rt.key] || { count: 0, reacted: false } : { count: 0, reacted: false };
                const btnClass = rData.reacted ? 'liked' : '';
                    return '<button type="button" class="reaction-btn like-btn ' + btnClass + ' flex items-center gap-2 text-lg" aria-label="' + rt.label + '" data-row-index="' + data.rowIndex + '" data-reaction="' + rt.key + '">' +
                    this.getIcon(rt.icon, 'w-6 h-6', rData.reacted) +
                    (showCount ? '<span class="reaction-count font-bold text-xl text-gray-200">' + rData.count + '</span>' : '') +
                    '</button>';
            }).join('');
            
            this.elements.modalReactionButtons.innerHTML = reactionButtons;
            this.elements.modalReactionButtons.querySelectorAll('.reaction-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.handleReaction(btn.dataset.rowIndex, btn.dataset.reaction);
                });
            });

            this.elements.answerModalContainer.classList.remove('hidden');
            
            // GSAPアニメーション（安全な実行）
            if (typeof gsap !== 'undefined') {
                gsap.to(this.elements.answerModalContainer, { opacity: 1, duration: 0.3, ease: 'power2.inOut' });
                gsap.to(this.elements.answerModalCard, { scale: 1, duration: 0.3, ease: 'power2.inOut' });
            } else {
                this.elements.answerModalContainer.style.opacity = '1';
                this.elements.answerModalCard.style.transform = 'scale(1)';
            }

            this.elements.answerModalCloseBtn.focus();
        }

        hideAnswerModal() {
            // GSAPアニメーション（安全な実行）
            if (typeof gsap !== 'undefined') {
                gsap.to(this.elements.answerModalContainer, {
                    opacity: 0,
                    duration: 0.3,
                    ease: 'power2.inOut',
                    onComplete: () => this.elements.answerModalContainer.classList.add('hidden')
                });
                gsap.to(this.elements.answerModalCard, { scale: 0.95, duration: 0.3, ease: 'power2.inOut' });
            } else {
                this.elements.answerModalContainer.style.opacity = '0';
                this.elements.answerModalCard.style.transform = 'scale(0.95)';
                this.elements.answerModalContainer.classList.add('hidden');
            }

            if (this.state.lastFocusedElement) {
                this.state.lastFocusedElement.focus();
            }
        }
        
        setupAdminButton() {
            if (isAdmin) {
                this.elements.unpublishBtn.classList.remove('hidden');
                this.elements.unpublishBtn.addEventListener('click', async () => {
                    if (confirm('このシートの公開を終了しますか？')) {
                        try {
                            const result = await this.gas.unpublishApp();
                            if (result === 'unpublished') {
                                this.elements.mainContainer.innerHTML = '<div class="text-center p-8 glass-panel rounded-xl"><p class="text-xl">公開を終了しました。</p></div>';
                                this.elements.footer.remove();
                                if(this.pollingInterval) clearInterval(this.pollingInterval);
                            }
                        } catch (error) {
                            console.error('Unpublish failed:', error);
                            alert('公開終了に失敗しました: ' + error.message);
                        }
                    }
                });
            }
        }

        renderIcons() {
            this.elements.answerModalCloseBtn.innerHTML = this.getIcon('x', 'w-6 h-6');
            document.getElementById('footerIcon').innerHTML = this.getIcon('layout-grid', 'w-5 h-5');
        }

        getIcon(name, classes = 'w-6 h-6', solid = false) {
            const icons = {
                lightbulb: {
                    outline: '<svg class="' + classes + '" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6zM9 16.5h6v4H9v-4zm0 1h6zm0 1h6zM10.5 11l.5 2h2l.5-2m-3 1h3" /></svg>',
                    solid: '<svg class="' + classes + '" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6z M10.5 11.25 L11 13 L13 13 L13.5 11.25 H 10.5 Z" /><path d="M9 16.5h6v1H9z M9 18h6v1H9z M9 19.5h6v1H9z" /></svg>'
                },
                'thumb-up': {
                    outline: '<svg class="' + classes + '" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>',
                    solid: '<svg class="' + classes + '" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z M6.5 10v12h1V10h-1z" /></svg>'
                },
                'magnifying-glass-plus': {
                    outline: '<svg class="' + classes + '" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" /></svg>',
                    solid: '<svg class="' + classes + '" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z M9.75 7.5v2.25H7.5v1.5h2.25V13.5h1.5v-2.25H13.5v-1.5h-2.25V7.5h-1.5z" fill="currentColor" /><path d="M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15zM16.5 16.5l4.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /></svg>'
                },
                star: '<svg class="' + classes + '" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.539 1.118l-3.975-2.888a1 1 0 00-1.175 0l-3.976 2.888c-.783.57-1.838-.196-1.539-1.118l1.518-4.674a1 1 0 00-.363-1.118L2.05 10.1c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>',
                users: '<svg class="' + classes + '" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm6-6a3 3 0 100-6 3 3 0 000 6z" /></svg>',
                x: '<svg class="' + classes + '" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>',
                'layout-grid': '<svg class="' + classes + '" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>'
            };
            const icon = icons[name];
            if (!icon) return '';
            if (typeof icon === 'string') return icon;
            return solid ? icon.solid : icon.outline;
        }
        
        debounce(func, delay) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }
    }

    // アプリケーションの初期化
    document.addEventListener('DOMContentLoaded', () => {
        new StudyQuestApp();
    });
  </script>
</body>
</html>

