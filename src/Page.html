/**
 * イベント委譲の設定（パフォーマンスと安定性のための核心部分）
 * 個別のカードにイベントリスナーを追加する代わりに、親コンテナで一括処理します。
 */
setupEventDelegation() {
    // メインの回答コンテナでクリックイベントを待つ
    this.handlers.onAnswersContainerClick = (e) => {
        // 1. クリックされた要素から最も近い`.answer-card`を探す
        const answerCard = e.target.closest('.answer-card');
        if (!answerCard) return; // カード内でなければ何もしない

        // 2. カードのデータ属性（rowIndex）がなければ処理を中断
        const rowIndex = answerCard.dataset.rowIndex;
        if (!rowIndex) return;

        // 3. リアクションボタンがクリックされたか判定
        const reactionBtn = e.target.closest('.reaction-btn');
        if (reactionBtn) {
            e.stopPropagation(); // ★最重要：イベントがカード本体に伝わるのを防ぐ
            const reactionType = reactionBtn.dataset.reaction;
            if (reactionType) {
                this.handleReaction(rowIndex, reactionType);
            }
            return; // リアクション処理が完了したので、ここで処理を終了する
        }

        // 4. ハイライトボタンがクリックされたか判定
        const highlightBtn = e.target.closest('.highlight-btn');
        if (highlightBtn) {
            e.stopPropagation(); // ★最重要：同様にイベントの伝播を停止
            this.handleHighlight(rowIndex);
            return; // ハイライト処理が完了したので、ここで処理を終了する
        }

        // 5. 上記のいずれでもなければ、カード本体がクリックされたと判断
        this.showAnswerModal(rowIndex);
    };
    this.elements.answersContainer.addEventListener('click', this.handlers.onAnswersContainerClick);

    // キーボード操作も同様に委譲で一元管理することで、動作を統一
    this.handlers.onAnswersContainerKeydown = (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            const activeElement = document.activeElement;
            // ...フォーカスされている要素に応じて処理を分岐させる...
        }
    };
    this.elements.answersContainer.addEventListener('keydown', this.handlers.onAnswersContainerKeydown);
    }
  }
}

/**
 * フォームリンクを取得して表示する関数
 */
function loadFormLink() {
  google.script.run
    .withSuccessHandler(formInfo => {
      if (formInfo && formInfo.formUrl) {
        const formLinkBtn = document.getElementById('form-link-btn');
        if (formLinkBtn) {
          formLinkBtn.href = formInfo.formUrl;
          formLinkBtn.classList.remove('hidden');
        }
      }
    })
    .withFailureHandler(error => {
      console.warn('フォーム情報の取得に失敗しました:', error);
    })
    .getActiveFormInfo();
}

try {
  if (window.studyQuestApp && typeof window.studyQuestApp.destroy === 'function') {
    window.studyQuestApp.destroy();
  }
  window.studyQuestApp = new StudyQuestApp();
  
  // Expose debug functions globally for console access
  window.debugAnswerCards = () => {
    if (window.studyQuestApp && window.studyQuestApp.debugAnswerCards) {
      window.studyQuestApp.debugAnswerCards();
    } else {
      console.log('StudyQuestApp not available or debug function not found');
    }
  };
  
  // Enhanced global debug function with additional utility methods
  window.debugClickAnswerCard = (cardIndex = 0, options = {}) => {
    if (window.studyQuestApp && window.studyQuestApp.debugClickAnswerCard) {
      return window.studyQuestApp.debugClickAnswerCard(cardIndex, options);
    } else {
      console.log('StudyQuestApp not available or debug function not found');
      return { success: false, error: 'StudyQuestApp not available' };
    }
  };

  // Additional global debug utilities
  window.debugClickAllAnswerCards = (options = {}) => {
    if (!window.studyQuestApp) {
      console.log('StudyQuestApp not available');
      return { success: false, error: 'StudyQuestApp not available' };
    }
    
    const container = window.studyQuestApp.elements?.answersContainer;
    if (!container) {
      console.log('No answers container found');
      return { success: false, error: 'No answers container found' };
    }
    
    const answerCards = container.querySelectorAll('.answer-card');
    const results = [];
    
    console.log(`Found ${answerCards.length} answer cards, clicking all...`);
    
    for (let i = 0; i < answerCards.length; i++) {
      const result = window.studyQuestApp.debugClickAnswerCard(i, { 
        ...options, 
        logDetails: false // Reduce noise when clicking all cards
      });
      results.push(result);
      
      if (options.delay && i < answerCards.length - 1) {
        // Add delay between clicks if specified
        setTimeout(() => {}, options.delay);
      }
    }
    
    return {
      success: true,
      totalCards: answerCards.length,
      results
    };
  };

  window.debugGetAnswerCardInfo = (cardIndex = 0) => {
    if (!window.studyQuestApp) {
      console.log('StudyQuestApp not available');
      return { success: false, error: 'StudyQuestApp not available' };
    }
    
    const container = window.studyQuestApp.elements?.answersContainer;
    if (!container) {
      console.log('No answers container found');
      return { success: false, error: 'No answers container found' };
    }
    
    const answerCards = container.querySelectorAll('.answer-card');
    if (answerCards.length === 0) {
      console.log('No answer cards found');
      return { success: false, error: 'No answer cards found' };
    }
    
    if (cardIndex >= answerCards.length) {
      console.log('Card index out of bounds');
      return { success: false, error: 'Card index out of bounds', totalCards: answerCards.length };
    }
    
    const card = answerCards[cardIndex];
    const cardInfo = {
      index: cardIndex,
      className: card.className,
      dataset: { ...card.dataset },
      rowIndex: card.dataset.rowIndex,
      boundingRect: card.getBoundingClientRect(),
      computedStyle: {
        display: getComputedStyle(card).display,
        visibility: getComputedStyle(card).visibility,
        opacity: getComputedStyle(card).opacity
      },
      textContent: card.textContent.trim(),
      innerHTML: card.innerHTML
    };
    
    console.log('Answer card info:', cardInfo);
    return { success: true, cardInfo };
  };
  
  // ドメイン情報とフォームリンクを取得
  loadDomainInfo();
  loadFormLink();
  
  window.addEventListener('beforeunload', () => {
    if (window.studyQuestApp && typeof window.studyQuestApp.destroy === 'function') {
      window.studyQuestApp.destroy();
    }
  });
} catch (error) {
  console.error('Error creating StudyQuestApp instance:', error);
  const container = document.getElementById('answers');
  if (container) {
    const msg = StudyQuestApp.prototype.escapeHtml(error.message || '');
    container.innerHTML = '<div class="text-red-400 p-4">アプリケーションの初期化に失敗しました: ' + msg + '</div>';
  }
}
</script>
</body>
</html>
