<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>GenericBoard - みんなのかいとうボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <?!= include('SharedSecurityHeaders'); ?>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript><link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" /></noscript>
  <link rel="dns-prefetch" href="//script.google.com" />
  <link rel="preconnect" href="https://script.google.com" crossorigin />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
  <?!= include('SharedTailwindConfig'); ?>
  <style>
:root{--color-primary:#8be9fd;--color-primary-dark:#6272a4;--color-background:#1a1b26;--color-surface:rgba(26,27,38,0.7);--color-text:#c0caf5;--color-text-secondary:#6272a4;--color-text-muted:rgba(255,255,255,0.6);--color-border:rgba(255,255,255,0.1);--color-accent:#facc15;--color-success:#50fa7b;--color-warning:#ffb86c;--color-error:#ff5555;--duration-fast:0.2s;--duration-normal:0.3s;--duration-slow:0.5s;--ease-out:cubic-bezier(0.25,0.46,0.45,0.94);--ease-in-out:cubic-bezier(0.645,0.045,0.355,1);--border-radius:0.75rem;--border-radius-lg:1rem;--shadow-sm:0 1px 2px rgba(0,0,0,0.05);--shadow-md:0 4px 6px rgba(0,0,0,0.1);--shadow-lg:0 10px 15px rgba(0,0,0,0.1);--shadow-glow:0 0 15px var(--color-primary);--glass-bg:var(--color-surface);--glass-border:1px solid var(--color-border);--glass-blur:blur(12px);--transition-duration:0.2s;--transition-easing:ease-out;--animation-duration:0.3s;--backdrop-blur:12px}body{color:var(--color-text);background-color:var(--color-background);margin:0;overflow-x:hidden}.glass-panel{background:var(--glass-bg);-webkit-backdrop-filter:var(--glass-blur);backdrop-filter:var(--glass-blur);border:var(--glass-border);transition:border-color var(--transition-duration) var(--transition-easing)}.glass-panel:hover{border-color:rgba(255,255,255,0.2)}.interactive-element{transition:all var(--duration-fast) var(--ease-out);border-radius:var(--border-radius)}.game-font{font-family:'Press Start 2P',cursive}.game-btn{transition:all var(--duration-fast) var(--ease-out);border-radius:var(--border-radius);border-bottom-width:4px;text-shadow:1px 1px 2px rgba(0,0,0,0.4);position:relative;overflow:hidden}.game-btn:not(:disabled):hover{transform:translateY(-2px) scale(1.02);box-shadow:var(--shadow-glow)}.game-btn:active:not(:disabled){transform:translateY(2px);border-bottom-width:2px;box-shadow:none}.game-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none!important}#classFilter,#sortOrder{background-color:var(--color-primary-dark);border:var(--glass-border);color:var(--color-text);border-radius:var(--border-radius);padding:0.25rem 0.5rem;transition:border-color var(--transition-duration) var(--transition-easing),box-shadow var(--transition-duration) var(--transition-easing)}#classFilter:focus,#sortOrder:focus{border-color:rgba(6,182,212,0.5);box-shadow:0 0 0 2px rgba(6,182,212,0.2);outline:none}:focus-visible{outline:3px solid var(--color-primary);outline-offset:2px;border-radius:var(--border-radius)}header{position:sticky;top:0;z-index:50;contain:layout;-webkit-backdrop-filter:blur(var(--backdrop-blur));backdrop-filter:blur(var(--backdrop-blur))}.line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}@media (min-width:768px) and (max-width:1023px){#headingLabel{font-size:1.25rem!important}}#formAnswerBtn{transition:all 0.2s ease-out}#formAnswerBtn:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.15)}#answerCount{transition:background-color 0.2s ease-out}#answerCount:hover{background-color:rgba(55,65,81,0.5)}.answer-card{will-change:transform,opacity;transition:all var(--duration-normal) var(--ease-out);border-radius:var(--border-radius-lg);contain:layout style;position:relative;overflow:hidden}.answer-card.highlighted{border:4px solid transparent;border-image:none!important;box-shadow:0 0 15px rgba(250,204,21,0.6);transform:scale(1.02);z-index:2;background:linear-gradient(var(--glass-bg),var(--glass-bg)) padding-box,linear-gradient(90deg,var(--color-accent),var(--color-primary)) border-box;background-clip:padding-box,border-box;position:relative}.answer-card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 8px 25px rgba(139,233,253,0.3)}.answer-card:focus-visible{transform:translateY(-4px) scale(1.02);box-shadow:0 8px 25px rgba(139,233,253,0.3)}.answer-card.highlighted:hover{transform:translateY(-4px) scale(1.04)}.answer-card.loading{opacity:0.7;pointer-events:none}.reaction-btn{transition:transform var(--transition-duration) var(--transition-easing),background-color var(--transition-duration) var(--transition-easing),box-shadow var(--transition-duration) var(--transition-easing);position:relative;overflow:hidden}.reaction-btn:hover{transform:scale(1.1)}.reaction-btn:active{transform:scale(0.95)}.reaction-btn.reacted{background-color:var(--color-primary)!important;color:#000!important;box-shadow:0 0 10px rgba(139,233,253,0.5)}.reaction-btn.liked{background-color:var(--color-primary)!important;color:#000!important;box-shadow:0 0 10px rgba(139,233,253,0.5)}.reaction-btn.loading{opacity:0.6;pointer-events:none}.fade-in{animation:fadeIn 0.5s ease-out}.slide-in{animation:slideIn 0.3s ease-out}.pulse{animation:pulse 0.6s ease-out}.shake{animation:shake 0.5s ease-out}.admin-toggle{transition:background-color var(--animation-duration) var(--transition-easing);-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px)}.admin-toggle:hover{background-color:rgba(139,233,253,0.1)}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(26,27,38,0.8);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000}.spinner{width:40px;height:40px;border:4px solid rgba(139,233,253,0.3);border-top:4px solid var(--color-primary);border-radius:50%;animation:spin 1s linear infinite}@keyframes fadeIn{from{opacity:0;will-change:opacity}to{opacity:1}}@keyframes slideIn{from{opacity:0;will-change:opacity}to{opacity:1}}@keyframes pulse{0%{will-change:transform}50%{transform:scale3d(1.05,1.05,1)}100%{transform:scale3d(1,1,1)}}@keyframes shake{0%,100%{will-change:transform}25%{transform:translate3d(-5px,0,0)}75%{transform:translate3d(5px,0,0)}}@keyframes spin{100%{transform:rotate(360deg);will-change:transform}}@keyframes bounce{0%,20%,50%,80%,100%{transform:translate(-50%,0) translateY(0)}40%{transform:translate(-50%,0) translateY(-10px)}60%{transform:translate(-50%,0) translateY(-5px)}}@media (min-resolution:120dpi) and (min-width:1200px){:root{--transition-duration:0.15s;--animation-duration:0.2s}}@media (prefers-contrast:high){:root{--color-border:rgba(255,255,255,0.3);--color-surface:rgba(26,27,38,0.98)}}@media (prefers-reduced-motion:reduce){:root{--transition-duration:0.01ms;--animation-duration:0.01ms;--backdrop-blur:0px}*,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important;transform:none!important}.answer-card:hover,.reaction-btn:hover,.game-btn:hover{transform:none!important}}.highlight-badge{position:absolute;top:0.25rem;right:0.25rem;width:1.5rem;height:1.5rem;display:flex;align-items:center;justify-content:center;color:#facc15;filter:drop-shadow(0 0 4px rgba(250,204,21,0.7))}.answer-card.reaction-bg-like{border-color:#ef4444!important;border-image:none!important}.answer-card.reaction-bg-understand{border-color:#fbbf24!important;border-image:none!important}.answer-card.reaction-bg-curious{border-color:#10b981!important;border-image:none!important}.reaction-bg-like-understand,.reaction-bg-like-curious,.reaction-bg-understand-curious,.reaction-bg-all{border-color:transparent;border-style:solid;background:var(--glass-bg);border-image-slice:1;border-image-source:linear-gradient(90deg,#ef4444,#fbbf24)}.reaction-bg-like-curious{border-image-source:linear-gradient(90deg,#ef4444,#10b981)}.reaction-bg-understand-curious{border-image-source:linear-gradient(90deg,#fbbf24,#10b981)}.reaction-bg-all{border-image-source:linear-gradient(90deg,#ef4444,#fbbf24,#10b981)}.reaction-border-1{border-width:2px}.reaction-border-2{border-width:4px}.reaction-border-3{border-width:6px}.answer-preview{display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;min-height:120px}.highlight-btn{transition:all 0.2s ease;border-radius:4px;padding:2px}.highlight-btn:hover{background:rgba(250,204,21,0.1);transform:scale(1.1)}.highlight-btn.liked{color:#facc15;filter:drop-shadow(0 0 4px rgba(250,204,21,0.7))}#controlsFooter{pointer-events:none}#controlsFooter>.glass-panel{pointer-events:auto}.skeleton{position:relative;overflow:hidden;background-color:rgba(255,255,255,0.05);color:transparent}.skeleton::after{content:"";position:absolute;inset:0;background-image:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,0.3),rgba(255,255,255,0));animation:skeleton-loading 1.2s infinite}@keyframes skeleton-loading{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans">
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="text-center">
      <div class="spinner"></div>
      <p class="mt-4 text-gray-300">読み込み中...</p>
    </div>
  </div>

  <div id="main-container" class="w-full mx-auto px-4 pt-4 pb-4 md:px-6 md:pt-6 md:pb-6">
    <header id="main-header" class="glass-panel rounded-xl p-4 mb-4 shadow-lg fade-in">
      <div class="flex items-center justify-between gap-4 py-2">
        <div class="flex items-center gap-3">
          <div id="answerCount" class="text-sm text-gray-400 flex items-center gap-2 flex-shrink-0">
            <span class="w-4 h-4 text-blue-400">👥</span>
            <span id="answerCountText">0件</span>
          </div>
          <a id="formAnswerBtn" href="#" target="_blank" rel="noopener noreferrer" class="text-xs bg-green-600 hover:bg-green-700 text-white font-medium px-3 py-1.5 rounded-md whitespace-nowrap transition-all flex items-center gap-1.5 shadow-sm no-underline" aria-label="フォームで回答" role="button">
            <span class="w-3 h-3">✏️</span>
            フォームで回答
          </a>
          <div class="flex items-center gap-2">
            <label for="classFilter" class="sr-only">クラス絞り込み</label>
            <select id="classFilter" class="hidden text-sm bg-gray-800/50 border border-gray-600 text-gray-300 px-3 py-1.5 rounded-md"></select>
            <label for="sortOrder" class="sr-only">並び順</label>
            <div class="relative">
              <select id="sortOrder" class="text-sm bg-gray-800/50 border border-gray-600 text-gray-300 px-3 py-1.5 pr-8 rounded-md appearance-none cursor-pointer focus:ring-2 focus:ring-cyan-400/50">
                <option value="newest" selected>新着順</option>
                <option value="random">ランダム順</option>
                <option value="score" id="scoreOption" class="hidden">スコア順</option>
              </select>
              <span class="absolute right-2 top-1/2 transform -translate-y-1/2 w-3 h-3 text-gray-400 pointer-events-none">▼</span>
            </div>
          </div>
        </div>
        <div class="flex-1 flex justify-center"></div>
        <div class="flex items-center gap-2">
          <div id="boardOwnerDisplay" class="text-xs text-gray-500 bg-gray-800/40 backdrop-blur-sm px-2.5 py-1 rounded-md flex items-center gap-1.5">
            <span class="w-3 h-3">👤</span>
            <span>ID: <?= userInfo.userId ? userInfo.userId.substring(0,8) + '...' : 'ID_NOT_SET' ?></span>
          </div>
          <button type="button" id="adminToggleBtn" class="admin-toggle text-gray-400 hover:text-cyan-400 transition-all p-1.5 rounded-md hover:bg-gray-800/50 hidden" aria-label="管理者モード切り替え">
            <span class="w-3 h-3">⚙️</span>
          </button>
          <button type="button" id="endPublicationBtn" class="admin-toggle text-xs bg-orange-600/80 hover:bg-orange-600 text-white px-3 py-1.5 rounded-md hidden whitespace-nowrap transition-all flex items-center gap-1" hidden aria-label="公開終了">
            <span class="w-3 h-3">🚫</span>
            公開終了
          </button>
        </div>
      </div>
      <div class="border-t border-transparent pt-4">
        <div class="flex justify-center">
          <div id="headingLabel" class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold text-pink-400 leading-tight flex justify-center items-center min-h-[2rem] text-center max-w-4xl line-clamp-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
            <span class="w-5 h-5 md:w-6 md:h-6 animate-spin">🔄</span>
            <span class="animate-pulse ml-2">問題文を読み込み中...</span>
          </div>
        </div>
      </div>
    </header>

    <div id="newContentBanner" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-full shadow-lg hidden transition-all duration-300" role="alert" aria-live="polite">
      <div class="flex items-center gap-3">
        <span id="newContentIcon" class="w-5 h-5 animate-pulse" aria-hidden="true">📋</span>
        <span id="newContentText">新しい意見が投稿されました</span>
        <button type="button" id="refreshContentBtn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full text-sm font-medium transition-colors" aria-label="新しいコンテンツを更新して表示">更新して表示</button>
        <button type="button" id="dismissBannerBtn" class="text-white/70 hover:text-white w-5 h-5 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors" aria-label="通知を閉じる">×</button>
      </div>
    </div>

    <main id="answers" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" role="main" aria-live="polite" aria-label="回答一覧"></main>
  </div>

  <div id="answerModalContainer" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true">
    <div id="answerModalCard" class="glass-panel rounded-xl p-6 flex flex-col shadow-2xl border-2 border-cyan-400/80 w-full max-w-5xl h-auto max-h-[85vh] relative" role="document" aria-labelledby="modalAnswer">
      <button type="button" id="answerModalCloseBtn" class="modal-close-btn bg-red-600 rounded-full p-2 text-white hover:scale-110 transition-transform z-10 absolute -top-3 -right-3" aria-label="閉じる">
        <span class="w-6 h-6 flex items-center justify-center">✕</span>
      </button>
      <div id="modalAnswer" class="flex-grow min-h-[200px] mb-4 overflow-y-auto pr-4"></div>
      <div id="modalFooter" class="text-xs text-gray-400 pt-4 border-t-2 border-dashed border-cyan-400/80 flex justify-between items-center">
        <div><span id="modalStudentName" class="font-bold text-2xl text-gray-200"></span></div>
        <div id="modalReactions" class="flex items-center gap-2"></div>
      </div>
    </div>
  </div>

  <div id="infoModalContainer" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true">
    <div id="infoModalCard" class="glass-panel rounded-xl p-6 shadow-2xl border-2 border-cyan-400/80 w-full max-w-lg relative" role="document">
      <div class="space-y-4 text-gray-200 text-lg leading-relaxed">
        <p>みんなの意見を気持ちよく共有するために、リアクションのしかたをおぼえよう！</p>
        <ul class="space-y-2">
          <li class="flex items-center gap-2">
            <span class="w-5 h-5 text-red-400">❤️</span>
            いいね：すてきだと思ったときに押そう
          </li>
          <li class="flex items-center gap-2">
            <span class="w-5 h-5 text-yellow-400">💡</span>
            なるほど：参考になったときに押そう
          </li>
          <li class="flex items-center gap-2">
            <span class="w-5 h-5 text-green-400">🤔</span>
            きになる：もっと知りたいときに押そう
          </li>
        </ul>
        <p class="flex items-center gap-2">
          <span class="w-5 h-5 text-purple-400">⭐</span>
          先生が注目してほしい意見につけています
        </p>
        <p>責任あるリアクションで、みんなで学びを深めよう！</p>
        <div class="text-center mt-6">
          <button id="infoModalConfirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">わかった</button>
        </div>
      </div>
    </div>
  </div>

  <footer id="controlsFooter" class="fixed bottom-0 left-0 right-0 z-40 p-4">
    <div class="glass-panel max-w-md mx-auto rounded-xl p-3 flex items-center justify-center gap-3">
      <input type="range" id="sizeSlider" min="2" max="6" value="4" class="w-1/2" aria-label="表示列数の変更" />
      <div class="flex items-center gap-1">
        <span id="sliderValue" class="font-bold text-lg">4</span>
        <span id="iconGrid" class="w-4 h-4 flex items-center justify-center">⊞</span>
      </div>
      <button type="button" id="modeToggleBtn" class="ml-4 px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm" title="プレビューモード切り替え">切替</button>
    </div>
  </footer>

  <script>
    // 🎯 統合最適化設定 - 全設定を一元化
    const CONFIG = Object.freeze({
      USER_ID: '<?= typeof userInfo !== "undefined" && userInfo && userInfo.userId ? userInfo.userId : "" ?>',
      SHEET_NAME: '<?= typeof sheetName !== "undefined" && sheetName ? sheetName : "" ?>',
      OPINION_HEADER: '<?= typeof __OPINION_HEADER__ !== "undefined" && __OPINION_HEADER__ ? __OPINION_HEADER__ : "お題" ?>',
      IS_OWNER: <?= isOwner ? true : false ?>,
      DISPLAY_MODES: Object.freeze({
        ANONYMOUS: 'anonymous',
        NAMED: 'named',
        EMAIL: 'email'
      }),
      PERFORMANCE: Object.freeze({
        BUDGET: 16,
        ANIMATION_DURATION: 300,
        DEBOUNCE_DELAY: 150
      }),
      DEBUG_MODE: false,
      CACHE: Object.freeze({
        TTL: 300000,
        MAX_SIZE: 100
      }),
      POLLING: Object.freeze({
        INTERVAL: 5000,
        MAX_RETRIES: 3
      }),
      DEFAULT_MODE: Object.freeze({
        isStudentMode: true,
        showCounts: false,
        showAdminFeatures: false,
        showHighlightToggle: false,
        showScoreSort: false,
        showPublishControls: false,
        displayMode: 'anonymous'
      }),
      ADMIN_MODE: Object.freeze({
        isStudentMode: false,
        showCounts: true,
        showAdminFeatures: true,
        showHighlightToggle: true,
        showScoreSort: true,
        showPublishControls: true,
        displayMode: 'named'
      })
    });

    // 🚀 アイコンライブラリ（絵文字使用）
    const ICONS = Object.freeze({
      'lightbulb': '💡',
      'hand-thumb-up': '❤️',
      'magnifying-glass-plus': '🤔',
      'star': '⭐',
      'grid-2x2': '⊞',
      'users': '👥'
    });

    // 🚀 高速化ユーティリティ - 1箇所に統合
    const Utils = {
      cache: new Map(),
      
      memoize(fn, ttl = CONFIG.CACHE.TTL) {
        const cache = new Map();
        return function(...args) {
          const key = JSON.stringify(args);
          const cached = cache.get(key);
          if (cached && Date.now() - cached.timestamp < ttl) {
            return cached.value;
          }
          const result = fn.apply(this, args);
          cache.set(key, { value: result, timestamp: Date.now() });
          if (cache.size > CONFIG.CACHE.MAX_SIZE) {
            const firstKey = cache.keys().next().value;
            cache.delete(firstKey);
          }
          return result;
        };
      },

      debounce(fn, delay = CONFIG.PERFORMANCE.DEBOUNCE_DELAY) {
        let timeoutId;
        return function(...args) {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => fn.apply(this, args), delay);
        };
      },

      throttle(fn, limit = CONFIG.PERFORMANCE.BUDGET) {
        let inThrottle;
        return function(...args) {
          if (!inThrottle) {
            fn.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      },

      sanitizeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      },

      getIcon(name, classes = '', solid = false) {
        const icon = ICONS[name] || '⭐';
        return '<span class="' + classes + '">' + icon + '</span>';
      },

      logDebug(...args) {
        if (CONFIG.DEBUG_MODE) console.log(...args);
      },

      logError(error, context = '') {
        console.error(`❌ ${context}:`, error);
      },

      isPreviewMode() {
        return window.location.protocol === 'file:' || 
               window.location.hostname === 'localhost' || 
               window.location.pathname.includes('preview') ||
               window.location.href.includes('preview');
      }
    };

    // 🎯 統合アプリケーション - 完全最適化版
    class GenericBoardApp {
      constructor() {
        this.state = {
          answers: [],
          filteredAnswers: [],
          currentFilter: 'all',
          currentSort: 'newest',
          gridColumns: 4,
          isPolling: false,
          isLoading: false,
          cache: new Map(),
          isStudentMode: true,
          showCounts: false,
          showAdminFeatures: false,
          showHighlightToggle: false,
          showScoreSort: false,
          displayMode: 'anonymous',
          isAdminUser: false,
          serverShowDetails: false,
          lastFocusedElement: null
        };
        
        this.elements = {};
        this.eventListeners = [];
        this.gsapTimelines = new Set();
        this.pollingInterval = null;
        this.handlers = {};
        this.cache = new Map();
        
        this.reactionTypes = [
          { key: 'LIKE', icon: 'hand-thumb-up' },
          { key: 'UNDERSTAND', icon: 'lightbulb' },
          { key: 'CURIOUS', icon: 'magnifying-glass-plus' }
        ];

        this.init();
      }

      init() {
        this.cacheElements();
        this.initializeMode();
        this.setupEventListeners();
        this.waitForGSAP().then(() => {
          this.verifyAdmin();
          this.adjustLayout();
          this.loadInitialData();
          this.setupInitialModeButton();
          this.updateSortOptions();
          if (!localStorage.getItem('introSeen')) {
            this.showInfoModal();
          }
        });
        Utils.logDebug('🚀 GenericBoardApp initialized');
      }

      initializeMode() {
        const targetMode = Utils.isPreviewMode() && window.location.hash === '#admin' ? 
                          CONFIG.ADMIN_MODE : CONFIG.DEFAULT_MODE;
        Object.assign(this.state, targetMode);
      }

      cacheElements() {
        const selectors = [
          'answers', 'headingLabel', 'answerCount', 'answerCountText', 
          'formAnswerBtn', 'classFilter', 'sortOrder', 'sizeSlider', 'sliderValue',
          'adminToggleBtn', 'endPublicationBtn', 'answerModalContainer', 
          'answerModalCard', 'answerModalCloseBtn', 'modalAnswer', 'modalStudentName', 
          'modalReactions', 'newContentBanner', 'refreshContentBtn', 'dismissBannerBtn',
          'infoModalContainer', 'infoModalCard', 'infoModalConfirmBtn', 'modeToggleBtn',
          'iconGrid', 'controlsFooter', 'mainContainer', 'loadingOverlay'
        ];
        
        selectors.forEach(id => {
          this.elements[id] = document.getElementById(id);
        });

        // 保存された列数をロード
        const savedCols = localStorage.getItem('boardColumns');
        if (savedCols && this.elements.sizeSlider && this.elements.sliderValue) {
          this.elements.sizeSlider.value = savedCols;
          this.elements.sliderValue.textContent = savedCols;
        }
      }

      waitForGSAP() {
        return new Promise(resolve => {
          if (typeof gsap !== 'undefined') {
            resolve();
          } else {
            const checkGSAP = setInterval(() => {
              if (typeof gsap !== 'undefined') {
                clearInterval(checkGSAP);
                resolve();
              }
            }, 50);
          }
        });
      }

      setupEventListeners() {
        const debouncedRender = Utils.debounce(() => this.renderBoard(true), CONFIG.PERFORMANCE.DEBOUNCE_DELAY);
        
        // スライダー
        if (this.elements.sizeSlider) {
          this.handlers.onSizeSliderInput = () => {
            localStorage.setItem('boardColumns', this.elements.sizeSlider.value);
            debouncedRender();
          };
          this.elements.sizeSlider.addEventListener('input', this.handlers.onSizeSliderInput);
        }

        // イベント委譲
        this.setupEventDelegation();

        // モーダル関連
        if (this.elements.answerModalCloseBtn) {
          this.handlers.onAnswerModalCloseClick = () => this.hideAnswerModal();
          this.elements.answerModalCloseBtn.addEventListener('click', this.handlers.onAnswerModalCloseClick);
        }

        if (this.elements.answerModalContainer) {
          this.handlers.onAnswerModalContainerClick = (e) => {
            if (e.target === e.currentTarget) this.hideAnswerModal();
          };
          this.elements.answerModalContainer.addEventListener('click', this.handlers.onAnswerModalContainerClick);
        }

        if (this.elements.infoModalConfirmBtn) {
          this.handlers.onInfoModalConfirmClick = () => this.hideInfoModal();
          this.elements.infoModalConfirmBtn.addEventListener('click', this.handlers.onInfoModalConfirmClick);
        }

        // フィルター・ソート
        if (this.elements.classFilter) {
          this.handlers.onClassFilterChange = () => this.loadSheetData(true);
          this.elements.classFilter.addEventListener('change', this.handlers.onClassFilterChange);
        }

        if (this.elements.sortOrder) {
          this.handlers.onSortOrderChange = () => this.loadSheetData(true);
          this.elements.sortOrder.addEventListener('change', this.handlers.onSortOrderChange);
        }

        // 管理者トグル
        if (this.elements.adminToggleBtn) {
          this.handlers.onAdminToggleClick = () => this.toggleAdminMode();
          this.elements.adminToggleBtn.addEventListener('click', this.handlers.onAdminToggleClick);
        }

        // モードトグル（プレビューのみ）
        if (this.elements.modeToggleBtn) {
          this.handlers.onModeToggleClick = () => this.togglePreviewMode();
          this.elements.modeToggleBtn.addEventListener('click', this.handlers.onModeToggleClick);
        }

        // キーボード・リサイズ
        this.handlers.onDocumentKeydown = (e) => {
          if (e.key === 'Escape') this.hideAnswerModal();
        };
        document.addEventListener('keydown', this.handlers.onDocumentKeydown);

        this.handlers.onWindowResize = Utils.debounce(() => this.adjustLayout(), 100);
        window.addEventListener('resize', this.handlers.onWindowResize);

        // 可視性変更
        this.handlers.onVisibilityChange = () => {
          if (document.hidden) {
            this.stopPolling();
          } else {
            this.startPolling();
          }
        };
        document.addEventListener('visibilitychange', this.handlers.onVisibilityChange);
      }

      setupEventDelegation() {
        if (!this.elements.answers) return;

        this.handlers.onAnswersContainerClick = (e) => {
          const answerCard = e.target.closest('.answer-card');
          if (!answerCard) return;

          const rowIndex = answerCard.dataset.rowIndex;
          if (!rowIndex) return;

          const reactionBtn = e.target.closest('.reaction-btn');
          if (reactionBtn) {
            e.stopPropagation();
            const reactionType = reactionBtn.dataset.reaction;
            if (reactionType) {
              this.handleReaction(rowIndex, reactionType);
            }
            return;
          }

          const highlightBtn = e.target.closest('.highlight-btn');
          if (highlightBtn) {
            e.stopPropagation();
            this.handleHighlight(rowIndex);
            return;
          }

          this.showAnswerModal(rowIndex);
        };
        this.elements.answers.addEventListener('click', this.handlers.onAnswersContainerClick);

        this.handlers.onAnswersContainerKeydown = (e) => {
          const answerCard = e.target.closest('.answer-card');
          if (!answerCard) return;

          const rowIndex = answerCard.dataset.rowIndex;
          if (!rowIndex) return;

          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            
            const focusedBtn = document.activeElement;
            if (focusedBtn.matches('.reaction-btn')) {
              const reactionType = focusedBtn.dataset.reaction;
              if (reactionType) {
                this.handleReaction(rowIndex, reactionType);
              }
              return;
            }
            
            if (focusedBtn.matches('.highlight-btn')) {
              this.handleHighlight(rowIndex);
              return;
            }
            
            this.showAnswerModal(rowIndex);
          }
        };
        this.elements.answers.addEventListener('keydown', this.handlers.onAnswersContainerKeydown);

        // バナー
        this.handlers.onDocumentClick = (e) => {
          if (e.target.matches('#refreshContentBtn')) {
            e.preventDefault();
            this.refreshData();
            return;
          }
          if (e.target.matches('#dismissBannerBtn')) {
            this.hideBanner();
            return;
          }
          if (e.target.matches('#retryLoadBtn')) {
            e.preventDefault();
            this.loadInitialData();
            return;
          }
        };
        document.addEventListener('click', this.handlers.onDocumentClick);
      }

      adjustLayout() {
        // レイアウト調整ロジック（省略可能）
      }

      async verifyAdmin() {
        try {
          const ok = await this.runGas('checkAdmin');
          if (ok && this.elements.adminToggleBtn) {
            this.state.isAdminUser = true;
            this.elements.adminToggleBtn.classList.remove('hidden');
            this.elements.adminToggleBtn.removeAttribute('hidden');
            this.elements.adminToggleBtn.textContent = this.state.showAdminFeatures ? '閲覧モード' : '管理モード';
          }
        } catch (e) {
          Utils.logError(e, 'Admin check');
        }
      }

      async loadInitialData() {
        Utils.logDebug('loadInitialData started');
        await this.loadSheetData(true, true);
        this.startPolling();
      }

      async loadSheetData(showLoading = true, isInitialLoad = false) {
        Utils.logDebug('loadSheetData called', { showLoading, isInitialLoad });
        if (this.state.isLoading && showLoading) return;
        
        this.state.isLoading = true;
        const selectedClass = isInitialLoad ? 'すべて' : this.elements.classFilter?.value || 'すべて';
        const sortOrder = this.elements.sortOrder?.value || 'newest';
        
        if (showLoading) {
          this.showSkeletons();
        }
        
        try {
          Utils.logDebug('Calling getPublishedSheetData with:', { selectedClass, sortOrder });
          const data = await this.runGas('getPublishedSheetData', selectedClass, sortOrder);
          Utils.logDebug('Received data:', data);
          
          if (data.opinionHeader || data.header) {
            this.updateHeader(data.opinionHeader || data.header);
          }
          
          if (data.answers || data.rows) {
            this.state.answers = data.answers || data.rows || [];
            this.filterAndSortAnswers();
            this.renderAnswers();
            this.updateAnswerCount();
          }

          if (data.formUrl && this.elements.formAnswerBtn) {
            this.elements.formAnswerBtn.href = data.formUrl;
          }

          if (isInitialLoad && (data.answers || data.rows)) {
            this.populateClassFilter(data.answers || data.rows);
          }
          
        } catch (error) {
          Utils.logError(error, 'Loading sheet data');
          this.showError(error.message || 'データの読み込みに失敗しました');
        } finally {
          this.state.isLoading = false;
        }
      }

      showSkeletons() {
        if (!this.elements.answers) return;
        const count = parseInt(this.elements.sizeSlider?.value || '4', 10) * 2;
        const frag = document.createDocumentFragment();
        for (let i = 0; i < count; i++) {
          frag.appendChild(this.createSkeletonCard());
        }
        this.elements.answers.innerHTML = '';
        this.elements.answers.appendChild(frag);
      }

      showError(message) {
        if (!this.elements.answers) return;
        this.elements.answers.innerHTML =
          '<div class="text-center text-red-400 col-span-full mt-8 p-4 bg-red-900/20 rounded-lg">' +
          '<p class="font-bold">データの読み込みに失敗しました。</p>' +
          '<p class="text-sm mt-2">' + Utils.sanitizeHtml(message) + '</p>' +
          '<button id="retryLoadBtn" class="mt-4 game-btn bg-cyan-600 text-white px-4 py-2 rounded-lg font-bold border-cyan-800 hover:bg-cyan-500 text-sm">再試行</button>' +
          '</div>';
      }

      updateHeader(text) {
        if (this.elements.headingLabel) {
          this.elements.headingLabel.innerHTML = '<span class="text-gradient">' + Utils.sanitizeHtml(text) + '</span>';
        }
      }

      filterAndSortAnswers() {
        let filtered = [...this.state.answers];
        
        if (this.state.currentFilter !== 'all') {
          filtered = filtered.filter(answer => 
            answer.class === this.state.currentFilter
          );
        }

        switch (this.state.currentSort) {
          case 'newest':
            filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            break;
          case 'random':
            filtered.sort(() => Math.random() - 0.5);
            break;
          case 'score':
            filtered.sort((a, b) => this.calculateScore(b) - this.calculateScore(a));
            break;
        }

        this.state.filteredAnswers = filtered;
      }

      calculateScore(answer) {
        const reactions = answer.reactions || {};
        return Object.values(reactions).reduce((sum, count) => sum + count, 0);
      }

      renderAnswers() {
        if (!this.elements.answers) return;
        
        const fragment = document.createDocumentFragment();
        
        this.state.filteredAnswers.forEach((answer, index) => {
          const card = this.createAnswerCard(answer, index);
          fragment.appendChild(card);
        });

        this.elements.answers.innerHTML = '';
        this.elements.answers.appendChild(fragment);
        
        this.animateCards();
      }

      renderBoard(isLayoutChange = false) {
        if (!this.elements.answers) return;
        
        this.elements.answers.querySelectorAll('.skeleton').forEach(el => el.remove());
        this.elements.sliderValue.textContent = this.elements.sizeSlider?.value || '4';
        
        const columns = parseInt(this.elements.sizeSlider?.value || '4', 10);
        const gridClasses = {
          2: 'grid-cols-1 sm:grid-cols-2',
          3: 'grid-cols-1 sm:grid-cols-2 md:grid-cols-3',
          4: 'grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4',
          5: 'grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5',
          6: 'grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6'
        };

        this.elements.answers.className = 'grid gap-4 ' + (gridClasses[columns] || gridClasses[4]);
        this.renderAnswers();
      }

      createAnswerCard(answer, index) {
        const card = document.createElement('div');
        card.className = this.getCardClasses(answer);
        card.setAttribute('data-row-index', answer.rowIndex);
        card.setAttribute('role', 'article');
        card.setAttribute('tabindex', '0');
        
        card.innerHTML = `
          <div class="p-4 relative">
            ${answer.highlighted ? '<div class="highlight-badge">⭐</div>' : ''}
            <div class="answer-preview mb-3 text-gray-200 leading-relaxed">
              ${Utils.sanitizeHtml(answer.opinion || answer.answer || '')}
            </div>
            <div class="flex items-center justify-between text-xs text-gray-400">
              <span class="font-medium">${this.getDisplayName(answer)}</span>
              <div class="flex items-center gap-1">
                ${this.createReactionButtons(answer, index)}
              </div>
            </div>
          </div>
        `;

        return card;
      }

      getCardClasses(answer) {
        let classes = 'answer-card glass-panel cursor-pointer interactive-element';
        
        if (answer.highlighted) {
          classes += ' highlighted';
        }

        const reactions = this.getActiveReactions(answer);
        if (reactions.length > 0) {
          classes += ` reaction-bg-${reactions.join('-')}`;
          const totalReactions = this.calculateScore(answer);
          if (totalReactions > 10) classes += ' reaction-border-3';
          else if (totalReactions > 5) classes += ' reaction-border-2';
          else if (totalReactions > 0) classes += ' reaction-border-1';
        }

        return classes;
      }

      getActiveReactions(answer) {
        const reactions = answer.reactions || {};
        const active = [];
        
        if (reactions.LIKE && (reactions.LIKE.count || reactions.LIKE) > 0) active.push('like');
        if (reactions.UNDERSTAND && (reactions.UNDERSTAND.count || reactions.UNDERSTAND) > 0) active.push('understand');
        if (reactions.CURIOUS && (reactions.CURIOUS.count || reactions.CURIOUS) > 0) active.push('curious');
        
        return active;
      }

      createReactionButtons(answer, index) {
        return this.reactionTypes.map(({ key, icon }) => {
          const reaction = answer.reactions ? answer.reactions[key] : null;
          const count = reaction ? (reaction.count || 0) : 0;
          const isActive = reaction ? (reaction.reacted || false) : false;
          
          const colorClass = key === 'LIKE' ? 'text-red-400' : 
                            key === 'UNDERSTAND' ? 'text-yellow-400' : 'text-green-400';
          
          return `
            <button 
              type="button"
              class="reaction-btn p-1 rounded transition-all ${colorClass} ${isActive ? 'reacted' : ''}"
              data-reaction="${key}"
              data-row-index="${answer.rowIndex}"
              aria-label="${key} reaction"
            >
              ${key === 'LIKE' ? '❤️' : key === 'UNDERSTAND' ? '💡' : '🤔'}
              ${this.state.showCounts ? `<span class="ml-1 text-xs">${count}</span>` : ''}
            </button>
          `;
        }).join('');
      }

      getDisplayName(answer) {
        const displayMode = this.state.displayMode;
        
        switch (displayMode) {
          case 'named':
            return answer.name || '匿名';
          case 'email':
            return answer.email || '匿名';
          default:
            return `ID: ${(answer.email || 'unknown').substring(0, 8)}`;
        }
      }

      createSkeletonCard() {
        const card = document.createElement('div');
        card.className = 'answer-card glass-panel rounded-xl p-4 flex flex-col justify-between shadow-lg border-2 border-cyan-400/80 skeleton';
        card.innerHTML =
          '<div class="flex-1 space-y-3">' +
          '<div class="h-6 w-3/4 rounded bg-gray-500/30"></div>' +
          '<div class="h-4 w-full rounded bg-gray-500/20"></div>' +
          '<div class="h-4 w-5/6 rounded bg-gray-500/20"></div>' +
          '</div>' +
          '<div class="mt-4 h-8 rounded bg-gray-500/20"></div>';
        return card;
      }

      animateCards() {
        if (typeof gsap === 'undefined') return;
        
        const cards = this.elements.answers.querySelectorAll('.answer-card');
        const tl = gsap.timeline();
        
        tl.fromTo(cards, 
          { opacity: 0, y: 20 },
          { 
            opacity: 1, 
            y: 0, 
            duration: 0.3, 
            stagger: 0.05,
            ease: 'power2.out'
          }
        );

        this.gsapTimelines.add(tl);
      }

      populateClassFilter(answers) {
        if (!this.elements.classFilter) return;
        const uniqueClasses = ['すべて', ...new Set(answers.map(a => a.class).filter(Boolean))];
        this.elements.classFilter.innerHTML = uniqueClasses.map(c => 
          '<option value="' + Utils.sanitizeHtml(c) + '">' + Utils.sanitizeHtml(c) + '</option>'
        ).join('');
        this.elements.classFilter.classList.remove('hidden');
      }

      updateAnswerCount() {
        if (this.elements.answerCountText) {
          this.elements.answerCountText.textContent = `${this.state.filteredAnswers.length}件`;
        }
      }

      async handleReaction(rowIndex, reaction) {
        const btns = document.querySelectorAll(`[data-row-index="${rowIndex}"][data-reaction="${reaction}"]`);
        btns.forEach(btn => {
          btn.disabled = true;
          btn.setAttribute('aria-disabled', 'true');
        });

        try {
          const res = await this.runGas('addReaction', rowIndex, reaction);
          if (res && res.status === 'ok') {
            const item = this.state.answers.find(i => i.rowIndex == rowIndex);
            if (item && res.reactions) {
              item.reactions = res.reactions;
              this.filterAndSortAnswers();
              this.renderAnswers();
            }
          }
        } catch (error) {
          Utils.logError(error, 'Reaction click');
        } finally {
          btns.forEach(btn => {
            btn.disabled = false;
            btn.setAttribute('aria-disabled', 'false');
          });
        }
      }

      async handleHighlight(rowIndex) {
        const btns = document.querySelectorAll(`.highlight-btn[data-row-index="${rowIndex}"]`);
        btns.forEach(btn => {
          btn.disabled = true;
          btn.setAttribute('aria-disabled', 'true');
        });

        try {
          const item = this.state.answers.find(i => i.rowIndex == rowIndex);
          const res = await this.runGas('toggleHighlight', rowIndex, item.highlight);
          if (res && res.status === 'ok') {
            if (item) {
              item.highlight = res.highlight;
              this.filterAndSortAnswers();
              this.renderAnswers();
            }
          }
        } catch (error) {
          Utils.logError(error, 'Highlight toggle');
        } finally {
          btns.forEach(btn => {
            btn.disabled = false;
            btn.setAttribute('aria-disabled', 'false');
          });
        }
      }

      async toggleAdminMode() {
        const enable = !this.state.showAdminFeatures;
        
        if (enable) {
          try {
            const ok = await this.runGas('checkAdmin');
            if (!ok) {
              console.warn('管理者権限がありません。');
              return;
            }
          } catch (e) {
            Utils.logError(e, '権限確認');
            return;
          }
        }

        Object.assign(this.state, enable ? CONFIG.ADMIN_MODE : CONFIG.DEFAULT_MODE);
        
        if (this.elements.adminToggleBtn) {
          this.elements.adminToggleBtn.textContent = enable ? '閲覧モード' : '管理モード';
        }
        
        this.updateSortOptions();
        this.loadSheetData(true, true);
      }

      togglePreviewMode() {
        const currentDisplayMode = this.state.displayMode;
        
        if (currentDisplayMode === 'anonymous') {
          Object.assign(this.state, CONFIG.ADMIN_MODE);
          this.elements.modeToggleBtn.textContent = '学生';
          this.elements.modeToggleBtn.className = 'ml-4 px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-sm';
        } else {
          Object.assign(this.state, CONFIG.DEFAULT_MODE);
          this.elements.modeToggleBtn.textContent = '管理者';
          this.elements.modeToggleBtn.className = 'ml-4 px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm';
        }
        
        this.updateSortOptions();
        this.loadSheetData(true);
      }

      setupInitialModeButton() {
        if (!this.elements.modeToggleBtn) return;
        
        if (Utils.isPreviewMode()) {
          this.elements.modeToggleBtn.style.display = 'block';
          const currentMode = this.state.displayMode;
          if (currentMode === 'named') {
            this.elements.modeToggleBtn.textContent = '学生';
            this.elements.modeToggleBtn.className = 'ml-4 px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-sm';
          } else {
            this.elements.modeToggleBtn.textContent = '管理者';
            this.elements.modeToggleBtn.className = 'ml-4 px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm';
          }
        } else {
          this.elements.modeToggleBtn.style.display = 'none';
        }
      }

      updateSortOptions() {
        const scoreOption = document.getElementById('scoreOption');
        if (scoreOption) {
          scoreOption.style.display = this.state.showScoreSort ? 'block' : 'none';
          if (!this.state.showScoreSort && this.elements.sortOrder?.value === 'score') {
            this.elements.sortOrder.value = 'newest';
          }
        }
      }

      showAnswerModal(rowIndex) {
        const data = this.state.filteredAnswers.find(r => r.rowIndex == rowIndex);
        if (!data) return;
        
        this.state.lastFocusedElement = document.activeElement;
        
        if (this.elements.modalAnswer) {
          this.elements.modalAnswer.innerHTML = 
            '<p class="text-cyan-200 whitespace-pre-wrap break-words text-3xl md:text-4xl font-bold leading-tight">' + 
            Utils.sanitizeHtml(data.opinion || data.answer || '') + '</p>' +
            '<p class="text-gray-200 whitespace-pre-wrap break-words text-2xl md:text-3xl mt-6">' + 
            Utils.sanitizeHtml(data.reason || '') + '</p>';
        }
        
        if (this.elements.modalStudentName) {
          this.elements.modalStudentName.textContent = this.state.displayMode === 'named' ? (data.name || '') : '';
        }

        this.elements.answerModalContainer?.classList.remove('hidden');
        if (typeof gsap !== 'undefined') {
          gsap.to(this.elements.answerModalContainer, { opacity: 1, duration: 0.3 });
          gsap.fromTo(this.elements.answerModalCard, 
            { scale: 0.95 }, 
            { 
              scale: 1, 
              duration: 0.3, 
              ease: 'back.out', 
              onComplete: () => this.elements.answerModalCloseBtn?.focus()
            }
          );
        }
      }

      hideAnswerModal() {
        if (typeof gsap !== 'undefined') {
          gsap.to(this.elements.answerModalContainer, {
            opacity: 0,
            duration: 0.3,
            onComplete: () => this.elements.answerModalContainer?.classList.add('hidden')
          });
          gsap.to(this.elements.answerModalCard, {
            scale: 0.95,
            duration: 0.3,
            ease: 'power2.in',
            onComplete: () => {
              if (this.state.lastFocusedElement) {
                this.state.lastFocusedElement.focus();
              }
            }
          });
        } else {
          this.elements.answerModalContainer?.classList.add('hidden');
        }
      }

      showInfoModal() {
        this.state.lastFocusedElement = document.activeElement;
        this.elements.infoModalContainer?.classList.remove('hidden');
        if (typeof gsap !== 'undefined') {
          gsap.to(this.elements.infoModalContainer, { opacity: 1, duration: 0.3 });
          gsap.fromTo(this.elements.infoModalCard,
            { scale: 0.95 },
            {
              scale: 1,
              duration: 0.3,
              ease: 'back.out',
              onComplete: () => this.elements.infoModalConfirmBtn?.focus()
            }
          );
        }
      }

      hideInfoModal() {
        if (typeof gsap !== 'undefined') {
          gsap.to(this.elements.infoModalContainer, {
            opacity: 0,
            duration: 0.3,
            onComplete: () => this.elements.infoModalContainer?.classList.add('hidden')
          });
          gsap.to(this.elements.infoModalCard, { scale: 0.95, duration: 0.3, ease: 'power2.in' });
        } else {
          this.elements.infoModalContainer?.classList.add('hidden');
        }
        localStorage.setItem('introSeen', '1');
        if (this.state.lastFocusedElement) {
          this.state.lastFocusedElement.focus();
        }
      }

      refreshData() {
        this.loadSheetData(true);
        this.hideBanner();
      }

      hideBanner() {
        if (this.elements.newContentBanner) {
          this.elements.newContentBanner.classList.add('hidden');
        }
      }

      startPolling() {
        if (this.state.isPolling) return;
        
        this.state.isPolling = true;
        this.pollingInterval = setInterval(() => {
          this.checkForUpdates();
        }, CONFIG.POLLING.INTERVAL);
      }

      stopPolling() {
        if (this.pollingInterval) {
          clearInterval(this.pollingInterval);
          this.pollingInterval = null;
          this.state.isPolling = false;
        }
      }

      async checkForUpdates() {
        try {
          const selectedClass = this.elements.classFilter?.value || 'すべて';
          const sortOrder = this.elements.sortOrder?.value || 'newest';
          const data = await this.runGas('getPublishedSheetData', selectedClass, sortOrder);
          if (data.answers || data.rows) {
            const newAnswers = data.answers || data.rows;
            if (newAnswers.length !== this.state.answers.length) {
              this.showBanner();
            }
          }
        } catch (error) {
          Utils.logError(error, 'Polling check');
        }
      }

      showBanner() {
        if (this.elements.newContentBanner) {
          this.elements.newContentBanner.classList.remove('hidden');
        }
      }

      runGas(funcName, ...args) {
        return new Promise((resolve, reject) => {
          if (Utils.isPreviewMode() || typeof google === 'undefined' || !google.script?.run) {
            console.warn('Google Apps Script environment not detected or preview mode. Using mock data.');
            this.getMockData(funcName, ...args).then(resolve).catch(reject);
          } else {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              [funcName](...args);
          }
        });
      }

      getMockData(funcName, ...args) {
        Utils.logDebug('getMockData called with:', funcName, args);
        return new Promise((resolve) => {
          setTimeout(() => {
            if (funcName === 'getPublishedSheetData') {
              const currentDisplayMode = this.state.displayMode;
              const studentName1 = currentDisplayMode === 'named' ? '田中太郎' : '';
              const studentName2 = currentDisplayMode === 'named' ? '佐藤花子' : '';
              
              resolve({
                header: 'テスト問題',
                sheetName: 'テストシート',
                rows: [
                  {
                    rowIndex: 1,
                    name: studentName1,
                    class: '3年A組',
                    opinion: 'これは素晴らしいアイデアだと思います。',
                    reason: '理由は簡潔で分かりやすく、実現可能性が高いからです。',
                    reactions: {
                      UNDERSTAND: { count: 5, reacted: false },
                      LIKE: { count: 2, reacted: false },
                      CURIOUS: { count: 1, reacted: false }
                    },
                    highlight: false
                  },
                  {
                    rowIndex: 2,
                    name: studentName2,
                    class: '3年B組',
                    opinion: '少し改善の余地があると考えます。',
                    reason: 'より多くの人の意見を聞く必要があると思います。',
                    reactions: {
                      UNDERSTAND: { count: 3, reacted: true },
                      LIKE: { count: 0, reacted: false },
                      CURIOUS: { count: 0, reacted: false }
                    },
                    highlight: true
                  }
                ]
              });
            } else if (funcName === 'addReaction') {
              resolve({
                status: 'ok',
                reactions: {
                  UNDERSTAND: { count: Math.floor(Math.random() * 5), reacted: Math.random() < 0.5 },
                  LIKE: { count: Math.floor(Math.random() * 5), reacted: Math.random() < 0.5 },
                  CURIOUS: { count: Math.floor(Math.random() * 5), reacted: Math.random() < 0.5 }
                }
              });
            } else if (funcName === 'toggleHighlight') {
              resolve({
                status: 'ok',
                highlight: !args[1]
              });
            } else if (funcName === 'checkAdmin') {
              resolve(true); 
            }
          }, 500);
        });
      }

      destroy() {
        this.stopPolling();
        
        Object.values(this.handlers).forEach((handler, key) => {
          // イベントリスナー削除のロジック（省略）
        });

        this.gsapTimelines.forEach(tl => {
          if (tl.kill) tl.kill();
        });

        this.state.cache.clear();
      }
    }

    // 🚀 アプリケーション開始
    let app;
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        app = new GenericBoardApp();
      });
    } else {
      app = new GenericBoardApp();
    }

    // グローバルエラーハンドリング
    window.addEventListener('error', (event) => {
      Utils.logError(event.error, 'Global error');
    });

    window.addEventListener('unhandledrejection', (event) => {
      Utils.logError(event.reason, 'Unhandled promise rejection');
    });

    // クリーンアップ
    window.addEventListener('beforeunload', () => {
      if (app && typeof app.destroy === 'function') {
        app.destroy();
      }
    });
  </script>
</body>
</html>