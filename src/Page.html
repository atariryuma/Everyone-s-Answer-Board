<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>GenericBoard - ã¿ã‚“ãªã®ã‹ã„ã¨ã†ãƒœãƒ¼ãƒ‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <?!= include('SharedSecurityHeaders'); ?>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript><link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" /></noscript>
  <link rel="dns-prefetch" href="//script.google.com" />
  <link rel="preconnect" href="https://script.google.com" crossorigin />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
  <?!= include('SharedTailwindConfig'); ?>
  <style>
:root{--color-primary:#8be9fd;--color-primary-dark:#6272a4;--color-background:#1a1b26;--color-surface:rgba(26,27,38,0.7);--color-text:#c0caf5;--color-text-secondary:#6272a4;--color-text-muted:rgba(255,255,255,0.6);--color-border:rgba(255,255,255,0.1);--color-accent:#facc15;--color-success:#50fa7b;--color-warning:#ffb86c;--color-error:#ff5555;--duration-fast:0.2s;--duration-normal:0.3s;--duration-slow:0.5s;--ease-out:cubic-bezier(0.25,0.46,0.45,0.94);--ease-in-out:cubic-bezier(0.645,0.045,0.355,1);--border-radius:0.75rem;--border-radius-lg:1rem;--shadow-sm:0 1px 2px rgba(0,0,0,0.05);--shadow-md:0 4px 6px rgba(0,0,0,0.1);--shadow-lg:0 10px 15px rgba(0,0,0,0.1);--shadow-glow:0 0 15px var(--color-primary);--glass-bg:var(--color-surface);--glass-border:1px solid var(--color-border);--glass-blur:blur(12px);--transition-duration:0.2s;--transition-easing:ease-out;--animation-duration:0.3s;--backdrop-blur:12px}body{color:var(--color-text);background-color:var(--color-background);margin:0;overflow-x:hidden}.glass-panel{background:var(--glass-bg);-webkit-backdrop-filter:var(--glass-blur);backdrop-filter:var(--glass-blur);border:var(--glass-border);transition:border-color var(--transition-duration) var(--transition-easing)}.glass-panel:hover{border-color:rgba(255,255,255,0.2)}.interactive-element{transition:all var(--duration-fast) var(--ease-out);border-radius:var(--border-radius)}.game-font{font-family:'Press Start 2P',cursive}.game-btn{transition:all var(--duration-fast) var(--ease-out);border-radius:var(--border-radius);border-bottom-width:4px;text-shadow:1px 1px 2px rgba(0,0,0,0.4);position:relative;overflow:hidden}.game-btn:not(:disabled):hover{transform:translateY(-2px) scale(1.02);box-shadow:var(--shadow-glow)}.game-btn:active:not(:disabled){transform:translateY(2px);border-bottom-width:2px;box-shadow:none}.game-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none!important}#classFilter,#sortOrder{background-color:var(--color-primary-dark);border:var(--glass-border);color:var(--color-text);border-radius:var(--border-radius);padding:0.25rem 0.5rem;transition:border-color var(--transition-duration) var(--transition-easing),box-shadow var(--transition-duration) var(--transition-easing)}#classFilter:focus,#sortOrder:focus{border-color:rgba(6,182,212,0.5);box-shadow:0 0 0 2px rgba(6,182,212,0.2);outline:none}:focus-visible{outline:3px solid var(--color-primary);outline-offset:2px;border-radius:var(--border-radius)}header{position:sticky;top:0;z-index:50;contain:layout;-webkit-backdrop-filter:blur(var(--backdrop-blur));backdrop-filter:blur(var(--backdrop-blur))}.line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}@media (min-width:768px) and (max-width:1023px){#headingLabel{font-size:1.25rem!important}}#formAnswerBtn{transition:all 0.2s ease-out}#formAnswerBtn:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.15)}#answerCount{transition:background-color 0.2s ease-out}#answerCount:hover{background-color:rgba(55,65,81,0.5)}.answer-card{will-change:transform,opacity;transition:all var(--duration-normal) var(--ease-out);border-radius:var(--border-radius-lg);contain:layout style;position:relative;overflow:hidden}.answer-card.highlighted{border:4px solid transparent;border-image:none!important;box-shadow:0 0 15px rgba(250,204,21,0.6);transform:scale(1.02);z-index:2;background:linear-gradient(var(--glass-bg),var(--glass-bg)) padding-box,linear-gradient(90deg,var(--color-accent),var(--color-primary)) border-box;background-clip:padding-box,border-box;position:relative}.answer-card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 8px 25px rgba(139,233,253,0.3)}.answer-card:focus-visible{transform:translateY(-4px) scale(1.02);box-shadow:0 8px 25px rgba(139,233,253,0.3)}.answer-card.highlighted:hover{transform:translateY(-4px) scale(1.04)}.answer-card.loading{opacity:0.7;pointer-events:none}.reaction-btn{transition:transform var(--transition-duration) var(--transition-easing),background-color var(--transition-duration) var(--transition-easing),box-shadow var(--transition-duration) var(--transition-easing);position:relative;overflow:hidden}.reaction-btn:hover{transform:scale(1.1)}.reaction-btn:active{transform:scale(0.95)}.reaction-btn.reacted{background-color:var(--color-primary)!important;color:#000!important;box-shadow:0 0 10px rgba(139,233,253,0.5)}.reaction-btn.liked{background-color:var(--color-primary)!important;color:#000!important;box-shadow:0 0 10px rgba(139,233,253,0.5)}.reaction-btn.loading{opacity:0.6;pointer-events:none}.fade-in{animation:fadeIn 0.5s ease-out}.slide-in{animation:slideIn 0.3s ease-out}.pulse{animation:pulse 0.6s ease-out}.shake{animation:shake 0.5s ease-out}.admin-toggle{transition:background-color var(--animation-duration) var(--transition-easing);-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px)}.admin-toggle:hover{background-color:rgba(139,233,253,0.1)}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(26,27,38,0.8);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000}.spinner{width:40px;height:40px;border:4px solid rgba(139,233,253,0.3);border-top:4px solid var(--color-primary);border-radius:50%;animation:spin 1s linear infinite}@keyframes fadeIn{from{opacity:0;will-change:opacity}to{opacity:1}}@keyframes slideIn{from{opacity:0;will-change:opacity}to{opacity:1}}@keyframes pulse{0%{will-change:transform}50%{transform:scale3d(1.05,1.05,1)}100%{transform:scale3d(1,1,1)}}@keyframes shake{0%,100%{will-change:transform}25%{transform:translate3d(-5px,0,0)}75%{transform:translate3d(5px,0,0)}}@keyframes spin{100%{transform:rotate(360deg);will-change:transform}}@keyframes bounce{0%,20%,50%,80%,100%{transform:translate(-50%,0) translateY(0)}40%{transform:translate(-50%,0) translateY(-10px)}60%{transform:translate(-50%,0) translateY(-5px)}}@media (min-resolution:120dpi) and (min-width:1200px){:root{--transition-duration:0.15s;--animation-duration:0.2s}}@media (prefers-contrast:high){:root{--color-border:rgba(255,255,255,0.3);--color-surface:rgba(26,27,38,0.98)}}@media (prefers-reduced-motion:reduce){:root{--transition-duration:0.01ms;--animation-duration:0.01ms;--backdrop-blur:0px}*,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important;transform:none!important}.answer-card:hover,.reaction-btn:hover,.game-btn:hover{transform:none!important}}.highlight-badge{position:absolute;top:0.25rem;right:0.25rem;width:1.5rem;height:1.5rem;display:flex;align-items:center;justify-content:center;color:#facc15;filter:drop-shadow(0 0 4px rgba(250,204,21,0.7))}.answer-card.reaction-bg-like{border-color:#ef4444!important;border-image:none!important}.answer-card.reaction-bg-understand{border-color:#fbbf24!important;border-image:none!important}.answer-card.reaction-bg-curious{border-color:#10b981!important;border-image:none!important}.reaction-bg-like-understand,.reaction-bg-like-curious,.reaction-bg-understand-curious,.reaction-bg-all{border-color:transparent;border-style:solid;background:var(--glass-bg);border-image-slice:1;border-image-source:linear-gradient(90deg,#ef4444,#fbbf24)}.reaction-bg-like-curious{border-image-source:linear-gradient(90deg,#ef4444,#10b981)}.reaction-bg-understand-curious{border-image-source:linear-gradient(90deg,#fbbf24,#10b981)}.reaction-bg-all{border-image-source:linear-gradient(90deg,#ef4444,#fbbf24,#10b981)}.reaction-border-1{border-width:2px}.reaction-border-2{border-width:4px}.reaction-border-3{border-width:6px}.answer-preview{display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;min-height:120px}.highlight-btn{transition:all 0.2s ease;border-radius:4px;padding:2px}.highlight-btn:hover{background:rgba(250,204,21,0.1);transform:scale(1.1)}.highlight-btn.liked{color:#facc15;filter:drop-shadow(0 0 4px rgba(250,204,21,0.7))}#controlsFooter{pointer-events:none}#controlsFooter>.glass-panel{pointer-events:auto}.skeleton{position:relative;overflow:hidden;background-color:rgba(255,255,255,0.05);color:transparent}.skeleton::after{content:"";position:absolute;inset:0;background-image:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,0.3),rgba(255,255,255,0));animation:skeleton-loading 1.2s infinite}@keyframes skeleton-loading{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans">
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="text-center">
      <div class="spinner"></div>
      <p class="mt-4 text-gray-300">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <div id="main-container" class="w-full mx-auto px-4 pt-4 pb-4 md:px-6 md:pt-6 md:pb-6">
    <header id="main-header" class="glass-panel rounded-xl p-4 mb-4 flex flex-col lg:flex-row justify-between items-center gap-4 shadow-lg">
      <div class="flex items-center gap-4 w-full lg:w-auto">
        <p id="answerCount" class="text-sm text-gray-400 flex items-center gap-2 flex-shrink-0"></p>
        <label for="classFilter" class="sr-only">ã‚¯ãƒ©ã‚¹çµã‚Šè¾¼ã¿</label>
        <select id="classFilter" class="hidden text-sm"></select>
        <label for="sortOrder" class="sr-only">ä¸¦ã³é †</label>
        <select id="sortOrder" class="text-sm">
          <option value="newest" selected>æ–°ç€é †</option>
          <option value="random">ãƒ©ãƒ³ãƒ€ãƒ é †</option>
          <option value="score" id="scoreOption" style="display: none;">ã‚¹ã‚³ã‚¢é †</option>
        </select>
      </div>
      <div class="flex-grow text-center w-full min-w-0">
        <h1 id="siteTitle" class="game-font text-yellow-300 text-lg md:text-xl mb-1">ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰</h1>
        <p id="headingLabel" class="text-2xl md:text-3xl font-bold text-pink-400 leading-tight flex justify-center">
          <svg class="w-6 h-6 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
          </svg>
        </p>
      </div>
      <div class="w-full lg:w-auto lg:min-w-[150px] text-right space-y-1">
        <p id="sheetNameText" class="text-xs text-gray-400 h-4"></p>
        <p id="modeLabel" class="text-xs text-gray-400"></p>
        <button type="button" id="adminToggleBtn" class="text-xs text-cyan-400 underline hidden" hidden aria-label="ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ"></button>
      </div>
    </header>

    <main id="answers" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" role="main" aria-live="polite" aria-label="å›ç­”ä¸€è¦§"></main>
  </div>
  
  <div id="answerModalContainer" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300" role="dialog" aria-modal="true">
    <div id="answerModalCard" class="glass-panel rounded-xl p-6 flex flex-col shadow-2xl border-2 border-cyan-400/80 w-full max-w-5xl h-auto max-h-[85vh] transform scale-95 transition-transform duration-300" role="document" aria-labelledby="modalAnswer">
      <button id="answerModalCloseBtn" class="absolute -top-3 -right-3 bg-red-600 rounded-full p-2 text-white hover:scale-110 transition-transform" aria-label="é–‰ã˜ã‚‹"></button>
      <div id="modalAnswer" class="flex-grow min-h-[200px] mb-4 overflow-y-auto pr-4"></div>
      <div id="modalFooter" class="text-xs text-gray-400 pt-4 border-t-2 border-dashed border-cyan-400/80 flex justify-between items-center">
        <div><span id="modalStudentName" class="font-bold text-2xl text-gray-200"></span></div>
        <div id="modalReactions" class="flex items-center gap-2"></div>
      </div>
    </div>
  </div>

  <div id="infoModalContainer" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300" role="dialog" aria-modal="true">
    <div id="infoModalCard" class="glass-panel rounded-xl p-6 shadow-2xl border-2 border-cyan-400/80 w-full max-w-lg transform scale-95 transition-transform duration-300 relative" role="document">
      <div class="space-y-4 text-gray-200 text-lg leading-relaxed">
        <p>ã¿ã‚“ãªã®æ„è¦‹ã‚’æ°—æŒã¡ã‚ˆãå…±æœ‰ã™ã‚‹ãŸã‚ã«ã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã—ã‹ãŸã‚’ãŠã¼ãˆã‚ˆã†ï¼</p>
        <ul class="space-y-2">
          <li class="flex items-center gap-2"><span id="infoIconLike" class="w-5 h-5 text-red-400"></span>ã„ã„ã­ï¼šã™ã¦ãã ã¨æ€ã£ãŸã¨ãã«æŠ¼ãã†</li>
          <li class="flex items-center gap-2"><span id="infoIconUnderstand" class="w-5 h-5 text-yellow-400"></span>ãªã‚‹ã»ã©ï¼šå‚è€ƒã«ãªã£ãŸã¨ãã«æŠ¼ãã†</li>
          <li class="flex items-center gap-2"><span id="infoIconCurious" class="w-5 h-5 text-green-400"></span>ãã«ãªã‚‹ï¼šã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ã¨ãã«æŠ¼ãã†</li>
        </ul>
        <p class="flex items-center gap-2"><span id="infoIconHighlight" class="w-5 h-5 text-yellow-300"></span>å…ˆç”ŸãŒæ³¨ç›®ã—ã¦ã»ã—ã„æ„è¦‹ã«ã¤ã‘ã¦ã„ã¾ã™</p>
        <p>è²¬ä»»ã‚ã‚‹ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã€ã¿ã‚“ãªã§å­¦ã³ã‚’æ·±ã‚ã‚ˆã†ï¼</p>
        <div class="text-center mt-6">
          <button id="infoModalConfirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ã‚ã‹ã£ãŸ</button>
        </div>
      </div>
    </div>
  </div>

  <footer id="controlsFooter" class="fixed bottom-0 left-0 right-0 z-40 p-4">
    <div class="glass-panel max-w-md mx-auto rounded-xl p-3 flex items-center justify-center gap-3">
      <input type="range" id="sizeSlider" min="2" max="6" value="4" class="w-1/2" aria-label="è¡¨ç¤ºåˆ—æ•°ã®å¤‰æ›´">
      <div class="flex items-center gap-1">
        <span id="sliderValue" class="font-bold text-lg">4</span>
        <span id="footerIcon" class="w-4 h-4"></span>
      </div>
      <button type="button" id="modeToggleBtn" class="ml-4 px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm" title="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">åˆ‡æ›¿</button>
    </div>
  </footer>

  <script>
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¤‰æ•°ã‚’JavaScriptã®å®šæ•°ã¨ã—ã¦åˆ©ç”¨ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ç„¡è¦–ï¼‰
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯ä»¥ä¸‹ã®å¤‰æ•°ã¯æœªå®šç¾©ã«ãªã‚‹ãŒã€windowå¤‰æ•°ã‹ã‚‰å‚ç…§
    let showAdminFeatures, showHighlightToggle, isAdminUser;
    try {
      // GASç’°å¢ƒã§ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŒç„¡è¦–ï¼‰
      showAdminFeatures = window.showAdminFeatures;
      showHighlightToggle = window.showHighlightToggle;
      isAdminUser = !window.isStudentMode;
    } catch (e) {
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç„¡è¦–
    }
    
    // å®Œå…¨ã«ã‚¨ãƒ©ãƒ¼ãƒ•ãƒªãƒ¼ã®SVGã‚¢ã‚¤ã‚³ãƒ³ï¼ˆlineã€rectã€circleã®ã¿ä½¿ç”¨ï¼‰
    const ICONS = {
      'lightbulb-outline': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><line x1="12" y1="2" x2="12" y2="4"/><line x1="12" y1="20" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="6.34" y2="6.34"/><line x1="17.66" y1="17.66" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="4" y2="12"/><line x1="20" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="6.34" y2="17.66"/><line x1="17.66" y1="6.34" x2="19.07" y2="4.93"/></svg>',
      'hand-thumb-up-outline': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="10" x2="7" y2="22"/><rect x="15" y="8" width="6" height="10"/><rect x="9" y="16" width="6" height="6"/></svg>',
      'magnifying-glass-plus-outline': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>',
      'x': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
      'star-outline': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="2" x2="15" y2="8"/><line x1="15" y1="8" x2="22" y2="9"/><line x1="22" y1="9" x2="16" y2="14"/><line x1="16" y1="14" x2="18" y2="21"/><line x1="18" y1="21" x2="12" y2="17"/><line x1="12" y1="17" x2="6" y2="21"/><line x1="6" y1="21" x2="8" y2="14"/><line x1="8" y1="14" x2="2" y2="9"/><line x1="2" y1="9" x2="9" y2="8"/><line x1="9" y1="8" x2="12" y2="2"/></svg>',
      'grid-2x2': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18"/><line x1="12" y1="3" x2="12" y2="21"/><line x1="3" y1="12" x2="21" y2="12"/></svg>',
      'users': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="7" r="4"/><rect x="2" y="15" width="14" height="6"/></svg>'
    };

    class StudyQuestApp {
      constructor() {
        // UIè¦ç´ ã¸ã®å‚ç…§ã‚’æ ¼ç´
        this.elements = {
          answersContainer: document.getElementById('answers'),
          sizeSlider: document.getElementById('sizeSlider'),
          sliderValue: document.getElementById('sliderValue'),
          headingLabel: document.getElementById('headingLabel'),
          sheetNameText: document.getElementById('sheetNameText'),
          modeLabel: document.getElementById('modeLabel'),
          adminToggleBtn: document.getElementById('adminToggleBtn'),
          answerCount: document.getElementById('answerCount'),
          answerModalContainer: document.getElementById('answerModalContainer'),
          answerModalCloseBtn: document.getElementById('answerModalCloseBtn'),
          answerModalCard: document.getElementById('answerModalCard'),
          modalAnswer: document.getElementById('modalAnswer'),
          modalStudentName: document.getElementById('modalStudentName'),
          modalReactionContainer: document.getElementById('modalReactions'),
          classFilter: document.getElementById('classFilter'),
          sortOrder: document.getElementById('sortOrder'),
          scoreOption: document.getElementById('scoreOption'),
          infoModalContainer: document.getElementById('infoModalContainer'),
          infoModalConfirmBtn: document.getElementById('infoModalConfirmBtn'),
          infoIconLike: document.getElementById('infoIconLike'),
          infoIconUnderstand: document.getElementById('infoIconUnderstand'),
          infoIconCurious: document.getElementById('infoIconCurious'),
          infoIconHighlight: document.getElementById('infoIconHighlight'),
          footerIcon: document.getElementById('footerIcon'),
          modeToggleBtn: document.getElementById('modeToggleBtn')
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ç®¡ç†
        this.state = {
          currentAnswers: [],
          isLoading: false,
          lastFocusedElement: null,
          pollingInterval: null,
          lastDataHash: null
        };

        this.handlers = {}; // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©å‚ç…§ç”¨

        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã¨ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        this.reactionTypes = [
          { key: 'LIKE', icon: 'hand-thumb-up-outline' },
          { key: 'UNDERSTAND', icon: 'lightbulb-outline' },
          { key: 'CURIOUS', icon: 'magnifying-glass-plus-outline' }
        ];
        
        this.init();
      }

      /**
       * ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
       */
      destroy() {
        this.stopPolling();
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
        if (this.elements.sizeSlider && this.handlers.onSizeSliderInput) {
          this.elements.sizeSlider.removeEventListener('input', this.handlers.onSizeSliderInput);
        }
        if (this.elements.sortOrder && this.handlers.onSortOrderChange) {
          this.elements.sortOrder.removeEventListener('change', this.handlers.onSortOrderChange);
        }
        if (this.elements.answersContainer && this.handlers.onReactionClick) {
          this.elements.answersContainer.removeEventListener('click', this.handlers.onReactionClick);
        }
        if (this.elements.adminToggleBtn && this.handlers.onAdminToggleClick) {
          this.elements.adminToggleBtn.removeEventListener('click', this.handlers.onAdminToggleClick);
        }
      }

      /**
       * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–å‡¦ç†
       */
      init() {
        this.renderIcons(); // ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        this.setupEventListeners(); // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        this.loadInitialData(); // åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰
      }

      /**
       * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
       */
      setupEventListeners() {
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å¤‰æ›´
        this.handlers.onSizeSliderInput = () => {
          localStorage.setItem('boardColumns', this.elements.sizeSlider.value);
          this.renderBoard();
        };
        this.elements.sizeSlider.addEventListener('input', this.handlers.onSizeSliderInput);

        // ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã‚½ãƒ¼ãƒˆé †ã®å¤‰æ›´
        this.handlers.onSortOrderChange = () => this.loadSheetData();
        this.elements.sortOrder.addEventListener('change', this.handlers.onSortOrderChange);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        this.handlers.onAnswerModalCloseClick = () => this.hideAnswerModal();
        this.elements.answerModalCloseBtn.addEventListener('click', this.handlers.onAnswerModalCloseClick);
        
        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        this.handlers.onReactionClick = (event) => {
          const button = event.target.closest('.reaction-btn');
          if (!button) return;
          
          const rowIndex = parseInt(button.getAttribute('data-row-index'));
          const reactionKey = button.getAttribute('data-reaction');
          
          if (rowIndex && reactionKey) {
            this.toggleReaction(rowIndex, reactionKey, button);
          }
        };
        this.elements.answersContainer.addEventListener('click', this.handlers.onReactionClick);
        
        // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³
        if (this.elements.adminToggleBtn) {
          this.handlers.onAdminToggleClick = () => this.toggleAdminMode();
          this.elements.adminToggleBtn.addEventListener('click', this.handlers.onAdminToggleClick);
        }

        // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º
        this.handlers.onCardClick = (event) => {
          const card = event.target.closest('.answer-card');
          if (!card || event.target.closest('.reaction-btn')) return; // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã¯é™¤å¤–
          
          const rowIndex = parseInt(card.getAttribute('data-row-index'));
          if (rowIndex) {
            this.showAnswerModal(rowIndex);
          }
        };
        this.elements.answersContainer.addEventListener('click', this.handlers.onCardClick);
        
        // ä¿å­˜ã•ã‚ŒãŸåˆ—æ•°ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰
        const savedCols = localStorage.getItem('boardColumns');
        if (savedCols && this.elements.sizeSlider && this.elements.sliderValue) {
          this.elements.sizeSlider.value = savedCols;
          this.elements.sliderValue.textContent = savedCols;
        }
        
        // â™¿ ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¼·åŒ–: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        this.initializeKeyboardNavigation();
      }

      /**
       * â™¿ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
       */
      initializeKeyboardNavigation() {
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', this.handleGlobalKeydown.bind(this));
        
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†
        this.focusManager = {
          currentFocusIndex: -1,
          focusableElements: []
        };
        
        // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œã®ãƒ©ã‚¤ãƒ–ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ä½œæˆ
        this.createAriaLiveRegion();
      }

      /**
       * ğŸ¹ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ©
       */
      handleGlobalKeydown(event) {
        try {
          // Escã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
          if (event.key === 'Escape') {
            this.hideAnswerModal();
            return;
          }

          // Ctrl+R / Cmd+R ã§ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒªãƒ­ãƒ¼ãƒ‰é˜²æ­¢ï¼‰
          if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
            event.preventDefault();
            this.loadSheetData();
            this.announceToScreenReader('ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã„ã¾ã™');
            return;
          }

          // çŸ¢å°ã‚­ãƒ¼ã§ã‚«ãƒ¼ãƒ‰é–“ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
          if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
            this.handleArrowKeyNavigation(event);
            return;
          }

          // ã‚¿ãƒ–ã‚­ãƒ¼ã§ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†
          if (event.key === 'Tab') {
            this.updateFocusableElements();
          }

        } catch (error) {
          console.error('Global keyboard handler error:', error);
        }
      }

      /**
       * â¡ï¸ çŸ¢å°ã‚­ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
       */
      handleArrowKeyNavigation(event) {
        const cards = Array.from(document.querySelectorAll('.answer-card'));
        if (cards.length === 0) return;

        const currentFocus = document.activeElement;
        const currentIndex = cards.indexOf(currentFocus);
        
        let newIndex = currentIndex;
        const gridColumns = parseInt(this.elements.sizeSlider?.value || 3);
        
        switch (event.key) {
          case 'ArrowUp':
            newIndex = Math.max(0, currentIndex - gridColumns);
            break;
          case 'ArrowDown':
            newIndex = Math.min(cards.length - 1, currentIndex + gridColumns);
            break;
          case 'ArrowLeft':
            newIndex = Math.max(0, currentIndex - 1);
            break;
          case 'ArrowRight':
            newIndex = Math.min(cards.length - 1, currentIndex + 1);
            break;
        }

        if (newIndex !== currentIndex && cards[newIndex]) {
          event.preventDefault();
          cards[newIndex].focus();
          this.announceCardInfo(cards[newIndex]);
        }
      }

      /**
       * ğŸ” ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯èƒ½è¦ç´ ã®æ›´æ–°
       */
      updateFocusableElements() {
        this.focusManager.focusableElements = Array.from(
          document.querySelectorAll(
            'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
          )
        );
      }

      /**
       * ğŸ“¢ ARIAãƒ©ã‚¤ãƒ–ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ä½œæˆ
       */
      createAriaLiveRegion() {
        const liveRegion = document.createElement('div');
        liveRegion.id = 'aria-live-region';
        liveRegion.setAttribute('aria-live', 'polite');
        liveRegion.setAttribute('aria-atomic', 'true');
        liveRegion.style.cssText = `
          position: absolute; 
          left: -10000px; 
          width: 1px; 
          height: 1px; 
          overflow: hidden;
        `;
        document.body.appendChild(liveRegion);
      }

      /**
       * ğŸ—£ï¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ã¸ã®é€šçŸ¥
       */
      announceToScreenReader(message) {
        const liveRegion = document.getElementById('aria-live-region');
        if (liveRegion) {
          liveRegion.textContent = message;
          // é‡è¤‡ã‚¢ãƒŠã‚¦ãƒ³ã‚¹é˜²æ­¢ã®ãŸã‚ã‚¯ãƒªã‚¢
          setTimeout(() => {
            liveRegion.textContent = '';
          }, 1000);
        }
      }

      /**
       * ğŸ’¬ ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ã‚¢ãƒŠã‚¦ãƒ³ã‚¹
       */
      announceCardInfo(cardElement) {
        try {
          const rowIndex = cardElement.dataset.rowIndex;
          const answer = this.state.currentAnswers.find(row => row.rowIndex == rowIndex);
          
          if (answer) {
            const announcement = `${answer.opinion}${answer.reason ? '. ç†ç”±: ' + answer.reason : ''}`;
            this.announceToScreenReader(announcement);
          }
        } catch (error) {
          console.error('Error announcing card info:', error);
        }
      }

      /**
       * Google Apps Scripté–¢æ•°ã‚’å®Ÿè¡Œ
       */
      runGas(funcName, ...args) {
        return new Promise((resolve, reject) => {
          console.log('runGas called:', { funcName, args, argsLength: args.length });
          
          // Google Apps Scriptç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            console.log('Calling Google Apps Script function:', funcName);
            google.script.run
              .withSuccessHandler((result) => {
                console.log('GAS function success:', { funcName, result });
                resolve(result);
              })
              .withFailureHandler((error) => {
                console.error('GAS function error:', { funcName, error });
                reject(error);
              })
              [funcName](...args);
          } else {
            // GASç’°å¢ƒãŒãªã„å ´åˆã¯ã€ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
            console.warn('Google Apps Script environment not detected. Using mock data.');
            this.getMockData(funcName, ...args).then((result) => {
              console.log('Mock data returned:', { funcName, result });
              resolve(result);
            }).catch((error) => {
              console.error('Mock data error:', { funcName, error });
              reject(error);
            });
          }
        });
      }

      /**
       * ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
       */
      getMockData(funcName, ...args) {
        return new Promise((resolve) => {
          setTimeout(() => {
            if (funcName === 'getPublishedSheetData') {
              resolve({
                header: 'ãƒ†ã‚¹ãƒˆå•é¡Œ',
                sheetName: 'ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒˆ',
                rows: [
                  {
                    rowIndex: 1,
                    name: 'ç”°ä¸­å¤ªéƒ',
                    class: '3å¹´Açµ„',
                    opinion: 'ã“ã‚Œã¯ç´ æ™´ã‚‰ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã ã¨æ€ã„ã¾ã™ã€‚',
                    reason: 'ç†ç”±ã¯ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ãã€å®Ÿç¾å¯èƒ½æ€§ãŒé«˜ã„ã‹ã‚‰ã§ã™ã€‚',
                    reactions: {
                      UNDERSTAND: { count: 5, reacted: false },
                      LIKE: { count: 2, reacted: false },
                      CURIOUS: { count: 1, reacted: false }
                    },
                    highlight: false
                  }
                ]
              });
            }
          }, 500);
        });
      }

      /**
       * åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
       */
      async loadInitialData() {
        await this.loadSheetData();
        // ç®¡ç†è€…è¨­å®šã®è¡¨ç¤º
        this.setupAdminUI();
        // åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã€ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ï¼ˆ5ç§’å¾Œï¼‰
        setTimeout(() => this.startPolling(), 5000);
      }

      /**
       * ç®¡ç†è€…UIè¨­å®šã¨configJSONè¡¨ç¤ºè¨­å®šã®åæ˜ 
       */
      setupAdminUI() {
        try {
          // GAS ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‹ã‚‰ç®¡ç†è€…æƒ…å ±ã‚’å–å¾—
          const showAdminFeatures = window.showAdminFeatures;
          const isAdminUser = !window.isStudentMode;

          console.log('Admin UI setup:', { showAdminFeatures, isAdminUser });
          
          // configJSONè¡¨ç¤ºè¨­å®šã®å–å¾—ã¨åæ˜ 
          this.applyConfigDisplaySettings();

          // ç®¡ç†è€…ãƒœã‚¿ãƒ³è¡¨ç¤ºè¨­å®š
          if (this.elements.adminToggleBtn) {
            if (showAdminFeatures && isAdminUser) {
              this.elements.adminToggleBtn.classList.remove('hidden');
              this.elements.adminToggleBtn.removeAttribute('hidden');
              this.elements.adminToggleBtn.textContent = 'ç®¡ç†ãƒ‘ãƒãƒ«';
              console.log('Admin button enabled');
            } else {
              this.elements.adminToggleBtn.classList.add('hidden');
              this.elements.adminToggleBtn.setAttribute('hidden', '');
              console.log('Admin button hidden');
            }
          }

          // ãƒ¢ãƒ¼ãƒ‰ãƒ©ãƒ™ãƒ«è¨­å®š
          if (this.elements.modeLabel) {
            this.elements.modeLabel.textContent = isAdminUser ? 'ç®¡ç†è€…' : 'å­¦ç¿’è€…';
          }

        } catch (error) {
          console.error('setupAdminUI error:', error);
        }
      }

      /**
       * configJSONã®è¡¨ç¤ºè¨­å®šã‚’åæ˜ 
       */
      applyConfigDisplaySettings() {
        try {
          // GAS ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‹ã‚‰configJSONã‚’å–å¾—
          const configJsonString = '<?= typeof userInfo !== "undefined" && userInfo && userInfo.configJson ? userInfo.configJson : "{}" ?>';
          console.log('configJSON raw string:', configJsonString);
          
          let config = {};
          try {
            config = JSON.parse(configJsonString);
            console.log('Parsed configJSON:', config);
          } catch (parseError) {
            console.error('Error parsing configJSON:', parseError);
            return;
          }
          
          // displaySettingsãŒã‚ã‚‹å ´åˆã®å‡¦ç†
          if (config.displaySettings && typeof config.displaySettings === 'object') {
            console.log('Applying display settings:', config.displaySettings);
            
            // åå‰è¡¨ç¤ºè¨­å®šã®åæ˜ 
            if (typeof config.displaySettings.showName === 'boolean') {
              this.state.displaySettings = this.state.displaySettings || {};
              this.state.displaySettings.showName = config.displaySettings.showName;
              console.log('Name display setting applied:', config.displaySettings.showName);
            }
            
            // ã‚¯ãƒ©ã‚¹è¡¨ç¤ºè¨­å®šã®åæ˜ 
            if (typeof config.displaySettings.showClass === 'boolean') {
              this.state.displaySettings = this.state.displaySettings || {};
              this.state.displaySettings.showClass = config.displaySettings.showClass;
              console.log('Class display setting applied:', config.displaySettings.showClass);
            }
            
            // ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºè¨­å®šã®åæ˜ 
            if (typeof config.displaySettings.showEmail === 'boolean') {
              this.state.displaySettings = this.state.displaySettings || {};
              this.state.displaySettings.showEmail = config.displaySettings.showEmail;
              console.log('Email display setting applied:', config.displaySettings.showEmail);
            }
            
            // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ¢ãƒ¼ãƒ‰è¨­å®šã®åæ˜ 
            if (typeof config.displaySettings.privacyMode === 'boolean') {
              this.state.displaySettings = this.state.displaySettings || {};
              this.state.displaySettings.privacyMode = config.displaySettings.privacyMode;
              console.log('Privacy mode setting applied:', config.displaySettings.privacyMode);
            }
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã®åæ˜ 
            if (typeof config.displaySettings.enableAnimations === 'boolean') {
              this.state.displaySettings = this.state.displaySettings || {};
              this.state.displaySettings.enableAnimations = config.displaySettings.enableAnimations;
              console.log('Animation setting applied:', config.displaySettings.enableAnimations);
            }
            
          } else {
            console.log('No display settings found in configJSON, using defaults');
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            this.state.displaySettings = {
              showName: false,
              showClass: false, 
              showEmail: false,
              privacyMode: true,
              enableAnimations: true
            };
          }
          
        } catch (error) {
          console.error('Error applying config display settings:', error);
        }
      }

      /**
       * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
       */
      async loadSheetData() {
        if (this.state.isLoading) return;
        this.state.isLoading = true;
        
        try {
          // UserIdã‚’å–å¾—ï¼ˆGASç’°å¢ƒã‹ã‚‰ï¼‰
          const userId = '<?= typeof userInfo !== "undefined" && userInfo && userInfo.userId ? userInfo.userId : "" ?>';
          
          // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
          console.log('loadSheetData called with:', {
            userId: userId,
            hasUserId: !!userId,
            userIdLength: userId.length
          });
          
          // userIdãŒç©ºã®å ´åˆã®å‡¦ç†
          if (!userId) {
            console.warn('userId is empty, trying to use mock data or fallback');
            // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã§ä¸€æ™‚çš„ã«è¡¨ç¤º
            const mockData = await this.getMockData('getPublishedSheetData');
            this.state.currentAnswers = mockData.rows || [];
            this.elements.headingLabel.textContent = this.escapeHtml(mockData.header || 'å•é¡Œ');
            if (this.elements.sheetNameText) {
              this.elements.sheetNameText.textContent = 'ã‚·ãƒ¼ãƒˆ: ' + this.escapeHtml(mockData.sheetName || 'ä¸æ˜');
            }
            this.renderBoard();
            this.showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç®¡ç†è€…ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return;
          }
          
          const selectedClass = 'ã™ã¹ã¦';
          const sortOrder = this.elements.sortOrder.value;
          
          console.log('Calling getPublishedSheetData with:', {
            userId, selectedClass, sortOrder
          });
          
          const data = await this.runGas('getPublishedSheetData', userId, selectedClass, sortOrder);
          
          console.log('getPublishedSheetData response:', {
            hasData: !!data,
            rowsCount: data?.rows?.length || 0,
            dataArrayLength: data?.data?.length || 0,
            header: data?.header,
            sheetName: data?.sheetName,
            dataStructure: Object.keys(data || {})
          });
          
          // ğŸ”§ ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–: å³å¯†ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ æ¤œè¨¼ã¨çµ±ä¸€åŒ–
          this.state.currentAnswers = this.normalizeSheetData(data);
          this.elements.headingLabel.textContent = this.escapeHtml(data.header || 'å•é¡Œ');
          
          if (this.elements.sheetNameText) {
            this.elements.sheetNameText.textContent = 'ã‚·ãƒ¼ãƒˆ: ' + this.escapeHtml(data.sheetName || 'ä¸æ˜');
          }
          
          this.renderBoard();
        } catch (error) {
          console.error('Error loading sheet data:', error);
          console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            name: error.name
          });
          this.showError(error.message || 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        } finally {
          this.state.isLoading = false;
        }
      }

      /**
       * ğŸš€ å·®åˆ†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ : åŠ¹ç‡çš„ãªæç”»æ›´æ–°
       */
      renderBoard() {
        const container = this.elements.answersContainer;
        const newRows = this.state.currentAnswers;
        
        this.elements.sliderValue.textContent = this.elements.sizeSlider.value;
        // ã‚°ãƒªãƒƒãƒ‰åˆ—æ•°ã‚’æ›´æ–°
        container.className = 'grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-' + this.elements.sizeSlider.value;
        
        // ğŸ”’ å›ç­”æ•°è¡¨ç¤ºã®å®‰å…¨ãªæ›´æ–°
        this.updateAnswerCount(newRows.length);
        
        if (newRows.length === 0) {
          this.renderEmptyState(container);
        } else {
          // ğŸš€ å·®åˆ†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
          this.performDifferentialRender(container, newRows);
        }
      }

      /**
       * ğŸ“­ ç©ºçŠ¶æ…‹ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
       */
      renderEmptyState(container) {
        // æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ã¦ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        this.clearBoardContainer(container);
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'text-center text-gray-500 col-span-full mt-8';
        emptyMessage.textContent = 'å›ç­”ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        container.appendChild(emptyMessage);
      }

      /**
       * ğŸš€ å·®åˆ†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œ
       */
      performDifferentialRender(container, newRows) {
        try {
          // ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®åˆæœŸåŒ–
          if (!this.cardRegistry) {
            this.initializeCardRegistry();
          }
          
          // å·®åˆ†è¨ˆç®—
          const diff = this.calculateDifferences(newRows);
          
          // åŠ¹ç‡çš„ãªæ›´æ–°é©ç”¨
          this.applyDifferences(container, diff, newRows);
          
          // ãƒ¬ã‚¸ã‚¹ãƒˆãƒªæ›´æ–°
          this.updateCardRegistry(newRows);
          
        } catch (error) {
          console.error('Differential render error:', error);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å…¨å†æç”»
          this.fallbackFullRender(container, newRows);
        }
      }

      /**
       * ğŸ“‹ ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¸ã‚¹ãƒˆãƒªåˆæœŸåŒ–
       */
      initializeCardRegistry() {
        this.cardRegistry = {
          cards: new Map(), // rowIndex -> DOM element
          data: new Map(),  // rowIndex -> data object
          lastUpdate: Date.now()
        };
      }

      /**
       * ğŸ” å·®åˆ†è¨ˆç®—
       */
      calculateDifferences(newRows) {
        const diff = {
          toAdd: [],     // æ–°è¦è¿½åŠ 
          toUpdate: [],  // æ›´æ–°ãŒå¿…è¦
          toRemove: [],  // å‰Šé™¤ãŒå¿…è¦
          unchanged: []  // å¤‰æ›´ãªã—
        };
        
        // ç¾åœ¨ã®è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é›†åˆ
        const currentRowIndices = new Set(this.cardRegistry.data.keys());
        const newRowIndices = new Set(newRows.map(row => row.rowIndex));
        
        // æ–°è¦è¿½åŠ ã®æ¤œå‡º
        newRows.forEach(row => {
          if (!currentRowIndices.has(row.rowIndex)) {
            diff.toAdd.push(row);
          } else {
            // æ›´æ–°ãƒã‚§ãƒƒã‚¯
            const currentData = this.cardRegistry.data.get(row.rowIndex);
            if (this.needsUpdate(currentData, row)) {
              diff.toUpdate.push(row);
            } else {
              diff.unchanged.push(row);
            }
          }
        });
        
        // å‰Šé™¤ã®æ¤œå‡º
        currentRowIndices.forEach(rowIndex => {
          if (!newRowIndices.has(rowIndex)) {
            diff.toRemove.push(rowIndex);
          }
        });
        
        console.log('Differential render:', {
          add: diff.toAdd.length,
          update: diff.toUpdate.length,
          remove: diff.toRemove.length,
          unchanged: diff.unchanged.length
        });
        
        return diff;
      }

      /**
       * ğŸ”„ æ›´æ–°ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
       */
      needsUpdate(currentData, newData) {
        if (!currentData) return true;
        
        // ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¯”è¼ƒ
        const fieldsToCheck = ['opinion', 'reason', 'name', 'class', 'highlight'];
        for (const field of fieldsToCheck) {
          if (currentData[field] !== newData[field]) {
            return true;
          }
        }
        
        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¯”è¼ƒ
        return this.reactionsChanged(currentData.reactions, newData.reactions);
      }

      /**
       * âš¡ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¤‰æ›´ãƒã‚§ãƒƒã‚¯
       */
      reactionsChanged(current, updated) {
        if (!current || !updated) return true;
        
        const keys = ['UNDERSTAND', 'LIKE', 'CURIOUS'];
        for (const key of keys) {
          if (!current[key] || !updated[key]) return true;
          if (current[key].count !== updated[key].count || 
              current[key].reacted !== updated[key].reacted) {
            return true;
          }
        }
        
        return false;
      }

      /**
       * âœ¨ å·®åˆ†é©ç”¨
       */
      applyDifferences(container, diff, newRows) {
        // requestAnimationFrame ã§æ»‘ã‚‰ã‹ãªæ›´æ–°
        requestAnimationFrame(() => {
          // å‰Šé™¤å‡¦ç†
          diff.toRemove.forEach(rowIndex => {
            const card = this.cardRegistry.cards.get(rowIndex);
            if (card && card.parentNode) {
              card.parentNode.removeChild(card);
            }
          });
          
          // è¿½åŠ å‡¦ç†ï¼ˆDocumentFragmentã§ãƒãƒƒãƒåŒ–ï¼‰
          if (diff.toAdd.length > 0) {
            const fragment = document.createDocumentFragment();
            diff.toAdd.forEach(row => {
              const card = this.createAnswerCard(row);
              this.cardRegistry.cards.set(row.rowIndex, card);
              fragment.appendChild(card);
            });
            container.appendChild(fragment);
          }
          
          // æ›´æ–°å‡¦ç†
          diff.toUpdate.forEach(row => {
            this.updateExistingCard(row);
          });
        });
      }

      /**
       * ğŸ”„ æ—¢å­˜ã‚«ãƒ¼ãƒ‰æ›´æ–°
       */
      updateExistingCard(rowData) {
        const existingCard = this.cardRegistry.cards.get(rowData.rowIndex);
        if (!existingCard) return;
        
        // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
        const newCard = this.createAnswerCard(rowData);
        
        // DOMç½®æ›ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
        existingCard.style.opacity = '0';
        setTimeout(() => {
          if (existingCard.parentNode) {
            existingCard.parentNode.replaceChild(newCard, existingCard);
            this.cardRegistry.cards.set(rowData.rowIndex, newCard);
            newCard.style.opacity = '1';
          }
        }, 150);
      }

      /**
       * ğŸ“ ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¸ã‚¹ãƒˆãƒªæ›´æ–°
       */
      updateCardRegistry(newRows) {
        this.cardRegistry.data.clear();
        newRows.forEach(row => {
          this.cardRegistry.data.set(row.rowIndex, { ...row });
        });
        this.cardRegistry.lastUpdate = Date.now();
      }

      /**
       * ğŸ†˜ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å…¨å†æç”»
       */
      fallbackFullRender(container, newRows) {
        console.warn('Using fallback full render');
        this.clearBoardContainer(container);
        this.initializeCardRegistry();
        
        const fragment = document.createDocumentFragment();
        newRows.forEach((row) => {
          const card = this.createAnswerCard(row);
          this.cardRegistry.cards.set(row.rowIndex, card);
          fragment.appendChild(card);
        });
        container.appendChild(fragment);
        
        this.updateCardRegistry(newRows);
      }

      /**
       * ğŸ›¡ï¸ ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢: ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã‚’å®‰å…¨ã«ã‚¯ãƒªã‚¢
       */
      clearBoardContainer(container) {
        // æ—¢å­˜ã®è¦ç´ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        const existingCards = container.querySelectorAll('.answer-card');
        existingCards.forEach(card => {
          // data-*å±æ€§ã‚’ã‚¯ãƒªã‚¢
          card.removeAttribute('data-row-index');
          // event listenerå‚ç…§ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰
          card.replaceWith(card.cloneNode(false));
        });
        
        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        const existingButtons = container.querySelectorAll('.reaction-btn');
        existingButtons.forEach(button => {
          button.removeAttribute('data-row-index');
          button.removeAttribute('data-reaction');
        });
        
        // ğŸ”’ DOMè¦ç´ ã‚’å®‰å…¨ã«ã‚¯ãƒªã‚¢ï¼ˆinnerHTMLä½¿ç”¨ã›ãšï¼‰
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
        
        // ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ’ãƒ³ãƒˆ
        if (window.gc) {
          setTimeout(() => window.gc(), 100);
        }
      }

      /**
       * ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: Identity ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®‰å…¨ã«ç”Ÿæˆ
       * XSSæ”»æ’ƒã‚’é˜²ããŸã‚ã€DOMæ“ä½œã§ã®ã¿è¦ç´ ã‚’æ§‹ç¯‰
       */
      createIdentitySection(data, displaySettings) {
        // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
        if (!data || typeof data !== 'object') return null;
        
        const identityParts = [];
        
        // åå‰è¡¨ç¤º
        if (displaySettings.showName && data.name && typeof data.name === 'string') {
          const nameSpan = document.createElement('span');
          nameSpan.className = 'font-bold text-sm text-gray-200';
          nameSpan.textContent = data.name; // textContentä½¿ç”¨ã§XSSé˜²æ­¢
          identityParts.push(nameSpan);
        }
        
        // ã‚¯ãƒ©ã‚¹è¡¨ç¤º
        if (displaySettings.showClass && data.class && typeof data.class === 'string') {
          const classSpan = document.createElement('span');
          classSpan.className = 'text-xs text-gray-400';
          classSpan.textContent = `(${data.class})`;
          identityParts.push(classSpan);
        }
        
        // ãƒ¡ãƒ¼ãƒ«è¡¨ç¤º
        if (displaySettings.showEmail && data.email && typeof data.email === 'string') {
          const emailSpan = document.createElement('span');
          emailSpan.className = 'text-xs text-gray-500';
          emailSpan.textContent = data.email;
          identityParts.push(emailSpan);
        }
        
        // ã‚³ãƒ³ãƒ†ãƒŠè¦ç´ ãŒãªã„å ´åˆã¯nullè¿”å´
        if (identityParts.length === 0) return null;
        
        // ã‚³ãƒ³ãƒ†ãƒŠã«å®‰å…¨ã«è¿½åŠ 
        const container = document.createElement('div');
        identityParts.forEach((part, index) => {
          if (index > 0) {
            // ã‚¹ãƒšãƒ¼ã‚¹ã¾ãŸã¯æ”¹è¡Œã‚’å®‰å…¨ã«è¿½åŠ 
            if (displaySettings.showEmail && index === identityParts.length - 1 && identityParts.length > 1) {
              container.appendChild(document.createElement('br'));
            } else {
              container.appendChild(document.createTextNode(' '));
            }
          }
          container.appendChild(part);
        });
        
        return container;
      }

      /**
       * ğŸ”§ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„: å›ç­”ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚’ç”Ÿæˆï¼ˆåˆ†é›¢è¨­è¨ˆï¼‰
       */
      createAnswerCard(data) {
        // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
        if (!this.validateCardData(data)) {
          console.warn('Invalid card data:', data);
          return this.createErrorCard();
        }

        const card = this.createCardStructure(data);
        this.applyCardStyling(card, data);
        this.attachCardAccessibility(card, data);
        
        return card;
      }

      /**
       * ğŸ›¡ï¸ ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å³å¯†æ¤œè¨¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰
       */
      validateCardData(data) {
        try {
          // null/undefined ãƒã‚§ãƒƒã‚¯
          if (!data || typeof data !== 'object') {
            return false;
          }
          
          // rowIndexå³å¯†æ¤œè¨¼
          if (typeof data.rowIndex !== 'number' || data.rowIndex <= 0) {
            return false;
          }
          
          // opinionå³å¯†æ¤œè¨¼
          if (typeof data.opinion !== 'string' || data.opinion.trim().length === 0) {
            return false;
          }
          
          // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‹ãƒã‚§ãƒƒã‚¯
          if (data.reason !== undefined && typeof data.reason !== 'string') {
            return false;
          }
          
          if (data.name !== undefined && typeof data.name !== 'string') {
            return false;
          }
          
          if (data.class !== undefined && typeof data.class !== 'string') {
            return false;
          }
          
          if (data.email !== undefined && typeof data.email !== 'string') {
            return false;
          }
          
          // reactionsæ¤œè¨¼
          if (data.reactions !== undefined) {
            if (typeof data.reactions !== 'object' || !this.validateReactions(data.reactions)) {
              return false;
            }
          }
          
          return true;
          
        } catch (error) {
          console.error('Card validation error:', error);
          return false;
        }
      }

      /**
       * âš¡ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
       */
      validateReactions(reactions) {
        const requiredKeys = ['UNDERSTAND', 'LIKE', 'CURIOUS'];
        
        for (const key of requiredKeys) {
          if (!reactions[key] || typeof reactions[key] !== 'object') {
            return false;
          }
          
          const reaction = reactions[key];
          if (typeof reaction.count !== 'number' || reaction.count < 0) {
            return false;
          }
          
          if (typeof reaction.reacted !== 'boolean') {
            return false;
          }
        }
        
        return true;
      }

      /**
       * âš ï¸ ã‚¨ãƒ©ãƒ¼ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
       */
      createErrorCard() {
        const errorCard = document.createElement('div');
        errorCard.className = 'answer-card glass-panel rounded-xl p-4 border-2 border-red-500/50';
        
        // ğŸ”’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®‰å…¨ã«è¿½åŠ 
        const errorMessage = document.createElement('p');
        errorMessage.className = 'text-red-400';
        errorMessage.textContent = 'ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™';
        errorCard.appendChild(errorMessage);
        
        return errorCard;
      }

      /**
       * ğŸ—ï¸ ã‚«ãƒ¼ãƒ‰DOMæ§‹é€ ä½œæˆ
       */
      createCardStructure(data) {
        const card = document.createElement('div');
        
        // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†
        const contentSection = this.createContentSection(data);
        card.appendChild(contentSection);
        
        // ãƒ•ãƒƒã‚¿ãƒ¼éƒ¨åˆ†ï¼ˆidentity + reactionsï¼‰
        const footerSection = this.createFooterSection(data);
        card.appendChild(footerSection);
        
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒãƒƒã‚¸
        if (data.highlight) {
          const badge = this.createHighlightBadge();
          card.appendChild(badge);
        }
        
        return card;
      }

      /**
       * ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
       */
      createContentSection(data) {
        const contentDiv = document.createElement('div');
        contentDiv.className = 'relative flex-grow mb-3 answer-preview';
        
        // æ„è¦‹éƒ¨åˆ†
        const opinionH3 = document.createElement('h3');
        opinionH3.className = 'opinion-text text-cyan-200 whitespace-pre-wrap break-words text-xl md:text-2xl font-semibold leading-tight';
        opinionH3.textContent = data.opinion || '';
        contentDiv.appendChild(opinionH3);
        
        // ç†ç”±éƒ¨åˆ†
        if (data.reason) {
          const reasonP = document.createElement('p');
          reasonP.className = 'text-gray-100 whitespace-pre-wrap break-words mt-4';
          reasonP.textContent = data.reason;
          contentDiv.appendChild(reasonP);
        }
        
        return contentDiv;
      }

      /**
       * ğŸ‘¥ ãƒ•ãƒƒã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
       */
      createFooterSection(data) {
        const footerDiv = document.createElement('div');
        
        // Identityéƒ¨åˆ†
        const identityContainer = this.createIdentitySection(data, this.state.displaySettings || {});
        
        // Reactionséƒ¨åˆ†
        const reactionsContainer = this.createReactionsSection(data);
        
        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š
        if (identityContainer) {
          footerDiv.className = 'text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex justify-between items-center';
          footerDiv.appendChild(identityContainer);
          footerDiv.appendChild(reactionsContainer);
        } else {
          footerDiv.className = 'text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex justify-end items-center';
          footerDiv.appendChild(reactionsContainer);
        }
        
        return footerDiv;
      }

      /**
       * âš¡ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
       */
      createReactionsSection(data) {
        const reactionsDiv = document.createElement('div');
        reactionsDiv.className = 'flex items-center gap-1';
        reactionsDiv.setAttribute('role', 'group');
        
        this.reactionTypes.forEach(rt => {
          const reactionButton = this.createReactionButton(data, rt);
          reactionsDiv.appendChild(reactionButton);
        });
        
        return reactionsDiv;
      }

      /**
       * ğŸ”˜ å€‹åˆ¥ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ä½œæˆ
       */
      createReactionButton(data, reactionType) {
        const info = data.reactions ? data.reactions[reactionType.key] : { count: 0, reacted: false };
        
        const button = document.createElement('button');
        button.type = 'button';
        button.dataset.rowIndex = data.rowIndex;
        button.dataset.reaction = reactionType.key;
        
        // ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°é©ç”¨
        this.applyReactionButtonStyle(button, reactionType.key, info.reacted);
        
        // ğŸ”’ ã‚¢ã‚¤ã‚³ãƒ³ã‚’å®‰å…¨ã«è¿½åŠ 
        const iconElement = this.createIcon(reactionType.icon, 'w-5 h-5', info.reacted);
        button.appendChild(iconElement);
        
        // ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ 
        const countSpan = document.createElement('span');
        countSpan.className = 'text-xs font-medium ml-1';
        countSpan.textContent = info.count;
        button.appendChild(countSpan);
        
        return button;
      }

      /**
       * â­ ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒãƒƒã‚¸ä½œæˆ
       */
      createHighlightBadge() {
        const badge = document.createElement('span');
        badge.className = 'highlight-badge';
        
        // ğŸ”’ ã‚¢ã‚¤ã‚³ãƒ³ã‚’å®‰å…¨ã«è¿½åŠ 
        const starIcon = this.createIcon('star', '', true);
        badge.appendChild(starIcon);
        
        return badge;
      }

      /**
       * ğŸ¨ ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°é©ç”¨
       */
      applyCardStyling(card, data) {
        const highlightClass = data.highlight ? ' highlighted' : '';
        card.className = 'relative answer-card glass-panel rounded-xl p-4 flex flex-col justify-between shadow-lg border-2 border-cyan-400/80 cursor-pointer' + highlightClass;
        card.dataset.rowIndex = data.rowIndex;
      }

      /**
       * ğŸ”˜ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
       */
      applyReactionButtonStyle(button, reactionKey, isReacted) {
        let buttonClass = 'reaction-btn flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all duration-200 ';
        
        if (isReacted) {
          // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¸ˆã¿ã®å ´åˆã®è‰²è¨­å®š
          if (reactionKey === 'LIKE') {
            buttonClass += 'bg-red-500/20 border-red-500 text-red-400 reacted';
          } else if (reactionKey === 'UNDERSTAND') {
            buttonClass += 'bg-yellow-500/20 border-yellow-500 text-yellow-400 reacted';
          } else if (reactionKey === 'CURIOUS') {
            buttonClass += 'bg-green-500/20 border-green-500 text-green-400 reacted';
          }
        } else {
          // æœªãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã®è‰²è¨­å®š
          if (reactionKey === 'LIKE') {
            buttonClass += 'bg-transparent border-red-500/30 text-red-500/60 hover:bg-red-500/10 hover:text-red-400';
          } else if (reactionKey === 'UNDERSTAND') {
            buttonClass += 'bg-transparent border-yellow-500/30 text-yellow-500/60 hover:bg-yellow-500/10 hover:text-yellow-400';
          } else if (reactionKey === 'CURIOUS') {
            buttonClass += 'bg-transparent border-green-500/30 text-green-500/60 hover:bg-green-500/10 hover:text-green-400';
          }
        }
        
        button.className = buttonClass;
      }

      /**
       * â™¿ ã‚«ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¨­å®š
       */
      attachCardAccessibility(card, data) {
        card.setAttribute('role', 'article');
        card.setAttribute('tabindex', '0');
        card.setAttribute('aria-label', `å›ç­”: ${data.opinion ? data.opinion.substring(0, 50) : ''}...`);
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
        card.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            this.showAnswerModal(data.rowIndex);
          }
        });
      }

      /**
       * ğŸ›¡ï¸ ä¿¡é ¼æ€§å‘ä¸Š: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
       */
      showError(message, options = {}) {
        try {
          const {
            type = 'error',
            retryable = false,
            autoHide = true,
            duration = 5000
          } = options;

          console.error('App Error:', {
            message,
            type,
            timestamp: new Date().toISOString(),
            stack: new Error().stack
          });

          // ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ãƒ‡ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ã‚³ãƒ³ãƒ†ãƒŠãŒãªã„å ´åˆã®å‡¦ç†
          if (!this.elements.answersContainer) {
            this.fallbackErrorDisplay(message);
            return;
          }

          const errorContainer = this.createErrorDisplay(message, type, retryable);
          
          // æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
          this.clearBoardContainer(this.elements.answersContainer);
          this.elements.answersContainer.appendChild(errorContainer);

          // è‡ªå‹•éè¡¨ç¤ºè¨­å®š
          if (autoHide && duration > 0) {
            setTimeout(() => {
              this.hideError();
            }, duration);
          }

        } catch (error) {
          // ã‚¨ãƒ©ãƒ¼å‡¦ç†ä¸­ã®ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
          console.error('Error in showError:', error);
          this.fallbackErrorDisplay(message);
        }
      }

      /**
       * ğŸ“± ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºè¦ç´ ä½œæˆ
       */
      createErrorDisplay(message, type, retryable) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-center col-span-full mt-8 p-4 rounded-lg';
        errorDiv.id = 'error-display';
        
        // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
        switch (type) {
          case 'warning':
            errorDiv.className += ' text-yellow-400 bg-yellow-900/20 border border-yellow-500/30';
            break;
          case 'info':
            errorDiv.className += ' text-blue-400 bg-blue-900/20 border border-blue-500/30';
            break;
          default:
            errorDiv.className += ' text-red-400 bg-red-900/20 border border-red-500/30';
        }

        // ğŸ”’ ã‚¨ãƒ©ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’å®‰å…¨ã«è¿½åŠ 
        const iconElement = this.createIcon('x-circle', 'w-8 h-8 mx-auto mb-2');
        errorDiv.appendChild(iconElement);

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const titleP = document.createElement('p');
        titleP.className = 'font-bold mb-2';
        titleP.textContent = this.getErrorTitle(type);
        errorDiv.appendChild(titleP);

        const messageP = document.createElement('p');
        messageP.className = 'text-sm';
        messageP.textContent = message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        errorDiv.appendChild(messageP);

        // ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³
        if (retryable) {
          const retryButton = document.createElement('button');
          retryButton.className = 'mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors';
          retryButton.textContent = 'å†è©¦è¡Œ';
          retryButton.addEventListener('click', () => {
            this.retryLastOperation();
          });
          errorDiv.appendChild(retryButton);
        }

        return errorDiv;
      }

      /**
       * ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
       */
      fallbackErrorDisplay(message) {
        // consoleã€alertã€ã¾ãŸã¯é€šçŸ¥APIä½¿ç”¨
        if (window.console && window.console.error) {
          console.error('Fallback error display:', message);
        }
        
        if (window.alert) {
          setTimeout(() => {
            window.alert(`ã‚¨ãƒ©ãƒ¼: ${message}`);
          }, 100);
        }
        
        // å¯èƒ½ã§ã‚ã‚Œã° document.body ã«ç›´æ¥è¿½åŠ 
        try {
          const fallbackDiv = document.createElement('div');
          fallbackDiv.style.cssText = `
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: #dc2626; 
            color: white; 
            padding: 16px; 
            border-radius: 8px; 
            z-index: 9999;
            max-width: 300px;
          `;
          fallbackDiv.textContent = message;
          document.body.appendChild(fallbackDiv);
          
          setTimeout(() => {
            if (fallbackDiv.parentNode) {
              fallbackDiv.parentNode.removeChild(fallbackDiv);
            }
          }, 5000);
        } catch (error) {
          // å®Œå…¨ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¤±æ•—ã®å ´åˆã¯consoleã®ã¿
          console.error('Complete fallback failure:', error, message);
        }
      }

      /**
       * ğŸ“ ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
       */
      getErrorTitle(type) {
        switch (type) {
          case 'warning': return 'æ³¨æ„';
          case 'info': return 'ãŠçŸ¥ã‚‰ã›';
          case 'network': return 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼';
          case 'permission': return 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚¨ãƒ©ãƒ¼';
          default: return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        }
      }

      /**
       * âŒ ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºéè¡¨ç¤º
       */
      hideError() {
        try {
          const errorDisplay = document.getElementById('error-display');
          if (errorDisplay) {
            errorDisplay.style.opacity = '0';
            errorDisplay.style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
              if (errorDisplay.parentNode) {
                errorDisplay.parentNode.removeChild(errorDisplay);
              }
            }, 300);
          }
        } catch (error) {
          console.error('Error hiding error display:', error);
        }
      }

      /**
       * ğŸ”„ æœ€å¾Œã®æ“ä½œã‚’ãƒªãƒˆãƒ©ã‚¤
       */
      retryLastOperation() {
        try {
          console.log('Retrying last operation...');
          this.hideError();
          
          // æœ€ã‚‚ä¸€èˆ¬çš„ãªæ“ä½œã§ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚’ãƒªãƒˆãƒ©ã‚¤
          this.loadSheetData();
        } catch (error) {
          console.error('Retry failed:', error);
          this.showError('ãƒªãƒˆãƒ©ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ', { retryable: false });
        }
      }

      /**
       * å›ç­”ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
       */
      hideAnswerModal() {
        this.elements.answerModalContainer.classList.add('hidden');
      }

      /**
       * ğŸ”§ ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–ã‚·ã‚¹ãƒ†ãƒ : å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®å³å¯†ãªæ¤œè¨¼ã¨çµ±ä¸€åŒ–
       */
      normalizeSheetData(rawData) {
        try {
          console.log('ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–é–‹å§‹:', rawData);
          
          // ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ç¢ºèª
          if (!rawData || typeof rawData !== 'object') {
            console.warn('Invalid data structure:', rawData);
            return [];
          }
          
          // ãƒ‡ãƒ¼ã‚¿é…åˆ—ã®æŠ½å‡ºã¨æ¤œè¨¼
          let dataArray = this.extractDataArray(rawData);
          
          // å„ãƒ‡ãƒ¼ã‚¿é …ç›®ã®æ­£è¦åŒ–
          const normalizedData = dataArray.map((item, index) => {
            try {
              return this.normalizeDataItem(item, index);
            } catch (error) {
              console.error(`Data item ${index} normalization failed:`, error);
              return null; // ç„¡åŠ¹ãªé …ç›®ã¯nullã«
            }
          }).filter(item => item !== null); // nullé …ç›®ã‚’é™¤å¤–
          
          console.log(`ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–å®Œäº†: ${dataArray.length}ä»¶ â†’ ${normalizedData.length}ä»¶`);
          return normalizedData;
          
        } catch (error) {
          console.error('ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–ã‚¨ãƒ©ãƒ¼:', error);
          return []; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        }
      }

      /**
       * ğŸ“Š ãƒ‡ãƒ¼ã‚¿é…åˆ—æŠ½å‡ºï¼ˆè¤‡æ•°å½¢å¼å¯¾å¿œï¼‰
       */
      extractDataArray(rawData) {
        // å„ªå…ˆé †ä½ã«åŸºã¥ãæŠ½å‡º
        if (Array.isArray(rawData.rows) && rawData.rows.length > 0) {
          return rawData.rows;
        }
        
        if (Array.isArray(rawData.data) && rawData.data.length > 0) {
          return rawData.data;
        }
        
        if (Array.isArray(rawData)) {
          return rawData;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰é…åˆ—ã‚’æ¢ç´¢
        for (const key in rawData) {
          if (Array.isArray(rawData[key]) && rawData[key].length > 0) {
            console.warn(`Fallback: Using data from key "${key}"`);
            return rawData[key];
          }
        }
        
        return [];
      }

      /**
       * ğŸ“ å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿é …ç›®ã®æ­£è¦åŒ–
       */
      normalizeDataItem(item, index) {
        if (!item || typeof item !== 'object') {
          throw new Error(`Invalid item type: ${typeof item}`);
        }
        
        // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼ã¨æ­£è¦åŒ–
        const rowIndex = this.normalizeRowIndex(item.rowIndex, index);
        const opinion = this.normalizeOpinion(item.opinion);
        
        // æ­£è¦åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        const normalizedItem = {
          rowIndex: rowIndex,
          opinion: opinion,
          reason: this.normalizeText(item.reason, ''),
          name: this.normalizeText(item.name, ''),
          class: this.normalizeText(item.class, ''),
          email: this.normalizeEmail(item.email),
          reactions: this.normalizeReactions(item.reactions),
          highlight: Boolean(item.highlight)
        };
        
        return normalizedItem;
      }

      /**
       * ğŸ”¢ rowIndexæ­£è¦åŒ–
       */
      normalizeRowIndex(rowIndex, fallbackIndex) {
        if (typeof rowIndex === 'number' && rowIndex > 0) {
          return rowIndex;
        }
        
        if (typeof rowIndex === 'string' && !isNaN(parseInt(rowIndex))) {
          const parsed = parseInt(rowIndex);
          if (parsed > 0) return parsed;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹
        return fallbackIndex + 1;
      }

      /**
       * ğŸ’¬ æ„è¦‹ãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–
       */
      normalizeOpinion(opinion) {
        if (typeof opinion !== 'string') {
          throw new Error('Opinion must be a string');
        }
        
        const trimmed = opinion.trim();
        if (trimmed.length === 0) {
          throw new Error('Opinion cannot be empty');
        }
        
        if (trimmed.length > 1000) {
          console.warn('Opinion text truncated:', trimmed.length);
          return trimmed.substring(0, 1000) + '...';
        }
        
        return trimmed;
      }

      /**
       * ğŸ“ ä¸€èˆ¬ãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–
       */
      normalizeText(text, defaultValue = '') {
        if (typeof text !== 'string') {
          return defaultValue;
        }
        
        const trimmed = text.trim();
        return trimmed || defaultValue;
      }

      /**
       * âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«æ­£è¦åŒ–
       */
      normalizeEmail(email) {
        if (typeof email !== 'string') {
          return '';
        }
        
        const trimmed = email.trim().toLowerCase();
        
        // ç°¡æ˜“ãƒ¡ãƒ¼ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailRegex.test(trimmed)) {
          return trimmed;
        }
        
        return '';
      }

      /**
       * âš¡ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–
       */
      normalizeReactions(reactions) {
        const defaultReactions = {
          UNDERSTAND: { count: 0, reacted: false },
          LIKE: { count: 0, reacted: false },
          CURIOUS: { count: 0, reacted: false }
        };
        
        if (!reactions || typeof reactions !== 'object') {
          return defaultReactions;
        }
        
        const normalized = {};
        for (const key of ['UNDERSTAND', 'LIKE', 'CURIOUS']) {
          if (reactions[key] && typeof reactions[key] === 'object') {
            normalized[key] = {
              count: Math.max(0, parseInt(reactions[key].count) || 0),
              reacted: Boolean(reactions[key].reacted)
            };
          } else {
            normalized[key] = defaultReactions[key];
          }
        }
        
        return normalized;
      }

      /**
       * ğŸ”’ XSSå®‰å…¨: å›ç­”æ•°è¡¨ç¤ºã‚’å®‰å…¨ã«æ›´æ–°
       */
      updateAnswerCount(count) {
        try {
          if (!this.elements.answerCount) return;
          
          // ğŸ”’ æ—¢å­˜å†…å®¹ã‚’å®‰å…¨ã«ã‚¯ãƒªã‚¢
          while (this.elements.answerCount.firstChild) {
            this.elements.answerCount.removeChild(this.elements.answerCount.firstChild);
          }
          
          // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å®‰å…¨ã«è¿½åŠ 
          const userIcon = this.createIcon('users', 'w-4 h-4 inline-block -mt-1');
          this.elements.answerCount.appendChild(userIcon);
          
          // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã‚’å®‰å…¨ã«è¿½åŠ 
          const countSpan = document.createElement('span');
          countSpan.textContent = count + 'ä»¶';
          this.elements.answerCount.appendChild(countSpan);
          
        } catch (error) {
          console.error('Answer count update error:', error);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          this.elements.answerCount.textContent = count + 'ä»¶';
        }
      }

      /**
       * ğŸ”’ XSSå®‰å…¨: SVGã‚¢ã‚¤ã‚³ãƒ³ã®DOMè¦ç´ ã‚’å®‰å…¨ã«ç”Ÿæˆ
       */
      createIcon(name, classes = '', solid = false) {
        // ã‚¢ã‚¤ã‚³ãƒ³ã‚­ãƒ¼ã®å„ªå…ˆé †ä½: solidç‰ˆ > outlineç‰ˆ > ãƒ—ãƒ¬ãƒ¼ãƒ³ç‰ˆ
        let key;
        if (solid && ICONS[name + '-solid']) {
          key = name + '-solid';
        } else if (ICONS[name + '-outline']) {
          key = name + '-outline';
        } else if (ICONS[name]) {
          key = name;
        } else {
          console.warn('Icon not found:', name);
          return this.createFallbackIcon(classes);
        }
        
        return this.createSVGElement(ICONS[key], classes);
      }

      /**
       * ğŸ”’ å®‰å…¨ãªSVGè¦ç´ ä½œæˆ
       */
      createSVGElement(svgString, classes) {
        try {
          // å®‰å…¨ãªSVGãƒ‘ãƒ¼ã‚¹
          const parser = new DOMParser();
          const doc = parser.parseFromString(svgString, 'image/svg+xml');
          const svgElement = doc.documentElement;
          
          if (svgElement.nodeName !== 'svg') {
            throw new Error('Invalid SVG');
          }
          
          // ã‚¯ãƒ©ã‚¹é©ç”¨
          if (classes) {
            svgElement.setAttribute('class', classes);
          }
          svgElement.setAttribute('aria-hidden', 'true');
          
          // æ–°ã—ã„SVGè¦ç´ ã¨ã—ã¦è¿”å´
          const newSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          
          // å±æ€§ã‚’ã‚³ãƒ”ãƒ¼
          for (const attr of svgElement.attributes) {
            newSvg.setAttribute(attr.name, attr.value);
          }
          
          // ã‚¯ãƒ©ã‚¹å±æ€§ã‚’è¿½åŠ /æ›´æ–°
          if (classes) {
            const existingClasses = newSvg.getAttribute('class') || '';
            newSvg.setAttribute('class', existingClasses ? `${existingClasses} ${classes}` : classes);
          }
          
          // å­è¦ç´ ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆinnerHTMLä½¿ç”¨ã›ãšï¼‰
          while (svgElement.firstChild) {
            newSvg.appendChild(svgElement.firstChild);
          }
          
          return newSvg;
          
        } catch (error) {
          console.error('SVG parsing error:', error);
          return this.createFallbackIcon(classes);
        }
      }

      /**
       * ğŸ†˜ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³ä½œæˆ
       */
      createFallbackIcon(classes) {
        const span = document.createElement('span');
        span.setAttribute('aria-hidden', 'true');
        span.className = classes;
        span.textContent = 'â­';
        return span;
      }

      /**
       * ğŸ”„ å¾Œæ–¹äº’æ›æ€§: getIcon (ãƒ¬ã‚¬ã‚·ãƒ¼ã‚µãƒãƒ¼ãƒˆ)
       * @deprecated createIcon()ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
       */
      getIcon(name, classes = '', solid = false) {
        const iconElement = this.createIcon(name, classes, solid);
        return iconElement.outerHTML;
      }
      
      /**
       * ğŸ”’ ä¸»è¦ãªã‚¢ã‚¤ã‚³ãƒ³ã‚’å®‰å…¨ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆXSSå¯¾ç­–ç‰ˆï¼‰
       */
      renderIcons() {
        try {
          console.log('renderIcons: Starting icon rendering');
          
          // ğŸ”’ ã™ã¹ã¦ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å®‰å…¨ãªDOMæ“ä½œã§ç½®æ›
          this.replaceIconSafely('answerModalCloseBtn', 'x', 'w-6 h-6');
          console.log('renderIcons: x icon OK');
          
          this.replaceIconSafely('footerIcon', 'grid-2x2');
          console.log('renderIcons: grid-2x2 icon OK');
          
          if (this.elements.infoIconLike) {
            this.replaceIconSafely('infoIconLike', 'hand-thumb-up-outline');
            console.log('renderIcons: hand-thumb-up-outline icon OK');
          }
          if (this.elements.infoIconUnderstand) {
            this.replaceIconSafely('infoIconUnderstand', 'lightbulb-outline');
            console.log('renderIcons: lightbulb-outline icon OK');
          }
          if (this.elements.infoIconCurious) {
            this.replaceIconSafely('infoIconCurious', 'magnifying-glass-plus-outline');
            console.log('renderIcons: magnifying-glass-plus-outline icon OK');
          }
          if (this.elements.infoIconHighlight) {
            this.replaceIconSafely('infoIconHighlight', 'star-outline');
            console.log('renderIcons: star-outline icon OK');
          }
          
          console.log('renderIcons: All icons rendered successfully');
        } catch (error) {
          console.error('renderIcons: Error during icon rendering', error);
          // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¶™ç¶š
        }
      }

      /**
       * ğŸ”’ ã‚¢ã‚¤ã‚³ãƒ³ã‚’å®‰å…¨ã«ç½®æ›
       */
      replaceIconSafely(elementKey, iconName, classes = '') {
        try {
          const element = this.elements[elementKey];
          if (!element) return;
          
          // æ—¢å­˜å†…å®¹ã‚’ã‚¯ãƒªã‚¢
          while (element.firstChild) {
            element.removeChild(element.firstChild);
          }
          
          // æ–°ã—ã„ã‚¢ã‚¤ã‚³ãƒ³ã‚’å®‰å…¨ã«è¿½åŠ 
          const iconElement = this.createIcon(iconName, classes);
          element.appendChild(iconElement);
          
        } catch (error) {
          console.error(`Icon replacement error for ${elementKey}:`, error);
        }
      }

      /**
       * ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
       */
      async toggleReaction(rowIndex, reactionKey, buttonElement) {
        if (buttonElement.classList.contains('loading')) return;
        
        try {
          buttonElement.classList.add('loading');
          console.log('Toggling reaction:', { rowIndex, reactionKey });
          
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
          const userId = '<?= typeof userInfo !== "undefined" && userInfo && userInfo.userId ? userInfo.userId : "" ?>';
          if (!userId) {
            throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
          }
          
          // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒˆã‚°ãƒ«å‡¦ç†
          const result = await this.runGas('addReaction', userId, rowIndex, reactionKey);
          console.log('Reaction toggle result:', result);
          
          // UIæ›´æ–°ï¼šæ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°æ–¹å¼ã«åŸºã¥ã„ã¦æ›´æ–°
          const wasReacted = buttonElement.classList.contains('reacted');
          this.updateReactionButtonStyle(buttonElement, reactionKey, !wasReacted, result.count || 0);
          
          // æˆåŠŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
          buttonElement.classList.add('pulse');
          setTimeout(() => buttonElement.classList.remove('pulse'), 600);
          
        } catch (error) {
          console.error('Reaction error:', error);
          this.showError('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          buttonElement.classList.add('shake');
          setTimeout(() => buttonElement.classList.remove('shake'), 500);
        } finally {
          buttonElement.classList.remove('loading');
        }
      }

      /**
       * ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
       */
      updateReactionButtonStyle(buttonElement, reactionKey, isReacted, count) {
        try {
          // æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã‚¯ãƒ©ã‚¹ã‚’ã‚¯ãƒªã‚¢
          buttonElement.className = buttonElement.className.replace(/bg-\w+\/?\w*|border-\w+\/?\w*|text-\w+\/?\w*|reacted|hover:\w+/g, '').trim();
          
          // åŸºæœ¬ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
          let buttonClass = 'reaction-btn flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all duration-200 ';
          
          if (isReacted) {
            // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¸ˆã¿ã®å ´åˆã®è‰²è¨­å®š
            if (reactionKey === 'LIKE') {
              buttonClass += 'bg-red-500/20 border-red-500 text-red-400 reacted';
            } else if (reactionKey === 'UNDERSTAND') {
              buttonClass += 'bg-yellow-500/20 border-yellow-500 text-yellow-400 reacted';
            } else if (reactionKey === 'CURIOUS') {
              buttonClass += 'bg-green-500/20 border-green-500 text-green-400 reacted';
            }
          } else {
            // æœªãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã®è‰²è¨­å®š
            if (reactionKey === 'LIKE') {
              buttonClass += 'bg-transparent border-red-500/30 text-red-500/60 hover:bg-red-500/10 hover:text-red-400';
            } else if (reactionKey === 'UNDERSTAND') {
              buttonClass += 'bg-transparent border-yellow-500/30 text-yellow-500/60 hover:bg-yellow-500/10 hover:text-yellow-400';
            } else if (reactionKey === 'CURIOUS') {
              buttonClass += 'bg-transparent border-green-500/30 text-green-500/60 hover:bg-green-500/10 hover:text-green-400';
            }
          }
          
          buttonElement.className = buttonClass;
          
          // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
          const countSpan = buttonElement.querySelector('span');
          if (countSpan) {
            countSpan.textContent = count;
          }
          
          console.log('Button style updated:', { reactionKey, isReacted, count, className: buttonElement.className });
          
        } catch (error) {
          console.error('Error updating reaction button style:', error);
        }
      }

      /**
       * ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
       */
      toggleAdminMode() {
        try {
          console.log('Toggle admin mode requested');
          // ç®¡ç†ãƒ‘ãƒãƒ«ã¸é·ç§»
          window.location.href = window.location.href.replace('mode=view', 'mode=admin');
        } catch (error) {
          console.error('Admin mode toggle error:', error);
          this.showError('ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡æ›¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }

      /**
       * å›ç­”è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
       */
      showAnswerModal(rowIndex) {
        try {
          // ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©²å½“ã®å›ç­”ã‚’æ¤œç´¢
          const answer = this.state.currentAnswers.find(row => row.rowIndex === rowIndex);
          if (!answer) {
            console.error('Answer not found for rowIndex:', rowIndex);
            return;
          }

          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°
          const modalContent = this.elements.answerModalContainer.querySelector('.glass-panel');
          if (!modalContent) return;

          // ğŸ”’ XSSå®‰å…¨ãªDOMæ§‹ç¯‰ï¼ˆinnerHTMLå®Œå…¨æ’é™¤ï¼‰
          while (modalContent.firstChild) {
            modalContent.removeChild(modalContent.firstChild);
          }

          const containerDiv = document.createElement('div');
          containerDiv.className = 'space-y-4';

          // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†
          const headerDiv = document.createElement('div');
          headerDiv.className = 'flex justify-between items-start';
          
          const titleH3 = document.createElement('h3');
          titleH3.className = 'text-xl font-bold text-cyan-200';
          titleH3.textContent = 'å›ç­”è©³ç´°';
          
          const closeButton = document.createElement('button');
          closeButton.id = 'answerModalCloseBtn';
          closeButton.className = 'text-gray-400 hover:text-white';
          const closeSpan = document.createElement('span');
          closeSpan.className = 'w-6 h-6';
          closeSpan.appendChild(this.createIcon('x', 'w-6 h-6'));
          closeButton.appendChild(closeSpan);
          
          headerDiv.appendChild(titleH3);
          headerDiv.appendChild(closeButton);

          // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†
          const contentDiv = document.createElement('div');
          contentDiv.className = 'space-y-3';

          // å›ç­”ã‚»ã‚¯ã‚·ãƒ§ãƒ³
          const answerDiv = document.createElement('div');
          const answerTitle = document.createElement('h4');
          answerTitle.className = 'text-cyan-400 font-semibold mb-2';
          answerTitle.textContent = 'å›ç­”';
          const answerP = document.createElement('p');
          answerP.className = 'text-gray-200 whitespace-pre-wrap';
          answerP.textContent = answer.opinion || '';
          answerDiv.appendChild(answerTitle);
          answerDiv.appendChild(answerP);
          contentDiv.appendChild(answerDiv);

          // ç†ç”±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ¡ä»¶ä»˜ãï¼‰
          if (answer.reason) {
            const reasonDiv = document.createElement('div');
            const reasonTitle = document.createElement('h4');
            reasonTitle.className = 'text-cyan-400 font-semibold mb-2';
            reasonTitle.textContent = 'ç†ç”±';
            const reasonP = document.createElement('p');
            reasonP.className = 'text-gray-200 whitespace-pre-wrap';
            reasonP.textContent = answer.reason;
            reasonDiv.appendChild(reasonTitle);
            reasonDiv.appendChild(reasonP);
            contentDiv.appendChild(reasonDiv);
          }

          // ã‚¯ãƒ©ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ¡ä»¶ä»˜ãï¼‰
          if (answer.class) {
            const classDiv = document.createElement('div');
            const classTitle = document.createElement('h4');
            classTitle.className = 'text-cyan-400 font-semibold mb-2';
            classTitle.textContent = 'ã‚¯ãƒ©ã‚¹';
            const classP = document.createElement('p');
            classP.className = 'text-gray-200';
            classP.textContent = answer.class;
            classDiv.appendChild(classTitle);
            classDiv.appendChild(classP);
            contentDiv.appendChild(classDiv);
          }

          // åå‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ¡ä»¶ä»˜ãï¼‰
          if (answer.name) {
            const nameDiv = document.createElement('div');
            const nameTitle = document.createElement('h4');
            nameTitle.className = 'text-cyan-400 font-semibold mb-2';
            nameTitle.textContent = 'åå‰';
            const nameP = document.createElement('p');
            nameP.className = 'text-gray-200';
            nameP.textContent = answer.name;
            nameDiv.appendChild(nameTitle);
            nameDiv.appendChild(nameP);
            contentDiv.appendChild(nameDiv);
          }

          containerDiv.appendChild(headerDiv);
          containerDiv.appendChild(contentDiv);
          modalContent.appendChild(containerDiv);

          // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
          this.elements.answerModalContainer.classList.remove('hidden');
          setTimeout(() => {
            this.elements.answerModalContainer.classList.remove('opacity-0');
          }, 10);

          // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
          const closeBtn = modalContent.querySelector('#answerModalCloseBtn');
          if (closeBtn) {
            closeBtn.addEventListener('click', () => this.hideAnswerModal());
          }

        } catch (error) {
          console.error('showAnswerModal error:', error);
        }
      }

      /**
       * ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
       */
      hideAnswerModal() {
        this.elements.answerModalContainer.classList.add('opacity-0');
        setTimeout(() => {
          this.elements.answerModalContainer.classList.add('hidden');
        }, 300);
      }

      /**
       * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
       */
      showError(message) {
        console.warn('Error:', message);
        // ç°¡æ˜“ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆå°†æ¥çš„ã«ã¯ãƒˆãƒ¼ã‚¹ãƒˆã‚„ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å¤‰æ›´å¯èƒ½ï¼‰
        if (window.confirm) {
          setTimeout(() => window.alert(message), 100);
        }
      }

      /**
       * ãƒŸãƒ‹ãƒãƒ«ãƒãƒ¼ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 
       */
      startPolling() {
        if (this.state.pollingInterval) return; // æ—¢ã«é–‹å§‹æ¸ˆã¿
        
        console.log('ğŸ“¡ Starting minimal polling system (3min interval)');
        this.state.pollingInterval = setInterval(() => {
          this.checkForUpdates();
        }, 3 * 60 * 1000); // 3åˆ†é–“éš”
      }

      stopPolling() {
        if (this.state.pollingInterval) {
          console.log('â¹ï¸ Stopping polling system');
          clearInterval(this.state.pollingInterval);
          this.state.pollingInterval = null;
        }
      }

      async checkForUpdates() {
        try {
          console.log('ğŸ” Checking for updates...');
          
          const userId = '<?= typeof userInfo !== "undefined" && userInfo && userInfo.userId ? userInfo.userId : "" ?>';
          if (!userId) return;
          
          const selectedClass = 'ã™ã¹ã¦';
          const sortOrder = this.elements.sortOrder.value;
          const data = await this.runGas('getPublishedSheetData', userId, selectedClass, sortOrder);
          
          // å·®åˆ†ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
          const dataHash = JSON.stringify(data.data || []).length;
          
          if (this.state.lastDataHash && dataHash !== this.state.lastDataHash) {
            console.log('ğŸ“Š New data detected, updating...');
            this.state.currentAnswers = data.data || [];
            this.renderBoard();
            
            // æ–°ç€é€šçŸ¥ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            if (document.title && !document.title.includes('â—')) {
              document.title = 'â— ' + document.title;
            }
          }
          
          this.state.lastDataHash = dataHash;
          
        } catch (error) {
          console.error('Polling error:', error);
        }
      }

      /**
       * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
       */
      escapeHtml(str) {
        if (!str) return '';
        return str.toString()
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      /**
       * GSAPãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
       */
      async waitForGSAP() {
        return new Promise(resolve => {
          if (typeof window.gsap !== 'undefined') {
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (typeof window.gsap !== 'undefined') {
                clearInterval(checkInterval);
                resolve();
              }
            }, 50);
          }
        });
      }

      /**
       * GSAPã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã‚«ãƒ¼ãƒ‰è¡¨ç¤º
       */
      async animateCardEntry(card, delay = 0) {
        if (typeof window.gsap === 'undefined') {
          return; // GSAPãŒç„¡ã„å ´åˆã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡ã—
        }

        return new Promise(resolve => {
          gsap.set(card, { 
            opacity: 0, 
            scale: 0.8, 
            y: 20 
          });

          gsap.to(card, {
            opacity: 1,
            scale: 1,
            y: 0,
            duration: 0.5,
            delay: delay,
            ease: "power2.out",
            onComplete: resolve
          });
        });
      }

      /**
       * ã‚¹ãƒ­ãƒƒãƒˆãƒ«é–¢æ•°
       */
      throttle(func, limit) {
        let inThrottle;
        return (...args) => {
          if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      }
    }
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    try {
      if (window.studyQuestApp && typeof window.studyQuestApp.destroy === 'function') {
        window.studyQuestApp.destroy();
      }
      window.studyQuestApp = new StudyQuestApp();
      
      // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      window.addEventListener('beforeunload', () => {
        if (window.studyQuestApp) {
          window.studyQuestApp.destroy();
        }
      });
      
    } catch (error) {
      console.error('Error creating GenericBoardApp instance:', error);
      
      // ã‚¨ãƒ©ãƒ¼æ™‚ã®ç·Šæ€¥è¡¨ç¤º
      const container = document.getElementById('answers');
      if (container) {
        // ğŸ”’ XSSå®‰å…¨ãªã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆinnerHTMLå®Œå…¨æ’é™¤ï¼‰
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-red-400 p-4';
        errorDiv.textContent = 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
        container.appendChild(errorDiv);
      }
    }
  </script>
</body>
</html>