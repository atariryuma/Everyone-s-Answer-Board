<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>StudyQuest -ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰- - ã¿ã‚“ãªã®ã‹ã„ã¨ã†ãƒœãƒ¼ãƒ‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="referrer" content="no-referrer">
<!-- Content Security Policy for enhanced security -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://fonts.googleapis.com https://script.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https:; img-src 'self' data: https:;">
<!-- Permissions Policy to silence console warnings -->
<meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=(), speaker-selection=()">
<!-- Preload Google Fonts for better performance -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&amp;display=swap" rel="stylesheet">
<!-- Global error handling and TailwindCSS setup -->
<script>
// Global error handling for document.write and other issues
window.addEventListener('error', function(event) {
  if (event.error && event.error.message) {
    if (event.error.message.includes('document.write') ||
        event.error.message.includes('Unexpected token')) {
      console.warn('Document.write or syntax error caught and handled:', event.error.message);
      event.preventDefault();
      return false;
    }
  }
});

// Handle unhandled promise rejections
window.addEventListener('unhandledrejection', function(event) {
  console.warn('Unhandled promise rejection:', event.reason);
  event.preventDefault();
});

// TailwindCSS configuration to suppress production warnings
window.tailwind = {
  config: {
    mode: 'jit',
    corePlugins: { preflight: false }
  }
};
</script>
<script src="https://cdn.tailwindcss.com" defer onerror="console.warn('TailwindCSS failed to load')"></script>
<script>
const DEBUG_MODE = <?= typeof DEBUG_MODE !== 'undefined' ? DEBUG_MODE : false ?>;
function debugLog() {
  if (DEBUG_MODE && console && console.log) {
    try {
      // å¼•æ•°ã‚’å®‰å…¨ã«å‡¦ç†
      const args = Array.from(arguments).map(arg => {
        if (typeof arg === 'object' && arg !== null) {
          return safeDebugStringify(arg);
        }
        return arg;
      });
      console.log.apply(console, args);
    } catch (error) {
      console.warn('debugLog error:', error.message);
    }
  }
}

function safeDebugStringify(obj, maxDepth = 2, currentDepth = 0) {
  if (currentDepth > maxDepth) return '[Max Depth Reached]';
  
  try {
    if (obj === null || obj === undefined) return obj;
    if (typeof obj !== 'object') return obj;
    
    // DOMè¦ç´ ã®å®‰å…¨ãªè¡¨ç¤º
    if (obj instanceof HTMLElement) {
      return `[${obj.tagName}${obj.id ? '#' + obj.id : ''}${obj.className ? '.' + obj.className.split(' ').slice(0, 2).join('.') : ''}]`;
    }
    
    // é…åˆ—ã®å®‰å…¨ãªè¡¨ç¤º
    if (Array.isArray(obj)) {
      if (obj.length > 5) {
        return `[Array(${obj.length}): first 3 items + ${obj.length - 3} more]`;
      }
      return obj.map(item => safeDebugStringify(item, maxDepth, currentDepth + 1));
    }
    
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å®‰å…¨ãªè¡¨ç¤º
    const result = {};
    let count = 0;
    for (const key in obj) {
      if (count >= 8) {
        result['...'] = `[${Object.keys(obj).length - 8} more properties]`;
        break;
      }
      result[key] = safeDebugStringify(obj[key], maxDepth, currentDepth + 1);
      count++;
    }
    return result;
  } catch (error) {
    return '[Stringify Error: ' + error.message + ']';
  }
}

// ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãƒ•ãƒ­ãƒ¼è¡¨ç¤ºæ©Ÿèƒ½
function showSystemFlow() {
  // Development flow display removed for production
}

const __SHOW_COUNTS__ = '<?= typeof showCounts !== "undefined" ? showCounts : false ?>';
const __DISPLAY_MODE__ = '<?= typeof displayMode !== "undefined" ? displayMode : "anonymous" ?>';
const __SHEET_NAME__ = '<?= typeof sheetName !== "undefined" ? sheetName : "" ?>';
const __MAPPING__ = '<?= typeof mapping !== "undefined" ? JSON.stringify(mapping) : "{}" ?>';
const __USER_ID__ = '<?= typeof userId !== "undefined" ? userId : "" ?>';
const __SPREADSHEET_ID__ = '<?= typeof spreadsheetId !== "undefined" ? spreadsheetId : "" ?>';
const __OWNER_NAME__ = '<?= typeof ownerName !== "undefined" ? ownerName : "" ?>';
const __OPINION_HEADER__ = '<?= typeof opinionHeader !== "undefined" ? opinionHeader : "ãŠé¡Œ" ?>';
const __SHOW_ADMIN_FEATURES__ = '<?= typeof showAdminFeatures !== "undefined" ? showAdminFeatures : false ?>';
const __SHOW_HIGHLIGHT_TOGGLE__ = '<?= typeof showHighlightToggle !== "undefined" ? showHighlightToggle : false ?>';
const __SHOW_SCORE_SORT__ = '<?= typeof showScoreSort !== "undefined" ? showScoreSort : false ?>';
const __IS_STUDENT_MODE__ = '<?= typeof isStudentMode !== "undefined" ? isStudentMode : true ?>';
const __IS_ADMIN_USER__ = '<?= typeof isAdminUser !== "undefined" ? isAdminUser : false ?>';
window.showCounts = __SHOW_COUNTS__.startsWith('<') ? false : __SHOW_COUNTS__ === 'true';
window.displayMode = __DISPLAY_MODE__.startsWith('<') ? 'anonymous' : __DISPLAY_MODE__;
// Store server-provided admin capability but always start in view mode
window.hasAdminCapability = __SHOW_ADMIN_FEATURES__.startsWith('<') ? false : __SHOW_ADMIN_FEATURES__ === 'true';
window.showAdminFeatures = false; // Always start in view mode
window.showHighlightToggle = __SHOW_HIGHLIGHT_TOGGLE__.startsWith('<') ? false : __SHOW_HIGHLIGHT_TOGGLE__ === 'true';
window.showScoreSort = __SHOW_SCORE_SORT__.startsWith('<') ? false : __SHOW_SCORE_SORT__ === 'true';
window.isStudentMode = __IS_STUDENT_MODE__.startsWith('<') ? true : __IS_STUDENT_MODE__ === 'true';
window.isAdminUser = __IS_ADMIN_USER__.startsWith('<') ? false : __IS_ADMIN_USER__ === 'true';

// Server configuration processing completed
const SHEET_NAME = __SHEET_NAME__.startsWith('<') ? 'ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒˆ' : __SHEET_NAME__;
const USER_ID = __USER_ID__.startsWith('<') ? '' : __USER_ID__;
const OWNER_NAME = __OWNER_NAME__.startsWith('<') ? '' : __OWNER_NAME__;
let MAPPING;
try {
  if (typeof __MAPPING__ === 'string' && !__MAPPING__.startsWith('<')) {
    MAPPING = JSON.parse(__MAPPING__);
  } else {
    MAPPING = {};
  }
} catch (e) {
  console.warn('Failed to parse MAPPING:', e);
  MAPPING = {};
}
</script>
<?!= include('SharedUtilities'); ?>
<style>
:root {
  --color-primary: #8be9fd;
  --color-background: #1a1b26;
  --color-surface: rgba(26, 27, 38, 0.95);
  --color-text: #c0caf5;
  --color-border: rgba(255, 255, 255, 0.1);
  --color-accent: #facc15;
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.15);
  --color-success: #10b981;
  --color-error: #ef4444;
  --color-warning: #f59e0b;
  /* Performance variables */
  --transition-duration: 0.2s;
  --transition-easing: ease-out;
  --animation-duration: 0.3s;
  --backdrop-blur: 12px;
}
body {
  color: var(--color-text);
  background-color: var(--color-background);
  margin: 0;
  overflow-x: hidden;
}
.glass-panel { 
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  backdrop-filter: blur(var(--backdrop-blur));
  -webkit-backdrop-filter: blur(var(--backdrop-blur));
  transition: border-color var(--transition-duration) var(--transition-easing);
}
.glass-panel:hover {
  border-color: rgba(255, 255, 255, 0.2);
}
.game-font {
  font-family: 'Press Start 2P', cursive;
}
.game-btn {
  transition: transform var(--transition-duration) var(--transition-easing),
              box-shadow var(--transition-duration) var(--transition-easing),
              border-bottom-width var(--transition-duration) var(--transition-easing);
  border-radius: 0.75rem;
  border-bottom-width: 4px;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
  position: relative;
  overflow: hidden;
}
.game-btn:not(:disabled):hover { 
  transform: translate3d(0, -2px, 0); 
  box-shadow: 0 8px 16px rgba(0,0,0,0.3);
}
.game-btn:active:not(:disabled) { 
  transform: translate3d(0, 2px, 0); 
  border-bottom-width: 2px; 
}
.game-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none !important;
}
#classFilter, #sortOrder { 
  background-color: #6272a4; 
  border: 1px solid var(--color-border); 
  color: var(--color-text); 
  border-radius: 0.75rem; 
  padding: 0.5rem 0.75rem; 
  transition: border-color var(--transition-duration) var(--transition-easing),
              box-shadow var(--transition-duration) var(--transition-easing);
}
#classFilter:focus, #sortOrder:focus {
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(139, 233, 253, 0.1);
}
:focus-visible { 
  outline: 3px solid var(--color-primary); 
  outline-offset: 2px; 
  border-radius: 0.75rem; 
}
header { 
  position: sticky; 
  top: 0; 
  z-index: 50; 
  contain: layout;
  backdrop-filter: blur(var(--backdrop-blur));
  -webkit-backdrop-filter: blur(var(--backdrop-blur));
}
.answer-card { 
  transition: transform var(--animation-duration) var(--transition-easing),
              box-shadow var(--animation-duration) var(--transition-easing);
  border-radius: 1rem;
  contain: layout style;
  position: relative;
  overflow: hidden;
}
.answer-card.highlighted {
  border-image: linear-gradient(45deg, #9333ea, #c084fc, #9333ea) 1 !important;
  border-width: 4px !important;
  box-shadow: 
    0 0 25px rgba(147, 51, 234, 0.6),
    inset 0 0 20px rgba(192, 132, 252, 0.1),
    0 8px 32px rgba(147, 51, 234, 0.2);
  transform: scale(1.02);
  position: relative;
}
.answer-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0,0,0,0.2);
}
.answer-card.loading {
  opacity: 0.7;
}

.answer-card.loading .reaction-btn,
.answer-card.loading .highlight-btn {
  opacity: 0.5;
}
.reaction-btn {
  transition: transform var(--transition-duration) var(--transition-easing),
              background-color var(--transition-duration) var(--transition-easing),
              box-shadow var(--transition-duration) var(--transition-easing);
  position: relative;
  overflow: hidden;
}
.reaction-btn:hover {
  transform: scale(1.1);
}
.reaction-btn:active {
  transform: scale(0.95);
}
.reaction-btn.reacted {
  background-color: var(--color-primary) !important;
  color: #000 !important;
  box-shadow: 0 0 10px rgba(139, 233, 253, 0.5);
}
.reaction-btn.loading {
  opacity: 0.6;
}
.fade-in {
  animation: fadeIn 0.5s ease-out;
}
.slide-in {
  animation: slideIn 0.3s ease-out;
}
.pulse {
  animation: pulse 0.6s ease-out;
}
.shake {
  animation: shake 0.5s ease-out;
}
.admin-toggle {
  transition: background-color var(--animation-duration) var(--transition-easing);
  -webkit-backdrop-filter: blur(8px);
  backdrop-filter: blur(8px);
}
.admin-toggle:hover {
  background-color: rgba(139, 233, 253, 0.1);
}
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(26, 27, 38, 0.8);
  -webkit-backdrop-filter: blur(4px);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(139, 233, 253, 0.3);
  border-top: 4px solid var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); will-change: opacity, transform; }
  to { opacity: 1; transform: translateY(0); will-change: auto; }
}
@keyframes pulse {
  0% { transform: scale3d(1, 1, 1); will-change: transform; }
  50% { transform: scale3d(1.05, 1.05, 1); }
  100% { transform: scale3d(1, 1, 1); will-change: auto; }
}
@keyframes shake {
  0%, 100% { transform: translate3d(0, 0, 0); will-change: transform; }
  25% { transform: translate3d(-5px, 0, 0); }
  75% { transform: translate3d(5px, 0, 0); }
}
@keyframes spin {
  100% { transform: rotate(360deg); will-change: transform; }
}
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translate(-50%, 0); will-change: auto; }
  40% { transform: translate(-50%, -10px); will-change: transform; }
  60% { transform: translate(-50%, -5px); }
}


/* Performance optimizations */
@media (max-width: 768px) and (max-resolution: 150dpi) {
  :root {
    --backdrop-blur: 0px;
    --transition-duration: 0.1s;
    --animation-duration: 0.15s;
  }
  
  .glass-panel {
    -webkit-backdrop-filter: none;
    backdrop-filter: none;
    background: var(--color-surface);
  }
  
  .answer-card:hover {
    transform: none;
  }
  
  .reaction-btn:hover {
    transform: scale(1.05);
  }
}

/* Low-end device optimizations */
@media (max-width: 768px), (max-resolution: 120dpi) {
  :root {
    --backdrop-blur: 0px;
    --transition-duration: 0.1s;
    --animation-duration: 0.1s;
  }
}

/* High refresh rate display optimizations */
@media (min-resolution: 120dpi) and (min-width: 1200px) {
  :root {
    --transition-duration: 0.15s;
    --animation-duration: 0.2s;
  }
}

/* Responsive improvements */
@media (max-width: 768px) {
  .answer-card {
    margin-bottom: 1rem;
  }
  .game-btn {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
  }
  header {
    padding: 1rem;
  }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  :root {
    --color-border: rgba(255, 255, 255, 0.3);
    --color-surface: rgba(26, 27, 38, 0.98);
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  :root {
    --transition-duration: 0.01ms;
    --animation-duration: 0.01ms;
    --backdrop-blur: 0px;
  }
  
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    transform: none !important;
  }
  
  .answer-card:hover,
  .reaction-btn:hover,
  .game-btn:hover {
    transform: none !important;
  }
}

/* Low performance mode styles */
.low-performance .answer-card {
  contain: layout style paint;
}

.low-performance .answer-card:hover {
  transform: none;
  box-shadow: var(--shadow-sm);
}

.low-performance .glass-panel {
  -webkit-backdrop-filter: none;
  backdrop-filter: none;
}

/* Hidden card styles for virtual scrolling */
.hidden-card {
  visibility: hidden;
  position: absolute;
  left: -9999px;
}

.visible {
  visibility: visible;
  pointer-events: auto;
}

/* Optimize grid layout for performance */
@supports (container-type: inline-size) {
  #answers {
    container-type: inline-size;
  }
}

/* Optimize for high DPI displays */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .answer-card {
    backface-visibility: hidden;
    perspective: 1000px;
  }
}
.answer-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}
.answer-card.new-card {
  animation: fadeIn 0.3s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.highlight-badge {
  position: absolute;
  top: 0.25rem;
  right: 0.25rem;
  width: 1.5rem;
  height: 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #facc15;
}
.answer-card.reaction-bg-like { border-color:#ef4444 !important; }
.answer-card.reaction-bg-understand { border-color:#fbbf24 !important; }
.answer-card.reaction-bg-curious { border-color:#10b981 !important; }
.answer-card.reaction-bg-like-understand { border-image: linear-gradient(45deg, #ef4444, #fbbf24) 1 !important; }
.answer-card.reaction-bg-like-curious { border-image: linear-gradient(45deg, #ef4444, #10b981) 1 !important; }
.answer-card.reaction-bg-understand-curious { border-image: linear-gradient(45deg, #fbbf24, #10b981) 1 !important; }
.answer-card.reaction-bg-like-understand-curious { border-image: linear-gradient(45deg, #ef4444, #fbbf24, #10b981) 1 !important; }
.reaction-border-1 { border-width: 2px; }
.reaction-border-2 { border-width: 4px; }
.reaction-border-3 { border-width: 6px; }
.answer-preview { 
  display: -webkit-box; 
  -webkit-line-clamp: 5; 
  line-clamp: 5; 
  -webkit-box-orient: vertical; 
  overflow: hidden; 
  text-overflow: ellipsis; 
  min-height: 120px; 
}
.like-btn svg { 
  transition: fill var(--transition-duration) var(--transition-easing),
              transform var(--transition-duration) var(--transition-easing);
  fill: none;
}
.like-btn.liked svg { stroke: transparent; fill: currentColor; transform: scale(1.1); }
.like-btn.loading {   opacity: 0.7; position: relative; }
.like-btn.loading::after { 
  content: ""; 
  position: absolute; 
  inset: 0; 
  border: 2px solid transparent; 
  border-top: 2px solid currentColor; 
  border-radius: 50%; 
  animation: spin 0.8s linear infinite; 
  width: 16px; 
  height: 16px; 
  margin: auto; 
}
.highlight-btn { 
  transition: background var(--transition-duration) var(--transition-easing),
              transform var(--transition-duration) var(--transition-easing);
  border-radius: 4px;
  padding: 2px;
}
.highlight-btn:hover { 
  background: rgba(147, 51, 234, 0.15);
  transform: scale(1.1);
}
.highlight-btn.liked { 
  color: #9333ea; 
  text-shadow: 0 0 8px rgba(147, 51, 234, 0.6);
}
#controlsFooter { pointer-events: none; }
#controlsFooter > .glass-panel { pointer-events: auto; }
.skeleton { position: relative; overflow: hidden; background-color: rgba(255,255,255,0.05); }
.skeleton::after { content: ""; position: absolute; inset: 0; background-image: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.2), rgba(255,255,255,0)); animation: skeleton-loading 1.5s infinite; }
@keyframes skeleton-loading { 0% { transform: translate3d(-100%, 0, 0); will-change: transform; } 100% { transform: translate3d(100%, 0, 0); } }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

/* Fallback styles when TailwindCSS fails to load */
.tailwind-fallback .bg-gradient-to-br { background: linear-gradient(135deg, var(--color-background), #2a2b3c); }
.tailwind-fallback .text-white { color: white; }
.tailwind-fallback .text-center { text-align: center; }
.tailwind-fallback .p-4 { padding: 1rem; }
.tailwind-fallback .p-6 { padding: 1.5rem; }
.tailwind-fallback .m-4 { margin: 1rem; }
.tailwind-fallback .mb-4 { margin-bottom: 1rem; }
.tailwind-fallback .mt-4 { margin-top: 1rem; }
.tailwind-fallback .flex { display: flex; }
.tailwind-fallback .flex-col { flex-direction: column; }
.tailwind-fallback .flex-wrap { flex-wrap: wrap; }
.tailwind-fallback .items-center { align-items: center; }
.tailwind-fallback .justify-center { justify-content: center; }
.tailwind-fallback .justify-between { justify-content: space-between; }
.tailwind-fallback .gap-4 { gap: 1rem; }
.tailwind-fallback .grid { display: grid; }
.tailwind-fallback .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
.tailwind-fallback .rounded-lg { border-radius: 0.5rem; }
.tailwind-fallback .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
.tailwind-fallback .w-full { width: 100%; }
.tailwind-fallback .h-full { height: 100%; }
.tailwind-fallback .min-h-screen { min-height: 100vh; }
.tailwind-fallback .relative { position: relative; }
.tailwind-fallback .absolute { position: absolute; }
.tailwind-fallback .fixed { position: fixed; }
.tailwind-fallback .top-0 { top: 0; }
.tailwind-fallback .bottom-0 { bottom: 0; }
.tailwind-fallback .left-0 { left: 0; }
.tailwind-fallback .right-0 { right: 0; }
.tailwind-fallback .z-10 { z-index: 10; }
.tailwind-fallback .z-50 { z-index: 50; }
.tailwind-fallback .hidden { display: none; }
.tailwind-fallback .block { display: block; }
.tailwind-fallback .inline { display: inline; }
.tailwind-fallback .inline-block { display: inline-block; }
.modal-close-btn { 
  position: absolute;
  top: -12px;
  right: -12px;
  transform: none;
  border: 2px solid #fff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}
/* ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è£…é£¾ */
#answerModalCard.reaction-border-1 { border-width: 3px !important; }
#answerModalCard.reaction-border-2 { border-width: 4px !important; }
#answerModalCard.reaction-border-3 { border-width: 5px !important; }
/* ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³èƒŒæ™¯è‰² */
#answerModalCard.reaction-bg-like { 
  border-color: #ef4444 !important; 
  border-image: none !important;
}
#answerModalCard.reaction-bg-understand { 
  border-color: #fbbf24 !important; 
  border-image: none !important;
}
#answerModalCard.reaction-bg-curious { 
  border-color: #10b981 !important; 
  border-image: none !important;
}
#answerModalCard.reaction-bg-like-understand { 
  border-image: linear-gradient(45deg, #ef4444, #fbbf24) 1 !important; 
  border-color: transparent !important;
}
#answerModalCard.reaction-bg-like-curious { 
  border-image: linear-gradient(45deg, #ef4444, #10b981) 1 !important; 
  border-color: transparent !important;
}
#answerModalCard.reaction-bg-understand-curious { 
  border-image: linear-gradient(45deg, #fbbf24, #10b981) 1 !important; 
  border-color: transparent !important;
}
#answerModalCard.reaction-bg-like-understand-curious { 
  border-image: linear-gradient(45deg, #ef4444, #fbbf24, #10b981) 1 !important; 
  border-color: transparent !important;
}
/* ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè£…é£¾ï¼ˆãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è£…é£¾ã‚ˆã‚Šå¾Œã«é…ç½®ã§å„ªå…ˆï¼‰ */
#answerModalCard.highlighted {
  border-image: linear-gradient(45deg, #9333ea, #c084fc, #9333ea) 1 !important;
  border-width: 4px !important;
  box-shadow: 
    0 0 25px rgba(147, 51, 234, 0.6),
    inset 0 0 20px rgba(192, 132, 252, 0.1) !important;
  position: relative;
}
.render-optimized { transform: translateZ(0); }
.modal-fade { animation: modalFade 0.2s ease-out; }
@keyframes modalFade { from { opacity: 0; will-change: opacity; } to { opacity: 1; } }
.modal-scale { animation: modalScale 0.2s ease-out; }
@keyframes modalScale { from { transform: scale3d(0.8, 0.8, 1); will-change: transform; } to { transform: scale3d(1, 1, 1); } }
</style>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans">
<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay hidden">
  <div class="text-center">
    <div class="spinner"></div>
    <p class="mt-4 text-gray-300">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>

<div id="main-container" class="w-full mx-auto px-4 pt-4 pb-4 md:px-6 md:pt-6 md:pb-6">
<!-- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header id="main-header" class="glass-panel rounded-xl p-3 mb-4 shadow-lg fade-in">
  <!-- ä¸Šéƒ¨: ãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯ + ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ï¼ˆæ¨ªä¸¦ã³ï¼‰ -->
  <div class="flex items-center justify-between mb-3 text-xs">
    <!-- ãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯ï¼ˆå·¦å´ï¼‰ -->
    <a id="form-link-btn" href="#" target="_blank" class="bg-cyan-500/10 border border-cyan-400/30 rounded px-3 py-1 flex items-center gap-2 hover:bg-cyan-500/20 transition-all text-cyan-400 hover:text-cyan-300 hidden">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
      </svg>
      <span class="font-medium">ğŸ“ å›ç­”ãƒ•ã‚©ãƒ¼ãƒ </span>
    </a>
    
    <!-- ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ï¼ˆå³å´ï¼‰ -->
    <div class="flex-shrink-0 flex items-center gap-2">
      <!-- ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
      <button type="button" id="adminToggleBtn" class="admin-toggle text-xs text-gray-500 hover:text-cyan-400 transition-all opacity-60 hover:opacity-100 hidden whitespace-nowrap flex items-center gap-1 px-2 py-1 rounded" hidden aria-label="ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
      </button>
      
      <div>
        <!-- ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è‡´è¡¨ç¤º -->
        <div id="header-domain-match" class="bg-green-500/10 border border-green-400/30 rounded px-2 py-1 hidden">
          <div class="flex items-center gap-1">
            <svg class="w-3 h-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-green-400 font-medium" id="header-domain-match-text">å­¦æ ¡ãƒ‰ãƒ¡ã‚¤ãƒ³</span>
          </div>
        </div>
        
        <!-- ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸ä¸€è‡´è¡¨ç¤º -->
        <div id="header-domain-mismatch" class="bg-yellow-500/10 border border-yellow-400/30 rounded px-2 py-1 hidden">
          <div class="flex items-center gap-1">
            <svg class="w-3 h-3 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <span class="text-yellow-400 font-medium" id="header-domain-mismatch-text">å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹</span>
          </div>
        </div>
        
        <!-- åˆæœŸçŠ¶æ…‹è¡¨ç¤º -->
        <div id="header-domain-initial" class="bg-blue-500/10 border border-blue-400/30 rounded px-2 py-1">
          <div class="flex items-center gap-1">
            <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
            <span class="text-blue-400 font-medium">ç¢ºèªä¸­</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ãƒ¡ã‚¤ãƒ³éƒ¨åˆ†: å•é¡Œã‚¿ã‚¤ãƒˆãƒ« + ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="flex flex-col lg:flex-row items-center gap-3">
    <!-- å·¦: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="flex items-center gap-3 text-xs">
      <div id="answerCount" class="text-gray-400 flex items-center gap-1">
        <svg class="w-3 h-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        <span id="answerCountText">0ä»¶</span>
      </div>
      
      <select id="classFilter" class="hidden text-xs bg-gray-700 border border-gray-600 rounded px-2 py-1" title="ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼" aria-label="ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"></select>
      
      <div class="relative">
        <select id="sortOrder" class="text-xs bg-gray-700 border border-gray-600 rounded px-2 py-1 pr-6 appearance-none" title="ä¸¦ã³é †" aria-label="ä¸¦ã³é †">
          <option value="newest" selected>æ–°ç€é †</option>
          <option value="random">ãƒ©ãƒ³ãƒ€ãƒ é †</option>
          <option value="score" id="scoreOption" class="hidden">ã‚¹ã‚³ã‚¢é †</option>
        </select>
        <svg class="absolute right-1 top-1/2 transform -translate-y-1/2 w-2 h-2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </div>

    <!-- ä¸­å¤®: å•é¡Œã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæœ€å¤§ï¼‰ -->
    <div class="flex-grow text-center min-w-0">
      <div id="headingLabel" class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-bold text-pink-400 leading-tight">
        <svg class="w-5 h-5 md:w-6 md:h-6 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
        </svg>
      </div>
    </div>

  <!-- Right Section: Info & Admin Controls -->
  <div class="w-full lg:w-auto lg:min-w-[150px] text-right space-y-1 px-2">
    <p id="sheetNameText" class="text-xs text-gray-400 h-4 truncate flex items-center justify-end gap-1">
    </p>
    <div class="flex justify-end gap-1 flex-wrap">
      <button type="button" id="endPublicationBtn" class="admin-toggle text-xs bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded hidden whitespace-nowrap transition-all flex items-center gap-1" hidden aria-label="å…¬é–‹çµ‚äº†">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636"></path>
        </svg>
        å…¬é–‹çµ‚äº†
      </button>
    </div>
  </div>
</header>
<!-- æ–°ç€é€šçŸ¥ãƒãƒŠãƒ¼ -->
<div id="newContentBanner" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-full shadow-lg hidden transition-all duration-300" role="alert" aria-live="polite">
  <div class="flex items-center gap-3">
    <span id="newContentIcon" class="w-5 h-5 animate-pulse" aria-hidden="true">ğŸ“‹</span>
    <span id="newContentText">æ–°ã—ã„æ„è¦‹ãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ</span>
    <button type="button" id="refreshContentBtn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full text-sm font-medium transition-colors" aria-label="æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°ã—ã¦è¡¨ç¤º">
      æ›´æ–°ã—ã¦è¡¨ç¤º
    </button>
    <button type="button" id="dismissBannerBtn" class="text-white/70 hover:text-white w-5 h-5 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors" aria-label="é€šçŸ¥ã‚’é–‰ã˜ã‚‹">
      Ã—
    </button>
  </div>
</div>

<main id="answers" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" role="main" aria-live="polite" aria-label="å›ç­”ä¸€è¦§"></main>
</div>
<div id="answerModalContainer" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true">
<div id="answerModalCard" class="glass-panel rounded-xl p-6 flex flex-col shadow-2xl border-2 border-cyan-400/80 w-full max-w-5xl h-auto max-h-[85vh] relative" role="document" aria-labelledby="modalAnswer">
<button type="button" id="answerModalCloseBtn" class="modal-close-btn bg-red-600 rounded-full p-2 text-white hover:scale-110 transition-transform z-10" aria-label="é–‰ã˜ã‚‹">
  <span id="iconClose" class="w-6 h-6"></span>
</button>
<div id="modalAnswer" class="flex-grow min-h-[200px] mb-4 overflow-y-auto pr-4"></div>
<div id="modalFooter" class="text-xs text-gray-400 pt-4 border-t-2 border-dashed border-cyan-400/80 flex justify-between items-center">
<div><span id="modalStudentName" class="font-bold text-2xl text-gray-200"></span></div>
<div id="modalReactions" class="flex items-center gap-2"></div>
</div>
</div>
</div>
<div id="infoModalContainer" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true">
<div id="infoModalCard" class="glass-panel rounded-xl p-8 shadow-2xl border-2 border-cyan-400/80 w-full max-w-2xl relative" role="document">
<div class="space-y-5 text-gray-200 text-lg leading-relaxed">
<!-- Digital Citizenship Education Section -->
<div class="bg-gradient-to-r from-green-800/40 to-emerald-800/40 border border-green-400/50 rounded-lg p-4 mb-4">
<div class="flex items-start gap-3">
<div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
<span class="text-lg">ğŸ“š</span>
</div>
<div>
<p class="text-base font-bold text-green-200 mb-3">ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚·ãƒ†ã‚£ã‚ºãƒ³ã‚·ãƒƒãƒ—ã£ã¦ä½•ã ã‚ã†ï¼Ÿ</p>
<p class="text-sm text-green-100 leading-relaxed mb-2">
<span class="text-green-200 font-semibold">ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚·ãƒ†ã‚£ã‚ºãƒ³ã‚·ãƒƒãƒ—</span>ã¨ã¯ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã‚’ä½¿ã†ã¨ãã«ã€<span class="text-green-200 font-semibold">ã‚„ã•ã—ã„å¿ƒã§ç›¸æ‰‹ã®ã“ã¨ã‚’è€ƒãˆã‚‹</span>ã“ã¨ã§ã™ã€‚
</p>
<p class="text-sm text-green-200 leading-relaxed mb-2">
ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰ã§ã‚‚ã€<span class="text-green-200 font-semibold">æ€ã„ã‚„ã‚Šã®ã‚ã‚‹è¨€è‘‰</span>ã‚’é¸ã‚“ã§ã€ã¿ã‚“ãªãŒæ°—æŒã¡ã‚ˆãå‚åŠ ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚
</p>
<p class="text-sm text-green-200 leading-relaxed">
å‹ã ã¡ã®æ„è¦‹ã‚’èã„ã¦ã€Œãã†ã„ã†è€ƒãˆã‚‚ã‚ã‚‹ã‚“ã ã­ã€ã¨<span class="text-green-200 font-semibold">å¤šæ§˜æ€§ã‚’å¤§åˆ‡ã«ã™ã‚‹å¿ƒ</span>ã‚’è‚²ã¦ã¾ã—ã‚‡ã†ã€‚
</p>
</div>
</div>
</div>

<p>ã¿ã‚“ãªã®æ„è¦‹ã‚’æ°—æŒã¡ã‚ˆãå…±æœ‰ã™ã‚‹ãŸã‚ã«ã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã—ã‹ãŸã‚’ãŠã¼ãˆã‚ˆã†ï¼</p>
<ul class="space-y-2">
<li class="flex items-center gap-2"><span id="infoIconLike" class="w-5 h-5 text-red-400"></span>ã„ã„ã­ï¼ï¼šã™ã¦ãã ã¨æ€ã£ãŸã¨ãã«æŠ¼ãã†</li>
<li class="flex items-center gap-2"><span id="infoIconUnderstand" class="w-5 h-5 text-yellow-400"></span>ãªã‚‹ã»ã©ï¼ï¼šå‚è€ƒã«ãªã£ãŸã¨ãã«æŠ¼ãã†</li>
<li class="flex items-center gap-2"><span id="infoIconCurious" class="w-5 h-5 text-green-400"></span>ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ï¼ï¼šã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ã¨ãã«æŠ¼ãã†</li>
</ul>
<p class="flex items-center gap-2"><span id="infoIconHighlight" class="w-5 h-5 text-purple-400"></span>å…ˆç”ŸãŒæ³¨ç›®ã—ã¦ã»ã—ã„æ„è¦‹ã«ã¤ã‘ã¦ã„ã¾ã™</p>
<p>è²¬ä»»ã‚ã‚‹ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã€ã¿ã‚“ãªã§å­¦ã³ã‚’æ·±ã‚ã‚ˆã†ï¼</p>


<div class="text-center mt-6">
<button type="button" id="infoModalConfirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ã‚ã‹ã£ãŸ</button>
</div>
</div>
</div>
</div>
<footer id="controlsFooter" class="fixed bottom-0 left-0 right-0 z-40 p-4">
<div class="glass-panel max-w-md mx-auto rounded-xl p-3 flex items-center justify-center gap-3">
<input type="range" id="sizeSlider" min="2" max="6" value="4" class="w-1/2" aria-label="è¡¨ç¤ºåˆ—æ•°ã®å¤‰æ›´">
<div class="flex items-center gap-1">
<span id="sliderValue" class="font-bold text-lg">4</span>
<span id="iconGrid" class="w-4 h-4"></span>
</div>
</div>
</footer>
<script>
// Optimize initial render
const RENDER_BATCH_SIZE = 10;
const VIEWPORT_BUFFER = 200; // Viewport buffer for virtual scrolling
const PERFORMANCE_BUDGET = 16; // Maximum ms per frame
const CHUNK_SIZE = 5; // DOM operations per chunk
const IDLE_TIMEOUT = 5000; // Idle timeout for cleanup
const ICONS = {
  'lightbulb-outline': '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6zM9 16.5h6v4H9v-4zm0 1h6zm0 1h6zM10.5 11l.5 2h2l.5-2m-3 1h3"/></svg>',
  'lightbulb-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6z M10.5 11.25 L11 13 L13 13 L13.5 11.25 H 10.5 Z"/><path d="M9 16.5h6v1H9z M9 18h6v1H9z M9 19.5h6v1H9z"/></svg>',
  'hand-thumb-up-outline': '<svg fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.338 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>',
  'hand-thumb-up-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z M6.5 10v12h1V10h-1z"/></svg>',
  'magnifying-glass-plus-outline': '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6"/></svg>',
  'magnifying-glass-plus-solid': '<svg viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z M9.75 7.5v2.25H7.5v1.5h2.25V13.5h1.5v-2.25H13.5v-1.5h-2.25V7.5h-1.5z" fill="currentColor"/><path d="M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15zM16.5 16.5l4.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
  'x': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
  'star-outline': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 8.5 22 9.3 17 14 18.2 21 12 17.8 5.8 21 7 14 2 9.3 9 8.5 12 2"/></svg>',
  'star-solid': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 8.5 22 9.3 17 14 18.2 21 12 17.8 5.8 21 7 14 2 9.3 9 8.5 12 2"/></svg>',
  'star': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 8.5 22 9.3 17 14 18.2 21 12 17.8 5.8 21 7 14 2 9.3 9 8.5 12 2"/></svg>',
  'grid-2x2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 12h18"/><path d="M12 3v18"/></svg>',
  'users': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>'
};

class UnifiedCache {
  constructor() {
    this.data = new Map();
    this.timestamps = new Map();
  }
  
  set(key, value, ttl = 300000) { // 5åˆ†ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆTTL
    this.data.set(key, value);
    this.timestamps.set(key, Date.now() + ttl);
  }
  
  get(key) {
    if (!this.data.has(key)) return undefined;
    
    const expiry = this.timestamps.get(key);
    if (expiry && Date.now() > expiry) {
      this.delete(key);
      return undefined;
    }
    
    return this.data.get(key);
  }
  
  has(key) {
    return this.get(key) !== undefined;
  }
  
  delete(key) {
    this.data.delete(key);
    this.timestamps.delete(key);
  }
  
  clear() {
    this.data.clear();
    this.timestamps.clear();
  }
  
  cleanup() {
    const now = Date.now();
    for (const [key, expiry] of this.timestamps.entries()) {
      if (now > expiry) {
        this.delete(key);
      }
    }
  }
  
  get size() {
    return this.data.size;
  }
}

class StudyQuestApp {
  constructor() {
    this.cache = new UnifiedCache();
    this.weakCache = new WeakMap(); // For DOM element caching
    this.performanceMetrics = { frameTime: 0, domOperations: 0 };
    this.visibilityObserver = null;
    this.resizeObserver = null;
    this.deferredUpdates = new Set();
    this.animationFrameId = null;
    this.idleCallbackId = null;
    this.domFragmentPool = [];
    this.isLowPerformanceMode = true;
    this.elements = {
      body: document.body,
      mainContainer: document.getElementById('main-container'),
      answersContainer: document.getElementById('answers'),
      sizeSlider: document.getElementById('sizeSlider'),
      sliderValue: document.getElementById('sliderValue'),
      headingLabel: document.getElementById('headingLabel'),
      sheetNameText: document.getElementById('sheetNameText'),
      endPublicationBtn: document.getElementById('endPublicationBtn'),
      adminToggleBtn: document.getElementById('adminToggleBtn'),
      answerCount: document.getElementById('answerCount'),
      answerModalContainer: document.getElementById('answerModalContainer'),
      answerModalCloseBtn: document.getElementById('answerModalCloseBtn'),
      answerModalCard: document.getElementById('answerModalCard'),
      modalAnswer: document.getElementById('modalAnswer'),
      modalStudentName: document.getElementById('modalStudentName'),
      modalReactionContainer: document.getElementById('modalReactions'),
      modalFooter: document.getElementById('modalFooter'),
      infoModalContainer: document.getElementById('infoModalContainer'),
      infoModalCard: document.getElementById('infoModalCard'),
      infoModalConfirmBtn: document.getElementById('infoModalConfirmBtn'),
      infoIconLike: document.getElementById('infoIconLike'),
      infoIconUnderstand: document.getElementById('infoIconUnderstand'),
      infoIconCurious: document.getElementById('infoIconCurious'),
      infoIconHighlight: document.getElementById('infoIconHighlight'),
      newContentBanner: document.getElementById('newContentBanner'),
      newContentText: document.getElementById('newContentText'),
      refreshContentBtn: document.getElementById('refreshContentBtn'),
      dismissBannerBtn: document.getElementById('dismissBannerBtn'),
      iconClose: document.getElementById('iconClose'),
      iconGrid: document.getElementById('iconGrid'),
      classFilter: document.getElementById('classFilter'),
      sortOrder: document.getElementById('sortOrder'),
      scoreOption: document.getElementById('scoreOption'),
      footer: document.getElementById('controlsFooter'),
      loadingOverlay: document.getElementById('loading-overlay')
    };
    this.state = {
      currentAnswers: [],
      isLoading: false,
      lastFocusedElement: null,
      isStudentMode: window.isStudentMode,
      isAdminUser: window.isAdminUser,
      showCounts: window.showCounts,
      showAdminFeatures: false, // åˆæœŸçŠ¶æ…‹ã¯å¸¸ã«é–²è¦§ãƒ¢ãƒ¼ãƒ‰
      showHighlightToggle: window.isAdminUser, // ç®¡ç†è€…ãªã‚‰å¸¸ã«è¡¨ç¤º
      showScoreSort: window.showScoreSort,
      displayMode: window.displayMode,
      sheetName: SHEET_NAME,
      userId: USER_ID, // Add userId to state
      hasNewContent: false,
      newContentCount: 0,
      lastSeenCount: 0,
      pollingFailureCount: 0
    };
    
    // æ–°ç€ãƒã‚§ãƒƒã‚¯ç”¨ã®åˆæœŸåŒ–
    this.lastViewKey = null;
    this.initialDataLoaded = false;
    
    // Initial state setup complete
    this.serverShowCounts = window.showCounts;
    this.serverDisplayMode = window.displayMode;
    this.pollingInterval = null;
    this.handlers = {};
    this.adminModeVerified = false; // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã®æ¨©é™ç¢ºèªãƒ•ãƒ©ã‚°
    this.reactionDebounce = new Map(); // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ç”¨
    this.highlightDebounce = new Map(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ç”¨
    this.pendingReactions = new Set(); // å‡¦ç†ä¸­ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼é‡è¤‡ç™»éŒ²é˜²æ­¢ãƒ•ãƒ©ã‚°
    this.eventDelegationSetup = false;
    this.nonCriticalListenersSetup = false;
    this.modalOperationPending = false;
    this.reactionTypes = [
      { key: 'LIKE', icon: 'hand-thumb-up' },
      { key: 'UNDERSTAND', icon: 'lightbulb' },
      { key: 'CURIOUS', icon: 'magnifying-glass-plus' }
    ];
    
    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ä¿å­˜ç”¨ã®ã‚­ãƒ¼
    this.reactionStorageKey = `reactions_${USER_ID}_${SHEET_NAME}`;
    this.gas = {
      getPublishedSheetData: (sheetName, classFilter, sort, adminMode, bypassCache) => this.runGas('getPublishedSheetData', this.state.userId, sheetName, classFilter, sort, adminMode, bypassCache),
      getIncrementalSheetData: (classFilter, sort, adminMode, sinceRowCount) => this.runGas('getIncrementalSheetData', this.state.userId, classFilter, sort, adminMode, sinceRowCount),
      getAvailableSheets: () => this.runGas('getAvailableSheets', this.state.userId),
      addReaction: (rowIndex, reaction, sheetName) => this.runGas('addReaction', this.state.userId, rowIndex, reaction, sheetName),
      toggleHighlight: (rowIndex, sheetName) => this.runGas('toggleHighlight', this.state.userId, rowIndex, sheetName),
      checkAdmin: () => this.runGas('checkAdmin', this.state.userId),
      clearCache: () => this.runGas('refreshBoardData', this.state.userId),
      getDataCount: (classFilter, sortOrder, adminMode) => this.runGas('getDataCount', this.state.userId, classFilter, sortOrder, adminMode)
    };
    const savedCols = localStorage.getItem('boardColumns');
    if (savedCols && this.elements.sizeSlider && this.elements.sliderValue) {
      this.elements.sizeSlider.value = savedCols;
      this.elements.sliderValue.textContent = savedCols;
    }
    this.init();
  }
  init() {
      // åˆæœŸãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹ã‚’è¡¨ç¤º
      this.showLoadingOverlay();
      
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ15ç§’ï¼‰
      this.initTimeoutId = setTimeout(() => {
        this.hideLoadingOverlay();
        console.warn('ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }, 15000);
      
      // Critical path only - non-blocking
      this.setupCriticalElements();
      this.showMinimalSkeleton();
      
      // Apply default low performance tweaks
      this.optimizeForLowPerformance();
      
      // Immediate async loading for data
      this.loadDataImmediate();
      
      // Defer all non-critical operations
      requestIdleCallback(() => {
        this.setupNonCriticalEventListeners();
        this.renderIcons();
        this.adjustLayout();
        this.updateSortOptions();
        this.setupObservers();
        // Initial admin state setup - ç®¡ç†è€…æ¨©é™ãŒã‚ã£ã¦ã‚‚æœ€åˆã¯é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
        if (window.hasAdminCapability && window.isAdminUser) {
          this.state.isAdminUser = true;
          this.state.showAdminFeatures = false; // åˆæœŸã¯é–²è¦§ãƒ¢ãƒ¼ãƒ‰
          if (this.elements.adminToggleBtn) {
            this.elements.adminToggleBtn.classList.remove('hidden');
            this.elements.adminToggleBtn.removeAttribute('hidden');
            this.elements.adminToggleBtn.style.display = ''; // è¡¨ç¤ºã‚’ç¢ºå®Ÿã«
            this.elements.adminToggleBtn.textContent = 'ç®¡ç†ãƒ¢ãƒ¼ãƒ‰';
          }
        } else {
          // éç®¡ç†è€…ã®å ´åˆã¯ç®¡ç†æ©Ÿèƒ½ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ–
          this.state.isAdminUser = false;
          this.state.showAdminFeatures = false;
          if (this.elements.adminToggleBtn) {
            this.elements.adminToggleBtn.classList.add('hidden');
            this.elements.adminToggleBtn.setAttribute('hidden', '');
            this.elements.adminToggleBtn.style.display = 'none'; // ç¢ºå®Ÿã«éè¡¨ç¤º
          }
        }
        // Check if modal should be shown
        const introSeen = localStorage.getItem('introSeen');
        
        // Show modal if never seen before
        if (!introSeen) {
          setTimeout(() => this.showInfoModal(), 500);
        }
      }, { timeout: 50 });

      // AdminPanelã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªãƒƒã‚¹ãƒ³
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'REFRESH_BOARD_DATA') {
          // Refresh board data message received
          this.loadSheetData(true);
        }
      });
    }
  setupCriticalElements() {
    if (this.elements.headingLabel) {
      // å•é¡Œæ–‡ã‚’å¸¸ã«è¡¨ç¤ºï¼ˆèª­ã¿è¾¼ã¿ä¸­ã¯è¡¨ç¤ºã—ãªã„ï¼‰
      const opinionHeader = __OPINION_HEADER__.startsWith('<') || __OPINION_HEADER__.includes('èª­ã¿è¾¼ã¿')
        ? 'ãŠé¡Œ'  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ã‚­ã‚¹ãƒˆ
        : this.escapeHtml(__OPINION_HEADER__);
      this.elements.headingLabel.textContent = opinionHeader;
    }

    // Only setup absolutely critical event listeners
    this.setupEventDelegation();
    this.handlers.onAnswerModalCloseClick = () => this.hideAnswerModal();
    if (this.elements.answerModalCloseBtn) {
      this.elements.answerModalCloseBtn.addEventListener('click', this.handlers.onAnswerModalCloseClick);
    }
    // Size slider for immediate response with throttling
    const debouncedRender = this.debounce(() => this.renderBoard(true), 200);
    this.handlers.onSizeSliderInput = this.throttle((e) => {
      localStorage.setItem('boardColumns', e.target.value);
      debouncedRender();
    }, 100); // Throttle to 100ms
    
    if (this.elements.sizeSlider) {
      this.elements.sizeSlider.addEventListener('input', this.handlers.onSizeSliderInput, { passive: true });
    }
  }
  
  setupNonCriticalEventListeners() {
    // é‡è¤‡ç™»éŒ²é˜²æ­¢
    if (this.nonCriticalListenersSetup) {
      // Non-critical event listeners already set up
      return;
    }
    
    // Optimized: Event delegation for answer cards container
    this.handlers.onAnswersContainerClick = (e) => {
      const card = e.target.closest('.answer-card');
      const reactionBtn = e.target.closest('.reaction-btn');
      const highlightBtn = e.target.closest('.highlight-btn');
      
      if (reactionBtn && card) {
        const rowIndex = card.dataset.rowIndex;
        const reaction = reactionBtn.dataset.reaction;
        if (rowIndex && reaction) {
          this.handleReaction(rowIndex, reaction);
        }
      } else if (highlightBtn && card) {
        const rowIndex = card.dataset.rowIndex;
        if (rowIndex) {
          this.handleHighlight(rowIndex);
        }
      } else if (card) {
        // Card click to show modal
        const rowIndex = card.dataset.rowIndex;
        if (rowIndex) {
          this.showAnswerModal(parseInt(rowIndex));
        }
      }
    };
    
    if (this.elements.answersContainer) {
      this.elements.answersContainer.addEventListener('click', this.handlers.onAnswersContainerClick);
    }
    
    // Modal handlers
    this.handlers.onAnswerModalContainerClick = (e) => {
      if (e.target === e.currentTarget) {
        this.hideAnswerModal();
      }
    };
    if (this.elements.answerModalContainer) {
      this.elements.answerModalContainer.addEventListener('click', this.handlers.onAnswerModalContainerClick);
    }
    if (this.elements.infoModalConfirmBtn) {
      this.handlers.onInfoModalConfirmClick = () => this.hideInfoModal();
      this.elements.infoModalConfirmBtn.addEventListener('click', this.handlers.onInfoModalConfirmClick);
    }
    this.handlers.onModalReactionClick = (e) => {
      const btn = e.target.closest('.reaction-btn');
      const highlightBtn = e.target.closest('.highlight-btn');
      
      if (highlightBtn) {
        const id = highlightBtn.dataset.rowIndex;
        if (id) {
          this.handleHighlight(id);
        }
      } else if (btn) {
        const id = btn.dataset.rowIndex;
        const reaction = btn.dataset.reaction;
        if (id && reaction) {
          this.handleReaction(id, reaction);
        }
      }
    };
    if (this.elements.modalReactionContainer) {
      this.elements.modalReactionContainer.addEventListener('click', this.handlers.onModalReactionClick);
    }
    this.handlers.onClassFilterChange = () => {
      this.dismissNewContentBanner(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´æ™‚ã¯æ—¢å­˜ã®é€šçŸ¥ã‚’æ¶ˆå»
      this.loadSheetData(true).then(() => {
        this.state.lastSeenCount = this.state.currentAnswers.length; // æ–°ã—ã„ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’è¨­å®š
      });
    };
    this.handlers.onSortOrderChange = () => {
      this.dismissNewContentBanner(); // ã‚½ãƒ¼ãƒˆå¤‰æ›´æ™‚ã¯æ—¢å­˜ã®é€šçŸ¥ã‚’æ¶ˆå»
      this.loadSheetData(true).then(() => {
        this.state.lastSeenCount = this.state.currentAnswers.length; // æ–°ã—ã„ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’è¨­å®š
      });
    };
    if (this.elements.classFilter) {
      this.elements.classFilter.addEventListener('change', this.handlers.onClassFilterChange);
    }
    if (this.elements.sortOrder) {
      this.elements.sortOrder.addEventListener('change', this.handlers.onSortOrderChange);
    }
    if (this.elements.endPublicationBtn) {
      this.handlers.onEndPublicationClick = () => this.endPublication();
      this.elements.endPublicationBtn.addEventListener('click', this.handlers.onEndPublicationClick);
    }
    if (this.elements.adminToggleBtn) {
      this.handlers.onAdminToggleClick = () => this.toggleAdminMode();
      this.elements.adminToggleBtn.addEventListener('click', this.handlers.onAdminToggleClick);
    }
    
    // æ–°ç€é€šçŸ¥ãƒãƒŠãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    if (this.elements.refreshContentBtn) {
      this.handlers.onRefreshContentClick = () => this.refreshContent();
      this.elements.refreshContentBtn.addEventListener('click', this.handlers.onRefreshContentClick);
    }
    if (this.elements.dismissBannerBtn) {
      this.handlers.onDismissBannerClick = () => this.dismissNewContentBanner();
      this.elements.dismissBannerBtn.addEventListener('click', this.handlers.onDismissBannerClick);
    }
    this.handlers.onDocumentKeydown = (e) => {
      if (e.key === 'Escape') {
        this.hideAnswerModal();
      }
    };
    document.addEventListener('keydown', this.handlers.onDocumentKeydown);
    this.handlers.onWindowResize = this.debounce(() => this.adjustLayout(), 100);
    window.addEventListener('resize', this.handlers.onWindowResize, { passive: true });
    this.handlers.onVisibilityChange = () => {
      if (document.hidden) {
        this.stopPolling();
        // Cleanup when page is hidden
        this.throttledUpdate('hidden-cleanup', () => this.cleanup(), 1000);
      } else {
        this.startPolling();
      }
    };
    document.addEventListener('visibilitychange', this.handlers.onVisibilityChange, { passive: true });
    
    this.nonCriticalListenersSetup = true;
    // Non-critical event listener setup complete
  }
  /**
 * ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã®è¨­å®šï¼ˆå®‰å®šç‰ˆã®å …ç‰¢ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’æ¡ç”¨ï¼‰
 * ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨ç«¶åˆã—ãªããªã‚Šã¾ã™ã€‚
 */
setupEventDelegation() {
    // é‡è¤‡ç™»éŒ²é˜²æ­¢
    if (this.eventDelegationSetup) {
        // Event delegation already set up
        return;
    }
    
    this.handlers.onAnswersContainerClick = (e) => {
        const answerCard = e.target.closest('.answer-card');

        if (!answerCard || answerCard.classList.contains('hidden-card')) {
            return;
        }

        const rowIndex = answerCard.dataset.rowIndex;
        if (!rowIndex) {
            return;
        }

        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚’å‡¦ç†
        const reactionBtn = e.target.closest('.reaction-btn');
        if (reactionBtn) {
            e.stopPropagation(); // â˜…é‡è¦: ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’æ­¢ã‚ã€ã‚«ãƒ¼ãƒ‰æœ¬ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã¨åˆ†é›¢
            if (!reactionBtn.disabled) {
                this.handleReaction(rowIndex, reactionBtn.dataset.reaction);
            }
            return;
        }

        // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚’å‡¦ç†
        const highlightBtn = e.target.closest('.highlight-btn');
        if (highlightBtn) {
            e.stopPropagation(); // â˜…é‡è¦: åŒæ§˜ã«ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
            if (!highlightBtn.disabled) {
                this.handleHighlight(rowIndex);
            }
            return;
        }

        // ä¸Šè¨˜ä»¥å¤–ã®å ´åˆã¯ã€ã‚«ãƒ¼ãƒ‰æœ¬ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã¨ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        this.showAnswerModal(rowIndex);
    };

    if (this.elements.answersContainer) {
        // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰è¿½åŠ 
        this.elements.answersContainer.removeEventListener('click', this.handlers.onAnswersContainerClick);
        this.elements.answersContainer.addEventListener('click', this.handlers.onAnswersContainerClick);
        this.eventDelegationSetup = true;
    } else {
        console.error('No answers container found for event delegation');
    }
}
  
  // Debug helper functions removed for production
  adjustLayout() {
    if (this.baseBodyPadding === undefined) {
      this.baseBodyPadding = parseFloat(getComputedStyle(this.elements.body).paddingBottom) || 0;
    }
    const footerHeight = this.elements.footer.offsetHeight;
    this.elements.body.style.paddingBottom = footerHeight + this.baseBodyPadding + 'px';
  }
  runGas(funcName, ...args) {
    // Simple request deduplication for identical calls (except for state-changing operations)
    const cacheKey = funcName + JSON.stringify(args);
    const isStateChanging = ['toggleHighlight', 'addReaction', 'endPublication'].includes(funcName);
    
    if (!isStateChanging) {
      const cached = this.cache.get(cacheKey);
      if (cached) {
        return Promise.resolve(cached);
      }
    }
    
    // GAS API call processing
    
    return new Promise((resolve, reject) => {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        const userId = USER_ID || '';
        google.script.run
          .withSuccessHandler((result) => {
            if (!isStateChanging) {
              this.cache.set(cacheKey, result, 1000); // 1ç§’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            }
            resolve(result);
          })
          .withFailureHandler((error) => {
            console.error('GAS APIã‚¨ãƒ©ãƒ¼å—ä¿¡:', { funcName, args, error, success: false });
            reject(error);
          })
          .withUserObject({ userId: userId })
          [funcName](...args);
      } else {
        console.warn('Google Apps Script environment not detected.');
        this.getMockData(funcName, ...args).then((result) => {
          if (!isStateChanging) {
            this.cache.set(cacheKey, result, 1000); // 1ç§’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
          }
          resolve(result);
        }).catch(reject);
      }
    });
  }
  async verifyAdminAsync() {
    // Use server-provided flag first (fast)
    if (window.isAdminUser) {
      this.state.isAdminUser = true;
      this.state.showHighlightToggle = true; // ç®¡ç†è€…ãªã‚‰å¸¸ã«è¡¨ç¤º
      // Admin permissions verified
      this.updateAdminButtonUI();
      this.updateEndPublicationButtonUI();
      return;
    }
    
    // Fallback API call (slower)
    try {
      const isAdmin = await this.gas.checkAdmin();
      if (isAdmin) {
        window.isAdminUser = true;
        this.state.isAdminUser = true;
        this.state.showHighlightToggle = true; // ç®¡ç†è€…ãªã‚‰å¸¸ã«è¡¨ç¤º
        // API admin permissions verified
        this.updateAdminButtonUI();
        this.updateEndPublicationButtonUI();
      }
    } catch (e) {
      console.error('Admin check failed', e);
    }
  }
  
  // ç®¡ç†è€…UIæ›´æ–°ã®å…±é€šãƒ¡ã‚½ãƒƒãƒ‰
  updateAdminButtonUI() {
    // Only show admin toggle button for administrators, never for viewers
    if (this.elements.adminToggleBtn && this.state.isAdminUser) {
      // Show button for admin users only
      this.elements.adminToggleBtn.classList.remove('hidden');
      this.elements.adminToggleBtn.removeAttribute('hidden');
      
      // Always show "ç®¡ç†ãƒ¢ãƒ¼ãƒ‰" text, never show "é–²è¦§ãƒ¢ãƒ¼ãƒ‰" to avoid confusion
      this.elements.adminToggleBtn.textContent = 'ç®¡ç†ãƒ¢ãƒ¼ãƒ‰';
      
      // Apply styling based on current admin mode state
      if (this.state.showAdminFeatures) {
        // Active admin mode: highlighted styling
        this.elements.adminToggleBtn.classList.remove('text-gray-500', 'opacity-60');
        this.elements.adminToggleBtn.classList.add('bg-cyan-600', 'hover:bg-cyan-700', 'text-white', 'shadow-lg', 'ring-2', 'ring-cyan-400/50');
      } else {
        // Inactive admin mode: subtle gray styling
        this.elements.adminToggleBtn.classList.remove('bg-cyan-600', 'hover:bg-cyan-700', 'text-white', 'shadow-lg', 'ring-2', 'ring-cyan-400/50');
        this.elements.adminToggleBtn.classList.add('text-gray-500', 'opacity-60');
      }
    } else {
      // Hide button for non-admin users
      if (this.elements.adminToggleBtn) {
        this.elements.adminToggleBtn.classList.add('hidden');
        this.elements.adminToggleBtn.setAttribute('hidden', '');
      }
    }
  }
  
  updateEndPublicationButtonUI() {
    if (this.elements.endPublicationBtn) {
      if (this.state.showAdminFeatures) {
        this.elements.endPublicationBtn.classList.remove('hidden');
        this.elements.endPublicationBtn.removeAttribute('hidden');
      } else {
        this.elements.endPublicationBtn.classList.add('hidden');
        this.elements.endPublicationBtn.setAttribute('hidden', '');
      }
    }
  }
  
  // ã‚µãƒ¼ãƒãƒ¼ç®¡ç†è€…æ¨©é™ç¢ºèªã®å…±é€šãƒ¡ã‚½ãƒƒãƒ‰
  async checkServerAdminPermission() {
    try {
      const isAdmin = await this.gas.checkAdmin();
      if (!isAdmin) {
        throw new Error('ã‚µãƒ¼ãƒãƒ¼å´ã§ç®¡ç†è€…æ¨©é™ãŒç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }
      return true;
    } catch (error) {
      console.error('ç®¡ç†è€…æ¨©é™ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }
  }
  
  // è»½é‡ãªæ–°ç€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒã‚§ãƒƒã‚¯
  async checkForNewContentLight() {
    try {
      const selectedClass = this.elements.classFilter ? this.elements.classFilter.value : 'ã™ã¹ã¦';
      const sortOrder = this.elements.sortOrder.value;
      
      // è»½é‡ãªä»¶æ•°ãƒã‚§ãƒƒã‚¯ã®ã¿å®Ÿè¡Œï¼ˆãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—ãªã—ï¼‰
      const countData = await this.gas.getDataCount(selectedClass, sortOrder, this.state.showAdminFeatures);
      
      console.log('ğŸ“Š è»½é‡æ–°ç€ãƒã‚§ãƒƒã‚¯:', {
        countResponse: countData,
        newCount: countData.count || 0,
        currentCount: this.state.currentAnswers ? this.state.currentAnswers.length : 0,
        lastSeenCount: this.state.lastSeenCount,
        selectedClass,
        sortOrder,
        status: countData.status,
        error: countData.message
      });
      
      const newCount = countData.count || 0;
      
      // æˆåŠŸã—ãŸå ´åˆã¯å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
      this.state.pollingFailureCount = 0;
      
      // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼/ã‚½ãƒ¼ãƒˆè¨­å®šã‚’ã‚­ãƒ¼ã¨ã—ã¦ä¿å­˜
      const currentViewKey = `${selectedClass}-${sortOrder}`;
      
      // åˆå›ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å®Œäº†ã®ç¢ºèª
      if (!this.initialDataLoaded) {
        // Initial data load completed
        this.lastViewKey = currentViewKey;
        this.state.lastSeenCount = newCount;
        this.initialDataLoaded = true;
        return;
      }
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼/ã‚½ãƒ¼ãƒˆè¨­å®šãŒå¤‰ã‚ã£ãŸå ´åˆã¯æ¯”è¼ƒã‚’ãƒªã‚»ãƒƒãƒˆ
      if (this.lastViewKey !== null && this.lastViewKey !== currentViewKey) {
        console.log('ğŸ”„ è¡¨ç¤ºè¨­å®šå¤‰æ›´æ¤œå‡ºã€æ–°ç€ãƒã‚§ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ:', {
          oldKey: this.lastViewKey,
          newKey: currentViewKey,
          newCount,
          settingLastSeenToNewCount: true
        });
        this.lastViewKey = currentViewKey;
        this.state.lastSeenCount = newCount;
        return;
      }
      
      // åŒã˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼/ã‚½ãƒ¼ãƒˆè¨­å®šã§ã®æ–°ç€ãƒã‚§ãƒƒã‚¯
      const hasNewItems = newCount > this.state.lastSeenCount && this.state.lastSeenCount > 0;
      console.log('ğŸ“Š æ–°ç€åˆ¤å®š:', {
        newCount,
        lastSeenCount: this.state.lastSeenCount,
        hasNewItems,
        difference: newCount - this.state.lastSeenCount,
        currentViewKey
      });
      
      if (hasNewItems) {
        const newItems = newCount - this.state.lastSeenCount;
        
        // ç•°å¸¸ã«å¤§ããªå·®ã¯èª¤æ¤œçŸ¥ã®å¯èƒ½æ€§ãŒé«˜ã„
        if (newItems <= 10 && newItems > 0) { // å¦¥å½“ãªç¯„å›²ã®æ–°ç€ã®ã¿é€šçŸ¥
          this.showNewContentBanner(newItems);
          console.log('ğŸ‰ è»½é‡æ–°ç€æ¤œå‡ºãƒ»é€šçŸ¥è¡¨ç¤º:', { 
            newItems, 
            newCount, 
            lastSeenCount: this.state.lastSeenCount,
            viewKey: currentViewKey,
            lightweightCheck: true
          });
        } else {
          console.log('âš ï¸ ç•°å¸¸ãªæ–°ç€æ•°æ¤œå‡ºã€èª¤æ¤œçŸ¥ã¨ã—ã¦ç„¡è¦–:', {
            newItems,
            newCount,
            lastSeenCount: this.state.lastSeenCount
          });
        }
      }
      
      // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã‚­ãƒ¼ã‚’ç¢ºå®Ÿã«è¨­å®š
      this.lastViewKey = currentViewKey;
    } catch (error) {
      this.state.pollingFailureCount++;
      console.warn('è»½é‡æ–°ç€ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—:', error, 'failureCount:', this.state.pollingFailureCount);
      
      // é€£ç¶šã§å¤±æ•—ãŒç¶šãå ´åˆã¯ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’å»¶ã°ã™
      if (this.state.pollingFailureCount >= 3) {
        // Polling interval extended due to consecutive failures
        this.stopPolling();
        setTimeout(() => {
          this.startPolling();
        }, 5000); // 5ç§’å¾Œã«å†é–‹
        this.state.pollingFailureCount = 0;
      }
    }
  }
  
  // æ–°ç€é€šçŸ¥ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
  showNewContentBanner(newItems) {
    if (!this.elements.newContentBanner) return;
    
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼šçŸ­æ™‚é–“å†…ã®é€£ç¶šé€šçŸ¥ã‚’é˜²ã
    const now = Date.now();
    if (this.lastNotificationTime && (now - this.lastNotificationTime) < 2000) {
      console.log('ğŸš« é€šçŸ¥ãƒ‡ãƒã‚¦ãƒ³ã‚¹: çŸ­æ™‚é–“å†…ã®é€£ç¶šé€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—');
      return;
    }
    this.lastNotificationTime = now;
    
    // æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€æ–°ã—ã„æ•°ã§ä¸Šæ›¸ãï¼ˆç´¯ç©ã—ãªã„ï¼‰
    if (!this.elements.newContentBanner.classList.contains('hidden')) {
      console.log('ğŸ“± é€šçŸ¥æ›´æ–°: æ—¢å­˜ãƒãƒŠãƒ¼ã‚’æ–°ã—ã„æ•°ã§æ›´æ–°', {
        oldCount: this.state.newContentCount,
        newCount: newItems
      });
      this.state.newContentCount = newItems; // ç´¯ç©ã›ãšä¸Šæ›¸ã
    } else {
      this.state.newContentCount = newItems;
    }
    
    this.state.hasNewContent = true;
    
    const message = this.state.newContentCount === 1 ? 
      'æ–°ã—ã„æ„è¦‹ãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ' : 
      `${this.state.newContentCount}ä»¶ã®æ–°ã—ã„æ„è¦‹ãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ`;
    this.elements.newContentText.textContent = message;
    
    this.elements.newContentBanner.classList.remove('hidden');
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰é©ç”¨
    this.elements.newContentBanner.style.animation = '';
    
    // 3ç§’å¾Œã«ãƒã‚¦ãƒ³ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    setTimeout(() => {
      if (!this.elements.newContentBanner.classList.contains('hidden')) {
        this.elements.newContentBanner.style.animation = 'bounce 1s ease-in-out';
      }
    }, 3000);
    
    console.log('ğŸ“¢ æ–°ç€é€šçŸ¥è¡¨ç¤º:', {
      count: this.state.newContentCount,
      message: message
    });
  }
  
  // æ–°ç€ãƒãƒŠãƒ¼ã‚’é–‰ã˜ã‚‹
  dismissNewContentBanner() {
    if (!this.elements.newContentBanner) return;
    
    this.elements.newContentBanner.classList.add('hidden');
    this.elements.newContentBanner.style.animation = '';
    this.state.hasNewContent = false;
    this.state.newContentCount = 0;
  }
  
  // å¢—åˆ†ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°ï¼ˆæ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã®ã¿å–å¾—ãƒ»è¿½åŠ ï¼‰
  async refreshContentIncremental() {
    this.dismissNewContentBanner();
    
    try {
      const originalText = this.elements.refreshContentBtn ? this.elements.refreshContentBtn.textContent : '';
      if (this.elements.refreshContentBtn) {
        this.elements.refreshContentBtn.textContent = 'æ›´æ–°ä¸­...';
        this.elements.refreshContentBtn.disabled = true;
      }
      
      console.log('ğŸ”„ å¢—åˆ†ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–‹å§‹ - åŸºæº–è¡Œæ•°:', this.state.lastSeenCount || 0);
      
      // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã‚’å–å¾—
      const classFilter = this.elements.classFilter ? this.elements.classFilter.value : 'ã™ã¹ã¦';
      const sortOrder = this.elements.sortOrder ? this.elements.sortOrder.value : 'newest';
      const adminMode = this.state.showAdminFeatures;
      
      // å¢—åˆ†ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const incrementalData = await this.gas.getIncrementalSheetData(
        classFilter, 
        sortOrder, 
        adminMode, 
        this.state.lastSeenCount || 0
      );
      
      if (incrementalData.status === 'error') {
        throw new Error(incrementalData.message);
      }
      
      console.log('ğŸ“¥ å¢—åˆ†ãƒ‡ãƒ¼ã‚¿å–å¾—çµæœ:', {
        newCount: incrementalData.newCount,
        totalCount: incrementalData.totalCount,
        hasNewData: incrementalData.newCount > 0
      });
      
      // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
      if (incrementalData.newCount === 0) {
        this.provideFeedback('æœ€æ–°ã®çŠ¶æ…‹ã§ã™', 'info');
        this.state.lastSeenCount = incrementalData.totalCount;
        return;
      }
      
      // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰ã«è¿½åŠ 
      await this.appendNewCards(incrementalData.data, sortOrder);

      // çŠ¶æ…‹ã‚’æ›´æ–°
      if (sortOrder === 'newest') {
        this.state.currentAnswers = incrementalData.data.concat(this.state.currentAnswers);
      } else {
        this.state.currentAnswers = this.state.currentAnswers.concat(incrementalData.data);
      }

      // ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ä»–ã®ã‚½ãƒ¼ãƒˆé †ã§ã‚‚æ–°ç€ãŒåæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
      this.gas.clearCache().catch(err => console.warn('Cache clear failed', err));
      this.state.lastSeenCount = incrementalData.totalCount;
      
      console.log('âœ… å¢—åˆ†ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Œäº†:', {
        addedCards: incrementalData.newCount,
        totalCards: this.state.currentAnswers.length,
        newBaseline: this.state.lastSeenCount
      });
      
      this.provideFeedback(`${incrementalData.newCount}ä»¶ã®æ–°ã—ã„æŠ•ç¨¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
      
    } catch (error) {
      console.error('å¢—åˆ†ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°ã«å¤±æ•—:', error);
      
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å¾“æ¥ã®å…¨ä½“æ›´æ–°ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      console.log('ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å…¨ä½“æ›´æ–°ã‚’å®Ÿè¡Œ');
      await this.refreshContentFull();
      
    } finally {
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      if (this.elements.refreshContentBtn) {
        this.elements.refreshContentBtn.textContent = this.elements.refreshContentBtn.textContent.includes('æ›´æ–°ä¸­') ? 
          (originalText || 'æ›´æ–°ã—ã¦è¡¨ç¤º') : this.elements.refreshContentBtn.textContent;
        this.elements.refreshContentBtn.disabled = false;
      }
    }
  }
  
  // å…¨ä½“ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°ï¼ˆå¾“æ¥ã®æ–¹æ³•ï¼‰
  async refreshContentFull() {
    try {
      // å¾“æ¥ã®æ‰‹å‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      this.cache.clear();
      console.log('ğŸ”„ å…¨ä½“ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–‹å§‹ - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†');
      
      await this.loadSheetData(true, false);
      
      // æ‰‹å‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œã¯æ–°ç€ãƒã‚§ãƒƒã‚¯åŸºæº–ã‚’æ›´æ–°ï¼ˆåˆæœŸåŒ–ãƒ•ãƒ©ã‚°ã¯ç¶­æŒï¼‰
      this.state.lastSeenCount = this.state.currentAnswers.length;
      console.log('ğŸ”„ å…¨ä½“ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Œäº†ã€æ–°ç€åŸºæº–æ›´æ–°:', {
        newLastSeenCount: this.state.lastSeenCount,
        maintainInitialFlag: this.initialDataLoaded,
        currentAnswersLength: this.state.currentAnswers.length,
        visibleCards: document.querySelectorAll('.answer-card').length
      });
      
      this.provideFeedback('æ›´æ–°å®Œäº†ï¼', 'success');
      
    } catch (error) {
      console.error('å…¨ä½“ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°ã«å¤±æ•—:', error);
      this.provideFeedback('æ›´æ–°å¤±æ•—', 'error');
      throw error;
    }
  }
  
  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°ï¼ˆæ‰‹å‹•ï¼‰ - å¢—åˆ†æ›´æ–°ã‚’å„ªå…ˆ
  async refreshContent() {
    // å¢—åˆ†æ›´æ–°ã‚’è©¦è¡Œã€å¤±æ•—æ™‚ã¯å…¨ä½“æ›´æ–°ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    await this.refreshContentIncremental();
  }
  
  // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
  async appendNewCards(newData, sortOrder = 'newest') {
    if (!newData || newData.length === 0) return;
    
    console.log('ğŸ“Œ æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ :', newData.length + 'ä»¶');
    
    const container = this.elements.answersContainer;
    if (!container) return;
    
    // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
    const fragment = document.createDocumentFragment();
    
    for (const data of newData) {
      const cardElement = this.createAnswerCard(data);
      if (cardElement) {
        // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        cardElement.style.opacity = '0';
        cardElement.style.transform = 'translateY(20px)';
        fragment.appendChild(cardElement);
      }
    }
    
    if (sortOrder === 'newest') {
      container.prepend(fragment);
    } else {
      container.appendChild(fragment);
    }
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
    await new Promise(resolve => {
      requestAnimationFrame(() => {
        const newCards = container.querySelectorAll('.answer-card[style*="opacity: 0"]');
        newCards.forEach((card, index) => {
          setTimeout(() => {
            card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          }, index * 100); // 100msãšã¤é…å»¶ã—ã¦é †æ¬¡è¡¨ç¤º
        });
        
        // å…¨ã¦ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ
        setTimeout(resolve, newCards.length * 100 + 300);
      });
    });
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
  provideFeedback(message, type = 'info') {
    if (!this.elements.refreshContentBtn) return;
    
    const originalText = this.elements.refreshContentBtn.textContent;
    const originalBackground = this.elements.refreshContentBtn.style.background;
    
    this.elements.refreshContentBtn.textContent = message;
    
    switch (type) {
      case 'success':
        this.elements.refreshContentBtn.style.background = 'rgba(16, 185, 129, 0.3)';
        break;
      case 'error':
        this.elements.refreshContentBtn.style.background = 'rgba(239, 68, 68, 0.3)';
        break;
      case 'info':
        this.elements.refreshContentBtn.style.background = 'rgba(59, 130, 246, 0.3)';
        break;
    }
    
    setTimeout(() => {
      this.elements.refreshContentBtn.textContent = originalText;
      this.elements.refreshContentBtn.style.background = originalBackground;
    }, 2000);
  }
  
  getMockData(funcName, ...args) {
    return new Promise((resolve) => {
      setTimeout(() => {
        if (funcName === 'getPublishedSheetData') {
          const currentDisplayMode = window.displayMode || this.state.displayMode;
          const studentName1 = currentDisplayMode === 'named' ? 'ç”°ä¸­å¤ªéƒ' : '';
          const studentName2 = currentDisplayMode === 'named' ? 'ä½è—¤èŠ±å­' : '';
          resolve({
            header: 'ãƒ†ã‚¹ãƒˆå•é¡Œ',
            sheetName: 'ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒˆ',
            data: [
              {
                rowIndex: 1,
                name: studentName1,
                class: '3å¹´Açµ„',
                opinion: 'ã“ã‚Œã¯ç´ æ™´ã‚‰ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã ã¨æ€ã„ã¾ã™ã€‚',
                reason: 'ç†ç”±ã¯ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ãã€å®Ÿç¾å¯èƒ½æ€§ãŒé«˜ã„ã‹ã‚‰ã§ã™ã€‚',
                reactions: {
                  UNDERSTAND: { count: 5, reacted: false },
                  LIKE: { count: 2, reacted: false },
                  CURIOUS: { count: 1, reacted: false }
                },
                highlight: false
              },
              {
                rowIndex: 2,
                name: studentName2,
                class: '3å¹´Bçµ„',
                opinion: 'å°‘ã—æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚‹ã¨è€ƒãˆã¾ã™ã€‚',
                reason: 'ã‚ˆã‚Šå¤šãã®äººã®æ„è¦‹ã‚’èãå¿…è¦ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚',
                reactions: {
                  UNDERSTAND: { count: 3, reacted: true },
                  LIKE: { count: 0, reacted: false },
                  CURIOUS: { count: 0, reacted: false }
                },
                highlight: true
              }
            ]
          });
        } else if (funcName === 'addReaction') {
          resolve({
            status: 'ok',
            reactions: {
              UNDERSTAND: { count: Math.floor(Math.random() * 5), reacted: Math.random() < 0.5 },
              LIKE: { count: Math.floor(Math.random() * 5), reacted: Math.random() < 0.5 },
              CURIOUS: { count: Math.floor(Math.random() * 5), reacted: Math.random() < 0.5 }
            }
          });
        } else if (funcName === 'toggleHighlight') {
          const currentHighlight = args[2] === undefined ? false : !args[2];
          resolve({
            status: 'ok',
            highlight: currentHighlight
          });
        } else if (funcName === 'checkAdmin') {
          resolve(true);
        }
      }, 300);
    });
  }
  startPolling() {
    if (this.pollingInterval) {
      clearInterval(this.pollingInterval);
    }
    
    // Adaptive polling: start with normal interval, adjust based on success/failure
    this.pollSuccessCount = 0;
    this.pollFailureCount = 0;
    this.currentPollInterval = this.isLowPerformanceMode ? 30000 : 15000;
    
    const adaptivePoll = async () => {
      console.log('â° ãƒãƒ¼ãƒªãƒ³ã‚°å®Ÿè¡Œ:', {
        currentInterval: this.currentPollInterval,
        successCount: this.pollSuccessCount,
        failureCount: this.pollFailureCount,
        timestamp: new Date().toLocaleTimeString()
      });
      
      try {
        await this.checkForNewContentLight();
        this.pollSuccessCount++;
        this.pollFailureCount = 0;
        
        // Reduce interval on consistent success (but not below minimum)
        if (this.pollSuccessCount > 3 && this.currentPollInterval > 10000) {
          this.currentPollInterval = Math.max(10000, this.currentPollInterval * 0.9);
        }
        
        console.log('âœ… ãƒãƒ¼ãƒªãƒ³ã‚°æˆåŠŸ:', {
          successCount: this.pollSuccessCount,
          nextInterval: this.currentPollInterval
        });
      } catch (error) {
        this.pollFailureCount++;
        this.pollSuccessCount = 0;
        
        // Increase interval on failures (exponential backoff)
        if (this.pollFailureCount > 2) {
          this.currentPollInterval = Math.min(60000, this.currentPollInterval * 1.5);
        }
        console.warn('âŒ ãƒãƒ¼ãƒªãƒ³ã‚°å¤±æ•—:', error, {
          failureCount: this.pollFailureCount,
          newInterval: this.currentPollInterval
        });
      }
      
      // Schedule next poll with current interval
      this.pollingTimeout = setTimeout(adaptivePoll, this.currentPollInterval);
    };
    
    // Start first poll
    this.pollingTimeout = setTimeout(adaptivePoll, this.currentPollInterval);
    
    // Start automatic cleanup for memory management
    this.cleanupInterval = setInterval(() => {
      this.cache.cleanup();
    }, 5 * 60 * 1000); // Cleanup every 5 minutes
  }
  stopPolling() {
    if (this.pollingInterval) {
      clearInterval(this.pollingInterval);
      this.pollingInterval = null;
    }
    
    if (this.pollingTimeout) {
      clearTimeout(this.pollingTimeout);
      this.pollingTimeout = null;
    }
    
    if (this.cleanupInterval) {
      clearInterval(this.cleanupInterval);
      this.cleanupInterval = null;
    }
  }
  destroy() {
    this.stopPolling();
    this.cleanup();
    if (this.elements.sizeSlider && this.handlers.onSizeSliderInput) {
      this.elements.sizeSlider.removeEventListener('input', this.handlers.onSizeSliderInput);
    }
    if (this.elements.answerModalCloseBtn && this.handlers.onAnswerModalCloseClick) {
      this.elements.answerModalCloseBtn.removeEventListener('click', this.handlers.onAnswerModalCloseClick);
    }
    if (this.elements.answerModalContainer && this.handlers.onAnswerModalContainerClick) {
      this.elements.answerModalContainer.removeEventListener('click', this.handlers.onAnswerModalContainerClick);
    }
    if (this.elements.infoModalConfirmBtn && this.handlers.onInfoModalConfirmClick) {
      this.elements.infoModalConfirmBtn.removeEventListener('click', this.handlers.onInfoModalConfirmClick);
    }
    if (this.elements.modalReactionContainer && this.handlers.onModalReactionClick) {
      this.elements.modalReactionContainer.removeEventListener('click', this.handlers.onModalReactionClick);
    }
    if (this.elements.classFilter && this.handlers.onClassFilterChange) {
      this.elements.classFilter.removeEventListener('change', this.handlers.onClassFilterChange);
    }
    if (this.elements.sortOrder && this.handlers.onSortOrderChange) {
      this.elements.sortOrder.removeEventListener('change', this.handlers.onSortOrderChange);
    }
    if (this.elements.adminToggleBtn && this.handlers.onAdminToggleClick) {
      this.elements.adminToggleBtn.removeEventListener('click', this.handlers.onAdminToggleClick);
    }
    if (this.handlers.onDocumentKeydown) {
      document.removeEventListener('keydown', this.handlers.onDocumentKeydown);
    }
    if (this.handlers.onWindowResize) {
      window.removeEventListener('resize', this.handlers.onWindowResize);
    }
    if (this.handlers.onVisibilityChange) {
      document.removeEventListener('visibilitychange', this.handlers.onVisibilityChange);
    }
    if (this.elements.answersContainer && this.handlers.onAnswersContainerClick) {
      this.elements.answersContainer.removeEventListener('click', this.handlers.onAnswersContainerClick);
    }
    if (this.handlers.onDocumentClick) {
      document.removeEventListener('click', this.handlers.onDocumentClick);
    }
    // Cleanup observers
    if (this.visibilityObserver) {
      this.visibilityObserver.disconnect();
    }
    if (this.resizeObserver) {
      this.resizeObserver.disconnect();
    }
    // Cancel any pending callbacks
    if (this.animationFrameId) {
      cancelAnimationFrame(this.animationFrameId);
    }
    if (this.idleCallbackId) {
      cancelIdleCallback(this.idleCallbackId);
    }
    // æ¼ã‚Œã¦ã„ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å‰Šé™¤
    if (this.elements.refreshContentBtn && this.handlers.onRefreshContentClick) {
      this.elements.refreshContentBtn.removeEventListener('click', this.handlers.onRefreshContentClick);
    }
    if (this.elements.dismissBannerBtn && this.handlers.onDismissBannerClick) {
      this.elements.dismissBannerBtn.removeEventListener('click', this.handlers.onDismissBannerClick);
    }
    if (this.elements.endPublicationBtn && this.handlers.onEndPublicationClick) {
      this.elements.endPublicationBtn.removeEventListener('click', this.handlers.onEndPublicationClick);
    }
    if (this.elements.sheetSelector && this.handlers.onSheetSelectorChange) {
      this.elements.sheetSelector.removeEventListener('change', this.handlers.onSheetSelectorChange);
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šãƒ•ãƒ©ã‚°ã®ãƒªã‚»ãƒƒãƒˆ
    this.eventDelegationSetup = false;
    this.nonCriticalListenersSetup = false;
    this.modalOperationPending = false;
    
    // Clear caches
    this.cache.clear();
    this.deferredUpdates.clear();
    this.domFragmentPool.length = 0;
    
    debugLog('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
  }
  async loadDataImmediate() {
    // Verify admin first to ensure proper initialization
    await this.verifyAdminAsync();
    
    // Start loading immediately without waiting
    this.loadSheetData(false, true).then(() => {
      this.startPolling();
    });
    
    // Load sheets in background
    this.loadAvailableSheets();
  }
  
  showMinimalSkeleton() {
    // Show only 3 skeletons for immediate visual feedback
    const count = 3;
    const frag = document.createDocumentFragment();
    for (let i = 0; i < count; i++) {
      frag.appendChild(this.createSkeletonCard());
    }
    this.elements.answersContainer.appendChild(frag);
  }

  displayEmptyState() {
    const container = this.elements.answersContainer;
    if (!container) return;
    
    container.innerHTML = `
      <div class="text-center py-16 px-6 col-span-full">
        <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <h3 class="mt-2 text-lg font-medium text-white">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“</h3>
        <p class="mt-1 text-sm text-gray-400">æœ€åˆã®å›ç­”è€…ã«ãªã‚Šã¾ã—ã‚‡ã†ï¼</p>
      </div>
    `;
  }

  // Add these two methods
  showLoadingOverlay() {
    if (this.elements.loadingOverlay) {
      this.elements.loadingOverlay.classList.remove('hidden');
    }
    
    // ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
    var allInteractiveElements = document.querySelectorAll('button, input, select, textarea, a, .cursor-pointer, .answer-card');
    allInteractiveElements.forEach(function(element) {
      if (element) {
        element.style.pointerEvents = 'none';
        element.style.opacity = '0.6';
      }
    });
    
    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’ç„¡åŠ¹åŒ–
    var mainContent = document.querySelector('#main-container') || document.body;
    mainContent.style.pointerEvents = 'none';
    mainContent.style.userSelect = 'none';
  }

  hideLoadingOverlay() {
    if (this.elements.loadingOverlay) {
      this.elements.loadingOverlay.classList.add('hidden');
    }
    
    // ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–
    var allInteractiveElements = document.querySelectorAll('button, input, select, textarea, a, .cursor-pointer, .answer-card');
    allInteractiveElements.forEach(function(element) {
      if (element) {
        element.style.pointerEvents = 'auto';
        element.style.opacity = '1';
      }
    });
    
    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’æœ‰åŠ¹åŒ–
    var mainContent = document.querySelector('#main-container') || document.body;
    mainContent.style.pointerEvents = 'auto';
    mainContent.style.userSelect = 'auto';
  }

  async loadSheetData(showLoading = true, isInitialLoad = false, requestedSheetName = null) {
    if (this.state.isLoading && showLoading) return;
    this.state.isLoading = true;
    this.showLoadingOverlay(); // Add this line

    const selectedClass = isInitialLoad ? 'ã™ã¹ã¦' : (this.elements.classFilter ? this.elements.classFilter.value : 'ã™ã¹ã¦');
    const oldAnswers = [...this.state.currentAnswers];
    
    // Show immediate visual feedback - but keep the question text visible
    // (Removed loading spinner from heading to keep question text always visible)
    
    // Optimized loading state - don't clear if initial load
    if (showLoading && !isInitialLoad) {
      const count = Math.min(parseInt(this.elements.sizeSlider.value, 10) * 2, 8); // Cap at 8
      const frag = document.createDocumentFragment();
      for (let i = 0; i < count; i++) {
        frag.appendChild(this.createSkeletonCard());
      }
      const container = this.elements.answersContainer;
      container.className = 'grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-' + this.elements.sizeSlider.value;
      container.innerHTML = '';
      container.appendChild(frag);
    }
    try {
      const sortOrder = this.elements.sortOrder.value;
      const classFilter = isInitialLoad ? 'ã™ã¹ã¦' : (this.elements.classFilter ? this.elements.classFilter.value : 'ã™ã¹ã¦');
      
      google.script.run
        .withSuccessHandler(result => {
          try {
            // åˆæœŸãƒ­ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
            if (isInitialLoad && this.initTimeoutId) {
              clearTimeout(this.initTimeoutId);
              this.initTimeoutId = null;
            }
            
            if (!result || !result.data || result.data.length === 0) {
              this.displayEmptyState();
              if (isInitialLoad) {
                this.state.lastSeenCount = 0;
              }
              return;
            }

            this.state.currentAnswers = result.data;
            
            // Apply saved reaction states to restore user's previous reactions
            this.applyReactionState(result.data);
            
            // Populate class filter with available classes and make it visible
            this.populateClassFilter(result.data);
            
            if (isInitialLoad) {
              this.state.lastSeenCount = result.data.length;
              // åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å®Œäº†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
              this.initialDataLoaded = true;
              const selectedClass = this.elements.classFilter ? this.elements.classFilter.value : 'ã™ã¹ã¦';
              const sortOrder = this.elements.sortOrder ? this.elements.sortOrder.value : 'newest';
              this.lastViewKey = `${selectedClass}-${sortOrder}`;
              // Initial data load completed
            }

            // Update heading with the actual question text from server (only if valid)
            if (result.header && this.elements.headingLabel && 
                result.header !== 'èª­ã¿è¾¼ã¿ä¸­...' && 
                !result.header.includes('èª­ã¿è¾¼ã¿') &&
                result.header.trim() !== '') {
              this.elements.headingLabel.textContent = result.header;
            }

            this.renderBoard(false);
          } finally {
            // æˆåŠŸæ™‚ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤
            this.state.isLoading = false;
            this.hideLoadingOverlay();
          }
        })
        .withFailureHandler(error => {
          try {
            // åˆæœŸãƒ­ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
            if (isInitialLoad && this.initTimeoutId) {
              clearTimeout(this.initTimeoutId);
              this.initTimeoutId = null;
            }
            
            console.error('Error loading sheet data:', error);
            
            // Check if the error indicates the board has been unpublished
            const errorStr = error.message || error.toString();
            if (errorStr.includes('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“') || 
                errorStr.includes('å…¬é–‹ã•ã‚Œã¦ã„ã¾ã›ã‚“') ||
                errorStr.includes('unpublished') ||
                errorStr.includes('not found')) {
              // Board has been unpublished, redirect to Unpublished.html
              console.log('Board appears to be unpublished, redirecting...');
              this.redirectToUnpublishedPage();
              return;
            }
            
            this.displayEmptyState();
          } finally {
            // ã‚¨ãƒ©ãƒ¼æ™‚ã«ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤
            this.state.isLoading = false;
            this.hideLoadingOverlay();
          }
        })
        .getPublishedSheetData(this.state.sheetName, classFilter, sortOrder, this.state.showAdminFeatures, false);
      
      
      // Post-processing after successful data load
      this.adjustLayout();
      
      if (!this.state.isAdminUser || !window.hasAdminCapability) {
        this.state.showAdminFeatures = false;
        this.state.showHighlightToggle = false;
        // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’ç¢ºå®Ÿã«éè¡¨ç¤º
        if (this.elements.adminToggleBtn) {
          this.elements.adminToggleBtn.classList.add('hidden');
          this.elements.adminToggleBtn.setAttribute('hidden', '');
          this.elements.adminToggleBtn.style.display = 'none';
        }
      } else {
        this.state.showHighlightToggle = true;
        // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        if (this.elements.adminToggleBtn) {
          this.elements.adminToggleBtn.classList.remove('hidden');
          this.elements.adminToggleBtn.removeAttribute('hidden');
          this.elements.adminToggleBtn.style.display = '';
        }
        // Admin settings updated
        this.cache.clear();
        // Cache cleared due to admin highlight settings
      }
      
      if (isInitialLoad) {
        this.elements.answersContainer.classList.add('render-optimized');
      }
    } catch (error) {
      console.error('Error loading sheet data:', error);
      const errorMessage = this.escapeHtml(error.message || 'Unknown error');
      this.elements.answersContainer.querySelectorAll('.skeleton').forEach(el => el.remove());
      this.elements.answersContainer.innerHTML = '<div class="text-center text-red-400 col-span-full mt-8 p-4 bg-red-900/20 rounded-lg">' + '<p class="font-bold">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>' + '<p class="text-sm mt-2">' + errorMessage + '</p>' + '<button id="retryLoadBtn" class="mt-4 game-btn bg-cyan-600 text-white px-4 py-2 rounded-lg font-bold border-cyan-800 hover:bg-cyan-500 text-sm">å†è©¦è¡Œ</button>' + '</div>';
      // åŒæœŸã‚¨ãƒ©ãƒ¼ã®å ´åˆã«ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤
      this.state.isLoading = false;
      this.hideLoadingOverlay();
    }
  }
  async loadAvailableSheets() {
    try {
      const sheetsData = await this.gas.getAvailableSheets();
      this.populateSheetSelector(sheetsData);
    } catch (error) {
      console.error('Failed to load available sheets:', error);
      if (this.elements.sheetSelector) {
        this.elements.sheetSelector.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼: ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—</option>';
      }
    }
  }
  populateSheetSelector(sheets) {
    const selector = this.elements.sheetSelector;
    
    if (!selector) return;

    if (!sheets || sheets.length === 0) {
      selector.innerHTML = '<option value="">åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
      selector.disabled = true;
      return;
    }
    
    // ã‚·ãƒ¼ãƒˆé¸æŠè‚¢ã‚’æ§‹ç¯‰
    if (!Array.isArray(sheets)) {
      console.error('Invalid sheets data:', sheets);
      selector.innerHTML = '<option>ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™</option>';
      selector.disabled = true;
      return;
    }
    
    const options = sheets.map(sheet => {
      const selected = sheet.name === this.state.sheetName ? 'selected' : ''; // Use sheet.name for comparison
      const activeLabel = sheet.name === this.state.sheetName ? ' (ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆ)' : '';
      return `<option value="${this.escapeHtml(sheet.name)}" ${selected}>${this.escapeHtml(sheet.name)}${activeLabel}</option>`;
    }).join('');
    
    selector.innerHTML = options;
    selector.disabled = false;
    
    // ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆã‚’è¨˜éŒ²
    // this.state.currentActiveSheet is already set by loadSheetData
  }
  async switchSheet() {
    const selectedSheet = this.elements.sheetSelector.value;
    if (!selectedSheet || selectedSheet === this.state.currentActiveSheet) {
      return;
    }
    
    try {
      // æ–°ã—ã„ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      await this.loadSheetData(true, false, selectedSheet);
      this.state.currentActiveSheet = selectedSheet;
      
      // UIã‚’æ›´æ–°
      this.updateSheetSelectorLabels();
    } catch (error) {
      console.error('Failed to switch sheet:', error);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®ã‚·ãƒ¼ãƒˆã«æˆ»ã™
      this.elements.sheetSelector.value = this.state.currentActiveSheet || '';
    }
  }
  updateSheetSelectorLabels() {
    const selector = this.elements.sheetSelector;
    const options = Array.from(selector.options);
    
    options.forEach(option => {
      const sheetName = option.value;
      const isActive = sheetName === this.state.currentActiveSheet;
      const cleanName = sheetName.replace(/ \(ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆ\)$/, '');
      
      if (isActive) {
        option.textContent = `${cleanName} (ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆ)`;
      } else {
        option.textContent = cleanName;
      }
    });
  }
  populateClassFilter(rows) {
    const classFilter = this.elements.classFilter;
    // Ensure rows is an array before mapping
    const uniqueClasses = ['ã™ã¹ã¦', ...new Set(Array.isArray(rows) ? rows.map(r => r.class).filter(Boolean) : [])];
    classFilter.innerHTML = uniqueClasses.map(c => '<option value="' + this.escapeHtml(c) + '">' + this.escapeHtml(c) + '</option>').join('');
    classFilter.value = 'ã™ã¹ã¦';
    classFilter.classList.remove('hidden');
  }
  applyReactionStyles(element, data) {
    if (!element || !data) return;
    
    // æ—¢å­˜ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢é€£ã‚¯ãƒ©ã‚¹ã‚’ã‚¯ãƒªã‚¢
    const reactionClasses = [
      'reaction-bg-like', 'reaction-bg-understand', 'reaction-bg-curious',
      'reaction-bg-like-understand', 'reaction-bg-like-curious', 'reaction-bg-understand-curious',
      'reaction-bg-like-understand-curious', 'reaction-border-1', 'reaction-border-2', 'reaction-border-3',
      'highlighted'
    ];
    reactionClasses.forEach(cls => element.classList.remove(cls));
    
    // ãƒã‚¤ãƒ©ã‚¤ãƒˆçŠ¶æ…‹ã‚’é©ç”¨ï¼ˆãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è£…é£¾ã‚ˆã‚Šå„ªå…ˆï¼‰
    if (data.highlight) {
      element.classList.add('highlighted');
      // Highlight decoration applied
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ™‚ã¯ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è£…é£¾ã‚’ã‚¹ã‚­ãƒƒãƒ—
      return;
    } else {
      // No highlight decoration
    }
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®š
    const active = this.reactionTypes.filter(rt => 
      data.reactions && data.reactions[rt.key] && data.reactions[rt.key].count > 0
    ).map(rt => rt.key);
    
    // èƒŒæ™¯è‰²ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
    if (active.length === 1) {
      if (active[0] === 'LIKE') element.classList.add('reaction-bg-like');
      else if (active[0] === 'UNDERSTAND') element.classList.add('reaction-bg-understand');
      else if (active[0] === 'CURIOUS') element.classList.add('reaction-bg-curious');
    } else if (active.length === 2) {
      const sorted = active.sort();
      if (sorted[0] === 'CURIOUS' && sorted[1] === 'LIKE') element.classList.add('reaction-bg-like-curious');
      else if (sorted[0] === 'LIKE' && sorted[1] === 'UNDERSTAND') element.classList.add('reaction-bg-like-understand');
      else if (sorted[0] === 'CURIOUS' && sorted[1] === 'UNDERSTAND') element.classList.add('reaction-bg-understand-curious');
    } else if (active.length === 3) {
      element.classList.add('reaction-bg-like-understand-curious');
    }
    
    // ãƒœãƒ¼ãƒ€ãƒ¼å¹…ã‚’é©ç”¨
    const totalReactions = this.reactionTypes.reduce((sum, rt) => sum + (data.reactions?.[rt.key]?.count || 0), 0);
    if (totalReactions >= 10) {
      element.classList.add('reaction-border-3');
    } else if (totalReactions >= 5) {
      element.classList.add('reaction-border-2');
    } else if (totalReactions > 0) {
      element.classList.add('reaction-border-1');
    }
  }
  renderBoard(isLayoutChange = false, oldRows = []) {
    // ç®¡ç†è€…ã®å ´åˆã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒˆã‚°ãƒ«ã‚’ç¢ºå®Ÿã«æœ‰åŠ¹åŒ–
    if (this.state.isAdminUser && !this.state.showHighlightToggle) {
      this.state.showHighlightToggle = true;
      // Highlight toggle force enabled in renderBoard
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒˆã‚°ãƒ«è¨­å®šãŒå¤‰æ›´ã•ã‚ŒãŸã®ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
      this.cache.clear();
      // Cache cleared due to highlight setting change
    }
    
    const container = this.elements.answersContainer;
    container.querySelectorAll('.skeleton').forEach(el => el.remove());
    const newRows = this.state.currentAnswers;
    
    // Batch DOM updates using performance-aware batching
    const updates = [];
    if (this.elements.sliderValue && this.elements.sizeSlider && 
        this.elements.sliderValue.textContent !== this.elements.sizeSlider.value) {
      updates.push(() => this.elements.sliderValue.textContent = this.elements.sizeSlider.value);
    }
    if (this.elements.sizeSlider) {
      const newClassName = 'grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-' + this.elements.sizeSlider.value;
      if (container.className !== newClassName) {
        updates.push(() => container.className = newClassName);
      }
    }
    if (this.elements.answerCount) {
      const userIcon = this.getIcon('users', 'w-4 h-4 inline-block -mt-1');
      const countHtml = userIcon + '<span>' + newRows.length + 'ä»¶</span>';
      if (this.elements.answerCount.innerHTML !== countHtml) {
        updates.push(() => this.elements.answerCount.innerHTML = countHtml);
      }
    }
    
    // Apply updates using performance-aware batching
    this.batchDOMUpdates(updates);
    
    if (newRows.length === 0) {
      if (!container.querySelector('.no-answers')) {
        container.innerHTML = '';
        const p = document.createElement('p');
        p.className = 'text-center text-gray-500 col-span-full mt-8 no-answers';
        p.textContent = 'ã“ã®ã‚¯ãƒ©ã‚¹ã®å›ç­”ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        container.appendChild(p);
      }
    } else {
      const existingMap = new Map();
      container.querySelectorAll('.answer-card').forEach(card => {
        existingMap.set(card.dataset.rowIndex, card);
      });
      existingMap.forEach((card, id) => {
        if (!newRows.some(r => String(r.rowIndex) === id)) {
          card.remove();
          existingMap.delete(id);
        }
      });
      const changedItems = [];
      let prevNode = null;
      // Enhanced batch processing with virtual scrolling for large datasets
      if (newRows.length > RENDER_BATCH_SIZE) {
        this.renderWithVirtualScrolling(newRows, oldRows, container, existingMap, changedItems);
      } else {
        // Process small datasets normally
        const fragment = this.getReusableFragment();
        
        newRows.forEach((row) => {
          const rowId = String(row.rowIndex);
          let card = existingMap.get(rowId);
          const oldData = oldRows.find(r => r.rowIndex === row.rowIndex);
          
          if (!card) {
            card = this.createAnswerCard(row);
            card.classList.add('new-card');
            
            // Add to visibility observer
            if (this.visibilityObserver) {
              this.visibilityObserver.observe(card);
            }
            
            changedItems.push(row);
            fragment.appendChild(card);
          } else {
            this.updateExistingCard(card, row, oldData, changedItems);
            // æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰ã¯æ—¢ã«DOMã«ã‚ã‚‹ã®ã§ã€ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ã—ãªã„
            // å¿…è¦ã«å¿œã˜ã¦ä½ç½®ã‚’èª¿æ•´ã™ã‚‹ãŒã€ã“ã“ã§ã¯å…ƒã®ä½ç½®ã‚’ä¿æŒ
          }
        });
        
        // Append fragment to container
        if (fragment.children.length > 0) {
          container.appendChild(fragment);
        }
        
        // Recycle fragment
        this.recycleFragment(fragment);
      }
      // Defer updates for better performance
      if (changedItems.length) {
        this.deferredRender(() => this.applyUpdates(changedItems));
      }
    }
  }
  
  renderWithVirtualScrolling(newRows, oldRows, container, existingMap, changedItems) {
    const batchSize = this.isLowPerformanceMode ? CHUNK_SIZE : RENDER_BATCH_SIZE;
    let currentIndex = 0;
    let prevNode = null;
    
    const processBatch = () => {
      const startTime = performance.now();
      const endIndex = Math.min(currentIndex + batchSize, newRows.length);
      const batch = newRows.slice(currentIndex, endIndex);
      
      // Use document fragment for efficient DOM manipulation
      const fragment = this.getReusableFragment();
      
      batch.forEach((row) => {
        const rowId = String(row.rowIndex);
        let card = existingMap.get(rowId);
        const oldData = oldRows.find(r => r.rowIndex === row.rowIndex);
        
        if (!card) {
          card = this.createAnswerCard(row);
          card.classList.add('new-card');
          
          // Add to visibility observer for virtual scrolling
          if (this.visibilityObserver) {
            this.visibilityObserver.observe(card);
          }
          
          changedItems.push(row);
          fragment.appendChild(card);
        } else {
          this.updateExistingCard(card, row, oldData, changedItems);
          // æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰ã¯æ—¢ã«DOMã«ã‚ã‚‹ã®ã§ã€ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ã—ãªã„
        }
      });
      
      // Append fragment to container
      if (fragment.children.length > 0) {
        container.appendChild(fragment);
      }
      
      // Recycle fragment
      this.recycleFragment(fragment);
      
      currentIndex = endIndex;
      
      // Continue processing if there are more items
      if (currentIndex < newRows.length) {
        const elapsed = performance.now() - startTime;
        
        if (elapsed < PERFORMANCE_BUDGET && !this.isLowPerformanceMode) {
          // Continue synchronously if we have time budget
          processBatch();
        } else {
          // Defer to next frame/idle callback
          this.deferredRender(processBatch);
        }
      }
    };
    
    processBatch();
  }
  
  updateExistingCard(card, row, oldData, changedItems) {
    if (oldData) {
      let hasChanges = false;
      
      if (oldData.opinion !== row.opinion) {
        const t = card.querySelector('.opinion-text');
        if (t) {
          t.textContent = row.opinion;
          hasChanges = true;
        }
      }
      
      if (oldData.reason !== row.reason) {
        const p = card.querySelector('.answer-preview p');
        if (p) {
          p.textContent = row.reason;
          hasChanges = true;
        }
      }
      
      if (oldData.name !== row.name) {
        const n = card.querySelector('.font-bold');
        if (n) {
          n.textContent = row.name;
          hasChanges = true;
        }
      }
      
      if (JSON.stringify(oldData.reactions) !== JSON.stringify(row.reactions) || 
          oldData.highlight !== row.highlight) {
        hasChanges = true;
      }
      
      if (hasChanges) {
        changedItems.push(row);
      }
    }
  }
  createAnswerCard(data) {
    // Optimized cache key generation (faster than JSON.stringify)
    const cacheKey = `${data.rowIndex}-${data.opinion?.slice(0,50)}-${data.reason?.slice(0,30)}-${data.name}-${JSON.stringify(data.reactions)}-${data.highlight}-${this.state.showCounts}-${this.state.displayMode}-${this.state.showHighlightToggle}`;
    
    // Answer card cache check
    
    const cachedCard = this.cache.get(`render-${cacheKey}`);
    if (cachedCard) {
      const clonedCard = cachedCard.cloneNode(true);
      // Ensure cloned card has proper data-row-index
      clonedCard.dataset.rowIndex = data.rowIndex;
      
      // Optimized: Only update elements that need row index (avoid querySelectorAll)
      const reactionButtons = clonedCard.querySelectorAll('.reaction-btn');
      reactionButtons.forEach(btn => {
        btn.dataset.rowIndex = data.rowIndex;
      });
      
      // Using cached card
      return clonedCard;
    }
    
    const card = document.createElement('div');
    const highlightClass = data.highlight ? ' highlighted' : '';
    card.className = 'relative answer-card glass-panel rounded-xl p-4 flex flex-col justify-between shadow-lg border-2 border-cyan-400/80 cursor-pointer' + highlightClass;
    card.dataset.rowIndex = data.rowIndex;
    card.setAttribute('role', 'article');
    card.setAttribute('tabindex', '0');
    card.setAttribute('aria-label', 'å›ç­”ã‚«ãƒ¼ãƒ‰: ' + (data.opinion || '').substring(0, 50) + (data.opinion && data.opinion.length > 50 ? '...' : ''));
    
    // Answer card created
    let highlightBtnHtml = '';
    // Highlight button condition check
    if (this.state.showHighlightToggle) {
      const cls = data.highlight ? 'liked' : '';
      const highlightAriaLabel = data.highlight ? 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤ã™ã‚‹' : 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹';
      highlightBtnHtml = '<button type="button" class="highlight-btn like-btn text-purple-600 ' + cls + '" aria-label="' + highlightAriaLabel + '" aria-pressed="' + data.highlight + '" data-row-index="' + data.rowIndex + '">' + this.getIcon('star', 'w-5 h-5', data.highlight) + '</button>';
      // Highlight button created
    } else {
      // Highlight button skipped
    }
    const showName = this.state.displayMode === 'named';
    let displayName = '';
    
    // Debug: Log display mode and admin features state
    // Card display state configured
    
    if (showName) {
      // åå‰ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°emailã‹ã‚‰ç”Ÿæˆ
      if (data.name) {
        displayName = data.name;
      } else if (data.email) {
        displayName = data.email.split('@')[0];
      }
      
    }
    
    const nameHtml = showName && displayName ? '<div class="name-display flex-shrink-0 mr-2"><span class="font-bold text-sm text-cyan-300 bg-gray-800/50 px-2 py-1 rounded border border-cyan-400">' + this.escapeHtml(displayName) + '</span></div>' : '';
    const containerClass = nameHtml ? 'text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex flex-col sm:flex-row justify-between items-start sm:items-center gap-y-1 min-h-[2rem]' : 'text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex justify-end items-center';
    
    // Name display configuration complete
    const reactionButtonsHtml = this.reactionTypes.map(rt => {
      const info = data.reactions ? data.reactions[rt.key] : { count: 0, reacted: false };
      const cls = info.reacted ? 'liked' : '';
      const colorClass = rt.key === 'LIKE' ? 'text-red-500' : rt.key === 'UNDERSTAND' ? 'text-yellow-500' : 'text-green-500';
      const countSpan = this.state.showCounts ? '<span class="reaction-count font-bold text-lg text-gray-200" aria-hidden="true">' + (info.count || 0) + '</span>' : '';
      const reactionNames = { 'LIKE': 'ã„ã„ã­ï¼', 'UNDERSTAND': 'ãªã‚‹ã»ã©ï¼', 'CURIOUS': 'ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ï¼' };
      const reactionName = reactionNames[rt.key] || rt.key;
      const ariaLabel = `${reactionName}${info.reacted ? 'ã‚’å–ã‚Šæ¶ˆã™' : 'ã™ã‚‹'}${this.state.showCounts ? ` (ç¾åœ¨${info.count || 0}ä»¶)` : ''}`;
      return '<button type="button" class="reaction-btn like-btn flex items-center gap-1 ' + colorClass + ' ' + cls + '" data-row-index="' + data.rowIndex + '" data-reaction="' + rt.key + '" aria-label="' + ariaLabel + '" aria-pressed="' + info.reacted + '">' + this.getIcon(rt.icon, 'w-5 h-5', info.reacted) + countSpan + '</button>';
    }).join('');
    // Optimized: Use DocumentFragment instead of innerHTML for better performance
    const fragment = document.createDocumentFragment();
    
    // Create main content div
    const contentDiv = document.createElement('div');
    contentDiv.className = 'relative flex-grow mb-3 answer-preview';
    
    const opinionTitle = document.createElement('h3');
    opinionTitle.className = 'opinion-text text-cyan-200 whitespace-pre-wrap break-words text-xl md:text-2xl font-semibold leading-tight';
    opinionTitle.textContent = data.opinion || '';
    
    const reasonText = document.createElement('p');
    reasonText.className = 'text-gray-100 whitespace-pre-wrap break-words mt-4';
    reasonText.textContent = data.reason || '';
    
    contentDiv.appendChild(opinionTitle);
    contentDiv.appendChild(reasonText);
    
    // Create footer div
    const footerDiv = document.createElement('div');
    footerDiv.className = containerClass;
    
    // åå‰è¡¨ç¤ºéƒ¨åˆ†ã‚’è¿½åŠ 
    if (nameHtml) {
      const nameContainer = document.createElement('div');
      nameContainer.className = 'name-container flex-shrink-0';
      nameContainer.innerHTML = nameHtml;
      footerDiv.appendChild(nameContainer);
      console.log('âœ… åå‰ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ :', {
        rowIndex: data.rowIndex,
        nameHtml,
        containerHTML: nameContainer.outerHTML
      });
    } else {
      console.log('âŒ åå‰HTMLç”Ÿæˆã•ã‚Œãš:', {
        rowIndex: data.rowIndex,
        showName,
        displayName
      });
    }
    
    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’è¿½åŠ 
    const reactionsDiv = document.createElement('div');
    reactionsDiv.className = 'flex items-center gap-1 flex-shrink-0';
    reactionsDiv.setAttribute('role', 'group');
    reactionsDiv.setAttribute('aria-label', 'å›ç­”ã¸ã®åå¿œ');
    reactionsDiv.innerHTML = reactionButtonsHtml + highlightBtnHtml;
    
    footerDiv.appendChild(reactionsDiv);
    
    // æœ€çµ‚çš„ãªfooterDivã®å†…å®¹ã‚’ç¢ºèª
    console.log('ğŸ“¦ ãƒ•ãƒƒã‚¿ãƒ¼æ§‹æˆç¢ºèª:', {
      rowIndex: data.rowIndex,
      footerChildren: footerDiv.children.length,
      footerHTML: footerDiv.outerHTML.substring(0, 200)
    });
    
    fragment.appendChild(contentDiv);
    fragment.appendChild(footerDiv);
    card.appendChild(fragment);
    if (data.highlight) {
      const badge = document.createElement('span');
      badge.className = 'highlight-badge';
      badge.innerHTML = this.getIcon('star', '', true);
      card.appendChild(badge);
    }
    
    // çµ±ä¸€ã•ã‚ŒãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
    this.applyReactionStyles(card, data);
    
    // Cache the card for reuse (limit cache size)
    if (this.cache.size > 100) {
      this.cache.cleanup();
    }
    this.cache.set(`render-${cacheKey}`, card.cloneNode(true));
    
    return card;
  }
  createSkeletonCard() {
    const card = document.createElement('div');
    card.className = 'answer-card glass-panel rounded-xl p-4 flex flex-col justify-between shadow-lg border-2 border-cyan-400/80 skeleton';
    // Simplified skeleton for faster rendering
    card.innerHTML = '<div class="h-20 w-full rounded bg-gray-500/30 mb-4"></div><div class="h-6 w-full rounded bg-gray-500/20"></div>';
    return card;
  }
  /**
 * ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ï¼ˆé€£ç¶šã‚¯ãƒªãƒƒã‚¯é˜²æ­¢æ©Ÿèƒ½ï¼‹å®‰å®šåŒ–ã•ã‚ŒãŸUIæ›´æ–°ï¼‰
 */
/**
 * ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ï¼ˆé€£ç¶šã‚¯ãƒªãƒƒã‚¯é˜²æ­¢æ©Ÿèƒ½ï¼‹å®‰å®šåŒ–ã•ã‚ŒãŸUIæ›´æ–°ï¼‰
 */
async handleReaction(rowIndex, reaction) {
    const numericRowIndex = parseInt(rowIndex, 10);
    const reactionKey = `${numericRowIndex}-${reaction}`;

    // â˜…é€£ç¶šã‚¯ãƒªãƒƒã‚¯é˜²æ­¢æ©Ÿèƒ½ï¼ˆå•é¡Œç‰ˆã‹ã‚‰ç¶™æ‰¿ï¼‰
    if (this.pendingReactions.has(reactionKey)) {
        return; // ã™ã§ã«å‡¦ç†ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
    }
    this.pendingReactions.add(reactionKey);

    const btns = document.querySelectorAll(`[data-row-index="${rowIndex}"][data-reaction="${reaction}"]`);
    
    // ãƒœã‚¿ãƒ³ã‚’å³åº§ã«ç„¡åŠ¹åŒ–ã—ã¦è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›
    btns.forEach(btn => {
        btn.disabled = true;
        btn.classList.add('loading');
    });
    const item = this.state.currentAnswers.find(i => i.rowIndex == numericRowIndex);

    if (!item) {
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
        btns.forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('loading');
        });
        this.pendingReactions.delete(reactionKey);
        return;
    }

    // 1äºº1ã¤ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯
    const currentReactions = item.reactions || {};
    const hasAnyReaction = Object.keys(currentReactions).some(key => 
      currentReactions[key] && currentReactions[key].reacted
    );
    
    const isCurrentReactionActive = currentReactions[reaction] && currentReactions[reaction].reacted;
    
    // æ—¢ã«ä»–ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã—ã¦ã„ã‚‹å ´åˆã§ã‚‚ã€åˆ¥ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ç›´æ¥åˆ‡ã‚Šæ›¿ãˆã‚’è¨±å¯
    // ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•çš„ã«æ—¢å­˜ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼‰
    if (hasAnyReaction && !isCurrentReactionActive) {
      debugLog('æ—¢å­˜ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™:', { 
        existingReactions: Object.keys(currentReactions).filter(key => currentReactions[key]?.reacted),
        newReaction: reaction
      });
    }

    try {
        // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆâ‘¡ï¼šå…ˆã«ã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡ã™ã‚‹
        const res = await this.gas.addReaction(numericRowIndex, reaction, this.state.sheetName);

        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å®‰å…¨ãªå‡¦ç†
        debugLog('addReactionãƒ¬ã‚¹ãƒãƒ³ã‚¹:', { res, type: typeof res });
        
        if (res && res.status === 'ok') {
            // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆâ‘¢ï¼šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”æˆåŠŸå¾Œã«ã€UIã‚’å®Œå…¨ã«æ›´æ–°ã™ã‚‹
            if (res.reactions && typeof res.reactions === 'object') {
                item.reactions = res.reactions;
            } else {
                debugLog('è­¦å‘Š: reactionsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒæœŸå¾…ã•ã‚ŒãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ã®reactionsã‚’ä¿æŒã—ã€ã‚«ã‚¦ãƒ³ãƒˆã®ã¿æ›´æ–°
                if (!item.reactions) {
                    item.reactions = {};
                }
                if (!item.reactions[reaction]) {
                    item.reactions[reaction] = { count: 0, reacted: false };
                }
                item.reactions[reaction].count = (item.reactions[reaction].count || 0) + 1;
                item.reactions[reaction].reacted = true;
            }
            
            // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’localStorageã«ä¿å­˜
            this.saveReactionState(numericRowIndex, item.reactions);
            
            // UIçŠ¶æ…‹ã‚’å³åº§ã«æ›´æ–°
            requestAnimationFrame(() => {
                this.applyUpdates([item]); // æ¬¡ã®æç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã§å®‰å…¨ã«UIã‚’æ›´æ–°
                
                // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å¼·åˆ¶æ›´æ–°
                const reactionBtns = document.querySelectorAll(`[data-row-index="${rowIndex}"][data-reaction="${reaction}"]`);
                reactionBtns.forEach(btn => {
                    const reactionInfo = item.reactions?.[reaction];
                    if (reactionInfo?.reacted) {
                        btn.classList.add('liked');
                        btn.setAttribute('aria-pressed', 'true');
                    } else {
                        btn.classList.remove('liked');
                        btn.setAttribute('aria-pressed', 'false');
                    }
                });
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚Œã°ãã¡ã‚‰ã‚‚æ›´æ–°
            if (!this.elements.answerModalContainer.classList.contains('hidden')) {
                const modalRowIndex = this.elements.modalReactionContainer.querySelector('[data-row-index]')?.dataset.rowIndex;
                if (modalRowIndex == rowIndex) {
                    this.updateModalContent(item);
                }
            }
        } else {
            const errorMsg = res?.message || 'ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ';
            debugLog('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³APIã‚¨ãƒ©ãƒ¼:', { 
                res, 
                errorMsg,
                responseType: typeof res,
                hasValues: res?.values !== undefined,
                responseKeys: res ? Object.keys(res) : []
            });
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (errorMsg.includes('Cannot read properties of undefined')) {
                throw new Error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            } else {
                throw new Error(errorMsg);
            }
        }
    } catch (error) {
        console.error('Failed to add reaction:', error);
        debugLog('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
            error: error.message,
            stack: error.stack,
            reaction,
            rowIndex,
            item: item ? { rowIndex: item.rowIndex, hasReactions: !!item.reactions } : null
        });
        this.showErrorFeedback(btns[0], 'ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ä½•ã‚‚ã—ãªã„ï¼ˆUIã¯å…ƒã®çŠ¶æ…‹ã®ã¾ã¾ï¼‰
    } finally {
        // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆâ‘£ï¼šæœ€å¾Œã«ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤
        btns.forEach(btn => {
            btn.classList.remove('loading');
            btn.disabled = false;
        });
        this.pendingReactions.delete(reactionKey);
    }
}
  
  showErrorFeedback(btn, message) {
    if (!btn) return;
    
    // å…ƒã®ã‚¯ãƒ©ã‚¹ã‚’ä¿å­˜
    const originalClasses = btn.className;
    
    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    btn.classList.add('bg-red-500');
    btn.title = message;
    
    // 2ç§’å¾Œã«å…ƒã«æˆ»ã™
    setTimeout(() => {
      btn.className = originalClasses;
      btn.title = '';
    }, 2000);
  }
  async handleHighlight(rowIndex) {
    // Highlight processing started
    
    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§ç®¡ç†è€…æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã®ã§ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã®ãƒã‚§ãƒƒã‚¯ã¯ä¸è¦
    
    const numericRowIndex = parseInt(rowIndex, 10);
    const highlightKey = `${numericRowIndex}-highlight`;
    
    // Enhanced debounce for highlight operations
    if (this.highlightDebounce.has(highlightKey)) {
      clearTimeout(this.highlightDebounce.get(highlightKey));
      return; // Ignore rapid highlight clicks
    }
    
    // Rate limiting for highlights
    const now = Date.now();
    const lastHighlightTime = this.lastReactionTimes?.get(highlightKey) || 0;
    if (now - lastHighlightTime < 500) { // Minimum 500ms between highlights
      return;
    }
    
    // æ—¢ã«å‡¦ç†ä¸­ã®å ´åˆã¯ç„¡è¦–
    if (this.pendingReactions.has(highlightKey)) {
      return;
    }
    
    this.pendingReactions.add(highlightKey);
    if (!this.lastReactionTimes) this.lastReactionTimes = new Map();
    this.lastReactionTimes.set(highlightKey, now);
    
    const btns = document.querySelectorAll('.highlight-btn[data-row-index="' + numericRowIndex + '"]');
    const item = this.state.currentAnswers.find(i => i.rowIndex == numericRowIndex);
    
    if (!item) {
      this.pendingReactions.delete(highlightKey);
      return;
    }
    
    // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆâ‘ ï¼šUIæ›´æ–°ã‚’ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®ã¿ã«é™å®š
    btns.forEach(btn => {
        btn.classList.add('loading');
        btn.disabled = true;
    });
    
    try {
        // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆâ‘¡ï¼šå…ˆã«ã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡ã™ã‚‹
        const res = await this.gas.toggleHighlight(numericRowIndex, this.state.sheetName);

        if (res && res.status === 'ok') {
            // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆâ‘¢ï¼šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”æˆåŠŸå¾Œã«ã€UIã‚’å®Œå…¨ã«æ›´æ–°ã™ã‚‹
            item.highlight = res.highlight;
            requestAnimationFrame(() => this.applyUpdates([item])); // æ¬¡ã®æç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã§å®‰å…¨ã«UIã‚’æ›´æ–°

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚Œã°ãã¡ã‚‰ã‚‚æ›´æ–°
            if (!this.elements.answerModalContainer.classList.contains('hidden')) {
                const modalRowIndex = this.elements.modalReactionContainer.querySelector('[data-row-index]')?.dataset.rowIndex;
                if (modalRowIndex == rowIndex) {
                    this.updateModalContent(item);
                }
            }
        } else {
            throw new Error(res?.message || 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error('Failed to toggle highlight:', error);
        this.showErrorFeedback(btns[0], 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
        // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆâ‘£ï¼šæœ€å¾Œã«ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤
        btns.forEach(btn => {
            btn.classList.remove('loading');
            btn.disabled = false;
        });
        this.pendingReactions.delete(highlightKey);
    }
  }
  
  async toggleAdminMode() {
    // Temporarily disable button to prevent duplicate clicks
    if (this.elements.adminToggleBtn) {
      this.elements.adminToggleBtn.disabled = true;
    }
    
    try {
      const enable = !this.state.showAdminFeatures;
      
      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      if (enable) {
        if (!this.state.isAdminUser || !window.hasAdminCapability) {
          console.warn('ç®¡ç†è€…æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
          return;
        }
        
        // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ç§»è¡Œæ™‚ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
        const confirmed = await this.showAdminModeConfirmation();
        if (!confirmed) {
          return; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆ
        }
        
        // æœ€åˆã®ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ã¿ã‚µãƒ¼ãƒãƒ¼å´ã§å†ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if (!this.adminModeVerified) {
          try {
            const ok = await this.gas.checkAdmin();
            if (!ok) {
              console.warn('ã‚µãƒ¼ãƒãƒ¼å´ã®æ¨©é™ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
              // ãƒ­ãƒ¼ã‚«ãƒ«ã®æ¨©é™æƒ…å ±ã‚’ä¿¡é ¼ã—ã¦ç¶™ç¶š
            }
            this.adminModeVerified = true;
          } catch (e) {
            console.warn('æ¨©é™ç¢ºèªAPIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã®æ¨©é™æƒ…å ±ã‚’ä¿¡é ¼ã—ã¦ç¶™ç¶š
          }
        }
      }
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‚’æ›´æ–°
      window.showAdminFeatures = enable;
      window.showHighlightToggle = this.state.isAdminUser; // ç®¡ç†è€…ãªã‚‰å¸¸ã«è¡¨ç¤º
      
      debugLog('toggleAdminModeçŠ¶æ…‹æ›´æ–°:', {
        enable,
        isAdminUser: this.state.isAdminUser,
        showAdminFeatures: window.showAdminFeatures,
        showHighlightToggle: window.showHighlightToggle
      });
      if (enable) {
        // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯å¼·åˆ¶çš„ã«åå‰ã¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’è¡¨ç¤º
        window.showCounts = true;
        window.displayMode = 'named';
        window.isStudentMode = false;
        window.showScoreSort = window.showCounts;
        debugLog('ç®¡ç†ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–: åå‰ã¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’å¼·åˆ¶è¡¨ç¤º', {
          showCounts: window.showCounts,
          displayMode: window.displayMode
        });
      } else {
        // é–²è¦§ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ã‚µãƒ¼ãƒãƒ¼è¨­å®šã«æˆ»ã™
        window.showCounts = this.serverShowCounts;
        window.displayMode = this.serverDisplayMode;
        window.isStudentMode = true;
        window.showScoreSort = window.showCounts;
        debugLog('é–²è¦§ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–: ã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚’å¾©å…ƒ', {
          showCounts: window.showCounts,
          displayMode: window.displayMode,
          serverShowCounts: this.serverShowCounts,
          serverDisplayMode: this.serverDisplayMode
        });
      }
      
      // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹æ™‚ã¯å¼·åˆ¶çš„ã«ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚‚æ›´æ–°
      if (enable) {
        this.state.displayMode = 'named';
        this.state.showCounts = true;
        this.state.isStudentMode = false;
      } else {
        this.state.displayMode = this.serverDisplayMode;
        this.state.showCounts = this.serverShowCounts;
        this.state.isStudentMode = true;
      }
      
      // Update local state from global variables (but preserve displayMode if in admin mode)
      this.updateConfigFromGlobals();
      
      // Re-enforce admin mode settings after updateConfigFromGlobals
      if (enable) {
        this.state.displayMode = 'named';
        this.state.showCounts = true;
      }
      
      // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª
      debugLog('ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå¾Œã®çŠ¶æ…‹ç¢ºèª:', {
        enable,
        stateDisplayMode: this.state.displayMode,
        stateShowCounts: this.state.showCounts,
        windowDisplayMode: window.displayMode,
        windowShowCounts: window.showCounts
      });
      
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã—ã„è¨­å®šã§å†æç”»
      this.cache.clear();
      
      // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã¯æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰ã‚’å…¨ã¦å‰Šé™¤ã—ã¦å¼·åˆ¶å†ç”Ÿæˆ
      this.elements.answersContainer.innerHTML = '';
      
      // UIçŠ¶æ…‹ã‚’æ›´æ–°
      this.updateSortOptions();
      this.updateAdminButtonUI();
      this.updateEndPublicationButtonUI();
      // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã¯è¨­å®šå¤‰æ›´ã®ãŸã‚å†æç”»ãŒå¿…è¦
      this.loadSheetData(true, false).then(() => {
        // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå¾Œã«æ–°ç€ãƒã‚§ãƒƒã‚¯ã®åŸºæº–ã‚’æ›´æ–°
        this.state.lastSeenCount = this.state.currentAnswers.length;
        console.log('ğŸ”„ ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå®Œäº†ã€æ–°ç€ãƒã‚§ãƒƒã‚¯åŸºæº–æ›´æ–°:', {
          newBaselineCount: this.state.lastSeenCount,
          adminMode: this.state.showAdminFeatures
        });
      });
    } finally {
      // Re-enable button
      if (this.elements.adminToggleBtn) {
        this.elements.adminToggleBtn.disabled = false;
      }
    }
  }
  
  /**
   * ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ç§»è¡Œç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
   */
  async showAdminModeConfirmation() {
    return new Promise((resolve) => {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’ä½œæˆ
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
          <div class="flex items-center mb-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
              </svg>
            </div>
            <div class="ml-4">
              <h3 class="text-lg font-medium text-gray-900">ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ</h3>
            </div>
          </div>
          <div class="mb-6">
            <p class="text-sm text-gray-600">
              ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€<strong>ç”Ÿå¾’ã®åå‰ã¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ãŒè¡¨ç¤º</strong>ã•ã‚Œã¾ã™ã€‚<br>
              ç”»é¢å…±æœ‰æ™‚ãªã©ã¯ååˆ†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
            </p>
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" class="cancel-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button type="button" class="confirm-btn px-4 py-2 text-sm font-medium text-white bg-orange-600 border border-transparent rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
              ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
            </button>
          </div>
        </div>
      `;
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const cancelBtn = modal.querySelector('.cancel-btn');
      const confirmBtn = modal.querySelector('.confirm-btn');
      
      const cleanup = () => {
        document.body.removeChild(modal);
      };
      
      cancelBtn.addEventListener('click', () => {
        cleanup();
        resolve(false);
      });
      
      confirmBtn.addEventListener('click', () => {
        cleanup();
        resolve(true);
      });
      
      // Escapeã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      const handleKeydown = (e) => {
        if (e.key === 'Escape') {
          cleanup();
          document.removeEventListener('keydown', handleKeydown);
          resolve(false);
        }
      };
      document.addEventListener('keydown', handleKeydown);
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.body.appendChild(modal);
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¢ºèªãƒœã‚¿ãƒ³ã«ç§»å‹•
      setTimeout(() => confirmBtn.focus(), 100);
    });
  }
  
  async endPublication() {
    if (!confirm('å…¬é–‹ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿç”Ÿå¾’ã¯å›ç­”ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚')) {
      return;
    }
    
    try {
      await this.runGas('clearActiveSheet');
      if (window.sharedModals) {
        window.sharedModals.showAlert('å…¬é–‹çµ‚äº†', 'å…¬é–‹ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚ç®¡ç†ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚', 'success');
      } else {
        alert('å…¬é–‹ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚ç®¡ç†ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚');
      }
      // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰Unpublished.htmlã«ç§»å‹•ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ï¼‰
      setTimeout(() => {
        this.redirectToUnpublishedPage();
      }, 1500);
    } catch (error) {
      console.error('å…¬é–‹çµ‚äº†ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      const errorMsg = 'å…¬é–‹çµ‚äº†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error);
      if (window.sharedModals) {
        window.sharedModals.showAlert('ã‚¨ãƒ©ãƒ¼', errorMsg, 'error');
      } else {
        alert(errorMsg);
      }
    }
  }
  redirectToUnpublishedPage() {
    // Force redirect to Unpublished.html for both admin and viewers
    google.script.run
      .withSuccessHandler(function(webAppUrl) {
        const url = new URL(webAppUrl);
        // Redirect to Unpublished.html
        url.pathname = url.pathname.replace(/\/[^\/]*$/, '/Unpublished.html');
        window.location.href = url.toString();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to get web app URL:', error);
        // Fallback: try relative path
        window.location.href = './Unpublished.html';
      })
      .getWebAppUrl();
  }
  
  endAdminMode() {
    google.script.run
      .withSuccessHandler(function(adminUrl) {
        const url = new URL(adminUrl);
        url.searchParams.set('mode', 'admin');
        window.location.href = url.toString();
      })
      .getWebAppUrl();
  }
  
  /**
   * ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’localStorageã«ä¿å­˜
   * @param {number} rowIndex - è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
   * @param {object} reactions - ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  saveReactionState(rowIndex, reactions) {
    try {
      // æ—¢å­˜ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const existingData = JSON.parse(localStorage.getItem(this.reactionStorageKey) || '{}');
      
      // ç¾åœ¨ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ä¿å­˜
      existingData[rowIndex] = {};
      Object.keys(reactions).forEach(reactionType => {
        const reaction = reactions[reactionType];
        if (reaction && reaction.reacted) {
          existingData[rowIndex][reactionType] = {
            reacted: true,
            timestamp: new Date().toISOString()
          };
        }
      });
      
      // ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯å‰Šé™¤
      if (Object.keys(existingData[rowIndex]).length === 0) {
        delete existingData[rowIndex];
      }
      
      localStorage.setItem(this.reactionStorageKey, JSON.stringify(existingData));
      debugLog('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ä¿å­˜:', { rowIndex, reactions: existingData[rowIndex] });
    } catch (error) {
      console.warn('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ä¿å­˜ã«å¤±æ•—:', error);
    }
  }
  
  /**
   * localStorageã‹ã‚‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿
   * @returns {object} ä¿å­˜ã•ã‚ŒãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹
   */
  loadReactionState() {
    try {
      const savedData = JSON.parse(localStorage.getItem(this.reactionStorageKey) || '{}');
      debugLog('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿:', savedData);
      return savedData;
    } catch (error) {
      console.warn('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
      return {};
    }
  }
  
  /**
   * ä¿å­˜ã•ã‚ŒãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã«é©ç”¨
   * @param {array} answers - å›ç­”ãƒ‡ãƒ¼ã‚¿é…åˆ—
   */
  applyReactionState(answers) {
    const savedReactions = this.loadReactionState();
    
    answers.forEach(answer => {
      const savedReaction = savedReactions[answer.rowIndex];
      if (savedReaction && answer.reactions) {
        Object.keys(savedReaction).forEach(reactionType => {
          if (answer.reactions[reactionType]) {
            answer.reactions[reactionType].reacted = true;
          }
        });
      }
    });
    
    debugLog('ä¿å­˜ã•ã‚ŒãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’é©ç”¨å®Œäº†');
  }
  updateReactionButtonUI(rowIndex, reaction, count, reacted) {
    document.querySelectorAll('[data-row-index="' + rowIndex + '"][data-reaction="' + reaction + '"]').forEach(btn => {
      const countEl = btn.querySelector('.reaction-count');
      if (countEl && this.state.showCounts) {
        countEl.textContent = count;
      }
      const rt = this.reactionTypes.find(r => r.key === reaction);
      const svgEl = btn.querySelector('svg');
      if (svgEl && rt) {
        svgEl.outerHTML = this.getIcon(rt.icon, 'w-5 h-5', reacted);
      }
      const colorClass = reaction === 'LIKE' ? 'text-red-500' : reaction === 'UNDERSTAND' ? 'text-yellow-500' : 'text-green-500';
      btn.classList.remove('text-red-500', 'text-yellow-500', 'text-green-500');
      btn.classList.add(colorClass);
      btn.classList.toggle('liked', reacted);
      btn.setAttribute('aria-pressed', reacted.toString());
      const reactionNames = { 'LIKE': 'ã„ã„ã­ï¼', 'UNDERSTAND': 'ãªã‚‹ã»ã©ï¼', 'CURIOUS': 'ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ï¼' };
      const reactionName = reactionNames[reaction] || reaction;
      const ariaLabel = `${reactionName}${reacted ? 'ã‚’å–ã‚Šæ¶ˆã™' : 'ã™ã‚‹'}${this.state.showCounts ? ` (ç¾åœ¨${count}ä»¶)` : ''}`;
      btn.setAttribute('aria-label', ariaLabel);
    });
  }
  applyUpdates(items) {
    items.forEach(item => {
      this.reactionTypes.forEach(rt => {
        if (item.reactions && item.reactions[rt.key]) {
          this.updateReactionButtonUI(item.rowIndex, rt.key, item.reactions[rt.key].count, item.reactions[rt.key].reacted);
        }
      });
      const card = document.querySelector('.answer-card[data-row-index="' + item.rowIndex + '"]');
      if (card) {
        card.classList.toggle('highlighted', item.highlight);
        this.applyReactionStyles(card, item);
        const highlightBtn = card.querySelector('.highlight-btn');
        if (highlightBtn) {
          highlightBtn.classList.toggle('liked', item.highlight);
          highlightBtn.setAttribute('aria-pressed', String(item.highlight));
          const label = item.highlight ? 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤ã™ã‚‹' : 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹';
          highlightBtn.setAttribute('aria-label', label);
          const svgEl = highlightBtn.querySelector('svg');
          if (svgEl) {
            svgEl.outerHTML = this.getIcon('star', 'w-5 h-5', item.highlight);
          }
        }
        let badge = card.querySelector('.highlight-badge');
        if (item.highlight && !badge) {
          badge = document.createElement('span');
          badge.className = 'highlight-badge';
          badge.innerHTML = this.getIcon('star', '', true);
          card.appendChild(badge);
        } else if (!item.highlight && badge) {
          badge.remove();
        }
      }
    });
  }
  showAnswerModal(rowIndex) {
    if (DEBUG_MODE) console.log('ğŸ“± [MODAL DEBUG] showAnswerModal called:', {
        rowIndex: rowIndex,
        rowIndexType: typeof rowIndex,
        timestamp: new Date().toISOString()
    });

    // Show answer modal called

    // Data search context
    
    // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆfilteredDataã¨currentAnswersã®ä¸¡æ–¹ã‹ã‚‰ï¼‰
    let data = this.state.currentAnswers.find(r => r.rowIndex == rowIndex);
    // Data search in currentAnswers
    
    if (!data && this.state.filteredData) {
      data = this.state.filteredData.find(r => r.rowIndex == rowIndex);
      debugLog('Data search in filteredData:', {
        found: !!data,
        searchRowIndex: rowIndex,
        availableRowIndexes: this.state.filteredData?.map(r => r.rowIndex) || []
      });
    }
    
    if (!data) {
      debugLog('ERROR: No data found for rowIndex:', {
        rowIndex: rowIndex,
        currentAnswers: this.state.currentAnswers,
        filteredData: this.state.filteredData
      });
      return;
    }
    
    debugLog('Data found for modal:', {
      rowIndex: rowIndex,
      data: data,
      opinion: data.opinion?.substring(0, 50) + '...',
      reason: data.reason?.substring(0, 50) + '...'
    });
    this.state.lastFocusedElement = document.activeElement;
    this.elements.modalAnswer.innerHTML = '<p class="text-cyan-200 whitespace-pre-wrap break-words text-3xl md:text-4xl font-bold leading-tight">' + this.escapeHtml(data.opinion || '') + '</p>' + '<p class="text-gray-200 whitespace-pre-wrap break-words text-2xl md:text-3xl mt-6">' + this.escapeHtml(data.reason || '') + '</p>';
    const showName = this.state.displayMode === 'named';
    let modalDisplayName = '';
    
    // Debug: Log modal display mode state
    debugLog('Modal display state:', {
      displayMode: this.state.displayMode,
      showName,
      showAdminFeatures: this.state.showAdminFeatures,
      isAdminUser: this.state.isAdminUser,
      dataName: data.name,
      dataEmail: data.email
    });
    
    if (showName) {
      // åå‰ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°emailã‹ã‚‰ç”Ÿæˆ
      if (data.name) {
        modalDisplayName = data.name;
      } else if (data.email) {
        modalDisplayName = data.email.split('@')[0];
      }
    }
    
    this.elements.modalStudentName.textContent = modalDisplayName;
    const footerBase = 'text-xs text-gray-400 pt-4 border-t-2 border-dashed border-cyan-400/80 flex';
    this.elements.modalFooter.className = footerBase + (showName ? ' justify-between items-center' : ' justify-end items-center');
    const reactionButtonsHtml = this.reactionTypes.map(rt => {
      const info = data.reactions?.[rt.key] || { count: 0, reacted: false };
      const cls = info.reacted ? 'liked' : '';
      const colorClass = rt.key === 'LIKE' ? 'text-red-500' : rt.key === 'UNDERSTAND' ? 'text-yellow-500' : 'text-green-500';
      const countSpan = this.state.showCounts ? '<span class="reaction-count font-bold text-2xl text-gray-200">' + info.count + '</span>' : '';
      return '<button type="button" class="reaction-btn like-btn flex items-center gap-1.5 ' + colorClass + ' ' + cls + '" ' + 'data-row-index="' + rowIndex + '" data-reaction="' + rt.key + '" aria-label="' + rt.key + '">' + this.getIcon(rt.icon, 'w-5 h-5', info.reacted) + countSpan + '</button>';
    }).join('');
    
    // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    let highlightBtnHtml = '';
    if (this.state.showHighlightToggle) {
      const cls = data.highlight ? 'liked' : '';
      const highlightAriaLabel = data.highlight ? 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤ã™ã‚‹' : 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹';
      highlightBtnHtml = '<button type="button" class="highlight-btn like-btn text-purple-600 ' + cls + '" aria-label="' + highlightAriaLabel + '" aria-pressed="' + data.highlight + '" data-row-index="' + data.rowIndex + '">' + this.getIcon('star', 'w-5 h-5', data.highlight) + '</button>';
    }
    
    this.elements.modalReactionContainer.innerHTML = reactionButtonsHtml + highlightBtnHtml;
    
    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ãã‚«ãƒ¼ãƒ‰è‰²ã®é©ç”¨
    debugLog('ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è£…é£¾é©ç”¨:', {
      rowIndex: data.rowIndex,
      highlight: data.highlight,
      reactions: data.reactions,
      element: this.elements.answerModalCard.className
    });
    this.applyReactionStyles(this.elements.answerModalCard, data);
    debugLog('ãƒ¢ãƒ¼ãƒ€ãƒ«è£…é£¾é©ç”¨å¾Œ:', {
      className: this.elements.answerModalCard.className
    });
    
    this.elements.answerModalContainer.classList.remove('hidden');
    this.elements.answerModalContainer.classList.add('modal-fade');
    this.elements.answerModalCard.classList.add('modal-scale');
    
    this.elements.answerModalCloseBtn.focus();
  }
  updateModalContent(data) {
    if (!data) return;
    
    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
    const reactionButtonsHtml = this.reactionTypes.map(rt => {
      const info = data.reactions?.[rt.key] || { count: 0, reacted: false };
      const cls = info.reacted ? 'liked' : '';
      const colorClass = rt.key === 'LIKE' ? 'text-red-500' : rt.key === 'UNDERSTAND' ? 'text-yellow-500' : 'text-green-500';
      const countSpan = this.state.showCounts ? '<span class="reaction-count font-bold text-2xl text-gray-200">' + info.count + '</span>' : '';
      return '<button type="button" class="reaction-btn like-btn flex items-center gap-1.5 ' + colorClass + ' ' + cls + '" ' + 'data-row-index="' + data.rowIndex + '" data-reaction="' + rt.key + '" aria-label="' + rt.key + '">' + this.getIcon(rt.icon, 'w-5 h-5', info.reacted) + countSpan + '</button>';
    }).join('');
    
    // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒœã‚¿ãƒ³ã‚’æ›´æ–°
    let highlightBtnHtml = '';
    if (this.state.showHighlightToggle) {
      const cls = data.highlight ? 'liked' : '';
      const highlightAriaLabel = data.highlight ? 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤ã™ã‚‹' : 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹';
      highlightBtnHtml = '<button type="button" class="highlight-btn like-btn text-purple-600 ' + cls + '" aria-label="' + highlightAriaLabel + '" aria-pressed="' + data.highlight + '" data-row-index="' + data.rowIndex + '">' + this.getIcon('star', 'w-5 h-5', data.highlight) + '</button>';
    }
    
    this.elements.modalReactionContainer.innerHTML = reactionButtonsHtml + highlightBtnHtml;
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
    debugLog('updateModalContentè£…é£¾é©ç”¨:', {
      rowIndex: data.rowIndex,
      highlight: data.highlight,
      reactions: data.reactions
    });
    this.applyReactionStyles(this.elements.answerModalCard, data);
  }
  hideAnswerModal() {
    this.elements.answerModalContainer.classList.add('hidden');
    this.elements.answerModalContainer.classList.remove('modal-fade');
    this.elements.answerModalCard.classList.remove('modal-scale');
    if (this.state.lastFocusedElement) {
      this.state.lastFocusedElement.focus();
    }
  }
  showInfoModal() {
    this.state.lastFocusedElement = document.activeElement;
    this.elements.infoModalContainer.classList.remove('hidden');
    this.elements.infoModalContainer.classList.add('modal-fade');
    this.elements.infoModalCard.classList.add('modal-scale');
    
    // Ensure modal starts from the top
    this.elements.infoModalCard.scrollTop = 0;
    
    // Focus on the modal container first, then the button
    setTimeout(() => {
      this.elements.infoModalConfirmBtn.focus();
    }, 100);
  }
  hideInfoModal() {
    this.elements.infoModalContainer.classList.add('hidden');
    this.elements.infoModalContainer.classList.remove('modal-fade');
    this.elements.infoModalCard.classList.remove('modal-scale');
    
    localStorage.setItem('introSeen', '1');
    if (this.state.lastFocusedElement) {
      this.state.lastFocusedElement.focus();
    }
  }
  getIcon(name, classes = '', solid = false) {
    // Cache icons to avoid repeated string concatenation
    const cacheKey = `icon-${name}-${classes}-${solid}`;
    const cachedIcon = this.cache.get(cacheKey);
    if (cachedIcon) {
      return cachedIcon;
    }
    
    let key = name;
    if (ICONS[name + '-outline'] || ICONS[name + '-solid']) {
      key = solid ? name + '-solid' : name + '-outline';
    }
    const icon = ICONS[key];
    if (!icon) {
      console.warn('Icon not found:', key);
      const fallback = '<span aria-hidden="true" class="' + classes + '">â­</span>';
      this.cache.set(cacheKey, fallback);
      return fallback;
    }
    const result = '<span aria-hidden="true" class="' + classes + '">' + icon + '</span>';
    this.cache.set(cacheKey, result);
    return result;
  }
  renderIcons() {
    if (this.elements.infoIconLike) {
      this.elements.infoIconLike.innerHTML = this.getIcon('hand-thumb-up');
    }
    if (this.elements.infoIconUnderstand) {
      this.elements.infoIconUnderstand.innerHTML = this.getIcon('lightbulb');
    }
    if (this.elements.infoIconCurious) {
      this.elements.infoIconCurious.innerHTML = this.getIcon('magnifying-glass-plus');
    }
    if (this.elements.infoIconHighlight) {
      this.elements.infoIconHighlight.innerHTML = this.getIcon('star');
    }
    if (this.elements.iconClose) {
      this.elements.iconClose.innerHTML = this.getIcon('x');
    }
    if (this.elements.iconGrid) {
      this.elements.iconGrid.innerHTML = this.getIcon('grid-2x2');
    }
  }
  debounce(func, delay) {
    // Use SharedUtilities with instance-specific keys
    const key = `studyquest-${this.instanceId || 'default'}-${Math.random().toString(36).substr(2, 9)}`;
    return (...args) => {
      window.sharedUtilities.debounce.debounce(() => func.apply(this, args), key, delay);
    };
  }
  
  throttle(func, delay) {
    // Use SharedUtilities with instance-specific keys
    const key = `studyquest-throttle-${this.instanceId || 'default'}-${Math.random().toString(36).substr(2, 9)}`;
    return (...args) => {
      window.sharedUtilities.throttle.throttle(() => func.apply(this, args), key, delay);
    };
  }
  updateSortOptions() {
    if (this.elements.scoreOption) {
      if (this.state.showScoreSort) {
        this.elements.scoreOption.style.display = 'block';
      } else {
        this.elements.scoreOption.style.display = 'none';
        if (this.elements.sortOrder.value === 'score') {
          this.elements.sortOrder.value = 'newest';
        }
      }
    }
  }
  updateConfigFromGlobals() {
    debugLog('updateConfigFromGlobalså‰ã®çŠ¶æ…‹:', {
      isAdminUser: this.state.isAdminUser,
      showHighlightToggle: this.state.showHighlightToggle,
      windowShowHighlightToggle: window.showHighlightToggle,
      showAdminFeatures: this.state.showAdminFeatures,
      windowShowAdminFeatures: window.showAdminFeatures,
      currentDisplayMode: this.state.displayMode
    });
    
    this.state.isStudentMode = window.isStudentMode;
    this.state.showCounts = window.showCounts;
    window.showScoreSort = window.showCounts;
    this.state.showAdminFeatures = window.showAdminFeatures;
    this.state.showHighlightToggle = this.state.isAdminUser; // ç®¡ç†è€…ãªã‚‰å¸¸ã«è¡¨ç¤º
    this.state.showScoreSort = window.showScoreSort;
    this.state.showPublishControls = window.showPublishControls;
    
    // Only update displayMode if not in admin mode
    if (!this.state.showAdminFeatures) {
      this.state.displayMode = window.displayMode;
    }
    
    debugLog('updateConfigFromGlobalså¾Œã®çŠ¶æ…‹:', {
      isAdminUser: this.state.isAdminUser,
      showHighlightToggle: this.state.showHighlightToggle,
      windowShowHighlightToggle: window.showHighlightToggle,
      showAdminFeatures: this.state.showAdminFeatures,
      windowShowAdminFeatures: window.showAdminFeatures,
      finalDisplayMode: this.state.displayMode,
      windowDisplayMode: window.displayMode
    });
  }
  escapeHtml(str) {
    if (!str) return '';
    return str.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }

  // Performance optimization methods
  detectLowPerformanceDevice() {
    const userAgent = navigator.userAgent;
    const platform = navigator.platform;
    const memory = navigator.deviceMemory || 4; // Default to 4GB if not available
    const cores = navigator.hardwareConcurrency || 4;
    
    // Detect low-end devices
    if (memory <= 2 || cores <= 2) return true;
    if (userAgent.includes('Mobile') && !userAgent.includes('iPad')) return true;
    if (platform.includes('Win32') && cores <= 4) return true;
    
    return false;
  }

  setupPerformanceMonitoring() {
    let frameCount = 0;
    let lastTime = performance.now();
    
    const measurePerformance = () => {
      const now = performance.now();
      const delta = now - lastTime;
      
      if (frameCount > 0) {
        this.performanceMetrics.frameTime = delta;
        
        // If frame time is consistently over 16ms, enable low performance mode
        if (delta > PERFORMANCE_BUDGET && !this.isLowPerformanceMode) {
          console.warn('Low performance detected, enabling optimizations');
          this.isLowPerformanceMode = true;
          this.optimizeForLowPerformance();
        }
      }
      
      lastTime = now;
      frameCount++;
      
      if (frameCount < 60) { // Monitor first 60 frames
        requestAnimationFrame(measurePerformance);
      }
    };
    
    requestAnimationFrame(measurePerformance);
  }

  optimizeForLowPerformance() {
    debugLog('Enabling low performance optimizations');
    
    // Reduce animation and transition durations
    document.documentElement.style.setProperty('--transition-duration', '0.1s');
    document.documentElement.style.setProperty('--animation-duration', '0.1s');
    document.documentElement.style.setProperty('--backdrop-blur', '4px');
    
    // Create comprehensive low-performance stylesheet
    const style = document.createElement('style');
    style.id = 'low-performance-optimizations';
    style.textContent = `
      /* Disable expensive visual effects */
      .glass-panel {
        -webkit-backdrop-filter: blur(4px) !important;
        backdrop-filter: blur(4px) !important;
        background: var(--color-surface) !important;
      }
      
      /* Simplify hover effects */
      .answer-card:hover {
        transform: none !important;
        box-shadow: var(--shadow-sm) !important;
      }
      
      .reaction-btn:hover {
        transform: scale(1.02) !important;
      }
      
      .game-btn:hover {
        transform: translateY(-1px) !important;
      }
      
      /* Disable complex animations */
      .answer-card.highlighted {
        transform: none !important;
        border: 3px solid #9333ea !important;
        border-image: none !important;
        box-shadow: 0 0 12px rgba(147, 51, 234, 0.5) !important;
      }
      
      /* Remove will-change to reduce GPU usage */
      * {
        will-change: auto !important;
      }
      
      /* Simplify shadows */
      .answer-card {
        box-shadow: var(--shadow-sm) !important;
      }
      
    `;
    document.head.appendChild(style);
    
    // Add low-performance class to body for CSS targeting
    document.body.classList.add('low-performance');
    
    // Reduce polling frequency
    if (this.pollingInterval) {
      clearInterval(this.pollingInterval);
      this.pollingInterval = setInterval(() => this.loadSheetData(false), 30000); // 30s instead of 15s
    }
  }

  setupObservers() {
    // Intersection Observer for virtual scrolling
    if ('IntersectionObserver' in window) {
      this.visibilityObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const card = entry.target;
          const rect = card.getBoundingClientRect();
          const isPartiallyVisible = rect.top < window.innerHeight && rect.bottom > 0;
          
          if (entry.isIntersecting) {
            card.classList.add('visible');
            card.classList.remove('hidden-card');
          } else if (!isPartiallyVisible) {
            // Only mark as hidden if the card is completely outside the viewport
            card.classList.remove('visible');
            card.classList.add('hidden-card');
          }
          // If partially visible but not intersecting, keep it accessible
        });
      }, {
        rootMargin: `${VIEWPORT_BUFFER}px`,
        threshold: [0, 0.1, 0.5, 1.0] // Multiple thresholds for better visibility detection
      });
    }

    // ResizeObserver for responsive adjustments
    if ('ResizeObserver' in window) {
      this.resizeObserver = new ResizeObserver(this.debounce(() => {
        this.adjustLayout();
      }, 100));
      this.resizeObserver.observe(this.elements.answersContainer);
    }
  }

  deferredRender(callback, priority = 'normal') {
    if (this.isLowPerformanceMode) {
      // Use requestIdleCallback for low priority updates
      this.idleCallbackId = requestIdleCallback(callback, { timeout: IDLE_TIMEOUT });
    } else {
      // Use requestAnimationFrame for normal updates
      this.animationFrameId = requestAnimationFrame(callback);
    }
  }

  batchDOMUpdates(updates) {
    const startTime = performance.now();
    let processedCount = 0;
    
    const processBatch = () => {
      while (processedCount < updates.length && (performance.now() - startTime) < PERFORMANCE_BUDGET) {
        updates[processedCount]();
        processedCount++;
      }
      
      if (processedCount < updates.length) {
        // Continue in next frame
        requestAnimationFrame(processBatch);
      }
    };
    
    processBatch();
  }

  getReusableFragment() {
    if (this.domFragmentPool.length > 0) {
      return this.domFragmentPool.pop();
    }
    return document.createDocumentFragment();
  }

  recycleFragment(fragment) {
    // Clear fragment content and reuse
    while (fragment.firstChild) {
      fragment.removeChild(fragment.firstChild);
    }
    if (this.domFragmentPool.length < 10) { // Limit pool size
      this.domFragmentPool.push(fragment);
    }
  }

  throttledUpdate(key, callback, delay = 100) {
    if (this.deferredUpdates.has(key)) {
      return;
    }
    
    this.deferredUpdates.add(key);
    setTimeout(() => {
      callback();
      this.deferredUpdates.delete(key);
    }, delay);
  }

  cleanup() {
    // Consolidated cache cleanup
    this.cache.cleanup();

    // Clear DOM fragment pool
    this.domFragmentPool.length = 0;

    debugLog('Cache cleanup completed', {
      cacheSize: this.cache.size
    });
  }
  
  // Enhanced cache methods with timestamp tracking
}
// ===== å…±é€šãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±å‡¦ç†é–¢æ•° =====
// AdminPanel.html ã¨ Registration.html ã§å…±é€šä½¿ç”¨

/**
 * ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹å…±é€šé–¢æ•°
 * @param {Function} onSuccess - æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @param {Function} onError - ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 */
function loadDomainInfo(onSuccess, onError) {
  google.script.run
    .withSuccessHandler(info => {
      displayDomainInfo(info);
      if (onSuccess) onSuccess(info);
    })
    .withFailureHandler(error => {
      console.error('ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      displayDomainInfo({ error: error.message || error });
      if (onError) onError(error);
    })
    .getDeployUserDomainInfo();
}

/**
 * ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹å…±é€šé–¢æ•°
 * @param {Object} info - ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function displayDomainInfo(info) {
  const headerDomainMatch = document.getElementById('header-domain-match');
  const headerDomainMismatch = document.getElementById('header-domain-mismatch');
  const headerDomainInitial = document.getElementById('header-domain-initial');
  const headerDomainMatchText = document.getElementById('header-domain-match-text');
  const headerDomainMismatchText = document.getElementById('header-domain-mismatch-text');

  // å…¨ã¦ã®è¡¨ç¤ºã‚’ä¸€æ—¦éè¡¨ç¤ºã«ã™ã‚‹
  if (headerDomainMatch) headerDomainMatch.classList.add('hidden');
  if (headerDomainMismatch) headerDomainMismatch.classList.add('hidden');
  if (headerDomainInitial) headerDomainInitial.classList.add('hidden');
  
  if (!info || info.error) {
    console.warn('ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚¨ãƒ©ãƒ¼:', info?.error);
    if (headerDomainInitial) headerDomainInitial.classList.remove('hidden');
    return;
  }

  if (info.isDomainMatch) {
    // ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒä¸€è‡´ã—ã¦ã„ã‚‹å ´åˆ
    if (headerDomainMatch && headerDomainMatchText) {
      headerDomainMatch.classList.remove('hidden');
      if (info.deployDomain) {
        headerDomainMatchText.textContent = `${info.deployDomain} ãƒ‰ãƒ¡ã‚¤ãƒ³`;
      } else {
        headerDomainMatchText.textContent = 'ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹';
      }
    }
  } else {
    // ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸ä¸€è‡´ã®å ´åˆ
    if (headerDomainMismatch && headerDomainMismatchText) {
      headerDomainMismatch.classList.remove('hidden');
      headerDomainMismatchText.textContent = info.currentDomain;
    }
  }
}

/**
 * ãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
 */
function loadFormLink() {
  google.script.run
    .withSuccessHandler(formInfo => {
      if (formInfo && formInfo.formUrl) {
        const formLinkBtn = document.getElementById('form-link-btn');
        if (formLinkBtn) {
          formLinkBtn.href = formInfo.formUrl;
          formLinkBtn.classList.remove('hidden');
        }
      }
    })
    .withFailureHandler(error => {
      console.warn('ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
    })
    .getActiveFormInfo(USER_ID);
}

try {
  if (window.studyQuestApp && typeof window.studyQuestApp.destroy === 'function') {
    window.studyQuestApp.destroy();
  }
  // ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼è¡¨ç¤º
  showSystemFlow();
  
  window.studyQuestApp = new StudyQuestApp();
  
  // Expose debug functions globally for console access
  window.debugAnswerCards = () => {
    if (window.studyQuestApp && window.studyQuestApp.debugAnswerCards) {
      window.studyQuestApp.debugAnswerCards();
    } else {
      console.log('StudyQuestApp not available or debug function not found');
    }
  };
  
  // Enhanced global debug function with additional utility methods
  window.debugClickAnswerCard = (cardIndex = 0, options = {}) => {
    if (window.studyQuestApp && window.studyQuestApp.debugClickAnswerCard) {
      return window.studyQuestApp.debugClickAnswerCard(cardIndex, options);
    } else {
      console.log('StudyQuestApp not available or debug function not found');
      return { success: false, error: 'StudyQuestApp not available' };
    }
  };

  // ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼è¡¨ç¤ºã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
  window.showSystemFlow = showSystemFlow;
  
  // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèªæ©Ÿèƒ½
  window.debugCurrentData = () => {
    if (window.studyQuestApp && window.studyQuestApp.state) {
      console.log('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ :', {
        currentAnswers: window.studyQuestApp.state.currentAnswers,
        currentAnswersLength: window.studyQuestApp.state.currentAnswers?.length,
        firstItem: window.studyQuestApp.state.currentAnswers?.[0],
        header: window.studyQuestApp.elements?.headingLabel?.textContent
      });
    } else {
      console.log('StudyQuestApp not available');
    }
  };

  // Additional global debug utilities
  window.debugClickAllAnswerCards = async (options = {}) => {
    if (!window.studyQuestApp) {
      console.log('StudyQuestApp not available');
      return { success: false, error: 'StudyQuestApp not available' };
    }
    
    const container = window.studyQuestApp.elements?.answersContainer;
    if (!container) {
      console.log('No answers container found');
      return { success: false, error: 'No answers container found' };
    }
    
    const answerCards = container.querySelectorAll('.answer-card');
    const results = [];
    
    console.log(`Found ${answerCards.length} answer cards, clicking all...`);
    
    for (let i = 0; i < answerCards.length; i++) {
      try {
        const result = await window.studyQuestApp.debugClickAnswerCard(i, { 
          ...options, 
          logDetails: false // Reduce noise when clicking all cards
        });
        results.push(result);
        
        if (options.delay && i < answerCards.length - 1) {
          // Add proper delay between clicks if specified
          await new Promise(resolve => setTimeout(resolve, options.delay));
        }
      } catch (error) {
        console.error(`Error clicking card ${i}:`, error);
        results.push({ success: false, error: error.message, cardIndex: i });
      }
    }
    
    return {
      success: true,
      totalCards: answerCards.length,
      results
    };
  };

  window.debugGetAnswerCardInfo = (cardIndex = 0) => {
    if (!window.studyQuestApp) {
      console.log('StudyQuestApp not available');
      return { success: false, error: 'StudyQuestApp not available' };
    }
    
    // Validate cardIndex
    if (typeof cardIndex !== 'number' || cardIndex < 0 || !Number.isInteger(cardIndex)) {
      console.log('Invalid card index:', cardIndex);
      return { success: false, error: 'Invalid card index. Must be a non-negative integer.' };
    }
    
    const container = window.studyQuestApp.elements?.answersContainer;
    if (!container) {
      console.log('No answers container found');
      return { success: false, error: 'No answers container found' };
    }
    
    const answerCards = container.querySelectorAll('.answer-card');
    if (answerCards.length === 0) {
      console.log('No answer cards found');
      return { success: false, error: 'No answer cards found' };
    }
    
    if (cardIndex >= answerCards.length) {
      console.log('Card index out of bounds');
      return { success: false, error: 'Card index out of bounds', totalCards: answerCards.length };
    }
    
    const card = answerCards[cardIndex];
    
    try {
      const cardInfo = {
        index: cardIndex,
        className: card.className,
        dataset: { ...card.dataset },
        rowIndex: card.dataset.rowIndex,
        boundingRect: card.getBoundingClientRect(),
        computedStyle: {
          display: getComputedStyle(card).display,
          visibility: getComputedStyle(card).visibility,
          opacity: getComputedStyle(card).opacity
        },
        textContent: card.textContent?.trim() || '',
        innerHTML: card.innerHTML
      };
      
      console.log('Answer card info:', cardInfo);
      return { success: true, cardInfo };
    } catch (error) {
      console.error('Error getting card info:', error);
      return { success: false, error: `Error getting card info: ${error.message}` };
    }
  };
  
  // ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã¨ãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯ã‚’å–å¾—
  loadDomainInfo();
  loadFormLink();
  
  window.addEventListener('beforeunload', () => {
    if (window.studyQuestApp && typeof window.studyQuestApp.destroy === 'function') {
      window.studyQuestApp.destroy();
    }
  });
} catch (error) {
  console.error('Error creating StudyQuestApp instance:', error);
  const container = document.getElementById('answers');
  if (container) {
    const msg = StudyQuestApp.prototype.escapeHtml(error.message || '');
    container.innerHTML = '<div class="text-red-400 p-4">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + msg + '</div>';
  }
}
</script>
</body>
</html>
