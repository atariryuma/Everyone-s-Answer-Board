<script>
// Unified Admin Panel Namespace and Management Classes
// Generated to address function interference issues and centralize state, events,
// asynchronous operations, and DOM handling.

window.AdminPanel = window.AdminPanel || {
  errors: {},
  ui: {},
  state: {
    current: null,
    selectedSheet: '',
    updateStatus(status) {
      this.current = status;
    }
  }
};

// -----------------------------------------------------------------------------
// State Manager
// -----------------------------------------------------------------------------
class AdminPanelStateManager {
  constructor() {
    this.state = {
      currentStatus: null,
      selectedSheet: '',
      isLoading: false
    };
    this.subscribers = new Map();
  }

  setState(key, value) {
    this.state[key] = value;
    this.notifySubscribers(key, value);
  }

  subscribe(key, callback) {
    if (!this.subscribers.has(key)) {
      this.subscribers.set(key, []);
    }
    this.subscribers.get(key).push(callback);
  }

  notifySubscribers(key, value) {
    const subs = this.subscribers.get(key) || [];
    subs.forEach(cb => {
      try {
        cb(value);
      } catch (e) {
        console.warn('Subscriber callback failed', e);
      }
    });
  }
}

// -----------------------------------------------------------------------------
// Event Manager
// -----------------------------------------------------------------------------
class AdminPanelEventManager {
  constructor() {
    this.listeners = new Map();
  }

  addListener(element, event, handler, options = {}) {
    if (!element || !event || !handler) return;
    const key = `${element.id || 'anonymous'}-${event}`;
    if (this.listeners.has(key)) {
      console.warn(`Duplicate listener for ${key}`);
      return;
    }
    element.addEventListener(event, handler, options);
    this.listeners.set(key, { element, event, handler, options });
  }
}

// -----------------------------------------------------------------------------
// Async Manager
// -----------------------------------------------------------------------------
class AdminPanelAsyncManager {
  constructor() {
    this.runningOperations = new Map();
  }

  async executeExclusive(operationId, operation) {
    if (this.runningOperations.has(operationId)) {
      return this.runningOperations.get(operationId);
    }
    const promise = Promise.resolve().then(operation);
    this.runningOperations.set(operationId, promise);
    try {
      return await promise;
    } finally {
      this.runningOperations.delete(operationId);
    }
  }
}

// -----------------------------------------------------------------------------
// DOM Manager
// -----------------------------------------------------------------------------
class AdminPanelDOMManager {
  constructor() {
    this.elementCache = new Map();
    this.operationQueue = [];
  }

  getElement(id) {
    if (!this.elementCache.has(id)) {
      this.elementCache.set(id, document.getElementById(id));
    }
    return this.elementCache.get(id);
  }

  queueOperation(operation) {
    this.operationQueue.push(operation);
    return new Promise(resolve => {
      requestAnimationFrame(() => {
        const op = this.operationQueue.shift();
        resolve(op());
      });
    });
  }
}

// Instantiate managers and expose via namespace
window.AdminPanel.stateManager = new AdminPanelStateManager();
window.AdminPanel.eventManager = new AdminPanelEventManager();
window.AdminPanel.asyncManager = new AdminPanelAsyncManager();
window.AdminPanel.domManager = new AdminPanelDOMManager();

// Link legacy globals to state manager for compatibility
Object.defineProperties(window, {
  currentStatus: {
    get() { return window.AdminPanel.stateManager.state.currentStatus; },
    set(v) { window.AdminPanel.stateManager.setState('currentStatus', v); }
  },
  selectedSheet: {
    get() { return window.AdminPanel.stateManager.state.selectedSheet; },
    set(v) { window.AdminPanel.stateManager.setState('selectedSheet', v); }
  }
});

// =============================================================================
// INITIALIZATION FUNCTIONS - Moved from various adminPanel files
// =============================================================================

// Simple logging utility with conditional output based on DEBUG mode
// DEBUG_MODE is defined in constants.js.html

function adminLog(level, ...args) {
  if (!(window.DEBUG_MODE || window.SYSTEM_CONSTANTS?.DEBUG_MODE)) return;
  
  switch (level) {
    case 'error':
      console.error('[AdminPanel]', ...args);
      break;
    case 'warn':
      console.warn('[AdminPanel]', ...args);
      break;
    case 'info':
      console.log('[AdminPanel]', ...args);
      break;
    case 'debug':
      if (window.DEBUG_MODE || window.SYSTEM_CONSTANTS?.DEBUG_MODE) console.log('[AdminPanel:DEBUG]', ...args);
      break;
    default:
      console.log('[AdminPanel]', ...args);
  }
}

// Convenience functions for different log levels
function logError(...args) { adminLog('error', ...args); }
function logWarn(...args) { adminLog('warn', ...args); }
function logInfo(...args) { adminLog('info', ...args); }
function logDebug(...args) { adminLog('debug', ...args); }

// =============================================================================
// USER AUTHENTICATION INITIALIZATION
// =============================================================================

// マルチテナント対応: ユーザーIDの安全な初期化
var userId = '';

// マルチテナント対応: バックエンドから安全にユーザーIDを取得
function initializeUserId() {
  console.group('🔐 Initializing UserId');
  logDebug('📞 About to call getCurrentUserStatus');
  
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(response => {
        logDebug('📥 getCurrentUserStatus response:', response);
        
        if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
          userId = response.userInfo.userId;
          logDebug('✅ AdminPanel: User authenticated, userId:', userId);
          console.groupEnd();
          resolve(userId);
        } else {
          console.error('❌ Failed to get userId from backend:', response);
          console.error('❌ Expected: {status: "success", userInfo: {userId: "..."}}');
          console.groupEnd();
          reject(new Error('ユーザーIDの取得に失敗しました'));
        }
      })
      .withFailureHandler(error => {
        console.error('❌ Backend error getting userId:', error);
        console.error('❌ Error type:', typeof error);
        console.error('❌ Error details:', error);
        console.groupEnd();
        reject(error);
      })
      .getCurrentUserStatus();
  });
}

// ユーザーID取得の完了を待つPromise
const userIdPromise = initializeUserId();

// =============================================================================
// CORE INITIALIZATION FUNCTIONS
// =============================================================================

// Layout adjustment for responsive design
function adjustLayout() {
  var isMobile = window.innerWidth < 768;
  var body = document.body;
  
  if (isMobile) {
    body.classList.add('mobile-layout');
    body.classList.remove('desktop-layout');
  } else {
    body.classList.add('desktop-layout');
    body.classList.remove('mobile-layout');
  }
}

// Initialize core functionality
function initCore() {
  adjustLayout();
}

// Initialize message area
function initializeMessageArea() {
  var messageArea = document.getElementById('message-area');
  if (!messageArea) {
    // Create message area if it doesn't exist
    messageArea = document.createElement('div');
    messageArea.id = 'message-area';
    messageArea.className = 'fixed top-32 right-4 z-50 max-w-sm';
    document.body.appendChild(messageArea);
  }
}

// Initialize UI components
function initializeUI() {
  console.log('✅ AdminPanel: UI components ready');
  // UI初期化のみ実行、loadStatusは adminPanel-api.js で処理される
}

// Initialize API functionality
function initializeAPI() {
  logDebug('🔧 API初期化開始');
  
  // Start background status updates
  if (typeof startSystemStatusUpdate === 'function') {
    startSystemStatusUpdate();
  }
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);

  // 初回ロード時にシステムステータスをロード
  logDebug('🚀 loadStatus()を呼び出します');
  if (typeof loadStatus === 'function') {
    loadStatus();
  }
  
  logDebug('✅ API初期化完了');
}

// Update user activity timestamp for polling optimization
function updateUserActivity() {
  if (typeof lastUserActivity !== 'undefined') {
    lastUserActivity = Date.now();
  }
}

// Initialize event listeners
function initializeEventListeners() {
  // Check if essential functions are available, but continue even if some are missing
  const requiredFunctions = ['handleQuickStart', 'showFormConfigModal', 'toggleSection'];
  const missingFunctions = requiredFunctions.filter(func => typeof window[func] !== 'function');

  if (missingFunctions.length > 0) {
    console.warn('⚠️ AdminPanel: Missing functions during event initialization:', missingFunctions);
  }

  console.log('✅ AdminPanel: Setting up event listeners');
  if (typeof setupEventListeners === 'function') {
    setupEventListeners();
  }
}

// Setup character counters
function setupCharacterCounters() {
  const questionTextarea = document.getElementById('custom-main-question');
  const questionCounter = document.getElementById('question-counter');

  if (questionTextarea && questionCounter) {
    questionTextarea.addEventListener('input', function() {
      const count = this.value.length;
      questionCounter.textContent = `${count}/500`;
      questionCounter.className = count > 450 ? 'text-xs text-red-400' : 'text-xs text-gray-500';
    });
  }
}

// Setup modal character counter observers
function setupModalCharacterCounters() {
  // モーダルが表示されるたびにカウンターをセットアップ
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const modal = document.getElementById('form-config-modal');
        if (modal && !modal.classList.contains('hidden')) {
          setTimeout(setupCharacterCounters, 100);
        }
      }
    });
  });
  
  // モーダルの監視を開始
  const modal = document.getElementById('form-config-modal');
  if (modal) {
    observer.observe(modal, { attributes: true });
  }
}

// Navigate to specific step in admin panel
function navigateToStep(step) {
  if (typeof currentStep !== 'undefined') {
    currentStep = step;
  } else {
    // Define currentStep if not already defined
    window.currentStep = step;
  }
  
  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
    const stepNumber = index + 1;
    indicator.classList.toggle('completed', stepNumber < step);
    indicator.classList.toggle('active', stepNumber === step);
  });
  
  // Show/hide step content
  document.querySelectorAll('.step-content').forEach((content, index) => {
    const stepNumber = index + 1;
    content.classList.toggle('hidden', stepNumber !== step);
  });
  
  // Update progress bar
  const progressBar = document.querySelector('.progress-bar');
  if (progressBar) {
    progressBar.style.width = `${(step / 3) * 100}%`;
  }
  
  if (typeof validateCurrentStep === 'function') {
    validateCurrentStep();
  }
}

// Make navigateToStep globally available
window.navigateToStep = navigateToStep;

// Initialize main admin panel
function initializeAdminPanel(incomingUserId) {
  // userId is now managed globally by adminPanel-core.js
  if (typeof loadUserInfo === 'function') loadUserInfo();
  if (typeof loadSystemStatus === 'function') loadSystemStatus();
  if (typeof setupEventListeners === 'function') setupEventListeners();
  if (typeof setupRealtimeUpdates === 'function') setupRealtimeUpdates();
  if (typeof validateCurrentStep === 'function') validateCurrentStep();
}

// Make initializeAdminPanel globally available
window.initializeAdminPanel = initializeAdminPanel;

// =============================================================================
// SYSTEM STATUS AND USER INTERACTION MANAGEMENT
// =============================================================================

// システム監視用の状態管理
window.systemStatus = {
  initializationStarted: false,
  coreInitialized: false,
  apiInitialized: false,
  uiInitialized: false,
  eventsInitialized: false,
  initializationComplete: false,
  userDataSyncComplete: false,
  errors: [],
  lastActivity: Date.now()
};

// 初期化中のユーザー操作防止 - DOM準備完了後に実行
if (document.body) {
  document.body.style.pointerEvents = 'none';
  console.log('🛡️ User interaction disabled during initialization');
} else {
  // DOM読み込み完了を待ってから実行
  document.addEventListener('DOMContentLoaded', function() {
    if (document.body) {
      document.body.style.pointerEvents = 'none';
      console.log('🛡️ User interaction disabled during initialization (delayed)');
    }
  });
}

// 主要なUI要素を無効化する関数
function disableUserInteraction() {
  // DOM準備完了チェック
  if (!document || !document.body) {
    console.warn('⚠️ DOM not ready for disableUserInteraction');
    return;
  }
  
  // フォーム要素の無効化
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(element => {
    element.disabled = true;
    element.style.opacity = '0.6';
  });
  
  // クリック可能な要素の無効化
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(element => {
    element.style.pointerEvents = 'none';
    element.style.opacity = '0.6';
  });
  
  // body要素の無効化
  document.body.style.pointerEvents = 'none';
  
  console.log('🛡️ All interactive elements disabled');
}

// UI要素を有効化する関数
function enableUserInteraction() {
  // DOM準備完了チェック
  if (!document || !document.body) {
    console.warn('⚠️ DOM not ready for enableUserInteraction');
    return;
  }
  
  // フォーム要素の有効化
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(element => {
    element.disabled = false;
    element.style.opacity = '';
  });
  
  // クリック可能な要素の有効化
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(element => {
    element.style.pointerEvents = '';
    element.style.opacity = '';
  });
  
  // body要素も有効化
  document.body.style.pointerEvents = 'auto';
  
  console.log('✅ All interactive elements enabled');
}

// DOM読み込み後に要素を無効化
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', disableUserInteraction);
} else {
  disableUserInteraction();
}

function updateSystemStatus(component, status, error = null) {
  window.systemStatus[component] = status;
  window.systemStatus.lastActivity = Date.now();
  if (error) {
    window.systemStatus.errors.push({ component, error: error.toString(), timestamp: Date.now() });
  }
  logDebug(`📊 System Status: ${component} = ${status}`);
}

// 公開停止後の全セクション展開処理
function checkAndExpandAllSections() {
  try {
    const expandAllFlag = localStorage.getItem('expandAllSections');
    if (expandAllFlag === 'true') {
      logInfo('📂 公開停止後のため全セクションを展開します');
      
      // 少し遅延してからセクションを展開（DOM要素の準備を待つ）
      setTimeout(() => {
        const sectionIds = ['step1-content', 'step2-content', 'step3-content'];
        let expandedCount = 0;
        
        sectionIds.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            // セクションが折りたたまれている場合のみ展開
            if (section.classList.contains('hidden')) {
              if (typeof toggleSection === 'function') {
                toggleSection(sectionId);
                expandedCount++;
                logDebug(`✅ セクション展開: ${sectionId}`);
              }
            }
          }
        });
        
        if (expandedCount > 0) {
          logInfo(`📂 ${expandedCount}個のセクションを展開しました`);
        }
        
        // フラグをクリア（一度だけ実行）
        localStorage.removeItem('expandAllSections');
        logDebug('🧹 全セクション展開フラグをクリアしました');
      }, 500);
    }
  } catch (error) {
    logWarn('⚠️ 全セクション展開処理でエラー:', error);
  }
}

// =============================================================================
// MASTER INITIALIZATION SYSTEM
// =============================================================================

function initializeAdminPanelMaster() {
  logInfo('🚀 AdminPanel Master Initialization Started');
  updateSystemStatus('initializationStarted', true);
  
  // Phase 1: Core初期化
  try {
    initCore();
    updateSystemStatus('coreInitialized', true);
  } catch (error) {
    updateSystemStatus('coreInitialized', false, error);
    console.error('❌ Core initialization failed:', error);
  }
  
  // 公開停止後の全セクション展開処理
  checkAndExpandAllSections();
  
  // フォーム作成完了表示をクリア（新規アクセス時はデフォルトで非表示）
  setTimeout(() => {
    const formJustCreated = sessionStorage.getItem('form_just_created');
    if (formJustCreated !== 'true') {
      // 新規作成ではない場合、セクションを非表示にする
      const formUrlSection = document.getElementById('form-url-section');
      if (formUrlSection && !formUrlSection.classList.contains('hidden')) {
        formUrlSection.classList.add('hidden');
        logDebug('📋 既存アクセス時はフォーム完了セクションを非表示');
      }
    }
  }, 100);
  
  // Phase 2: 各モジュールを並列初期化 (パフォーマンス向上)
  // 遅延を最小限に抑制して即座に初期化
  setTimeout(() => {
    logDebug('🔧 Phase 2: 並列モジュール初期化開始');
    
    // Status管理初期化
    try {
      initializeMessageArea();
      logDebug('✅ Status module initialized');
    } catch (error) {
      logError('❌ Status module initialization failed:', error);
    }
    
    // API通信初期化（最重要 - getInitialDataを呼び出す）
    function initializeAPIWithRetry(attempts = 0) {
      try {
        logDebug('🚀 API module initialization starting...');
        initializeAPI();
        updateSystemStatus('apiInitialized', true);
        logDebug('✅ API module initialized');
        return;
      } catch (error) {
        updateSystemStatus('apiInitialized', false, error);
        console.error('❌ API initialization failed:', error);
      }
      
      if (attempts < 5) {
        logDebug(`⏳ API関数読み込み待機中... (試行 ${attempts + 1}/5)`);
        setTimeout(() => initializeAPIWithRetry(attempts + 1), 200);
        return;
      }
      
      // フォールバック実装
      console.warn('⚠️ API functions not available, implementing fallback...');
      updateSystemStatus('apiInitialized', 'fallback');
      logDebug('✅ API module initialized with fallback');
    }
    
    initializeAPIWithRetry();
    
    // UI初期化
    try {
      initializeUI();
      updateSystemStatus('uiInitialized', true);
      logDebug('✅ UI module initialized');
    } catch (error) {
      updateSystemStatus('uiInitialized', false, error);
      console.error('❌ UI initialization failed:', error);
    }
    
    // フォーム管理初期化
    try {
      setupCharacterCounters();
      setupModalCharacterCounters();
      logDebug('✅ Forms module initialized');
    } catch (error) {
      logError('❌ Forms module initialization failed:', error);
    }
    
    // イベント管理初期化（最後に実行）
    setTimeout(() => {
      function initializeEventsWithRetry(attempts = 0) {
        try {
          initializeEventListeners();
          updateSystemStatus('eventsInitialized', true);
          updateSystemStatus('initializationComplete', true);
          logDebug('✅ Events module initialized');
          logInfo('🎉 AdminPanel Master Initialization Complete');
          
          // システム状態の最終レポート
          console.log('📊 Final System Status:', window.systemStatus);
          
          // ユーザー情報の確実な同期完了後にローディング解除
          setTimeout(async () => {
            try {
              console.log('🔄 Final user data synchronization...');
              
              // ユーザーデータの最終同期を確実に実行
              if (typeof loadStatus === 'function') {
                await loadStatus(true);
                console.log('✅ User data synchronization completed');
              } else {
                console.warn('⚠️ loadStatus function not available');
              }
              
              // すべての同期が完了したらローディングオーバーレイを非表示
              if (window.unifiedLoading) {
                window.unifiedLoading.hide();
                console.log('✅ Global loading overlay hidden after full sync');
              } else {
                // フォールバック: 直接DOM操作
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                  overlay.classList.add('hidden');
                  console.log('✅ Loading overlay hidden (fallback)');
                }
              }
              
              // UI要素の有効化
              enableUserInteraction();
              updateSystemStatus('userDataSyncComplete', true);
              
            } catch (error) {
              console.error('❌ Final sync error:', error);
              // エラーでもローディングは解除
              if (window.unifiedLoading) {
                window.unifiedLoading.hide();
              }
            }
          }, 800);
          return;
        } catch (error) {
          updateSystemStatus('eventsInitialized', false, error);
          console.error('❌ Events initialization failed:', error);
        }
        
        if (attempts < 5) {
          logDebug(`⏳ イベント関数読み込み待機中... (試行 ${attempts + 1}/5)`);
          setTimeout(() => initializeEventsWithRetry(attempts + 1), 200);
          return;
        }
        
        // フォールバック実装
        console.warn('⚠️ Event functions not available, implementing fallback...');
        updateSystemStatus('eventsInitialized', 'fallback');
        updateSystemStatus('initializationComplete', 'fallback');
        logInfo('⚠️ AdminPanel Master Initialization Complete (with fallback functions)');
        
        // システム状態の最終レポート（フォールバック版）
        console.log('📊 Final System Status (Fallback):', window.systemStatus);
        
        // フォールバック初期化でもローディング解除処理を実行
        setTimeout(async () => {
          try {
            console.log('🔄 Fallback: Final user data synchronization attempt...');
            
            // 可能であればユーザーデータ同期を試行
            if (typeof loadStatus === 'function') {
              try {
                await loadStatus(true);
                console.log('✅ Fallback: User data synchronization completed');
              } catch (syncError) {
                console.warn('⚠️ Fallback: User data sync failed, but continuing:', syncError);
              }
            }
            
            // ローディングオーバーレイを必ず非表示
            if (window.unifiedLoading) {
              window.unifiedLoading.hide();
              console.log('✅ Fallback: Global loading overlay hidden');
            } else {
              const overlay = document.getElementById('loading-overlay');
              if (overlay) {
                overlay.classList.add('hidden');
                console.log('✅ Fallback: Loading overlay hidden (direct DOM)');
              }
            }
            
            // UI要素の有効化
            enableUserInteraction();
            updateSystemStatus('userDataSyncComplete', true);
            console.log('✅ Fallback: User interaction enabled');
            
          } catch (error) {
            console.error('❌ Fallback sync error:', error);
            // エラーでもローディングは解除
            if (window.unifiedLoading) {
              window.unifiedLoading.hide();
            }
            enableUserInteraction();
          }
        }, 600);
      }
      
      initializeEventsWithRetry();
    }, 100);
    
  }, 10);
}

// 単一DOMContentLoadedハンドラー
if (document.readyState !== 'loading') {
  initializeAdminPanelMaster();
} else {
  document.addEventListener('DOMContentLoaded', initializeAdminPanelMaster);
}

// Update layout on resize
window.addEventListener('resize', function() {
  if (typeof debounce === 'function') {
    debounce(adjustLayout, 250, 'layout-resize')();
  } else {
    // Fallback without debounce
    adjustLayout();
  }
});

</script>
