<script>
// Unified Admin Panel Namespace and Management Classes
// Generated to address function interference issues and centralize state, events,
// asynchronous operations, and DOM handling.

window.AdminPanel = window.AdminPanel || {
  errors: {},
  ui: {},
  state: {
    current: null,
    selectedSheet: '',
    updateStatus(status) {
      this.current = status;
    }
  }
};

// -----------------------------------------------------------------------------
// State Manager
// -----------------------------------------------------------------------------
class AdminPanelStateManager {
  constructor() {
    this.state = {
      currentStatus: null,
      selectedSheet: '',
      isLoading: false
    };
    this.subscribers = new Map();
  }

  setState(key, value) {
    this.state[key] = value;
    this.notifySubscribers(key, value);
  }

  subscribe(key, callback) {
    if (!this.subscribers.has(key)) {
      this.subscribers.set(key, []);
    }
    this.subscribers.get(key).push(callback);
  }

  notifySubscribers(key, value) {
    const subs = this.subscribers.get(key) || [];
    subs.forEach(cb => {
      try {
        cb(value);
      } catch (e) {
        console.warn('Subscriber callback failed', e);
      }
    });
  }
}

// -----------------------------------------------------------------------------
// Event Manager
// -----------------------------------------------------------------------------
class AdminPanelEventManager {
  constructor() {
    this.listeners = new Map();
  }

  addListener(element, event, handler, options = {}) {
    if (!element || !event || !handler) return;
    const key = `${element.id || 'anonymous'}-${event}`;
    if (this.listeners.has(key)) {
      console.warn(`Duplicate listener for ${key}`);
      return;
    }
    element.addEventListener(event, handler, options);
    this.listeners.set(key, { element, event, handler, options });
  }
}

// -----------------------------------------------------------------------------
// Async Manager
// -----------------------------------------------------------------------------
class AdminPanelAsyncManager {
  constructor() {
    this.runningOperations = new Map();
  }

  async executeExclusive(operationId, operation) {
    if (this.runningOperations.has(operationId)) {
      return this.runningOperations.get(operationId);
    }
    const promise = Promise.resolve().then(operation);
    this.runningOperations.set(operationId, promise);
    try {
      return await promise;
    } finally {
      this.runningOperations.delete(operationId);
    }
  }
}

// -----------------------------------------------------------------------------
// DOM Manager
// -----------------------------------------------------------------------------
class AdminPanelDOMManager {
  constructor() {
    this.elementCache = new Map();
    this.operationQueue = [];
  }

  getElement(id) {
    if (!this.elementCache.has(id)) {
      this.elementCache.set(id, document.getElementById(id));
    }
    return this.elementCache.get(id);
  }

  queueOperation(operation) {
    this.operationQueue.push(operation);
    return new Promise(resolve => {
      requestAnimationFrame(() => {
        const op = this.operationQueue.shift();
        resolve(op());
      });
    });
  }
}

// Instantiate managers and expose via namespace
window.AdminPanel.stateManager = new AdminPanelStateManager();
window.AdminPanel.eventManager = new AdminPanelEventManager();
window.AdminPanel.asyncManager = new AdminPanelAsyncManager();
window.AdminPanel.domManager = new AdminPanelDOMManager();

// Link legacy globals to state manager for compatibility
Object.defineProperties(window, {
  currentStatus: {
    get() { return window.AdminPanel.stateManager.state.currentStatus; },
    set(v) { window.AdminPanel.stateManager.setState('currentStatus', v); }
  },
  selectedSheet: {
    get() { return window.AdminPanel.stateManager.state.selectedSheet; },
    set(v) { window.AdminPanel.stateManager.setState('selectedSheet', v); }
  }
});

// =============================================================================
// INITIALIZATION FUNCTIONS - Moved from various adminPanel files
// =============================================================================

// Simple logging utility with conditional output based on DEBUG mode
// DEBUG_MODE is defined in constants.js.html

function adminLog(level, ...args) {
  if (!(window.DEBUG_MODE || window.SYSTEM_CONSTANTS?.DEBUG_MODE)) return;
  
  switch (level) {
    case 'error':
      console.error('[AdminPanel]', ...args);
      break;
    case 'warn':
      console.warn('[AdminPanel]', ...args);
      break;
    case 'info':
      console.log('[AdminPanel]', ...args);
      break;
    case 'debug':
      if (window.DEBUG_MODE || window.SYSTEM_CONSTANTS?.DEBUG_MODE) console.log('[AdminPanel:DEBUG]', ...args);
      break;
    default:
      console.log('[AdminPanel]', ...args);
  }
}

// Convenience functions for different log levels
function logError(...args) { adminLog('error', ...args); }
function logWarn(...args) { adminLog('warn', ...args); }
function logInfo(...args) { adminLog('info', ...args); }
function logDebug(...args) { adminLog('debug', ...args); }

// =============================================================================
// USER AUTHENTICATION INITIALIZATION
// =============================================================================

// マルチテナント対応: ユーザーIDの安全な初期化
var userId = '';

// マルチテナント対応: バックエンドから安全にユーザーIDを取得
function initializeUserId() {
  console.group('🔐 Initializing UserId');
  logDebug('📞 About to call getCurrentUserStatus');
  
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(response => {
        logDebug('📥 getCurrentUserStatus response:', response);
        
        if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
          userId = response.userInfo.userId;
          logDebug('✅ AdminPanel: User authenticated, userId:', userId);
          console.groupEnd();
          resolve(userId);
        } else {
          console.error('❌ Failed to get userId from backend:', response);
          console.error('❌ Expected: {status: "success", userInfo: {userId: "..."}}');
          console.groupEnd();
          reject(new Error('ユーザーIDの取得に失敗しました'));
        }
      })
      .withFailureHandler(error => {
        console.error('❌ Backend error getting userId:', error);
        console.error('❌ Error type:', typeof error);
        console.error('❌ Error details:', error);
        console.groupEnd();
        reject(error);
      })
      .getCurrentUserStatus();
  });
}

// ユーザーID取得の完了を待つPromise
const userIdPromise = initializeUserId();

// =============================================================================
// CORE INITIALIZATION FUNCTIONS
// =============================================================================

// Layout adjustment for responsive design
function adjustLayout() {
  var isMobile = window.innerWidth < 768;
  var body = document.body;
  
  if (isMobile) {
    body.classList.add('mobile-layout');
    body.classList.remove('desktop-layout');
  } else {
    body.classList.add('desktop-layout');
    body.classList.remove('mobile-layout');
  }
}

// Initialize core functionality
function initCore() {
  adjustLayout();
}

// Initialize message area
function initializeMessageArea() {
  var messageArea = document.getElementById('message-area');
  if (!messageArea) {
    // Create message area if it doesn't exist
    messageArea = document.createElement('div');
    messageArea.id = 'message-area';
    messageArea.className = 'fixed top-32 right-4 z-50 max-w-sm';
    document.body.appendChild(messageArea);
  }
}

// Initialize UI components
function initializeUI() {
  console.log('✅ AdminPanel: UI components ready');
  // UI初期化のみ実行、loadStatusは adminPanel-api.js で処理される
}

// Initialize API functionality
function initializeAPI() {
  logDebug('🔧 API初期化開始');
  
  // Start background status updates with safe calling
  if (checkFunctionAvailability('startSystemStatusUpdate')) {
    safeCallFunction('startSystemStatusUpdate');
  } else {
    console.warn('⚠️ startSystemStatusUpdate not available - background updates disabled');
  }
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);

  // 初回ロード時にシステムステータスをロード
  logDebug('🚀 loadStatus()を呼び出します');
  if (checkFunctionAvailability('loadStatus')) {
    safeCallFunction('loadStatus');
  } else {
    console.warn('⚠️ loadStatus not available - manual status refresh required');
  }
  
  logDebug('✅ API初期化完了');
}

// Update user activity timestamp for polling optimization
function updateUserActivity() {
  if (typeof lastUserActivity !== 'undefined') {
    lastUserActivity = Date.now();
  }
}

// Initialize event listeners
function initializeEventListeners() {
  console.log('✅ AdminPanel: Setting up event listeners');
  
  // Use safe function calling with availability checks
  if (checkFunctionAvailability('setupEventListeners')) {
    safeCallFunction('setupEventListeners');
  } else {
    console.warn('⚠️ setupEventListeners function not available, attempting graceful degradation');
    
    // Basic fallback event listener setup
    if (checkFunctionAvailability('setupRealtimeValidation')) {
      safeCallFunction('setupRealtimeValidation');
    } else {
      console.warn('⚠️ setupRealtimeValidation not available - real-time validation disabled');
    }
  }
}

// Setup character counters
function setupCharacterCounters() {
  const questionTextarea = document.getElementById('custom-main-question');
  const questionCounter = document.getElementById('question-counter');

  if (questionTextarea && questionCounter) {
    questionTextarea.addEventListener('input', function() {
      const count = this.value.length;
      questionCounter.textContent = `${count}/500`;
      questionCounter.className = count > 450 ? 'text-xs text-red-400' : 'text-xs text-gray-500';
    });
  }
}

// Setup modal character counter observers
function setupModalCharacterCounters() {
  // モーダルが表示されるたびにカウンターをセットアップ
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const modal = document.getElementById('form-config-modal');
        if (modal && !modal.classList.contains('hidden')) {
          setTimeout(setupCharacterCounters, 100);
        }
      }
    });
  });
  
  // モーダルの監視を開始
  const modal = document.getElementById('form-config-modal');
  if (modal) {
    observer.observe(modal, { attributes: true });
  }
}

// Navigate to specific step in admin panel
function navigateToStep(step) {
  if (typeof currentStep !== 'undefined') {
    currentStep = step;
  } else {
    // Define currentStep if not already defined
    window.currentStep = step;
  }
  
  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
    const stepNumber = index + 1;
    indicator.classList.toggle('completed', stepNumber < step);
    indicator.classList.toggle('active', stepNumber === step);
  });
  
  // Show/hide step content
  document.querySelectorAll('.step-content').forEach((content, index) => {
    const stepNumber = index + 1;
    content.classList.toggle('hidden', stepNumber !== step);
  });
  
  // Update progress bar
  const progressBar = document.querySelector('.progress-bar');
  if (progressBar) {
    progressBar.style.width = `${(step / 3) * 100}%`;
  }
  
  if (typeof validateCurrentStep === 'function') {
    validateCurrentStep();
  }
}

// Make navigateToStep globally available
window.navigateToStep = navigateToStep;

// Initialize main admin panel
function initializeAdminPanel(incomingUserId) {
  // userId is now managed globally by adminPanel-core.js
  if (typeof loadUserInfo === 'function') loadUserInfo();
  if (typeof loadSystemStatus === 'function') loadSystemStatus();
  if (typeof setupEventListeners === 'function') setupEventListeners();
  if (typeof setupRealtimeUpdates === 'function') setupRealtimeUpdates();
  if (typeof validateCurrentStep === 'function') validateCurrentStep();
}

// Make initializeAdminPanel globally available
window.initializeAdminPanel = initializeAdminPanel;

// =============================================================================
// CRITICAL UI FUNCTIONS - Moved from adminPanel-ui.js.html for early availability
// =============================================================================

// Toggle section visibility
function toggleSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (!section) {
    console.warn('Section not found:', sectionId);
    return;
  }
  
  // Find the toggle button for this section
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  const arrow = toggleBtn ? toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up') : null;
  
  // Toggle the section visibility
  if (section.classList.contains('hidden')) {
    // Show section
    section.classList.remove('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'true');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-up');
      arrow.classList.add('fa-chevron-down');
    }
  } else {
    // Hide section
    section.classList.add('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'false');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-down');
      arrow.classList.add('fa-chevron-up');
    }
  }
}

// Hide privacy modal
function hidePrivacyModal() {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('privacy-modal', false);
    }
  }
}

// Show form configuration modal
function showFormConfigModal() {
  if (window.sharedModals) {
    window.sharedModals.showFormConfig();
    if (typeof loadSavedClassChoices === 'function') {
      loadSavedClassChoices();
    }
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('form-config-modal', true);
    }
  } else {
    // Fallback for legacy support
    const modal = document.getElementById('form-config-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (typeof loadSavedClassChoices === 'function') {
        loadSavedClassChoices();
      }
      if (typeof manageFocusForModal === 'function') {
        manageFocusForModal('form-config-modal', true);
      }
    }
  }
}

// Enhanced updateUIWithNewStatus that works with both minimal and full implementations
function updateUIWithNewStatus(status) {
  if (!status) {
    console.warn('updateUIWithNewStatus: Invalid status received');
    return;
  }
  
  // Store for later use
  window.currentStatus = status;
  
  // Try to use the full implementation if available
  if (typeof window._fullUpdateUIWithNewStatus === 'function') {
    try {
      return window._fullUpdateUIWithNewStatus(status);
    } catch (error) {
      console.warn('Full updateUIWithNewStatus failed, using fallback:', error);
      // Continue with minimal implementation below
    }
  }
  
  // Minimal implementation for essential UI updates
  console.log('updateUIWithNewStatus: Using minimal implementation');
  
  // Update essential UI elements that are always available
  try {
    // Update basic status information
    if (status._normalized && typeof status._normalized.isPublished !== 'undefined') {
      const publishStatus = status._normalized.isPublished ? '公開中' : '停止中';
      const publishElement = document.getElementById('info-publish-text');
      if (publishElement) {
        publishElement.textContent = publishStatus;
      }
    }
    
    // Update answer count if available
    if (status.answerCount !== undefined) {
      const answerCountElement = document.getElementById('answer-count');
      if (answerCountElement) {
        answerCountElement.textContent = status.answerCount || '0';
      }
    }
    
    // Update active sheet information
    if (status.activeSheetName) {
      const sheetNameElements = document.querySelectorAll('.active-sheet-name');
      sheetNameElements.forEach(element => {
        element.textContent = status.activeSheetName;
      });
    }
    
  } catch (error) {
    console.error('Error in minimal updateUIWithNewStatus:', error);
  }
}

// Hide digital citizenship modal
function hideDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('digital-citizenship-modal', false);
    }
  }
}

// Hide confirmation modal
function hideConfirmationModal() {
  const modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('confirmation-modal', false);
    }
  }
}

// Generic showMessage function (placeholder)
function showMessage(message, type = 'info') {
  console.log(`[${type.toUpperCase()}] ${message}`);
  
  // Try to use advanced message system if available
  if (window.AdminPanel && window.AdminPanel.ui && typeof window.AdminPanel.ui.showMessage === 'function') {
    return window.AdminPanel.ui.showMessage(message, type);
  }
  
  // Simple fallback implementation
  const messageArea = document.getElementById('message-area');
  if (messageArea) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type} bg-${type === 'error' ? 'red' : type === 'warning' ? 'yellow' : type === 'success' ? 'green' : 'blue'}-100 border-l-4 border-${type === 'error' ? 'red' : type === 'warning' ? 'yellow' : type === 'success' ? 'green' : 'blue'}-500 p-4 mb-4`;
    messageDiv.textContent = message;
    messageArea.appendChild(messageDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.parentNode.removeChild(messageDiv);
      }
    }, 5000);
  }
}

// =============================================================================
// VALIDATION FUNCTIONS - Moved from adminPanel-ui.js.html for early availability
// =============================================================================

// Validate configuration with fallback logic
function validateConfig() {
  // Try to use the full implementation if available
  if (typeof window._fullValidateConfig === 'function') {
    try {
      return window._fullValidateConfig();
    } catch (error) {
      console.warn('Full validateConfig failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential validation
  console.log('validateConfig: Using minimal implementation');
  
  try {
    // Check primary element first, then fallback to secondary element
    const opinionValue = document.getElementById('opinionHeader')?.value || 
                        document.getElementById('reason-column')?.value || '';
    
    return opinionValue && opinionValue.trim() !== '';
  } catch (error) {
    console.error('Error in minimal validateConfig:', error);
    return false;
  }
}

// Update configuration buttons state with fallback logic
function updateConfigButtons() {
  // Try to use the full implementation if available
  if (typeof window._fullUpdateConfigButtons === 'function') {
    try {
      return window._fullUpdateConfigButtons();
    } catch (error) {
      console.warn('Full updateConfigButtons failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential button updates
  console.log('updateConfigButtons: Using minimal implementation');
  
  try {
    const isValid = validateConfig();
    const saveBtn = document.getElementById('save-publish-btn');
    
    if (saveBtn) {
      saveBtn.disabled = !isValid;
      if (isValid) {
        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }
  } catch (error) {
    console.error('Error in minimal updateConfigButtons:', error);
  }
}

// =============================================================================
// FUNCTION AVAILABILITY MANAGEMENT
// =============================================================================

// Central function availability checker
function checkFunctionAvailability(functionName) {
  const isAvailable = typeof window[functionName] === 'function';
  if (!isAvailable) {
    console.warn(`⚠️ Function ${functionName} is not available`);
  }
  return isAvailable;
}

// Safe function caller with fallback handling
function safeCallFunction(functionName, ...args) {
  try {
    if (checkFunctionAvailability(functionName)) {
      return window[functionName](...args);
    } else {
      console.warn(`⚠️ Cannot call ${functionName} - function not available`);
      return null;
    }
  } catch (error) {
    console.error(`❌ Error calling ${functionName}:`, error);
    return null;
  }
}

// Function registry for better management
window.AdminPanel.functionRegistry = {
  available: new Set(),
  pending: new Set(),
  
  register(functionName) {
    if (typeof window[functionName] === 'function') {
      this.available.add(functionName);
      this.pending.delete(functionName);
      console.log(`✅ Function registered: ${functionName}`);
    } else {
      this.pending.add(functionName);
      console.warn(`⚠️ Function pending: ${functionName}`);
    }
  },
  
  isAvailable(functionName) {
    return this.available.has(functionName);
  },
  
  waitFor(functionName, timeout = 5000) {
    return new Promise((resolve, reject) => {
      if (this.isAvailable(functionName)) {
        resolve(window[functionName]);
        return;
      }
      
      const startTime = Date.now();
      const checkInterval = setInterval(() => {
        if (this.isAvailable(functionName)) {
          clearInterval(checkInterval);
          resolve(window[functionName]);
        } else if (Date.now() - startTime > timeout) {
          clearInterval(checkInterval);
          reject(new Error(`Function ${functionName} not available after ${timeout}ms`));
        }
      }, 100);
    });
  }
};

// Make all critical functions globally available immediately
window.toggleSection = toggleSection;
window.hidePrivacyModal = hidePrivacyModal;
window.hideDigitalCitizenshipModal = hideDigitalCitizenshipModal;
window.hideConfirmationModal = hideConfirmationModal;
window.showFormConfigModal = showFormConfigModal;
window.showMessage = showMessage;
window.updateUIWithNewStatus = updateUIWithNewStatus;
window.validateConfig = validateConfig;
window.updateConfigButtons = updateConfigButtons;
window.checkFunctionAvailability = checkFunctionAvailability;
window.safeCallFunction = safeCallFunction;

// Register all critical functions
const criticalFunctions = [
  'toggleSection', 'hidePrivacyModal', 'hideDigitalCitizenshipModal', 
  'hideConfirmationModal', 'showFormConfigModal', 'showMessage', 
  'updateUIWithNewStatus', 'validateConfig', 'updateConfigButtons', 
  'navigateToStep', 'initializeAdminPanel'
];

criticalFunctions.forEach(funcName => {
  window.AdminPanel.functionRegistry.register(funcName);
});

// =============================================================================
// SYSTEM STATUS AND USER INTERACTION MANAGEMENT
// =============================================================================

// システム監視用の状態管理
window.systemStatus = {
  initializationStarted: false,
  coreInitialized: false,
  apiInitialized: false,
  uiInitialized: false,
  eventsInitialized: false,
  initializationComplete: false,
  userDataSyncComplete: false,
  errors: [],
  lastActivity: Date.now()
};

// 初期化中のユーザー操作防止 - DOM準備完了後に実行
if (document.body) {
  document.body.style.pointerEvents = 'none';
  console.log('🛡️ User interaction disabled during initialization');
} else {
  // DOM読み込み完了を待ってから実行
  document.addEventListener('DOMContentLoaded', function() {
    if (document.body) {
      document.body.style.pointerEvents = 'none';
      console.log('🛡️ User interaction disabled during initialization (delayed)');
    }
  });
}

// 主要なUI要素を無効化する関数
function disableUserInteraction() {
  // DOM準備完了チェック
  if (!document || !document.body) {
    console.warn('⚠️ DOM not ready for disableUserInteraction');
    return;
  }
  
  // フォーム要素の無効化
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(element => {
    element.disabled = true;
    element.style.opacity = '0.6';
  });
  
  // クリック可能な要素の無効化
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(element => {
    element.style.pointerEvents = 'none';
    element.style.opacity = '0.6';
  });
  
  // body要素の無効化
  document.body.style.pointerEvents = 'none';
  
  console.log('🛡️ All interactive elements disabled');
}

// UI要素を有効化する関数
function enableUserInteraction() {
  // DOM準備完了チェック
  if (!document || !document.body) {
    console.warn('⚠️ DOM not ready for enableUserInteraction');
    return;
  }
  
  // フォーム要素の有効化
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(element => {
    element.disabled = false;
    element.style.opacity = '';
  });
  
  // クリック可能な要素の有効化
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(element => {
    element.style.pointerEvents = '';
    element.style.opacity = '';
  });
  
  // body要素も有効化
  document.body.style.pointerEvents = 'auto';
  
  console.log('✅ All interactive elements enabled');
}

// DOM読み込み後に要素を無効化
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', disableUserInteraction);
} else {
  disableUserInteraction();
}

function updateSystemStatus(component, status, error = null) {
  window.systemStatus[component] = status;
  window.systemStatus.lastActivity = Date.now();
  if (error) {
    window.systemStatus.errors.push({ component, error: error.toString(), timestamp: Date.now() });
  }
  logDebug(`📊 System Status: ${component} = ${status}`);
}

// 公開停止後の全セクション展開処理
function checkAndExpandAllSections() {
  try {
    const expandAllFlag = localStorage.getItem('expandAllSections');
    if (expandAllFlag === 'true') {
      logInfo('📂 公開停止後のため全セクションを展開します');
      
      // 少し遅延してからセクションを展開（DOM要素の準備を待つ）
      setTimeout(() => {
        const sectionIds = ['step1-content', 'step2-content', 'step3-content'];
        let expandedCount = 0;
        
        sectionIds.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            // セクションが折りたたまれている場合のみ展開
            if (section.classList.contains('hidden')) {
              if (typeof toggleSection === 'function') {
                toggleSection(sectionId);
                expandedCount++;
                logDebug(`✅ セクション展開: ${sectionId}`);
              }
            }
          }
        });
        
        if (expandedCount > 0) {
          logInfo(`📂 ${expandedCount}個のセクションを展開しました`);
        }
        
        // フラグをクリア（一度だけ実行）
        localStorage.removeItem('expandAllSections');
        logDebug('🧹 全セクション展開フラグをクリアしました');
      }, 500);
    }
  } catch (error) {
    logWarn('⚠️ 全セクション展開処理でエラー:', error);
  }
}

// =============================================================================
// MASTER INITIALIZATION SYSTEM
// =============================================================================

function initializeAdminPanelMaster() {
  logInfo('🚀 AdminPanel Master Initialization Started');
  updateSystemStatus('initializationStarted', true);
  
  // Phase 1: Core初期化
  try {
    initCore();
    updateSystemStatus('coreInitialized', true);
  } catch (error) {
    updateSystemStatus('coreInitialized', false, error);
    console.error('❌ Core initialization failed:', error);
  }
  
  // 公開停止後の全セクション展開処理
  checkAndExpandAllSections();
  
  // フォーム作成完了表示をクリア（新規アクセス時はデフォルトで非表示）
  setTimeout(() => {
    const formJustCreated = sessionStorage.getItem('form_just_created');
    if (formJustCreated !== 'true') {
      // 新規作成ではない場合、セクションを非表示にする
      const formUrlSection = document.getElementById('form-url-section');
      if (formUrlSection && !formUrlSection.classList.contains('hidden')) {
        formUrlSection.classList.add('hidden');
        logDebug('📋 既存アクセス時はフォーム完了セクションを非表示');
      }
    }
  }, 100);
  
  // Phase 2: 各モジュールを並列初期化 (パフォーマンス向上)
  // 遅延を最小限に抑制して即座に初期化
  setTimeout(() => {
    logDebug('🔧 Phase 2: 並列モジュール初期化開始');
    
    // Status管理初期化
    try {
      initializeMessageArea();
      logDebug('✅ Status module initialized');
    } catch (error) {
      logError('❌ Status module initialization failed:', error);
    }
    
    // API通信初期化（最重要 - getInitialDataを呼び出す）
    try {
      logDebug('🚀 API module initialization starting...');
      initializeAPI();
      updateSystemStatus('apiInitialized', true);
      logDebug('✅ API module initialized');
    } catch (error) {
      updateSystemStatus('apiInitialized', false, error);
      console.error('❌ API initialization failed:', error);
      
      // フォールバック実装
      console.warn('⚠️ API functions not available, using fallback...');
      updateSystemStatus('apiInitialized', 'fallback');
      logDebug('✅ API module initialized with fallback');
    }
    
    // UI初期化
    try {
      initializeUI();
      updateSystemStatus('uiInitialized', true);
      logDebug('✅ UI module initialized');
    } catch (error) {
      updateSystemStatus('uiInitialized', false, error);
      console.error('❌ UI initialization failed:', error);
    }
    
    // フォーム管理初期化
    try {
      setupCharacterCounters();
      setupModalCharacterCounters();
      logDebug('✅ Forms module initialized');
    } catch (error) {
      logError('❌ Forms module initialization failed:', error);
    }
    
    // イベント管理初期化（最後に実行）
    setTimeout(() => {
      try {
        initializeEventListeners();
        updateSystemStatus('eventsInitialized', true);
        updateSystemStatus('initializationComplete', true);
        logDebug('✅ Events module initialized');
        logInfo('🎉 AdminPanel Master Initialization Complete');
        
        // システム状態の最終レポート
        console.log('📊 Final System Status:', window.systemStatus);
        
        // ユーザー情報の同期と最終処理
        finalizeInitialization();
        
      } catch (error) {
        updateSystemStatus('eventsInitialized', false, error);
        console.error('❌ Events initialization failed:', error);
        
        // エラーでも最終処理は実行
        finalizeInitialization();
      }
    }, 100);
    
  }, 10);
}

// Finalize initialization and enable user interaction
async function finalizeInitialization() {
  setTimeout(async () => {
    try {
      console.log('🔄 Final user data synchronization...');
      
      // ユーザーデータの最終同期を確実に実行
      if (typeof loadStatus === 'function') {
        try {
          await loadStatus(true);
          console.log('✅ User data synchronization completed');
        } catch (syncError) {
          console.warn('⚠️ User data sync failed, but continuing:', syncError);
        }
      } else {
        console.warn('⚠️ loadStatus function not available');
      }
      
      // すべての同期が完了したらローディングオーバーレイを非表示
      if (window.unifiedLoading) {
        window.unifiedLoading.hide();
        console.log('✅ Global loading overlay hidden after full sync');
      } else {
        // フォールバック: 直接DOM操作
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.add('hidden');
          console.log('✅ Loading overlay hidden (fallback)');
        }
      }
      
      // UI要素の有効化
      enableUserInteraction();
      updateSystemStatus('userDataSyncComplete', true);
      
    } catch (error) {
      console.error('❌ Final sync error:', error);
      // エラーでもローディングは解除
      if (window.unifiedLoading) {
        window.unifiedLoading.hide();
      }
      enableUserInteraction();
    }
  }, 500);
}

// 単一DOMContentLoadedハンドラー
if (document.readyState !== 'loading') {
  initializeAdminPanelMaster();
} else {
  document.addEventListener('DOMContentLoaded', initializeAdminPanelMaster);
}

// Update layout on resize
window.addEventListener('resize', function() {
  if (typeof debounce === 'function') {
    debounce(adjustLayout, 250, 'layout-resize')();
  } else {
    // Fallback without debounce
    adjustLayout();
  }
});

</script>
