<script>
// Unified Admin Panel Namespace and Management Classes
// Generated to address function interference issues and centralize state, events,
// asynchronous operations, and DOM handling.

window.AdminPanel = window.AdminPanel || {
  errors: {},
  ui: {},
  state: {
    current: null,
    selectedSheet: '',
    updateStatus(status) {
      this.current = status;
    }
  }
};

// -----------------------------------------------------------------------------
// State Manager
// -----------------------------------------------------------------------------
class AdminPanelStateManager {
  constructor() {
    this.state = {
      currentStatus: null,
      selectedSheet: '',
      isLoading: false
    };
    this.subscribers = new Map();
  }

  setState(key, value) {
    this.state[key] = value;
    this.notifySubscribers(key, value);
  }

  subscribe(key, callback) {
    if (!this.subscribers.has(key)) {
      this.subscribers.set(key, []);
    }
    this.subscribers.get(key).push(callback);
  }

  notifySubscribers(key, value) {
    const subs = this.subscribers.get(key) || [];
    subs.forEach(cb => {
      try {
        cb(value);
      } catch (e) {
        console.warn('Subscriber callback failed', e);
      }
    });
  }
}

// -----------------------------------------------------------------------------
// Event Manager
// -----------------------------------------------------------------------------
class AdminPanelEventManager {
  constructor() {
    this.listeners = new Map();
  }

  addListener(element, event, handler, options = {}) {
    if (!element || !event || !handler) return;
    const key = `${element.id || 'anonymous'}-${event}`;
    if (this.listeners.has(key)) {
      console.warn(`Duplicate listener for ${key}`);
      return;
    }
    element.addEventListener(event, handler, options);
    this.listeners.set(key, { element, event, handler, options });
  }
}

// -----------------------------------------------------------------------------
// Async Manager
// -----------------------------------------------------------------------------
class AdminPanelAsyncManager {
  constructor() {
    this.runningOperations = new Map();
  }

  async executeExclusive(operationId, operation) {
    if (this.runningOperations.has(operationId)) {
      return this.runningOperations.get(operationId);
    }
    const promise = Promise.resolve().then(operation);
    this.runningOperations.set(operationId, promise);
    try {
      return await promise;
    } finally {
      this.runningOperations.delete(operationId);
    }
  }
}

// -----------------------------------------------------------------------------
// DOM Manager
// -----------------------------------------------------------------------------
class AdminPanelDOMManager {
  constructor() {
    this.elementCache = new Map();
    this.operationQueue = [];
  }

  getElement(id) {
    if (!this.elementCache.has(id)) {
      this.elementCache.set(id, document.getElementById(id));
    }
    return this.elementCache.get(id);
  }

  queueOperation(operation) {
    this.operationQueue.push(operation);
    return new Promise(resolve => {
      requestAnimationFrame(() => {
        const op = this.operationQueue.shift();
        resolve(op());
      });
    });
  }
}

// Instantiate managers and expose via namespace
window.AdminPanel.stateManager = new AdminPanelStateManager();
window.AdminPanel.eventManager = new AdminPanelEventManager();
window.AdminPanel.asyncManager = new AdminPanelAsyncManager();
window.AdminPanel.domManager = new AdminPanelDOMManager();

// Link legacy globals to state manager for compatibility
Object.defineProperties(window, {
  currentStatus: {
    get() { return window.AdminPanel.stateManager.state.currentStatus; },
    set(v) { window.AdminPanel.stateManager.setState('currentStatus', v); }
  },
  selectedSheet: {
    get() { return window.AdminPanel.stateManager.state.selectedSheet; },
    set(v) { window.AdminPanel.stateManager.setState('selectedSheet', v); }
  }
});

// =============================================================================
// INITIALIZATION FUNCTIONS - Moved from various adminPanel files
// =============================================================================

// Simple logging utility with conditional output based on DEBUG mode
// DEBUG_MODE is defined in constants.js.html

function adminLog(level, ...args) {
  if (!(window.DEBUG_MODE || window.SYSTEM_CONSTANTS?.DEBUG_MODE)) return;
  
  switch (level) {
    case 'error':
      console.error('[AdminPanel]', ...args);
      break;
    case 'warn':
      console.warn('[AdminPanel]', ...args);
      break;
    case 'info':
      console.log('[AdminPanel]', ...args);
      break;
    case 'debug':
      if (window.DEBUG_MODE || window.SYSTEM_CONSTANTS?.DEBUG_MODE) console.log('[AdminPanel:DEBUG]', ...args);
      break;
    default:
      console.log('[AdminPanel]', ...args);
  }
}

// Convenience functions for different log levels
function logError(...args) { adminLog('error', ...args); }
function logWarn(...args) { adminLog('warn', ...args); }
function logInfo(...args) { adminLog('info', ...args); }
function logDebug(...args) { adminLog('debug', ...args); }

// =============================================================================
// USER AUTHENTICATION INITIALIZATION
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å®‰å…¨ãªåˆæœŸåŒ–
var userId = '';

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å®‰å…¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
function initializeUserId() {
  console.group('ğŸ” Initializing UserId');
  logDebug('ğŸ“ About to call getCurrentUserStatus');
  
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(response => {
        logDebug('ğŸ“¥ getCurrentUserStatus response:', response);
        
        if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
          userId = response.userInfo.userId;
          logDebug('âœ… AdminPanel: User authenticated, userId:', userId);
          console.groupEnd();
          resolve(userId);
        } else {
          console.error('âŒ Failed to get userId from backend:', response);
          console.error('âŒ Expected: {status: "success", userInfo: {userId: "..."}}');
          console.groupEnd();
          reject(new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        }
      })
      .withFailureHandler(error => {
        console.error('âŒ Backend error getting userId:', error);
        console.error('âŒ Error type:', typeof error);
        console.error('âŒ Error details:', error);
        console.groupEnd();
        reject(error);
      })
      .getCurrentUserStatus();
  });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ã®å®Œäº†ã‚’å¾…ã¤Promise
const userIdPromise = initializeUserId();

// =============================================================================
// CORE INITIALIZATION FUNCTIONS
// =============================================================================

// Layout adjustment for responsive design
function adjustLayout() {
  var isMobile = window.innerWidth < 768;
  var body = document.body;
  
  if (isMobile) {
    body.classList.add('mobile-layout');
    body.classList.remove('desktop-layout');
  } else {
    body.classList.add('desktop-layout');
    body.classList.remove('mobile-layout');
  }
}

// Initialize core functionality
function initCore() {
  adjustLayout();
}

// Initialize message area
function initializeMessageArea() {
  var messageArea = document.getElementById('message-area');
  if (!messageArea) {
    // Create message area if it doesn't exist
    messageArea = document.createElement('div');
    messageArea.id = 'message-area';
    messageArea.className = 'fixed top-32 right-4 z-50 max-w-sm';
    document.body.appendChild(messageArea);
  }
}

// Initialize UI components
function initializeUI() {
  console.log('âœ… AdminPanel: UI components ready');
  // UIåˆæœŸåŒ–ã®ã¿å®Ÿè¡Œã€loadStatusã¯ adminPanel-api.js ã§å‡¦ç†ã•ã‚Œã‚‹
}

// Initialize API functionality
function initializeAPI() {
  logDebug('ğŸ”§ APIåˆæœŸåŒ–é–‹å§‹');
  
  // Start background status updates with safe calling
  if (checkFunctionAvailability('startSystemStatusUpdate')) {
    safeCallFunction('startSystemStatusUpdate');
  } else {
    console.warn('âš ï¸ startSystemStatusUpdate not available - background updates disabled');
  }
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);

  // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒ­ãƒ¼ãƒ‰
  logDebug('ğŸš€ loadStatus()ã‚’å‘¼ã³å‡ºã—ã¾ã™');
  if (checkFunctionAvailability('loadStatus')) {
    safeCallFunction('loadStatus');
  } else {
    console.warn('âš ï¸ loadStatus not available - manual status refresh required');
  }
  
  logDebug('âœ… APIåˆæœŸåŒ–å®Œäº†');
}

// Update user activity timestamp for polling optimization
function updateUserActivity() {
  if (typeof lastUserActivity !== 'undefined') {
    lastUserActivity = Date.now();
  }
}

// Initialize event listeners
function initializeEventListeners() {
  console.log('âœ… AdminPanel: Setting up event listeners');
  
  // Use safe function calling with availability checks
  if (checkFunctionAvailability('setupEventListeners')) {
    safeCallFunction('setupEventListeners');
  } else {
    console.warn('âš ï¸ setupEventListeners function not available, attempting graceful degradation');
    
    // Basic fallback event listener setup
    if (checkFunctionAvailability('setupRealtimeValidation')) {
      safeCallFunction('setupRealtimeValidation');
    } else {
      console.warn('âš ï¸ setupRealtimeValidation not available - real-time validation disabled');
    }
  }
}

// Setup character counters
function setupCharacterCounters() {
  const questionTextarea = document.getElementById('custom-main-question');
  const questionCounter = document.getElementById('question-counter');

  if (questionTextarea && questionCounter) {
    questionTextarea.addEventListener('input', function() {
      const count = this.value.length;
      questionCounter.textContent = `${count}/500`;
      questionCounter.className = count > 450 ? 'text-xs text-red-400' : 'text-xs text-gray-500';
    });
  }
}

// Setup modal character counter observers
function setupModalCharacterCounters() {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŸã³ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const modal = document.getElementById('form-config-modal');
        if (modal && !modal.classList.contains('hidden')) {
          setTimeout(setupCharacterCounters, 100);
        }
      }
    });
  });
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç›£è¦–ã‚’é–‹å§‹
  const modal = document.getElementById('form-config-modal');
  if (modal) {
    observer.observe(modal, { attributes: true });
  }
}

// Navigate to specific step in admin panel
function navigateToStep(step) {
  if (typeof currentStep !== 'undefined') {
    currentStep = step;
  } else {
    // Define currentStep if not already defined
    window.currentStep = step;
  }
  
  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
    const stepNumber = index + 1;
    indicator.classList.toggle('completed', stepNumber < step);
    indicator.classList.toggle('active', stepNumber === step);
  });
  
  // Show/hide step content
  document.querySelectorAll('.step-content').forEach((content, index) => {
    const stepNumber = index + 1;
    content.classList.toggle('hidden', stepNumber !== step);
  });
  
  // Update progress bar
  const progressBar = document.querySelector('.progress-bar');
  if (progressBar) {
    progressBar.style.width = `${(step / 3) * 100}%`;
  }
  
  if (typeof validateCurrentStep === 'function') {
    validateCurrentStep();
  }
}

// Make navigateToStep globally available
window.navigateToStep = navigateToStep;

// Initialize main admin panel
function initializeAdminPanel(incomingUserId) {
  // userId is now managed globally by adminPanel-core.js
  if (typeof loadUserInfo === 'function') loadUserInfo();
  if (typeof loadSystemStatus === 'function') loadSystemStatus();
  if (typeof setupEventListeners === 'function') setupEventListeners();
  if (typeof setupRealtimeUpdates === 'function') setupRealtimeUpdates();
  if (typeof validateCurrentStep === 'function') validateCurrentStep();
}

// Make initializeAdminPanel globally available
window.initializeAdminPanel = initializeAdminPanel;

// =============================================================================
// CRITICAL UI FUNCTIONS - Moved from adminPanel-ui.js.html for early availability
// =============================================================================

// Toggle section visibility
function toggleSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (!section) {
    console.warn('Section not found:', sectionId);
    return;
  }
  
  // Find the toggle button for this section
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  const arrow = toggleBtn ? toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up') : null;
  
  // Toggle the section visibility
  if (section.classList.contains('hidden')) {
    // Show section
    section.classList.remove('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'true');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-up');
      arrow.classList.add('fa-chevron-down');
    }
  } else {
    // Hide section
    section.classList.add('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'false');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-down');
      arrow.classList.add('fa-chevron-up');
    }
  }
}

// Hide privacy modal
function hidePrivacyModal() {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('privacy-modal', false);
    }
  }
}

// Show form configuration modal
function showFormConfigModal() {
  if (window.sharedModals) {
    window.sharedModals.showFormConfig();
    if (typeof loadSavedClassChoices === 'function') {
      loadSavedClassChoices();
    }
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('form-config-modal', true);
    }
  } else {
    // Fallback for legacy support
    const modal = document.getElementById('form-config-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (typeof loadSavedClassChoices === 'function') {
        loadSavedClassChoices();
      }
      if (typeof manageFocusForModal === 'function') {
        manageFocusForModal('form-config-modal', true);
      }
    }
  }
}

// Enhanced updateUIWithNewStatus that works with both minimal and full implementations
function updateUIWithNewStatus(status) {
  if (!status) {
    console.warn('updateUIWithNewStatus: Invalid status received');
    return;
  }
  
  // Store for later use
  window.currentStatus = status;
  
  // Try to use the full implementation if available
  if (typeof window._fullUpdateUIWithNewStatus === 'function') {
    try {
      return window._fullUpdateUIWithNewStatus(status);
    } catch (error) {
      console.warn('Full updateUIWithNewStatus failed, using fallback:', error);
      // Continue with minimal implementation below
    }
  }
  
  // Minimal implementation for essential UI updates
  console.log('updateUIWithNewStatus: Using minimal implementation');
  
  // Update essential UI elements that are always available
  try {
    // Update basic status information
    if (status._normalized && typeof status._normalized.isPublished !== 'undefined') {
      const publishStatus = status._normalized.isPublished ? 'å…¬é–‹ä¸­' : 'åœæ­¢ä¸­';
      const publishElement = document.getElementById('info-publish-text');
      if (publishElement) {
        publishElement.textContent = publishStatus;
      }
    }
    
    // Update answer count if available
    if (status.answerCount !== undefined) {
      const answerCountElement = document.getElementById('answer-count');
      if (answerCountElement) {
        answerCountElement.textContent = status.answerCount || '0';
      }
    }
    
    // Update active sheet information
    if (status.activeSheetName) {
      const sheetNameElements = document.querySelectorAll('.active-sheet-name');
      sheetNameElements.forEach(element => {
        element.textContent = status.activeSheetName;
      });
    }
    
  } catch (error) {
    console.error('Error in minimal updateUIWithNewStatus:', error);
  }
}

// Hide digital citizenship modal
function hideDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('digital-citizenship-modal', false);
    }
  }
}

// Hide confirmation modal
function hideConfirmationModal() {
  const modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('confirmation-modal', false);
    }
  }
}

// Generic showMessage function (placeholder)
function showMessage(message, type = 'info') {
  console.log(`[${type.toUpperCase()}] ${message}`);
  
  // Try to use advanced message system if available
  if (window.AdminPanel && window.AdminPanel.ui && typeof window.AdminPanel.ui.showMessage === 'function') {
    return window.AdminPanel.ui.showMessage(message, type);
  }
  
  // Simple fallback implementation
  const messageArea = document.getElementById('message-area');
  if (messageArea) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type} bg-${type === 'error' ? 'red' : type === 'warning' ? 'yellow' : type === 'success' ? 'green' : 'blue'}-100 border-l-4 border-${type === 'error' ? 'red' : type === 'warning' ? 'yellow' : type === 'success' ? 'green' : 'blue'}-500 p-4 mb-4`;
    messageDiv.textContent = message;
    messageArea.appendChild(messageDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.parentNode.removeChild(messageDiv);
      }
    }, 5000);
  }
}

// =============================================================================
// VALIDATION FUNCTIONS - Moved from adminPanel-ui.js.html for early availability
// =============================================================================

// Validate configuration with fallback logic
function validateConfig() {
  // Try to use the full implementation if available
  if (typeof window._fullValidateConfig === 'function') {
    try {
      return window._fullValidateConfig();
    } catch (error) {
      console.warn('Full validateConfig failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential validation
  console.log('validateConfig: Using minimal implementation');
  
  try {
    // Check primary element first, then fallback to secondary element
    const opinionValue = document.getElementById('opinionHeader')?.value || 
                        document.getElementById('reason-column')?.value || '';
    
    return opinionValue && opinionValue.trim() !== '';
  } catch (error) {
    console.error('Error in minimal validateConfig:', error);
    return false;
  }
}

// Update configuration buttons state with fallback logic
function updateConfigButtons() {
  // Try to use the full implementation if available
  if (typeof window._fullUpdateConfigButtons === 'function') {
    try {
      return window._fullUpdateConfigButtons();
    } catch (error) {
      console.warn('Full updateConfigButtons failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential button updates
  console.log('updateConfigButtons: Using minimal implementation');
  
  try {
    const isValid = validateConfig();
    const saveBtn = document.getElementById('save-publish-btn');
    
    if (saveBtn) {
      saveBtn.disabled = !isValid;
      if (isValid) {
        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }
  } catch (error) {
    console.error('Error in minimal updateConfigButtons:', error);
  }
}

// =============================================================================
// FUNCTION AVAILABILITY MANAGEMENT
// =============================================================================

// Central function availability checker
function checkFunctionAvailability(functionName) {
  const isAvailable = typeof window[functionName] === 'function';
  if (!isAvailable) {
    console.warn(`âš ï¸ Function ${functionName} is not available`);
  }
  return isAvailable;
}

// Safe function caller with fallback handling
function safeCallFunction(functionName, ...args) {
  try {
    if (checkFunctionAvailability(functionName)) {
      return window[functionName](...args);
    } else {
      console.warn(`âš ï¸ Cannot call ${functionName} - function not available`);
      return null;
    }
  } catch (error) {
    console.error(`âŒ Error calling ${functionName}:`, error);
    return null;
  }
}

// Function registry for better management
window.AdminPanel.functionRegistry = {
  available: new Set(),
  pending: new Set(),
  
  register(functionName) {
    if (typeof window[functionName] === 'function') {
      this.available.add(functionName);
      this.pending.delete(functionName);
      console.log(`âœ… Function registered: ${functionName}`);
    } else {
      this.pending.add(functionName);
      console.warn(`âš ï¸ Function pending: ${functionName}`);
    }
  },
  
  isAvailable(functionName) {
    return this.available.has(functionName);
  },
  
  waitFor(functionName, timeout = 5000) {
    return new Promise((resolve, reject) => {
      if (this.isAvailable(functionName)) {
        resolve(window[functionName]);
        return;
      }
      
      const startTime = Date.now();
      const checkInterval = setInterval(() => {
        if (this.isAvailable(functionName)) {
          clearInterval(checkInterval);
          resolve(window[functionName]);
        } else if (Date.now() - startTime > timeout) {
          clearInterval(checkInterval);
          reject(new Error(`Function ${functionName} not available after ${timeout}ms`));
        }
      }, 100);
    });
  }
};

// Make all critical functions globally available immediately
window.toggleSection = toggleSection;
window.hidePrivacyModal = hidePrivacyModal;
window.hideDigitalCitizenshipModal = hideDigitalCitizenshipModal;
window.hideConfirmationModal = hideConfirmationModal;
window.showFormConfigModal = showFormConfigModal;
window.showMessage = showMessage;
window.updateUIWithNewStatus = updateUIWithNewStatus;
window.validateConfig = validateConfig;
window.updateConfigButtons = updateConfigButtons;
window.checkFunctionAvailability = checkFunctionAvailability;
window.safeCallFunction = safeCallFunction;

// Register all critical functions
const criticalFunctions = [
  'toggleSection', 'hidePrivacyModal', 'hideDigitalCitizenshipModal', 
  'hideConfirmationModal', 'showFormConfigModal', 'showMessage', 
  'updateUIWithNewStatus', 'validateConfig', 'updateConfigButtons', 
  'navigateToStep', 'initializeAdminPanel'
];

criticalFunctions.forEach(funcName => {
  window.AdminPanel.functionRegistry.register(funcName);
});

// =============================================================================
// SYSTEM STATUS AND USER INTERACTION MANAGEMENT
// =============================================================================

// ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ç”¨ã®çŠ¶æ…‹ç®¡ç†
window.systemStatus = {
  initializationStarted: false,
  coreInitialized: false,
  apiInitialized: false,
  uiInitialized: false,
  eventsInitialized: false,
  initializationComplete: false,
  userDataSyncComplete: false,
  errors: [],
  lastActivity: Date.now()
};

// åˆæœŸåŒ–ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œé˜²æ­¢ - DOMæº–å‚™å®Œäº†å¾Œã«å®Ÿè¡Œ
if (document.body) {
  document.body.style.pointerEvents = 'none';
  console.log('ğŸ›¡ï¸ User interaction disabled during initialization');
} else {
  // DOMèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
  document.addEventListener('DOMContentLoaded', function() {
    if (document.body) {
      document.body.style.pointerEvents = 'none';
      console.log('ğŸ›¡ï¸ User interaction disabled during initialization (delayed)');
    }
  });
}

// ä¸»è¦ãªUIè¦ç´ ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹é–¢æ•°
function disableUserInteraction() {
  // DOMæº–å‚™å®Œäº†ãƒã‚§ãƒƒã‚¯
  if (!document || !document.body) {
    console.warn('âš ï¸ DOM not ready for disableUserInteraction');
    return;
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ç„¡åŠ¹åŒ–
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(element => {
    element.disabled = true;
    element.style.opacity = '0.6';
  });
  
  // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¦ç´ ã®ç„¡åŠ¹åŒ–
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(element => {
    element.style.pointerEvents = 'none';
    element.style.opacity = '0.6';
  });
  
  // bodyè¦ç´ ã®ç„¡åŠ¹åŒ–
  document.body.style.pointerEvents = 'none';
  
  console.log('ğŸ›¡ï¸ All interactive elements disabled');
}

// UIè¦ç´ ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹é–¢æ•°
function enableUserInteraction() {
  // DOMæº–å‚™å®Œäº†ãƒã‚§ãƒƒã‚¯
  if (!document || !document.body) {
    console.warn('âš ï¸ DOM not ready for enableUserInteraction');
    return;
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®æœ‰åŠ¹åŒ–
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(element => {
    element.disabled = false;
    element.style.opacity = '';
  });
  
  // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¦ç´ ã®æœ‰åŠ¹åŒ–
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(element => {
    element.style.pointerEvents = '';
    element.style.opacity = '';
  });
  
  // bodyè¦ç´ ã‚‚æœ‰åŠ¹åŒ–
  document.body.style.pointerEvents = 'auto';
  
  console.log('âœ… All interactive elements enabled');
}

// DOMèª­ã¿è¾¼ã¿å¾Œã«è¦ç´ ã‚’ç„¡åŠ¹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', disableUserInteraction);
} else {
  disableUserInteraction();
}

function updateSystemStatus(component, status, error = null) {
  window.systemStatus[component] = status;
  window.systemStatus.lastActivity = Date.now();
  if (error) {
    window.systemStatus.errors.push({ component, error: error.toString(), timestamp: Date.now() });
  }
  logDebug(`ğŸ“Š System Status: ${component} = ${status}`);
}

// å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†
function checkAndExpandAllSections() {
  try {
    const expandAllFlag = localStorage.getItem('expandAllSections');
    if (expandAllFlag === 'true') {
      logInfo('ğŸ“‚ å…¬é–‹åœæ­¢å¾Œã®ãŸã‚å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ã—ã¾ã™');
      
      // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ï¼ˆDOMè¦ç´ ã®æº–å‚™ã‚’å¾…ã¤ï¼‰
      setTimeout(() => {
        const sectionIds = ['step1-content', 'step2-content', 'step3-content'];
        let expandedCount = 0;
        
        sectionIds.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å±•é–‹
            if (section.classList.contains('hidden')) {
              if (typeof toggleSection === 'function') {
                toggleSection(sectionId);
                expandedCount++;
                logDebug(`âœ… ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹: ${sectionId}`);
              }
            }
          }
        });
        
        if (expandedCount > 0) {
          logInfo(`ğŸ“‚ ${expandedCount}å€‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ã—ã¾ã—ãŸ`);
        }
        
        // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
        localStorage.removeItem('expandAllSections');
        logDebug('ğŸ§¹ å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      }, 500);
    }
  } catch (error) {
    logWarn('âš ï¸ å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// =============================================================================
// MASTER INITIALIZATION SYSTEM
// =============================================================================

function initializeAdminPanelMaster() {
  logInfo('ğŸš€ AdminPanel Master Initialization Started');
  updateSystemStatus('initializationStarted', true);
  
  // Phase 1: CoreåˆæœŸåŒ–
  try {
    initCore();
    updateSystemStatus('coreInitialized', true);
  } catch (error) {
    updateSystemStatus('coreInitialized', false, error);
    console.error('âŒ Core initialization failed:', error);
  }
  
  // å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†
  checkAndExpandAllSections();
  
  // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°è¦ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤ºï¼‰
  setTimeout(() => {
    const formJustCreated = sessionStorage.getItem('form_just_created');
    if (formJustCreated !== 'true') {
      // æ–°è¦ä½œæˆã§ã¯ãªã„å ´åˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
      const formUrlSection = document.getElementById('form-url-section');
      if (formUrlSection && !formUrlSection.classList.contains('hidden')) {
        formUrlSection.classList.add('hidden');
        logDebug('ğŸ“‹ æ—¢å­˜ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º');
      }
    }
  }, 100);
  
  // Phase 2: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¸¦åˆ—åˆæœŸåŒ– (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š)
  // é…å»¶ã‚’æœ€å°é™ã«æŠ‘åˆ¶ã—ã¦å³åº§ã«åˆæœŸåŒ–
  setTimeout(() => {
    logDebug('ğŸ”§ Phase 2: ä¸¦åˆ—ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–é–‹å§‹');
    
    // Statusç®¡ç†åˆæœŸåŒ–
    try {
      initializeMessageArea();
      logDebug('âœ… Status module initialized');
    } catch (error) {
      logError('âŒ Status module initialization failed:', error);
    }
    
    // APIé€šä¿¡åˆæœŸåŒ–ï¼ˆæœ€é‡è¦ - getInitialDataã‚’å‘¼ã³å‡ºã™ï¼‰
    try {
      logDebug('ğŸš€ API module initialization starting...');
      initializeAPI();
      updateSystemStatus('apiInitialized', true);
      logDebug('âœ… API module initialized');
    } catch (error) {
      updateSystemStatus('apiInitialized', false, error);
      console.error('âŒ API initialization failed:', error);
      
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
      console.warn('âš ï¸ API functions not available, using fallback...');
      updateSystemStatus('apiInitialized', 'fallback');
      logDebug('âœ… API module initialized with fallback');
    }
    
    // UIåˆæœŸåŒ–
    try {
      initializeUI();
      updateSystemStatus('uiInitialized', true);
      logDebug('âœ… UI module initialized');
    } catch (error) {
      updateSystemStatus('uiInitialized', false, error);
      console.error('âŒ UI initialization failed:', error);
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†åˆæœŸåŒ–
    try {
      setupCharacterCounters();
      setupModalCharacterCounters();
      logDebug('âœ… Forms module initialized');
    } catch (error) {
      logError('âŒ Forms module initialization failed:', error);
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†åˆæœŸåŒ–ï¼ˆæœ€å¾Œã«å®Ÿè¡Œï¼‰
    setTimeout(() => {
      try {
        initializeEventListeners();
        updateSystemStatus('eventsInitialized', true);
        updateSystemStatus('initializationComplete', true);
        logDebug('âœ… Events module initialized');
        logInfo('ğŸ‰ AdminPanel Master Initialization Complete');
        
        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ
        console.log('ğŸ“Š Final System Status:', window.systemStatus);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®åŒæœŸã¨æœ€çµ‚å‡¦ç†
        finalizeInitialization();
        
      } catch (error) {
        updateSystemStatus('eventsInitialized', false, error);
        console.error('âŒ Events initialization failed:', error);
        
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚æœ€çµ‚å‡¦ç†ã¯å®Ÿè¡Œ
        finalizeInitialization();
      }
    }, 100);
    
  }, 10);
}

// Finalize initialization and enable user interaction
async function finalizeInitialization() {
  setTimeout(async () => {
    try {
      console.log('ğŸ”„ Final user data synchronization...');
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æœ€çµ‚åŒæœŸã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
      if (typeof loadStatus === 'function') {
        try {
          await loadStatus(true);
          console.log('âœ… User data synchronization completed');
        } catch (syncError) {
          console.warn('âš ï¸ User data sync failed, but continuing:', syncError);
        }
      } else {
        console.warn('âš ï¸ loadStatus function not available');
      }
      
      // ã™ã¹ã¦ã®åŒæœŸãŒå®Œäº†ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
      if (window.unifiedLoading) {
        window.unifiedLoading.hide();
        console.log('âœ… Global loading overlay hidden after full sync');
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥DOMæ“ä½œ
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.add('hidden');
          console.log('âœ… Loading overlay hidden (fallback)');
        }
      }
      
      // UIè¦ç´ ã®æœ‰åŠ¹åŒ–
      enableUserInteraction();
      updateSystemStatus('userDataSyncComplete', true);
      
    } catch (error) {
      console.error('âŒ Final sync error:', error);
      // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è§£é™¤
      if (window.unifiedLoading) {
        window.unifiedLoading.hide();
      }
      enableUserInteraction();
    }
  }, 500);
}

// å˜ä¸€DOMContentLoadedãƒãƒ³ãƒ‰ãƒ©ãƒ¼
if (document.readyState !== 'loading') {
  initializeAdminPanelMaster();
} else {
  document.addEventListener('DOMContentLoaded', initializeAdminPanelMaster);
}

// Update layout on resize
window.addEventListener('resize', function() {
  if (typeof debounce === 'function') {
    debounce(adjustLayout, 250, 'layout-resize')();
  } else {
    // Fallback without debounce
    adjustLayout();
  }
});

</script>
