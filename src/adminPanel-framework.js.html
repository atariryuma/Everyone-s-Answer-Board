<script>
// Unified Admin Panel Namespace and Management Classes
// Generated to address function interference issues and centralize state, events,
// asynchronous operations, and DOM handling.

window.AdminPanel = window.AdminPanel || {
  errors: {},
  ui: {},
  state: {
    current: null,
    selectedSheet: '',
    updateStatus(status) {
      this.current = status;
    }
  },
  // Initialization state tracking to prevent redundant calls
  initialization: {
    isInProgress: false,
    isCompleted: false,
    completedPhases: new Set(),
    startTime: null,
    lastLoadStatusCall: null,
    loadStatusCallCount: 0
  }
};

// -----------------------------------------------------------------------------
// State Manager
// -----------------------------------------------------------------------------
class AdminPanelStateManager {
  constructor() {
    this.state = {
      currentStatus: null,
      selectedSheet: '',
      isLoading: false,
      debugMode: false // DEBUG_MODEÁä∂ÊÖã„ÇíËøΩÂä†
    };
    this.subscribers = new Map();
  }

  setState(key, value) {
    this.state[key] = value;
    this.notifySubscribers(key, value);
  }

  subscribe(key, callback) {
    if (!this.subscribers.has(key)) {
      this.subscribers.set(key, []);
    }
    this.subscribers.get(key).push(callback);
  }

  notifySubscribers(key, value) {
    const subs = this.subscribers.get(key) || [];
    subs.forEach((cb) => {
      try {
        cb(value);
      } catch (e) {
        console.warn('Subscriber callback failed', e);
      }
    });
  }
}

// -----------------------------------------------------------------------------
// Event Manager
// -----------------------------------------------------------------------------
class AdminPanelEventManager {
  constructor() {
    this.listeners = new Map();
  }

  addListener(element, event, handler, options = {}) {
    if (!element || !event || !handler) return;
    const key = `${element.id || 'anonymous'}-${event}`;
    if (this.listeners.has(key)) {
      console.warn(`Duplicate listener for ${key}`);
      return;
    }
    element.addEventListener(event, handler, options);
    this.listeners.set(key, { element, event, handler, options });
  }
}

// -----------------------------------------------------------------------------
// Async Manager
// -----------------------------------------------------------------------------
class AdminPanelAsyncManager {
  constructor() {
    this.runningOperations = new Map();
  }

  executeExclusive(operationId, operation) {
    if (this.runningOperations.has(operationId)) {
      return this.runningOperations.get(operationId);
    }
    const promise = Promise.resolve().then(operation);
    this.runningOperations.set(operationId, promise);
    return promise.then((result) => {
      this.runningOperations.delete(operationId);
      return result;
    }).catch((error) => {
      this.runningOperations.delete(operationId);
      throw error;
    });
  }
}

// -----------------------------------------------------------------------------
// DOM Manager
// -----------------------------------------------------------------------------
class AdminPanelDOMManager {
  constructor() {
    this.elementCache = new Map();
    this.operationQueue = [];
  }

  getElement(id) {
    if (!this.elementCache.has(id)) {
      this.elementCache.set(id, document.getElementById(id));
    }
    return this.elementCache.get(id);
  }

  queueOperation(operation) {
    this.operationQueue.push(operation);
    return new Promise((resolve) => {
      requestAnimationFrame(() => {
        const op = this.operationQueue.shift();
        resolve(op());
      });
    });
  }
}

// Instantiate managers and expose via namespace
window.AdminPanel.stateManager = new AdminPanelStateManager();
window.AdminPanel.eventManager = new AdminPanelEventManager();
window.AdminPanel.asyncManager = new AdminPanelAsyncManager();
window.AdminPanel.domManager = new AdminPanelDOMManager();

// Link legacy globals to state manager for compatibility
Object.defineProperties(window, {
  currentStatus: {
    get: function() { return window.AdminPanel.stateManager.state.currentStatus; },
    set: function(v) { window.AdminPanel.stateManager.setState('currentStatus', v); }
  },
  selectedSheet: {
    get: function() { return window.AdminPanel.stateManager.state.selectedSheet; },
    set: function(v) { window.AdminPanel.stateManager.setState('selectedSheet', v); }
  }
});

// =============================================================================
// INITIALIZATION FUNCTIONS - Moved from various adminPanel files
// =============================================================================

// Simple logging utility with conditional output based on DEBUG mode
// DEBUG_MODE is defined in constants.js.html

const adminLog = (level, ...args) => {
  // Only show errors and critical warnings - disable verbose logging
  switch (level) {
    case 'error':
      console.error('[AdminPanel]', ...args);
      break;
    case 'warn':
      // Only show warnings in debug mode
      if (window.DEBUG_MODE) console.warn('[AdminPanel]', ...args);
      break;
    case 'info':
    case 'debug':
    default:
      // All info/debug logs disabled for performance
      return;
  }
};

// Convenience functions for different log levels
const logError = (...args) => adminLog('error', ...args);
const logWarn = (...args) => adminLog('warn', ...args);
const logInfo = (...args) => adminLog('info', ...args);
const logDebug = (...args) => adminLog('debug', ...args);

// =============================================================================
// USER AUTHENTICATION INITIALIZATION
// =============================================================================

// „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÂØæÂøú: „É¶„Éº„Ç∂„ÉºID„ÅÆÂÆâÂÖ®„Å™ÂàùÊúüÂåñ
let userId = '';

// „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÂØæÂøú: „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åã„ÇâÂÆâÂÖ®„Å´„É¶„Éº„Ç∂„ÉºID„ÇíÂèñÂæó
const initializeUserId = () => {
  console.group('üîê Initializing UserId');
  logDebug('üìû About to call getCurrentUserStatus');
  
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler((response) => {
        logDebug('üì• getCurrentUserStatus response:', response);
        
        if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
          userId = response.userInfo.userId;
          logDebug('‚úÖ AdminPanel: User authenticated, userId:', userId);
          console.groupEnd();
          resolve(userId);
        } else {
          console.error('‚ùå Failed to get userId from backend:', response);
          console.error('‚ùå Expected: {status: "success", userInfo: {userId: "..."}}');
          console.groupEnd();
          reject(new Error('„É¶„Éº„Ç∂„ÉºID„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'));
        }
      })
      .withFailureHandler((error) => {
        console.error('‚ùå Backend error getting userId:', error);
        console.error('‚ùå Error type:', typeof error);
        console.error('‚ùå Error details:', error);
        console.groupEnd();
        reject(error);
      })
      .getCurrentUserStatus();
  });
}

// „É™„Éà„É©„Ç§‰ªò„Åç„É¶„Éº„Ç∂„ÉºIDÂèñÂæó
const initializeUserIdWithRetry = async (maxRetries = 3, delay = 1000) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await initializeUserId();
    } catch (error) {
      console.warn(`‚ö†Ô∏è UserId initialization failed (attempt ${i + 1}/${maxRetries}):`, error.message);
      if (i < maxRetries - 1) {
        console.log(`üîÑ Retrying in ${delay}ms...`);
        await new Promise((resolve) => { setTimeout(resolve, delay); });
        delay = Math.min(delay * 1.5, 5000); // ÊåáÊï∞„Éê„ÉÉ„ÇØ„Ç™„ÉïÔºàÊúÄÂ§ß5ÁßíÔºâ
      } else {
        logError(error, 'All userId initialization attempts failed');
        throw error;
      }
    }
  }
};

// „É¶„Éº„Ç∂„ÉºIDÂèñÂæó„ÅÆÂÆå‰∫Ü„ÇíÂæÖ„Å§PromiseÔºà„É™„Éà„É©„Ç§Ê©üÊßã‰ªò„ÅçÔºâ
const userIdPromise = initializeUserIdWithRetry();

// =============================================================================
// CORE INITIALIZATION FUNCTIONS
// =============================================================================

// Layout adjustment for responsive design
const adjustLayout = () => {
  const isMobile = window.innerWidth < 768;
  const body = document.body;
  
  if (isMobile) {
    body.classList.add('mobile-layout');
    body.classList.remove('desktop-layout');
  } else {
    body.classList.add('desktop-layout');
    body.classList.remove('mobile-layout');
  }
};

// Initialize core functionality
const initCore = () => {
  adjustLayout();
};

// Initialize message area
const initializeMessageArea = () => {
  let messageArea = document.getElementById('message-area');
  if (!messageArea) {
    // Create message area if it doesn't exist
    messageArea = document.createElement('div');
    messageArea.id = 'message-area';
    messageArea.className = 'fixed top-32 right-4 z-50 max-w-sm';
    document.body.appendChild(messageArea);
  }
};

// Initialize UI components
const initializeUI = () => {
  // UIÂàùÊúüÂåñ„ÅÆ„ÅøÂÆüË°å„ÄÅloadStatus„ÅØ adminPanel-api.js „ÅßÂá¶ÁêÜ„Åï„Çå„Çã
};

// Initialize API functionality
const initializeAPI = () => {
  logDebug('üîß APIÂàùÊúüÂåñÈñãÂßã');
  
  // Start background status updates with safe calling
  if (checkFunctionAvailability('startSystemStatusUpdate')) {
    safeCallFunction('startSystemStatusUpdate');
  } else {
    console.warn('‚ö†Ô∏è startSystemStatusUpdate not available - background updates disabled');
  }
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);

  // ÂàùÊúüÂåñÊôÇ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„É≠„Éº„Éâ - „Çø„Ç§„Éü„É≥„Ç∞Ë™øÊï¥Áâà
  logDebug('üöÄ ÂàùÊúüÂåñÊôÇloadStatus(true)Âëº„Å≥Âá∫„ÅóÔºàÈÅÖÂª∂„ÅÇ„ÇäÔºâ');
  setTimeout(() => {
    if (checkFunctionAvailability('loadStatus')) {
      window.loadStatus(true);
    } else {
      console.warn('‚ö†Ô∏è loadStatus not available');
    }
  }, 500); // 500msÈÅÖÂª∂„Åß„Çà„ÇäÂÆâÂÖ®„Å™ÂàùÊúüÂåñ
  
  logDebug('‚úÖ APIÂàùÊúüÂåñÂÆå‰∫Ü');
};

// Update user activity timestamp for polling optimization
const updateUserActivity = () => {
  if (typeof lastUserActivity !== 'undefined') {
    lastUserActivity = Date.now();
  }
};

// Initialize event listeners
const initializeEventListeners = () => {
  
  // Use safe function calling with availability checks
  if (checkFunctionAvailability('setupEventListeners')) {
    safeCallFunction('setupEventListeners');
  } else {
    console.warn('‚ö†Ô∏è setupEventListeners function not available, attempting graceful degradation');
    
    // Basic fallback event listener setup
    if (checkFunctionAvailability('setupRealtimeValidation')) {
      safeCallFunction('setupRealtimeValidation');
    } else {
      console.warn('‚ö†Ô∏è setupRealtimeValidation not available - real-time validation disabled');
    }
  }
};

// Setup character counters
const setupCharacterCounters = () => {
  const questionTextarea = document.getElementById('custom-main-question');
  const questionCounter = document.getElementById('question-counter');

  if (questionTextarea && questionCounter) {
    questionTextarea.addEventListener('input', function() {
      const count = this.value.length;
      questionCounter.textContent = `${count}/500`;
      questionCounter.className = count > 450 ? 'text-xs text-red-400' : 'text-xs text-gray-500';
    });
  }
};

// Setup modal character counter observers
const setupModalCharacterCounters = () => {
  // „É¢„Éº„ÉÄ„É´„ÅåË°®Á§∫„Åï„Çå„Çã„Åü„Å≥„Å´„Ç´„Ç¶„É≥„Çø„Éº„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const modal = document.getElementById('form-config-modal');
        if (modal && !modal.classList.contains('hidden')) {
          setTimeout(setupCharacterCounters, 100);
        }
      }
    });
  });
  
  // „É¢„Éº„ÉÄ„É´„ÅÆÁõ£Ë¶ñ„ÇíÈñãÂßã
  const modal = document.getElementById('form-config-modal');
  if (modal) {
    observer.observe(modal, { attributes: true });
  }
};

// Navigate to specific step in admin panel
const navigateToStep = (step) => {
  if (typeof currentStep !== 'undefined') {
    currentStep = step;
  } else {
    // Define currentStep if not already defined
    window.currentStep = step;
  }
  
  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
    const stepNumber = index + 1;
    indicator.classList.toggle('completed', stepNumber < step);
    indicator.classList.toggle('active', stepNumber === step);
  });
  
  // Show/hide step content
  document.querySelectorAll('.step-content').forEach((content, index) => {
    const stepNumber = index + 1;
    content.classList.toggle('hidden', stepNumber !== step);
  });
  
  // Update progress bar
  const progressBar = document.querySelector('.progress-bar');
  if (progressBar) {
    progressBar.style.width = `${(step / 3) * 100}%`;
  }
  
  if (typeof validateCurrentStep === 'function') {
    validateCurrentStep();
  }
};

// Make navigateToStep globally available
window.navigateToStep = navigateToStep;

// Initialize main admin panel
function initializeAdminPanel(incomingUserId) {
  // userId is now managed globally by adminPanel-core.js
  if (typeof loadUserInfo === 'function') loadUserInfo();
  if (typeof loadSystemStatus === 'function') loadSystemStatus();
  if (typeof setupEventListeners === 'function') setupEventListeners();
  if (typeof setupRealtimeUpdates === 'function') setupRealtimeUpdates();
  if (typeof validateCurrentStep === 'function') validateCurrentStep();
}

// Make initializeAdminPanel globally available
window.initializeAdminPanel = initializeAdminPanel;

// =============================================================================
// CRITICAL UI FUNCTIONS - Moved from adminPanel-ui.js.html for early availability
// =============================================================================

// Toggle section visibility
function toggleSection(sectionId) {
  var section = document.getElementById(sectionId);
  if (!section) {
    console.warn('Section not found:', sectionId);
    return;
  }
  
  // Find the toggle button for this section
  var toggleBtn = document.querySelector('[onclick*="' + sectionId + '"]');
  var arrow = toggleBtn ? toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up') : null;
  
  // Toggle the section visibility
  if (section.classList.contains('hidden')) {
    // Show section
    section.classList.remove('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'true');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-up');
      arrow.classList.add('fa-chevron-down');
    }
  } else {
    // Hide section
    section.classList.add('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'false');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-down');
      arrow.classList.add('fa-chevron-up');
    }
  }
}

// Hide privacy modal
const hidePrivacyModal = () => {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('privacy-modal', false);
    }
  }
};

// Show form configuration modal
function showFormConfigModal() {
  if (window.sharedModals) {
    window.sharedModals.showFormConfig();
    if (typeof loadSavedClassChoices === 'function') {
      loadSavedClassChoices();
    }
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('form-config-modal', true);
    }
  } else {
    // Fallback for legacy support
    const modal = document.getElementById('form-config-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (typeof loadSavedClassChoices === 'function') {
        loadSavedClassChoices();
      }
      if (typeof manageFocusForModal === 'function') {
        manageFocusForModal('form-config-modal', true);
      }
    }
  }
}

// Enhanced updateUIWithNewStatus that works with both minimal and full implementations
function updateUIWithNewStatus(status) {
  if (!status) {
    console.warn('updateUIWithNewStatus: Invalid status received');
    return;
  }
  
  // Store for later use
  window.currentStatus = status;
  
  // Enhanced full implementation detection with multiple retries
  if (typeof window._fullUpdateUIWithNewStatus === 'function') {
    try {
      // Êú¨Áï™Áí∞Â¢É„Åß„ÅÆ„É≠„Ç∞Èáè„ÇíÊ∏õ„Çâ„Åô
      if (window.DEBUG_MODE || window.location.hostname === 'localhost') {
        console.log('updateUIWithNewStatus: Using full implementation');
      }
      return window._fullUpdateUIWithNewStatus(status);
    } catch (error) {
      console.warn('Full updateUIWithNewStatus failed, using fallback:', error);
      // Continue with minimal implementation below
    }
  } else {
    // Enhanced retry mechanism with multiple attempts
    var retryCount = 0;
    var maxRetries = 3;
    var retryDelays = [200, 500, 1000]; // Progressive delays
    
    var tryFullImplementation = function() {
      if (typeof window._fullUpdateUIWithNewStatus === 'function') {
        console.log('updateUIWithNewStatus: Full implementation now available (retry ' + (retryCount + 1) + ')');
        try {
          window._fullUpdateUIWithNewStatus(status);
          return;
        } catch (error) {
          console.warn('Retried full updateUIWithNewStatus failed:', error);
        }
      }
      
      if (retryCount < maxRetries) {
        retryCount++;
        setTimeout(tryFullImplementation, retryDelays[retryCount - 1] || 1000);
      } else {
        console.log('updateUIWithNewStatus: Max retries exceeded, using minimal implementation only');
      }
    };
    
    // Start retry sequence
    setTimeout(tryFullImplementation, retryDelays[0]);
  }
  
  // Enhanced minimal implementation for comprehensive UI updates
  console.log('updateUIWithNewStatus: Using enhanced minimal implementation');
  
  // Update essential UI elements with comprehensive information
  try {
    // 1. Update publication status with indicators
    if (status._normalized && typeof status._normalized.isPublished !== 'undefined') {
      var publishStatus = status._normalized.isPublished ? 'ÂÖ¨Èñã‰∏≠' : 'ÂÅúÊ≠¢‰∏≠';
      var publishElement = document.getElementById('info-publish-text');
      if (publishElement) {
        publishElement.textContent = publishStatus;
      }
      
      // Update publish indicator
      var indicatorElement = document.getElementById('info-publish-indicator');
      var statusElement = document.getElementById('info-publish-status');
      if (status._normalized.isPublished) {
        if (statusElement) statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-green-600 text-white';
        if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-green-400';
      } else {
        if (statusElement) statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-gray-600 text-gray-300';
        if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      }
    }
    
    // 2. Update user information section
    if (status.userInfo) {
      var adminEmailEl = document.getElementById('info-admin-email');
      var userIdEl = document.getElementById('info-user-id');
      
      if (adminEmailEl && status.userInfo.adminEmail) {
        adminEmailEl.textContent = status.userInfo.adminEmail;
      }
      if (userIdEl && status.userInfo.userId) {
        userIdEl.textContent = status.userInfo.userId;
      }
      
      // Update spreadsheet access
      if (status.userInfo.spreadsheetUrl) {
        var spreadsheetBtn = document.getElementById('open-spreadsheet-btn-step2');
        if (spreadsheetBtn) {
          spreadsheetBtn.disabled = false;
          spreadsheetBtn.onclick = function() { window.open(status.userInfo.spreadsheetUrl, '_blank'); };
        }
      }
    }
    
    // 3. Update configuration display
    if (status.config || (status.userInfo && status.userInfo.configJson)) {
      var config = status.config;
      if (!config && status.userInfo.configJson) {
        try {
          config = typeof status.userInfo.configJson === 'string' 
            ? JSON.parse(status.userInfo.configJson) 
            : status.userInfo.configJson;
        } catch (e) {
          console.warn('Failed to parse configJson in minimal implementation');
        }
      }
      
      if (config) {
        // Update published sheet name
        var publishedSheetEl = document.getElementById('info-published-sheet');
        if (publishedSheetEl) {
          publishedSheetEl.textContent = config.publishedSheetName || status.activeSheetName || '„Å™„Åó';
        }
        
        // Update display mode
        var displayModeEl = document.getElementById('info-display-mode');
        if (displayModeEl) {
          displayModeEl.textContent = config.showNames ? 'ÂêçÂâçË°®Á§∫' : 'ÂåøÂêçË°®Á§∫';
        }
        
        // Update show counts setting
        var showCountsEl = document.getElementById('info-show-counts');
        if (showCountsEl) {
          showCountsEl.textContent = config.showCounts ? 'Ë°®Á§∫' : 'ÈùûË°®Á§∫';
        }
      }
    }
    
    // 4. Update answer count if available
    if (status.answerCount !== undefined) {
      var answerCountElement = document.getElementById('answer-count');
      if (answerCountElement) {
        answerCountElement.textContent = status.answerCount || '0';
      }
    }
    
    // 5. Update active sheet information
    if (status.activeSheetName) {
      var sheetNameElements = document.querySelectorAll('.active-sheet-name');
      sheetNameElements.forEach(function(element) {
        element.textContent = status.activeSheetName;
      });
    }
    
    
  } catch (error) {
    console.error('Error in enhanced minimal updateUIWithNewStatus:', error);
  }
}

// Hide digital citizenship modal
function hideDigitalCitizenshipModal() {
  var modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('digital-citizenship-modal', false);
    }
  }
}

// Hide confirmation modal
function hideConfirmationModal() {
  var modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('confirmation-modal', false);
    }
  }
}

// Unified showMessage function - uses SharedUtilities MessageManager
function showMessage(message, type = 'info', duration = 5000) {
  console.log('[' + type.toUpperCase() + '] ' + message);
  
  // Use SharedUtilities MessageManager if available
  if (window.sharedUtilities?.messages?.show) {
    return window.sharedUtilities.messages.show(message, type, duration);
  }
  
  // Fallback for cases where SharedUtilities is not loaded
  console.warn('‚ö†Ô∏è SharedUtilities MessageManager not available, using console fallback');
}

// =============================================================================
// VALIDATION FUNCTIONS - Moved from adminPanel-ui.js.html for early availability
// =============================================================================

// Validate configuration with fallback logic
function validateConfig() {
  // Try to use the full implementation if available
  if (typeof window._fullValidateConfig === 'function') {
    try {
      return window._fullValidateConfig();
    } catch (error) {
      console.warn('Full validateConfig failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential validation
  console.log('validateConfig: Using minimal implementation');
  
  try {
    // Check primary element first, then fallback to secondary element
    var opinionValueEl1 = document.getElementById('opinionHeader');
    var opinionValueEl2 = document.getElementById('reason-column');
    var opinionValue = (opinionValueEl1 && opinionValueEl1.value) || 
                        (opinionValueEl2 && opinionValueEl2.value) || '';
    
    return opinionValue && opinionValue.trim() !== '';
  } catch (error) {
    console.error('Error in minimal validateConfig:', error);
    return false;
  }
}

// Update configuration buttons state with fallback logic
function updateConfigButtons() {
  // Try to use the full implementation if available
  if (typeof window._fullUpdateConfigButtons === 'function') {
    try {
      return window._fullUpdateConfigButtons();
    } catch (error) {
      console.warn('Full updateConfigButtons failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential button updates
  console.log('updateConfigButtons: Using minimal implementation');
  
  try {
    var isValid = validateConfig();
    var saveBtn = document.getElementById('save-publish-btn');
    
    if (saveBtn) {
      saveBtn.disabled = !isValid;
      if (isValid) {
        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }
  } catch (error) {
    console.error('Error in minimal updateConfigButtons:', error);
  }
}

// =============================================================================
// FUNCTION AVAILABILITY MANAGEMENT
// =============================================================================

// Central function availability checker
function checkFunctionAvailability(functionName) {
  var isAvailable = typeof window[functionName] === 'function';
  if (!isAvailable) {
    console.warn('‚ö†Ô∏è Function ' + functionName + ' is not available');
  }
  return isAvailable;
}

// Safe function caller with fallback handling
function safeCallFunction(functionName, ...args) {
  try {
    if (checkFunctionAvailability(functionName)) {
      return window[functionName](...args);
    } else {
      console.warn('‚ö†Ô∏è Cannot call ' + functionName + ' - function not available');
      return null;
    }
  } catch (error) {
    console.error('‚ùå Error calling ' + functionName + ':', error);
    return null;
  }
}

// Enhanced function registry with full implementation tracking
window.AdminPanel.functionRegistry = {
  available: new Set(),
  pending: new Set(),
  fullImplementations: new Set(),
  
  register(functionName) {
    if (typeof window[functionName] === 'function') {
      this.available.add(functionName);
      this.pending.delete(functionName);
    } else {
      this.pending.add(functionName);
      console.warn('‚ö†Ô∏è Function pending: ' + functionName);
    }
  },
  
  registerFullImplementation(functionName) {
    var fullFuncName = '_full' + functionName.charAt(0).toUpperCase() + functionName.slice(1);
    if (typeof window[fullFuncName] === 'function') {
      this.fullImplementations.add(functionName);
      // Verbose implementation logging disabled for performance
    }
  },
  
  hasFullImplementation(functionName) {
    var fullFuncName = '_full' + functionName.charAt(0).toUpperCase() + functionName.slice(1);
    return typeof window[fullFuncName] === 'function';
  },
  
  isAvailable(functionName) {
    return this.available.has(functionName);
  },
  
  // Enhanced full implementation detection
  checkForFullImplementations() {
    var functionsToCheck = [
      'updateUIWithNewStatus', 'populateHeaderOptions', 'populateConfig', 
      'updateFormUrlDisplay', 'validateConfig', 'updateConfigButtons'
    ];
    
    var foundCount = 0;
    var self = this;
    functionsToCheck.forEach(function(funcName) {
      if (self.hasFullImplementation(funcName)) {
        self.registerFullImplementation(funcName);
        foundCount++;
      }
    });
    
    // Êú¨Áï™Áí∞Â¢É„Åß„ÅÆ„É≠„Ç∞Èáè„ÇíÊ∏õ„Çâ„Åô
    if (window.DEBUG_MODE || window.location.hostname === 'localhost') {
      console.log('üîç Full implementations check: ' + foundCount + '/' + functionsToCheck.length + ' available');
    }
    return foundCount;
  },
  
  waitFor(functionName, timeout = 5000) {
    return new Promise(function(resolve, reject) {
      if (this.isAvailable(functionName)) {
        resolve(window[functionName]);
        return;
      }
      
      var startTime = Date.now();
      var checkInterval = setInterval(function() {
        if (this.isAvailable(functionName)) {
          clearInterval(checkInterval);
          resolve(window[functionName]);
        } else if (Date.now() - startTime > timeout) {
          clearInterval(checkInterval);
          reject(new Error('Function ' + functionName + ' not available after ' + timeout + 'ms'));
        }
      }, 100);
    });
  }
};

// =============================================================================
// ADDITIONAL UI FUNCTIONS - Critical functions that were missing
// =============================================================================

// Update form URL display (minimal implementation)
function updateFormUrlDisplay(status = null) {
  // Try to use the full implementation if available
  if (typeof window._fullUpdateFormUrlDisplay === 'function') {
    try {
      return window._fullUpdateFormUrlDisplay(status);
    } catch (error) {
      console.warn('Full updateFormUrlDisplay failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential form URL updates
  console.log('updateFormUrlDisplay: Using minimal implementation');
  
  try {
    var formUrlInput = document.getElementById('form-url-input');
    if (!formUrlInput) return;
    
    var currentStatusToUse = status || window.currentStatus;
    if (!currentStatusToUse || !currentStatusToUse.userInfo) {
      console.warn('‚ö†Ô∏è updateFormUrlDisplay: statusÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
      return;
    }
    
    // Simple form URL extraction
    var formUrl = null;
    if (currentStatusToUse.userInfo.configJson) {
      try {
        var config = typeof currentStatusToUse.userInfo.configJson === 'string' 
          ? JSON.parse(currentStatusToUse.userInfo.configJson) 
          : currentStatusToUse.userInfo.configJson;
        formUrl = config.formUrl;
      } catch (e) {
        console.warn('Failed to parse configJson for form URL');
      }
    }
    
    if (formUrl) {
      formUrlInput.value = formUrl;
      var openFormLink = document.getElementById('open-form-url-link');
      if (openFormLink) {
        openFormLink.href = formUrl;
      }
    }
  } catch (error) {
    console.error('Error in minimal updateFormUrlDisplay:', error);
  }
}

// Populate header options (minimal implementation)
function populateHeaderOptions(headers) {
  // Try to use the full implementation if available
  if (typeof window._fullPopulateHeaderOptions === 'function') {
    try {
      return window._fullPopulateHeaderOptions(headers);
    } catch (error) {
      console.warn('Full populateHeaderOptions failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential header population
  console.log('populateHeaderOptions: Using minimal implementation');
  
  try {
    if (window.populateHeaderOptionsRunning) {
      return;
    }
    window.populateHeaderOptionsRunning = true;
    
    var selects = ['opinionHeader', 'reason-column', 'name-column', 'class-column'];
    
    selects.forEach(function(selectId) {
      var select = document.getElementById(selectId);
      if (select) {
        var currentValue = select.value;
        
        if (headers && headers.length > 0) {
          select.innerHTML = '<option value="">-- Âàó„ÇíÈÅ∏Êäû --</option>';
          headers.forEach(function(header) {
            if (header && typeof header === 'string' && header.trim()) {
              var option = document.createElement('option');
              option.value = header;
              option.textContent = header;
              select.appendChild(option);
            }
          });
          select.disabled = false;
          if (currentValue) {
            select.value = currentValue;
          }
        } else {
          select.innerHTML = '<option value="">-- „Ç∑„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>';
          select.disabled = true;
        }
      }
    });
    
    setTimeout(function() {
      window.populateHeaderOptionsRunning = false;
    }, 100);
  } catch (error) {
    console.error('Error in minimal populateHeaderOptions:', error);
    window.populateHeaderOptionsRunning = false;
  }
}

// Make all critical functions globally available immediately
window.toggleSection = toggleSection;
window.hidePrivacyModal = hidePrivacyModal;
window.hideDigitalCitizenshipModal = hideDigitalCitizenshipModal;
window.hideConfirmationModal = hideConfirmationModal;
window.showFormConfigModal = showFormConfigModal;
window.showMessage = showMessage; // Unified with SharedUtilities MessageManager
window.updateUIWithNewStatus = updateUIWithNewStatus;
window.validateConfig = validateConfig;
window.updateConfigButtons = updateConfigButtons;
// Populate configuration (minimal implementation)
function populateConfig(cfg) {
  // Â±•Ê≠¥Âæ©ÂÖÉ‰∏≠„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºà„Åü„Å†„Åó„ÄÅ„Éâ„É©„Éï„Éà„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØÈô§„ÅèÔºâ
  if ((window._historyRestoreInProgress || window._historyColumnSelections) && !window._draftModeActive) {
    console.log('üõ°Ô∏è populateConfig: Â±•Ê≠¥Âæ©ÂÖÉ‰∏≠„ÅÆ„Åü„ÇÅÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åó„Åü');
    return;
  }
  
  // „Éâ„É©„Éï„Éà„É¢„Éº„ÉâÊôÇ„ÅÆ„É≠„Ç∞Âá∫Âäõ
  if (window._draftModeActive) {
    console.log('üìù populateConfig: „Éâ„É©„Éï„Éà„É¢„Éº„Éâ„ÅßË®≠ÂÆö„ÇíÂèçÊò†‰∏≠');
  }
  
  // Try to use the full implementation if available
  if (typeof window._fullPopulateConfig === 'function') {
    try {
      return window._fullPopulateConfig(cfg);
    } catch (error) {
      console.warn('Full populateConfig failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential config population
  console.log('populateConfig: Using minimal implementation');
  
  try {
    if (!cfg) return;
    
    if (window.populateConfigRunning) {
      return;
    }
    window.populateConfigRunning = true;
    
    var mappings = {
      'opinionHeader': cfg.opinionHeader || cfg.opinionColumn,
      'reason-column': cfg.reasonColumn || cfg.reasonHeader,
      'name-column': cfg.nameColumn || cfg.nameHeader,
      'class-column': cfg.classColumn || cfg.classHeader,
      'show-names': cfg.showNames,
      'show-counts': cfg.showCounts
    };
    
    Object.keys(mappings).forEach(function(elementId) {
      var element = document.getElementById(elementId);
      var value = mappings[elementId];
      
      if (element && value !== undefined) {
        if (element.type === 'checkbox') {
          element.checked = Boolean(value);
        } else {
          element.value = value;
        }
      }
    });
    
    setTimeout(function() {
      window.populateConfigRunning = false;
    }, 100);
  } catch (error) {
    console.error('Error in minimal populateConfig:', error);
    window.populateConfigRunning = false;
  }
}

window.updateFormUrlDisplay = updateFormUrlDisplay;
window.populateHeaderOptions = populateHeaderOptions;
window.populateConfig = populateConfig;
window.checkFunctionAvailability = checkFunctionAvailability;
window.safeCallFunction = safeCallFunction;

// Register all critical functions
var criticalFunctions = [
  'toggleSection', 'hidePrivacyModal', 'hideDigitalCitizenshipModal', 
  'hideConfirmationModal', 'showFormConfigModal', 'showMessage', 
  'updateUIWithNewStatus', 'validateConfig', 'updateConfigButtons', 
  'updateFormUrlDisplay', 'populateHeaderOptions', 'populateConfig',
  'navigateToStep', 'initializeAdminPanel'
];

criticalFunctions.forEach(function(funcName) {
  window.AdminPanel.functionRegistry.register(funcName);
});

// Full implementation monitoring with periodic checks
var fullImplCheckCount = 0;
var maxFullImplChecks = 10;

function checkFullImplementationsAvailability() {
  fullImplCheckCount++;
  var foundCount = window.AdminPanel.functionRegistry.checkForFullImplementations();
  
  if (foundCount > 0) {
    console.log('üéâ Found ' + foundCount + ' full implementations on attempt ' + fullImplCheckCount);
    
    // Force retry of UI updates with full implementations now available
    if (window.currentStatus && foundCount >= 3) {
      console.log('üîÑ Retrying UI updates with full implementations');
      setTimeout(function() {
        if (typeof window._fullUpdateUIWithNewStatus === 'function') {
          window._fullUpdateUIWithNewStatus(window.currentStatus);
        }
      }, 100);
    }
  } else if (fullImplCheckCount < maxFullImplChecks) {
    // Continue checking for full implementations
    setTimeout(checkFullImplementationsAvailability, 500);
  } else {
    console.warn('‚ö†Ô∏è Full implementations not found after maximum attempts');
  }
}

// Start monitoring for full implementations after a delay
setTimeout(checkFullImplementationsAvailability, 300);

// =============================================================================
// SYSTEM STATUS AND USER INTERACTION MANAGEMENT
// =============================================================================

// „Ç∑„Çπ„ÉÜ„É†Áõ£Ë¶ñÁî®„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
window.systemStatus = {
  initializationStarted: false,
  coreInitialized: false,
  apiInitialized: false,
  uiInitialized: false,
  eventsInitialized: false,
  initializationComplete: false,
  userDataSyncComplete: false,
  errors: [],
  lastActivity: Date.now()
};

// ÂàùÊúüÂåñ‰∏≠„ÅÆ„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÈò≤Ê≠¢ - DOMÊ∫ñÂÇôÂÆå‰∫ÜÂæå„Å´ÂÆüË°å
if (document.body) {
  document.body.style.pointerEvents = 'none';
  console.log('üõ°Ô∏è User interaction disabled during initialization');
} else {
  // DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„Åã„ÇâÂÆüË°å
  document.addEventListener('DOMContentLoaded', function() {
    if (document.body) {
      document.body.style.pointerEvents = 'none';
      console.log('üõ°Ô∏è User interaction disabled during initialization (delayed)');
    }
  });
}

// ‰∏ªË¶Å„Å™UIË¶ÅÁ¥†„ÇíÁÑ°ÂäπÂåñ„Åô„ÇãÈñ¢Êï∞
function disableUserInteraction() {
  // DOMÊ∫ñÂÇôÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
  if (!document || !document.body) {
    console.warn('‚ö†Ô∏è DOM not ready for disableUserInteraction');
    return;
  }
  
  // „Éï„Ç©„Éº„É†Ë¶ÅÁ¥†„ÅÆÁÑ°ÂäπÂåñ
  var forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(function(element) {
    element.disabled = true;
    element.style.opacity = '0.6';
  });
  
  // „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å™Ë¶ÅÁ¥†„ÅÆÁÑ°ÂäπÂåñ
  var clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(function(element) {
    element.style.pointerEvents = 'none';
    element.style.opacity = '0.6';
  });
  
  // bodyË¶ÅÁ¥†„ÅÆÁÑ°ÂäπÂåñ
  document.body.style.pointerEvents = 'none';
  
  console.log('üõ°Ô∏è All interactive elements disabled');
}

// UIË¶ÅÁ¥†„ÇíÊúâÂäπÂåñ„Åô„ÇãÈñ¢Êï∞
function enableUserInteraction() {
  // DOMÊ∫ñÂÇôÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
  if (!document || !document.body) {
    console.warn('‚ö†Ô∏è DOM not ready for enableUserInteraction');
    return;
  }
  
  // „Éï„Ç©„Éº„É†Ë¶ÅÁ¥†„ÅÆÊúâÂäπÂåñ
  var forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(function(element) {
    element.disabled = false;
    element.style.opacity = '';
  });
  
  // „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å™Ë¶ÅÁ¥†„ÅÆÊúâÂäπÂåñ
  var clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(function(element) {
    element.style.pointerEvents = '';
    element.style.opacity = '';
  });
  
  // bodyË¶ÅÁ¥†„ÇÇÊúâÂäπÂåñ
  document.body.style.pointerEvents = 'auto';
  
  console.log('‚úÖ All interactive elements enabled');
}

// DOMË™≠„ÅøËæº„ÅøÂæå„Å´Ë¶ÅÁ¥†„ÇíÁÑ°ÂäπÂåñ
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', disableUserInteraction);
} else {
  disableUserInteraction();
}

function updateSystemStatus(component, status, error = null) {
  window.systemStatus[component] = status;
  window.systemStatus.lastActivity = Date.now();
  if (error) {
    window.systemStatus.errors.push({ component, error: error.toString(), timestamp: Date.now() });
  }
  logDebug('üìä System Status: ' + component + ' = ' + status);
}

// ÂÖ¨ÈñãÂÅúÊ≠¢Âæå„ÅÆÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥Â±ïÈñãÂá¶ÁêÜ
function checkAndExpandAllSections() {
  try {
    var expandAllFlag = localStorage.getItem('expandAllSections');
    if (expandAllFlag === 'true') {
      logInfo('üìÇ ÂÖ¨ÈñãÂÅúÊ≠¢Âæå„ÅÆ„Åü„ÇÅÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂ±ïÈñã„Åó„Åæ„Åô');
      
      // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„Åã„Çâ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂ±ïÈñãÔºàDOMË¶ÅÁ¥†„ÅÆÊ∫ñÂÇô„ÇíÂæÖ„Å§Ôºâ
      setTimeout(function() {
        var sectionIds = ['step1-content', 'step2-content', 'step3-content'];
        var expandedCount = 0;
        
        sectionIds.forEach(function(sectionId) {
          var section = document.getElementById(sectionId);
          if (section) {
            // „Çª„ÇØ„Ç∑„Éß„É≥„ÅåÊäò„Çä„Åü„Åü„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂ±ïÈñã
            if (section.classList.contains('hidden')) {
              if (typeof toggleSection === 'function') {
                toggleSection(sectionId);
                expandedCount++;
                logDebug('‚úÖ „Çª„ÇØ„Ç∑„Éß„É≥Â±ïÈñã: ' + sectionId);
              }
            }
          }
        });
        
        if (expandedCount > 0) {
          logInfo('üìÇ ' + expandedCount + 'ÂÄã„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂ±ïÈñã„Åó„Åæ„Åó„Åü');
        }
        
        // „Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢Ôºà‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°åÔºâ
        localStorage.removeItem('expandAllSections');
        logDebug('üßπ ÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥Â±ïÈñã„Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
      }, 500);
    }
  } catch (error) {
    logWarn('‚ö†Ô∏è ÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥Â±ïÈñãÂá¶ÁêÜ„Åß„Ç®„É©„Éº:', error);
  }
}

// =============================================================================
// MASTER INITIALIZATION SYSTEM
// =============================================================================

function initializeAdminPanelMaster() {
  // „Ç∑„É≥„Éó„É´Âåñ: ÈáçË§áÂàùÊúüÂåñ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁ∞°Á¥†Âåñ
  if (window.AdminPanel.initialization.isCompleted) {
    logDebug('‚úÖ AdminPanel already initialized');
    return;
  }
  
  window.AdminPanel.initialization.isInProgress = true;
  logInfo('üöÄ AdminPanel Master Initialization Started');
  
  // Phase 1: CoreÂàùÊúüÂåñ
  try {
    initCore();
  } catch (error) {
    console.error('‚ùå Core initialization failed:', error);
  }
  
  // ÂÖ¨ÈñãÂÅúÊ≠¢Âæå„ÅÆÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥Â±ïÈñãÂá¶ÁêÜ
  checkAndExpandAllSections();
  
  // „Éï„Ç©„Éº„É†‰ΩúÊàêÂÆå‰∫ÜË°®Á§∫„Çí„ÇØ„É™„Ç¢ÔºàÊñ∞Ë¶è„Ç¢„ÇØ„Çª„ÇπÊôÇ„ÅØ„Éá„Éï„Ç©„É´„Éà„ÅßÈùûË°®Á§∫Ôºâ
  setTimeout(function() {
    var formJustCreated = sessionStorage.getItem('form_just_created');
    if (formJustCreated !== 'true') {
      // Êñ∞Ë¶è‰ΩúÊàê„Åß„ÅØ„Å™„ÅÑÂ†¥Âêà„ÄÅ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
      var formUrlSection = document.getElementById('form-url-section');
      if (formUrlSection && !formUrlSection.classList.contains('hidden')) {
        formUrlSection.classList.add('hidden');
        logDebug('üìã Êó¢Â≠ò„Ç¢„ÇØ„Çª„ÇπÊôÇ„ÅØ„Éï„Ç©„Éº„É†ÂÆå‰∫Ü„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫');
      }
    }
  }, 100);
  
  // Phase 2: ÂêÑ„É¢„Ç∏„É•„Éº„É´„Çí‰∏¶ÂàóÂàùÊúüÂåñ („Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂêë‰∏ä)
  // ÈÅÖÂª∂„ÇíÊúÄÂ∞èÈôê„Å´ÊäëÂà∂„Åó„Å¶Âç≥Â∫ß„Å´ÂàùÊúüÂåñ
  setTimeout(function() {
    logDebug('üîß Phase 2: ‰∏¶Âàó„É¢„Ç∏„É•„Éº„É´ÂàùÊúüÂåñÈñãÂßã');
    
    // StatusÁÆ°ÁêÜÂàùÊúüÂåñ
    try {
      initializeMessageArea();
      logDebug('‚úÖ Status module initialized');
    } catch (error) {
      logError('‚ùå Status module initialization failed:', error);
    }
    
    // APIÈÄö‰ø°ÂàùÊúüÂåñ
    try {
      logDebug('üöÄ API module initialization...');
      initializeAPI();
      logDebug('‚úÖ API module initialized');
    } catch (error) {
      console.error('‚ùå API initialization failed:', error);
    }
    
    // UIÂàùÊúüÂåñ
    try {
      initializeUI();
      logDebug('‚úÖ UI module initialized');
    } catch (error) {
      console.error('‚ùå UI initialization failed:', error);
    }
    
    // „Éï„Ç©„Éº„É†ÁÆ°ÁêÜÂàùÊúüÂåñ
    try {
      setupCharacterCounters();
      setupModalCharacterCounters();
      logDebug('‚úÖ Forms module initialized');
    } catch (error) {
      logError('‚ùå Forms module initialization failed:', error);
    }
    
    // „Ç§„Éô„É≥„ÉàÁÆ°ÁêÜÂàùÊúüÂåñÔºàÊúÄÂæå„Å´ÂÆüË°åÔºâ
    setTimeout(function() {
      try {
        initializeEventListeners();
        logDebug('‚úÖ Events module initialized');
        logInfo('üéâ AdminPanel Master Initialization Complete');
        
        // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆÂêåÊúü„Å®ÊúÄÁµÇÂá¶ÁêÜ
        finalizeInitialization();
        
      } catch (error) {
        updateSystemStatus('eventsInitialized', false, error);
        console.error('‚ùå Events initialization failed:', error);
        
        // „Ç®„É©„Éº„Åß„ÇÇÊúÄÁµÇÂá¶ÁêÜ„ÅØÂÆüË°å
        finalizeInitialization();
      }
    }, 100);
    
  }, 10);
}

// Finalize initialization and enable user interaction
async function finalizeInitialization() {
  setTimeout(function() {
    try {
      console.log('üîÑ Final initialization steps...');
      
      // „Åô„Åπ„Å¶„ÅÆÂêåÊúü„ÅåÂÆå‰∫Ü„Åó„Åü„Çâ„É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÈùûË°®Á§∫
      if (window.unifiedLoading) {
        window.unifiedLoading.hide();
      } else {
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Áõ¥Êé•DOMÊìç‰Ωú
        var overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.add('hidden');
        }
      }
      
      // UIË¶ÅÁ¥†„ÅÆÊúâÂäπÂåñ
      enableUserInteraction();
      
      // Initialize and load history table after all initialization is complete
      try {
        console.log('üîÑ Initializing HistoryManager...');
        if (window.HistoryManager) {
          window.HistoryManager.initialize();
          console.log('üîÑ Loading history table after initialization...');
          window.HistoryManager.renderTable();
        } else {
          console.warn('‚ö†Ô∏è HistoryManager not available yet');
        }
      } catch (historyError) {
        console.warn('‚ö†Ô∏è History initialization/loading failed:', historyError);
      }
      
      // Draft recovery after initialization complete
      try {
        console.log('üîÑ Checking for draft recovery...');
        if (typeof recoverDraftIfAvailable === 'function') {
          recoverDraftIfAvailable();
        }
      } catch (draftError) {
        console.warn('‚ö†Ô∏è Draft recovery failed:', draftError);
      }
      
      // ÂàùÊúüÂåñÂÆå‰∫Ü
      window.AdminPanel.initialization.isInProgress = false;
      window.AdminPanel.initialization.isCompleted = true;
      logInfo('‚úÖ AdminPanel Master Initialization Completed');
      
    } catch (error) {
      console.error('‚ùå Final sync error:', error);
      // „Ç®„É©„Éº„Åß„ÇÇ„É≠„Éº„Éá„Ç£„É≥„Ç∞„ÅØËß£Èô§
      if (window.unifiedLoading) {
        window.unifiedLoading.hide();
      }
      enableUserInteraction();
      
      // ÂàùÊúüÂåñÂÆå‰∫ÜÔºà„Ç®„É©„Éº„ÅÇ„Çä„Åß„ÇÇÔºâ
      window.AdminPanel.initialization.isInProgress = false;
      window.AdminPanel.initialization.isCompleted = true;
      logWarn('‚ö†Ô∏è AdminPanel initialization completed with errors');
    }
  }, 500);
}

// Âçò‰∏ÄDOMContentLoaded„Éè„É≥„Éâ„É©„Éº
if (document.readyState !== 'loading') {
  initializeAdminPanelMaster();
} else {
  document.addEventListener('DOMContentLoaded', initializeAdminPanelMaster);
}

// Update layout on resize
window.addEventListener('resize', function() {
  if (typeof debounce === 'function') {
    debounce(adjustLayout, 250, 'layout-resize')();
  } else {
    // Fallback without debounce
    adjustLayout();
  }
});

// Account management modal functionality has been removed
// Individual user access control is now handled in AppSetupPage.html
/*
  
  // Setup event listeners
  setupEventListeners: function() {
    var accountBtn = document.getElementById('account-management-btn');
    var closeBtn = document.getElementById('account-modal-close');
    var cancelBtn = document.getElementById('account-modal-cancel');
    var saveBtn = document.getElementById('save-access-settings');
    var deleteBtn = document.getElementById('delete-account-btn');
    var toggle = document.getElementById('user-access-toggle');
    
    if (accountBtn) {
      accountBtn.addEventListener('click', function() { self.openModal(); });
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', function() { self.closeModal(); });
    }
    
    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => this.closeModal());
    }
    
    if (saveBtn) {
      saveBtn.addEventListener('click', () => this.saveAccessSettings());
    }
    
    if (deleteBtn) {
      deleteBtn.addEventListener('click', () => this.handleDeleteAccount());
    }
    
    if (toggle) {
      toggle.addEventListener('change', () => this.onToggleChange());
    }
    
    // Close modal on backdrop click
    if (this.modal) {
      this.modal.addEventListener('click', (e) => {
        if (e.target === this.modal) {
          this.closeModal();
        }
      });
    }
  },
  
  // Open modal and load current status
  openModal: function() {
    if (!this.modal) return;
    
    this.modal.classList.remove('hidden');
    this.modal.classList.add('flex');
    this.modal.setAttribute('aria-hidden', 'false');
    
    // Focus management for accessibility
    var firstFocusable = this.modal.querySelector('button, input, textarea, select, [tabindex]:not([tabindex="-1"])');
    if (firstFocusable) {
      setTimeout(function() { firstFocusable.focus(); }, 100);
    }
    
    // Load current user access status
    this.loadCurrentStatus();
    
    logDebug('üìù Account management modal opened');
  },
  
  // Close modal
  closeModal: function() {
    if (!this.modal) return;
    
    this.modal.classList.add('hidden');
    this.modal.classList.remove('flex');
    this.modal.setAttribute('aria-hidden', 'true');
    
    // Reset form state
    this.resetForm();
    
    logDebug('‚ùå Account management modal closed');
  },
  
  // Load current user access status
  loadCurrentStatus: function() {
    var statusElement = document.getElementById('user-access-status');
    var toggle = document.getElementById('user-access-toggle');
    
    if (statusElement) {
      statusElement.textContent = 'üîÑ Ë™≠„ÅøËæº„Åø‰∏≠...';
      statusElement.className = 'ml-2 px-2 py-1 rounded-full text-xs font-medium bg-gray-600 text-gray-300';
    }
    
    if (toggle) {
      toggle.disabled = true;
    }
    
    // Get current user status from the global status
    if (window.currentStatus && window.currentStatus.userInfo) {
      var userInfo = window.currentStatus.userInfo;
      var isActive = userInfo.isActive !== false; // Default to true if not specified
      
      this.updateStatusDisplay(isActive);
      
      if (toggle) {
        toggle.checked = isActive;
        toggle.disabled = false;
      }
      
      this.currentUserStatus = isActive;
      logDebug('üìä Current user isActive status: ' + isActive);
    } else {
      // Fallback: call API to get current status
      if (typeof runGasWithUserId === 'function') {
        runGasWithUserId('getUserActiveStatus')
          .then(function(result) {
            if (result && typeof result.isActive === 'boolean') {
              var isActive = result.isActive;
              this.updateStatusDisplay(isActive);
              
              if (toggle) {
                toggle.checked = isActive;
                toggle.disabled = false;
              }
              
              this.currentUserStatus = isActive;
            } else {
              this.showStatusError('„É¶„Éº„Ç∂„ÉºÁä∂ÊÖã„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
          })
          .catch(function(error) {
            console.error('‚ùó Failed to load user status:', error);
            this.showStatusError('„É¶„Éº„Ç∂„ÉºÁä∂ÊÖã„ÅÆÂèñÂæó„Ç®„É©„Éº');
          });
      } else {
        this.showStatusError('API„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
      }
    }
  },
  
  // Update status display
  updateStatusDisplay: function(isActive) {
    var statusElement = document.getElementById('user-access-status');
    if (!statusElement) return;
    
    if (isActive) {
      statusElement.textContent = '‚úÖ ÊúâÂäπ';
      statusElement.className = 'ml-2 px-2 py-1 rounded-full text-xs font-medium bg-green-600 text-white';
    } else {
      statusElement.textContent = '‚ùå ÁÑ°Âäπ';
      statusElement.className = 'ml-2 px-2 py-1 rounded-full text-xs font-medium bg-red-600 text-white';
    }
  },
  
  // Show status error
  showStatusError: function(message) {
    var statusElement = document.getElementById('user-access-status');
    var toggle = document.getElementById('user-access-toggle');
    
    if (statusElement) {
      statusElement.textContent = '‚ùó ' + message;
      statusElement.className = 'ml-2 px-2 py-1 rounded-full text-xs font-medium bg-yellow-600 text-white';
    }
    
    if (toggle) {
      toggle.disabled = true;
    }
  },
  
  // Handle toggle change
  onToggleChange: function() {
    var toggle = document.getElementById('user-access-toggle');
    var saveBtn = document.getElementById('save-access-settings');
    
    if (toggle && saveBtn) {
      var hasChanges = toggle.checked !== this.currentUserStatus;
      saveBtn.disabled = !hasChanges;
      
      if (hasChanges) {
        saveBtn.textContent = 'Ë®≠ÂÆö„Çí‰øùÂ≠ò';
        saveBtn.classList.remove('bg-gray-600', 'cursor-not-allowed');
        saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
      } else {
        saveBtn.textContent = 'Â§âÊõ¥„Å™„Åó';
        saveBtn.classList.add('bg-gray-600', 'cursor-not-allowed');
        saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
      }
    }
  },
  
  // Save access settings
  saveAccessSettings: function() {
    var toggle = document.getElementById('user-access-toggle');
    var saveBtn = document.getElementById('save-access-settings');
    
    if (!toggle || toggle.disabled) return;
    
    var newStatus = toggle.checked;
    var originalText = saveBtn.textContent;
    
    // Update UI
    saveBtn.disabled = true;
    saveBtn.textContent = 'üîÑ ‰øùÂ≠ò‰∏≠...';
    
    if (typeof runGasWithUserId === 'function') {
      runGasWithUserId('updateSelfActiveStatus', false, userId, newStatus)
        .then(function(result) {
          if (result && result.success) {
            this.currentUserStatus = newStatus;
            this.updateStatusDisplay(newStatus);
            
            // Show success message
            if (window.showMessage) {
              showMessage('‚úÖ „Ç¢„ÇØ„Çª„ÇπË®≠ÂÆö„Çí' + (newStatus ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ') + '„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü', 'success');
            }
            
            // Close modal after short delay
            setTimeout(function() {
              this.closeModal();
            }, 1500);
            
          } else {
            throw new Error(result.message || 'Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        })
        .catch(function(error) {
          console.error('‚ùó Failed to save access settings:', error);
          
          // Revert toggle state
          toggle.checked = this.currentUserStatus;
          
          // Show error message
          if (window.showMessage) {
            showMessage('‚ùå Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || error), 'error');
          }
        })
        .finally(function() {
          // Reset button state
          saveBtn.textContent = originalText;
          this.onToggleChange(); // Re-evaluate button state
        });
    } else {
      console.error('‚ùó runGasWithUserId function not available');
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
      
      if (window.showMessage) {
        showMessage('‚ùå API„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì', 'error');
      }
    }
  },
  
  // Handle account deletion
  handleDeleteAccount: function() {
    // Use existing delete account functionality
    if (typeof handleDeleteRequest === 'function') {
      this.closeModal(); // Close the modal first
      setTimeout(function() {
        handleDeleteRequest(); // Call existing delete function
      }, 300);
    } else {
      console.error('‚ùó handleDeleteRequest function not available');
      if (window.showMessage) {
        showMessage('‚ùå „Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§Ê©üËÉΩ„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì', 'error');
      }
    }
  },
  
  // Reset form state
  resetForm: function() {
    var toggle = document.getElementById('user-access-toggle');
    var saveBtn = document.getElementById('save-access-settings');
    
    if (toggle && this.currentUserStatus !== null) {
      toggle.checked = this.currentUserStatus;
      toggle.disabled = false;
    }
    
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Ë®≠ÂÆö„Çí‰øùÂ≠ò';
      saveBtn.classList.add('bg-gray-600', 'cursor-not-allowed');
      saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    }
  }

*/
// Account management initialization has been removed

// =============================================================================
// UNIFIED HISTORY MANAGEMENT SYSTEM 
// =============================================================================

/**
 * Unified History Manager - Simple, Error-Resilient, Single Responsibility
 */
window.HistoryManager = {
  // Constants
  STORAGE_KEY: 'answerBoardHistory',
  OLD_STORAGE_KEY: 'adminPanelHistory', // For migration
  MAX_ITEMS: 5,
  
  // Initialization state
  _initialized: false,
  
  /**
   * Initialize the History Manager
   */
  initialize() {
    try {
      if (this._initialized) {
        console.log('üîÑ HistoryManager already initialized');
        return true;
      }
      
      console.log('üöÄ HistoryManager initializing...');
      
      // Migrate old data if exists
      this._migrateOldData();
      
      this._initialized = true;
      return true;
      
    } catch (error) {
      console.error('‚ùå HistoryManager initialization failed:', error);
      return false;
    }
  },
  
  /**
   * Migrate data from old storage key to new key
   */
  _migrateOldData() {
    try {
      var oldData = localStorage.getItem(this.OLD_STORAGE_KEY);
      var newData = localStorage.getItem(this.STORAGE_KEY);
      
      if (oldData && !newData) {
        console.log('üîÑ Migrating history data from old key...');
        localStorage.setItem(this.STORAGE_KEY, oldData);
        localStorage.removeItem(this.OLD_STORAGE_KEY);
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è History data migration failed:', error);
    }
  },
  
  /**
   * Load history from localStorage with error handling
   */
  load() {
    try {
      console.log('üîÑ Loading history from localStorage...');
      var data = localStorage.getItem(this.STORAGE_KEY);
      var parsed = data ? JSON.parse(data) : [];
      var validated = Array.isArray(parsed) ? parsed : [];
      console.log('‚úÖ Loaded ' + validated.length + ' history items');
      return validated;
    } catch (error) {
      console.error('‚ùå Failed to load history:', error);
      return [];
    }
  },
  
  /**
   * Save history to localStorage with error handling
   */
  save(items) {
    try {
      var safeItems = Array.isArray(items) ? items : [];
      var limitedItems = safeItems.slice(0, this.MAX_ITEMS);
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(limitedItems));
      console.log('‚úÖ Saved ' + limitedItems.length + ' history items');
      return true;
    } catch (error) {
      console.error('‚ùå Failed to save history:', error);
      return false;
    }
  },
  
  /**
   * Add new item to history
   */
  add(newItem) {
    try {
      if (!newItem || !newItem.id) {
        console.warn('‚ö†Ô∏è Invalid history item provided');
        return false;
      }
      
      var history = this.load();
      history.unshift(newItem);
      return this.save(history);
    } catch (error) {
      console.error('‚ùå Failed to add history item:', error);
      return false;
    }
  },
  
  /**
   * Clear all history
   */
  clear() {
    try {
      localStorage.removeItem(this.STORAGE_KEY);
      localStorage.removeItem(this.OLD_STORAGE_KEY); // Clean old key too
      return true;
    } catch (error) {
      console.error('‚ùå Failed to clear history:', error);
      return false;
    }
  },
  /**
   * Format date for created date column (Êó•‰ªò„ÅÆ„ÅøË°®Á§∫)
   */
  _formatCreatedDate(dateStr) {
    if (!dateStr) return 'Êú™Ë®≠ÂÆö';
    try {
      var date = new Date(dateStr);
      return date.toLocaleDateString('ja-JP', {
        month: '2-digit',
        day: '2-digit'
      }).replace(/\//g, '/');  // "08/12" ÂΩ¢Âºè
    } catch {
      return dateStr;
    }
  },

  /**
   * Format date for published date column (Âπ¥2Ê°ÅÁúÅÁï• + ÊôÇÈñì‰ªò„Åç)
   */
  _formatPublishedDate(dateStr) {
    if (!dateStr) return 'Êú™Ë®≠ÂÆö';
    try {
      var date = new Date(dateStr);
      return date.toLocaleString('ja-JP', {
        year: '2-digit',  // 25Âπ¥Ë°®Á§∫
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }).replace(/\//g, '/');  // "25/08/12 08:45" ÂΩ¢Âºè
    } catch {
      return dateStr;
    }
  },

  /**
   * Format settings display with icons and clear meanings (showNames/showCounts based)
   */
  _formatSettingsDisplay(item) {
    // showNames„Éô„Éº„Çπ„ÅÆÂà§ÂÆöÔºà‰∏ã‰Ωç‰∫íÊèõÊÄß„ÇÇËÄÉÊÖÆÔºâ
    var isShowNames = false;
    if (item.showNames !== undefined) {
      isShowNames = item.showNames;
    } else if (item.displayMode !== undefined) {
      // Êóß„Éá„Éº„ÇøÂØæÂøú
      isShowNames = item.displayMode === 'named';
    }
    
    var displayPart = isShowNames ? 'üë•ÈÄöÂ∏∏' : 'üé≠ÂåøÂêç';
    var countPart = item.showCounts ? 'üî¢Ë°®Á§∫' : 'üö´ÈùûË°®Á§∫';
    return displayPart + '/' + countPart;
  },

  /**
   * Render history table in the UI
   */
  renderTable() {
    try {
      if (!this._initialized) {
        console.warn('‚ö†Ô∏è HistoryManager not initialized, initializing now...');
        if (!this.initialize()) {
          console.error('‚ùå Cannot render table - initialization failed');
          return false;
        }
      }
      
      console.log('üîÑ Rendering history table...');
      var tableBody = document.getElementById('history-table-body');
      
      if (!tableBody) {
        console.warn('‚ùå History table body element not found');
        return false;
      }
      
      // Show loading state
      tableBody.innerHTML = `
        <tr>
          <td colspan="4" class="px-3 py-6 text-center text-gray-500 text-sm">
            <div class="flex flex-col items-center justify-center">
              <div class="spinner mb-3"></div>
              <div>Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
            </div>
          </td>
        </tr>
      `;
      
      // Load and display history
      var history = this.load();
      tableBody.innerHTML = '';
      
      if (history.length === 0) {
        this._renderEmptyState(tableBody);
        return true;
      }
      
      // Render history items
      var successCount = 0;
      history.forEach(function(item, index) {
        try {
          var row = this._createHistoryTableRow(item, index);
          if (row) {
            tableBody.appendChild(row);
            successCount++;
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Failed to render history item:', error);
        }
      });
      
      return true;
      
    } catch (error) {
      console.error('‚ùå Failed to render history table:', error);
      this._renderErrorState();
      return false;
    }
  },
  
  /**
   * Render empty state for history table
   */
  _renderEmptyState(tableBody) {
    var emptyRow = document.createElement('tr');
    emptyRow.innerHTML = `
      <td colspan="4" class="px-3 py-8 text-center text-gray-500 text-sm">
        <div class="flex flex-col items-center">
          <div class="text-4xl mb-2">üìù</div>
          <div class="font-medium mb-1">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
          <div class="text-xs text-gray-600">„Éï„Ç©„Éº„É†„ÇíÂÖ¨Èñã„Åô„Çã„Å®Â±•Ê≠¥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
        </div>
      </td>
    `;
    tableBody.appendChild(emptyRow);
  },
  
  /**
   * Render error state for history table
   */
  _renderErrorState() {
    var tableBody = document.getElementById('history-table-body');
    if (tableBody) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="4" class="px-3 py-4 text-center text-red-500 text-sm">
            Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü
          </td>
        </tr>
      `;
    }
  },
  
  /**
   * Create a table row for a history item
   */
  _createHistoryTableRow(item, index) {
    try {
      var row = document.createElement('tr');
      
      // Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºà‰ªïÊßò„Å´Âêà„Çè„Åõ„Å¶‰øÆÊ≠£Ôºâ
      var createdDate = this._formatCreatedDate(item.createdDate);      // "08/12"
      var publishedDate = this._formatPublishedDate(item.publishedAt);  // "25/08/12 08:45"
      
      // ÂïèÈ°åÊñáÂá¶ÁêÜ
      var question = this._escapeHtml(item.questionText || 'Êú™Ë®≠ÂÆö');
      var truncated = question.length > 30 ? question.substring(0, 30) + '...' : question;
      
      // Ë®≠ÂÆöË°®Á§∫Ôºà„Ç¢„Ç§„Ç≥„É≥/ÊÑèÂë≥ÊòéÁ¢∫ÂåñÔºâ
      var settingsDisplay = this._formatSettingsDisplay(item);
      
      // 4ÂàóHTMLÁîüÊàê
      row.innerHTML = `
        <td class="px-3 py-2 text-sm">${createdDate}</td>
        <td class="px-3 py-2 text-sm">${publishedDate}</td>
        <td class="px-3 py-2 text-sm" title="${question}">${truncated}</td>
        <td class="px-3 py-2 text-xs text-white">${settingsDisplay}</td>
      `;
      
      // Ë°å„ÇØ„É™„ÉÉ„ÇØÂæ©ÂÖÉÊ©üËÉΩÔºàÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´‰ªò„ÅçÔºâ
      row.style.cursor = 'pointer';
      row.classList.add('hover:bg-gray-700', 'transition-colors');
      row.addEventListener('click', function() {
        this._showRestoreConfirmationModal(item);
      });
      
      return row;
    } catch (error) {
      console.error('‚ùå Failed to create history table row:', error);
      return null;
    }
  },
  
  /**
   * Show restore confirmation modal
   */
  showRestoreModal(itemId) {
    try {
      var history = this.load();
      var item = history.find(function(h) { return h.id === itemId; });
      
      if (!item) {
        console.error('‚ùå History item not found:', itemId);
        return;
      }
      
      if (typeof showMessage === 'function') {
        showMessage('üîÑ Ë®≠ÂÆö„ÇíÂæ©ÂÖÉ‰∏≠...', 'info');
      }
      
      // Perform restoration
      this._restoreHistoryItem(item);
      
    } catch (error) {
      console.error('‚ùå Failed to show restore modal:', error);
    }
  },

  /**
   * Show restore confirmation modal before actually restoring
   */
  _showRestoreConfirmationModal(item) {
    try {
      // ÈáçË§áÂÆüË°åÈò≤Ê≠¢
      if (this._isRestoreInProgress) {
        console.log('‚ö†Ô∏è Restore already in progress, ignoring duplicate request');
        return;
      }
      
      console.log('üîÑ Showing restore confirmation modal for:', item.questionText);
      
      // Âæ©ÂÖÉ„Åô„ÇãË®≠ÂÆö„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíÊ∫ñÂÇô
      var formattedDate = this._formatCreatedDate(item.createdDate);
      var truncatedQuestion = item.questionText && item.questionText.length > 50 
        ? item.questionText.substring(0, 50) + '...' 
        : (item.questionText || 'Êú™Ë®≠ÂÆö');
      
      // ÁèæÂú®„ÅÆ„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
      var currentSpreadsheetId = window.currentStatus?.userInfo?.spreadsheetId || null;
      var targetSpreadsheetId = item.spreadsheetId || null;
      var hasSpreadsheetDifference = currentSpreadsheetId && targetSpreadsheetId && 
                                     currentSpreadsheetId !== targetSpreadsheetId;
      
      // Êã°Âºµ„Åï„Çå„Åü„É¢„Éº„ÉÄ„É´HTML„ÇíÁîüÊàê
      this._showEnhancedRestoreModal(item, {
        truncatedQuestion,
        formattedDate,
        hasSpreadsheetDifference,
        currentSpreadsheetId,
        targetSpreadsheetId
      });
      
    } catch (error) {
      console.error('‚ùå Failed to show restore confirmation modal:', error);
      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂÖÉ„ÅÆ„Ç∑„É≥„Éó„É´„É¢„Éº„ÉÄ„É´
      this._showFallbackRestoreModal(item);
    }
  },

  /**
   * Show enhanced restore confirmation modal with detailed layout
   */
  _showEnhancedRestoreModal(item, details) {
    var modal = document.getElementById('confirmation-modal');
    if (!modal) {
      console.warn('‚ö†Ô∏è confirmation-modal not found, using fallback');
      this._showFallbackRestoreModal(item);
      return;
    }

    // „Ç´„Çπ„Çø„É†HTML„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÁîüÊàê
    var modalContent = this._generateRestoreModalHTML(item, details);
    
    // „É¢„Éº„ÉÄ„É´„ÅÆÂÜÖÂÆπ„Çí‰∏ÄÊôÇÁöÑ„Å´ÁΩÆ„ÅçÊèõ„Åà
    var glassPanel = modal.querySelector('.glass-panel');
    var originalContent = glassPanel.innerHTML;
    glassPanel.innerHTML = modalContent;
    
    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    modal.classList.remove('hidden');
    
    // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„ÇíË®≠ÂÆö
    var confirmBtn = modal.querySelector('#restore-confirm-btn');
    var cancelBtn = modal.querySelector('#restore-cancel-btn');
    
    var cleanup = function() {
      // ÂÖÉ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Å´Êàª„Åô
      glassPanel.innerHTML = originalContent;
      modal.classList.add('hidden');
    };
    
    if (confirmBtn) {
      confirmBtn.onclick = function() {
        cleanup();
        console.log('‚úÖ User confirmed restoration');
        this._restoreHistoryItem(item);
      };
    }
    
    if (cancelBtn) {
      cancelBtn.onclick = function() {
        cleanup();
        console.log('‚ùå User cancelled restoration');
      };
    }
  },

  /**
   * Generate HTML content for enhanced restore modal
   */
  _generateRestoreModalHTML(item, details) {
    var truncatedQuestion = details.truncatedQuestion;
    var formattedDate = details.formattedDate;
    var hasSpreadsheetDifference = details.hasSpreadsheetDifference;
    var currentSpreadsheetId = details.currentSpreadsheetId;
    var targetSpreadsheetId = details.targetSpreadsheetId;
    
    // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàID„Çí„Éû„Çπ„ÇØË°®Á§∫Áî®„Å´Â§âÊèõ
    var maskSpreadsheetId = function(id) {
      if (!id || id.length < 8) return id || 'Êú™Ë®≠ÂÆö';
      return '...' + id.slice(-6);
    };
    
    var spreadsheetDiffSection = hasSpreadsheetDifference ? `
      <div class="bg-yellow-500/10 border border-yellow-400/30 rounded-lg p-4 mb-4">
        <h4 class="text-sm font-semibold text-yellow-400 mb-2 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h4a1 1 0 011 1v2h4a1 1 0 011 1v1a1 1 0 01-1 1H3a1 1 0 01-1-1V5a1 1 0 011-1h4zM7 8v8a2 2 0 002 2h2a2 2 0 002-2V8M7 8H5a2 2 0 00-2 2v6a2 2 0 002 2h2M13 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2"></path>
          </svg>
          üìÅ „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÂ§âÊõ¥
        </h4>
        <div class="text-xs text-yellow-100 space-y-1">
          <div><span class="text-yellow-200 font-medium">ÁèæÂú®:</span> ${maskSpreadsheetId(currentSpreadsheetId)}</div>
          <div><span class="text-yellow-200 font-medium">Âæ©ÂÖÉÂæå:</span> ${maskSpreadsheetId(targetSpreadsheetId)}</div>
        </div>
      </div>
    ` : '';
    
    return `
      <h3 class="text-xl font-bold text-orange-400 mb-4 flex items-center gap-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        üìã Â±•Ê≠¥Âæ©ÂÖÉ„ÅÆÁ¢∫Ë™ç
      </h3>
      <p class="text-gray-300 mb-4">
        ‰ª•‰∏ã„ÅÆË®≠ÂÆö„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºüÁèæÂú®„ÅÆË®≠ÂÆö„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ
      </p>
      
      <!-- Âæ©ÂÖÉ‰∫àÂÆö„ÅÆË®≠ÂÆöÊÉÖÂ†± -->
      <div class="bg-orange-500/10 border border-orange-400/30 rounded-lg p-4 mb-4">
        <h4 class="text-sm font-semibold text-orange-400 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          üìù Âæ©ÂÖÉ‰∫àÂÆö„ÅÆË®≠ÂÆö
        </h4>
        <div class="space-y-2 text-xs text-orange-100">
          <div><span class="text-orange-200 font-medium">ÂïèÈ°åÊñá:</span> ${truncatedQuestion}</div>
          <div><span class="text-orange-200 font-medium">„Ç∑„Éº„ÉàÂêç:</span> ${item.sheetName || 'Êú™Ë®≠ÂÆö'}</div>
          <div><span class="text-orange-200 font-medium">‰ΩúÊàêÊó•:</span> ${formattedDate}</div>
        </div>
      </div>
      
      ${spreadsheetDiffSection}
      
      <!-- Ë≠¶Âëä„É°„ÉÉ„Çª„Éº„Ç∏ -->
      <div class="bg-red-500/10 border border-red-400/30 rounded-lg p-3 mb-6">
        <p class="text-xs text-red-200 flex items-center gap-2">
          <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          „Åì„ÅÆÊìç‰Ωú„Å´„Çà„ÇäÁèæÂú®„ÅÆÊú™‰øùÂ≠ò„ÅÆË®≠ÂÆöÂÜÖÂÆπ„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åô„ÄÇ
        </p>
      </div>
      
      <div class="flex justify-end gap-3">
        <button type="button" id="restore-cancel-btn" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
        <button type="button" id="restore-confirm-btn" class="btn btn-primary">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Âæ©ÂÖÉ„Åô„Çã
        </button>
      </div>
    `;
  },

  /**
   * Fallback restore modal for compatibility
   */
  _showFallbackRestoreModal(item) {
    var formattedDate = this._formatCreatedDate(item.createdDate);
    var truncatedQuestion = item.questionText && item.questionText.length > 50 
      ? item.questionText.substring(0, 50) + '...' 
      : (item.questionText || 'Êú™Ë®≠ÂÆö');
    
    var title = 'Â±•Ê≠¥Âæ©ÂÖÉ„ÅÆÁ¢∫Ë™ç';
    var message = `‰ª•‰∏ã„ÅÆË®≠ÂÆö„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºüÁèæÂú®„ÅÆË®≠ÂÆö„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ

üìù ÂïèÈ°åÊñá: ${truncatedQuestion}
üìä „Ç∑„Éº„ÉàÂêç: ${item.sheetName || 'Êú™Ë®≠ÂÆö'}  
üìÖ ‰ΩúÊàêÊó•: ${formattedDate}

‚ö†Ô∏è „Åì„ÅÆÊìç‰Ωú„Å´„Çà„ÇäÁèæÂú®„ÅÆË®≠ÂÆöÂÜÖÂÆπ„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åô„ÄÇ`;

    // SharedModals„Ç∑„Çπ„ÉÜ„É†„ÇíÂÑ™ÂÖàÁöÑ„Å´‰ΩøÁî®
    if (window.sharedModals && typeof window.sharedModals.showConfirmation === 'function') {
      console.log('‚úÖ Using sharedModals.showConfirmation fallback');
      window.sharedModals.showConfirmation(
        title,
        message,
        function() {
          console.log('‚úÖ User confirmed restoration');
          this._restoreHistoryItem(item);
        },
        function() {
          console.log('‚ùå User cancelled restoration');
        }
      );
    } else if (typeof showConfirmationModal === 'function') {
      console.log('‚úÖ Using showConfirmationModal fallback');
      showConfirmationModal(
        title,
        message,
        function() {
          console.log('‚úÖ User confirmed restoration');
          this._restoreHistoryItem(item);
        }
      );
    } else {
      console.warn('‚ö†Ô∏è No confirmation modal system available, using browser confirm');
      if (confirm(title + '\n\n' + message.replace(/üìù|üìä|üìÖ|‚ö†Ô∏è/g, ''))) {
        console.log('‚úÖ User confirmed restoration via browser confirm');
        this._restoreHistoryItem(item);
      } else {
        console.log('‚ùå User cancelled restoration via browser confirm');
      }
    }
  },
  
  /**
   * Restore configuration from history item
   */
  async _restoreHistoryItem(item) {
    try {
      // ÈáçË§áÂÆüË°åÈò≤Ê≠¢
      if (this._isRestoreInProgress) {
        console.log('‚ö†Ô∏è Restore already in progress, skipping duplicate request');
        return;
      }
      
      this._isRestoreInProgress = true;
      
      console.log('üîÑ Restoring history:', item.questionText);
      console.log('üìä History item details:', {
        id: item.id,
        questionText: item.questionText,
        sheetName: item.sheetName,
        spreadsheetId: item.spreadsheetId,
        opinionHeader: item.opinionHeader,
        nameHeader: item.nameHeader
      });
      
      // AIÂàóÂà§ÂÆö„Å´„Çà„Çã‰∏äÊõ∏„Åç„ÇíÈò≤Ê≠¢„Åô„Çã„Éï„É©„Ç∞„ÇíË®≠ÂÆöÔºà„Éâ„É©„Éï„Éà„É¢„Éº„ÉâÔºâ
      window._historyRestoreInProgress = true;
      window._draftModeActive = true;
      console.log('üõ°Ô∏è AIÂàóÂà§ÂÆö„Çπ„Ç≠„ÉÉ„Éó„Éï„É©„Ç∞„ÇíË®≠ÂÆö„Åó„Åæ„Åó„ÅüÔºà„Éâ„É©„Éï„Éà„É¢„Éº„ÉâÔºâ');
      
      // 1. „ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆöÂæ©ÂÖÉÔºàÂÆüÂú®„Åô„ÇãË¶ÅÁ¥†ID„Å´‰øÆÊ≠£Ôºâ
      // ÂøÖÈ†à: ÂõûÁ≠î„Éá„Éº„ÇøÂàóÔºàopinionHeader „Çª„É¨„ÇØ„ÉàÔºâ
      (function restoreOpinionHeader() {
        var value = item.opinionHeader || item.opinionColumn || item.questionText || '';
        var opinionSelect = document.getElementById('opinionHeader');
        if (opinionSelect && value) {
          opinionSelect.value = value;
          console.log('‚úÖ Opinion header restored: ' + value);
        }
      })();
      
      // ÂèÇËÄÉ: ÂêçÂâçÂàó„ÅØ name-column „Çª„É¨„ÇØ„Éà„Çí‰ΩøÁî®Ôºàname-headerË¶ÅÁ¥†„ÅØÂ≠òÂú®„Åó„Å™„ÅÑÔºâ
      if (item.nameHeader) {
        var nameSelectEl = document.getElementById('name-column');
        if (nameSelectEl) nameSelectEl.value = item.nameHeader;
      }
      
      // 1.5. ÂàóÈÅ∏Êäû„ÅÆÂæ©ÂÖÉÔºàÂ±•Ê≠¥„Éá„Éº„Çø„Åã„ÇâÔºâ- Âº∑ÂåñÁâà
      console.log('üîÑ Restoring column selections from history');
      
      // Âæ©ÂÖÉ„Åô„ÇãÂàóÈÅ∏Êäû„Éá„Éº„Çø„ÇíÊ∫ñÂÇô„Åó„ÄÅ‰øùË≠∑Áî®„Å´‰øùÂ≠ò
      var columnSelections = {
        opinionHeader: item.opinionHeader || item.opinionColumn || item.questionText || '',
        nameColumn: item.nameHeader || item.nameColumn || '',
        classColumn: item.classColumn || '',
        reasonHeader: item.reasonHeader || ''
      };
      
      // „Ç∞„É≠„Éº„Éê„É´„Å´‰øùÂ≠ò„Åó„Å¶AIÊé®ÂÆö„Å´„Çà„Çã‰∏äÊõ∏„Åç„ÇíÈò≤„Åê
      window._historyColumnSelections = columnSelections;
      
      // DOMË¶ÅÁ¥†„Å∏„ÅÆÂÄ§Ë®≠ÂÆö„ÇíÈñ¢Êï∞Âåñ„Åó„Å¶Á¢∫ÂÆü„Å´ÂÆüË°å
      var setSelectValue = function(elementId, value, description) {
        if (!value) return;
        var element = document.getElementById(elementId);
        if (element) {
          element.value = value;
          // change „Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´„Åó„Å¶„ÄÅUI„ÅÆÊõ¥Êñ∞„Çí„Éà„É™„Ç¨„Éº
          element.dispatchEvent(new Event('change', { bubbles: true }));
          console.log('‚úÖ ' + description + ' restored: ' + value);
        } else {
          console.warn('‚ö†Ô∏è Element not found: ' + elementId);
        }
      };
      
      // ÂêÑÂàó„ÅÆÂæ©ÂÖÉ„ÇíÂÆüË°åÔºà„Éâ„É©„Éï„Éà„É¢„Éº„Éâ„ÅßÔºâ
      setSelectValue('opinionHeader', columnSelections.opinionHeader, 'Opinion header');
      setSelectValue('name-column', columnSelections.nameColumn, 'Name column');
      setSelectValue('class-column', columnSelections.classColumn, 'Class column');
      setSelectValue('reasonHeader', columnSelections.reasonHeader, 'Reason header');
      
      // 2. ÂêçÂâçË°®Á§∫Ë®≠ÂÆöÂæ©ÂÖÉÔºàshowNames„Éô„Éº„ÇπÔºâ
      var showNamesCheckbox = document.getElementById('show-names');
      if (showNamesCheckbox) {
        if (item.showNames !== undefined) {
          showNamesCheckbox.checked = item.showNames;
        } else if (item.displayMode !== undefined) {
          // Êóß„Éá„Éº„ÇøÂØæÂøú
          showNamesCheckbox.checked = (item.displayMode === 'named');
        }
      }
      
      // 3. „É™„Ç¢„ÇØ„Ç∑„Éß„É≥Êï∞Ë°®Á§∫Âæ©ÂÖÉ
      var showCountsCheckbox = document.getElementById('show-counts');
      if (showCountsCheckbox) {
        showCountsCheckbox.checked = (item.showCounts === true);
      }
      
      // 4. ÂÆåÂÖ®„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂæ©ÂÖÉÔºà„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà + „Ç∑„Éº„ÉàÔºâ
      console.log('üîç Restore conditions check:', {
        hasSpreadsheetId: !!item.spreadsheetId,
        hasSheetName: !!item.sheetName,
        spreadsheetId: item.spreadsheetId,
        sheetName: item.sheetName
      });
      
      if (item.spreadsheetId && item.sheetName) {
        console.log('‚úÖ Full project restore path selected');
        await this._restoreFullProject(item.spreadsheetId, item.sheetName);
      } else if (item.sheetName) {
        console.log('‚úÖ Sheet-only restore path selected');
        // „Ç∑„Éº„Éà„ÅÆ„ÅøÂæ©ÂÖÉ
        await this._restoreSheetSelection(item.sheetName);
      } else {
        console.warn('‚ö†Ô∏è No valid restoration path found - missing sheet or spreadsheet info');
        console.warn('üîß Attempting fallback: trying to find sheet by question text');
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂïèÈ°åÊñá„Åã„Çâ„Ç∑„Éº„ÉàÂêç„ÇíÊé®Ê∏¨
        var fallbackSheetName = await this._findSheetByQuestionText(item.questionText);
        if (fallbackSheetName) {
          console.log('‚úÖ Fallback found sheet: ' + fallbackSheetName);
          await this._restoreSheetSelection(fallbackSheetName);
        } else {
          console.error('‚ùå Fallback failed: unable to determine correct sheet');
        }
      }
      
      // 5. UIÂÆåÂÖ®Êõ¥Êñ∞
      await this._refreshAfterRestore();
      
      // Âæ©ÂÖÉÂÆå‰∫ÜÂæå„Å´Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢ÔºàUIÂèçÊò†ÂÆå‰∫Ü„ÇíÂæÖ„Å§Ôºâ
      await new Promise(function(resolve) { setTimeout(resolve, 500); });
      
      // Success message with specific details
      if (typeof showMessage === 'function') {
        var sheetInfo = item.sheetName ? '„Ç∑„Éº„Éà„Äå' + item.sheetName + '„Äç' : 'Ë®≠ÂÆö';
        showMessage('‚úÖ Â±•Ê≠¥„Åã„Çâ' + sheetInfo + '„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü', 'success');
      }
      console.log('‚úÖ Complete restore finished successfully');
      
    } catch (error) {
      console.error('‚ùå History restore failed:', error);
      
      // Enhanced error handling with rollback capability
      var errorMessage = '‚ùå Ë®≠ÂÆöÂæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
      var shouldAttemptRollback = false;
      
      if (error.message?.includes('Unable to parse range') || error.message?.includes('Invalid range')) {
        errorMessage = '‚ùå „Ç∑„Éº„ÉàÂêç„ÅÆÂΩ¢Âºè„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ„ÄÇ';
      } else if (error.message?.includes('spreadsheet') || error.message?.includes('spreadsheetId')) {
        errorMessage = '‚ùå „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊ®©Èôê„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        shouldAttemptRollback = true;
      } else if (error.message?.includes('sheet') || error.message?.includes('sheetName')) {
        errorMessage = '‚ùå ÊåáÂÆö„Åï„Çå„Åü„Ç∑„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ';
      } else if (error.message?.includes('verification failed')) {
        errorMessage = '‚ùå „Éá„Éº„Çø„Éô„Éº„ÇπÊõ¥Êñ∞„ÅÆÊ§úË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        shouldAttemptRollback = true;
      }
      
      // Attempt rollback if appropriate
      if (shouldAttemptRollback) {
        try {
          console.log('üîÑ Attempting rollback...');
          // Reload current status to restore previous state
          if (typeof loadStatus === 'function') {
            await loadStatus(true);
            console.log('‚úÖ Rollback completed');
            errorMessage += ' Ââç„ÅÆÁä∂ÊÖã„Å´Âæ©ÂÖÉ„Åó„Åæ„Åó„Åü„ÄÇ';
          }
        } catch (rollbackError) {
          console.warn('‚ö†Ô∏è Rollback failed:', rollbackError);
          errorMessage += ' ÊâãÂãï„Åß„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        }
      }
      
      if (typeof showMessage === 'function') {
        showMessage(errorMessage, 'error');
      }
      
      // Log technical details for debugging but don't show to user
      console.error('Technical details:', {
        itemId: item.id,
        sheetName: item.sheetName,
        spreadsheetId: item.spreadsheetId,
        errorMessage: error.message,
        errorStack: error.stack
      });
    } finally {
      // ÈÅÖÂª∂„Åó„Å¶„Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢ÔºàUIÊõ¥Êñ∞„ÅåÂÆåÂÖ®„Å´ÂÆå‰∫Ü„Åô„Çã„ÅÆ„ÇíÂæÖ„Å§Ôºâ
      setTimeout(function() {
        // AIÂàóÂà§ÂÆö„Çπ„Ç≠„ÉÉ„Éó„Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢
        if (window._historyRestoreInProgress) {
          window._historyRestoreInProgress = false;
          console.log('üõ°Ô∏è AIÂàóÂà§ÂÆö„Çπ„Ç≠„ÉÉ„Éó„Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
        }
        
        // Â±•Ê≠¥ÂàóÈÅ∏Êäû‰øùË≠∑„Éï„É©„Ç∞„ÇÇ„ÇØ„É™„Ç¢
        if (window._historyColumnSelections) {
          window._historyColumnSelections = null;
          console.log('üõ°Ô∏è Â±•Ê≠¥ÂàóÈÅ∏Êäû‰øùË≠∑„Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
        }
        
        // „Éâ„É©„Éï„Éà„É¢„Éº„Éâ„Åß„ÅÆË®≠ÂÆöÂèçÊò†„ÇíÂÆüË°å
        if (window._draftModeActive) {
          window.HistoryManager._applyDraftUIUpdates();
        }
      }, 1000); // 1ÁßíÂæå„Å´„ÇØ„É™„Ç¢
      
      // ÈáçË§áÂÆüË°åÈò≤Ê≠¢„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
      this._isRestoreInProgress = false;
    }
  },

  /**
   * Find sheet by question text as fallback mechanism
   */
  async _findSheetByQuestionText(questionText) {
    try {
      console.log('üîç Searching for sheet with question: "' + questionText + '"');
      
      // ÁèæÂú®„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Åã„ÇâË®≠ÂÆöÊÉÖÂ†±„ÇíÂèñÂæó
      if (window.AdminPanel?.currentStatus?.configJson) {
        var configJson = window.AdminPanel.currentStatus.configJson;
        
        // ÂêÑ„Ç∑„Éº„ÉàË®≠ÂÆö„ÇíÁ¢∫Ë™ç
        for (var [key, sheetConfig] of Object.entries(configJson)) {
          if (key.startsWith('sheet_') && sheetConfig.opinionHeader) {
            if (sheetConfig.opinionHeader === questionText) {
              var sheetName = sheetConfig.sheetName || key.replace('sheet_', '');
              console.log('‚úÖ Found matching sheet: ' + sheetName);
              return sheetName;
            }
          }
        }
      }
      
      console.warn('‚ö†Ô∏è No matching sheet found for question text');
      return null;
      
    } catch (error) {
      console.error('‚ùå Error in _findSheetByQuestionText:', error);
      return null;
    }
  },

  /**
   * Sanitize sheet name for safe API usage
   */
  _sanitizeSheetName(sheetName) {
    if (!sheetName) return '';
    
    // Remove potentially problematic characters but preserve most Unicode
    // Keep: letters, numbers, spaces, basic punctuation
    var sanitized = sheetName
      .replace(/[^\w\s\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF-]/g, '') // Keep alphanumeric, spaces, and Japanese characters
      .trim();
    
    return sanitized;
  },

  /**
   * Restore full project (spreadsheet + sheet) from history
   */
  async _restoreFullProject(spreadsheetId, sheetName) {
    try {
      // „Ç∑„Éº„ÉàÂêç„Çí„Çµ„Éã„Çø„Ç§„Ç∫
      var sanitizedSheetName = this._sanitizeSheetName(sheetName);
      console.log('üîÑ Restoring full project: ' + spreadsheetId + '/' + sheetName + ' (sanitized: ' + sanitizedSheetName + ')');
      
      // ÁèæÂú®„ÅÆ„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàID„ÇíÂèñÂæó
      var getCurrentSpreadsheetId = function() {
        if (window.AdminPanel?.currentStatus?.userInfo?.spreadsheetId) {
          return window.AdminPanel.currentStatus.userInfo.spreadsheetId;
        }
        return null;
      };
      
      var currentSpreadsheetId = getCurrentSpreadsheetId();
      
      // Áï∞„Å™„Çã„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂàá„ÇäÊõø„ÅàÂá¶ÁêÜ
      if (spreadsheetId !== currentSpreadsheetId) {
        console.log('üîÑ Switching spreadsheet: ' + currentSpreadsheetId + ' ‚Üí ' + spreadsheetId);
        
        // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÂàá„ÇäÊõø„Åà„ÅÆÈÄöÁü•
        if (typeof showMessage === 'function') {
          showMessage('üîÑ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂàá„ÇäÊõø„Åà„Å¶„ÅÑ„Åæ„Åô...', 'info', 3000);
        }
        
        // ÂÆüÈöõ„ÅÆ„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÂàá„ÇäÊõø„Åà„ÇíÂÆüË°å
        await this._performSpreadsheetSwitch(spreadsheetId);
        
        // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÂàá„ÇäÊõø„ÅàÂæå„ÅÆÂÆâÂÆöÂåñÂæÖÊ©ü
        console.log('‚è≥ Waiting for spreadsheet switch to stabilize...');
        await new Promise(function(resolve) { setTimeout(resolve, 1500); });
        
        // UIÊõ¥Êñ∞ÂÆå‰∫Ü„ÇíÂæÖÊ©ü„Åó„Å¶„Åã„Çâ„Ç∑„Éº„ÉàÈÅ∏ÊäûÂæ©ÂÖÉ
        console.log('üîÑ Waiting for sheet options to include: ' + sanitizedSheetName);
        var sheetFound = await this._waitForSheetOptionsUpdate(sanitizedSheetName);
        if (!sheetFound) {
          console.warn('‚ö†Ô∏è Sheet ' + sanitizedSheetName + ' not found in options after waiting, proceeding with fallback');
        }
        
        // **CRITICAL**: Force correct the activeSheetName in loaded status
        console.log('üîß Force correcting activeSheetName after spreadsheet switch');
        if (window.currentStatus) {
          window.currentStatus.activeSheetName = sanitizedSheetName;
        }
        if (window.AdminPanel?.currentStatus) {
          window.AdminPanel.currentStatus.activeSheetName = sanitizedSheetName;
        }
      }
      
      // „Ç∑„Éº„ÉàÈÅ∏ÊäûÂæ©ÂÖÉ„Å®ÂÖ¨ÈñãÊÉÖÂ†±Êõ¥Êñ∞Ôºà„Çµ„Éã„Çø„Ç§„Ç∫„Åï„Çå„ÅüÂêçÂâç„Çí‰ΩøÁî®Ôºâ
      await this._restoreSheetSelection(sanitizedSheetName);
      
      // „Éâ„É©„Éï„Éà„É¢„Éº„Éâ„Åß„ÅØÂÖ¨Èñã„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Å™„ÅÑ
      if (!window._draftModeActive) {
        console.log('üîÑ ÂÖ¨Èñã„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíÂº∑Âà∂Êõ¥Êñ∞');
        await this._updatePublishedSheetInfo(sanitizedSheetName);
      } else {
        console.log('üìù „Éâ„É©„Éï„Éà„É¢„Éº„Éâ: ÂÖ¨Èñã„Ç∑„Éº„ÉàÊÉÖÂ†±„ÅÆÊõ¥Êñ∞„Çí„Çπ„Ç≠„ÉÉ„Éó');
      }
      
      console.log(`‚úÖ Full project restore completed`);
      
    } catch (error) {
      console.warn('‚ö†Ô∏è Full project restore failed:', error);
      if (typeof showMessage === 'function') {
        showMessage('‚ö†Ô∏è „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂæ©ÂÖÉ„ÅßÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'warning');
      }
    }
  },

  /**
   * Restore sheet selection from history
   */
  async _restoreSheetSelection(sheetName) {
    try {
      // „Çµ„Éã„Çø„Ç§„Ç∫„Åï„Çå„Åü„Ç∑„Éº„ÉàÂêç„Çí‰ΩøÁî®
      var sanitizedSheetName = this._sanitizeSheetName(sheetName);
      console.log('üîÑ Restoring sheet selection: "' + sheetName + '" (sanitized: "' + sanitizedSheetName + '")');
      
      // „Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖãÊõ¥Êñ∞Ôºà„Çµ„Éã„Çø„Ç§„Ç∫„Åï„Çå„ÅüÂêçÂâç„Çí‰ΩøÁî®Ôºâ
      window.AdminPanel.selectedSheet = sanitizedSheetName;
      if (window.AdminPanel.stateManager) {
        window.AdminPanel.stateManager.setState('selectedSheet', sanitizedSheetName);  
      }
      
      // „Ç∑„Éº„ÉàÈÅ∏ÊäûUIÊõ¥Êñ∞
      var sheetSelect = document.getElementById('sheet-select');
      if (sheetSelect) {
        // Find the option that matches either the original or sanitized name
        var options = Array.from(sheetSelect.options);
        var matchingOption = options.find(function(option) { 
          return option.value === sheetName || option.value === sanitizedSheetName;
        });
        
        if (matchingOption && sheetSelect.value !== matchingOption.value) {
          sheetSelect.value = matchingOption.value;
          sheetSelect.dispatchEvent(new Event('change'));
          
          // „Éó„É´„ÉÄ„Ç¶„É≥Ë°®Á§∫„ÅÆÂº∑Âà∂Êõ¥Êñ∞
          if (typeof updateSheetSelectActiveIndicator === 'function') {
            updateSheetSelectActiveIndicator(matchingOption.value);
          }
          
          console.log('‚úÖ Sheet selection UI updated to: ' + matchingOption.value);
        } else if (!matchingOption) {
          console.warn('‚ö†Ô∏è Sheet "' + sheetName + '" not found in options. Available: ' + options.map(function(o) { return o.value; }).join(', '));
        }
      }
      
      console.log('‚úÖ Sheet restored: ' + sanitizedSheetName);
    } catch (error) {
      console.warn('‚ö†Ô∏è Sheet restore warning:', error);
    }
  },

  /**
   * Refresh UI after history restore with enhanced error handling
   */
  async _refreshAfterRestore() {
    var refreshSteps = [
      { name: '„Éá„Éº„ÇøÂÜçË™≠Ëæº', fn: function() { return typeof loadData === 'function' ? loadData() : Promise.resolve(); } }
      // ÂàóÂà§ÂÆöÊõ¥Êñ∞„ÅØÂ±•Ê≠¥Âæ©ÂÖÉÊôÇ„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàÂæ©ÂÖÉ„Åó„ÅüË®≠ÂÆöÂÄ§„Çí‰øùÊåÅ„Åô„Çã„Åü„ÇÅÔºâ
    ];
    
    // Execute each step with individual error handling
    for (var step of refreshSteps) {
      try {
        console.log('üîÑ Executing refresh step: ' + step.name);
        await step.fn();
        console.log('‚úÖ ' + step.name + ' completed');
      } catch (error) {
        console.warn('‚ö†Ô∏è ' + step.name + ' failed, continuing with next step:', error);
        // Continue with other steps even if one fails
      }
    }
    
    // Â±•Ê≠¥Âæ©ÂÖÉÊôÇ„ÅØÂàóÈÅ∏Êäû„ÇíÊ∞∏Á∂öÂåñÔºàÊúÄÂ∞è‰øùÂ≠òÔºâ - with enhanced retry logic
    if (window._historyRestoreInProgress) {
      try {
        // „Éò„ÉÉ„ÉÄ„ÉºÊèèÁîª„ÉªÈÅ∏ÊäûÂèçÊò†ÂÆå‰∫Ü„ÇíÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ‰øùÂ≠ò
        await new Promise(function(resolve) { setTimeout(resolve, 600); }); // Increased wait time
        
        var sheetName = (window.AdminPanel && window.AdminPanel.selectedSheet) || (document.getElementById('sheet-select')?.value) || '';
        var spreadsheetId = (window.currentStatus && window.currentStatus.userInfo && window.currentStatus.userInfo.spreadsheetId) || null;
        
        if (sheetName && spreadsheetId && typeof buildConfigObject === 'function' && typeof runGasWithUserId === 'function') {
          var config = buildConfigObject();
          console.log('üîÑ Saving restored configuration for sheet: ' + sheetName);
          
          // Save sheet configuration with retry
          await this._saveConfigWithRetry(spreadsheetId, sheetName, config);
          
          // Activate sheet with retry
          await this._activateSheetWithRetry(spreadsheetId, sheetName);
          
        } else {
          console.warn('‚ö†Ô∏è Ëá™Âãï‰øùÂ≠ò„Çπ„Ç≠„ÉÉ„ÉóÔºàÂøÖË¶ÅÊÉÖÂ†±‰∏çË∂≥Ôºâ:', { 
            sheetName, 
            hasSpreadsheetId: !!spreadsheetId,
            hasBuildConfigObject: typeof buildConfigObject === 'function',
            hasRunGasWithUserId: typeof runGasWithUserId === 'function'
          });
        }
      } catch (autoSaveErr) {
        console.warn('‚ö†Ô∏è Ëá™Âãï‰øùÂ≠òÂá¶ÁêÜ„ÅßË≠¶Âëä:', autoSaveErr?.message || autoSaveErr);
        // Show user-friendly message but don't block the restore process
        if (typeof showMessage === 'function') {
          showMessage('‚ö†Ô∏è Ë®≠ÂÆö‰øùÂ≠ò„ÅßÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„Åå„ÄÅÂæ©ÂÖÉ„ÅØÂÆå‰∫Ü„Åó„Åæ„Åó„Åü', 'warning');
        }
      }
    }

    console.log('‚úÖ UI refresh completed');
  },

  /**
   * Save configuration with retry mechanism
   */
  async _saveConfigWithRetry(spreadsheetId, sheetName, config, maxRetries = 2) {
    for (var i = 0; i <= maxRetries; i++) {
      try {
        await runGasWithUserId('saveSheetConfig', 'Ë®≠ÂÆö‰øùÂ≠ò‰∏≠...', spreadsheetId, sheetName, config);
        console.log('‚úÖ Configuration saved successfully for sheet: ' + sheetName);
        return;
      } catch (error) {
        console.warn('‚ùå Save config attempt ' + (i + 1) + ' failed:', error);
        if (i === maxRetries) {
          throw error; // Re-throw on final attempt
        }
        await new Promise(function(resolve) { setTimeout(resolve, 1000 * (i + 1)); }); // Progressive delay
      }
    }
  },

  /**
   * Activate sheet with retry mechanism
   */
  async _activateSheetWithRetry(spreadsheetId, sheetName, maxRetries = 2) {
    for (var i = 0; i <= maxRetries; i++) {
      try {
        await runGasWithUserId('switchToSheet', false, spreadsheetId, sheetName);
        console.log('‚úÖ Sheet activated successfully: ' + sheetName);
        return;
      } catch (error) {
        console.warn('‚ùå Activate sheet attempt ' + (i + 1) + ' failed:', error);
        if (i === maxRetries) {
          console.warn('‚ö†Ô∏è Failed to activate sheet after all retries, but continuing');
          return; // Don't throw for sheet activation failure
        }
        await new Promise(function(resolve) { setTimeout(resolve, 1000 * (i + 1)); }); // Progressive delay
      }
    }
  },

  /**
   * Perform actual spreadsheet switching
   */
  async _performSpreadsheetSwitch(targetSpreadsheetId) {
    try {
      // 1. Update user's active spreadsheet in database
      if (typeof runGasWithUserId === 'function') {
        var updateResult = await runGasWithUserId('updateUserAPI', false, {
          spreadsheetId: targetSpreadsheetId
        });
        
        if (updateResult && updateResult.status === 'success') {
          console.log('‚úÖ Spreadsheet switched successfully in database');
        } else {
          throw new Error('Database update failed: ' + (updateResult?.message || 'Unknown error'));
        }
      } else {
        throw new Error('runGasWithUserId function not available');
      }

      // 2. Clear caches to force reload with new spreadsheet
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      if (window.gasOptimizer && typeof window.gasOptimizer.clearCache === 'function') {
        window.gasOptimizer.clearCache();
      }

      // 3. Reload application state with new spreadsheet
      if (typeof loadStatus === 'function') {
        await loadStatus(true); // Force reload bypassing cache
        // Application state reloaded - verbose logging disabled
        
        // 4. Force update currentSpreadsheetUrl after state reload
        if (window.currentStatus?.userInfo?.spreadsheetUrl) {
          currentSpreadsheetUrl = window.currentStatus.userInfo.spreadsheetUrl;
          console.log('‚úÖ currentSpreadsheetUrl force updated after switch:', currentSpreadsheetUrl);
        } else {
          console.warn('‚ö†Ô∏è No spreadsheetUrl available in reloaded currentStatus');
        }
        
        // 5. **CRITICAL**: Verify spreadsheet consistency after loadStatus
        await this._verifySpreadsheetConsistency(targetSpreadsheetId);
        
      } else {
        console.warn('‚ö†Ô∏è loadStatus function not available for state reload');
      }

    } catch (error) {
      console.error('‚ùå Spreadsheet switching failed:', error);
      if (typeof showMessage === 'function') {
        showMessage('‚ùå „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      }
      throw error; // Re-throw to be handled by caller
    }
  },

  /**
   * Verify spreadsheet consistency after restoration - ENHANCED
   * Ensures both client and server state are properly synchronized
   */
  async _verifySpreadsheetConsistency(targetSpreadsheetId) {
    try {
      console.log('üîç Verifying spreadsheet consistency (enhanced):', {
        target: targetSpreadsheetId,
        checkingCurrentStatus: !!window.currentStatus?.userInfo
      });
      
      // Use current status first (already loaded via unified API)
      var currentSpreadsheetId = window.currentStatus?.userInfo?.spreadsheetId;
      
      if (currentSpreadsheetId !== targetSpreadsheetId) {
        console.warn('‚ö†Ô∏è Spreadsheet ID mismatch detected:', {
          expected: targetSpreadsheetId,
          actual: currentSpreadsheetId
        });
        
        // Áµ±ÂêàÁöÑ„Å™‰∏çÊï¥Âêà‰øÆÊ≠£Âá¶ÁêÜ
        await this._correctSpreadsheetIdInconsistency(targetSpreadsheetId, currentSpreadsheetId);
      } else {
        console.log('‚úÖ Spreadsheet consistency verified');
      }
      
    } catch (error) {
      console.warn('‚ö†Ô∏è Spreadsheet consistency verification failed:', error);
    }
  },

  /**
   * Wait for sheet options to be updated with target sheet
   */
  async _waitForSheetOptionsUpdate(targetSheetName, maxWaitTime = 3000) {
    var startTime = Date.now();
    var checkInterval = 100; // Check every 100ms
    
    return new Promise(function(resolve, reject) {
      var checkSheetOptions = function() {
        var select = document.getElementById('sheet-select');
        if (!select) {
          console.warn('‚ö†Ô∏è Sheet select element not found during wait');
          resolve(false);
          return;
        }
        
        // Check if target sheet is in options
        var options = Array.from(select.options);
        var hasTargetSheet = options.some(function(option) { return option.value === targetSheetName; });
        
        if (hasTargetSheet) {
          console.log('‚úÖ Target sheet found in options: ' + targetSheetName);
          resolve(true);
          return;
        }
        
        // Check timeout
        var elapsed = Date.now() - startTime;
        if (elapsed >= maxWaitTime) {
          console.warn('‚ö†Ô∏è Timeout waiting for sheet options update (' + elapsed + 'ms). Available: ' + options.map(function(o) { return o.value; }).join(', '));
          resolve(false); // Don't reject, allow fallback
          return;
        }
        
        // Continue checking
        setTimeout(checkSheetOptions, checkInterval);
      };
      
      // Start checking
      checkSheetOptions();
    });
  },
  
  /**
   * Generate unique history ID
   */
  generateId() {
    return Date.now().toString() + Math.random().toString(36).substr(2, 9);
  },
  
  /**
   * HTML escape utility
   */
  /**
   * Update published sheet information after restore
   */
  async _updatePublishedSheetInfo(sheetName) {
    try {
      console.log('üîÑ Updating published sheet info to: ' + sheetName);
      
      // „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÅßÂÖ¨Èñã„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞
      if (typeof runGasWithUserId === 'function') {
        var response = await runGasWithUserId('activateSheetSimple', false, sheetName);
        if (response && response.status === 'success') {
          console.log('‚úÖ Published sheet info updated on server: ' + sheetName);
        }
      }
      
      // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„ÅÆÁä∂ÊÖã„ÇÇÊõ¥Êñ∞
      if (window.AdminPanel?.currentStatus) {
        window.AdminPanel.currentStatus.publishedSheetName = sheetName;
        window.AdminPanel.currentStatus.activeSheetName = sheetName;
        
        // config „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰ΩúÊàê
        if (!window.AdminPanel.currentStatus.config) {
          window.AdminPanel.currentStatus.config = {};
        }
        window.AdminPanel.currentStatus.config.publishedSheetName = sheetName;
      }
      
      // UIË°®Á§∫„ÇíÊõ¥Êñ∞Ôºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ - status„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ©Âàá„Å´Ê∏°„Åô
      if (typeof updateTopicText === 'function') {
        try {
          // „Çà„ÇäÈÅ©Âàá„Å™status„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂèñÂæó
          var statusForUpdate = window.currentStatus || window.AdminPanel?.currentStatus;
          if (statusForUpdate) {
            updateTopicText(statusForUpdate);
          } else {
            console.warn('‚ö†Ô∏è No valid status object available for updateTopicText');
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è updateTopicText failed during published sheet info update:', error);
        }
      }
      
    } catch (error) {
      console.warn('‚ö†Ô∏è Failed to update published sheet info:', error);
    }
  },

  /**
   * „Éâ„É©„Éï„Éà„É¢„Éº„Éâ„Åß„ÅÆUIÊõ¥Êñ∞„ÇíÈÅ©Áî®
   */
  _applyDraftUIUpdates() {
    try {
      console.log('üìù „Éâ„É©„Éï„Éà„É¢„Éº„Éâ„Åß„ÅÆUIÊõ¥Êñ∞„ÇíÈÅ©Áî®‰∏≠...');
      
      // Â±•Ê≠¥Âæ©ÂÖÉ„ÅÆ‰øùË≠∑„Éï„É©„Ç∞„Çí‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñ„Åó„Å¶UIÊõ¥Êñ∞„ÇíÂÆüË°å
      var originalRestoreFlag = window._historyRestoreInProgress;
      var originalColumnSelections = window._historyColumnSelections;
      
      window._historyRestoreInProgress = false;
      window._historyColumnSelections = null;
      
      // ÁèæÂú®„ÅÆ„Éï„Ç©„Éº„É†ÂÄ§„ÇíË™≠„ÅøÂèñ„Å£„Å¶Ë®≠ÂÆö„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÊßãÁØâ
      var currentConfig = this._getDraftConfiguration();
      
      // populateConfig„ÇíÂëº„Å≥Âá∫„Åó„Å¶UIÊõ¥Êñ∞
      if (typeof window._fullPopulateConfig === 'function') {
        window._fullPopulateConfig(currentConfig);
      } else if (typeof window.populateConfig === 'function') {
        window.populateConfig(currentConfig);
      }
      
      // „Éâ„É©„Éï„ÉàÁä∂ÊÖã„ÅÆË¶ñË¶öÁöÑ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíË°®Á§∫
      this._showDraftModeIndicator();
      
      // „Éâ„É©„Éï„ÉàÁä∂ÊÖã„ÇíUI„Éú„Çø„É≥„Å´ÂèçÊò†
      this._updateDraftModeUI();
      
      // „Éï„É©„Ç∞„ÇíÂÖÉ„Å´Êàª„Åô
      window._historyRestoreInProgress = originalRestoreFlag;
      window._historyColumnSelections = originalColumnSelections;
      
      console.log('‚úÖ „Éâ„É©„Éï„Éà„É¢„Éº„Éâ„Åß„ÅÆUIÊõ¥Êñ∞„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
      
    } catch (error) {
      console.error('‚ùå „Éâ„É©„Éï„Éà„É¢„Éº„ÉâUIÊõ¥Êñ∞„Ç®„É©„Éº:', error);
    }
  },
  
  /**
   * ÁèæÂú®„ÅÆ„Éâ„É©„Éï„ÉàË®≠ÂÆö„ÇíÂèñÂæó
   */
  _getDraftConfiguration() {
    var config = {};
    
    // ÂêÑ„Éï„Ç©„Éº„É†Ë¶ÅÁ¥†„Åã„ÇâÁèæÂú®„ÅÆÂÄ§„ÇíÂèñÂæó
    var opinionHeaderEl = document.getElementById('opinionHeader');
    if (opinionHeaderEl) config.opinionHeader = opinionHeaderEl.value;
    
    var nameColumnEl = document.getElementById('name-column');
    if (nameColumnEl) config.nameColumn = nameColumnEl.value;
    
    var classColumnEl = document.getElementById('class-column');
    if (classColumnEl) config.classColumn = classColumnEl.value;
    
    var reasonHeaderEl = document.getElementById('reasonHeader');
    if (reasonHeaderEl) config.reasonHeader = reasonHeaderEl.value;
    
    var showNamesEl = document.getElementById('show-names');
    if (showNamesEl) config.showNames = showNamesEl.checked;
    
    var showCountsEl = document.getElementById('show-counts');
    if (showCountsEl) config.showCounts = showCountsEl.checked;
    
    return config;
  },
  
  /**
   * Áµ±Âêà„Åï„Çå„Åü„Éâ„É©„Éï„Éà„É¢„Éº„ÉâÁä∂ÊÖã„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÅÆË°®Á§∫
   */
  _showDraftModeIndicator() {
    var indicatorSection = document.getElementById('draft-mode-indicator-section');
    if (indicatorSection) {
      indicatorSection.classList.remove('hidden');
      console.log('‚úÖ Áµ±Âêà„Éâ„É©„Éï„Éà„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü');
    }
    
    // „Éâ„É©„Éï„ÉàÊ©üËÉΩ„Éò„É´„Éó„ÇÇË°®Á§∫
    var helpSection = document.getElementById('draft-help-section');
    if (helpSection) {
      helpSection.classList.remove('hidden');
      console.log('üí° „Éâ„É©„Éï„Éà„Éò„É´„Éó„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü');
    }
  },
  
  /**
   * „Éâ„É©„Éï„Éà„É¢„Éº„ÉâÁä∂ÊÖã„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÅÆÈùûË°®Á§∫
   */
  _hideDraftModeIndicator() {
    var indicatorSection = document.getElementById('draft-mode-indicator-section');
    if (indicatorSection) {
      indicatorSection.classList.add('hidden');
      console.log('‚úÖ Áµ±Âêà„Éâ„É©„Éï„Éà„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÈùûË°®Á§∫„Å´„Åó„Åæ„Åó„Åü');
    }
    
    // „Éâ„É©„Éï„ÉàÊ©üËÉΩ„Éò„É´„Éó„ÇÇÈùûË°®Á§∫
    var helpSection = document.getElementById('draft-help-section');
    if (helpSection) {
      helpSection.classList.add('hidden');
      console.log('üí° „Éâ„É©„Éï„Éà„Éò„É´„Éó„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫„Å´„Åó„Åæ„Åó„Åü');
    }
    
    // „Éâ„É©„Éï„Éà„É¢„Éº„ÉâUI„ÇíÈÄöÂ∏∏„Å´Êàª„Åô
    this._updateDraftModeUI(false);
  },
  
  /**
   * „Éâ„É©„Éï„Éà„É¢„Éº„ÉâÁä∂ÊÖã„Å´Âêà„Çè„Åõ„Å¶UI„ÇíÊõ¥Êñ∞
   */
  _updateDraftModeUI(isDraftMode = null) {
    if (isDraftMode === null) {
      isDraftMode = window._draftModeActive;
    }
    
    var saveButton = document.getElementById('save-publish-btn');
    var saveButtonText = document.getElementById('save-publish-text');
    
    if (saveButton && saveButtonText) {
      if (isDraftMode) {
        saveButtonText.textContent = '„Éâ„É©„Éï„Éà„Çí‰øùÂ≠ò„Åó„Å¶ÂÖ¨Èñã';
        saveButton.className = saveButton.className.replace('btn-primary', 'btn-warning');
        console.log('üìù UI„Çí„Éâ„É©„Éï„Éà„É¢„Éº„Éâ„Å´Â§âÊõ¥');
      } else {
        saveButtonText.textContent = 'Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Å¶ÂÖ¨Èñã';
        saveButton.className = saveButton.className.replace('btn-warning', 'btn-primary');
        console.log('‚úÖ UI„ÇíÈÄöÂ∏∏„É¢„Éº„Éâ„Å´Â§âÊõ¥');
      }
    }
  },

  /**
   * „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàID‰∏çÊï¥Âêà„ÅÆÁµ±ÂêàÁöÑ‰øÆÊ≠£Âá¶ÁêÜ
   */
  async _correctSpreadsheetIdInconsistency(targetSpreadsheetId, currentSpreadsheetId) {
    try {
      console.log('üîß Áµ±ÂêàÁöÑ„Å™„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàID‰øÆÊ≠£„ÇíÈñãÂßã');
      
      // 1. „Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖã„ÅÆ‰øÆÊ≠£
      if (window.currentStatus?.userInfo) {
        console.log('üîß Correcting currentStatus with target spreadsheet ID');
        window.currentStatus.userInfo.spreadsheetId = targetSpreadsheetId;
        
        // Also update spreadsheet URL if available
        if (window.currentStatus.userInfo.spreadsheetUrl) {
          var correctedUrl = window.currentStatus.userInfo.spreadsheetUrl.replace(
            /\/spreadsheets\/d\/[a-zA-Z0-9-_]+/,
            '/spreadsheets/d/' + targetSpreadsheetId
          );
          window.currentStatus.userInfo.spreadsheetUrl = correctedUrl;
          console.log('üîó Spreadsheet URL also corrected');
        }
      }
      
      // 2. AdminPanelÁä∂ÊÖã„ÅÆ‰øÆÊ≠£
      if (window.AdminPanel?.currentStatus?.userInfo) {
        console.log('üîß Correcting AdminPanel.currentStatus');
        window.AdminPanel.currentStatus.userInfo.spreadsheetId = targetSpreadsheetId;
      }
      
      // 3. UIË¶ÅÁ¥†„ÅÆ‰øÆÊ≠£
      var spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
      if (spreadsheetBtn) {
        var correctedUrl = 'https://docs.google.com/spreadsheets/d/' + targetSpreadsheetId + '/edit';
        spreadsheetBtn.href = correctedUrl;
        console.log('üîó Spreadsheet button URL updated');
      }
      
      // 4. „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢
      if (typeof clearAllSpreadsheetCache === 'function') {
        await clearAllSpreadsheetCache();
        console.log('üßπ „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÂÆå‰∫Ü');
      }
      
      console.log('‚úÖ Áµ±ÂêàÁöÑ„Å™„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàID‰øÆÊ≠£„ÅåÂÆå‰∫Ü');
      
    } catch (error) {
      console.error('‚ùå „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàID‰øÆÊ≠£„Ç®„É©„Éº:', error);
    }
  },

  _escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
};

// History manager integration
window.AdminPanel.historyManager = {
  loadSimpleHistoryTable: function() { return window.HistoryManager.renderTable(); },
  restoreFromSimpleHistory: function(item) { return window.HistoryManager._restoreHistoryItem(item); }
};

//# sourceURL=adminPanel-framework.js.html
</script>
