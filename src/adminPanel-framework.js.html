<script>
// Unified Admin Panel Namespace and Management Classes
// Generated to address function interference issues and centralize state, events,
// asynchronous operations, and DOM handling.

window.AdminPanel = window.AdminPanel || {
  errors: {},
  ui: {},
  state: {
    current: null,
    selectedSheet: '',
    updateStatus(status) {
      this.current = status;
    }
  },
  // Initialization state tracking to prevent redundant calls
  initialization: {
    isInProgress: false,
    isCompleted: false,
    completedPhases: new Set(),
    startTime: null,
    lastLoadStatusCall: null,
    loadStatusCallCount: 0
  }
};

// -----------------------------------------------------------------------------
// State Manager
// -----------------------------------------------------------------------------
class AdminPanelStateManager {
  constructor() {
    this.state = {
      currentStatus: null,
      selectedSheet: '',
      isLoading: false,
      debugMode: false // DEBUG_MODE状態を追加
    };
    this.subscribers = new Map();
  }

  setState(key, value) {
    this.state[key] = value;
    this.notifySubscribers(key, value);
  }

  subscribe(key, callback) {
    if (!this.subscribers.has(key)) {
      this.subscribers.set(key, []);
    }
    this.subscribers.get(key).push(callback);
  }

  notifySubscribers(key, value) {
    const subs = this.subscribers.get(key) || [];
    subs.forEach(cb => {
      try {
        cb(value);
      } catch (e) {
        console.warn('Subscriber callback failed', e);
      }
    });
  }
}

// -----------------------------------------------------------------------------
// Event Manager
// -----------------------------------------------------------------------------
class AdminPanelEventManager {
  constructor() {
    this.listeners = new Map();
  }

  addListener(element, event, handler, options = {}) {
    if (!element || !event || !handler) return;
    const key = (element.id || 'anonymous') + '-' + event;
    if (this.listeners.has(key)) {
      console.warn('Duplicate listener for ' + key);
      return;
    }
    element.addEventListener(event, handler, options);
    this.listeners.set(key, { element, event, handler, options });
  }
}

// -----------------------------------------------------------------------------
// Async Manager
// -----------------------------------------------------------------------------
class AdminPanelAsyncManager {
  constructor() {
    this.runningOperations = new Map();
  }

  async executeExclusive(operationId, operation) {
    if (this.runningOperations.has(operationId)) {
      return this.runningOperations.get(operationId);
    }
    const promise = Promise.resolve().then(operation);
    this.runningOperations.set(operationId, promise);
    try {
      return await promise;
    } finally {
      this.runningOperations.delete(operationId);
    }
  }
}

// -----------------------------------------------------------------------------
// DOM Manager
// -----------------------------------------------------------------------------
class AdminPanelDOMManager {
  constructor() {
    this.elementCache = new Map();
    this.operationQueue = [];
  }

  getElement(id) {
    if (!this.elementCache.has(id)) {
      this.elementCache.set(id, document.getElementById(id));
    }
    return this.elementCache.get(id);
  }

  queueOperation(operation) {
    this.operationQueue.push(operation);
    return new Promise(resolve => {
      requestAnimationFrame(() => {
        const op = this.operationQueue.shift();
        resolve(op());
      });
    });
  }
}

// Instantiate managers and expose via namespace
window.AdminPanel.stateManager = new AdminPanelStateManager();
window.AdminPanel.eventManager = new AdminPanelEventManager();
window.AdminPanel.asyncManager = new AdminPanelAsyncManager();
window.AdminPanel.domManager = new AdminPanelDOMManager();

// Link legacy globals to state manager for compatibility
Object.defineProperties(window, {
  currentStatus: {
    get() { return window.AdminPanel.stateManager.state.currentStatus; },
    set(v) { window.AdminPanel.stateManager.setState('currentStatus', v); }
  },
  selectedSheet: {
    get() { return window.AdminPanel.stateManager.state.selectedSheet; },
    set(v) { window.AdminPanel.stateManager.setState('selectedSheet', v); }
  }
});

// =============================================================================
// INITIALIZATION FUNCTIONS - Moved from various adminPanel files
// =============================================================================

// Simple logging utility with conditional output based on DEBUG mode
// DEBUG_MODE is defined in constants.js.html

function adminLog(level, ...args) {
  // AdminPanel.stateManagerが初期化されているか、またはwindow.DEBUG_MODEが設定されているかを確認
  const isDebugModeEnabled = window.AdminPanel && window.AdminPanel.stateManager && window.AdminPanel.stateManager.state.debugMode || window.DEBUG_MODE;
  if (!isDebugModeEnabled) return;
  
  switch (level) {
    case 'error':
      console.error('[AdminPanel]', ...args);
      break;
    case 'warn':
      console.warn('[AdminPanel]', ...args);
      break;
    case 'info':
      console.log('[AdminPanel]', ...args);
      break;
    case 'debug':
      // debugレベルのログは、debugModeが有効な場合のみ出力
      if (isDebugModeEnabled) console.log('[AdminPanel:DEBUG]', ...args);
      break;
    default:
      console.log('[AdminPanel]', ...args);
  }
}

// Convenience functions for different log levels
function logError(...args) { adminLog('error', ...args); }
function logWarn(...args) { adminLog('warn', ...args); }
function logInfo(...args) { adminLog('info', ...args); }
function logDebug(...args) { adminLog('debug', ...args); }

// =============================================================================
// USER AUTHENTICATION INITIALIZATION
// =============================================================================

// マルチテナント対応: ユーザーIDの安全な初期化
var userId = '';

// マルチテナント対応: バックエンドから安全にユーザーIDを取得
function initializeUserId() {
  console.group('🔐 Initializing UserId');
  logDebug('📞 About to call getCurrentUserStatus');
  
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(response => {
        logDebug('📥 getCurrentUserStatus response:', response);
        
        if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
          userId = response.userInfo.userId;
          logDebug('✅ AdminPanel: User authenticated, userId:', userId);
          console.groupEnd();
          resolve(userId);
        } else {
          console.error('❌ Failed to get userId from backend:', response);
          console.error('❌ Expected: {status: "success", userInfo: {userId: "..."}}');
          console.groupEnd();
          reject(new Error('ユーザーIDの取得に失敗しました'));
        }
      })
      .withFailureHandler(error => {
        console.error('❌ Backend error getting userId:', error);
        console.error('❌ Error type:', typeof error);
        console.error('❌ Error details:', error);
        console.groupEnd();
        reject(error);
      })
      .getCurrentUserStatus();
  });
}

// リトライ付きユーザーID取得
async function initializeUserIdWithRetry(maxRetries = 3, delay = 1000) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await initializeUserId();
    } catch (error) {
      console.warn(`⚠️ UserId initialization failed (attempt ${i + 1}/${maxRetries}):`, error.message);
      if (i < maxRetries - 1) {
        console.log(`🔄 Retrying in ${delay}ms...`);
        await new Promise(resolve => setTimeout(resolve, delay));
        delay = Math.min(delay * 1.5, 5000); // 指数バックオフ（最大5秒）
      } else {
        console.error('❌ All userId initialization attempts failed');
        throw error;
      }
    }
  }
}

// ユーザーID取得の完了を待つPromise（リトライ機構付き）
const userIdPromise = initializeUserIdWithRetry();

// =============================================================================
// CORE INITIALIZATION FUNCTIONS
// =============================================================================

// Layout adjustment for responsive design
function adjustLayout() {
  var isMobile = window.innerWidth < 768;
  var body = document.body;
  
  if (isMobile) {
    body.classList.add('mobile-layout');
    body.classList.remove('desktop-layout');
  } else {
    body.classList.add('desktop-layout');
    body.classList.remove('mobile-layout');
  }
}

// Initialize core functionality
function initCore() {
  adjustLayout();
}

// Initialize message area
function initializeMessageArea() {
  var messageArea = document.getElementById('message-area');
  if (!messageArea) {
    // Create message area if it doesn't exist
    messageArea = document.createElement('div');
    messageArea.id = 'message-area';
    messageArea.className = 'fixed top-32 right-4 z-50 max-w-sm';
    document.body.appendChild(messageArea);
  }
}

// Initialize UI components
function initializeUI() {
  // UI初期化のみ実行、loadStatusは adminPanel-api.js で処理される
}

// Initialize API functionality
function initializeAPI() {
  logDebug('🔧 API初期化開始');
  
  // Start background status updates with safe calling
  if (checkFunctionAvailability('startSystemStatusUpdate')) {
    safeCallFunction('startSystemStatusUpdate');
  } else {
    console.warn('⚠️ startSystemStatusUpdate not available - background updates disabled');
  }
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);

  // 初期化時のステータスロード - タイミング調整版
  logDebug('🚀 初期化時loadStatus(true)呼び出し（遅延あり）');
  setTimeout(() => {
    if (checkFunctionAvailability('loadStatus')) {
      window.loadStatus(true);
    } else {
      console.warn('⚠️ loadStatus not available');
    }
  }, 500); // 500ms遅延でより安全な初期化
  
  logDebug('✅ API初期化完了');
}

// Update user activity timestamp for polling optimization
function updateUserActivity() {
  if (typeof lastUserActivity !== 'undefined') {
    lastUserActivity = Date.now();
  }
}

// Initialize event listeners
function initializeEventListeners() {
  
  // Use safe function calling with availability checks
  if (checkFunctionAvailability('setupEventListeners')) {
    safeCallFunction('setupEventListeners');
  } else {
    console.warn('⚠️ setupEventListeners function not available, attempting graceful degradation');
    
    // Basic fallback event listener setup
    if (checkFunctionAvailability('setupRealtimeValidation')) {
      safeCallFunction('setupRealtimeValidation');
    } else {
      console.warn('⚠️ setupRealtimeValidation not available - real-time validation disabled');
    }
  }
}

// Setup character counters
function setupCharacterCounters() {
  const questionTextarea = document.getElementById('custom-main-question');
  const questionCounter = document.getElementById('question-counter');

  if (questionTextarea && questionCounter) {
    questionTextarea.addEventListener('input', function() {
      const count = this.value.length;
      questionCounter.textContent = count + '/500';
      questionCounter.className = count > 450 ? 'text-xs text-red-400' : 'text-xs text-gray-500';
    });
  }
}

// Setup modal character counter observers
function setupModalCharacterCounters() {
  // モーダルが表示されるたびにカウンターをセットアップ
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const modal = document.getElementById('form-config-modal');
        if (modal && !modal.classList.contains('hidden')) {
          setTimeout(setupCharacterCounters, 100);
        }
      }
    });
  });
  
  // モーダルの監視を開始
  const modal = document.getElementById('form-config-modal');
  if (modal) {
    observer.observe(modal, { attributes: true });
  }
}

// Navigate to specific step in admin panel
function navigateToStep(step) {
  if (typeof currentStep !== 'undefined') {
    currentStep = step;
  } else {
    // Define currentStep if not already defined
    window.currentStep = step;
  }
  
  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
    const stepNumber = index + 1;
    indicator.classList.toggle('completed', stepNumber < step);
    indicator.classList.toggle('active', stepNumber === step);
  });
  
  // Show/hide step content
  document.querySelectorAll('.step-content').forEach((content, index) => {
    const stepNumber = index + 1;
    content.classList.toggle('hidden', stepNumber !== step);
  });
  
  // Update progress bar
  const progressBar = document.querySelector('.progress-bar');
  if (progressBar) {
    progressBar.style.width = ((step / 3) * 100) + '%';
  }
  
  if (typeof validateCurrentStep === 'function') {
    validateCurrentStep();
  }
}

// Make navigateToStep globally available
window.navigateToStep = navigateToStep;

// Initialize main admin panel
function initializeAdminPanel(incomingUserId) {
  // userId is now managed globally by adminPanel-core.js
  if (typeof loadUserInfo === 'function') loadUserInfo();
  if (typeof loadSystemStatus === 'function') loadSystemStatus();
  if (typeof setupEventListeners === 'function') setupEventListeners();
  if (typeof setupRealtimeUpdates === 'function') setupRealtimeUpdates();
  if (typeof validateCurrentStep === 'function') validateCurrentStep();
}

// Make initializeAdminPanel globally available
window.initializeAdminPanel = initializeAdminPanel;

// =============================================================================
// CRITICAL UI FUNCTIONS - Moved from adminPanel-ui.js.html for early availability
// =============================================================================

// Toggle section visibility
function toggleSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (!section) {
    console.warn('Section not found:', sectionId);
    return;
  }
  
  // Find the toggle button for this section
  const toggleBtn = document.querySelector('[onclick*="' + sectionId + '"]');
  const arrow = toggleBtn ? toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up') : null;
  
  // Toggle the section visibility
  if (section.classList.contains('hidden')) {
    // Show section
    section.classList.remove('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'true');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-up');
      arrow.classList.add('fa-chevron-down');
    }
  } else {
    // Hide section
    section.classList.add('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'false');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-down');
      arrow.classList.add('fa-chevron-up');
    }
  }
}

// Hide privacy modal
function hidePrivacyModal() {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('privacy-modal', false);
    }
  }
}

// Show form configuration modal
function showFormConfigModal() {
  if (window.sharedModals) {
    window.sharedModals.showFormConfig();
    if (typeof loadSavedClassChoices === 'function') {
      loadSavedClassChoices();
    }
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('form-config-modal', true);
    }
  } else {
    // Fallback for legacy support
    const modal = document.getElementById('form-config-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (typeof loadSavedClassChoices === 'function') {
        loadSavedClassChoices();
      }
      if (typeof manageFocusForModal === 'function') {
        manageFocusForModal('form-config-modal', true);
      }
    }
  }
}

// Enhanced updateUIWithNewStatus that works with both minimal and full implementations
function updateUIWithNewStatus(status) {
  if (!status) {
    console.warn('updateUIWithNewStatus: Invalid status received');
    return;
  }
  
  // Store for later use
  window.currentStatus = status;
  
  // Enhanced full implementation detection with multiple retries
  if (typeof window._fullUpdateUIWithNewStatus === 'function') {
    try {
      // 本番環境でのログ量を減らす
      if (window.DEBUG_MODE || window.location.hostname === 'localhost') {
        console.log('updateUIWithNewStatus: Using full implementation');
      }
      return window._fullUpdateUIWithNewStatus(status);
    } catch (error) {
      console.warn('Full updateUIWithNewStatus failed, using fallback:', error);
      // Continue with minimal implementation below
    }
  } else {
    // Enhanced retry mechanism with multiple attempts
    let retryCount = 0;
    const maxRetries = 3;
    const retryDelays = [200, 500, 1000]; // Progressive delays
    
    const tryFullImplementation = () => {
      if (typeof window._fullUpdateUIWithNewStatus === 'function') {
        console.log(`updateUIWithNewStatus: Full implementation now available (retry ${retryCount + 1})`);
        try {
          window._fullUpdateUIWithNewStatus(status);
          return;
        } catch (error) {
          console.warn('Retried full updateUIWithNewStatus failed:', error);
        }
      }
      
      if (retryCount < maxRetries) {
        retryCount++;
        setTimeout(tryFullImplementation, retryDelays[retryCount - 1] || 1000);
      } else {
        console.log('updateUIWithNewStatus: Max retries exceeded, using minimal implementation only');
      }
    };
    
    // Start retry sequence
    setTimeout(tryFullImplementation, retryDelays[0]);
  }
  
  // Enhanced minimal implementation for comprehensive UI updates
  console.log('updateUIWithNewStatus: Using enhanced minimal implementation');
  
  // Update essential UI elements with comprehensive information
  try {
    // 1. Update publication status with indicators
    if (status._normalized && typeof status._normalized.isPublished !== 'undefined') {
      const publishStatus = status._normalized.isPublished ? '公開中' : '停止中';
      const publishElement = document.getElementById('info-publish-text');
      if (publishElement) {
        publishElement.textContent = publishStatus;
      }
      
      // Update publish indicator
      const indicatorElement = document.getElementById('info-publish-indicator');
      const statusElement = document.getElementById('info-publish-status');
      if (status._normalized.isPublished) {
        if (statusElement) statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-green-600 text-white';
        if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-green-400';
      } else {
        if (statusElement) statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-gray-600 text-gray-300';
        if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      }
    }
    
    // 2. Update user information section
    if (status.userInfo) {
      const adminEmailEl = document.getElementById('info-admin-email');
      const userIdEl = document.getElementById('info-user-id');
      
      if (adminEmailEl && status.userInfo.adminEmail) {
        adminEmailEl.textContent = status.userInfo.adminEmail;
      }
      if (userIdEl && status.userInfo.userId) {
        userIdEl.textContent = status.userInfo.userId;
      }
      
      // Update spreadsheet access
      if (status.userInfo.spreadsheetUrl) {
        const spreadsheetBtn = document.getElementById('open-spreadsheet-btn-step2');
        if (spreadsheetBtn) {
          spreadsheetBtn.disabled = false;
          spreadsheetBtn.onclick = () => window.open(status.userInfo.spreadsheetUrl, '_blank');
        }
      }
    }
    
    // 3. Update configuration display
    if (status.config || (status.userInfo && status.userInfo.configJson)) {
      let config = status.config;
      if (!config && status.userInfo.configJson) {
        try {
          config = typeof status.userInfo.configJson === 'string' 
            ? JSON.parse(status.userInfo.configJson) 
            : status.userInfo.configJson;
        } catch (e) {
          console.warn('Failed to parse configJson in minimal implementation');
        }
      }
      
      if (config) {
        // Update published sheet name
        const publishedSheetEl = document.getElementById('info-published-sheet');
        if (publishedSheetEl) {
          publishedSheetEl.textContent = config.publishedSheetName || status.activeSheetName || 'なし';
        }
        
        // Update display mode
        const displayModeEl = document.getElementById('info-display-mode');
        if (displayModeEl) {
          displayModeEl.textContent = config.showNames ? '名前表示' : '匿名表示';
        }
        
        // Update show counts setting
        const showCountsEl = document.getElementById('info-show-counts');
        if (showCountsEl) {
          showCountsEl.textContent = config.showCounts ? '表示' : '非表示';
        }
      }
    }
    
    // 4. Update answer count if available
    if (status.answerCount !== undefined) {
      const answerCountElement = document.getElementById('answer-count');
      if (answerCountElement) {
        answerCountElement.textContent = status.answerCount || '0';
      }
    }
    
    // 5. Update active sheet information
    if (status.activeSheetName) {
      const sheetNameElements = document.querySelectorAll('.active-sheet-name');
      sheetNameElements.forEach(element => {
        element.textContent = status.activeSheetName;
      });
    }
    
    
  } catch (error) {
    console.error('Error in enhanced minimal updateUIWithNewStatus:', error);
  }
}

// Hide digital citizenship modal
function hideDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('digital-citizenship-modal', false);
    }
  }
}

// Hide confirmation modal
function hideConfirmationModal() {
  const modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('confirmation-modal', false);
    }
  }
}

// Unified showMessage function - uses SharedUtilities MessageManager
function showMessage(message, type = 'info', duration = 5000) {
  console.log(`[${type.toUpperCase()}] ${message}`);
  
  // Use SharedUtilities MessageManager if available
  if (window.sharedUtilities?.messages?.show) {
    return window.sharedUtilities.messages.show(message, type, duration);
  }
  
  // Fallback for cases where SharedUtilities is not loaded
  console.warn('⚠️ SharedUtilities MessageManager not available, using console fallback');
}

// =============================================================================
// VALIDATION FUNCTIONS - Moved from adminPanel-ui.js.html for early availability
// =============================================================================

// Validate configuration with fallback logic
function validateConfig() {
  // Try to use the full implementation if available
  if (typeof window._fullValidateConfig === 'function') {
    try {
      return window._fullValidateConfig();
    } catch (error) {
      console.warn('Full validateConfig failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential validation
  console.log('validateConfig: Using minimal implementation');
  
  try {
    // Check primary element first, then fallback to secondary element
    const opinionValueEl1 = document.getElementById('opinionHeader');
    const opinionValueEl2 = document.getElementById('reason-column');
    const opinionValue = (opinionValueEl1 && opinionValueEl1.value) || 
                        (opinionValueEl2 && opinionValueEl2.value) || '';
    
    return opinionValue && opinionValue.trim() !== '';
  } catch (error) {
    console.error('Error in minimal validateConfig:', error);
    return false;
  }
}

// Update configuration buttons state with fallback logic
function updateConfigButtons() {
  // Try to use the full implementation if available
  if (typeof window._fullUpdateConfigButtons === 'function') {
    try {
      return window._fullUpdateConfigButtons();
    } catch (error) {
      console.warn('Full updateConfigButtons failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential button updates
  console.log('updateConfigButtons: Using minimal implementation');
  
  try {
    const isValid = validateConfig();
    const saveBtn = document.getElementById('save-publish-btn');
    
    if (saveBtn) {
      saveBtn.disabled = !isValid;
      if (isValid) {
        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }
  } catch (error) {
    console.error('Error in minimal updateConfigButtons:', error);
  }
}

// =============================================================================
// FUNCTION AVAILABILITY MANAGEMENT
// =============================================================================

// Central function availability checker
function checkFunctionAvailability(functionName) {
  const isAvailable = typeof window[functionName] === 'function';
  if (!isAvailable) {
    console.warn(`⚠️ Function ${functionName} is not available`);
  }
  return isAvailable;
}

// Safe function caller with fallback handling
function safeCallFunction(functionName, ...args) {
  try {
    if (checkFunctionAvailability(functionName)) {
      return window[functionName](...args);
    } else {
      console.warn(`⚠️ Cannot call ${functionName} - function not available`);
      return null;
    }
  } catch (error) {
    console.error(`❌ Error calling ${functionName}:`, error);
    return null;
  }
}

// Enhanced function registry with full implementation tracking
window.AdminPanel.functionRegistry = {
  available: new Set(),
  pending: new Set(),
  fullImplementations: new Set(),
  
  register(functionName) {
    if (typeof window[functionName] === 'function') {
      this.available.add(functionName);
      this.pending.delete(functionName);
    } else {
      this.pending.add(functionName);
      console.warn(`⚠️ Function pending: ${functionName}`);
    }
  },
  
  registerFullImplementation(functionName) {
    const fullFuncName = `_full${functionName.charAt(0).toUpperCase()}${functionName.slice(1)}`;
    if (typeof window[fullFuncName] === 'function') {
      this.fullImplementations.add(functionName);
      // デバッグモードのみログ出力（本番での重複ログを減らす）
      if (window.DEBUG_MODE || window.location.hostname === 'localhost') {
        console.log(`🔧 Full implementation registered: ${fullFuncName}`);
      }
    }
  },
  
  hasFullImplementation(functionName) {
    const fullFuncName = `_full${functionName.charAt(0).toUpperCase()}${functionName.slice(1)}`;
    return typeof window[fullFuncName] === 'function';
  },
  
  isAvailable(functionName) {
    return this.available.has(functionName);
  },
  
  // Enhanced full implementation detection
  checkForFullImplementations() {
    const functionsToCheck = [
      'updateUIWithNewStatus', 'populateHeaderOptions', 'populateConfig', 
      'updateFormUrlDisplay', 'validateConfig', 'updateConfigButtons'
    ];
    
    let foundCount = 0;
    functionsToCheck.forEach(funcName => {
      if (this.hasFullImplementation(funcName)) {
        this.registerFullImplementation(funcName);
        foundCount++;
      }
    });
    
    // 本番環境でのログ量を減らす
    if (window.DEBUG_MODE || window.location.hostname === 'localhost') {
      console.log(`🔍 Full implementations check: ${foundCount}/${functionsToCheck.length} available`);
    }
    return foundCount;
  },
  
  waitFor(functionName, timeout = 5000) {
    return new Promise((resolve, reject) => {
      if (this.isAvailable(functionName)) {
        resolve(window[functionName]);
        return;
      }
      
      const startTime = Date.now();
      const checkInterval = setInterval(() => {
        if (this.isAvailable(functionName)) {
          clearInterval(checkInterval);
          resolve(window[functionName]);
        } else if (Date.now() - startTime > timeout) {
          clearInterval(checkInterval);
          reject(new Error(`Function ${functionName} not available after ${timeout}ms`));
        }
      }, 100);
    });
  }
};

// =============================================================================
// ADDITIONAL UI FUNCTIONS - Critical functions that were missing
// =============================================================================

// Update form URL display (minimal implementation)
function updateFormUrlDisplay(status = null) {
  // Try to use the full implementation if available
  if (typeof window._fullUpdateFormUrlDisplay === 'function') {
    try {
      return window._fullUpdateFormUrlDisplay(status);
    } catch (error) {
      console.warn('Full updateFormUrlDisplay failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential form URL updates
  console.log('updateFormUrlDisplay: Using minimal implementation');
  
  try {
    const formUrlInput = document.getElementById('form-url-input');
    if (!formUrlInput) return;
    
    const currentStatusToUse = status || window.currentStatus;
    if (!currentStatusToUse || !currentStatusToUse.userInfo) {
      console.warn('⚠️ updateFormUrlDisplay: status情報が不足しています');
      return;
    }
    
    // Simple form URL extraction
    let formUrl = null;
    if (currentStatusToUse.userInfo.configJson) {
      try {
        const config = typeof currentStatusToUse.userInfo.configJson === 'string' 
          ? JSON.parse(currentStatusToUse.userInfo.configJson) 
          : currentStatusToUse.userInfo.configJson;
        formUrl = config.formUrl;
      } catch (e) {
        console.warn('Failed to parse configJson for form URL');
      }
    }
    
    if (formUrl) {
      formUrlInput.value = formUrl;
      const openFormLink = document.getElementById('open-form-url-link');
      if (openFormLink) {
        openFormLink.href = formUrl;
      }
    }
  } catch (error) {
    console.error('Error in minimal updateFormUrlDisplay:', error);
  }
}

// Populate header options (minimal implementation)
function populateHeaderOptions(headers) {
  // Try to use the full implementation if available
  if (typeof window._fullPopulateHeaderOptions === 'function') {
    try {
      return window._fullPopulateHeaderOptions(headers);
    } catch (error) {
      console.warn('Full populateHeaderOptions failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential header population
  console.log('populateHeaderOptions: Using minimal implementation');
  
  try {
    if (window.populateHeaderOptionsRunning) {
      return;
    }
    window.populateHeaderOptionsRunning = true;
    
    const selects = ['opinionHeader', 'reason-column', 'name-column', 'class-column'];
    
    selects.forEach(selectId => {
      const select = document.getElementById(selectId);
      if (select) {
        const currentValue = select.value;
        
        if (headers && headers.length > 0) {
          select.innerHTML = '<option value="">-- 列を選択 --</option>';
          headers.forEach(header => {
            if (header && typeof header === 'string' && header.trim()) {
              const option = document.createElement('option');
              option.value = header;
              option.textContent = header;
              select.appendChild(option);
            }
          });
          select.disabled = false;
          if (currentValue) {
            select.value = currentValue;
          }
        } else {
          select.innerHTML = '<option value="">-- シートを選択してください --</option>';
          select.disabled = true;
        }
      }
    });
    
    setTimeout(() => {
      window.populateHeaderOptionsRunning = false;
    }, 100);
  } catch (error) {
    console.error('Error in minimal populateHeaderOptions:', error);
    window.populateHeaderOptionsRunning = false;
  }
}

// Make all critical functions globally available immediately
window.toggleSection = toggleSection;
window.hidePrivacyModal = hidePrivacyModal;
window.hideDigitalCitizenshipModal = hideDigitalCitizenshipModal;
window.hideConfirmationModal = hideConfirmationModal;
window.showFormConfigModal = showFormConfigModal;
window.showMessage = showMessage; // Unified with SharedUtilities MessageManager
window.updateUIWithNewStatus = updateUIWithNewStatus;
window.validateConfig = validateConfig;
window.updateConfigButtons = updateConfigButtons;
// Populate configuration (minimal implementation)
function populateConfig(cfg) {
  // ドラフトモード時のログ出力
  if (window._draftModeActive) {
    console.log('📝 populateConfig: ドラフトモードで設定を反映中');
  }

  // Try to use the full implementation if available
  if (typeof window._fullPopulateConfig === 'function') {
    try {
      return window._fullPopulateConfig(cfg);
    } catch (error) {
      console.warn('Full populateConfig failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential config population
  console.log('populateConfig: Using minimal implementation');
  
  try {
    if (!cfg) return;
    
    if (window.populateConfigRunning) {
      return;
    }
    window.populateConfigRunning = true;
    
    const mappings = {
      'opinionHeader': cfg.opinionHeader || cfg.opinionColumn,
      'reason-column': cfg.reasonColumn || cfg.reasonHeader,
      'name-column': cfg.nameColumn || cfg.nameHeader,
      'class-column': cfg.classColumn || cfg.classHeader,
      'show-names': cfg.showNames,
      'show-counts': cfg.showCounts
    };
    
    Object.keys(mappings).forEach(elementId => {
      const element = document.getElementById(elementId);
      const value = mappings[elementId];
      
      if (element && value !== undefined) {
        if (element.type === 'checkbox') {
          element.checked = Boolean(value);
        } else {
          element.value = value;
        }
      }
    });
    
    setTimeout(() => {
      window.populateConfigRunning = false;
    }, 100);
  } catch (error) {
    console.error('Error in minimal populateConfig:', error);
    window.populateConfigRunning = false;
  }
}

window.updateFormUrlDisplay = updateFormUrlDisplay;
window.populateHeaderOptions = populateHeaderOptions;
window.populateConfig = populateConfig;
window.checkFunctionAvailability = checkFunctionAvailability;
window.safeCallFunction = safeCallFunction;

// Register all critical functions
const criticalFunctions = [
  'toggleSection', 'hidePrivacyModal', 'hideDigitalCitizenshipModal', 
  'hideConfirmationModal', 'showFormConfigModal', 'showMessage', 
  'updateUIWithNewStatus', 'validateConfig', 'updateConfigButtons', 
  'updateFormUrlDisplay', 'populateHeaderOptions', 'populateConfig',
  'navigateToStep', 'initializeAdminPanel'
];

criticalFunctions.forEach(funcName => {
  window.AdminPanel.functionRegistry.register(funcName);
});

// Full implementation monitoring with periodic checks
let fullImplCheckCount = 0;
const maxFullImplChecks = 10;

function checkFullImplementationsAvailability() {
  fullImplCheckCount++;
  const foundCount = window.AdminPanel.functionRegistry.checkForFullImplementations();
  
  if (foundCount > 0) {
    console.log(`🎉 Found ${foundCount} full implementations on attempt ${fullImplCheckCount}`);
    
    // Force retry of UI updates with full implementations now available
    if (window.currentStatus && foundCount >= 3) {
      console.log('🔄 Retrying UI updates with full implementations');
      setTimeout(() => {
        if (typeof window._fullUpdateUIWithNewStatus === 'function') {
          window._fullUpdateUIWithNewStatus(window.currentStatus);
        }
      }, 100);
    }
  } else if (fullImplCheckCount < maxFullImplChecks) {
    // Continue checking for full implementations
    setTimeout(checkFullImplementationsAvailability, 500);
  } else {
    console.warn('⚠️ Full implementations not found after maximum attempts');
  }
}

// Start monitoring for full implementations after a delay
setTimeout(checkFullImplementationsAvailability, 300);

// =============================================================================
// SYSTEM STATUS AND USER INTERACTION MANAGEMENT
// =============================================================================

// システム監視用の状態管理
window.systemStatus = {
  initializationStarted: false,
  coreInitialized: false,
  apiInitialized: false,
  uiInitialized: false,
  eventsInitialized: false,
  initializationComplete: false,
  userDataSyncComplete: false,
  errors: [],
  lastActivity: Date.now()
};

// 初期化中のユーザー操作防止 - DOM準備完了後に実行
if (document.body) {
  document.body.style.pointerEvents = 'none';
  console.log('🛡️ User interaction disabled during initialization');
} else {
  // DOM読み込み完了を待ってから実行
  document.addEventListener('DOMContentLoaded', function() {
    if (document.body) {
      document.body.style.pointerEvents = 'none';
      console.log('🛡️ User interaction disabled during initialization (delayed)');
    }
  });
}

// 主要なUI要素を無効化する関数
function disableUserInteraction() {
  // DOM準備完了チェック
  if (!document || !document.body) {
    console.warn('⚠️ DOM not ready for disableUserInteraction');
    return;
  }
  
  // フォーム要素の無効化
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(element => {
    element.disabled = true;
    element.style.opacity = '0.6';
  });
  
  // クリック可能な要素の無効化
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(element => {
    element.style.pointerEvents = 'none';
    element.style.opacity = '0.6';
  });
  
  // body要素の無効化
  document.body.style.pointerEvents = 'none';
  
  console.log('🛡️ All interactive elements disabled');
}

// UI要素を有効化する関数
function enableUserInteraction() {
  // DOM準備完了チェック
  if (!document || !document.body) {
    console.warn('⚠️ DOM not ready for enableUserInteraction');
    return;
  }
  
  // フォーム要素の有効化
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(element => {
    element.disabled = false;
    element.style.opacity = '';
  });
  
  // クリック可能な要素の有効化
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(element => {
    element.style.pointerEvents = '';
    element.style.opacity = '';
  });
  
  // body要素も有効化
  document.body.style.pointerEvents = 'auto';
  
  console.log('✅ All interactive elements enabled');
}

// DOM読み込み後に要素を無効化
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', disableUserInteraction);
} else {
  disableUserInteraction();
}

function updateSystemStatus(component, status, error = null) {
  window.systemStatus[component] = status;
  window.systemStatus.lastActivity = Date.now();
  if (error) {
    window.systemStatus.errors.push({ component, error: error.toString(), timestamp: Date.now() });
  }
  logDebug(`📊 System Status: ${component} = ${status}`);
}

// 公開停止後の全セクション展開処理
function checkAndExpandAllSections() {
  try {
    const expandAllFlag = localStorage.getItem('expandAllSections');
    if (expandAllFlag === 'true') {
      logInfo('📂 公開停止後のため全セクションを展開します');
      
      // 少し遅延してからセクションを展開（DOM要素の準備を待つ）
      setTimeout(() => {
        const sectionIds = ['step1-content', 'step2-content', 'step3-content'];
        let expandedCount = 0;
        
        sectionIds.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            // セクションが折りたたまれている場合のみ展開
            if (section.classList.contains('hidden')) {
              if (typeof toggleSection === 'function') {
                toggleSection(sectionId);
                expandedCount++;
                logDebug(`✅ セクション展開: ${sectionId}`);
              }
            }
          }
        });
        
        if (expandedCount > 0) {
          logInfo(`📂 ${expandedCount}個のセクションを展開しました`);
        }
        
        // フラグをクリア（一度だけ実行）
        localStorage.removeItem('expandAllSections');
        logDebug('🧹 全セクション展開フラグをクリアしました');
      }, 500);
    }
  } catch (error) {
    logWarn('⚠️ 全セクション展開処理でエラー:', error);
  }
}

// =============================================================================
// MASTER INITIALIZATION SYSTEM
// =============================================================================

function initializeAdminPanelMaster() {
  // シンプル化: 重複初期化チェックを簡素化
  if (window.AdminPanel.initialization.isCompleted) {
    logDebug('✅ AdminPanel already initialized');
    return;
  }
  
  window.AdminPanel.initialization.isInProgress = true;
  logInfo('🚀 AdminPanel Master Initialization Started');
  
  // Phase 1: Core初期化
  try {
    initCore();
  } catch (error) {
    console.error('❌ Core initialization failed:', error);
  }
  
  // 公開停止後の全セクション展開処理
  checkAndExpandAllSections();
  
  // フォーム作成完了表示をクリア（新規アクセス時はデフォルトで非表示）
  setTimeout(() => {
    const formJustCreated = sessionStorage.getItem('form_just_created');
    if (formJustCreated !== 'true') {
      // 新規作成ではない場合、セクションを非表示にする
      const formUrlSection = document.getElementById('form-url-section');
      if (formUrlSection && !formUrlSection.classList.contains('hidden')) {
        formUrlSection.classList.add('hidden');
        logDebug('📋 既存アクセス時はフォーム完了セクションを非表示');
      }
    }
  }, 100);
  
  // Phase 2: Sequential Module Initialization (Sync Order)
  // Initialize modules in strict sequential order to prevent race conditions
  initializeModulesSequentially();
}

// Sequential module initialization function
async function initializeModulesSequentially() {
  console.log('CRITICAL: Starting sequential module initialization');
  
  // Step 1: Status module
  try {
    initializeMessageArea();
    console.log('CRITICAL: Status module initialized');
  } catch (error) {
    console.error('CRITICAL: Status module failed:', error);
  }
  
  // Step 2: API module (wait for functions to be available)
  await new Promise(resolve => {
    let attempts = 0;
    const maxAttempts = 50; // 5 second timeout
    
    const checkAPI = () => {
      attempts++;
      try {
        if (typeof initializeAPI === 'function') {
          initializeAPI();
          console.log('CRITICAL: API module initialized');
          resolve();
        } else if (attempts >= maxAttempts) {
          console.error('CRITICAL: API module timeout - initializeAPI not available');
          resolve(); // Continue anyway
        } else {
          setTimeout(checkAPI, 100);
        }
      } catch (error) {
        console.error('CRITICAL: API initialization failed:', error);
        resolve(); // Continue anyway
      }
    };
    
    checkAPI();
  });
  
  // Step 3: UI module
  try {
    if (typeof initializeUI === 'function') {
      initializeUI();
      console.log('CRITICAL: UI module initialized');
    }
  } catch (error) {
    console.error('CRITICAL: UI initialization failed:', error);
  }
  
  // Step 4: Forms module
  try {
    if (typeof setupCharacterCounters === 'function') {
      setupCharacterCounters();
    }
    if (typeof setupModalCharacterCounters === 'function') {
      setupModalCharacterCounters();
    }
    console.log('CRITICAL: Forms module initialized');
  } catch (error) {
    console.error('CRITICAL: Forms initialization failed:', error);
  }
  
  // Step 5: Events module (last - wait for all functions to be available)
  await new Promise(resolve => {
    let attempts = 0;
    const maxAttempts = 50;
    
    const checkEvents = () => {
      attempts++;
      try {
        if (typeof initializeEventListeners === 'function' && 
            typeof runHeaderGuessing === 'function' &&
            typeof openAppSetupPage === 'function') {
          initializeEventListeners();
          console.log('CRITICAL: Events module initialized');
          console.log('CRITICAL: AdminPanel Master Initialization Complete');
          finalizeInitialization();
          resolve();
        } else if (attempts >= maxAttempts) {
          console.error('CRITICAL: Events module timeout - some functions not available');
          console.log('CRITICAL: Available functions:', {
            initializeEventListeners: typeof initializeEventListeners,
            runHeaderGuessing: typeof runHeaderGuessing, 
            openAppSetupPage: typeof openAppSetupPage
          });
          finalizeInitialization();
          resolve();
        } else {
          setTimeout(checkEvents, 100);
        }
      } catch (error) {
        console.error('CRITICAL: Events initialization failed:', error);
        finalizeInitialization();
        resolve();
      }
    };
    
    checkEvents();
  });
}

// Finalize initialization and enable user interaction
async function finalizeInitialization() {
  setTimeout(async () => {
    try {
      console.log('🔄 Final initialization steps...');
      
      // すべての同期が完了したらローディングオーバーレイを非表示
      if (window.unifiedLoading) {
        window.unifiedLoading.hide();
      } else {
        // フォールバック: 直接DOM操作
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.add('hidden');
        }
      }
      
      // UI要素の有効化
      enableUserInteraction();
      
      // Draft recovery after initialization complete
      try {
        console.log('🔄 Checking for draft recovery...');
        if (typeof recoverDraftIfAvailable === 'function') {
          recoverDraftIfAvailable();
        }
      } catch (draftError) {
        console.warn('⚠️ Draft recovery failed:', draftError);
      }
      
      // 初期化完了
      window.AdminPanel.initialization.isInProgress = false;
      window.AdminPanel.initialization.isCompleted = true;
      logInfo('✅ AdminPanel Master Initialization Completed');
      
    } catch (error) {
      console.error('❌ Final sync error:', error);
      // エラーでもローディングは解除
      if (window.unifiedLoading) {
        window.unifiedLoading.hide();
      }
      enableUserInteraction();
      
      // 初期化完了（エラーありでも）
      window.AdminPanel.initialization.isInProgress = false;
      window.AdminPanel.initialization.isCompleted = true;
      logWarn('⚠️ AdminPanel initialization completed with errors');
    }
  }, 500);
}

// 単一DOMContentLoadedハンドラー
if (document.readyState !== 'loading') {
  initializeAdminPanelMaster();
} else {
  document.addEventListener('DOMContentLoaded', initializeAdminPanelMaster);
}

// Update layout on resize
window.addEventListener('resize', function() {
  if (typeof debounce === 'function') {
    debounce(adjustLayout, 250, 'layout-resize')();
  } else {
    // Fallback without debounce
    adjustLayout();
  }
});

// Account management modal functionality has been removed
// Individual user access control is now handled in AppSetupPage.html
/*
  
  // Setup event listeners
  setupEventListeners: function() {
    const accountBtn = document.getElementById('account-management-btn');
    const closeBtn = document.getElementById('account-modal-close');
    const cancelBtn = document.getElementById('account-modal-cancel');
    const saveBtn = document.getElementById('save-access-settings');
    const deleteBtn = document.getElementById('delete-account-btn');
    const toggle = document.getElementById('user-access-toggle');
    
    if (accountBtn) {
      accountBtn.addEventListener('click', () => this.openModal());
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', () => this.closeModal());
    }
    
    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => this.closeModal());
    }
    
    if (saveBtn) {
      saveBtn.addEventListener('click', () => this.saveAccessSettings());
    }
    
    if (deleteBtn) {
      deleteBtn.addEventListener('click', () => this.handleDeleteAccount());
    }
    
    if (toggle) {
      toggle.addEventListener('change', () => this.onToggleChange());
    }
    
    // Close modal on backdrop click
    if (this.modal) {
      this.modal.addEventListener('click', (e) => {
        if (e.target === this.modal) {
          this.closeModal();
        }
      });
    }
  },
  
  // Open modal and load current status
  openModal: function() {
    if (!this.modal) return;
    
    this.modal.classList.remove('hidden');
    this.modal.classList.add('flex');
    this.modal.setAttribute('aria-hidden', 'false');
    
    // Focus management for accessibility
    const firstFocusable = this.modal.querySelector('button, input, textarea, select, [tabindex]:not([tabindex="-1"])');
    if (firstFocusable) {
      setTimeout(() => firstFocusable.focus(), 100);
    }
    
    // Load current user access status
    this.loadCurrentStatus();
    
    logDebug('📝 Account management modal opened');
  },
  
  // Close modal
  closeModal: function() {
    if (!this.modal) return;
    
    this.modal.classList.add('hidden');
    this.modal.classList.remove('flex');
    this.modal.setAttribute('aria-hidden', 'true');
    
    // Reset form state
    this.resetForm();
    
    logDebug('❌ Account management modal closed');
  },
  
  // Load current user access status
  loadCurrentStatus: function() {
    const statusElement = document.getElementById('user-access-status');
    const toggle = document.getElementById('user-access-toggle');
    
    if (statusElement) {
      statusElement.textContent = '🔄 読み込み中...';
      statusElement.className = 'ml-2 px-2 py-1 rounded-full text-xs font-medium bg-gray-600 text-gray-300';
    }
    
    if (toggle) {
      toggle.disabled = true;
    }
    
    // Get current user status from the global status
    if (window.currentStatus && window.currentStatus.userInfo) {
      const userInfo = window.currentStatus.userInfo;
      const isActive = userInfo.isActive !== false; // Default to true if not specified
      
      this.updateStatusDisplay(isActive);
      
      if (toggle) {
        toggle.checked = isActive;
        toggle.disabled = false;
      }
      
      this.currentUserStatus = isActive;
      logDebug(`📊 Current user isActive status: ${isActive}`);
    } else {
      // Fallback: call API to get current status
      if (typeof runGasWithUserId === 'function') {
        runGasWithUserId('getUserActiveStatus')
          .then((result) => {
            if (result && typeof result.isActive === 'boolean') {
              const isActive = result.isActive;
              this.updateStatusDisplay(isActive);
              
              if (toggle) {
                toggle.checked = isActive;
                toggle.disabled = false;
              }
              
              this.currentUserStatus = isActive;
            } else {
              this.showStatusError('ユーザー状態の取得に失敗しました');
            }
          })
          .catch((error) => {
            console.error('❗ Failed to load user status:', error);
            this.showStatusError('ユーザー状態の取得エラー');
          });
      } else {
        this.showStatusError('APIが利用できません');
      }
    }
  },
  
  // Update status display
  updateStatusDisplay: function(isActive) {
    const statusElement = document.getElementById('user-access-status');
    if (!statusElement) return;
    
    if (isActive) {
      statusElement.textContent = '✅ 有効';
      statusElement.className = 'ml-2 px-2 py-1 rounded-full text-xs font-medium bg-green-600 text-white';
    } else {
      statusElement.textContent = '❌ 無効';
      statusElement.className = 'ml-2 px-2 py-1 rounded-full text-xs font-medium bg-red-600 text-white';
    }
  },
  
  // Show status error
  showStatusError: function(message) {
    const statusElement = document.getElementById('user-access-status');
    const toggle = document.getElementById('user-access-toggle');
    
    if (statusElement) {
      statusElement.textContent = `❗ ${message}`;
      statusElement.className = 'ml-2 px-2 py-1 rounded-full text-xs font-medium bg-yellow-600 text-white';
    }
    
    if (toggle) {
      toggle.disabled = true;
    }
  },
  
  // Handle toggle change
  onToggleChange: function() {
    const toggle = document.getElementById('user-access-toggle');
    const saveBtn = document.getElementById('save-access-settings');
    
    if (toggle && saveBtn) {
      const hasChanges = toggle.checked !== this.currentUserStatus;
      saveBtn.disabled = !hasChanges;
      
      if (hasChanges) {
        saveBtn.textContent = '設定を保存';
        saveBtn.classList.remove('bg-gray-600', 'cursor-not-allowed');
        saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
      } else {
        saveBtn.textContent = '変更なし';
        saveBtn.classList.add('bg-gray-600', 'cursor-not-allowed');
        saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
      }
    }
  },
  
  // Save access settings
  saveAccessSettings: function() {
    const toggle = document.getElementById('user-access-toggle');
    const saveBtn = document.getElementById('save-access-settings');
    
    if (!toggle || toggle.disabled) return;
    
    const newStatus = toggle.checked;
    const originalText = saveBtn.textContent;
    
    // Update UI
    saveBtn.disabled = true;
    saveBtn.textContent = '🔄 保存中...';
    
    if (typeof runGasWithUserId === 'function') {
      runGasWithUserId('updateSelfActiveStatus', false, userId, newStatus)
        .then((result) => {
          if (result && result.success) {
            this.currentUserStatus = newStatus;
            this.updateStatusDisplay(newStatus);
            
            // Show success message
            if (window.showMessage) {
              showMessage(`✅ アクセス設定を${newStatus ? '有効' : '無効'}に変更しました`, 'success');
            }
            
            // Close modal after short delay
            setTimeout(() => {
              this.closeModal();
            }, 1500);
            
          } else {
            throw new Error(result.message || '設定の保存に失敗しました');
          }
        })
        .catch((error) => {
          console.error('❗ Failed to save access settings:', error);
          
          // Revert toggle state
          toggle.checked = this.currentUserStatus;
          
          // Show error message
          if (window.showMessage) {
            showMessage(`❌ 設定の保存に失敗しました: ${error.message || error}`, 'error');
          }
        })
        .finally(() => {
          // Reset button state
          saveBtn.textContent = originalText;
          this.onToggleChange(); // Re-evaluate button state
        });
    } else {
      console.error('❗ runGasWithUserId function not available');
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
      
      if (window.showMessage) {
        showMessage('❌ APIが利用できません', 'error');
      }
    }
  },
  
  // Handle account deletion
  handleDeleteAccount: function() {
    // Use existing delete account functionality
    if (typeof handleDeleteRequest === 'function') {
      this.closeModal(); // Close the modal first
      setTimeout(() => {
        handleDeleteRequest(); // Call existing delete function
      }, 300);
    } else {
      console.error('❗ handleDeleteRequest function not available');
      if (window.showMessage) {
        showMessage('❌ アカウント削除機能が利用できません', 'error');
      }
    }
  },
  
  // Reset form state
  resetForm: function() {
    const toggle = document.getElementById('user-access-toggle');
    const saveBtn = document.getElementById('save-access-settings');
    
    if (toggle && this.currentUserStatus !== null) {
      toggle.checked = this.currentUserStatus;
      toggle.disabled = false;
    }
    
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = '設定を保存';
      saveBtn.classList.add('bg-gray-600', 'cursor-not-allowed');
      saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    }
  }
};

*/
// Account management initialization has been removed

// =============================================================================
// UNIFIED HISTORY MANAGEMENT SYSTEM 
// =============================================================================

/**
 * Unified History Manager - Simple, Error-Resilient, Single Responsibility
 */
// History features have been removed


//# sourceURL=adminPanel-framework.js.html
</script>
