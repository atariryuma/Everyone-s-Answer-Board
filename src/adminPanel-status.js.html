<script>
// =============================================================================
// ADMIN PANEL ERROR HANDLING & STATUS MANAGEMENT
// =============================================================================

// =============================================================================
// ERROR HANDLING SYSTEM
// =============================================================================

function handleError(error, context, userMessage) {
  console.error(`âŒ Error in ${context}:`, error);
  
  if (error && typeof error === 'object') {
    console.error('Error details:', {
      message: error.message,
      stack: error.stack,
      name: error.name
    });
  }

  var displayMessage = userMessage || translateErrorMessage(error?.message || String(error), context);
  showMessage(displayMessage, 'error');
}

// Error message translation for better UX
function translateErrorMessage(errorMsg, context) {
  const lowerMsg = errorMsg.toLowerCase();
  
  // ç¯„å›²ã‚¨ãƒ©ãƒ¼
  if (lowerMsg.includes('ç¯„å›²ã®åˆ—æ•°ã«ã¯') || lowerMsg.includes('range')) {
    return 'é¸æŠã—ãŸç¯„å›²ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
  }
  
  // ã‚·ãƒ¼ãƒˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼
  if (lowerMsg.includes('ã‚·ãƒ¼ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—') || lowerMsg.includes('sheet')) {
    return 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
  }
  
  // æ¨©é™ã‚¨ãƒ©ãƒ¼
  if (lowerMsg.includes('permission') || lowerMsg.includes('æ¨©é™') || lowerMsg.includes('access denied')) {
    return 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
  }
  
  // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
  if (lowerMsg.includes('network') || lowerMsg.includes('timeout') || lowerMsg.includes('fetch')) {
    return 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ é–¢é€£ã‚¨ãƒ©ãƒ¼
  if (lowerMsg.includes('form') && lowerMsg.includes('not found')) {
    return 'ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚';
  }
  
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
  if (lowerMsg.includes('validation') || lowerMsg.includes('invalid')) {
    return 'å…¥åŠ›å†…å®¹ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚å¿…é ˆé …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
  }
  
  // èªè¨¼ã‚¨ãƒ©ãƒ¼
  if (lowerMsg.includes('authentication') || lowerMsg.includes('login') || lowerMsg.includes('unauthorized')) {
    return 'èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
  }
  
  // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼
  if (lowerMsg.includes('server error') || lowerMsg.includes('500') || lowerMsg.includes('503')) {
    return 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
  }
  
  // è¨­å®šã‚¨ãƒ©ãƒ¼
  if (context && context.includes('config') || lowerMsg.includes('configuration')) {
    return 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
  }
  
  // ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼
  if (lowerMsg.includes('failed') || lowerMsg.includes('error')) {
    return 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
  }
  
  return errorMsg || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
}

// Safe GAS call wrapper with error handling
function safeGASCall(methodName, successHandler, errorMessage) {
  return function(...args) {
    try {
      return google.script.run
        .withSuccessHandler(successHandler)
        .withFailureHandler(function(error) {
          handleError(error, methodName, errorMessage);
        })[methodName](...args);
    } catch (e) {
      handleError(e, methodName, errorMessage);
    }
  };
}

// Show error with context
function showError(error) {
  handleError(error, 'UI', null);
}

// =============================================================================
// STATUS VALIDATION AND UPDATES
// =============================================================================

// API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¨™æº–åŒ–: å¼·åŒ–ã•ã‚ŒãŸæ¤œè¨¼ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
function validateStatus(status) {
  if (!status) {
    console.error('âŒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼å¤±æ•—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒnullã¾ãŸã¯undefined');
    showMessage('ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®å¿œç­”ãŒç„¡åŠ¹ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    return false;
  }
  
  // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‡¦ç†
  if (status.status === 'error') {
    console.error('âŒ APIã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', status.message);
    showMessage('ã‚¨ãƒ©ãƒ¼: ' + status.message, 'error');
    return false;
  }
  
  // ç°¡ç´ åŒ–ã•ã‚ŒãŸæ¤œè¨¼å®Ÿè¡Œï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’å‰Šé™¤ï¼‰
  return performStatusValidation(status);
}


// ğŸ”§ å®Ÿéš›ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¤œè¨¼å‡¦ç†ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡ï¼‰
function performStatusValidation(status) {
  console.log('ğŸ” ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¤œè¨¼ã‚’å®Ÿè¡Œä¸­...');
  
  // å¿…é ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®æ¤œè¨¼
  const validationErrors = [];
  
  if (!status.userInfo) {
    validationErrors.push('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  } else {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è©³ç´°æ¤œè¨¼
    if (!status.userInfo.userId) {
      validationErrors.push('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }
    if (!status.userInfo.adminEmail) {
      validationErrors.push('ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }
  }
  
  // è¨­å®šæƒ…å ±ã®æ¤œè¨¼
  if (!status.config) {
    validationErrors.push('è¨­å®šæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    console.warn('âš ï¸ status.config ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§åˆæœŸåŒ–ã—ã¾ã™');
    status.config = {};
  }
  
  // appUrlsã®æ¤œè¨¼
  if (!status.appUrls) {
    validationErrors.push('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    console.warn('âš ï¸ status.appUrls ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
  }
  
  // ã‚·ãƒ¼ãƒˆæƒ…å ±ã®æ¤œè¨¼ï¼ˆè­¦å‘Šãƒ¬ãƒ™ãƒ«ï¼‰
  if (!status.allSheets || !Array.isArray(status.allSheets)) {
    console.warn('âš ï¸ ã‚·ãƒ¼ãƒˆä¸€è¦§ãŒç„¡åŠ¹ã¾ãŸã¯å­˜åœ¨ã—ã¾ã›ã‚“:', status.allSheets);
    status.allSheets = []; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  }
  
  // ã‚·ãƒ¼ãƒˆè©³ç´°ã®æ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
  if (status.sheetDetails) {
    if (!status.sheetDetails.allHeaders || !Array.isArray(status.sheetDetails.allHeaders)) {
      console.warn('âš ï¸ ã‚·ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ãŒç„¡åŠ¹ã§ã™:', status.sheetDetails.allHeaders);
      console.warn('ã“ã‚Œã¯ã€ŒNo headers found for ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”ã€ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
    } else {
      console.log('âœ… ã‚·ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼æ¤œè¨¼OK:', status.sheetDetails.allHeaders.length + 'å€‹ã®ãƒ˜ãƒƒãƒ€ãƒ¼');
    }
    
    if (!status.sheetDetails.guessedConfig) {
      console.warn('âš ï¸ AIåˆ—åˆ¤å®šçµæœãŒå­˜åœ¨ã—ã¾ã›ã‚“ - æ‰‹å‹•è¨­å®šãŒå¿…è¦ã§ã™');
    } else {
      console.log('âœ… AIåˆ—åˆ¤å®šçµæœãŒåˆ©ç”¨å¯èƒ½:', status.sheetDetails.guessedConfig);
    }
  } else {
    console.log('â„¹ï¸ ã‚·ãƒ¼ãƒˆè©³ç´°ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãªã®ã§å­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆæ­£å¸¸ï¼‰');
  }
  
  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ—ã®æ¤œè¨¼
  if (typeof status.setupStep !== 'number') {
    console.warn('âš ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ—ãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', status.setupStep);
    status.setupStep = 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  }
  
  // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆ
  if (validationErrors.length > 0) {
    console.error('âŒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', validationErrors);
    showMessage('ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ' + validationErrors.join(', '), 'error');
    return false;
  }
  
  console.log('âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼æˆåŠŸ');
  return true;
}

// Update user activity timestamp for polling optimization
function updateUserActivity() {
  lastUserActivity = Date.now();
}

// =============================================================================
// INITIALIZATION HELPERS
// =============================================================================

// Initialize message area
function initializeMessageArea() {
  var messageArea = document.getElementById('message-area');
  if (!messageArea) {
    // Create message area if it doesn't exist
    messageArea = document.createElement('div');
    messageArea.id = 'message-area';
    messageArea.className = 'fixed top-4 right-4 z-50 max-w-sm';
    document.body.appendChild(messageArea);
  }
}

// åˆæœŸåŒ–ã¯ adminPanel-core.js ã®çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ã§ç®¡ç†ã•ã‚Œã¾ã™
</script>
