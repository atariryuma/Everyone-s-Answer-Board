// =============================================================================
// ADMIN PANEL ERROR HANDLING & STATUS MANAGEMENT
// =============================================================================

// =============================================================================
// ERROR HANDLING SYSTEM
// =============================================================================
// handleError implementation is now provided by window.AdminPanel.errors.handle
// defined in adminPanel-framework.js.html. All calls in this file rely on the
// global handleError for unified error processing.

// Safe GAS call wrapper with error handling
function safeGASCall(methodName, successHandler, errorMessage) {
  return function(...args) {
    try {
      return google.script.run
        .withSuccessHandler(successHandler)
        .withFailureHandler(function(error) {
          handleError(error, methodName, errorMessage);
        })[methodName](...args);
    } catch (e) {
      handleError(e, methodName, errorMessage);
    }
  };
}

// Show error with context
function showError(error) {
  handleError(error, 'UI', null);
}

// =============================================================================
// STATUS VALIDATION AND UPDATES
// =============================================================================

// 検証ログの重複防止用キャッシュ
let lastValidationHash = null;
let validationLogCount = 0;

// API レスポンス標準化: 強化された検証とエラーハンドリング
function validateStatus(status) {
  if (!status) {
    console.error('❌ レスポンス検証失敗: ステータスオブジェクトがnullまたはundefined');
    showMessage('システムからの応答が無効です。ページを再読み込みしてください。', 'error');
    return false;
  }
  
  // エラーレスポンスの処理
  if (status.status === 'error') {
    console.error('❌ APIエラーレスポンス:', status.message);
    showMessage('エラー: ' + status.message, 'error');
    return false;
  }
  
  // 重複検証防止: 同じデータに対する検証ログを制限
  const validationKey = JSON.stringify({
    userId: status.userInfo && status.userInfo.userId,
    activeSheet: status.activeSheetName,
    headerCount: status.sheetDetails && status.sheetDetails.allHeaders && status.sheetDetails.allHeaders.length,
    setupStep: status.setupStep
  });
  
  const shouldLogValidation = lastValidationHash !== validationKey || validationLogCount < 2;
  if (shouldLogValidation) {
    lastValidationHash = validationKey;
    validationLogCount++;
  }
  
  // 必須プロパティの検証
  const validationErrors = [];
  
  if (!status.userInfo) {
    validationErrors.push('ユーザー情報が見つかりません');
  } else {
    // ユーザー情報の詳細検証
    if (!status.userInfo.userId) {
      validationErrors.push('ユーザーIDが設定されていません');
    }
    if (!status.userInfo.adminEmail) {
      validationErrors.push('管理者メールアドレスが設定されていません');
    }
  }
  
  // 設定情報の検証
  if (!status.config) {
    validationErrors.push('設定情報が見つかりません');
    console.warn('⚠️ status.config が存在しません、空のオブジェクトで初期化します');
    status.config = {};
  }
  
  // appUrlsの検証
  if (!status.appUrls) {
    validationErrors.push('アプリケーションURLが設定されていません');
    console.warn('⚠️ status.appUrls が存在しません');
  }
  
  // シート情報の検証（警告レベル）
  if (!status.allSheets || !Array.isArray(status.allSheets)) {
    console.warn('⚠️ シート一覧が無効または存在しません:', status.allSheets);
    status.allSheets = []; // フォールバック
  }
  
  // シート詳細の検証（オプショナル）- 重複ログ防止
  if (status.sheetDetails) {
    if (!status.sheetDetails.allHeaders || !Array.isArray(status.sheetDetails.allHeaders)) {
      console.warn('⚠️ シートヘッダー情報が無効です:', status.sheetDetails.allHeaders);
      console.warn('これは「No headers found for フォームの回答」エラーの原因となる可能性があります');
    } else {
      // 重複ヘッダー検証ログを防止
      if (shouldLogValidation) {
        console.log('✅ シートヘッダー検証OK:', status.sheetDetails.allHeaders.length + '個のヘッダー');
      }
    }
    
    if (!status.sheetDetails.guessedConfig) {
      if (shouldLogValidation) {
        console.warn('⚠️ AI列判定結果が存在しません - 手動設定が必要です');
      }
    } else {
      // 本番環境では詳細ログを削減 + 重複防止
      if (shouldLogValidation) {
        if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
          console.log('✅ AI列判定結果が利用可能:', status.sheetDetails.guessedConfig);
        } else {
          console.log('✅ AI列判定結果が利用可能');
        }
      }
    }
  } else {
    if (shouldLogValidation) {
      console.log('ℹ️ シート詳細はオプショナルなので存在しません（正常）');
    }
  }
  
  // セットアップステップの検証
  if (typeof status.setupStep !== 'number') {
    console.warn('⚠️ セットアップステップが数値ではありません:', status.setupStep);
    status.setupStep = 1; // デフォルト値
  }
  
  // 検証エラーがある場合
  if (validationErrors.length > 0) {
    console.error('❌ レスポンス検証エラー:', validationErrors);
    showMessage('データ検証エラー: ' + validationErrors.join(', '), 'error');
    return false;
  }
  
  // 重複防止: 初回または重要な変更時のみ成功ログを出力
  if (shouldLogValidation) {
    console.log('✅ レスポンス検証成功');
  }
  return true;
}

// Update user activity timestamp for polling optimization
function updateUserActivity() {
  lastUserActivity = Date.now();
}

// =============================================================================
// INITIALIZATION HELPERS
// =============================================================================

// Message area initialization is now handled in adminPanel-framework.js.html

//# sourceURL=adminPanel-status.js.html
