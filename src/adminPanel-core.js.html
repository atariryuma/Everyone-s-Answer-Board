<script>
// =============================================================================
// ADMIN PANEL CORE UTILITIES & DOM OPERATIONS
// =============================================================================

// =============================================================================
// IMMEDIATE FUNCTION STUBS - Prevent undefined function errors
// =============================================================================

// Define critical function stubs immediately to prevent undefined errors


if (typeof window.navigateToStep === 'undefined') {
  window.navigateToStep = function(step) {
    console.warn('navigateToStep stub called - actual function not yet loaded');
  };
}

if (typeof window.showFormConfigModal === 'undefined') {
  window.showFormConfigModal = function() {
    console.warn('showFormConfigModal stub called - actual function not yet loaded');
  };
}

if (typeof window.hideFormConfigModal === 'undefined') {
  window.hideFormConfigModal = function() {
    console.warn('hideFormConfigModal stub called - actual function not yet loaded');
  };
}

if (typeof window.toggleSection === 'undefined') {
  window.toggleSection = function(sectionId) {
    console.warn('toggleSection stub called - actual function not yet loaded');
  };
}

console.log('‚úÖ Function stubs initialized to prevent undefined errors');

// =============================================================================
// UNIFIED ERROR HANDLING AND LOGGING SYSTEM - Enhanced Version
// =============================================================================

// Áµ±‰∏Ä„Ç®„É©„ÉºÂá¶ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÔºàÂº∑ÂåñÁâàÔºâ
const UnifiedErrorHandler = {
  // „Ç®„É©„ÉºÂàÜÈ°ûÂÆöÊï∞
  ErrorTypes: {
    CRITICAL: 'critical',      // „Ç∑„Çπ„ÉÜ„É†ÂÖ®‰Ωì„Å´ÂΩ±Èüø„Åô„ÇãÈáçÂ§ß„Ç®„É©„Éº
    HIGH: 'high',             // Ê©üËÉΩ„Å´ÈáçÂ§ß„Å™ÂΩ±Èüø„Åå„ÅÇ„Çã„Ç®„É©„Éº
    MEDIUM: 'medium',         // ÈÉ®ÂàÜÁöÑ„Å™Ê©üËÉΩÈöúÂÆ≥
    LOW: 'low',               // ËªΩÂæÆ„Å™„Ç®„É©„Éº„ÇÑË≠¶Âëä
    DEBUG: 'debug'            // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
  },
  
  ErrorCategories: {
    URL_GENERATION: 'url_generation',
    API_COMMUNICATION: 'api_communication',
    UI_UPDATE: 'ui_update',
    DATA_VALIDATION: 'data_validation',
    CACHE_OPERATION: 'cache_operation',
    USER_ACTION: 'user_action',
    SYSTEM_INITIALIZATION: 'system_initialization'
  },
  
  // „Ç®„É©„ÉºÁµ±Ë®à
  errorStats: {
    total: 0,
    byType: {},
    byCategory: {},
    recentErrors: [], // ÊúÄÊñ∞10‰ª∂„ÅÆ„Ç®„É©„Éº
    maxRecentErrors: 10
  },
  
  // Ë®≠ÂÆö
  debugMode: window.DEBUG_MODE || false,
  suppressedPatterns: [
    'document.write',
    'Failed to execute \'write\'',
    'mae_html_user_bin_i18n',
    'warden_bin_i18n',
    'unrecognized feature',
    'Tailwind CLI'
  ],
  
  /**
   * Áµ±‰∏Ä„Ç®„É©„Éº„É≠„Ç∞Ê©üËÉΩ
   * @param {Error|string} error - „Ç®„É©„Éº„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åæ„Åü„ÅØ„É°„ÉÉ„Çª„Éº„Ç∏
   * @param {string} type - „Ç®„É©„Éº„Çø„Ç§„Éó
   * @param {string} category - „Ç®„É©„Éº„Ç´„ÉÜ„Ç¥„É™
   * @param {Object} context - ËøΩÂä†„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÊÉÖÂ†±
   */
  logError(error, type = this.ErrorTypes.MEDIUM, category = this.ErrorCategories.SYSTEM_INITIALIZATION, context = {}) {
    const errorMessage = error?.message || error?.toString() || String(error);
    
    // ÊäëÂà∂„Éë„Çø„Éº„É≥„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
    if (this.shouldSuppressError(errorMessage)) {
      if (this.debugMode) {
        console.debug('üîá Suppressed error:', errorMessage);
      }
      return;
    }
    
    // „Ç®„É©„ÉºÊÉÖÂ†±„ÇíÊßãÁØâ
    const errorInfo = {
      timestamp: new Date().toISOString(),
      message: errorMessage,
      type: type,
      category: category,
      context: context,
      stack: error?.stack || null,
      userAgent: navigator.userAgent,
      url: window.location.href
    };
    
    // Áµ±Ë®à„ÇíÊõ¥Êñ∞
    this.updateErrorStats(errorInfo);
    
    // „Ç®„É©„Éº„É¨„Éô„É´„Å´Âøú„Åò„Åü„É≠„Ç∞Âá∫Âäõ
    this.outputError(errorInfo);
    
    // ÈáçË¶Å„Å™„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØËøΩÂä†Âá¶ÁêÜ
    if (type === this.ErrorTypes.CRITICAL || type === this.ErrorTypes.HIGH) {
      this.handleCriticalError(errorInfo);
    }
    
    return errorInfo;
  },
  
  /**
   * „Ç®„É©„ÉºÊäëÂà∂„ÉÅ„Çß„ÉÉ„ÇØ
   * @param {string} message - „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
   * @returns {boolean} ÊäëÂà∂„Åô„Åπ„Åç„Åã„Å©„ÅÜ„Åã
   */
  shouldSuppressError(message) {
    return this.suppressedPatterns.some(pattern => 
      message && message.includes(pattern)
    );
  },
  
  /**
   * „Ç®„É©„ÉºÁµ±Ë®à„ÅÆÊõ¥Êñ∞
   * @param {Object} errorInfo - „Ç®„É©„ÉºÊÉÖÂ†±
   */
  updateErrorStats(errorInfo) {
    this.errorStats.total++;
    
    // „Çø„Ç§„ÉóÂà•Áµ±Ë®à
    if (!this.errorStats.byType[errorInfo.type]) {
      this.errorStats.byType[errorInfo.type] = 0;
    }
    this.errorStats.byType[errorInfo.type]++;
    
    // „Ç´„ÉÜ„Ç¥„É™Âà•Áµ±Ë®à
    if (!this.errorStats.byCategory[errorInfo.category]) {
      this.errorStats.byCategory[errorInfo.category] = 0;
    }
    this.errorStats.byCategory[errorInfo.category]++;
    
    // ÊúÄËøë„ÅÆ„Ç®„É©„Éº„ÇíË®òÈå≤
    this.errorStats.recentErrors.push({
      timestamp: errorInfo.timestamp,
      message: errorInfo.message.substring(0, 100), // ÊúÄÂàù„ÅÆ100ÊñáÂ≠ó
      type: errorInfo.type,
      category: errorInfo.category
    });
    
    // ÊúÄÂ§ßÊï∞„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÅØÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§
    if (this.errorStats.recentErrors.length > this.maxRecentErrors) {
      this.errorStats.recentErrors.shift();
    }
  },
  
  /**
   * „Ç®„É©„Éº„ÅÆ„É≠„Ç∞Âá∫Âäõ
   * @param {Object} errorInfo - „Ç®„É©„ÉºÊÉÖÂ†±
   */
  outputError(errorInfo) {
    const prefix = `[AdminPanel:${errorInfo.type.toUpperCase()}:${errorInfo.category}]`;
    const logMessage = `${errorInfo.message}`;
    
    switch (errorInfo.type) {
      case this.ErrorTypes.CRITICAL:
        console.error(`üö® ${prefix}`, logMessage, errorInfo.context);
        break;
      case this.ErrorTypes.HIGH:
        console.error(`‚ùå ${prefix}`, logMessage, errorInfo.context);
        break;
      case this.ErrorTypes.MEDIUM:
        console.warn(`‚ö†Ô∏è ${prefix}`, logMessage, errorInfo.context);
        break;
      case this.ErrorTypes.LOW:
        console.warn(`‚ÑπÔ∏è ${prefix}`, logMessage);
        break;
      case this.ErrorTypes.DEBUG:
        if (this.debugMode) {
          console.log(`üîç ${prefix}`, logMessage, errorInfo.context);
        }
        break;
      default:
        console.log(`üìù ${prefix}`, logMessage);
    }
  },
  
  /**
   * ÈáçË¶Å„Å™„Ç®„É©„Éº„ÅÆËøΩÂä†Âá¶ÁêÜ
   * @param {Object} errorInfo - „Ç®„É©„ÉºÊÉÖÂ†±
   */
  handleCriticalError(errorInfo) {
    // ÈáçË¶Å„Å™„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØË©≥Á¥∞„Å™ÊÉÖÂ†±„Çí„É≠„Ç∞Âá∫Âäõ
    console.group(`üö® ÈáçË¶Å„Å™„Ç®„É©„Éº„ÅÆË©≥Á¥∞: ${errorInfo.category}`);
    console.log('„Çø„Ç§„É†„Çπ„Çø„É≥„Éó:', errorInfo.timestamp);
    console.log('„É°„ÉÉ„Çª„Éº„Ç∏:', errorInfo.message);
    console.log('„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà:', errorInfo.context);
    if (errorInfo.stack) {
      console.log('„Çπ„Çø„ÉÉ„ÇØ„Éà„É¨„Éº„Çπ:', errorInfo.stack);
    }
    console.log('Áµ±Ë®àÊÉÖÂ†±:', this.getErrorStats());
    console.groupEnd();
    
    // TODO: Â∞ÜÊù•ÁöÑ„Å´„ÅØ„Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„Å∏„ÅÆÈáçË¶Å„Ç®„É©„ÉºÂ†±ÂëäÊ©üËÉΩ„ÇíËøΩÂä†
  },
  
  /**
   * „Ç®„É©„ÉºÁµ±Ë®à„ÅÆÂèñÂæó
   * @returns {Object} „Ç®„É©„ÉºÁµ±Ë®àÊÉÖÂ†±
   */
  getErrorStats() {
    return {
      ...this.errorStats,
      categories: Object.keys(this.ErrorCategories),
      types: Object.keys(this.ErrorTypes)
    };
  }
};

// „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
window.UnifiedErrorHandler = UnifiedErrorHandler;

// ÂæìÊù•„ÅÆ„É≠„Ç∞Èñ¢Êï∞„ÇíÁµ±‰∏Ä„Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº„Å´Áµ±Âêà
const DEBUG_MODE = UnifiedErrorHandler.debugMode;

function adminLog(level, ...args) {
  const message = args.join(' ');
  const context = { originalArgs: args };
  
  switch (level) {
    case 'error':
      UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.HIGH, UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context);
      break;
    case 'warn':
      UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.MEDIUM, UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context);
      break;
    case 'info':
      if (DEBUG_MODE) console.log('[AdminPanel:INFO]', ...args);
      break;
    case 'debug':
      UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.DEBUG, UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context);
      break;
    default:
      if (DEBUG_MODE) console.log('[AdminPanel]', ...args);
  }
}

// ‰æøÂà©„Å™Èñ¢Êï∞Áæ§ÔºàÁµ±‰∏Ä„Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº„Çí‰ΩøÁî®Ôºâ
function logError(message, category = UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context = {}) {
  return UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.HIGH, category, context);
}

function logWarn(message, category = UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context = {}) {
  return UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.MEDIUM, category, context);
}

function logInfo(...args) { 
  if (DEBUG_MODE) console.log('[AdminPanel:INFO]', ...args);
}

function logDebug(message, context = {}) {
  return UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.DEBUG, UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context);
}

// =============================================================================
// SHARED UTILITIES AND CODE QUALITY IMPROVEMENTS
// =============================================================================

/**
 * Áµ±‰∏Ä„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„ÇØ„É©„ÇπÔºà„Ç≥„Éº„ÉâÂìÅË≥™Âêë‰∏ä„Å®„É°„É≥„ÉÜ„Éä„É≥„ÇπÊÄßÊîπÂñÑÔºâ
 */
const AdminPanelUtilities = {
  // =============================================================================
  // HTML ESCAPING AND SANITIZATION
  // =============================================================================
  
  /**
   * ÂÆâÂÖ®„Å™HTML„Ç®„Çπ„Ç±„Éº„ÉóÊ©üËÉΩÔºàXSSÂØæÁ≠ñÔºâ
   * @param {*} text - „Ç®„Çπ„Ç±„Éº„Éó„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà
   * @returns {string} „Ç®„Çπ„Ç±„Éº„Éó„Åï„Çå„ÅüHTML
   */
  escapeHtml(text) {
    if (text == null) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
  },
  
  /**
   * „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂÆâÂÖ®„Å™Ê§úË®º
   * @param {*} obj - Ê§úË®º„Åô„Çã„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
   * @returns {boolean} ÊúâÂäπ„Å™„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„Å©„ÅÜ„Åã
   */
  isValidObject(obj) {
    return obj && typeof obj === 'object' && !Array.isArray(obj) && obj.constructor === Object;
  },
  
  /**
   * ÈÖçÂàó„ÅÆÂÆâÂÖ®„Å™Ê§úË®º
   * @param {*} arr - Ê§úË®º„Åô„ÇãÈÖçÂàó
   * @returns {boolean} ÊúâÂäπ„Å™ÈÖçÂàó„Åã„Å©„ÅÜ„Åã
   */
  isValidArray(arr) {
    return Array.isArray(arr);
  },
  
  /**
   * ÊñáÂ≠óÂàó„ÅÆÂÆâÂÖ®„Å™Ê§úË®º
   * @param {*} str - Ê§úË®º„Åô„ÇãÊñáÂ≠óÂàó
   * @param {number} minLength - ÊúÄÂ∞èÊñáÂ≠óÊï∞Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
   * @returns {boolean} ÊúâÂäπ„Å™ÊñáÂ≠óÂàó„Åã„Å©„ÅÜ„Åã
   */
  isValidString(str, minLength = 0) {
    return typeof str === 'string' && str.length >= minLength;
  },
  
  // =============================================================================
  // PERFORMANCE MONITORING
  // =============================================================================
  
  /**
   * „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†
   */
  PerformanceMonitor: {
    operations: new Map(),
    thresholds: {
      warning: 100,  // 100ms‰ª•‰∏ä„ÅßË≠¶Âëä
      critical: 500  // 500ms‰ª•‰∏ä„ÅßÈáçË¶ÅË≠¶Âëä
    },
    
    /**
     * Êìç‰Ωú„ÅÆÈñãÂßã„ÇíË®òÈå≤
     * @param {string} operationId - Êìç‰ΩúID
     * @param {string} description - Êìç‰Ωú„ÅÆË™¨Êòé
     */
    start(operationId, description = '') {
      this.operations.set(operationId, {
        startTime: performance.now(),
        description: description,
        endTime: null,
        duration: null
      });
    },
    
    /**
     * Êìç‰Ωú„ÅÆÁµÇ‰∫Ü„ÇíË®òÈå≤
     * @param {string} operationId - Êìç‰ΩúID
     * @returns {number} ÂÆüË°åÊôÇÈñìÔºà„Éü„É™ÁßíÔºâ
     */
    end(operationId) {
      const operation = this.operations.get(operationId);
      if (!operation) {
        console.warn(`‚ö†Ô∏è Unknown operation ID: ${operationId}`);
        return 0;
      }
      
      operation.endTime = performance.now();
      operation.duration = operation.endTime - operation.startTime;
      
      // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπË≠¶Âëä„ÅÆÂá∫Âäõ
      if (operation.duration > this.thresholds.critical) {
        console.error(`üö® Critical performance issue: ${operationId} took ${operation.duration.toFixed(1)}ms`);
      } else if (operation.duration > this.thresholds.warning) {
        console.warn(`‚ö†Ô∏è Performance warning: ${operationId} took ${operation.duration.toFixed(1)}ms`);
      }
      
      return operation.duration;
    },
    
    /**
     * Áµ±Ë®àÊÉÖÂ†±„ÅÆÂèñÂæó
     * @returns {Object} „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÁµ±Ë®à
     */
    getStats() {
      const completedOps = Array.from(this.operations.values()).filter(op => op.duration !== null);
      if (completedOps.length === 0) {
        return { totalOperations: 0, averageDuration: 0, slowOperations: 0 };
      }
      
      const totalDuration = completedOps.reduce((sum, op) => sum + op.duration, 0);
      const slowOps = completedOps.filter(op => op.duration > this.thresholds.warning).length;
      
      return {
        totalOperations: completedOps.length,
        averageDuration: totalDuration / completedOps.length,
        slowOperations: slowOps,
        slowOperationPercentage: (slowOps / completedOps.length) * 100
      };
    }
  },
  
  // =============================================================================
  // DEBUGGING AND DIAGNOSTICS
  // =============================================================================
  
  /**
   * „Éá„Éê„ÉÉ„Ç∞„ÉªË®∫Êñ≠„Ç∑„Çπ„ÉÜ„É†
   */
  Diagnostics: {
    /**
     * „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÅÆÂåÖÊã¨ÁöÑË®∫Êñ≠
     * @returns {Object} Ë®∫Êñ≠ÁµêÊûú
     */
    runSystemDiagnostics() {
      const diagnostics = {
        timestamp: new Date().toISOString(),
        browser: this.getBrowserInfo(),
        performance: AdminPanelUtilities.PerformanceMonitor.getStats(),
        errors: window.UnifiedErrorHandler ? window.UnifiedErrorHandler.getErrorStats() : null,
        loadingState: window.UnifiedLoadingManager ? window.UnifiedLoadingManager.getStats() : null,
        uiState: window.uiUpdateBatching ? {
          updateCount: window.uiUpdateBatching.updateCount,
          skippedUpdates: window.uiUpdateBatching.skippedUpdates,
          cacheSize: window.uiUpdateBatching.domCache.size
        } : null,
        memoryUsage: this.getMemoryUsage()
      };
      
      console.group('üîç „Ç∑„Çπ„ÉÜ„É†Ë®∫Êñ≠ÁµêÊûú');
      console.log('Ë®∫Êñ≠ÊôÇÂàª:', diagnostics.timestamp);
      console.log('„Éñ„É©„Ç¶„Ç∂ÊÉÖÂ†±:', diagnostics.browser);
      console.log('„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ:', diagnostics.performance);
      console.log('„Ç®„É©„ÉºÁµ±Ë®à:', diagnostics.errors);
      console.log('„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã:', diagnostics.loadingState);
      console.log('UIÊõ¥Êñ∞Áµ±Ë®à:', diagnostics.uiState);
      console.log('„É°„É¢„É™‰ΩøÁî®Èáè:', diagnostics.memoryUsage);
      console.groupEnd();
      
      return diagnostics;
    },
    
    /**
     * „Éñ„É©„Ç¶„Ç∂ÊÉÖÂ†±„ÅÆÂèñÂæó
     * @returns {Object} „Éñ„É©„Ç¶„Ç∂ÊÉÖÂ†±
     */
    getBrowserInfo() {
      return {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        cookieEnabled: navigator.cookieEnabled,
        onLine: navigator.onLine,
        screenResolution: `${screen.width}x${screen.height}`,
        viewportSize: `${window.innerWidth}x${window.innerHeight}`
      };
    },
    
    /**
     * „É°„É¢„É™‰ΩøÁî®Èáè„ÅÆÂèñÂæóÔºàÂà©Áî®ÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
     * @returns {Object|null} „É°„É¢„É™‰ΩøÁî®ÈáèÊÉÖÂ†±
     */
    getMemoryUsage() {
      if (performance.memory) {
        return {
          usedJSHeapSize: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + ' MB',
          totalJSHeapSize: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024) + ' MB',
          jsHeapSizeLimit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024) + ' MB'
        };
      }
      return null;
    }
  }
};

// „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
window.AdminPanelUtilities = AdminPanelUtilities;

// ÂæìÊù•„ÅÆÈñ¢Êï∞ÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
function escapeHtml(text) {
  return AdminPanelUtilities.escapeHtml(text);
}

function isValidObject(obj) {
  return AdminPanelUtilities.isValidObject(obj);
}

function isValidArray(arr) {
  return AdminPanelUtilities.isValidArray(arr);
}

// =============================================================================
// ENHANCED MESSAGE SYSTEM FOR SETUP FLOW
// =============================================================================

// Âº∑Âåñ„Åï„Çå„Åü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Ç∑„Çπ„ÉÜ„É†
function showMessage(message, type = 'info', duration = 5000, options = {}) {
  // Êó¢Â≠ò„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Ç∑„Çπ„ÉÜ„É†„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  if (window.sharedUtilities && window.sharedUtilities.showMessage) {
    return window.sharedUtilities.showMessage(message, type, duration, options);
  }
  
  // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Ç§„É≥„É©„Ç§„É≥ÂÆüË£Ö
  return showInlineMessage(message, type, duration, options);
}

// „Ç§„É≥„É©„Ç§„É≥„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂÆüË£ÖÔºâ
function showInlineMessage(message, type = 'info', duration = 5000, options = {}) {
  // „É°„ÉÉ„Çª„Éº„Ç∏„Ç≥„É≥„ÉÜ„Éä„ÇíÂèñÂæó„Åæ„Åü„ÅØ‰ΩúÊàê
  let container = document.getElementById('message-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'message-container';
    container.className = 'fixed top-4 right-4 z-[10000] space-y-2';
    document.body.appendChild(container);
  }
  
  // „É°„ÉÉ„Çª„Éº„Ç∏Ë¶ÅÁ¥†„Çí‰ΩúÊàê
  const messageEl = createMessageElement(message, type, options);
  container.appendChild(messageEl);
  
  // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë°®Á§∫
  requestAnimationFrame(() => {
    messageEl.classList.remove('translate-x-full', 'opacity-0');
    messageEl.classList.add('translate-x-0', 'opacity-100');
  });
  
  // Ëá™ÂãïÂâäÈô§
  if (duration > 0) {
    setTimeout(() => {
      removeMessage(messageEl);
    }, duration);
  }
  
  return messageEl;
}

// „É°„ÉÉ„Çª„Éº„Ç∏Ë¶ÅÁ¥†„ÅÆ‰ΩúÊàê
function createMessageElement(message, type, options) {
  const colors = {
    success: 'bg-green-600/20 border-green-500/50 text-green-100',
    error: 'bg-red-600/20 border-red-500/50 text-red-100',
    warning: 'bg-yellow-600/20 border-yellow-500/50 text-yellow-100',
    info: 'bg-blue-600/20 border-blue-500/50 text-blue-100'
  };
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå', 
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  const messageEl = document.createElement('div');
  messageEl.className = `message glass-panel rounded-lg p-4 border shadow-lg flex items-center transition-all duration-300 ease-out transform translate-x-full opacity-0 ${colors[type]}`;
  
  messageEl.innerHTML = `
    <div class="mr-3 text-xl">${icons[type]}</div>
    <div class="flex-1 text-sm">${escapeHtml(message)}</div>
    <button class="ml-4 text-gray-400 hover:text-white text-xl leading-none" onclick="this.closest('.message').remove()">‚úï</button>
  `;
  
  return messageEl;
}

// „É°„ÉÉ„Çª„Éº„Ç∏ÂâäÈô§„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
function removeMessage(messageEl) {
  messageEl.classList.remove('translate-x-0', 'opacity-100');
  messageEl.classList.add('translate-x-full', 'opacity-0');
  messageEl.addEventListener('transitionend', () => messageEl.remove());
}

// HTML „Ç®„Çπ„Ç±„Éº„ÉóÈñ¢Êï∞
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Çπ„ÉÜ„ÉÉ„ÉóÁî®„ÅÆÁâπÂà•„Å™„É°„ÉÉ„Çª„Éº„Ç∏
function showSetupMessage(message, step, type = 'info') {
  const stepIcon = step ? `üî• Step ${step}:` : 'üìã';
  return showMessage(`${stepIcon} ${message}`, type, 6000, { step });
}

// „Ç®„É©„ÉºÁî®„ÅÆË©≥Á¥∞„É°„ÉÉ„Çª„Éº„Ç∏
function showDetailedError(title, details, suggestions = []) {
  let message = `${title}`;
  if (details) {
    message += `\nË©≥Á¥∞: ${details}`;
  }
  if (suggestions.length > 0) {
    message += `\nÂØæÂá¶Ê≥ï: ${suggestions.join(', ')}`;
  }
  return showMessage(message, 'error', 8000, { detailed: true });
}

// Use SharedUtilities instead of local debounce
var debounce = window.debounce || function(func, delay, key) {
  window.sharedUtilities.debounce.debounce(func, key || 'default', delay);
};

// =============================================================================
// DOM UTILITY FUNCTIONS - Use SharedUtilities
// =============================================================================

// Backward compatibility functions using SharedUtilities
var dom = window.sharedUtilities.dom;
var createSafeElement = dom.createSafeElement.bind(dom);
var getCachedElement = dom.getCachedElement.bind(dom);
var safeGetElement = getCachedElement;
var setButtonState = dom.setButtonState.bind(dom);
var setSafeTextContent = dom.setSafeTextContent.bind(dom);
var toggleClass = dom.toggleClass.bind(dom);
var addSafeEventListener = dom.addSafeEventListener.bind(dom);
var removeSafeEventListener = dom.removeSafeEventListener.bind(dom);
var clearElementCache = dom.clearElementCache.bind(dom);
var cacheElements = dom.cacheElements.bind(dom);

// =============================================================================
// EVENT HANDLER UTILITIES - Consolidated patterns
// =============================================================================

// Utility for setting up multiple event listeners efficiently
function setupMultipleListeners(elementHandlerMap) {
  Object.keys(elementHandlerMap).forEach(function(elementId) {
    var element = elementId.startsWith('#') ? 
      document.querySelector(elementId) : 
      (elements[elementId] || getCachedElement(elementId));
    
    if (element) {
      var handlers = elementHandlerMap[elementId];
      if (Array.isArray(handlers)) {
        handlers.forEach(function(handler) {
          addSafeEventListener(element, handler.event, handler.callback, handler.options);
        });
      } else {
        addSafeEventListener(element, handlers.event, handlers.callback, handlers.options);
      }
    }
  });
}

// Utility for setting up click handlers with confirmation
function setupConfirmationHandler(elementId, confirmTitle, confirmMessage, callback) {
  var element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', function(e) {
      e.preventDefault();
      showConfirmationModal(
        confirmTitle,
        confirmMessage,
        callback
      );
    });
  }
}

// Utility for setting up handlers with privacy consent
function setupPrivacyHandler(elementId, callback) {
  var element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', function(e) {
      e.preventDefault();
      showPrivacyModal(function() {
        hidePrivacyModal();
        callback();
      });
    });
  }
}

// Utility for delegated event handling (useful for dynamic content)
function setupDelegatedHandler(parentElement, selector, event, callback) {
  if (typeof parentElement === 'string') {
    parentElement = getCachedElement(parentElement);
  }
  
  if (parentElement) {
    addSafeEventListener(parentElement, event, function(e) {
      var target = e.target.closest(selector);
      if (target) {
        callback.call(target, e);
      }
    });
  }
}

// =============================================================================
// PROCESSING CACHE SYSTEM - Prevent Duplicate Executions
// =============================================================================

// üéØ Processing cache system to prevent duplicate processing
const processingCache = {
  sheetHeaderValidation: new Map(),
  aiColumnDetection: new Map(),
  configNormalization: new Map(),
  urlGeneration: new Map(),
  statusValidation: new Map()
};

// Cache cleanup intervals (in milliseconds)
const CACHE_TTL = {
  sheetHeaderValidation: 60000,    // 1 minute
  aiColumnDetection: 120000,       // 2 minutes  
  configNormalization: 300000,     // 5 minutes
  urlGeneration: 600000,           // 10 minutes
  statusValidation: 60000          // 1 minute
};

/**
 * Execute function with caching to prevent duplicate processing
 * @param {string} cacheType - Type of cache (sheetHeaderValidation, aiColumnDetection, etc.)
 * @param {string} key - Cache key
 * @param {Function} fn - Function to execute
 * @param {number} ttl - Time to live in milliseconds (optional, defaults to cacheType TTL)
 * @returns {*} Cached or fresh result
 */
function executeWithCache(cacheType, key, fn, ttl) {
  const cache = processingCache[cacheType];
  if (!cache) {
    console.warn(`‚ö†Ô∏è Unknown cache type: ${cacheType}`);
    return fn(); // Execute without caching
  }
  
  const now = Date.now();
  const cacheEntry = cache.get(key);
  
  // Check if cached result is still valid
  if (cacheEntry && (now - cacheEntry.timestamp) < (ttl || CACHE_TTL[cacheType])) {
    console.log(`‚úÖ Cache hit for ${cacheType}:${key}`);
    return cacheEntry.result;
  }
  
  // Execute function and cache result
  console.log(`üîÑ Cache miss for ${cacheType}:${key}, executing...`);
  try {
    const result = fn();
    cache.set(key, {
      result: result,
      timestamp: now
    });
    return result;
  } catch (error) {
    console.error(`‚ùå Error executing cached function ${cacheType}:${key}:`, error);
    throw error;
  }
}

/**
 * Clear specific cache or all caches
 * @param {string} cacheType - Type of cache to clear (optional, clears all if not specified)
 * @param {string} key - Specific key to clear (optional, clears all keys if not specified)
 */
function clearProcessingCache(cacheType, key) {
  if (cacheType && key) {
    // Clear specific cache entry
    if (processingCache[cacheType]) {
      processingCache[cacheType].delete(key);
      console.log(`üßπ Cleared cache entry: ${cacheType}:${key}`);
    }
  } else if (cacheType) {
    // Clear entire cache type
    if (processingCache[cacheType]) {
      processingCache[cacheType].clear();
      console.log(`üßπ Cleared cache type: ${cacheType}`);
    }
  } else {
    // Clear all caches
    Object.values(processingCache).forEach(cache => cache.clear());
    console.log('üßπ Cleared all processing caches');
  }
}

/**
 * Cache cleanup job - removes expired entries
 */
function cleanupProcessingCache() {
  const now = Date.now();
  
  Object.entries(processingCache).forEach(([cacheType, cache]) => {
    const ttl = CACHE_TTL[cacheType];
    let cleanedCount = 0;
    
    for (const [key, entry] of cache.entries()) {
      if (now - entry.timestamp > ttl) {
        cache.delete(key);
        cleanedCount++;
      }
    }
    
    if (cleanedCount > 0) {
      console.log(`üßπ Cleaned ${cleanedCount} expired entries from ${cacheType} cache`);
    }
  });
}

// Schedule cache cleanup every 5 minutes
setInterval(cleanupProcessingCache, 300000);

// =============================================================================
// GLOBAL LOADING OVERLAY MANAGEMENT SYSTEM
// =============================================================================

/**
 * Áµ±‰∏Ä„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖãÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÔºàÁ´∂ÂêàÁä∂ÊÖãËß£Ê±∫Ê©üËÉΩ‰ªò„ÅçÔºâ
 * Êó¢Â≠ò„ÅÆUnifiedLoadingManager„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØÊã°ÂºµÊ©üËÉΩ„ÅÆ„ÅøËøΩÂä†
 */
const AdminPanelLoadingManager = {
  // Áä∂ÊÖãÁÆ°ÁêÜ
  isActive: false,
  activeOperations: new Map(), // „Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥ID„Å®Ë©≥Á¥∞ÊÉÖÂ†±„ÅÆ„Éû„ÉÉ„Éó
  overlayElement: null,
  progressElement: null,
  messageElement: null,
  currentMessage: '',
  startTime: null,
  progressUpdateTimer: null,
  
  // Á´∂ÂêàÁä∂ÊÖãËß£Ê±∫„ÅÆ„Åü„ÇÅ„ÅÆË®≠ÂÆö
  operationPriority: {
    critical: 1000,
    high: 500,
    medium: 100,
    low: 10
  },
  
  // Áµ±Ë®à„Å®„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÁõ£Ë¶ñ
  stats: {
    totalOperations: 0,
    concurrentOperations: 0,
    maxConcurrentOperations: 0,
    averageDisplayTime: 0,
    lastOperationTimes: [] // ÊúÄÊñ∞10‰ª∂„ÅÆË°®Á§∫ÊôÇÈñì
  },
  
  // „É°„É¢„É™„É™„Éº„ÇØÈò≤Ê≠¢
  maxOperationHistory: 10,
  cleanupInterval: 30000, // 30Áßí
  lastCleanupTime: Date.now(),
  
  /**
   * „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫„ÅÆÈñãÂßãÔºàÁ´∂ÂêàÁä∂ÊÖãÂØæÂøúÔºâ
   * @param {string} operationId - „Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥ID
   * @param {string} message - Ë°®Á§∫„É°„ÉÉ„Çª„Éº„Ç∏
   * @param {Object} options - „Ç™„Éó„Ç∑„Éß„É≥
   */
  show(operationId, message = 'Âá¶ÁêÜ‰∏≠...', options = {}) {
    const priority = options.priority || 'medium';
    const startTime = Date.now();
    
    console.log(`üîÑ Áµ±‰∏Ä„É≠„Éº„Éá„Ç£„É≥„Ç∞ÈñãÂßã: ${operationId} (ÂÑ™ÂÖàÂ∫¶: ${priority})`);
    
    // „Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíË®òÈå≤
    const operationInfo = {
      id: operationId,
      message: message,
      priority: this.operationPriority[priority] || this.operationPriority.medium,
      startTime: startTime,
      options: options
    };
    
    this.activeOperations.set(operationId, operationInfo);
    
    // Áµ±Ë®àÊõ¥Êñ∞
    this.stats.totalOperations++;
    this.stats.concurrentOperations = this.activeOperations.size;
    if (this.stats.concurrentOperations > this.stats.maxConcurrentOperations) {
      this.stats.maxConcurrentOperations = this.stats.concurrentOperations;
    }
    
    // ÊúÄÂÑ™ÂÖà„ÅÆ„Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥„ÇíÊ±∫ÂÆö
    const highestPriorityOperation = this.getHighestPriorityOperation();
    
    // Ë°®Á§∫„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊõ¥Êñ∞ÔºàÊúÄÂÑ™ÂÖà„Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
    if (highestPriorityOperation && highestPriorityOperation.id === operationId) {
      this.updateDisplayedMessage(message);
    }
    
    // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíË°®Á§∫
    this.showOverlay();
    
    // ÈÄ≤ÊçóËøΩË∑°ÈñãÂßã
    if (options.showProgress !== false) {
      this.startProgressTracking();
    }
    
    this.isActive = true;
  },
  
  /**
   * „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫„ÅÆÁµÇ‰∫Ü
   * @param {string} operationId - „Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥ID
   * @param {string} finalMessage - ÊúÄÁµÇ„É°„ÉÉ„Çª„Éº„Ç∏
   */
  hide(operationId, finalMessage = null) {
    if (!this.activeOperations.has(operationId)) {
      console.warn(`‚ö†Ô∏è Unknown operation ID for hide: ${operationId}`);
      return;
    }
    
    const operation = this.activeOperations.get(operationId);
    const displayTime = Date.now() - operation.startTime;
    
    console.log(`‚úÖ Áµ±‰∏Ä„É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫Ü: ${operationId} (${displayTime}ms)`);
    
    // Áµ±Ë®àÊõ¥Êñ∞
    this.updateDisplayTimeStats(displayTime);
    
    // „Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥„ÇíÂâäÈô§
    this.activeOperations.delete(operationId);
    this.stats.concurrentOperations = this.activeOperations.size;
    
    // ‰ªñ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà
    if (this.activeOperations.size > 0) {
      const nextOperation = this.getHighestPriorityOperation();
      if (nextOperation) {
        this.updateDisplayedMessage(nextOperation.message);
        console.log(`üîÑ „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫Á∂ôÁ∂ö: ${nextOperation.id} (ÊÆã„Çä${this.activeOperations.size}‰ª∂)`);
      }
    } else {
      // ÂÖ®„Å¶„ÅÆ„Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥„ÅåÂÆå‰∫Ü
      if (finalMessage) {
        this.updateDisplayedMessage(finalMessage);
        setTimeout(() => this.hideOverlay(), 800);
      } else {
        this.hideOverlay();
      }
    }
  },
  
  /**
   * ÊúÄÂÑ™ÂÖà„ÅÆ„Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥„ÇíÂèñÂæó
   * @returns {Object|null} ÊúÄÂÑ™ÂÖà„ÅÆ„Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±
   */
  getHighestPriorityOperation() {
    let highest = null;
    for (const operation of this.activeOperations.values()) {
      if (!highest || operation.priority > highest.priority) {
        highest = operation;
      }
    }
    return highest;
  },
  
  /**
   * Ë°®Á§∫ÊôÇÈñìÁµ±Ë®à„ÅÆÊõ¥Êñ∞
   * @param {number} displayTime - Ë°®Á§∫ÊôÇÈñìÔºà„Éü„É™ÁßíÔºâ
   */
  updateDisplayTimeStats(displayTime) {
    this.stats.lastOperationTimes.push(displayTime);
    if (this.stats.lastOperationTimes.length > this.maxOperationHistory) {
      this.stats.lastOperationTimes.shift();
    }
    
    // Âπ≥ÂùáË°®Á§∫ÊôÇÈñì„ÇíË®àÁÆó
    this.stats.averageDisplayTime = this.stats.lastOperationTimes.reduce((a, b) => a + b, 0) / this.stats.lastOperationTimes.length;
  },
  
  /**
   * „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„ÅÆÊõ¥Êñ∞
   * @param {string} message - Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏
   */
  updateDisplayedMessage(message) {
    this.currentMessage = message;
    if (this.messageElement) {
      this.messageElement.textContent = message;
    }
    console.log(`üí¨ Loading message updated: ${message}`);
  },
  
  /**
   * „Ç™„Éº„Éê„Éº„É¨„Ç§„ÅÆË°®Á§∫
   */
  showOverlay() {
    // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰ΩúÊàê
    if (!this.overlayElement) {
      this.createOverlay();
    }
    
    if (this.overlayElement && this.overlayElement.style.display !== 'flex') {
      this.overlayElement.style.display = 'flex';
      this.startTime = Date.now();
    }
  },
  
  /**
   * „Ç™„Éº„Éê„Éº„É¨„Ç§„ÅÆÈùûË°®Á§∫
   */
  hideOverlay() {
    if (this.overlayElement) {
      this.overlayElement.style.display = 'none';
      this.isActive = false;
      
      // ÈÄ≤ÊçóËøΩË∑°ÂÅúÊ≠¢
      if (this.progressUpdateTimer) {
        clearInterval(this.progressUpdateTimer);
        this.progressUpdateTimer = null;
      }
      
      console.log('üéØ Áµ±‰∏Ä„É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ÈùûË°®Á§∫');
    }
  },
  
  /**
   * Áµ±Ë®àÊÉÖÂ†±„ÅÆÂèñÂæó
   * @returns {Object} Áµ±Ë®àÊÉÖÂ†±
   */
  getStats() {
    return {
      ...this.stats,
      activeOperations: Array.from(this.activeOperations.keys()),
      isActive: this.isActive,
      currentMessage: this.currentMessage
    };
  },
  
  /**
   * „É°„É¢„É™„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
   */
  performCleanup() {
    const now = Date.now();
    if (now - this.lastCleanupTime > this.cleanupInterval) {
      // Ë°®Á§∫ÊôÇÈñìÂ±•Ê≠¥„ÅÆÂà∂Èôê
      if (this.stats.lastOperationTimes.length > this.maxOperationHistory) {
        this.stats.lastOperationTimes = this.stats.lastOperationTimes.slice(-this.maxOperationHistory);
      }
      
      this.lastCleanupTime = now;
      console.log('üßπ Áµ±‰∏Ä„É≠„Éº„Éá„Ç£„É≥„Ç∞: „É°„É¢„É™„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü');
    }
  },
  
  /**
   * „Ç™„Éº„Éê„Éº„É¨„Ç§DOMË¶ÅÁ¥†„ÅÆ‰ΩúÊàê
   */
  createOverlay() {
    if (this.overlayElement) {
      return; // Êó¢„Å´‰ΩúÊàêÊ∏à„Åø
    }
    
    // „É°„Ç§„É≥ „Ç™„Éº„Éê„Éº„É¨„Ç§Ë¶ÅÁ¥†„Çí‰ΩúÊàê
    const overlay = document.createElement('div');
    overlay.id = 'unified-loading-overlay';
    overlay.className = 'fixed inset-0 z-[9999] flex items-center justify-center';
    overlay.style.cssText = `
      display: none;
      background: rgba(26, 27, 38, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    `;
    
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç≥„É≥„ÉÜ„Éä„Çí‰ΩúÊàê
    const content = document.createElement('div');
    content.className = 'bg-white bg-opacity-95 backdrop-blur-sm rounded-2xl shadow-2xl p-8 max-w-md mx-4 text-center border border-gray-200';
    
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
    const spinner = document.createElement('div');
    spinner.className = 'inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4';
    
    // „É°„ÉÉ„Çª„Éº„Ç∏Ë¶ÅÁ¥†
    const message = document.createElement('div');
    message.className = 'text-gray-800 font-medium text-lg mb-2';
    message.textContent = this.currentMessage || 'Âá¶ÁêÜ‰∏≠...';
    
    // ÈÄ≤ÊçóË¶ÅÁ¥†Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
    const progress = document.createElement('div');
    progress.className = 'text-gray-600 text-sm';
    progress.textContent = '';
    
    // Ë¶ÅÁ¥†„ÇíÁµÑ„ÅøÁ´ã„Å¶
    content.appendChild(spinner);
    content.appendChild(message);
    content.appendChild(progress);
    overlay.appendChild(content);
    
    // DOM„Å´ËøΩÂä†
    document.body.appendChild(overlay);
    
    // ÂèÇÁÖß„Çí‰øùÂ≠ò
    this.overlayElement = overlay;
    this.messageElement = message;
    this.progressElement = progress;
    
    console.log('üé® Áµ±‰∏Ä„É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§‰ΩúÊàêÂÆå‰∫Ü');
  },
  
  /**
   * ÈÄ≤ÊçóËøΩË∑°„ÅÆÈñãÂßã
   */
  startProgressTracking() {
    if (this.progressUpdateTimer) {
      clearInterval(this.progressUpdateTimer);
    }
    
    this.progressUpdateTimer = setInterval(() => {
      this.performCleanup(); // ÂÆöÊúüÁöÑ„Å™„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„ÇÇÂÆüË°å
      
      if (this.progressElement && this.activeOperations.size > 0) {
        const elapsed = Date.now() - this.startTime;
        const seconds = Math.floor(elapsed / 1000);
        
        if (this.activeOperations.size > 1) {
          this.progressElement.textContent = `${this.activeOperations.size}‰ª∂„ÅÆÂá¶ÁêÜ„ÇíÂÆüË°å‰∏≠... (${seconds}Áßí)`;
        } else {
          this.progressElement.textContent = `Âá¶ÁêÜÊôÇÈñì: ${seconds}Áßí`;
        }
      }
    }, 1000);
  }
};

// „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨ÈñãÔºàÊó¢Â≠ò„ÅÆUnifiedLoadingManager„Å®„ÅÆÁ´∂Âêà„ÇíÂÆåÂÖ®ÂõûÈÅøÔºâ
if (typeof window.UnifiedLoadingManager === 'undefined') {
  // UnifiedLoadingManager„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅAdminPanelLoadingManager„Çí„Ç≥„Éî„Éº
  window.UnifiedLoadingManager = AdminPanelLoadingManager;
  console.log('‚úÖ UnifiedLoadingManager (AdminPanel version) initialized');
} else {
  // Êó¢Â≠ò„ÅÆUnifiedLoadingManager„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅÊ©üËÉΩ„ÇíÊã°Âºµ
  console.log('‚ÑπÔ∏è UnifiedLoadingManager already exists, extending with AdminPanel features');
  
  // AdminPanel„ÅÆÊã°ÂºµÊ©üËÉΩ„ÇíÊó¢Â≠ò„ÅÆUnifiedLoadingManager„Å´ËøΩÂä†
  if (!window.UnifiedLoadingManager.show) {
    Object.assign(window.UnifiedLoadingManager, AdminPanelLoadingManager);
  }
}

// AdminPanelÂ∞ÇÁî®„ÅÆÂèÇÁÖß„ÇÇ‰ΩúÊàê
window.AdminPanelLoadingManager = AdminPanelLoadingManager;

// ÂæìÊù•„ÅÆ„Ç∞„É≠„Éº„Éê„É´„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖãÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
const globalLoadingState = {
  get isActive() { return (window.UnifiedLoadingManager || AdminPanelLoadingManager).isActive; },
  get activeOperations() { return new Set((window.UnifiedLoadingManager || AdminPanelLoadingManager).activeOperations.keys()); },
  get overlayElement() { return (window.UnifiedLoadingManager || AdminPanelLoadingManager).overlayElement; },
  get progressElement() { return (window.UnifiedLoadingManager || AdminPanelLoadingManager).progressElement; },
  get messageElement() { return (window.UnifiedLoadingManager || AdminPanelLoadingManager).messageElement; },
  get currentMessage() { return (window.UnifiedLoadingManager || AdminPanelLoadingManager).currentMessage; },
  get startTime() { return (window.UnifiedLoadingManager || AdminPanelLoadingManager).startTime; },
  get progressUpdateTimer() { return (window.UnifiedLoadingManager || AdminPanelLoadingManager).progressUpdateTimer; }
};

/**
 * Show global loading overlay with progress trackingÔºàÁµ±‰∏Ä„É≠„Éº„Éá„Ç£„É≥„Ç∞‰ΩøÁî®Ôºâ
 * @param {string} operationId - Unique ID for the operation
 * @param {string} message - Loading message to display
 * @param {Object} options - Additional options
 */
function showGlobalLoading(operationId, message = 'Âá¶ÁêÜ‰∏≠...', options = {}) {
  // Áµ±‰∏Ä„É≠„Éº„Éá„Ç£„É≥„Ç∞„Éû„Éç„Éº„Ç∏„É£„Éº„Çí‰ΩøÁî®
  if (window.UnifiedLoadingManager) {
    return window.UnifiedLoadingManager.show(operationId, message, options);
  }
  
  // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂæìÊù•„ÅÆÂÆüË£Ö
  console.log(`üîÑ Global loading start: ${operationId} - ${message}`);
  
  // Create overlay if not exists
  if (!globalLoadingState.overlayElement) {
    createGlobalLoadingOverlay();
  }
  
  // Update message and show overlay
  updateLoadingMessage(message);
  showLoadingOverlay();
  
  // Start progress tracking if enabled
  if (options.showProgress !== false) {
    startProgressTracking();
  }
  
  globalLoadingState.isActive = true;
}

/**
 * Hide global loading overlay for specific operationÔºàÁµ±‰∏Ä„É≠„Éº„Éá„Ç£„É≥„Ç∞‰ΩøÁî®Ôºâ
 * @param {string} operationId - Operation ID to remove
 * @param {string} finalMessage - Optional final message before hiding
 */
function hideGlobalLoading(operationId, finalMessage) {
  // Áµ±‰∏Ä„É≠„Éº„Éá„Ç£„É≥„Ç∞„Éû„Éç„Éº„Ç∏„É£„Éº„Çí‰ΩøÁî®
  if (window.UnifiedLoadingManager) {
    return window.UnifiedLoadingManager.hide(operationId, finalMessage);
  }
  
  // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂæìÊù•„ÅÆÂÆüË£Ö
  console.log(`‚úÖ Global loading end: ${operationId}`);
  
  if (finalMessage) {
    updateLoadingMessage(finalMessage);
    setTimeout(() => hideLoadingOverlay(), 800);
  } else {
    hideLoadingOverlay();
  }
}

/**
 * Create the global loading overlay DOM structure
 */
function createGlobalLoadingOverlay() {
  // Create main overlay with admin panel theme
  const overlay = document.createElement('div');
  overlay.id = 'global-loading-overlay';
  overlay.className = 'fixed inset-0 z-[9999] flex items-center justify-center';
  overlay.style.cssText = `
    display: none;
    background: rgba(26, 27, 38, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  `;
  
  // Create loading content container using glass-panel theme
  const container = document.createElement('div');
  container.className = 'glass-panel text-center shadow-2xl';
  container.style.cssText = `
    background: rgba(26, 27, 38, 0.9);
    border: 1px solid rgba(139, 233, 253, 0.2);
    border-radius: 1rem;
    padding: 2rem;
    max-width: 20rem;
    margin: 1rem;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  `;
  
  // Create spinner with admin panel primary color
  const spinner = document.createElement('div');
  spinner.className = 'animate-spin rounded-full mx-auto mb-4';
  spinner.style.cssText = `
    width: 3rem;
    height: 3rem;
    border: 4px solid rgba(139, 233, 253, 0.2);
    border-top: 4px solid #8be9fd;
    border-radius: 50%;
  `;
  
  // Create message element with admin panel text color
  const messageElement = document.createElement('div');
  messageElement.className = 'text-lg font-medium mb-2';
  messageElement.style.cssText = `
    color: #c0caf5;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Google Sans', sans-serif;
  `;
  messageElement.textContent = 'Âá¶ÁêÜ‰∏≠...';
  
  // Create progress element with admin panel accent color
  const progressElement = document.createElement('div');
  progressElement.className = 'text-sm';
  progressElement.style.cssText = `
    color: #8be9fd;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Google Sans', sans-serif;
  `;
  progressElement.textContent = '';
  
  // Assemble structure
  container.appendChild(spinner);
  container.appendChild(messageElement);
  container.appendChild(progressElement);
  overlay.appendChild(container);
  document.body.appendChild(overlay);
  
  // Store references
  globalLoadingState.overlayElement = overlay;
  globalLoadingState.messageElement = messageElement;
  globalLoadingState.progressElement = progressElement;
  
  console.log('üé® Admin-themed global loading overlay created');
}

/**
 * Show loading overlay with animation
 */
function showLoadingOverlay() {
  if (!globalLoadingState.overlayElement) return;
  
  globalLoadingState.startTime = Date.now();
  globalLoadingState.overlayElement.style.display = 'flex';
  
  // Fade in animation
  requestAnimationFrame(() => {
    globalLoadingState.overlayElement.style.opacity = '0';
    globalLoadingState.overlayElement.style.transform = 'scale(0.95)';
    
    requestAnimationFrame(() => {
      globalLoadingState.overlayElement.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
      globalLoadingState.overlayElement.style.opacity = '1';
      globalLoadingState.overlayElement.style.transform = 'scale(1)';
    });
  });
}

/**
 * Hide loading overlay with animation
 */
function hideLoadingOverlay() {
  if (!globalLoadingState.overlayElement) return;
  
  const overlay = globalLoadingState.overlayElement;
  
  // Fade out animation
  overlay.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
  overlay.style.opacity = '0';
  overlay.style.transform = 'scale(0.95)';
  
  setTimeout(() => {
    overlay.style.display = 'none';
    globalLoadingState.isActive = false;
    stopProgressTracking();
  }, 300);
  
  console.log('üéØ Global loading overlay hidden');
}

/**
 * Update loading message
 * @param {string} message - New message to display
 */
function updateLoadingMessage(message) {
  if (globalLoadingState.messageElement) {
    globalLoadingState.messageElement.textContent = message;
    globalLoadingState.currentMessage = message;
    console.log(`üí¨ Loading message updated: ${message}`);
  }
}

/**
 * Start progress tracking with elapsed time
 */
function startProgressTracking() {
  if (globalLoadingState.progressUpdateTimer) {
    clearInterval(globalLoadingState.progressUpdateTimer);
  }
  
  globalLoadingState.progressUpdateTimer = setInterval(() => {
    if (!globalLoadingState.isActive || !globalLoadingState.startTime) return;
    
    const elapsed = Math.floor((Date.now() - globalLoadingState.startTime) / 1000);
    const progressText = `Âá¶ÁêÜÊôÇÈñì: ${elapsed}Áßí`;
    
    if (globalLoadingState.progressElement) {
      globalLoadingState.progressElement.textContent = progressText;
    }
  }, 1000);
}

/**
 * Stop progress tracking
 */
function stopProgressTracking() {
  if (globalLoadingState.progressUpdateTimer) {
    clearInterval(globalLoadingState.progressUpdateTimer);
    globalLoadingState.progressUpdateTimer = null;
  }
}

/**
 * Force hide all loading overlays (emergency cleanup)
 */
function forceHideGlobalLoading() {
  globalLoadingState.activeOperations.clear();
  hideLoadingOverlay();
  console.log('üö® Force hide global loading - all operations cleared');
}

/**
 * Check if global loading is currently active
 * @returns {boolean} True if loading is active
 */
function isGlobalLoadingActive() {
  return globalLoadingState.isActive && globalLoadingState.activeOperations.size > 0;
}

// =============================================================================  
// STATE MANAGEMENT
// =============================================================================

// „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÂØæÂøú: „É¶„Éº„Ç∂„ÉºID„ÅÆÂÆâÂÖ®„Å™ÂàùÊúüÂåñ
var userId = '';

// „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÂØæÂøú: „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åã„ÇâÂÆâÂÖ®„Å´„É¶„Éº„Ç∂„ÉºID„ÇíÂèñÂæó
function initializeUserId() {
  console.group('üîê Initializing UserId');
  logDebug('üìû About to call getCurrentUserStatus');
  
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(response => {
        logDebug('üì• getCurrentUserStatus response:', response);
        
        if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
          userId = response.userInfo.userId;
          logDebug('‚úÖ AdminPanel: User authenticated, userId:', userId);
          console.groupEnd();
          resolve(userId);
        } else {
          console.error('‚ùå Failed to get userId from backend:', response);
          console.error('‚ùå Expected: {status: "success", userInfo: {userId: "..."}}');
          console.groupEnd();
          reject(new Error('„É¶„Éº„Ç∂„ÉºID„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'));
        }
      })
      .withFailureHandler(error => {
        console.error('‚ùå Backend error getting userId:', error);
        console.error('‚ùå Error type:', typeof error);
        console.error('‚ùå Error details:', error);
        console.groupEnd();
        reject(error);
      })
      .getCurrentUserStatus();
  });
}

// „É¶„Éº„Ç∂„ÉºIDÂèñÂæó„ÅÆÂÆå‰∫Ü„ÇíÂæÖ„Å§Promise
const userIdPromise = initializeUserId();
var selectedSheet = '';
var currentActiveSheet = '';
var webAppUrl = '';
var currentSpreadsheetUrl = '';
var currentStatus = null;

// Global variables from adminPanel.js.html
let currentStep = 1;
let selectedSheetId = null;
let selectedFormId = null;
let availableSheets = [];
let availableForms = [];
let currentConfig = null;

// Initialize admin panel
function initializeAdminPanel(incomingUserId) {
  // userId is now managed globally by adminPanel-core.js
  loadUserInfo();
  loadSystemStatus();
  setupEventListeners();
  setupRealtimeUpdates();
  validateCurrentStep();
}

// =============================================================================
// LEGACY UTILITIES (for backward compatibility)
// =============================================================================

// Safe text content setter
function safeSetText(elementId, text) {
  var element = typeof elementId === 'string' ? getCachedElement(elementId) : elementId;
  if (element) {
    setSafeTextContent(element, text || '');
  }
}

// =============================================================================
// LAYOUT AND VIEWPORT UTILITIES
// =============================================================================

// Layout adjustment for responsive design
function adjustLayout() {
  var isMobile = window.innerWidth < 768;
  var body = document.body;
  
  if (isMobile) {
    body.classList.add('mobile-layout');
    body.classList.remove('desktop-layout');
  } else {
    body.classList.add('desktop-layout');
    body.classList.remove('mobile-layout');
  }
}

// AdminPanel no longer overrides global setLoading
// Uses unified loading system with admin-specific configurations


// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize layout on load
// Áµ±ÂêàÂàùÊúüÂåñÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
function initCore() {
  adjustLayout();
}

// ÂÖ¨ÈñãÂÅúÊ≠¢Âæå„ÅÆÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥Â±ïÈñãÂá¶ÁêÜ
function checkAndExpandAllSections() {
  try {
    const expandAllFlag = localStorage.getItem('expandAllSections');
    if (expandAllFlag === 'true') {
      logInfo('üìÇ ÂÖ¨ÈñãÂÅúÊ≠¢Âæå„ÅÆ„Åü„ÇÅÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂ±ïÈñã„Åó„Åæ„Åô');
      
      // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„Åã„Çâ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂ±ïÈñãÔºàDOMË¶ÅÁ¥†„ÅÆÊ∫ñÂÇô„ÇíÂæÖ„Å§Ôºâ
      setTimeout(() => {
        const sectionIds = ['step1-content', 'step2-content', 'step3-content'];
        let expandedCount = 0;
        
        sectionIds.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            // „Çª„ÇØ„Ç∑„Éß„É≥„ÅåÊäò„Çä„Åü„Åü„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂ±ïÈñã
            if (section.classList.contains('hidden')) {
              toggleSection(sectionId);
              expandedCount++;
              logDebug(`‚úÖ „Çª„ÇØ„Ç∑„Éß„É≥Â±ïÈñã: ${sectionId}`);
            }
          }
        });
        
        if (expandedCount > 0) {
          logInfo(`üìÇ ${expandedCount}ÂÄã„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂ±ïÈñã„Åó„Åæ„Åó„Åü`);
        }
        
        // „Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢Ôºà‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°åÔºâ
        localStorage.removeItem('expandAllSections');
        logDebug('üßπ ÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥Â±ïÈñã„Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
      }, 500);
    }
  } catch (error) {
    logWarn('‚ö†Ô∏è ÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥Â±ïÈñãÂá¶ÁêÜ„Åß„Ç®„É©„Éº:', error);
  }
}

// Áµ±ÂêàÂàùÊúüÂåñ„Ç∑„Çπ„ÉÜ„É† - Âçò‰∏Ä„Ç®„É≥„Éà„É™„Éº„Éù„Ç§„É≥„Éà
// „Ç∑„Çπ„ÉÜ„É†Áõ£Ë¶ñÁî®„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
window.systemStatus = {
  initializationStarted: false,
  coreInitialized: false,
  apiInitialized: false,
  uiInitialized: false,
  eventsInitialized: false,
  initializationComplete: false,
  errors: [],
  lastActivity: Date.now()
};

function updateSystemStatus(component, status, error = null) {
  window.systemStatus[component] = status;
  window.systemStatus.lastActivity = Date.now();
  if (error) {
    window.systemStatus.errors.push({ component, error: error.toString(), timestamp: Date.now() });
  }
  logDebug(`üìä System Status: ${component} = ${status}`);
}

function initializeAdminPanelMaster() {
  logInfo('üöÄ AdminPanel Master Initialization Started');
  updateSystemStatus('initializationStarted', true);
  
  // Phase 1: CoreÂàùÊúüÂåñ
  try {
    initCore();
    updateSystemStatus('coreInitialized', true);
  } catch (error) {
    updateSystemStatus('coreInitialized', false, error);
    console.error('‚ùå Core initialization failed:', error);
  }
  
  // ÂÖ¨ÈñãÂÅúÊ≠¢Âæå„ÅÆÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥Â±ïÈñãÂá¶ÁêÜ
  checkAndExpandAllSections();
  
  // „Éï„Ç©„Éº„É†‰ΩúÊàêÂÆå‰∫ÜË°®Á§∫„Çí„ÇØ„É™„Ç¢ÔºàÊñ∞Ë¶è„Ç¢„ÇØ„Çª„ÇπÊôÇ„ÅØ„Éá„Éï„Ç©„É´„Éà„ÅßÈùûË°®Á§∫Ôºâ
  setTimeout(() => {
    const formJustCreated = sessionStorage.getItem('form_just_created');
    if (formJustCreated !== 'true') {
      // Êñ∞Ë¶è‰ΩúÊàê„Åß„ÅØ„Å™„ÅÑÂ†¥Âêà„ÄÅ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
      const formUrlSection = document.getElementById('form-url-section');
      if (formUrlSection && !formUrlSection.classList.contains('hidden')) {
        formUrlSection.classList.add('hidden');
        logDebug('üìã Êó¢Â≠ò„Ç¢„ÇØ„Çª„ÇπÊôÇ„ÅØ„Éï„Ç©„Éº„É†ÂÆå‰∫Ü„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫');
      }
    }
  }, 100);
  
  // Phase 2: ÂêÑ„É¢„Ç∏„É•„Éº„É´„Çí‰∏¶ÂàóÂàùÊúüÂåñ („Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂêë‰∏ä)
  // ÈÅÖÂª∂„ÇíÊúÄÂ∞èÈôê„Å´ÊäëÂà∂„Åó„Å¶Âç≥Â∫ß„Å´ÂàùÊúüÂåñ
  setTimeout(() => {
    logDebug('üîß Phase 2: ‰∏¶Âàó„É¢„Ç∏„É•„Éº„É´ÂàùÊúüÂåñÈñãÂßã');
    
    // StatusÁÆ°ÁêÜÂàùÊúüÂåñ
    if (typeof initializeMessageArea === 'function') {
      initializeMessageArea();
      logDebug('‚úÖ Status module initialized');
    }
    
    // APIÈÄö‰ø°ÂàùÊúüÂåñÔºàÊúÄÈáçË¶Å - getInitialData„ÇíÂëº„Å≥Âá∫„ÅôÔºâ
    function initializeAPIWithRetry(attempts = 0) {
      if (typeof initializeAPI === 'function' && typeof runGasWithUserId === 'function') {
        logDebug('üöÄ API module initialization starting...');
        try {
          initializeAPI();
          updateSystemStatus('apiInitialized', true);
          logDebug('‚úÖ API module initialized');
        } catch (error) {
          updateSystemStatus('apiInitialized', false, error);
          console.error('‚ùå API initialization failed:', error);
        }
        return;
      } 
      
      if (attempts < 5) { // 10 -> 5„Å´Áü≠Á∏Æ
        logDebug(`‚è≥ APIÈñ¢Êï∞Ë™≠„ÅøËæº„ÅøÂæÖÊ©ü‰∏≠... (Ë©¶Ë°å ${attempts + 1}/5)`);
        setTimeout(() => initializeAPIWithRetry(attempts + 1), 200); // 100ms -> 200ms„Å´Ë™øÊï¥
        return;
      }
      
      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂÆüË£Ö
      console.warn('‚ö†Ô∏è API functions not available, implementing fallback...');
      const missingFunctions = {
        initializeAPI: typeof initializeAPI,
        runGasWithUserId: typeof runGasWithUserId
      };
      console.error('Missing functions:', missingFunctions);
      updateSystemStatus('apiInitialized', false, new Error(`Missing functions: ${JSON.stringify(missingFunctions)}`));
      
      // üîß ÊîπËâØ„Åï„Çå„Åü„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞„ÇíÂÆüË£Ö
      if (typeof runGasWithUserId !== 'function') {
        window.runGasWithUserId = function(functionName, loadingMessage, ...args) {
          console.warn(`üîÑ Fallback: ${functionName} called with message: ${loadingMessage}`);
          
          // üéØ ÊÆµÈöéÁöÑ„Å´„É™„Éà„É©„Ç§„Åó„Å¶ÂÆüÈöõ„ÅÆAPIÈñ¢Êï∞„ÇíÂæÖÊ©ü
          return new Promise((resolve, reject) => {
            let retryCount = 0;
            const maxRetries = 10;
            
            const checkApiAvailability = () => {
              // SharedUtilities„ÅåË™≠„ÅøËæº„Åæ„Çå„ÄÅÂÆüÈöõ„ÅÆrunGasWithUserIdÈñ¢Êï∞„ÅåÂà©Áî®ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
              if (typeof sharedUtilities !== 'undefined' && 
                  sharedUtilities.gas && 
                  typeof sharedUtilities.gas.call === 'function') {
                
                // ÂÆüÈöõ„ÅÆAPIÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                try {
                  // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫‰ªò„Åç„ÅßÂÆüË°å
                  const realCall = loadingMessage && loadingMessage !== false ?
                    sharedUtilities.gas.callWithLoading(functionName, loadingMessage, 'overlay', userId, ...args) :
                    (userId ? 
                      sharedUtilities.gas.call(functionName, userId, ...args) :
                      sharedUtilities.gas.call(functionName, ...args));
                    
                  console.log(`‚úÖ FallbackÊàêÂäü: ${functionName}„ÅÆÂÆüË°å„ÇíÂæ©Êóß`);
                  resolve(realCall);
                } catch (error) {
                  console.error(`‚ùå FallbackÂÆüË°å„Ç®„É©„Éº: ${functionName}`, error);
                  reject(error);
                }
              } else {
                retryCount++;
                if (retryCount < maxRetries) {
                  setTimeout(checkApiAvailability, 1000);
                } else {
                  reject(new Error(`API function ${functionName} not available after ${maxRetries} retries`));
                }
              }
            };
            
            checkApiAvailability();
          });
        };
        logDebug('üì¶ Improved fallback runGasWithUserId implemented');
      }
      
      if (typeof initializeAPI !== 'function') {
        window.initializeAPI = function() {
          console.warn('üîÑ Fallback: initializeAPI called');
          logDebug('üì¶ Fallback API initialization');
        };
        logDebug('üì¶ Fallback initializeAPI implemented');
      }
      
      updateSystemStatus('apiInitialized', 'fallback');
      logDebug('‚úÖ API module initialized with fallback');
    }
    
    initializeAPIWithRetry();
    
    // UIÂàùÊúüÂåñ
    if (typeof initializeUI === 'function') {
      try {
        initializeUI();
        updateSystemStatus('uiInitialized', true);
        logDebug('‚úÖ UI module initialized');
      } catch (error) {
        updateSystemStatus('uiInitialized', false, error);
        console.error('‚ùå UI initialization failed:', error);
      }
    } else {
      updateSystemStatus('uiInitialized', false, new Error('initializeUI function not found'));
    }
    
    // „Éï„Ç©„Éº„É†ÁÆ°ÁêÜÂàùÊúüÂåñ
    if (typeof setupCharacterCounters === 'function') {
      setupCharacterCounters();
      logDebug('‚úÖ Forms module initialized');
    }
    
    // „Ç§„Éô„É≥„ÉàÁÆ°ÁêÜÂàùÊúüÂåñÔºàÊúÄÂæå„Å´ÂÆüË°åÔºâ
    setTimeout(() => {
      function initializeEventsWithRetry(attempts = 0) {
        // üîß ÊîπÂñÑ„Åï„Çå„Åü„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„ÉÅ„Çß„ÉÉ„ÇØÔºàwindow„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇÇÁ¢∫Ë™çÔºâ
        const functionsAvailable = {
          initializeEventListeners: typeof initializeEventListeners === 'function' || typeof window.initializeEventListeners === 'function',
          handleQuickStart: typeof handleQuickStart === 'function' || typeof window.handleQuickStart === 'function',
          runHeaderGuessing: typeof runHeaderGuessing === 'function' || typeof window.runHeaderGuessing === 'function'
        };
        
        logDebug('üîç Èñ¢Êï∞ÂèØÁî®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØ:', functionsAvailable);
        
        if (functionsAvailable.initializeEventListeners && 
            functionsAvailable.handleQuickStart && 
            functionsAvailable.runHeaderGuessing) {
          try {
            // „Ç∞„É≠„Éº„Éê„É´„Åæ„Åü„ÅØ„É≠„Éº„Ç´„É´„Çπ„Ç≥„Éº„Éó„Åã„ÇâÈñ¢Êï∞„ÇíÂèñÂæó
            const initEventsFn = typeof initializeEventListeners === 'function' ? initializeEventListeners : window.initializeEventListeners;
            initEventsFn();
            
            updateSystemStatus('eventsInitialized', true);
            updateSystemStatus('initializationComplete', true);
            logDebug('‚úÖ Events module initialized');
            logInfo('üéâ AdminPanel Master Initialization Complete');
            
            // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÅÆÊúÄÁµÇ„É¨„Éù„Éº„Éà
            console.log('üìä Final System Status:', window.systemStatus);
          } catch (error) {
            updateSystemStatus('eventsInitialized', false, error);
            console.error('‚ùå Events initialization failed:', error);
          }
          return;
        } 
        
        if (attempts < 8) { // 5 -> 8„Å´Â¢óÂä†Ôºà„Çà„ÇäÂØõÂÆπ„Å´Ôºâ
          logDebug(`‚è≥ „Ç§„Éô„É≥„ÉàÈñ¢Êï∞Ë™≠„ÅøËæº„ÅøÂæÖÊ©ü‰∏≠... (Ë©¶Ë°å ${attempts + 1}/8)`);
          setTimeout(() => initializeEventsWithRetry(attempts + 1), 300); // 200ms -> 300ms„Å´Ë™øÊï¥
          return;
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂÆüË£ÖÔºà„Çà„ÇäÁ¢∫ÂÆü„Å´Ôºâ
        console.warn('‚ö†Ô∏è Event functions not available after 8 attempts, implementing enhanced fallback...');
        const missingEventFunctions = {
          initializeEventListeners: typeof initializeEventListeners,
          handleQuickStart: typeof handleQuickStart,
          runHeaderGuessing: typeof runHeaderGuessing,
          // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„ÇÇÁ¢∫Ë™ç
          'window.initializeEventListeners': typeof window.initializeEventListeners,
          'window.handleQuickStart': typeof window.handleQuickStart,
          'window.runHeaderGuessing': typeof window.runHeaderGuessing
        };
        console.error('Missing functions detail:', missingEventFunctions);
        updateSystemStatus('eventsInitialized', false, new Error(`Missing event functions: ${JSON.stringify(missingEventFunctions)}`));
        
        // üîß Âº∑Âåñ„Åï„Çå„Åü„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞„ÇíÂÆüË£Ö
        if (!functionsAvailable.handleQuickStart) {
          window.handleQuickStart = function() {
            console.warn('üîÑ Enhanced Fallback: handleQuickStart called');
            if (window.showMessage) {
              window.showMessage('QuickStartÊ©üËÉΩ„ÅØÁèæÂú®Âà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
            }
          };
          logDebug('üì¶ Enhanced Fallback handleQuickStart implemented');
        }
        
        if (!functionsAvailable.runHeaderGuessing) {
          window.runHeaderGuessing = function() {
            console.warn('üîÑ Enhanced Fallback: runHeaderGuessing called');
            if (window.showMessage) {
              window.showMessage('AIÂà§ÂÆöÊ©üËÉΩ„ÅØÁèæÂú®Âà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
            }
          };
          logDebug('üì¶ Enhanced Fallback runHeaderGuessing implemented');
        }
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅØÂà©Áî®ÂèØËÉΩ„Å™Â†¥Âêà„ÅÆ„ÅøÂàùÊúüÂåñ
        if (functionsAvailable.initializeEventListeners) {
          try {
            const initEventsFn = typeof initializeEventListeners === 'function' ? initializeEventListeners : window.initializeEventListeners;
            initEventsFn();
            updateSystemStatus('eventsInitialized', 'partial');
            logDebug('‚úÖ Events module initialized (partial)');
          } catch (error) {
            updateSystemStatus('eventsInitialized', false, error);
            console.error('‚ùå Partial events initialization failed:', error);
          }
        } else {
          logDebug('üì¶ Events module skipped (function not available)');
        }
        
        updateSystemStatus('initializationComplete', 'fallback');
        logInfo('‚ö†Ô∏è AdminPanel Master Initialization Complete (with enhanced fallback functions)');
        
        // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÅÆÊúÄÁµÇ„É¨„Éù„Éº„ÉàÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁâàÔºâ
        console.log('üìä Final System Status (Enhanced Fallback):', window.systemStatus);
      }
      
      initializeEventsWithRetry();
    }, 150); // 100ms -> 150ms„Å´Ë™øÊï¥Ôºà„Çà„Çä‰ΩôË£ï„ÇíÊåÅ„Å£„Å¶Ôºâ
    
  }, 10); // 50ms -> 10ms„Å´Áü≠Á∏Æ
}

// =============================================================================
// ÂÆâÂÖ®„Å™Èñ¢Êï∞Âëº„Å≥Âá∫„Åó„Ç∑„Çπ„ÉÜ„É† - „Ç®„É©„ÉºÈò≤Ê≠¢„ÅÆ„Åü„ÇÅ„ÅÆ‰∏≠Ê†∏Ê©üËÉΩ
// =============================================================================

// Èñ¢Êï∞Â≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„ÅçÂÆâÂÖ®Âëº„Å≥Âá∫„Åó
function safeCall(functionName, ...args) {
  // Validate function name
  if (!functionName || typeof functionName !== 'string') {
    logError('safeCall: Invalid function name:', functionName);
    return null;
  }

  if (typeof window[functionName] === 'function') {
    try {
      logDebug(`Calling function: ${functionName}`);
      return window[functionName](...args);
    } catch (error) {
      logError(`Error calling ${functionName}:`, error);
      
      // Èñ¢Êï∞Â≠òÂú®ÊôÇ„ÅÆ„Ç®„É©„ÉºÁµ±Ë®à„ÇíË®òÈå≤
      if (!window.adminPanelErrorStats) {
        window.adminPanelErrorStats = {};
      }
      window.adminPanelErrorStats[functionName] = (window.adminPanelErrorStats[functionName] || 0) + 1;
      
      return null;
    }
  } else {
    logWarn(`Function ${functionName} is not defined, deferring call`);
    // ÈÅÖÂª∂ÂÆüË°å„Ç≠„É•„Éº„Å´ËøΩÂä†
    deferredCalls.push({ functionName, args, timestamp: Date.now() });
    return null;
  }
}

// ÈÅÖÂª∂ÂÆüË°å„Ç≠„É•„Éº
const deferredCalls = [];

// Èñ¢Êï∞„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖÊ©ü
function waitForFunction(functionName, maxRetries = 100, interval = 200) {
  return new Promise((resolve, reject) => {
    let retries = 0;
    
    function check() {
      if (typeof window[functionName] === 'function') {
        resolve(window[functionName]);
      } else if (retries < maxRetries) {
        retries++;
        setTimeout(check, interval);
      } else {
        reject(new Error(`Function ${functionName} not found after ${maxRetries * interval}ms`));
      }
    }
    
    check();
  });
}

// ÈÅÖÂª∂ÂÆüË°å„Ç≠„É•„Éº„ÅÆÂá¶ÁêÜ
function processDeferredCalls() {
  const currentTime = Date.now();
  const processedCalls = [];
  
  deferredCalls.forEach((call, index) => {
    // 5Áßí‰ª•‰∏äÂè§„ÅÑÂëº„Å≥Âá∫„Åó„ÅØÁ†¥Ê£Ñ
    if (currentTime - call.timestamp > 5000) {
      console.warn(`Discarding old deferred call: ${call.functionName}`);
      processedCalls.push(index);
      return;
    }
    
    // Èñ¢Êï∞„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Å£„Åü„ÇâÂÆüË°å
    if (typeof window[call.functionName] === 'function') {
      try {
        console.log(`Executing deferred call: ${call.functionName}`);
        window[call.functionName](...call.args);
        processedCalls.push(index);
      } catch (error) {
        console.error(`Error executing deferred call ${call.functionName}:`, error);
        processedCalls.push(index);
      }
    }
  });
  
  // Âá¶ÁêÜÊ∏à„Åø„ÅÆÂëº„Å≥Âá∫„Åó„ÇíÂâäÈô§ÔºàÈÄÜÈ†Ü„ÅßÂâäÈô§Ôºâ
  processedCalls.reverse().forEach(index => {
    deferredCalls.splice(index, 1);
  });
}

// ÂÆöÊúüÁöÑ„Å´ÈÅÖÂª∂ÂÆüË°å„Ç≠„É•„Éº„ÇíÂá¶ÁêÜ
const deferredCallsProcessor = setInterval(() => {
  if (deferredCalls.length > 0) {
    processDeferredCalls();
  }
  
  // 5ÂàÜÁµå„Å£„Åü„ÇâÂÆöÊúüÂÆüË°å„ÇíÂÅúÊ≠¢
  if (Date.now() - window.adminPanelStartTime > 300000) {
    clearInterval(deferredCallsProcessor);
  }
}, 300);

// ÂàùÊúüÂåñÂÆå‰∫Ü„Éï„É©„Ç∞„Å®„ÉÅ„Çß„ÉÉ„Ç´„Éº
window.adminPanelStartTime = Date.now();
window.coreInitialized = false;
window.uiInitialized = false;
window.apiInitialized = false;

// ÂàùÊúüÂåñÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
function checkInitializationComplete() {
  const requiredFunctions = [
    'updateUIWithNewStatus',
    'navigateToStep', 
    'showFormConfigModal',
    'hideFormConfigModal',
    'toggleSection',
    'runGasWithUserId'
  ];
  
  const missingFunctions = requiredFunctions.filter(func => 
    typeof window[func] !== 'function'
  );
  
  if (missingFunctions.length === 0) {
    console.log('‚úÖ All critical functions are available');
    processDeferredCalls(); // ÊúÄÁµÇÁöÑ„Å™ÈÅÖÂª∂ÂÆüË°åÂá¶ÁêÜ
    return true;
  } else {
    console.log('‚ö†Ô∏è Missing functions:', missingFunctions);
    return false;
  }
}

// Ë§áÊï∞„ÅÆÈñ¢Êï∞„ÇíÂæÖÊ©üÔºàÊó¢Â≠ò„ÅÆwaitForFunctionÈñ¢Êï∞„Çí‰ΩøÁî®Ôºâ
function waitForFunctions(funcNames, maxRetries = 50, interval = 100) {
  return Promise.all(
    funcNames.map(funcName => waitForFunction(funcName, maxRetries, interval))
  );
}

// Á∞°Á¥†Âåñ„Åï„Çå„ÅüÂàùÊúüÂåñ„Ç∑„Çπ„ÉÜ„É†
function safeInitializeAdminPanelMaster() {
  try {
    console.log('üöÄ Starting simplified admin panel initialization...');
    
    // CoreÂàùÊúüÂåñ„Éï„É©„Ç∞„ÇíË®≠ÂÆö
    window.coreInitialized = true;
    
    // „Ç≥„Ç¢Ê©üËÉΩ„ÅÆÂàùÊúüÂåñ
    if (typeof initCore === 'function') {
      initCore();
    }
    
    // „É°„Ç§„É≥„ÅÆÂàùÊúüÂåñ„ÇíÂÆüË°å
    if (typeof initializeAdminPanelMaster === 'function') {
      initializeAdminPanelMaster();
    }
    
    // Á∞°Âçò„Å™ÂàùÊúüÂåñÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØÔºà2ÁßíÂæåÔºâ
    setTimeout(() => {
      const missingFunctions = ['updateUIWithNewStatus', 'navigateToStep', 'showFormConfigModal', 'hideFormConfigModal', 'toggleSection']
        .filter(func => typeof window[func] !== 'function');
      
      if (missingFunctions.length === 0) {
        console.log('‚úÖ All critical functions are available');
      } else {
        console.warn('‚ö†Ô∏è Some functions still missing (using stubs):', missingFunctions);
      }
    }, 2000);
    
    console.log('‚úÖ Simplified initialization completed');
    
  } catch (error) {
    console.error('‚ùå Error during initialization:', error);
    
    // „Ç∑„É≥„Éó„É´„Å™„Ç®„É©„ÉºÂõûÂæ©
    setTimeout(() => {
      console.log('üîÑ Attempting recovery...');
      if (typeof initializeAdminPanelMaster === 'function') {
        initializeAdminPanelMaster();
      }
    }, 2000);
  }
}

// Âçò‰∏ÄDOMContentLoaded„Éè„É≥„Éâ„É©„Éº - „Ç®„É©„ÉºÈò≤Ê≠¢Áâà
if (document.readyState !== 'loading') {
  safeInitializeAdminPanelMaster();
} else {
  document.addEventListener('DOMContentLoaded', safeInitializeAdminPanelMaster);
}

// Update layout on resize
window.addEventListener('resize', debounce(adjustLayout, 250, 'layout-resize'));
</script>
