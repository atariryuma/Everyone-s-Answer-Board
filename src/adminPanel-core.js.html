<script>
// =============================================================================
// ADMIN PANEL CORE UTILITIES & DOM OPERATIONS
// =============================================================================

// =============================================================================
// IMMEDIATE FUNCTION STUBS - Prevent undefined function errors
// =============================================================================

// Define critical function stubs immediately to prevent undefined errors


if (typeof window.navigateToStep === 'undefined') {
  window.navigateToStep = function(step) {
    console.warn('navigateToStep stub called - actual function not yet loaded');
  };
}

if (typeof window.showFormConfigModal === 'undefined') {
  window.showFormConfigModal = function() {
    console.warn('showFormConfigModal stub called - actual function not yet loaded');
  };
}

if (typeof window.hideFormConfigModal === 'undefined') {
  window.hideFormConfigModal = function() {
    console.warn('hideFormConfigModal stub called - actual function not yet loaded');
  };
}

if (typeof window.toggleSection === 'undefined') {
  window.toggleSection = function(sectionId) {
    console.warn('toggleSection stub called - actual function not yet loaded');
  };
}

console.log('âœ… Function stubs initialized to prevent undefined errors');

// =============================================================================
// UNIFIED ERROR HANDLING AND LOGGING SYSTEM - Enhanced Version
// =============================================================================

// çµ±ä¸€ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå¼·åŒ–ç‰ˆï¼‰
const UnifiedErrorHandler = {
  // ã‚¨ãƒ©ãƒ¼åˆ†é¡å®šæ•°
  ErrorTypes: {
    CRITICAL: 'critical',      // ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã«å½±éŸ¿ã™ã‚‹é‡å¤§ã‚¨ãƒ©ãƒ¼
    HIGH: 'high',             // æ©Ÿèƒ½ã«é‡å¤§ãªå½±éŸ¿ãŒã‚ã‚‹ã‚¨ãƒ©ãƒ¼
    MEDIUM: 'medium',         // éƒ¨åˆ†çš„ãªæ©Ÿèƒ½éšœå®³
    LOW: 'low',               // è»½å¾®ãªã‚¨ãƒ©ãƒ¼ã‚„è­¦å‘Š
    DEBUG: 'debug'            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
  },
  
  ErrorCategories: {
    URL_GENERATION: 'url_generation',
    API_COMMUNICATION: 'api_communication',
    UI_UPDATE: 'ui_update',
    DATA_VALIDATION: 'data_validation',
    CACHE_OPERATION: 'cache_operation',
    USER_ACTION: 'user_action',
    SYSTEM_INITIALIZATION: 'system_initialization'
  },
  
  // ã‚¨ãƒ©ãƒ¼çµ±è¨ˆ
  errorStats: {
    total: 0,
    byType: {},
    byCategory: {},
    recentErrors: [], // æœ€æ–°10ä»¶ã®ã‚¨ãƒ©ãƒ¼
    maxRecentErrors: 10
  },
  
  // è¨­å®š
  debugMode: window.DEBUG_MODE || false,
  suppressedPatterns: [
    'document.write',
    'Failed to execute \'write\'',
    'mae_html_user_bin_i18n',
    'warden_bin_i18n',
    'unrecognized feature',
    'Tailwind CLI'
  ],
  
  /**
   * çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ©Ÿèƒ½
   * @param {Error|string} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   * @param {string} type - ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—
   * @param {string} category - ã‚¨ãƒ©ãƒ¼ã‚«ãƒ†ã‚´ãƒª
   * @param {Object} context - è¿½åŠ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±
   */
  logError(error, type = this.ErrorTypes.MEDIUM, category = this.ErrorCategories.SYSTEM_INITIALIZATION, context = {}) {
    const errorMessage = error?.message || error?.toString() || String(error);
    
    // æŠ‘åˆ¶ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚§ãƒƒã‚¯
    if (this.shouldSuppressError(errorMessage)) {
      if (this.debugMode) {
        console.debug('ğŸ”‡ Suppressed error:', errorMessage);
      }
      return;
    }
    
    // ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’æ§‹ç¯‰
    const errorInfo = {
      timestamp: new Date().toISOString(),
      message: errorMessage,
      type: type,
      category: category,
      context: context,
      stack: error?.stack || null,
      userAgent: navigator.userAgent,
      url: window.location.href
    };
    
    // çµ±è¨ˆã‚’æ›´æ–°
    this.updateErrorStats(errorInfo);
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸãƒ­ã‚°å‡ºåŠ›
    this.outputError(errorInfo);
    
    // é‡è¦ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è¿½åŠ å‡¦ç†
    if (type === this.ErrorTypes.CRITICAL || type === this.ErrorTypes.HIGH) {
      this.handleCriticalError(errorInfo);
    }
    
    return errorInfo;
  },
  
  /**
   * ã‚¨ãƒ©ãƒ¼æŠ‘åˆ¶ãƒã‚§ãƒƒã‚¯
   * @param {string} message - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   * @returns {boolean} æŠ‘åˆ¶ã™ã¹ãã‹ã©ã†ã‹
   */
  shouldSuppressError(message) {
    return this.suppressedPatterns.some(pattern => 
      message && message.includes(pattern)
    );
  },
  
  /**
   * ã‚¨ãƒ©ãƒ¼çµ±è¨ˆã®æ›´æ–°
   * @param {Object} errorInfo - ã‚¨ãƒ©ãƒ¼æƒ…å ±
   */
  updateErrorStats(errorInfo) {
    this.errorStats.total++;
    
    // ã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆ
    if (!this.errorStats.byType[errorInfo.type]) {
      this.errorStats.byType[errorInfo.type] = 0;
    }
    this.errorStats.byType[errorInfo.type]++;
    
    // ã‚«ãƒ†ã‚´ãƒªåˆ¥çµ±è¨ˆ
    if (!this.errorStats.byCategory[errorInfo.category]) {
      this.errorStats.byCategory[errorInfo.category] = 0;
    }
    this.errorStats.byCategory[errorInfo.category]++;
    
    // æœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²
    this.errorStats.recentErrors.push({
      timestamp: errorInfo.timestamp,
      message: errorInfo.message.substring(0, 100), // æœ€åˆã®100æ–‡å­—
      type: errorInfo.type,
      category: errorInfo.category
    });
    
    // æœ€å¤§æ•°ã‚’è¶…ãˆãŸå ´åˆã¯å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
    if (this.errorStats.recentErrors.length > this.maxRecentErrors) {
      this.errorStats.recentErrors.shift();
    }
  },
  
  /**
   * ã‚¨ãƒ©ãƒ¼ã®ãƒ­ã‚°å‡ºåŠ›
   * @param {Object} errorInfo - ã‚¨ãƒ©ãƒ¼æƒ…å ±
   */
  outputError(errorInfo) {
    const prefix = `[AdminPanel:${errorInfo.type.toUpperCase()}:${errorInfo.category}]`;
    const logMessage = `${errorInfo.message}`;
    
    switch (errorInfo.type) {
      case this.ErrorTypes.CRITICAL:
        console.error(`ğŸš¨ ${prefix}`, logMessage, errorInfo.context);
        break;
      case this.ErrorTypes.HIGH:
        console.error(`âŒ ${prefix}`, logMessage, errorInfo.context);
        break;
      case this.ErrorTypes.MEDIUM:
        console.warn(`âš ï¸ ${prefix}`, logMessage, errorInfo.context);
        break;
      case this.ErrorTypes.LOW:
        console.warn(`â„¹ï¸ ${prefix}`, logMessage);
        break;
      case this.ErrorTypes.DEBUG:
        if (this.debugMode) {
          console.log(`ğŸ” ${prefix}`, logMessage, errorInfo.context);
        }
        break;
      default:
        console.log(`ğŸ“ ${prefix}`, logMessage);
    }
  },
  
  /**
   * é‡è¦ãªã‚¨ãƒ©ãƒ¼ã®è¿½åŠ å‡¦ç†
   * @param {Object} errorInfo - ã‚¨ãƒ©ãƒ¼æƒ…å ±
   */
  handleCriticalError(errorInfo) {
    // é‡è¦ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è©³ç´°ãªæƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
    console.group(`ğŸš¨ é‡è¦ãªã‚¨ãƒ©ãƒ¼ã®è©³ç´°: ${errorInfo.category}`);
    console.log('ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—:', errorInfo.timestamp);
    console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', errorInfo.message);
    console.log('ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:', errorInfo.context);
    if (errorInfo.stack) {
      console.log('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', errorInfo.stack);
    }
    console.log('çµ±è¨ˆæƒ…å ±:', this.getErrorStats());
    console.groupEnd();
    
    // TODO: å°†æ¥çš„ã«ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã¸ã®é‡è¦ã‚¨ãƒ©ãƒ¼å ±å‘Šæ©Ÿèƒ½ã‚’è¿½åŠ 
  },
  
  /**
   * ã‚¨ãƒ©ãƒ¼çµ±è¨ˆã®å–å¾—
   * @returns {Object} ã‚¨ãƒ©ãƒ¼çµ±è¨ˆæƒ…å ±
   */
  getErrorStats() {
    return {
      ...this.errorStats,
      categories: Object.keys(this.ErrorCategories),
      types: Object.keys(this.ErrorTypes)
    };
  }
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
window.UnifiedErrorHandler = UnifiedErrorHandler;

// å¾“æ¥ã®ãƒ­ã‚°é–¢æ•°ã‚’çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«çµ±åˆ
const DEBUG_MODE = UnifiedErrorHandler.debugMode;

function adminLog(level, ...args) {
  const message = args.join(' ');
  const context = { originalArgs: args };
  
  switch (level) {
    case 'error':
      UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.HIGH, UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context);
      break;
    case 'warn':
      UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.MEDIUM, UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context);
      break;
    case 'info':
      if (DEBUG_MODE) console.log('[AdminPanel:INFO]', ...args);
      break;
    case 'debug':
      UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.DEBUG, UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context);
      break;
    default:
      if (DEBUG_MODE) console.log('[AdminPanel]', ...args);
  }
}

// ä¾¿åˆ©ãªé–¢æ•°ç¾¤ï¼ˆçµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ä½¿ç”¨ï¼‰
function logError(message, category = UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context = {}) {
  return UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.HIGH, category, context);
}

function logWarn(message, category = UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context = {}) {
  return UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.MEDIUM, category, context);
}

function logInfo(...args) { 
  if (DEBUG_MODE) console.log('[AdminPanel:INFO]', ...args);
}

function logDebug(message, context = {}) {
  return UnifiedErrorHandler.logError(message, UnifiedErrorHandler.ErrorTypes.DEBUG, UnifiedErrorHandler.ErrorCategories.SYSTEM_INITIALIZATION, context);
}

// =============================================================================
// SHARED UTILITIES AND CODE QUALITY IMPROVEMENTS
// =============================================================================

/**
 * çµ±ä¸€ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ï¼ˆã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Šã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§æ”¹å–„ï¼‰
 */
const AdminPanelUtilities = {
  // =============================================================================
  // HTML ESCAPING AND SANITIZATION
  // =============================================================================
  
  /**
   * å®‰å…¨ãªHTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ©Ÿèƒ½ï¼ˆXSSå¯¾ç­–ï¼‰
   * @param {*} text - ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
   * @returns {string} ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸHTML
   */
  escapeHtml(text) {
    if (text == null) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
  },
  
  /**
   * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å®‰å…¨ãªæ¤œè¨¼
   * @param {*} obj - æ¤œè¨¼ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @returns {boolean} æœ‰åŠ¹ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã©ã†ã‹
   */
  isValidObject(obj) {
    return obj && typeof obj === 'object' && !Array.isArray(obj) && obj.constructor === Object;
  },
  
  /**
   * é…åˆ—ã®å®‰å…¨ãªæ¤œè¨¼
   * @param {*} arr - æ¤œè¨¼ã™ã‚‹é…åˆ—
   * @returns {boolean} æœ‰åŠ¹ãªé…åˆ—ã‹ã©ã†ã‹
   */
  isValidArray(arr) {
    return Array.isArray(arr);
  },
  
  /**
   * æ–‡å­—åˆ—ã®å®‰å…¨ãªæ¤œè¨¼
   * @param {*} str - æ¤œè¨¼ã™ã‚‹æ–‡å­—åˆ—
   * @param {number} minLength - æœ€å°æ–‡å­—æ•°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   * @returns {boolean} æœ‰åŠ¹ãªæ–‡å­—åˆ—ã‹ã©ã†ã‹
   */
  isValidString(str, minLength = 0) {
    return typeof str === 'string' && str.length >= minLength;
  },
  
  // =============================================================================
  // PERFORMANCE MONITORING
  // =============================================================================
  
  /**
   * ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 
   */
  PerformanceMonitor: {
    operations: new Map(),
    thresholds: {
      warning: 100,  // 100msä»¥ä¸Šã§è­¦å‘Š
      critical: 500  // 500msä»¥ä¸Šã§é‡è¦è­¦å‘Š
    },
    
    /**
     * æ“ä½œã®é–‹å§‹ã‚’è¨˜éŒ²
     * @param {string} operationId - æ“ä½œID
     * @param {string} description - æ“ä½œã®èª¬æ˜
     */
    start(operationId, description = '') {
      this.operations.set(operationId, {
        startTime: performance.now(),
        description: description,
        endTime: null,
        duration: null
      });
    },
    
    /**
     * æ“ä½œã®çµ‚äº†ã‚’è¨˜éŒ²
     * @param {string} operationId - æ“ä½œID
     * @returns {number} å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
     */
    end(operationId) {
      const operation = this.operations.get(operationId);
      if (!operation) {
        console.warn(`âš ï¸ Unknown operation ID: ${operationId}`);
        return 0;
      }
      
      operation.endTime = performance.now();
      operation.duration = operation.endTime - operation.startTime;
      
      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è­¦å‘Šã®å‡ºåŠ›
      if (operation.duration > this.thresholds.critical) {
        console.error(`ğŸš¨ Critical performance issue: ${operationId} took ${operation.duration.toFixed(1)}ms`);
      } else if (operation.duration > this.thresholds.warning) {
        console.warn(`âš ï¸ Performance warning: ${operationId} took ${operation.duration.toFixed(1)}ms`);
      }
      
      return operation.duration;
    },
    
    /**
     * çµ±è¨ˆæƒ…å ±ã®å–å¾—
     * @returns {Object} ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆ
     */
    getStats() {
      const completedOps = Array.from(this.operations.values()).filter(op => op.duration !== null);
      if (completedOps.length === 0) {
        return { totalOperations: 0, averageDuration: 0, slowOperations: 0 };
      }
      
      const totalDuration = completedOps.reduce((sum, op) => sum + op.duration, 0);
      const slowOps = completedOps.filter(op => op.duration > this.thresholds.warning).length;
      
      return {
        totalOperations: completedOps.length,
        averageDuration: totalDuration / completedOps.length,
        slowOperations: slowOps,
        slowOperationPercentage: (slowOps / completedOps.length) * 100
      };
    }
  },
  
  // =============================================================================
  // DEBUGGING AND DIAGNOSTICS
  // =============================================================================
  
  /**
   * ãƒ‡ãƒãƒƒã‚°ãƒ»è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ 
   */
  Diagnostics: {
    /**
     * ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®åŒ…æ‹¬çš„è¨ºæ–­
     * @returns {Object} è¨ºæ–­çµæœ
     */
    runSystemDiagnostics() {
      const diagnostics = {
        timestamp: new Date().toISOString(),
        browser: this.getBrowserInfo(),
        performance: AdminPanelUtilities.PerformanceMonitor.getStats(),
        errors: window.UnifiedErrorHandler ? window.UnifiedErrorHandler.getErrorStats() : null,
        loadingState: window.UnifiedLoadingManager ? window.UnifiedLoadingManager.getStats() : null,
        uiState: window.uiUpdateBatching ? {
          updateCount: window.uiUpdateBatching.updateCount,
          skippedUpdates: window.uiUpdateBatching.skippedUpdates,
          cacheSize: window.uiUpdateBatching.domCache.size
        } : null,
        memoryUsage: this.getMemoryUsage()
      };
      
      console.group('ğŸ” ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­çµæœ');
      console.log('è¨ºæ–­æ™‚åˆ»:', diagnostics.timestamp);
      console.log('ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±:', diagnostics.browser);
      console.log('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹:', diagnostics.performance);
      console.log('ã‚¨ãƒ©ãƒ¼çµ±è¨ˆ:', diagnostics.errors);
      console.log('ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹:', diagnostics.loadingState);
      console.log('UIæ›´æ–°çµ±è¨ˆ:', diagnostics.uiState);
      console.log('ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡:', diagnostics.memoryUsage);
      console.groupEnd();
      
      return diagnostics;
    },
    
    /**
     * ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±ã®å–å¾—
     * @returns {Object} ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±
     */
    getBrowserInfo() {
      return {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        cookieEnabled: navigator.cookieEnabled,
        onLine: navigator.onLine,
        screenResolution: `${screen.width}x${screen.height}`,
        viewportSize: `${window.innerWidth}x${window.innerHeight}`
      };
    },
    
    /**
     * ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å–å¾—ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
     * @returns {Object|null} ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æƒ…å ±
     */
    getMemoryUsage() {
      if (performance.memory) {
        return {
          usedJSHeapSize: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + ' MB',
          totalJSHeapSize: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024) + ' MB',
          jsHeapSizeLimit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024) + ' MB'
        };
      }
      return null;
    }
  }
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
window.AdminPanelUtilities = AdminPanelUtilities;

// å¾“æ¥ã®é–¢æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
function escapeHtml(text) {
  return AdminPanelUtilities.escapeHtml(text);
}

function isValidObject(obj) {
  return AdminPanelUtilities.isValidObject(obj);
}

function isValidArray(arr) {
  return AdminPanelUtilities.isValidArray(arr);
}

// =============================================================================
// ENHANCED MESSAGE SYSTEM FOR SETUP FLOW
// =============================================================================

// å¼·åŒ–ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ 
function showMessage(message, type = 'info', duration = 5000, options = {}) {
  // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if (window.sharedUtilities && window.sharedUtilities.showMessage) {
    return window.sharedUtilities.showMessage(message, type, duration, options);
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè£…
  return showInlineMessage(message, type, duration, options);
}

// ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…ï¼‰
function showInlineMessage(message, type = 'info', duration = 5000, options = {}) {
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
  let container = document.getElementById('message-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'message-container';
    container.className = 'fixed top-4 right-4 z-[10000] space-y-2';
    document.body.appendChild(container);
  }
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
  const messageEl = createMessageElement(message, type, options);
  container.appendChild(messageEl);
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
  requestAnimationFrame(() => {
    messageEl.classList.remove('translate-x-full', 'opacity-0');
    messageEl.classList.add('translate-x-0', 'opacity-100');
  });
  
  // è‡ªå‹•å‰Šé™¤
  if (duration > 0) {
    setTimeout(() => {
      removeMessage(messageEl);
    }, duration);
  }
  
  return messageEl;
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã®ä½œæˆ
function createMessageElement(message, type, options) {
  const colors = {
    success: 'bg-green-600/20 border-green-500/50 text-green-100',
    error: 'bg-red-600/20 border-red-500/50 text-red-100',
    warning: 'bg-yellow-600/20 border-yellow-500/50 text-yellow-100',
    info: 'bg-blue-600/20 border-blue-500/50 text-blue-100'
  };
  
  const icons = {
    success: 'âœ…',
    error: 'âŒ', 
    warning: 'âš ï¸',
    info: 'â„¹ï¸'
  };
  
  const messageEl = document.createElement('div');
  messageEl.className = `message glass-panel rounded-lg p-4 border shadow-lg flex items-center transition-all duration-300 ease-out transform translate-x-full opacity-0 ${colors[type]}`;
  
  messageEl.innerHTML = `
    <div class="mr-3 text-xl">${icons[type]}</div>
    <div class="flex-1 text-sm">${escapeHtml(message)}</div>
    <button class="ml-4 text-gray-400 hover:text-white text-xl leading-none" onclick="this.closest('.message').remove()">âœ•</button>
  `;
  
  return messageEl;
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
function removeMessage(messageEl) {
  messageEl.classList.remove('translate-x-0', 'opacity-100');
  messageEl.classList.add('translate-x-full', 'opacity-0');
  messageEl.addEventListener('transitionend', () => messageEl.remove());
}

// HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ—ç”¨ã®ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function showSetupMessage(message, step, type = 'info') {
  const stepIcon = step ? `ğŸ”¥ Step ${step}:` : 'ğŸ“‹';
  return showMessage(`${stepIcon} ${message}`, type, 6000, { step });
}

// ã‚¨ãƒ©ãƒ¼ç”¨ã®è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function showDetailedError(title, details, suggestions = []) {
  let message = `${title}`;
  if (details) {
    message += `\nè©³ç´°: ${details}`;
  }
  if (suggestions.length > 0) {
    message += `\nå¯¾å‡¦æ³•: ${suggestions.join(', ')}`;
  }
  return showMessage(message, 'error', 8000, { detailed: true });
}

// Use SharedUtilities instead of local debounce
var debounce = window.debounce || function(func, delay, key) {
  window.sharedUtilities.debounce.debounce(func, key || 'default', delay);
};

// =============================================================================
// DOM UTILITY FUNCTIONS - Use SharedUtilities
// =============================================================================

// Backward compatibility functions using SharedUtilities
var dom = window.sharedUtilities.dom;
var createSafeElement = dom.createSafeElement.bind(dom);
var getCachedElement = dom.getCachedElement.bind(dom);
var safeGetElement = getCachedElement;
var setButtonState = dom.setButtonState.bind(dom);
var setSafeTextContent = dom.setSafeTextContent.bind(dom);
var toggleClass = dom.toggleClass.bind(dom);
var addSafeEventListener = dom.addSafeEventListener.bind(dom);
var removeSafeEventListener = dom.removeSafeEventListener.bind(dom);
var clearElementCache = dom.clearElementCache.bind(dom);
var cacheElements = dom.cacheElements.bind(dom);

// =============================================================================
// EVENT HANDLER UTILITIES - Consolidated patterns
// =============================================================================

// Utility for setting up multiple event listeners efficiently
function setupMultipleListeners(elementHandlerMap) {
  Object.keys(elementHandlerMap).forEach(function(elementId) {
    var element = elementId.startsWith('#') ? 
      document.querySelector(elementId) : 
      (elements[elementId] || getCachedElement(elementId));
    
    if (element) {
      var handlers = elementHandlerMap[elementId];
      if (Array.isArray(handlers)) {
        handlers.forEach(function(handler) {
          addSafeEventListener(element, handler.event, handler.callback, handler.options);
        });
      } else {
        addSafeEventListener(element, handlers.event, handlers.callback, handlers.options);
      }
    }
  });
}

// Utility for setting up click handlers with confirmation
function setupConfirmationHandler(elementId, confirmTitle, confirmMessage, callback) {
  var element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', function(e) {
      e.preventDefault();
      showConfirmationModal(
        confirmTitle,
        confirmMessage,
        callback
      );
    });
  }
}

// Utility for setting up handlers with privacy consent
function setupPrivacyHandler(elementId, callback) {
  var element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', function(e) {
      e.preventDefault();
      showPrivacyModal(function() {
        hidePrivacyModal();
        callback();
      });
    });
  }
}

// Utility for delegated event handling (useful for dynamic content)
function setupDelegatedHandler(parentElement, selector, event, callback) {
  if (typeof parentElement === 'string') {
    parentElement = getCachedElement(parentElement);
  }
  
  if (parentElement) {
    addSafeEventListener(parentElement, event, function(e) {
      var target = e.target.closest(selector);
      if (target) {
        callback.call(target, e);
      }
    });
  }
}

// =============================================================================
// PROCESSING CACHE SYSTEM - Prevent Duplicate Executions
// =============================================================================

// ğŸ¯ Processing cache system to prevent duplicate processing
const processingCache = {
  sheetHeaderValidation: new Map(),
  aiColumnDetection: new Map(),
  configNormalization: new Map(),
  urlGeneration: new Map(),
  statusValidation: new Map()
};

// Cache cleanup intervals (in milliseconds)
const CACHE_TTL = {
  sheetHeaderValidation: 60000,    // 1 minute
  aiColumnDetection: 120000,       // 2 minutes  
  configNormalization: 300000,     // 5 minutes
  urlGeneration: 600000,           // 10 minutes
  statusValidation: 60000          // 1 minute
};

/**
 * Execute function with caching to prevent duplicate processing
 * @param {string} cacheType - Type of cache (sheetHeaderValidation, aiColumnDetection, etc.)
 * @param {string} key - Cache key
 * @param {Function} fn - Function to execute
 * @param {number} ttl - Time to live in milliseconds (optional, defaults to cacheType TTL)
 * @returns {*} Cached or fresh result
 */
function executeWithCache(cacheType, key, fn, ttl) {
  const cache = processingCache[cacheType];
  if (!cache) {
    console.warn(`âš ï¸ Unknown cache type: ${cacheType}`);
    return fn(); // Execute without caching
  }
  
  const now = Date.now();
  const cacheEntry = cache.get(key);
  
  // Check if cached result is still valid
  if (cacheEntry && (now - cacheEntry.timestamp) < (ttl || CACHE_TTL[cacheType])) {
    console.log(`âœ… Cache hit for ${cacheType}:${key}`);
    return cacheEntry.result;
  }
  
  // Execute function and cache result
  console.log(`ğŸ”„ Cache miss for ${cacheType}:${key}, executing...`);
  try {
    const result = fn();
    cache.set(key, {
      result: result,
      timestamp: now
    });
    return result;
  } catch (error) {
    console.error(`âŒ Error executing cached function ${cacheType}:${key}:`, error);
    throw error;
  }
}

/**
 * Clear specific cache or all caches
 * @param {string} cacheType - Type of cache to clear (optional, clears all if not specified)
 * @param {string} key - Specific key to clear (optional, clears all keys if not specified)
 */
function clearProcessingCache(cacheType, key) {
  if (cacheType && key) {
    // Clear specific cache entry
    if (processingCache[cacheType]) {
      processingCache[cacheType].delete(key);
      console.log(`ğŸ§¹ Cleared cache entry: ${cacheType}:${key}`);
    }
  } else if (cacheType) {
    // Clear entire cache type
    if (processingCache[cacheType]) {
      processingCache[cacheType].clear();
      console.log(`ğŸ§¹ Cleared cache type: ${cacheType}`);
    }
  } else {
    // Clear all caches
    Object.values(processingCache).forEach(cache => cache.clear());
    console.log('ğŸ§¹ Cleared all processing caches');
  }
}

/**
 * Cache cleanup job - removes expired entries
 */
function cleanupProcessingCache() {
  const now = Date.now();
  
  Object.entries(processingCache).forEach(([cacheType, cache]) => {
    const ttl = CACHE_TTL[cacheType];
    let cleanedCount = 0;
    
    for (const [key, entry] of cache.entries()) {
      if (now - entry.timestamp > ttl) {
        cache.delete(key);
        cleanedCount++;
      }
    }
    
    if (cleanedCount > 0) {
      console.log(`ğŸ§¹ Cleaned ${cleanedCount} expired entries from ${cacheType} cache`);
    }
  });
}

// Schedule cache cleanup every 5 minutes
setInterval(cleanupProcessingCache, 300000);

// =============================================================================
// GLOBAL LOADING OVERLAY MANAGEMENT SYSTEM
// =============================================================================

/**
 * Show global loading overlay using unified loading manager
 * @param {string} operationId - Unique ID for the operation
 * @param {string} message - Loading message to display
 * @param {Object} options - Additional options
 */
function showGlobalLoading(operationId, message = 'å‡¦ç†ä¸­...', options = {}) {
  if (!window.unifiedLoading) {
    console.warn('âš ï¸ unifiedLoading manager not available');
    return;
  }

  const showProgress = options.showProgress !== false && options.progress !== undefined;
  const config = {
    message,
    type: options.type || (showProgress ? 'progress' : 'overlay'),
    disableInteraction: options.disableInteraction !== false
  };
  if (showProgress) {
    config.progress = options.progress;
  }
  window.unifiedLoading.show(config);
}

/**
 * Hide global loading overlay using unified loading manager
 * @param {string} operationId - Operation ID to remove
 * @param {string} finalMessage - Optional final message before hiding
 */
function hideGlobalLoading(operationId, finalMessage) {
  if (!window.unifiedLoading) return;

  if (finalMessage) {
    const config = { ...window.unifiedLoading.currentState, message: finalMessage, type: 'overlay', disableInteraction: true };
    window.unifiedLoading.show(config);
    setTimeout(() => window.unifiedLoading.hide(), 800);
  } else {
    window.unifiedLoading.hide();
  }
}

/**
 * Update loading message on the global overlay
 * @param {string} message - New message to display
 */
function updateLoadingMessage(message) {
  if (window.unifiedLoading && window.unifiedLoading.currentState) {
    const config = { ...window.unifiedLoading.currentState, message };
    window.unifiedLoading.show(config);
  }
}

// =============================================================================
// STATE MANAGEMENT
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å®‰å…¨ãªåˆæœŸåŒ–
var userId = '';

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å®‰å…¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
function initializeUserId() {
  console.group('ğŸ” Initializing UserId');
  logDebug('ğŸ“ About to call getCurrentUserStatus');
  
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(response => {
        logDebug('ğŸ“¥ getCurrentUserStatus response:', response);
        
        if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
          userId = response.userInfo.userId;
          logDebug('âœ… AdminPanel: User authenticated, userId:', userId);
          console.groupEnd();
          resolve(userId);
        } else {
          console.error('âŒ Failed to get userId from backend:', response);
          console.error('âŒ Expected: {status: "success", userInfo: {userId: "..."}}');
          console.groupEnd();
          reject(new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        }
      })
      .withFailureHandler(error => {
        console.error('âŒ Backend error getting userId:', error);
        console.error('âŒ Error type:', typeof error);
        console.error('âŒ Error details:', error);
        console.groupEnd();
        reject(error);
      })
      .getCurrentUserStatus();
  });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ã®å®Œäº†ã‚’å¾…ã¤Promise
const userIdPromise = initializeUserId();
var selectedSheet = '';
var currentActiveSheet = '';
var webAppUrl = '';
var currentSpreadsheetUrl = '';
var currentStatus = null;

// Global variables from adminPanel.js.html
let currentStep = 1;
let selectedSheetId = null;
let selectedFormId = null;
let availableSheets = [];
let availableForms = [];
let currentConfig = null;

// Initialize admin panel
function initializeAdminPanel(incomingUserId) {
  // userId is now managed globally by adminPanel-core.js
  loadUserInfo();
  loadSystemStatus();
  setupEventListeners();
  setupRealtimeUpdates();
  validateCurrentStep();
}

// =============================================================================
// LEGACY UTILITIES (for backward compatibility)
// =============================================================================

// Safe text content setter
function safeSetText(elementId, text) {
  var element = typeof elementId === 'string' ? getCachedElement(elementId) : elementId;
  if (element) {
    setSafeTextContent(element, text || '');
  }
}

// =============================================================================
// LAYOUT AND VIEWPORT UTILITIES
// =============================================================================

// Layout adjustment for responsive design
function adjustLayout() {
  var isMobile = window.innerWidth < 768;
  var body = document.body;
  
  if (isMobile) {
    body.classList.add('mobile-layout');
    body.classList.remove('desktop-layout');
  } else {
    body.classList.add('desktop-layout');
    body.classList.remove('mobile-layout');
  }
}

// AdminPanel no longer overrides global setLoading
// Uses unified loading system with admin-specific configurations


// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize layout on load
// çµ±åˆåˆæœŸåŒ–ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
function initCore() {
  adjustLayout();
}

// å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†
function checkAndExpandAllSections() {
  try {
    const expandAllFlag = localStorage.getItem('expandAllSections');
    if (expandAllFlag === 'true') {
      logInfo('ğŸ“‚ å…¬é–‹åœæ­¢å¾Œã®ãŸã‚å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ã—ã¾ã™');
      
      // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ï¼ˆDOMè¦ç´ ã®æº–å‚™ã‚’å¾…ã¤ï¼‰
      setTimeout(() => {
        const sectionIds = ['step1-content', 'step2-content', 'step3-content'];
        let expandedCount = 0;
        
        sectionIds.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å±•é–‹
            if (section.classList.contains('hidden')) {
              toggleSection(sectionId);
              expandedCount++;
              logDebug(`âœ… ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹: ${sectionId}`);
            }
          }
        });
        
        if (expandedCount > 0) {
          logInfo(`ğŸ“‚ ${expandedCount}å€‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ã—ã¾ã—ãŸ`);
        }
        
        // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
        localStorage.removeItem('expandAllSections');
        logDebug('ğŸ§¹ å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      }, 500);
    }
  } catch (error) {
    logWarn('âš ï¸ å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ  - å˜ä¸€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
// ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ç”¨ã®çŠ¶æ…‹ç®¡ç†
window.systemStatus = {
  initializationStarted: false,
  coreInitialized: false,
  apiInitialized: false,
  uiInitialized: false,
  eventsInitialized: false,
  initializationComplete: false,
  errors: [],
  lastActivity: Date.now()
};

function updateSystemStatus(component, status, error = null) {
  window.systemStatus[component] = status;
  window.systemStatus.lastActivity = Date.now();
  if (error) {
    window.systemStatus.errors.push({ component, error: error.toString(), timestamp: Date.now() });
  }
  logDebug(`ğŸ“Š System Status: ${component} = ${status}`);
}

function initializeAdminPanelMaster() {
  logInfo('ğŸš€ AdminPanel Master Initialization Started');
  updateSystemStatus('initializationStarted', true);
  
  // Phase 1: CoreåˆæœŸåŒ–
  try {
    initCore();
    updateSystemStatus('coreInitialized', true);
  } catch (error) {
    updateSystemStatus('coreInitialized', false, error);
    console.error('âŒ Core initialization failed:', error);
  }
  
  // å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†
  checkAndExpandAllSections();
  
  // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°è¦ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤ºï¼‰
  setTimeout(() => {
    const formJustCreated = sessionStorage.getItem('form_just_created');
    if (formJustCreated !== 'true') {
      // æ–°è¦ä½œæˆã§ã¯ãªã„å ´åˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
      const formUrlSection = document.getElementById('form-url-section');
      if (formUrlSection && !formUrlSection.classList.contains('hidden')) {
        formUrlSection.classList.add('hidden');
        logDebug('ğŸ“‹ æ—¢å­˜ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º');
      }
    }
  }, 100);
  
  // Phase 2: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¸¦åˆ—åˆæœŸåŒ– (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š)
  // é…å»¶ã‚’æœ€å°é™ã«æŠ‘åˆ¶ã—ã¦å³åº§ã«åˆæœŸåŒ–
  setTimeout(() => {
    logDebug('ğŸ”§ Phase 2: ä¸¦åˆ—ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–é–‹å§‹');
    
    // Statusç®¡ç†åˆæœŸåŒ–
    if (typeof initializeMessageArea === 'function') {
      initializeMessageArea();
      logDebug('âœ… Status module initialized');
    }
    
    // APIé€šä¿¡åˆæœŸåŒ–ï¼ˆæœ€é‡è¦ - getInitialDataã‚’å‘¼ã³å‡ºã™ï¼‰
    function initializeAPIWithRetry(attempts = 0) {
      if (typeof initializeAPI === 'function' && typeof runGasWithUserId === 'function') {
        logDebug('ğŸš€ API module initialization starting...');
        try {
          initializeAPI();
          updateSystemStatus('apiInitialized', true);
          logDebug('âœ… API module initialized');
        } catch (error) {
          updateSystemStatus('apiInitialized', false, error);
          console.error('âŒ API initialization failed:', error);
        }
        return;
      } 
      
      if (attempts < 5) { // 10 -> 5ã«çŸ­ç¸®
        logDebug(`â³ APIé–¢æ•°èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­... (è©¦è¡Œ ${attempts + 1}/5)`);
        setTimeout(() => initializeAPIWithRetry(attempts + 1), 200); // 100ms -> 200msã«èª¿æ•´
        return;
      }
      
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
      console.warn('âš ï¸ API functions not available, implementing fallback...');
      const missingFunctions = {
        initializeAPI: typeof initializeAPI,
        runGasWithUserId: typeof runGasWithUserId
      };
      console.error('Missing functions:', missingFunctions);
      updateSystemStatus('apiInitialized', false, new Error(`Missing functions: ${JSON.stringify(missingFunctions)}`));
      
      // ğŸ”§ æ”¹è‰¯ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè£…
      if (typeof runGasWithUserId !== 'function') {
        window.runGasWithUserId = function(functionName, loadingMessage, ...args) {
          console.warn(`ğŸ”„ Fallback: ${functionName} called with message: ${loadingMessage}`);
          
          // ğŸ¯ æ®µéšçš„ã«ãƒªãƒˆãƒ©ã‚¤ã—ã¦å®Ÿéš›ã®APIé–¢æ•°ã‚’å¾…æ©Ÿ
          return new Promise((resolve, reject) => {
            let retryCount = 0;
            const maxRetries = 10;
            
            const checkApiAvailability = () => {
              // SharedUtilitiesãŒèª­ã¿è¾¼ã¾ã‚Œã€å®Ÿéš›ã®runGasWithUserIdé–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
              if (typeof sharedUtilities !== 'undefined' && 
                  sharedUtilities.gas && 
                  typeof sharedUtilities.gas.call === 'function') {
                
                // å®Ÿéš›ã®APIé–¢æ•°ã‚’å‘¼ã³å‡ºã—
                try {
                  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºä»˜ãã§å®Ÿè¡Œ
                  const realCall = loadingMessage && loadingMessage !== false ?
                    sharedUtilities.gas.callWithLoading(functionName, loadingMessage, 'overlay', userId, ...args) :
                    (userId ? 
                      sharedUtilities.gas.call(functionName, userId, ...args) :
                      sharedUtilities.gas.call(functionName, ...args));
                    
                  console.log(`âœ… FallbackæˆåŠŸ: ${functionName}ã®å®Ÿè¡Œã‚’å¾©æ—§`);
                  resolve(realCall);
                } catch (error) {
                  console.error(`âŒ Fallbackå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${functionName}`, error);
                  reject(error);
                }
              } else {
                retryCount++;
                if (retryCount < maxRetries) {
                  setTimeout(checkApiAvailability, 1000);
                } else {
                  reject(new Error(`API function ${functionName} not available after ${maxRetries} retries`));
                }
              }
            };
            
            checkApiAvailability();
          });
        };
        logDebug('ğŸ“¦ Improved fallback runGasWithUserId implemented');
      }
      
      if (typeof initializeAPI !== 'function') {
        window.initializeAPI = function() {
          console.warn('ğŸ”„ Fallback: initializeAPI called');
          logDebug('ğŸ“¦ Fallback API initialization');
        };
        logDebug('ğŸ“¦ Fallback initializeAPI implemented');
      }
      
      updateSystemStatus('apiInitialized', 'fallback');
      logDebug('âœ… API module initialized with fallback');
    }
    
    initializeAPIWithRetry();
    
    // UIåˆæœŸåŒ–
    if (typeof initializeUI === 'function') {
      try {
        initializeUI();
        updateSystemStatus('uiInitialized', true);
        logDebug('âœ… UI module initialized');
      } catch (error) {
        updateSystemStatus('uiInitialized', false, error);
        console.error('âŒ UI initialization failed:', error);
      }
    } else {
      updateSystemStatus('uiInitialized', false, new Error('initializeUI function not found'));
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†åˆæœŸåŒ–
    if (typeof setupCharacterCounters === 'function') {
      setupCharacterCounters();
      logDebug('âœ… Forms module initialized');
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†åˆæœŸåŒ–ï¼ˆæœ€å¾Œã«å®Ÿè¡Œï¼‰
    setTimeout(() => {
      function initializeEventsWithRetry(attempts = 0) {
        // ğŸ”§ æ”¹å–„ã•ã‚ŒãŸã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ãƒã‚§ãƒƒã‚¯ï¼ˆwindowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚ç¢ºèªï¼‰
        const functionsAvailable = {
          initializeEventListeners: typeof initializeEventListeners === 'function' || typeof window.initializeEventListeners === 'function',
          handleQuickStart: typeof handleQuickStart === 'function' || typeof window.handleQuickStart === 'function',
          runHeaderGuessing: typeof runHeaderGuessing === 'function' || typeof window.runHeaderGuessing === 'function'
        };
        
        logDebug('ğŸ” é–¢æ•°å¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯:', functionsAvailable);
        
        if (functionsAvailable.initializeEventListeners && 
            functionsAvailable.handleQuickStart && 
            functionsAvailable.runHeaderGuessing) {
          try {
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰é–¢æ•°ã‚’å–å¾—
            const initEventsFn = typeof initializeEventListeners === 'function' ? initializeEventListeners : window.initializeEventListeners;
            initEventsFn();
            
            updateSystemStatus('eventsInitialized', true);
            updateSystemStatus('initializationComplete', true);
            logDebug('âœ… Events module initialized');
            logInfo('ğŸ‰ AdminPanel Master Initialization Complete');
            
            // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ
            console.log('ğŸ“Š Final System Status:', window.systemStatus);
          } catch (error) {
            updateSystemStatus('eventsInitialized', false, error);
            console.error('âŒ Events initialization failed:', error);
          }
          return;
        } 
        
        if (attempts < 8) { // 5 -> 8ã«å¢—åŠ ï¼ˆã‚ˆã‚Šå¯›å®¹ã«ï¼‰
          logDebug(`â³ ã‚¤ãƒ™ãƒ³ãƒˆé–¢æ•°èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­... (è©¦è¡Œ ${attempts + 1}/8)`);
          setTimeout(() => initializeEventsWithRetry(attempts + 1), 300); // 200ms -> 300msã«èª¿æ•´
          return;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…ï¼ˆã‚ˆã‚Šç¢ºå®Ÿã«ï¼‰
        console.warn('âš ï¸ Event functions not available after 8 attempts, implementing enhanced fallback...');
        const missingEventFunctions = {
          initializeEventListeners: typeof initializeEventListeners,
          handleQuickStart: typeof handleQuickStart,
          runHeaderGuessing: typeof runHeaderGuessing,
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã‚‚ç¢ºèª
          'window.initializeEventListeners': typeof window.initializeEventListeners,
          'window.handleQuickStart': typeof window.handleQuickStart,
          'window.runHeaderGuessing': typeof window.runHeaderGuessing
        };
        console.error('Missing functions detail:', missingEventFunctions);
        updateSystemStatus('eventsInitialized', false, new Error(`Missing event functions: ${JSON.stringify(missingEventFunctions)}`));
        
        // ğŸ”§ å¼·åŒ–ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè£…
        if (!functionsAvailable.handleQuickStart) {
          window.handleQuickStart = function() {
            console.warn('ğŸ”„ Enhanced Fallback: handleQuickStart called');
            if (window.showMessage) {
              window.showMessage('QuickStartæ©Ÿèƒ½ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'warning');
            }
          };
          logDebug('ğŸ“¦ Enhanced Fallback handleQuickStart implemented');
        }
        
        if (!functionsAvailable.runHeaderGuessing) {
          window.runHeaderGuessing = function() {
            console.warn('ğŸ”„ Enhanced Fallback: runHeaderGuessing called');
            if (window.showMessage) {
              window.showMessage('AIåˆ¤å®šæ©Ÿèƒ½ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'warning');
            }
          };
          logDebug('ğŸ“¦ Enhanced Fallback runHeaderGuessing implemented');
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯åˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿åˆæœŸåŒ–
        if (functionsAvailable.initializeEventListeners) {
          try {
            const initEventsFn = typeof initializeEventListeners === 'function' ? initializeEventListeners : window.initializeEventListeners;
            initEventsFn();
            updateSystemStatus('eventsInitialized', 'partial');
            logDebug('âœ… Events module initialized (partial)');
          } catch (error) {
            updateSystemStatus('eventsInitialized', false, error);
            console.error('âŒ Partial events initialization failed:', error);
          }
        } else {
          logDebug('ğŸ“¦ Events module skipped (function not available)');
        }
        
        updateSystemStatus('initializationComplete', 'fallback');
        logInfo('âš ï¸ AdminPanel Master Initialization Complete (with enhanced fallback functions)');
        
        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç‰ˆï¼‰
        console.log('ğŸ“Š Final System Status (Enhanced Fallback):', window.systemStatus);
      }
      
      initializeEventsWithRetry();
    }, 150); // 100ms -> 150msã«èª¿æ•´ï¼ˆã‚ˆã‚Šä½™è£•ã‚’æŒã£ã¦ï¼‰
    
  }, 10); // 50ms -> 10msã«çŸ­ç¸®
}

// =============================================================================
// å®‰å…¨ãªé–¢æ•°å‘¼ã³å‡ºã—ã‚·ã‚¹ãƒ†ãƒ  - ã‚¨ãƒ©ãƒ¼é˜²æ­¢ã®ãŸã‚ã®ä¸­æ ¸æ©Ÿèƒ½
// =============================================================================

// é–¢æ•°å­˜åœ¨ãƒã‚§ãƒƒã‚¯ä»˜ãå®‰å…¨å‘¼ã³å‡ºã—
function safeCall(functionName, ...args) {
  // Validate function name
  if (!functionName || typeof functionName !== 'string') {
    logError('safeCall: Invalid function name:', functionName);
    return null;
  }

  if (typeof window[functionName] === 'function') {
    try {
      logDebug(`Calling function: ${functionName}`);
      return window[functionName](...args);
    } catch (error) {
      logError(`Error calling ${functionName}:`, error);
      
      // é–¢æ•°å­˜åœ¨æ™‚ã®ã‚¨ãƒ©ãƒ¼çµ±è¨ˆã‚’è¨˜éŒ²
      if (!window.adminPanelErrorStats) {
        window.adminPanelErrorStats = {};
      }
      window.adminPanelErrorStats[functionName] = (window.adminPanelErrorStats[functionName] || 0) + 1;
      
      return null;
    }
  } else {
    logWarn(`Function ${functionName} is not defined, deferring call`);
    // é…å»¶å®Ÿè¡Œã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
    deferredCalls.push({ functionName, args, timestamp: Date.now() });
    return null;
  }
}

// é…å»¶å®Ÿè¡Œã‚­ãƒ¥ãƒ¼
const deferredCalls = [];

// é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
function waitForFunction(functionName, maxRetries = 100, interval = 200) {
  return new Promise((resolve, reject) => {
    let retries = 0;
    
    function check() {
      if (typeof window[functionName] === 'function') {
        resolve(window[functionName]);
      } else if (retries < maxRetries) {
        retries++;
        setTimeout(check, interval);
      } else {
        reject(new Error(`Function ${functionName} not found after ${maxRetries * interval}ms`));
      }
    }
    
    check();
  });
}

// é…å»¶å®Ÿè¡Œã‚­ãƒ¥ãƒ¼ã®å‡¦ç†
function processDeferredCalls() {
  const currentTime = Date.now();
  const processedCalls = [];
  
  deferredCalls.forEach((call, index) => {
    // 5ç§’ä»¥ä¸Šå¤ã„å‘¼ã³å‡ºã—ã¯ç ´æ£„
    if (currentTime - call.timestamp > 5000) {
      console.warn(`Discarding old deferred call: ${call.functionName}`);
      processedCalls.push(index);
      return;
    }
    
    // é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸã‚‰å®Ÿè¡Œ
    if (typeof window[call.functionName] === 'function') {
      try {
        console.log(`Executing deferred call: ${call.functionName}`);
        window[call.functionName](...call.args);
        processedCalls.push(index);
      } catch (error) {
        console.error(`Error executing deferred call ${call.functionName}:`, error);
        processedCalls.push(index);
      }
    }
  });
  
  // å‡¦ç†æ¸ˆã¿ã®å‘¼ã³å‡ºã—ã‚’å‰Šé™¤ï¼ˆé€†é †ã§å‰Šé™¤ï¼‰
  processedCalls.reverse().forEach(index => {
    deferredCalls.splice(index, 1);
  });
}

// å®šæœŸçš„ã«é…å»¶å®Ÿè¡Œã‚­ãƒ¥ãƒ¼ã‚’å‡¦ç†
const deferredCallsProcessor = setInterval(() => {
  if (deferredCalls.length > 0) {
    processDeferredCalls();
  }
  
  // 5åˆ†çµŒã£ãŸã‚‰å®šæœŸå®Ÿè¡Œã‚’åœæ­¢
  if (Date.now() - window.adminPanelStartTime > 300000) {
    clearInterval(deferredCallsProcessor);
  }
}, 300);

// åˆæœŸåŒ–å®Œäº†ãƒ•ãƒ©ã‚°ã¨ãƒã‚§ãƒƒã‚«ãƒ¼
window.adminPanelStartTime = Date.now();
window.coreInitialized = false;
window.uiInitialized = false;
window.apiInitialized = false;

// åˆæœŸåŒ–çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
function checkInitializationComplete() {
  const requiredFunctions = [
    'updateUIWithNewStatus',
    'navigateToStep', 
    'showFormConfigModal',
    'hideFormConfigModal',
    'toggleSection',
    'runGasWithUserId'
  ];
  
  const missingFunctions = requiredFunctions.filter(func => 
    typeof window[func] !== 'function'
  );
  
  if (missingFunctions.length === 0) {
    console.log('âœ… All critical functions are available');
    processDeferredCalls(); // æœ€çµ‚çš„ãªé…å»¶å®Ÿè¡Œå‡¦ç†
    return true;
  } else {
    console.log('âš ï¸ Missing functions:', missingFunctions);
    return false;
  }
}

// è¤‡æ•°ã®é–¢æ•°ã‚’å¾…æ©Ÿï¼ˆæ—¢å­˜ã®waitForFunctioné–¢æ•°ã‚’ä½¿ç”¨ï¼‰
function waitForFunctions(funcNames, maxRetries = 50, interval = 100) {
  return Promise.all(
    funcNames.map(funcName => waitForFunction(funcName, maxRetries, interval))
  );
}

// ç°¡ç´ åŒ–ã•ã‚ŒãŸåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ 
function safeInitializeAdminPanelMaster() {
  try {
    console.log('ğŸš€ Starting simplified admin panel initialization...');
    
    // CoreåˆæœŸåŒ–ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    window.coreInitialized = true;
    
    // ã‚³ã‚¢æ©Ÿèƒ½ã®åˆæœŸåŒ–
    if (typeof initCore === 'function') {
      initCore();
    }
    
    // ãƒ¡ã‚¤ãƒ³ã®åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
    if (typeof initializeAdminPanelMaster === 'function') {
      initializeAdminPanelMaster();
    }
    
    // ç°¡å˜ãªåˆæœŸåŒ–å®Œäº†ãƒã‚§ãƒƒã‚¯ï¼ˆ2ç§’å¾Œï¼‰
    setTimeout(() => {
      const missingFunctions = ['updateUIWithNewStatus', 'navigateToStep', 'showFormConfigModal', 'hideFormConfigModal', 'toggleSection']
        .filter(func => typeof window[func] !== 'function');
      
      if (missingFunctions.length === 0) {
        console.log('âœ… All critical functions are available');
      } else {
        console.warn('âš ï¸ Some functions still missing (using stubs):', missingFunctions);
      }
    }, 2000);
    
    console.log('âœ… Simplified initialization completed');
    
  } catch (error) {
    console.error('âŒ Error during initialization:', error);
    
    // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ©ãƒ¼å›å¾©
    setTimeout(() => {
      console.log('ğŸ”„ Attempting recovery...');
      if (typeof initializeAdminPanelMaster === 'function') {
        initializeAdminPanelMaster();
      }
    }, 2000);
  }
}

// å˜ä¸€DOMContentLoadedãƒãƒ³ãƒ‰ãƒ©ãƒ¼ - ã‚¨ãƒ©ãƒ¼é˜²æ­¢ç‰ˆ
if (document.readyState !== 'loading') {
  safeInitializeAdminPanelMaster();
} else {
  document.addEventListener('DOMContentLoaded', safeInitializeAdminPanelMaster);
}

// Update layout on resize
window.addEventListener('resize', debounce(adjustLayout, 250, 'layout-resize'));
</script>
