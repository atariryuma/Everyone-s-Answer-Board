<script>
// =============================================================================
// ADMIN PANEL CORE UTILITIES & DOM OPERATIONS
// =============================================================================

// =============================================================================
// LOGGING UTILITIES - Standardized logging with levels
// =============================================================================

// Simple logging utility with conditional output based on DEBUG mode
const DEBUG_MODE = window.DEBUG_MODE || false;

function adminLog(level, ...args) {
  if (!DEBUG_MODE) return;
  
  switch (level) {
    case 'error':
      console.error('[AdminPanel]', ...args);
      break;
    case 'warn':
      console.warn('[AdminPanel]', ...args);
      break;
    case 'info':
      console.log('[AdminPanel]', ...args);
      break;
    case 'debug':
      if (DEBUG_MODE) console.log('[AdminPanel:DEBUG]', ...args);
      break;
    default:
      console.log('[AdminPanel]', ...args);
  }
}

// Convenience functions for different log levels
function logError(...args) { adminLog('error', ...args); }
function logWarn(...args) { adminLog('warn', ...args); }
function logInfo(...args) { adminLog('info', ...args); }
function logDebug(...args) { adminLog('debug', ...args); }

// =============================================================================
// ENHANCED MESSAGE SYSTEM FOR SETUP FLOW
// =============================================================================

// å¼·åŒ–ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ 
function showMessage(message, type = 'info', duration = 5000, options = {}) {
  // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if (window.sharedUtilities && window.sharedUtilities.showMessage) {
    return window.sharedUtilities.showMessage(message, type, duration, options);
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè£…
  return showInlineMessage(message, type, duration, options);
}

// ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…ï¼‰
function showInlineMessage(message, type = 'info', duration = 5000, options = {}) {
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
  let container = document.getElementById('message-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'message-container';
    container.className = 'fixed top-4 right-4 z-[10000] space-y-2';
    document.body.appendChild(container);
  }
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
  const messageEl = createMessageElement(message, type, options);
  container.appendChild(messageEl);
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
  requestAnimationFrame(() => {
    messageEl.classList.remove('translate-x-full', 'opacity-0');
    messageEl.classList.add('translate-x-0', 'opacity-100');
  });
  
  // è‡ªå‹•å‰Šé™¤
  if (duration > 0) {
    setTimeout(() => {
      removeMessage(messageEl);
    }, duration);
  }
  
  return messageEl;
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã®ä½œæˆ
function createMessageElement(message, type, options) {
  const colors = {
    success: 'bg-green-600/20 border-green-500/50 text-green-100',
    error: 'bg-red-600/20 border-red-500/50 text-red-100',
    warning: 'bg-yellow-600/20 border-yellow-500/50 text-yellow-100',
    info: 'bg-blue-600/20 border-blue-500/50 text-blue-100'
  };
  
  const icons = {
    success: 'âœ…',
    error: 'âŒ', 
    warning: 'âš ï¸',
    info: 'â„¹ï¸'
  };
  
  const messageEl = document.createElement('div');
  messageEl.className = `message glass-panel rounded-lg p-4 border shadow-lg flex items-center transition-all duration-300 ease-out transform translate-x-full opacity-0 ${colors[type]}`;
  
  messageEl.innerHTML = `
    <div class="mr-3 text-xl">${icons[type]}</div>
    <div class="flex-1 text-sm">${escapeHtml(message)}</div>
    <button class="ml-4 text-gray-400 hover:text-white text-xl leading-none" onclick="this.closest('.message').remove()">âœ•</button>
  `;
  
  return messageEl;
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
function removeMessage(messageEl) {
  messageEl.classList.remove('translate-x-0', 'opacity-100');
  messageEl.classList.add('translate-x-full', 'opacity-0');
  messageEl.addEventListener('transitionend', () => messageEl.remove());
}

// HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ—ç”¨ã®ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function showSetupMessage(message, step, type = 'info') {
  const stepIcon = step ? `ğŸ”¥ Step ${step}:` : 'ğŸ“‹';
  return showMessage(`${stepIcon} ${message}`, type, 6000, { step });
}

// ã‚¨ãƒ©ãƒ¼ç”¨ã®è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function showDetailedError(title, details, suggestions = []) {
  let message = `${title}`;
  if (details) {
    message += `\nè©³ç´°: ${details}`;
  }
  if (suggestions.length > 0) {
    message += `\nå¯¾å‡¦æ³•: ${suggestions.join(', ')}`;
  }
  return showMessage(message, 'error', 8000, { detailed: true });
}

// =============================================================================
// UNIFIED MANAGEMENT SYSTEM API - çµ±ä¸€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ API
// =============================================================================

/**
 * çµ±ä¸€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - å…¨ç®¡ç†ã‚¯ãƒ©ã‚¹ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 */
window.unifiedManagement = {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç† (CacheManager)
  cache: {
    get: (key, valueFn, options) => typeof cacheManager !== 'undefined' ? cacheManager.get(key, valueFn, options) : (valueFn ? valueFn() : null),
    remove: (key) => typeof cacheManager !== 'undefined' ? cacheManager.remove(key) : null,
    clearAll: () => typeof cacheManager !== 'undefined' ? cacheManager.clearAll() : null,
    clearFrontend: (options) => typeof cacheManager !== 'undefined' ? cacheManager.clearAllFrontendCaches(options) : Promise.resolve({ success: false }),
    clearSpecific: (type) => typeof cacheManager !== 'undefined' ? cacheManager.clearSpecificCache(type) : Promise.resolve({ success: false }),
    diagnose: () => typeof cacheManager !== 'undefined' ? cacheManager.diagnoseFrontendCache() : { available: false },
    getHealth: () => typeof cacheManager !== 'undefined' ? cacheManager.getHealth() : { status: 'unavailable' }
  },

  // ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡ (TimingManager)
  timing: {
    delay: (ms, id) => typeof TimingManager !== 'undefined' ? TimingManager.delay(ms, id) : new Promise(resolve => setTimeout(resolve, ms)),
    sequence: (operations, intervalMs, sequenceId) => typeof TimingManager !== 'undefined' ? TimingManager.sequence(operations, intervalMs, sequenceId) : Promise.resolve([]),
    parallel: (operations, concurrency) => typeof TimingManager !== 'undefined' ? TimingManager.parallel(operations, concurrency) : Promise.all(operations.map(op => op())),
    progressSequence: (steps, onProgress, stepDelay) => typeof TimingManager !== 'undefined' ? TimingManager.progressSequence(steps, onProgress, stepDelay) : Promise.resolve([]),
    debounce: (func, key, delay) => typeof TimingManager !== 'undefined' ? TimingManager.debounce(func, key, delay) : func,
    throttle: (func, key, delay) => typeof TimingManager !== 'undefined' ? TimingManager.throttle(func, key, delay) : func,
    clearTiming: (key) => typeof TimingManager !== 'undefined' ? TimingManager.clearTiming(key) : null,
    clearAllTiming: () => typeof TimingManager !== 'undefined' ? TimingManager.clearAllTiming() : null
  },

  // ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œåˆ¶å¾¡ (FlowExecutionManager)
  flow: {
    execute: (flowId, operation, options) => typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.executeWithLock(flowId, operation, options) : operation(),
    executeWithLoading: (flowId, operation, options) => typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.executeWithLoadingSync(flowId, operation, options) : operation(),
    cancel: (flowId) => typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.cancelFlow(flowId) : null,
    cancelAll: () => typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.cancelAllFlows() : null,
    diagnose: () => typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.diagnoseExecution() : { activeFlows: [], pendingOperations: 0 }
  },

  // UIç®¡ç† (UnifiedLoadingManager)
  ui: {
    showLoading: (message, options) => window.unifiedLoading?.showSimple(message, options),
    showProgress: (message, step, percentage) => window.unifiedLoading?.showAdminProgress(message, step, percentage),
    hideLoading: () => window.unifiedLoading?.hide(),
    setLoading: (isLoading, message, step, percentage) => window.setLoading(isLoading, message, step, percentage)
  },

  // ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­
  diagnose: () => ({
    cache: typeof cacheManager !== 'undefined' ? cacheManager.diagnoseFrontendCache() : { available: false },
    flow: typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.diagnoseExecution() : { activeFlows: [], pendingOperations: 0 },
    timing: {
      activeTimers: typeof timingManager !== 'undefined' ? timingManager.activeTimers.size : 0,
      debounceTimers: typeof timingManager !== 'undefined' ? (timingManager.debounceTimers?.size || 0) : 0,
      throttleTimers: typeof timingManager !== 'undefined' ? (timingManager.throttleTimers?.size || 0) : 0
    },
    timestamp: Date.now()
  })
};

// ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›æ€§ã®ãŸã‚ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
var debounce = function(func, delay, key) {
  if (typeof TimingManager !== 'undefined') {
    return TimingManager.debounce(func, key || 'default', delay);
  } else if (window.sharedUtilities && window.sharedUtilities.debounce) {
    window.sharedUtilities.debounce.debounce(func, key || 'default', delay);
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
    let timeouts = window._debounceTimeouts || (window._debounceTimeouts = {});
    return function(...args) {
      const timeoutKey = key || 'default';
      clearTimeout(timeouts[timeoutKey]);
      timeouts[timeoutKey] = setTimeout(() => func.apply(this, args), delay);
    };
  }
};

// =============================================================================
// DOM UTILITY FUNCTIONS - Use SharedUtilities
// =============================================================================

// Backward compatibility functions using SharedUtilities
var dom = window.sharedUtilities.dom;
var createSafeElement = dom.createSafeElement.bind(dom);
var getCachedElement = dom.getCachedElement.bind(dom);
var safeGetElement = getCachedElement;
var setButtonState = dom.setButtonState.bind(dom);
var setSafeTextContent = dom.setSafeTextContent.bind(dom);
var toggleClass = dom.toggleClass.bind(dom);
var addSafeEventListener = dom.addSafeEventListener.bind(dom);
var removeSafeEventListener = dom.removeSafeEventListener.bind(dom);
var clearElementCache = dom.clearElementCache.bind(dom);
var cacheElements = dom.cacheElements.bind(dom);

// =============================================================================
// EVENT HANDLER UTILITIES - Consolidated patterns
// =============================================================================

// Utility for setting up multiple event listeners efficiently
function setupMultipleListeners(elementHandlerMap) {
  Object.keys(elementHandlerMap).forEach(function(elementId) {
    var element = elementId.startsWith('#') ? 
      document.querySelector(elementId) : 
      (elements[elementId] || getCachedElement(elementId));
    
    if (element) {
      var handlers = elementHandlerMap[elementId];
      if (Array.isArray(handlers)) {
        handlers.forEach(function(handler) {
          addSafeEventListener(element, handler.event, handler.callback, handler.options);
        });
      } else {
        addSafeEventListener(element, handlers.event, handlers.callback, handlers.options);
      }
    }
  });
}

// Utility for setting up click handlers with confirmation
function setupConfirmationHandler(elementId, confirmTitle, confirmMessage, callback) {
  var element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', function(e) {
      e.preventDefault();
      showConfirmationModal(
        confirmTitle,
        confirmMessage,
        callback
      );
    });
  }
}

// Utility for setting up handlers with privacy consent
function setupPrivacyHandler(elementId, callback) {
  var element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', function(e) {
      e.preventDefault();
      showPrivacyModal(function() {
        hidePrivacyModal();
        callback();
      });
    });
  }
}

// Utility for delegated event handling (useful for dynamic content)
function setupDelegatedHandler(parentElement, selector, event, callback) {
  if (typeof parentElement === 'string') {
    parentElement = getCachedElement(parentElement);
  }
  
  if (parentElement) {
    addSafeEventListener(parentElement, event, function(e) {
      var target = e.target.closest(selector);
      if (target) {
        callback.call(target, e);
      }
    });
  }
}

// =============================================================================
// STATE MANAGEMENT
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å®‰å…¨ãªåˆæœŸåŒ–
var userId = '';

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å®‰å…¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
function initializeUserId() {
  console.group('ğŸ” Initializing UserId');
  logDebug('ğŸ“ About to call getCurrentUserStatus');
  
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(response => {
        logDebug('ğŸ“¥ getCurrentUserStatus response:', response);
        
        if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
          userId = response.userInfo.userId;
          logDebug('âœ… AdminPanel: User authenticated, userId:', userId);
          console.groupEnd();
          resolve(userId);
        } else {
          console.error('âŒ Failed to get userId from backend:', response);
          console.error('âŒ Expected: {status: "success", userInfo: {userId: "..."}}');
          console.groupEnd();
          reject(new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        }
      })
      .withFailureHandler(error => {
        console.error('âŒ Backend error getting userId:', error);
        console.error('âŒ Error type:', typeof error);
        console.error('âŒ Error details:', error);
        console.groupEnd();
        reject(error);
      })
      .getCurrentUserStatus();
  });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ã®å®Œäº†ã‚’å¾…ã¤Promise
const userIdPromise = initializeUserId();
var selectedSheet = '';
var currentActiveSheet = '';
var webAppUrl = '';
var currentSpreadsheetUrl = '';
var currentStatus = null;

// Global variables from adminPanel.js.html
let currentStep = 1;
let selectedSheetId = null;
let selectedFormId = null;
let availableSheets = [];
let availableForms = [];
let currentConfig = null;

// Initialize admin panel
function initializeAdminPanel(incomingUserId) {
  // userId is now managed globally by adminPanel-core.js
  loadUserInfo();
  loadSystemStatus();
  setupEventListeners();
  setupRealtimeUpdates();
  validateCurrentStep();
}

// =============================================================================
// LEGACY UTILITIES (for backward compatibility)
// =============================================================================

// Safe text content setter
function safeSetText(elementId, text) {
  var element = typeof elementId === 'string' ? getCachedElement(elementId) : elementId;
  if (element) {
    setSafeTextContent(element, text || '');
  }
}

// =============================================================================
// LAYOUT AND VIEWPORT UTILITIES
// =============================================================================

// Layout adjustment for responsive design
function adjustLayout() {
  var isMobile = window.innerWidth < 768;
  var body = document.body;
  
  if (isMobile) {
    body.classList.add('mobile-layout');
    body.classList.remove('desktop-layout');
  } else {
    body.classList.add('desktop-layout');
    body.classList.remove('mobile-layout');
  }
}

// AdminPanel no longer overrides global setLoading
// Uses unified loading system with admin-specific configurations


// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize layout on load
// çµ±åˆåˆæœŸåŒ–ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
function initCore() {
  adjustLayout();
}

// å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†
function checkAndExpandAllSections() {
  try {
    const expandAllFlag = localStorage.getItem('expandAllSections');
    if (expandAllFlag === 'true') {
      logInfo('ğŸ“‚ å…¬é–‹åœæ­¢å¾Œã®ãŸã‚å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ã—ã¾ã™');
      
      // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ï¼ˆDOMè¦ç´ ã®æº–å‚™ã‚’å¾…ã¤ï¼‰
      setTimeout(() => {
        const sectionIds = ['step1-content', 'step2-content', 'step3-content'];
        let expandedCount = 0;
        
        sectionIds.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å±•é–‹
            if (section.classList.contains('hidden')) {
              toggleSection(sectionId);
              expandedCount++;
              logDebug(`âœ… ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹: ${sectionId}`);
            }
          }
        });
        
        if (expandedCount > 0) {
          logInfo(`ğŸ“‚ ${expandedCount}å€‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ã—ã¾ã—ãŸ`);
        }
        
        // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
        localStorage.removeItem('expandAllSections');
        logDebug('ğŸ§¹ å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      }, 500);
    }
  } catch (error) {
    logWarn('âš ï¸ å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ  - å˜ä¸€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
// ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ç”¨ã®çŠ¶æ…‹ç®¡ç†
window.systemStatus = {
  initializationStarted: false,
  coreInitialized: false,
  apiInitialized: false,
  uiInitialized: false,
  eventsInitialized: false,
  initializationComplete: false,
  userDataSyncComplete: false,
  errors: [],
  lastActivity: Date.now()
};

// åˆæœŸåŒ–ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œé˜²æ­¢
document.body.style.pointerEvents = 'none';
console.log('ğŸ›¡ï¸ User interaction disabled during initialization');

// ä¸»è¦ãªUIè¦ç´ ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹é–¢æ•°
function disableUserInteraction() {
  // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ç„¡åŠ¹åŒ–
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(element => {
    element.disabled = true;
    element.style.opacity = '0.6';
  });
  
  // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¦ç´ ã®ç„¡åŠ¹åŒ–
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(element => {
    element.style.pointerEvents = 'none';
    element.style.opacity = '0.6';
  });
  
  console.log('ğŸ›¡ï¸ All interactive elements disabled');
}

// UIè¦ç´ ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹é–¢æ•°
function enableUserInteraction() {
  // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®æœ‰åŠ¹åŒ–
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(element => {
    element.disabled = false;
    element.style.opacity = '';
  });
  
  // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¦ç´ ã®æœ‰åŠ¹åŒ–
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(element => {
    element.style.pointerEvents = '';
    element.style.opacity = '';
  });
  
  // bodyè¦ç´ ã‚‚æœ‰åŠ¹åŒ–
  document.body.style.pointerEvents = 'auto';
  
  console.log('âœ… All interactive elements enabled');
}

// DOMèª­ã¿è¾¼ã¿å¾Œã«è¦ç´ ã‚’ç„¡åŠ¹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', disableUserInteraction);
} else {
  disableUserInteraction();
}

function updateSystemStatus(component, status, error = null) {
  window.systemStatus[component] = status;
  window.systemStatus.lastActivity = Date.now();
  if (error) {
    window.systemStatus.errors.push({ component, error: error.toString(), timestamp: Date.now() });
  }
  logDebug(`ğŸ“Š System Status: ${component} = ${status}`);
}

function initializeAdminPanelMaster() {
  logInfo('ğŸš€ AdminPanel Master Initialization Started');
  updateSystemStatus('initializationStarted', true);
  
  // Phase 1: CoreåˆæœŸåŒ–
  try {
    initCore();
    updateSystemStatus('coreInitialized', true);
  } catch (error) {
    updateSystemStatus('coreInitialized', false, error);
    console.error('âŒ Core initialization failed:', error);
  }
  
  // å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†
  checkAndExpandAllSections();
  
  // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°è¦ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤ºï¼‰
  setTimeout(() => {
    const formJustCreated = sessionStorage.getItem('form_just_created');
    if (formJustCreated !== 'true') {
      // æ–°è¦ä½œæˆã§ã¯ãªã„å ´åˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
      const formUrlSection = document.getElementById('form-url-section');
      if (formUrlSection && !formUrlSection.classList.contains('hidden')) {
        formUrlSection.classList.add('hidden');
        logDebug('ğŸ“‹ æ—¢å­˜ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º');
      }
    }
  }, 100);
  
  // Phase 2: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¸¦åˆ—åˆæœŸåŒ– (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š)
  // é…å»¶ã‚’æœ€å°é™ã«æŠ‘åˆ¶ã—ã¦å³åº§ã«åˆæœŸåŒ–
  setTimeout(() => {
    logDebug('ğŸ”§ Phase 2: ä¸¦åˆ—ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–é–‹å§‹');
    
    // Statusç®¡ç†åˆæœŸåŒ–
    if (typeof initializeMessageArea === 'function') {
      initializeMessageArea();
      logDebug('âœ… Status module initialized');
    }
    
    // APIé€šä¿¡åˆæœŸåŒ–ï¼ˆæœ€é‡è¦ - getInitialDataã‚’å‘¼ã³å‡ºã™ï¼‰
    function initializeAPIWithRetry(attempts = 0) {
      if (typeof initializeAPI === 'function' && typeof runGasWithUserId === 'function') {
        logDebug('ğŸš€ API module initialization starting...');
        try {
          initializeAPI();
          updateSystemStatus('apiInitialized', true);
          logDebug('âœ… API module initialized');
        } catch (error) {
          updateSystemStatus('apiInitialized', false, error);
          console.error('âŒ API initialization failed:', error);
        }
        return;
      } 
      
      if (attempts < 5) { // 10 -> 5ã«çŸ­ç¸®
        logDebug(`â³ APIé–¢æ•°èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­... (è©¦è¡Œ ${attempts + 1}/5)`);
        setTimeout(() => initializeAPIWithRetry(attempts + 1), 200); // 100ms -> 200msã«èª¿æ•´
        return;
      }
      
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
      console.warn('âš ï¸ API functions not available, implementing fallback...');
      const missingFunctions = {
        initializeAPI: typeof initializeAPI,
        runGasWithUserId: typeof runGasWithUserId
      };
      console.error('Missing functions:', missingFunctions);
      updateSystemStatus('apiInitialized', false, new Error(`Missing functions: ${JSON.stringify(missingFunctions)}`));
      
      // åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè£…
      if (typeof runGasWithUserId !== 'function') {
        window.runGasWithUserId = function(functionName, loadingMessage, ...args) {
          console.warn(`ğŸ”„ Fallback: ${functionName} called with message: ${loadingMessage}`);
          return Promise.reject(new Error(`API function ${functionName} not available - system initializing`));
        };
        logDebug('ğŸ“¦ Fallback runGasWithUserId implemented');
      }
      
      if (typeof initializeAPI !== 'function') {
        window.initializeAPI = function() {
          console.warn('ğŸ”„ Fallback: initializeAPI called');
          logDebug('ğŸ“¦ Fallback API initialization');
        };
        logDebug('ğŸ“¦ Fallback initializeAPI implemented');
      }
      
      updateSystemStatus('apiInitialized', 'fallback');
      logDebug('âœ… API module initialized with fallback');
    }
    
    initializeAPIWithRetry();
    
    // UIåˆæœŸåŒ–
    if (typeof initializeUI === 'function') {
      try {
        initializeUI();
        updateSystemStatus('uiInitialized', true);
        logDebug('âœ… UI module initialized');
      } catch (error) {
        updateSystemStatus('uiInitialized', false, error);
        console.error('âŒ UI initialization failed:', error);
      }
    } else {
      updateSystemStatus('uiInitialized', false, new Error('initializeUI function not found'));
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†åˆæœŸåŒ–
    if (typeof setupCharacterCounters === 'function') {
      setupCharacterCounters();
      logDebug('âœ… Forms module initialized');
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†åˆæœŸåŒ–ï¼ˆæœ€å¾Œã«å®Ÿè¡Œï¼‰
    setTimeout(() => {
      function initializeEventsWithRetry(attempts = 0) {
        if (typeof initializeEventListeners === 'function' && 
            typeof handleQuickStart === 'function' && 
            typeof runHeaderGuessing === 'function') {
          try {
            initializeEventListeners();
            updateSystemStatus('eventsInitialized', true);
            updateSystemStatus('initializationComplete', true);
            logDebug('âœ… Events module initialized');
            logInfo('ğŸ‰ AdminPanel Master Initialization Complete');
            
            // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ
            console.log('ğŸ“Š Final System Status:', window.systemStatus);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ç¢ºå®ŸãªåŒæœŸå®Œäº†å¾Œã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤
            setTimeout(async () => {
              try {
                console.log('ğŸ”„ Final user data synchronization...');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æœ€çµ‚åŒæœŸã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
                if (typeof loadStatus === 'function') {
                  await loadStatus(true);
                  console.log('âœ… User data synchronization completed');
                } else {
                  console.warn('âš ï¸ loadStatus function not available');
                }
                
                // ã™ã¹ã¦ã®åŒæœŸãŒå®Œäº†ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
                if (window.unifiedLoading) {
                  window.unifiedLoading.hide();
                  console.log('âœ… Global loading overlay hidden after full sync');
                } else {
                  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥DOMæ“ä½œ
                  const overlay = document.getElementById('loading-overlay');
                  if (overlay) {
                    overlay.classList.add('hidden');
                    console.log('âœ… Loading overlay hidden (fallback)');
                  }
                }
                
                // UIè¦ç´ ã®æœ‰åŠ¹åŒ–
                enableUserInteraction();
                updateSystemStatus('userDataSyncComplete', true);
                
              } catch (error) {
                console.error('âŒ Final sync error:', error);
                // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è§£é™¤
                if (window.unifiedLoading) {
                  window.unifiedLoading.hide();
                }
              }
            }, 800);
          } catch (error) {
            updateSystemStatus('eventsInitialized', false, error);
            console.error('âŒ Events initialization failed:', error);
          }
          return;
        } 
        
        if (attempts < 5) { // 10 -> 5ã«çŸ­ç¸®
          logDebug(`â³ ã‚¤ãƒ™ãƒ³ãƒˆé–¢æ•°èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­... (è©¦è¡Œ ${attempts + 1}/5)`);
          setTimeout(() => initializeEventsWithRetry(attempts + 1), 200);
          return;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
        console.warn('âš ï¸ Event functions not available, implementing fallback...');
        const missingEventFunctions = {
          initializeEventListeners: typeof initializeEventListeners,
          handleQuickStart: typeof handleQuickStart,
          runHeaderGuessing: typeof runHeaderGuessing
        };
        console.error('Missing functions:', missingEventFunctions);
        updateSystemStatus('eventsInitialized', false, new Error(`Missing event functions: ${JSON.stringify(missingEventFunctions)}`));
        
        // åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè£…
        if (typeof handleQuickStart !== 'function') {
          window.handleQuickStart = function() {
            console.warn('ğŸ”„ Fallback: handleQuickStart called');
            window.showMessage && window.showMessage('QuickStartæ©Ÿèƒ½ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'warning');
          };
          logDebug('ğŸ“¦ Fallback handleQuickStart implemented');
        }
        
        if (typeof runHeaderGuessing !== 'function') {
          window.runHeaderGuessing = function() {
            console.warn('ğŸ”„ Fallback: runHeaderGuessing called');
            window.showMessage && window.showMessage('AIåˆ¤å®šæ©Ÿèƒ½ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'warning');
          };
          logDebug('ğŸ“¦ Fallback runHeaderGuessing implemented');
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯åˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿åˆæœŸåŒ–
        if (typeof initializeEventListeners === 'function') {
          try {
            initializeEventListeners();
            updateSystemStatus('eventsInitialized', 'partial');
            logDebug('âœ… Events module initialized (partial)');
          } catch (error) {
            updateSystemStatus('eventsInitialized', false, error);
            console.error('âŒ Partial events initialization failed:', error);
          }
        } else {
          logDebug('ğŸ“¦ Events module skipped (function not available)');
        }
        
        updateSystemStatus('initializationComplete', 'fallback');
        logInfo('âš ï¸ AdminPanel Master Initialization Complete (with fallback functions)');
        
        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç‰ˆï¼‰
        console.log('ğŸ“Š Final System Status (Fallback):', window.systemStatus);
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆæœŸåŒ–ã§ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤å‡¦ç†ã‚’å®Ÿè¡Œ
        setTimeout(async () => {
          try {
            console.log('ğŸ”„ Fallback: Final user data synchronization attempt...');
            
            // å¯èƒ½ã§ã‚ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚’è©¦è¡Œ
            if (typeof loadStatus === 'function') {
              try {
                await loadStatus(true);
                console.log('âœ… Fallback: User data synchronization completed');
              } catch (syncError) {
                console.warn('âš ï¸ Fallback: User data sync failed, but continuing:', syncError);
              }
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å¿…ãšéè¡¨ç¤º
            if (window.unifiedLoading) {
              window.unifiedLoading.hide();
              console.log('âœ… Fallback: Global loading overlay hidden');
            } else {
              const overlay = document.getElementById('loading-overlay');
              if (overlay) {
                overlay.classList.add('hidden');
                console.log('âœ… Fallback: Loading overlay hidden (direct DOM)');
              }
            }
            
            // UIè¦ç´ ã®æœ‰åŠ¹åŒ–
            enableUserInteraction();
            updateSystemStatus('userDataSyncComplete', true);
            console.log('âœ… Fallback: User interaction enabled');
            
          } catch (error) {
            console.error('âŒ Fallback sync error:', error);
            // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è§£é™¤
            if (window.unifiedLoading) {
              window.unifiedLoading.hide();
            }
            enableUserInteraction();
          }
        }, 600);
      }
      
      initializeEventsWithRetry();
    }, 100); // 50ms -> 100msã«èª¿æ•´
    
  }, 10); // 50ms -> 10msã«çŸ­ç¸®
}

// å˜ä¸€DOMContentLoadedãƒãƒ³ãƒ‰ãƒ©ãƒ¼
if (document.readyState !== 'loading') {
  initializeAdminPanelMaster();
} else {
  document.addEventListener('DOMContentLoaded', initializeAdminPanelMaster);
}

// Update layout on resize
window.addEventListener('resize', debounce(adjustLayout, 250, 'layout-resize'));
</script>
