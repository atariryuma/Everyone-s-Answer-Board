<script>
// =============================================================================
// ADMIN PANEL CORE UTILITIES & DOM OPERATIONS
// =============================================================================

// =============================================================================
// LOGGING UTILITIES - Standardized logging with levels
// =============================================================================

// Simple logging utility with conditional output based on DEBUG mode
const DEBUG_MODE = window.DEBUG_MODE || false;

function adminLog(level, ...args) {
  if (!DEBUG_MODE) return;
  
  switch (level) {
    case 'error':
      console.error('[AdminPanel]', ...args);
      break;
    case 'warn':
      console.warn('[AdminPanel]', ...args);
      break;
    case 'info':
      console.log('[AdminPanel]', ...args);
      break;
    case 'debug':
      if (DEBUG_MODE) console.log('[AdminPanel:DEBUG]', ...args);
      break;
    default:
      console.log('[AdminPanel]', ...args);
  }
}

// Convenience functions for different log levels
function logError(...args) { adminLog('error', ...args); }
function logWarn(...args) { adminLog('warn', ...args); }
function logInfo(...args) { adminLog('info', ...args); }
function logDebug(...args) { adminLog('debug', ...args); }

// Use SharedUtilities instead of local debounce
var debounce = window.debounce || function(func, delay, key) {
  window.sharedUtilities.debounce.debounce(func, key || 'default', delay);
};

// =============================================================================
// DOM UTILITY FUNCTIONS - Use SharedUtilities
// =============================================================================

// Backward compatibility functions using SharedUtilities
var dom = window.sharedUtilities.dom;
var createSafeElement = dom.createSafeElement.bind(dom);
var getCachedElement = dom.getCachedElement.bind(dom);
var safeGetElement = getCachedElement;
var setButtonState = dom.setButtonState.bind(dom);
var setSafeTextContent = dom.setSafeTextContent.bind(dom);
var toggleClass = dom.toggleClass.bind(dom);
var addSafeEventListener = dom.addSafeEventListener.bind(dom);
var removeSafeEventListener = dom.removeSafeEventListener.bind(dom);
var clearElementCache = dom.clearElementCache.bind(dom);
var cacheElements = dom.cacheElements.bind(dom);

// =============================================================================
// EVENT HANDLER UTILITIES - Consolidated patterns
// =============================================================================

// Utility for setting up multiple event listeners efficiently
function setupMultipleListeners(elementHandlerMap) {
  Object.keys(elementHandlerMap).forEach(function(elementId) {
    var element = elementId.startsWith('#') ? 
      document.querySelector(elementId) : 
      (elements[elementId] || getCachedElement(elementId));
    
    if (element) {
      var handlers = elementHandlerMap[elementId];
      if (Array.isArray(handlers)) {
        handlers.forEach(function(handler) {
          addSafeEventListener(element, handler.event, handler.callback, handler.options);
        });
      } else {
        addSafeEventListener(element, handlers.event, handlers.callback, handlers.options);
      }
    }
  });
}

// Utility for setting up click handlers with confirmation
function setupConfirmationHandler(elementId, confirmTitle, confirmMessage, callback) {
  var element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', function(e) {
      e.preventDefault();
      showConfirmationModal(
        confirmTitle,
        confirmMessage,
        callback
      );
    });
  }
}

// Utility for setting up handlers with privacy consent
function setupPrivacyHandler(elementId, callback) {
  var element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', function(e) {
      e.preventDefault();
      showPrivacyModal(function() {
        hidePrivacyModal();
        callback();
      });
    });
  }
}

// Utility for delegated event handling (useful for dynamic content)
function setupDelegatedHandler(parentElement, selector, event, callback) {
  if (typeof parentElement === 'string') {
    parentElement = getCachedElement(parentElement);
  }
  
  if (parentElement) {
    addSafeEventListener(parentElement, event, function(e) {
      var target = e.target.closest(selector);
      if (target) {
        callback.call(target, e);
      }
    });
  }
}

// =============================================================================
// STATE MANAGEMENT
// =============================================================================

// „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÂØæÂøú: „É¶„Éº„Ç∂„ÉºID„ÅÆÂÆâÂÖ®„Å™ÂàùÊúüÂåñ
var userId = '';

// „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÂØæÂøú: „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åã„ÇâÂÆâÂÖ®„Å´„É¶„Éº„Ç∂„ÉºID„ÇíÂèñÂæó
function initializeUserId() {
  console.group('üîê Initializing UserId');
  console.log('üìû About to call getCurrentUserStatus');
  
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(response => {
        console.log('üì• getCurrentUserStatus response:', response);
        
        if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
          userId = response.userInfo.userId;
          console.log('‚úÖ AdminPanel: User authenticated, userId:', userId);
          console.groupEnd();
          resolve(userId);
        } else {
          console.error('‚ùå Failed to get userId from backend:', response);
          console.error('‚ùå Expected: {status: "success", userInfo: {userId: "..."}}');
          console.groupEnd();
          reject(new Error('„É¶„Éº„Ç∂„ÉºID„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'));
        }
      })
      .withFailureHandler(error => {
        console.error('‚ùå Backend error getting userId:', error);
        console.error('‚ùå Error type:', typeof error);
        console.error('‚ùå Error details:', error);
        console.groupEnd();
        reject(error);
      })
      .getCurrentUserStatus();
  });
}

// „É¶„Éº„Ç∂„ÉºIDÂèñÂæó„ÅÆÂÆå‰∫Ü„ÇíÂæÖ„Å§Promise
const userIdPromise = initializeUserId();
var selectedSheet = '';
var currentActiveSheet = '';
var webAppUrl = '';
var currentSpreadsheetUrl = '';
var currentStatus = null;

// Global variables from adminPanel.js.html
let currentStep = 1;
let selectedSheetId = null;
let selectedFormId = null;
let availableSheets = [];
let availableForms = [];
let currentConfig = null;

// Initialize admin panel
function initializeAdminPanel(incomingUserId) {
  // userId is now managed globally by adminPanel-core.js
  loadUserInfo();
  loadSystemStatus();
  setupEventListeners();
  setupRealtimeUpdates();
  validateCurrentStep();
}

// =============================================================================
// LEGACY UTILITIES (for backward compatibility)
// =============================================================================

// Safe text content setter
function safeSetText(elementId, text) {
  var element = typeof elementId === 'string' ? getCachedElement(elementId) : elementId;
  if (element) {
    setSafeTextContent(element, text || '');
  } else {
    console.warn(`‚ùå [DEBUG] Element not found: ${elementId}`);
  }
}

// Check if element exists and has class
function hasClass(element, className) {
  return element && element.classList && element.classList.contains(className);
}

// Safe attribute setter
function safeSetAttribute(elementId, attribute, value) {
  var element = typeof elementId === 'string' ? getCachedElement(elementId) : elementId;
  if (element) {
    element.setAttribute(attribute, value);
  }
}

// Safe style setter
function safeSetStyle(elementId, property, value) {
  var element = typeof elementId === 'string' ? getCachedElement(elementId) : elementId;
  if (element && element.style) {
    element.style[property] = value;
  }
}

// Safe innerHTML setter (use with caution)
function safeSetHTML(elementId, html) {
  var element = typeof elementId === 'string' ? getCachedElement(elementId) : elementId;
  if (element) {
    // Basic XSS protection
    var div = document.createElement('div');
    div.textContent = html;
    element.innerHTML = div.innerHTML;
  }
}

// =============================================================================
// LAYOUT AND VIEWPORT UTILITIES
// =============================================================================

// Layout adjustment for responsive design
function adjustLayout() {
  var isMobile = window.innerWidth < 768;
  var body = document.body;
  
  if (isMobile) {
    body.classList.add('mobile-layout');
    body.classList.remove('desktop-layout');
  } else {
    body.classList.add('desktop-layout');
    body.classList.remove('mobile-layout');
  }
}

// Set loading state and message with progress
function setLoading(flag, text = 'Âá¶ÁêÜ‰∏≠...', step = 0, percentage = 0) {
  const overlay = document.getElementById('loading-overlay');
  const loadingMessage = document.getElementById('loading-message');
  const progressBar = document.getElementById('loading-progress-bar');
  const progressPercentage = document.getElementById('loading-progress-percentage');

  if (overlay) {
    if (flag) {
      overlay.classList.remove('hidden');
      // ÁîªÈù¢ÂÖ®‰Ωì„ÇíÊìç‰Ωú‰∏çËÉΩ„Å´„Åô„Çã
      document.body.style.overflow = 'hidden';
      document.body.style.pointerEvents = 'none';

      if (loadingMessage) {
        loadingMessage.textContent = text;
      }
      if (progressBar) {
        progressBar.style.width = `${percentage}%`;
      }
      if (progressPercentage) {
        progressPercentage.textContent = `${percentage}%`;
      }

      // Update individual steps
      for (let i = 1; i <= 4; i++) {
        const stepDot = document.getElementById(`loading-step-${i}-dot`);
        const stepText = document.getElementById(`loading-step-${i}-text`);
        const stepDetail = document.getElementById(`loading-step-${i}-detail`);

        if (stepDot && stepText && stepDetail) {
          if (i < step) {
            stepDot.className = 'w-2 h-2 rounded-full bg-green-400';
            stepText.classList.remove('text-gray-300', 'text-emerald-300');
            stepText.classList.add('text-green-300');
            stepDetail.classList.remove('text-gray-500', 'text-emerald-400');
            stepDetail.classList.add('text-green-400');
          } else if (i === step) {
            stepDot.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse';
            stepText.classList.remove('text-gray-300', 'text-green-300');
            stepText.classList.add('text-emerald-300');
            stepDetail.classList.remove('text-gray-500', 'text-green-400');
            stepDetail.classList.add('text-emerald-400');
          } else {
            stepDot.className = 'w-2 h-2 rounded-full bg-gray-400';
            stepText.classList.remove('text-emerald-300', 'text-green-300');
            stepText.classList.add('text-gray-300');
            stepDetail.classList.remove('text-emerald-400', 'text-green-400');
            stepDetail.classList.add('text-gray-500');
          }
        }
      }
    } else {
      overlay.classList.add('hidden');
      // ÁîªÈù¢Êìç‰Ωú„ÇíÂèØËÉΩ„Å´„Åô„Çã
      document.body.style.overflow = '';
      document.body.style.pointerEvents = '';
    }
  }
}


// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize layout on load
function initCore() {
  adjustLayout();
}

if (document.readyState !== 'loading') {
  initCore();
} else {
  document.addEventListener('DOMContentLoaded', initCore);
}

// Update layout on resize
window.addEventListener('resize', debounce(adjustLayout, 250, 'layout-resize'));
</script>
