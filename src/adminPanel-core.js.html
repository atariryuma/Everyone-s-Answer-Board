<script>
// =============================================================================
// ADMIN PANEL CORE UTILITIES & DOM OPERATIONS
// =============================================================================

// =============================================================================
// LOGGING UTILITIES - Standardized logging with levels
// =============================================================================

// Simple logging utility with conditional output based on DEBUG mode
const DEBUG_MODE = window.DEBUG_MODE || false;

function adminLog(level, ...args) {
  if (!DEBUG_MODE) return;
  
  switch (level) {
    case 'error':
      console.error('[AdminPanel]', ...args);
      break;
    case 'warn':
      console.warn('[AdminPanel]', ...args);
      break;
    case 'info':
      console.log('[AdminPanel]', ...args);
      break;
    case 'debug':
      if (DEBUG_MODE) console.log('[AdminPanel:DEBUG]', ...args);
      break;
    default:
      console.log('[AdminPanel]', ...args);
  }
}

// Convenience functions for different log levels
function logError(...args) { adminLog('error', ...args); }
function logWarn(...args) { adminLog('warn', ...args); }
function logInfo(...args) { adminLog('info', ...args); }
function logDebug(...args) { adminLog('debug', ...args); }

// Use SharedUtilities instead of local debounce
var debounce = window.debounce || function(func, delay, key) {
  window.sharedUtilities.debounce.debounce(func, key || 'default', delay);
};

// =============================================================================
// DOM UTILITY FUNCTIONS - Use SharedUtilities
// =============================================================================

// Backward compatibility functions using SharedUtilities
var dom = window.sharedUtilities.dom;
var createSafeElement = dom.createSafeElement.bind(dom);
var getCachedElement = dom.getCachedElement.bind(dom);
var safeGetElement = getCachedElement;
var setButtonState = dom.setButtonState.bind(dom);
var setSafeTextContent = dom.setSafeTextContent.bind(dom);
var toggleClass = dom.toggleClass.bind(dom);
var addSafeEventListener = dom.addSafeEventListener.bind(dom);
var removeSafeEventListener = dom.removeSafeEventListener.bind(dom);
var clearElementCache = dom.clearElementCache.bind(dom);
var cacheElements = dom.cacheElements.bind(dom);

// =============================================================================
// EVENT HANDLER UTILITIES - Consolidated patterns
// =============================================================================

// Utility for setting up multiple event listeners efficiently
function setupMultipleListeners(elementHandlerMap) {
  Object.keys(elementHandlerMap).forEach(function(elementId) {
    var element = elementId.startsWith('#') ? 
      document.querySelector(elementId) : 
      (elements[elementId] || getCachedElement(elementId));
    
    if (element) {
      var handlers = elementHandlerMap[elementId];
      if (Array.isArray(handlers)) {
        handlers.forEach(function(handler) {
          addSafeEventListener(element, handler.event, handler.callback, handler.options);
        });
      } else {
        addSafeEventListener(element, handlers.event, handlers.callback, handlers.options);
      }
    }
  });
}

// Utility for setting up click handlers with confirmation
function setupConfirmationHandler(elementId, confirmTitle, confirmMessage, callback) {
  var element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', function(e) {
      e.preventDefault();
      showConfirmationModal(
        confirmTitle,
        confirmMessage,
        callback
      );
    });
  }
}

// Utility for setting up handlers with privacy consent
function setupPrivacyHandler(elementId, callback) {
  var element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', function(e) {
      e.preventDefault();
      showPrivacyModal(function() {
        hidePrivacyModal();
        callback();
      });
    });
  }
}

// Utility for delegated event handling (useful for dynamic content)
function setupDelegatedHandler(parentElement, selector, event, callback) {
  if (typeof parentElement === 'string') {
    parentElement = getCachedElement(parentElement);
  }
  
  if (parentElement) {
    addSafeEventListener(parentElement, event, function(e) {
      var target = e.target.closest(selector);
      if (target) {
        callback.call(target, e);
      }
    });
  }
}

// =============================================================================
// STATE MANAGEMENT
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å®‰å…¨ãªåˆæœŸåŒ–
var userId = '';

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å®‰å…¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
function initializeUserId() {
  console.group('ğŸ” Initializing UserId');
  logDebug('ğŸ“ About to call getCurrentUserStatus');
  
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(response => {
        logDebug('ğŸ“¥ getCurrentUserStatus response:', response);
        
        if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
          userId = response.userInfo.userId;
          logDebug('âœ… AdminPanel: User authenticated, userId:', userId);
          console.groupEnd();
          resolve(userId);
        } else {
          console.error('âŒ Failed to get userId from backend:', response);
          console.error('âŒ Expected: {status: "success", userInfo: {userId: "..."}}');
          console.groupEnd();
          reject(new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        }
      })
      .withFailureHandler(error => {
        console.error('âŒ Backend error getting userId:', error);
        console.error('âŒ Error type:', typeof error);
        console.error('âŒ Error details:', error);
        console.groupEnd();
        reject(error);
      })
      .getCurrentUserStatus();
  });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ã®å®Œäº†ã‚’å¾…ã¤Promise
const userIdPromise = initializeUserId();
var selectedSheet = '';
var currentActiveSheet = '';
var webAppUrl = '';
var currentSpreadsheetUrl = '';
var currentStatus = null;

// Global variables from adminPanel.js.html
let currentStep = 1;
let selectedSheetId = null;
let selectedFormId = null;
let availableSheets = [];
let availableForms = [];
let currentConfig = null;

// Initialize admin panel
function initializeAdminPanel(incomingUserId) {
  // userId is now managed globally by adminPanel-core.js
  loadUserInfo();
  loadSystemStatus();
  setupEventListeners();
  setupRealtimeUpdates();
  validateCurrentStep();
}

// =============================================================================
// LEGACY UTILITIES (for backward compatibility)
// =============================================================================

// Safe text content setter
function safeSetText(elementId, text) {
  var element = typeof elementId === 'string' ? getCachedElement(elementId) : elementId;
  if (element) {
    setSafeTextContent(element, text || '');
  }
}

// =============================================================================
// LAYOUT AND VIEWPORT UTILITIES
// =============================================================================

// Layout adjustment for responsive design
function adjustLayout() {
  var isMobile = window.innerWidth < 768;
  var body = document.body;
  
  if (isMobile) {
    body.classList.add('mobile-layout');
    body.classList.remove('desktop-layout');
  } else {
    body.classList.add('desktop-layout');
    body.classList.remove('mobile-layout');
  }
}

// AdminPanel no longer overrides global setLoading
// Uses unified loading system with admin-specific configurations


// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize layout on load
// çµ±åˆåˆæœŸåŒ–ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
function initCore() {
  adjustLayout();
}

// å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†
function checkAndExpandAllSections() {
  try {
    const expandAllFlag = localStorage.getItem('expandAllSections');
    if (expandAllFlag === 'true') {
      logInfo('ğŸ“‚ å…¬é–‹åœæ­¢å¾Œã®ãŸã‚å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ã—ã¾ã™');
      
      // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ï¼ˆDOMè¦ç´ ã®æº–å‚™ã‚’å¾…ã¤ï¼‰
      setTimeout(() => {
        const sectionIds = ['step1-content', 'step2-content', 'step3-content'];
        let expandedCount = 0;
        
        sectionIds.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å±•é–‹
            if (section.classList.contains('hidden')) {
              toggleSection(sectionId);
              expandedCount++;
              logDebug(`âœ… ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹: ${sectionId}`);
            }
          }
        });
        
        if (expandedCount > 0) {
          logInfo(`ğŸ“‚ ${expandedCount}å€‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ã—ã¾ã—ãŸ`);
        }
        
        // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
        localStorage.removeItem('expandAllSections');
        logDebug('ğŸ§¹ å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      }, 500);
    }
  } catch (error) {
    logWarn('âš ï¸ å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ  - å˜ä¸€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
function initializeAdminPanelMaster() {
  logInfo('ğŸš€ AdminPanel Master Initialization Started');
  
  // Phase 1: CoreåˆæœŸåŒ–
  initCore();
  
  // å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†
  checkAndExpandAllSections();
  
  // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°è¦ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤ºï¼‰
  setTimeout(() => {
    const formJustCreated = sessionStorage.getItem('form_just_created');
    if (formJustCreated !== 'true') {
      // æ–°è¦ä½œæˆã§ã¯ãªã„å ´åˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
      const formUrlSection = document.getElementById('form-url-section');
      if (formUrlSection && !formUrlSection.classList.contains('hidden')) {
        formUrlSection.classList.add('hidden');
        logDebug('ğŸ“‹ æ—¢å­˜ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º');
      }
    }
  }, 100);
  
  // Phase 2: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é †æ¬¡åˆæœŸåŒ– (race conditionã‚’é˜²ã)
  // é…å»¶ã‚’æœ€å°é™ã«æŠ‘åˆ¶ã—ã¦å³åº§ã«åˆæœŸåŒ–
  setTimeout(() => {
    logDebug('ğŸ”§ Phase 2: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–é–‹å§‹');
    
    // Statusç®¡ç†åˆæœŸåŒ–
    if (typeof initializeMessageArea === 'function') {
      initializeMessageArea();
      logDebug('âœ… Status module initialized');
    }
    
    // APIé€šä¿¡åˆæœŸåŒ–ï¼ˆæœ€é‡è¦ - getInitialDataã‚’å‘¼ã³å‡ºã™ï¼‰
    function initializeAPIWithRetry(attempts = 0) {
      if (typeof initializeAPI === 'function' && typeof runGasWithUserId === 'function') {
        logDebug('ğŸš€ API module initialization starting...');
        initializeAPI();
        logDebug('âœ… API module initialized');
      } else if (attempts < 10) {
        logDebug(`â³ APIé–¢æ•°èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­... (è©¦è¡Œ ${attempts + 1}/10)`);
        setTimeout(() => initializeAPIWithRetry(attempts + 1), 100);
      } else {
        console.error('âŒ API functions not found after maximum attempts!');
        console.error('Missing functions:', {
          initializeAPI: typeof initializeAPI,
          runGasWithUserId: typeof runGasWithUserId
        });
      }
    }
    
    initializeAPIWithRetry();
    
    // UIåˆæœŸåŒ–
    if (typeof initializeUI === 'function') {
      initializeUI();
      logDebug('âœ… UI module initialized');
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†åˆæœŸåŒ–
    if (typeof setupCharacterCounters === 'function') {
      setupCharacterCounters();
      logDebug('âœ… Forms module initialized');
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†åˆæœŸåŒ–ï¼ˆæœ€å¾Œã«å®Ÿè¡Œï¼‰
    setTimeout(() => {
      function initializeEventsWithRetry(attempts = 0) {
        if (typeof initializeEventListeners === 'function' && 
            typeof handleQuickStart === 'function' && 
            typeof runHeaderGuessing === 'function') {
          initializeEventListeners();
          logDebug('âœ… Events module initialized');
          logInfo('ğŸ‰ AdminPanel Master Initialization Complete');
        } else if (attempts < 10) {
          logDebug(`â³ ã‚¤ãƒ™ãƒ³ãƒˆé–¢æ•°èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­... (è©¦è¡Œ ${attempts + 1}/10)`);
          setTimeout(() => initializeEventsWithRetry(attempts + 1), 100);
        } else {
          console.error('âŒ Event functions not found after maximum attempts!');
          console.error('Missing functions:', {
            initializeEventListeners: typeof initializeEventListeners,
            handleQuickStart: typeof handleQuickStart,
            runHeaderGuessing: typeof runHeaderGuessing
          });
          logInfo('âš ï¸ AdminPanel Master Initialization Complete (with missing functions)');
        }
      }
      
      initializeEventsWithRetry();
    }, 50);
    
  }, 10); // 50ms -> 10msã«çŸ­ç¸®
}

// å˜ä¸€DOMContentLoadedãƒãƒ³ãƒ‰ãƒ©ãƒ¼
if (document.readyState !== 'loading') {
  initializeAdminPanelMaster();
} else {
  document.addEventListener('DOMContentLoaded', initializeAdminPanelMaster);
}

// Update layout on resize
window.addEventListener('resize', debounce(adjustLayout, 250, 'layout-resize'));
</script>
