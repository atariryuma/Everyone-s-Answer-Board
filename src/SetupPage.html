<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyQuest - 初回セットアップ</title>
    <!-- Bootstrap CSS & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <?!= include('UnifiedStyles'); ?>
    <?!= include('SharedUtilities'); ?>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <!-- ヘッダー -->
                <div class="text-center mb-5">
                    <h1 class="display-4 fw-bold text-info mb-2">📚 StudyQuest</h1>
                    <p class="fs-4 text-light">初回セットアップ</p>
                    <p class="text-muted">システムを使用開始するための設定を行います</p>
                </div>

                <!-- メッセージエリア -->
                <div id="message-area" class="mb-4"></div>

                <!-- セットアップフォーム -->
                <div class="glass-panel rounded-3 p-4 mb-4">
                    <h2 class="h4 fw-semibold text-white mb-4">🔧 システム設定</h2>

                    <form id="setup-form">
                        <!-- サービスアカウントJSON -->
                        <div class="mb-3">
                            <label for="service-account-json" class="form-label text-light">
                                🔑 サービスアカウントJSONキー
                            </label>
                            <textarea
                                id="service-account-json"
                                name="serviceAccountJson"
                                rows="8"
                                class="form-control bg-dark text-light font-monospace"
                                style="font-size: 0.75rem; resize: vertical;"
                                placeholder='{"type": "service_account", "project_id": "...", "private_key_id": "...", ...}'
                                required></textarea>
                            <div class="form-text text-muted">Google Cloud ConsoleからダウンロードしたサービスアカウントのJSONファイルの内容を貼り付けてください</div>
                        </div>

                        <!-- データベーススプレッドシートID -->
                        <div class="mb-3">
                            <label for="database-id" class="form-label text-light">
                                📊 データベーススプレッドシートID
                            </label>
                            <input
                                type="text"
                                id="database-id"
                                name="databaseId"
                                class="form-control bg-dark text-light font-monospace"
                                placeholder="1BcD3fGhIjKlMnOpQrStUvWxYz0123456789ABCDEFGH"
                                pattern="[a-zA-Z0-9_\-]{44}"
                                maxlength="44"
                                required>
                            <div class="form-text text-muted">データベース用スプレッドシートのIDを入力してください（44文字）</div>
                        </div>

                        <!-- セットアップボタン -->
                        <div class="d-grid">
                            <button
                                type="submit"
                                id="setup-btn"
                                class="btn btn-primary btn-lg fw-bold"
                                style="background: linear-gradient(to right, #0891b2, #2563eb); border: none;">
                                <span id="setup-text">🚀 セットアップを開始</span>
                                <div id="setup-spinner" class="spinner-border spinner-border-sm mx-auto d-none" role="status"></div>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- テストセクション（セットアップ後に表示） -->
                <div id="test-section" class="glass-panel rounded-3 p-4 d-none">
                    <h3 class="h5 fw-semibold text-white mb-3">✅ セットアップ完了</h3>
                    <p class="text-light mb-3">セットアップが正常に完了しました。システムの動作確認を行えます。</p>
                    <button
                        id="test-btn"
                        class="btn btn-success fw-bold me-2 mb-2"
                        style="background: linear-gradient(to right, #059669, #10b981); border: none;">
                        🔍 システムテスト実行
                    </button>
                    <button type="button" id="start-studyquest-btn" onclick="startApp()" class="btn fw-bold mb-2"
                        style="background: linear-gradient(to right, #7c3aed, #ec4899); border: none; color: white;">
                        📚 StudyQuestを開始
                    </button>
                </div>

                <!-- ヘルプセクション -->
                <div class="glass-panel rounded-3 p-4">
                    <h3 class="h5 fw-semibold text-white mb-3">❓ セットアップでお困りの場合</h3>
                    <div class="text-light">
                        <details class="mb-2" style="cursor: pointer;">
                            <summary class="fw-medium text-info">サービスアカウントJSONの取得方法</summary>
                            <div class="mt-2 ps-3 text-muted small">
                                <ol class="list-unstyled">
                                    <li class="mb-1">1. Google Cloud Consoleにアクセス</li>
                                    <li class="mb-1">2. プロジェクトを選択または作成</li>
                                    <li class="mb-1">3. 「IAMと管理」→「サービスアカウント」</li>
                                    <li class="mb-1">4. 「サービスアカウントを作成」</li>
                                    <li class="mb-1">5. アカウント作成後、「キー」タブからJSONキーをダウンロード</li>
                                </ol>
                            </div>
                        </details>
                        <details style="cursor: pointer;">
                            <summary class="fw-medium text-info">スプレッドシートIDの取得方法</summary>
                            <div class="mt-2 ps-3 text-muted small">
                                <ol class="list-unstyled">
                                    <li class="mb-1">1. Google Sheetsで新しいスプレッドシートを作成</li>
                                    <li class="mb-1">2. URLから44文字のIDをコピー（/d/の後の部分）</li>
                                    <li class="mb-1">3. サービスアカウントをスプレッドシートの編集者として追加</li>
                                </ol>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let setupInProgress = false;

        // メッセージ表示関数
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const colors = {
                success: 'bg-success bg-opacity-25 border-success text-green-100',
                error: 'bg-danger bg-opacity-25 border-danger text-danger',
                warning: 'bg-warning bg-opacity-25 border-warning text-warning',
                info: 'bg-primary bg-opacity-25 border-primary text-primary'
            };

            messageArea.innerHTML = `
                <div class="message show glass-panel rounded-lg p-4 border ${colors[type]}">
                    <div class="flex items-center">
                        <div class="mr-3">
                            ${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}
                        </div>
                        <div class="flex-1">${message}</div>
                        <button onclick="this.closest('.message').style.display='none'" class="ms-3 text-muted">✕</button>
                    </div>
                </div>
            `;
        }

        // バリデーション関数
        function validateJSON(jsonString) {
            try {
                const parsed = JSON.parse(jsonString);
                const required = ['type', 'project_id', 'private_key_id', 'private_key', 'client_email'];
                for (const field of required) {
                    if (!parsed[field]) {
                        throw new Error(`必須フィールド '${field}' が見つかりません`);
                    }
                }
                if (parsed.type !== 'service_account') {
                    throw new Error('サービスアカウントタイプのJSONである必要があります');
                }
                return true;
            } catch (e) {
                throw new Error(`JSON形式が無効です: ${e.message}`);
            }
        }

        function validateSpreadsheetId(id) {
            if (!id || id.length !== 44) {
                throw new Error('スプレッドシートIDは44文字である必要があります');
            }
            if (!/^[a-zA-Z0-9_-]+$/.test(id)) {
                throw new Error('スプレッドシートIDに無効な文字が含まれています');
            }
            return true;
        }

        // セットアップフォーム送信処理
        document.getElementById('setup-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (setupInProgress) return;
            setupInProgress = true;

            const setupBtn = document.getElementById('setup-btn');
            const setupText = document.getElementById('setup-text');
            const setupSpinner = document.getElementById('setup-spinner');

            try {
                // ボタン状態を変更
                setupBtn.disabled = true;
                setupText.style.display = 'none';
                setupSpinner.classList.remove('hidden');

                // 入力値取得
                const serviceAccountJson = document.getElementById('service-account-json').value.trim();
                const databaseId = document.getElementById('database-id').value.trim();

                // バリデーション
                validateJSON(serviceAccountJson);
                validateSpreadsheetId(databaseId);

                showMessage('セットアップを実行中...', 'info');

                // セットアップ実行
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler((result) => {
                            showMessage('✅ セットアップが正常に完了しました！', 'success');
                            document.getElementById('test-section').classList.remove('hidden');
                            resolve(result);
                        })
                        .withFailureHandler((error) => {
                            console.error('Setup error:', error);
                            let displayMessage = `❌ セットアップに失敗しました: ${error.message || error}`;
                            if (error.message && error.message.includes('スプレッドシートの共有設定が「制限付き」になっていません')) {
                                displayMessage = `
                                    <p class="font-bold">${error.message}</p>
                                    <p class="mt-2">セキュリティのため、データベースとして使用するスプレッドシートの共有設定を「制限付き」に変更してください。</p>
                                    <p>変更方法: スプレッドシートを開き、「共有」ボタン → 「一般的なアクセス」を「制限付き」に変更。</p>
                                `;
                            }
                            showMessage(displayMessage, 'error');
                            reject(error);
                        })
                        .setupApplication(serviceAccountJson, databaseId);
                });

            } catch (error) {
                showMessage(`❌ ${error.message}`, 'error');
            } finally {
                // ボタン状態をリセット
                setupBtn.disabled = false;
                setupText.style.display = 'inline';
                setupSpinner.classList.add('hidden');
                setupInProgress = false;
            }
        });

        // テストボタン処理
        document.getElementById('test-btn').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<div class="loading-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mx-auto"></div>';

            google.script.run
                .withSuccessHandler((result) => {
                    showMessage(`${result.message}`, result.status === 'success' ? 'success' : 'warning');
                    this.disabled = false;
                    this.innerHTML = '🔍 システムテスト実行';
                })
                .withFailureHandler((error) => {
                    showMessage(`テスト実行に失敗しました: ${error.message || error}`, 'error');
                    this.disabled = false;
                    this.innerHTML = '🔍 システムテスト実行';
                })
                .testSetup();
        });

        // 入力フィールドのリアルタイムバリデーション
        document.getElementById('service-account-json').addEventListener('blur', function() {
            try {
                if (this.value.trim()) {
                    validateJSON(this.value.trim());
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
            } catch (e) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });

        document.getElementById('database-id').addEventListener('input', function() {
            try {
                if (this.value.trim()) {
                    validateSpreadsheetId(this.value.trim());
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
            } catch (e) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });

        function startApp() {
            const btn = document.getElementById('start-studyquest-btn');
            if (btn) {
                btn.innerHTML = '<span>読み込み中...</span>';
                btn.disabled = true;
            }

            google.script.run
                .withSuccessHandler(function(url) {
                    window.top.location.href = url;
                })
                .withFailureHandler(function(error) {
                    alert('アプリケーションのURL取得に失敗しました: ' + error.message);
                    if (btn) {
                        btn.innerHTML = '📚 StudyQuestを開始';
                        btn.disabled = false;
                    }
                })
                .getWebAppUrl();
        }
    </script>
</body>
</html>
