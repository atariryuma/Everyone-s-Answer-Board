<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; padding: 30px; background-color: #f8f9fa; color: #333; }
        .container { max-width: 700px; margin: 0 auto; background-color: #fff; border: 1px solid #dee2e6; padding: 20px 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { color: #495057; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="url"] { width: 100%; padding: 10px; margin-bottom: 20px; box-sizing: border-box; border: 1px solid #ced4da; border-radius: 4px; }
        button { padding: 12px 22px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:disabled { background-color: #6c757d; }
        #message { margin-top: 20px; font-weight: bold; padding: 10px; border-radius: 4px; }
        .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb;}
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb;}
    </style>
</head>
<body>
    <div class="container">
        <h2>みんなの回答ボード - 初回セットアップ</h2>
        
        <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; color: #856404;">📋 事前準備の確認</h3>
            <p><strong>Logger API（管理者向けログ記録API）が正しくデプロイされているか確認してください：</strong></p>
            <ol>
                <li>Logger APIプロジェクトで「デプロイ」→「新しいデプロイ」を実行</li>
                <li>「種類」を「ウェブアプリ」に設定</li>
                <li>「実行者」を「自分」に設定</li>
                <li>「アクセスできるユーザー」を「すべてのユーザー（匿名ユーザーを含む）」に設定</li>
                <li>「デプロイ」をクリックしてWeb App URLを取得</li>
            </ol>
            <p><strong>重要：</strong> Logger APIが正しくデプロイされていない場合、「Page Not Found」エラーが発生します。</p>
        </div>
        
        <p>Logger APIのウェブアプリURLを以下に貼り付けてください：</p>
        <form id="setupForm">
            <label for="apiUrl">Logger API Web App URL:</label>
            <input type="url" id="apiUrl" name="apiUrl" required 
                   placeholder="例: https://script.google.com/macros/s/AKfycbxXXXXX/exec"
                   style="font-family: monospace;">
            
            <div style="margin-bottom: 15px; font-size: 12px; color: #6c757d;">
                <strong>有効な形式:</strong><br>
                • https://script.google.com/macros/s/xxxxx/exec<br>
                • https://script.google.com/a/macros/domain.com/s/xxxxx/exec
            </div>
            
            <button type="submit" id="submitBtn">設定を保存してデータベースを作成</button>
        </form>
        <div id="message"></div>
        
        <div style="margin-top: 30px; font-size: 12px; color: #6c757d; border-top: 1px solid #dee2e6; padding-top: 15px;">
            <strong>トラブルシューティング:</strong><br>
            • 「Page Not Found」エラー → Logger APIのデプロイ状況を確認<br>
            • 「権限エラー」→ Logger APIのアクセス設定を「すべてのユーザー（匿名ユーザーを含む）」に変更<br>
            • 「URL形式エラー」→ 上記の有効な形式に従ってURLを入力
        </div>
    </div>

    <script>
        document.getElementById('setupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const apiUrl = document.getElementById('apiUrl').value;
            const btn = document.getElementById('submitBtn');
            const msgDiv = document.getElementById('message');

            btn.disabled = true;
            btn.textContent = '処理中...';
            msgDiv.textContent = '';
            msgDiv.className = '';

            google.script.run
                .withSuccessHandler(function(message) {
                    msgDiv.textContent = message;
                    if (message.startsWith('✅')) {
                        msgDiv.className = 'success';
                        btn.style.backgroundColor = '#28a745';
                        btn.textContent = '完了';
                    } else {
                        msgDiv.className = 'error';
                        btn.disabled = false;
                        btn.textContent = '設定を保存してデータベースを作成';
                    }
                })
                .withFailureHandler(function(error) {
                    msgDiv.className = 'error';
                    msgDiv.textContent = 'エラー: ' + error.message;
                    btn.disabled = false;
                    btn.textContent = '設定を保存してデータベースを作成';
                })
                .saveSettingsAndCreateDb(apiUrl);
        });
    </script>
</body>
</html>