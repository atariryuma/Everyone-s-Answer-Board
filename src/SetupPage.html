<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyQuest - ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --color-primary: #8be9fd;
            --color-secondary: #50fa7b;
            --color-background: #1a1b26;
            --color-surface: rgba(26,27,38,0.7);
            --color-text: #c0caf5;
            --color-border: rgba(255,255,255,0.1);
            --color-success: #10b981;
            --color-error: #ef4444;
            --color-warning: #f59e0b;
            --color-info: #3b82f6;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; 
            background: linear-gradient(135deg, var(--color-background) 0%, #282a36 100%);
            color: var(--color-text);
            min-height: 100vh;
            padding: 1rem;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            color: var(--color-primary);
            font-size: 2.25rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            color: var(--color-secondary);
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
        }
        
        .section h2 {
            color: var(--color-primary);
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        
        .section h2 .emoji {
            margin-right: 0.5rem;
            font-size: 1.75rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--color-text);
        }
        
        .form-control {
            width: 100%;
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            color: var(--color-text);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(139, 233, 253, 0.2);
        }
        
        .form-control.textarea {
            min-height: 150px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: var(--color-background);
            width: 100%;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text);
            margin-top: 0.5rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
            display: none;
        }
        
        .alert.success { background-color: var(--color-success); color: white; }
        .alert.error { background-color: var(--color-error); color: white; }
        .alert.info { background-color: var(--color-info); color: white; }
        .alert.warning { background-color: var(--color-warning); color: white; }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-border);
            padding: 1rem;
            border-radius: 0.5rem;
        }
        
        .info-card h4 {
            color: var(--color-secondary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .info-card p {
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .step-list {
            list-style: none;
            padding: 0;
        }
        
        .step-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: flex-start;
        }
        
        .step-list li:last-child {
            border-bottom: none;
        }
        
        .step-number {
            background: var(--color-primary);
            color: var(--color-background);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            margin-right: 0.75rem;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }
        
        .code-block {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--color-border);
            border-radius: 0.375rem;
            padding: 0.75rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.8rem;
            color: var(--color-primary);
            margin: 0.5rem 0;
            overflow-x: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-indicator.success { background-color: var(--color-success); }
        .status-indicator.error { background-color: var(--color-error); }
        .status-indicator.pending { background-color: var(--color-warning); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ StudyQuest ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h1>
            <p class="subtitle">æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</p>
        </div>
        
        <!-- æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2><span class="emoji">ğŸ¯</span>æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç‰¹å¾´</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h4>âœ… 403ã‚¨ãƒ©ãƒ¼å®Œå…¨è§£æ±º</h4>
                    <p>Google Workspaceç®¡ç†è€…ã®è¨­å®šå¤‰æ›´ãŒä¸è¦ã«ãªã‚Šã¾ã—ãŸ</p>
                </div>
                <div class="info-card">
                    <h4>ğŸ—ï¸ å˜ä¸€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ</h4>
                    <p>Admin Logger APIä¸è¦ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¤§å¹…ã«ç°¡ç´ åŒ–</p>
                </div>
                <div class="info-card">
                    <h4>ğŸš€ é«˜æ€§èƒ½åŒ–</h4>
                    <p>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ ã¨Google Sheets API v4ã§50-75%é«˜é€ŸåŒ–</p>
                </div>
                <div class="info-card">
                    <h4>ğŸ” å¼·å›ºãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h4>
                    <p>JWT + ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ã«ã‚ˆã‚‹å®‰å…¨ãªä¸­å¤®DBç®¡ç†</p>
                </div>
            </div>
        </div>
        
        <!-- äº‹å‰æº–å‚™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2><span class="emoji">ğŸ“‹</span>äº‹å‰æº–å‚™ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
            <p class="mb-4">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ãŒæº–å‚™æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
            <ol class="step-list">
                <li>
                    <span class="step-number">1</span>
                    <div>
                        <strong>Google Cloud Console ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ¸ˆã¿</strong><br>
                        <small>Google Sheets API ã¨ Google Drive API ã‚’æœ‰åŠ¹åŒ–ã—ã€JSONã‚­ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</small>
                    </div>
                </li>
                <li>
                    <span class="step-number">2</span>
                    <div>
                        <strong>ä¸­å¤®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆæ¸ˆã¿</strong><br>
                        <small>ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆclient_emailï¼‰ã«ç·¨é›†è€…æ¨©é™ã§å…±æœ‰æ¸ˆã¿</small>
                    </div>
                </li>
                <li>
                    <span class="step-number">3</span>
                    <div>
                        <strong>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’ç¢ºèªæ¸ˆã¿</strong><br>
                        <small>URLã‹ã‚‰44æ–‡å­—ã®IDã‚’å–å¾—ï¼ˆä¾‹ï¼š1BcD3fGhIjKlMnOpQrStUvWxYz0123456789ABCDEFGHï¼‰</small>
                    </div>
                </li>
            </ol>
        </div>
        
        <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="section">
            <h2><span class="emoji">âš™ï¸</span>ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h2>
            
            <div id="alertContainer"></div>
            
            <form id="setupForm">
                <div class="form-group">
                    <label class="form-label" for="serviceAccountJson">
                        <strong>ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONã‚­ãƒ¼</strong>
                        <small style="color: #facc15;">ï¼ˆGoogle Cloud Consoleã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ãƒšãƒ¼ã‚¹ãƒˆï¼‰</small>
                    </label>
                    <textarea 
                        id="serviceAccountJson" 
                        class="form-control textarea" 
                        placeholder='{"type":"service_account","project_id":"your-project",...}'
                        required></textarea>
                    <small style="color: #94a3b8;">JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å…¨å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="databaseSpreadsheetId">
                        <strong>ä¸­å¤®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID</strong>
                        <small style="color: #facc15;">ï¼ˆ44æ–‡å­—ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDï¼‰</small>
                    </label>
                    <input 
                        type="text" 
                        id="databaseSpreadsheetId" 
                        class="form-control" 
                        placeholder="1BcD3fGhIjKlMnOpQrStUvWxYz0123456789ABCDEFGH"
                        pattern="[a-zA-Z0-9_-]{44}"
                        title="44æ–‡å­—ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                        required>
                    <small style="color: #94a3b8;">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‹ã‚‰44æ–‡å­—ã®IDã‚’å–å¾—ã—ã¦ãã ã•ã„</small>
                </div>
                
                <button type="submit" id="setupBtn" class="btn btn-primary">
                    ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè¡Œ
                </button>
                
                <button type="button" id="testBtn" class="btn btn-secondary" style="display: none;">
                    ğŸ§ª ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ãƒ†ã‚¹ãƒˆ
                </button>
            </form>
        </div>
        
        <!-- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° -->
        <div class="section">
            <h2><span class="emoji">ğŸ”§</span>ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h4>ğŸ”’ èªè¨¼ã‚¨ãƒ©ãƒ¼</h4>
                    <p><strong>ç—‡çŠ¶:</strong> "Service account authentication failed"</p>
                    <p><strong>è§£æ±ºç­–:</strong> JSONã‚­ãƒ¼ã®å½¢å¼ç¢ºèªã€APIæœ‰åŠ¹åŒ–ç¢ºèªã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå…±æœ‰ç¢ºèª</p>
                </div>
                <div class="info-card">
                    <h4>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼</h4>
                    <p><strong>ç—‡çŠ¶:</strong> "Database spreadsheet not accessible"</p>
                    <p><strong>è§£æ±ºç­–:</strong> ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDç¢ºèªï¼ˆ44æ–‡å­—ï¼‰ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¨©é™ç¢ºèª</p>
                </div>
                <div class="info-card">
                    <h4>ğŸš« æ¨©é™ã‚¨ãƒ©ãƒ¼</h4>
                    <p><strong>ç—‡çŠ¶:</strong> "Permission denied"</p>
                    <p><strong>è§£æ±ºç­–:</strong> Google Cloud Console ã§APIæœ‰åŠ¹åŒ–ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ç¢ºèª</p>
                </div>
                <div class="info-card">
                    <h4>ğŸ“ JSONå½¢å¼ã‚¨ãƒ©ãƒ¼</h4>
                    <p><strong>ç—‡çŠ¶:</strong> "Invalid JSON format"</p>
                    <p><strong>è§£æ±ºç­–:</strong> JSONãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ã€æ”¹è¡Œãƒ»ã‚¹ãƒšãƒ¼ã‚¹å«ã‚ã¦å®Œå…¨ã«ãƒšãƒ¼ã‚¹ãƒˆ</p>
                </div>
            </div>
        </div>
        
        <!-- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— -->
        <div class="section">
            <h2><span class="emoji">ğŸ‰</span>ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å¾Œ</h2>
            <p class="mb-4">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæˆåŠŸã™ã‚‹ã¨ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ï¼š</p>
            <div class="info-grid">
                <div class="info-card">
                    <h4>ğŸ‘¨â€ğŸ’¼ ç®¡ç†ç”»é¢</h4>
                    <div class="code-block">?mode=admin</div>
                    <p>æ–°ã—ã„å›ç­”ãƒœãƒ¼ãƒ‰ã®ä½œæˆã€è¨­å®šç®¡ç†</p>
                </div>
                <div class="info-card">
                    <h4>ğŸ“ å›ç­”ãƒœãƒ¼ãƒ‰</h4>
                    <div class="code-block">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆURL</div>
                    <p>ç”Ÿå¾’ã®å›ç­”è¡¨ç¤ºã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½</p>
                </div>
                <div class="info-card">
                    <h4>ğŸ§ª 100%ãƒ†ã‚¹ãƒˆæ¸ˆã¿</h4>
                    <div class="code-block">13/13 tests passed</div>
                    <p>åŸºæœ¬æ©Ÿèƒ½7é …ç›® + é«˜åº¦æ©Ÿèƒ½6é …ç›®</p>
                </div>
                <div class="info-card">
                    <h4>ğŸš€ é«˜æ€§èƒ½</h4>
                    <div class="code-block">50-75% faster</div>
                    <p>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹é«˜é€ŸåŒ–</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            alert.innerHTML = `
                <span class="status-indicator ${type === 'success' ? 'success' : type === 'error' ? 'error' : 'pending'}"></span>
                ${message}
            `;
            container.innerHTML = '';
            container.appendChild(alert);
        }

        function validateJSON(jsonString) {
            try {
                const parsed = JSON.parse(jsonString);
                if (parsed.type !== 'service_account') {
                    throw new Error('ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                }
                if (!parsed.private_key || !parsed.client_email || !parsed.project_id) {
                    throw new Error('å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                return true;
            } catch (e) {
                throw new Error(`JSONå½¢å¼ã‚¨ãƒ©ãƒ¼: ${e.message}`);
            }
        }

        function validateSpreadsheetId(id) {
            if (!/^[a-zA-Z0-9_-]{44}$/.test(id)) {
                throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¯44æ–‡å­—ã®è‹±æ•°å­—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
            }
            return true;
        }

        document.getElementById('setupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const serviceAccountJson = document.getElementById('serviceAccountJson').value.trim();
            const databaseSpreadsheetId = document.getElementById('databaseSpreadsheetId').value.trim();
            const setupBtn = document.getElementById('setupBtn');
            const testBtn = document.getElementById('testBtn');
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            try {
                validateJSON(serviceAccountJson);
                validateSpreadsheetId(databaseSpreadsheetId);
            } catch (error) {
                showAlert(`âŒ å…¥åŠ›ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return;
            }
            
            // UIæ›´æ–°
            setupBtn.disabled = true;
            setupBtn.innerHTML = '<span class="spinner"></span> ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè¡Œä¸­...';
            showAlert('ğŸ”„ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚’å®Ÿè¡Œä¸­...', 'info');
            
            // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè¡Œ
            google.script.run
                .withSuccessHandler(function(result) {
                    setupBtn.disabled = false;
                    setupBtn.innerHTML = 'âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†';
                    setupBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    
                    testBtn.style.display = 'block';
                    
                    showAlert('ğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åˆ©ç”¨ã‚’é–‹å§‹ã§ãã¾ã™ã€‚', 'success');
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ï¼‰
                    setTimeout(() => {
                        document.getElementById('serviceAccountJson').value = '';
                        showAlert('ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€å…¥åŠ›ã•ã‚ŒãŸJSONã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚', 'info');
                    }, 2000);
                })
                .withFailureHandler(function(error) {
                    setupBtn.disabled = false;
                    setupBtn.innerHTML = 'ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè¡Œ';
                    
                    let errorMessage = error.message || error.toString();
                    if (errorMessage.includes('authentication')) {
                        errorMessage = 'ğŸ”’ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONã‚­ãƒ¼ã¨APIè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else if (errorMessage.includes('spreadsheet')) {
                        errorMessage = 'ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚IDã¨å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else if (errorMessage.includes('permission')) {
                        errorMessage = 'ğŸš« æ¨©é™ã‚¨ãƒ©ãƒ¼: Google Cloud Consoleã§APIãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    }
                    
                    showAlert(`âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ${errorMessage}`, 'error');
                })
                .setupApplication(serviceAccountJson, databaseSpreadsheetId);
        });
        
        document.getElementById('testBtn').addEventListener('click', function() {
            const testBtn = document.getElementById('testBtn');
            
            testBtn.disabled = true;
            testBtn.innerHTML = '<span class="spinner"></span> ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
            showAlert('ğŸ§ª ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã®è¨ºæ–­ã‚’å®Ÿè¡Œä¸­...', 'info');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    testBtn.disabled = false;
                    testBtn.innerHTML = 'ğŸ§ª ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ãƒ†ã‚¹ãƒˆ';
                    
                    showAlert('âœ… è¨ºæ–­å®Œäº†: å…¨ã¦ã®æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚', 'success');
                })
                .withFailureHandler(function(error) {
                    testBtn.disabled = false;
                    testBtn.innerHTML = 'ğŸ§ª ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ãƒ†ã‚¹ãƒˆ';
                    
                    showAlert(`âš ï¸ è¨ºæ–­çµæœ: ${error.message}`, 'warning');
                })
                .testSetup();
        });
        
        // JSONãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        document.getElementById('serviceAccountJson').addEventListener('blur', function() {
            try {
                const value = this.value.trim();
                if (value) {
                    const parsed = JSON.parse(value);
                    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€private_keyã®ä¸€éƒ¨ã®ã¿è¡¨ç¤º
                    if (parsed.private_key) {
                        parsed.private_key = parsed.private_key.substring(0, 50) + '...[çœç•¥]';
                    }
                    showAlert('âœ… JSONå½¢å¼ãŒæ­£ã—ãæ¤œè¨¼ã•ã‚Œã¾ã—ãŸ', 'success');
                }
            } catch (e) {
                showAlert('âš ï¸ JSONå½¢å¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'warning');
            }
        });
    </script>
</body>
</html>