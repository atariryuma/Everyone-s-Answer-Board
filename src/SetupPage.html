<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyQuest - åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</title>
    <!-- Bootstrap CSS & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <?!= include('UnifiedStyles'); ?>
    <?!= include('SharedUtilities'); ?>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="text-center mb-5">
                    <h1 class="display-4 fw-bold text-info mb-2">ğŸ“š StudyQuest</h1>
                    <p class="fs-4 text-light">åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</p>
                    <p class="text-muted">ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨é–‹å§‹ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’è¡Œã„ã¾ã™</p>
                </div>

                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
                <div id="message-area" class="mb-4"></div>

                <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="glass-panel rounded-3 p-4 mb-4">
                    <h2 class="h4 fw-semibold text-white mb-4">ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>

                    <form id="setup-form">
                        <!-- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSON -->
                        <div class="mb-3">
                            <label for="service-account-json" class="form-label text-light">
                                ğŸ”‘ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONã‚­ãƒ¼
                            </label>
                            <textarea
                                id="service-account-json"
                                name="serviceAccountJson"
                                rows="8"
                                class="form-control bg-dark text-light font-monospace"
                                style="font-size: 0.75rem; resize: vertical;"
                                placeholder='{"type": "service_account", "project_id": "...", "private_key_id": "...", ...}'
                                required></textarea>
                            <div class="form-text text-muted">Google Cloud Consoleã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</div>
                        </div>

                        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID -->
                        <div class="mb-3">
                            <label for="database-id" class="form-label text-light">
                                ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
                            </label>
                            <input
                                type="text"
                                id="database-id"
                                name="databaseId"
                                class="form-control bg-dark text-light font-monospace"
                                placeholder="1BcD3fGhIjKlMnOpQrStUvWxYz0123456789ABCDEFGH"
                                pattern="[a-zA-Z0-9_\-]{44}"
                                maxlength="44"
                                required>
                            <div class="form-text text-muted">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç”¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ44æ–‡å­—ï¼‰</div>
                        </div>

                        <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ -->
                        <div class="d-grid">
                            <button
                                type="submit"
                                id="setup-btn"
                                class="btn btn-primary btn-lg fw-bold"
                                style="background: linear-gradient(to right, #0891b2, #2563eb); border: none;">
                                <span id="setup-text">ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹</span>
                                <div id="setup-spinner" class="spinner-border spinner-border-sm mx-auto d-none" role="status"></div>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¾Œã«è¡¨ç¤ºï¼‰ -->
                <div id="test-section" class="glass-panel rounded-3 p-4 d-none">
                    <h3 class="h5 fw-semibold text-white mb-3">âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†</h3>
                    <p class="text-light mb-3">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œç¢ºèªã‚’è¡Œãˆã¾ã™ã€‚</p>
                    <button
                        id="test-btn"
                        class="btn btn-success fw-bold me-2 mb-2"
                        style="background: linear-gradient(to right, #059669, #10b981); border: none;">
                        ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                    </button>
                    <button type="button" id="start-studyquest-btn" onclick="startApp()" class="btn fw-bold mb-2"
                        style="background: linear-gradient(to right, #7c3aed, #ec4899); border: none; color: white;">
                        ğŸ“š StudyQuestã‚’é–‹å§‹
                    </button>
                </div>

                <!-- ãƒ˜ãƒ«ãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="glass-panel rounded-3 p-4">
                    <h3 class="h5 fw-semibold text-white mb-3">â“ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ãŠå›°ã‚Šã®å ´åˆ</h3>
                    <div class="text-light">
                        <details class="mb-2" style="cursor: pointer;">
                            <summary class="fw-medium text-info">ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONã®å–å¾—æ–¹æ³•</summary>
                            <div class="mt-2 ps-3 text-muted small">
                                <ol class="list-unstyled">
                                    <li class="mb-1">1. Google Cloud Consoleã«ã‚¢ã‚¯ã‚»ã‚¹</li>
                                    <li class="mb-1">2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã¾ãŸã¯ä½œæˆ</li>
                                    <li class="mb-1">3. ã€ŒIAMã¨ç®¡ç†ã€â†’ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€</li>
                                    <li class="mb-1">4. ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã€</li>
                                    <li class="mb-1">5. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå¾Œã€ã€Œã‚­ãƒ¼ã€ã‚¿ãƒ–ã‹ã‚‰JSONã‚­ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                                </ol>
                            </div>
                        </details>
                        <details style="cursor: pointer;">
                            <summary class="fw-medium text-info">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã®å–å¾—æ–¹æ³•</summary>
                            <div class="mt-2 ps-3 text-muted small">
                                <ol class="list-unstyled">
                                    <li class="mb-1">1. Google Sheetsã§æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ</li>
                                    <li class="mb-1">2. URLã‹ã‚‰44æ–‡å­—ã®IDã‚’ã‚³ãƒ”ãƒ¼ï¼ˆ/d/ã®å¾Œã®éƒ¨åˆ†ï¼‰</li>
                                    <li class="mb-1">3. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ç·¨é›†è€…ã¨ã—ã¦è¿½åŠ </li>
                                </ol>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let setupInProgress = false;

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const colors = {
                success: 'bg-success bg-opacity-25 border-success text-green-100',
                error: 'bg-danger bg-opacity-25 border-danger text-danger',
                warning: 'bg-warning bg-opacity-25 border-warning text-warning',
                info: 'bg-primary bg-opacity-25 border-primary text-primary'
            };

            messageArea.innerHTML = `
                <div class="message show glass-panel rounded-lg p-4 border ${colors[type]}">
                    <div class="flex items-center">
                        <div class="mr-3">
                            ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}
                        </div>
                        <div class="flex-1">${message}</div>
                        <button onclick="this.closest('.message').style.display='none'" class="ms-3 text-muted">âœ•</button>
                    </div>
                </div>
            `;
        }

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
        function validateJSON(jsonString) {
            try {
                const parsed = JSON.parse(jsonString);
                const required = ['type', 'project_id', 'private_key_id', 'private_key', 'client_email'];
                for (const field of required) {
                    if (!parsed[field]) {
                        throw new Error(`å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ '${field}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                    }
                }
                if (parsed.type !== 'service_account') {
                    throw new Error('ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã®JSONã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                }
                return true;
            } catch (e) {
                throw new Error(`JSONå½¢å¼ãŒç„¡åŠ¹ã§ã™: ${e.message}`);
            }
        }

        function validateSpreadsheetId(id) {
            if (!id || id.length !== 44) {
                throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¯44æ–‡å­—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
            }
            if (!/^[a-zA-Z0-9_-]+$/.test(id)) {
                throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã«ç„¡åŠ¹ãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
            }
            return true;
        }

        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        document.getElementById('setup-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (setupInProgress) return;
            setupInProgress = true;

            const setupBtn = document.getElementById('setup-btn');
            const setupText = document.getElementById('setup-text');
            const setupSpinner = document.getElementById('setup-spinner');

            try {
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’å¤‰æ›´
                setupBtn.disabled = true;
                setupText.style.display = 'none';
                setupSpinner.classList.remove('hidden');

                // å…¥åŠ›å€¤å–å¾—
                const serviceAccountJson = document.getElementById('service-account-json').value.trim();
                const databaseId = document.getElementById('database-id').value.trim();

                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                validateJSON(serviceAccountJson);
                validateSpreadsheetId(databaseId);

                showMessage('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œä¸­...', 'info');

                // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè¡Œ
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler((result) => {
                            showMessage('âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                            document.getElementById('test-section').classList.remove('hidden');
                            resolve(result);
                        })
                        .withFailureHandler((error) => {
                            console.error('Setup error:', error);
                            let displayMessage = `âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`;
                            if (error.message && error.message.includes('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šãŒã€Œåˆ¶é™ä»˜ãã€ã«ãªã£ã¦ã„ã¾ã›ã‚“')) {
                                displayMessage = `
                                    <p class="font-bold">${error.message}</p>
                                    <p class="mt-2">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’ã€Œåˆ¶é™ä»˜ãã€ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
                                    <p>å¤‰æ›´æ–¹æ³•: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ãã€ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ â†’ ã€Œä¸€èˆ¬çš„ãªã‚¢ã‚¯ã‚»ã‚¹ã€ã‚’ã€Œåˆ¶é™ä»˜ãã€ã«å¤‰æ›´ã€‚</p>
                                `;
                            }
                            showMessage(displayMessage, 'error');
                            reject(error);
                        })
                        .setupApplication(serviceAccountJson, databaseId);
                });

            } catch (error) {
                showMessage(`âŒ ${error.message}`, 'error');
            } finally {
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                setupBtn.disabled = false;
                setupText.style.display = 'inline';
                setupSpinner.classList.add('hidden');
                setupInProgress = false;
            }
        });

        // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³å‡¦ç†
        document.getElementById('test-btn').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<div class="loading-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mx-auto"></div>';

            google.script.run
                .withSuccessHandler((result) => {
                    showMessage(`${result.message}`, result.status === 'success' ? 'success' : 'warning');
                    this.disabled = false;
                    this.innerHTML = 'ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ';
                })
                .withFailureHandler((error) => {
                    showMessage(`ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`, 'error');
                    this.disabled = false;
                    this.innerHTML = 'ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ';
                })
                .testSetup();
        });

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        document.getElementById('service-account-json').addEventListener('blur', function() {
            try {
                if (this.value.trim()) {
                    validateJSON(this.value.trim());
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
            } catch (e) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });

        document.getElementById('database-id').addEventListener('input', function() {
            try {
                if (this.value.trim()) {
                    validateSpreadsheetId(this.value.trim());
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
            } catch (e) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });

        function startApp() {
            const btn = document.getElementById('start-studyquest-btn');
            if (btn) {
                btn.innerHTML = '<span>èª­ã¿è¾¼ã¿ä¸­...</span>';
                btn.disabled = true;
            }

            google.script.run
                .withSuccessHandler(function(url) {
                    window.top.location.href = url;
                })
                .withFailureHandler(function(error) {
                    alert('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®URLå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    if (btn) {
                        btn.innerHTML = 'ğŸ“š StudyQuestã‚’é–‹å§‹';
                        btn.disabled = false;
                    }
                })
                .getWebAppUrl();
        }
    </script>
</body>
</html>
