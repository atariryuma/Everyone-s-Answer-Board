<script>
/**
 * AppSetupPage デバッグモード制御機能モジュール
 * DEBUG_MODE設定の管理と切り替え
 */

// グローバル変数
let debugModeState = null;
let debugModeLoading = false;

/**
 * デバッグモードの状態を読み込み
 */
function loadDebugModeStatus() {
    debugModeLoading = true;
    
    google.script.run
        .withSuccessHandler(result => {
            debugModeLoading = false;
            
            if (result.status === 'success') {
                debugModeState = result.debugMode;
                updateDebugModeUI();
            } else {
                console.error('Failed to load debug mode status:', result);
                showDebugModeError('デバッグモード状態の取得に失敗しました');
            }
        })
        .withFailureHandler(error => {
            debugModeLoading = false;
            console.error('Load debug mode status error:', error);
            showDebugModeError('デバッグモード状態の取得に失敗しました: ' + error.message);
        })
        .getDebugModeStatus();
}

/**
 * デバッグモードUIを更新
 */
function updateDebugModeUI() {
    const toggle = document.getElementById('debugModeToggle');
    const statusText = document.getElementById('debug-mode-status');
    const lastModifiedText = document.getElementById('debug-mode-last-modified');
    
    if (toggle && debugModeState !== null) {
        toggle.checked = debugModeState;
    }
    
    if (statusText) {
        const statusIcon = debugModeState ? '🟢' : '🔴';
        const statusMessage = debugModeState ? 'デバッグモードが有効です' : 'デバッグモードが無効です';
        const statusClass = debugModeState ? 'text-green-400' : 'text-red-400';
        
        statusText.innerHTML = `<span class="${statusClass}">${statusIcon} ${statusMessage}</span>`;
    }
    
    // 最終更新時刻を表示（利用可能な場合）
    if (lastModifiedText) {
        lastModifiedText.textContent = ''; // 必要に応じて実装
    }
}

/**
 * デバッグモードエラー表示
 */
function showDebugModeError(errorMessage) {
    const statusText = document.getElementById('debug-mode-status');
    if (statusText) {
        statusText.innerHTML = `<span class="text-red-400">❌ ${errorMessage}</span>`;
    }
}

/**
 * デバッグモード状態を切り替え
 */
function toggleDebugModeState() {
    const toggle = document.getElementById('debugModeToggle');
    const updateBtn = document.getElementById('updateDebugModeBtn');
    const spinner = document.getElementById('debug-update-spinner');
    const text = document.getElementById('debug-update-text');

    if (!toggle || debugModeLoading) return;

    const newState = toggle.checked;
    debugModeLoading = true;

    // UI feedback
    if (updateBtn) updateBtn.disabled = true;
    if (spinner) spinner.classList.remove('hidden');
    if (text) text.classList.add('hidden');

    google.script.run
        .withSuccessHandler(result => {
            debugModeLoading = false;
            
            if (result.status === 'success') {
                debugModeState = result.debugMode;
                updateDebugModeUI();
                
                // 成功メッセージを表示
                showDebugModeSuccessMessage(newState);
            } else {
                console.error('Failed to toggle debug mode:', result);
                // UI をロールバック
                if (toggle) toggle.checked = debugModeState;
                showDebugModeError('デバッグモード切り替えに失敗しました: ' + result.message);
            }
            
            // UI復元
            if (updateBtn) updateBtn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            if (text) text.classList.remove('hidden');
        })
        .withFailureHandler(error => {
            debugModeLoading = false;
            console.error('Toggle debug mode error:', error);
            
            // UI をロールバック
            if (toggle) toggle.checked = debugModeState;
            showDebugModeError('デバッグモード切り替えに失敗しました: ' + error.message);
            
            // UI復元
            if (updateBtn) updateBtn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            if (text) text.classList.remove('hidden');
        })
        .toggleDebugMode(newState);
}

/**
 * デバッグモード切り替え成功メッセージを表示
 */
function showDebugModeSuccessMessage(newState) {
    const statusText = document.getElementById('debug-mode-status');
    if (!statusText) return;
    
    const message = newState ? 'デバッグモードを有効にしました' : 'デバッグモードを無効にしました';
    const icon = newState ? '✅' : '⚪';
    const color = newState ? 'text-green-400' : 'text-gray-400';
    
    // 一時的に成功メッセージを表示
    statusText.innerHTML = `<span class="${color}">${icon} ${message}</span>`;
    
    // 3秒後に通常の状態表示に戻す
    setTimeout(() => {
        updateDebugModeUI();
    }, 3000);
}

/**
 * デバッグモード情報の詳細を表示
 */
function showDebugModeInfo() {
    const infoHtml = `
        <div class="bg-gray-800 border border-gray-600 rounded-lg p-4 mt-4">
            <h4 class="text-white font-semibold mb-3">🐛 デバッグモードについて</h4>
            <div class="space-y-2 text-sm text-gray-300">
                <div><strong>有効時:</strong> 詳細ログ、API詳細情報、UI可視化、エラー完全表示</div>
                <div><strong>無効時:</strong> 軽量ログ、パフォーマンス最適化、必要最小限情報</div>
                <div><strong>影響範囲:</strong> PropertiesServiceで管理され、全ユーザーに影響</div>
                <div><strong>推奨:</strong> 本番環境では無効、開発・デバッグ時のみ有効</div>
            </div>
        </div>
    `;
    
    // 既存の情報があれば削除
    const existingInfo = document.getElementById('debug-mode-info');
    if (existingInfo) {
        existingInfo.remove();
        return;
    }
    
    // 新しい情報を追加
    const debugSection = document.querySelector('.glass-panel h2:contains("🐛 デバッグモード制御")');
    if (debugSection && debugSection.parentElement) {
        const infoDiv = document.createElement('div');
        infoDiv.id = 'debug-mode-info';
        infoDiv.innerHTML = infoHtml;
        debugSection.parentElement.appendChild(infoDiv);
    }
}

/**
 * デバッグログのクリア（開発用）
 */
function clearDebugLogs() {
    if (!confirm('デバッグログをクリアしますか？')) {
        return;
    }
    
    try {
        // ブラウザコンソールをクリア
        console.clear();
        
        // 成功メッセージ
        console.log('🧹 デバッグログをクリアしました');
        
        // UI通知
        const statusText = document.getElementById('debug-mode-status');
        if (statusText) {
            const originalContent = statusText.innerHTML;
            statusText.innerHTML = '<span class="text-blue-400">🧹 ログをクリアしました</span>';
            
            setTimeout(() => {
                statusText.innerHTML = originalContent;
            }, 2000);
        }
    } catch (error) {
        console.error('Failed to clear debug logs:', error);
    }
}

/**
 * デバッグ情報の収集と表示
 */
function collectDebugInfo() {
    const debugInfo = {
        timestamp: new Date().toISOString(),
        debugMode: debugModeState,
        userAgent: navigator.userAgent,
        url: window.location.href,
        localStorage: {
            diagnosticHistoryCount: 0,
            adminPanelUrlCache: null
        }
    };
    
    // localStorageの情報を安全に取得
    try {
        const diagnosticHistory = localStorage.getItem('diagnosticHistoryCache');
        debugInfo.localStorage.diagnosticHistoryCount = diagnosticHistory ? JSON.parse(diagnosticHistory).length : 0;
        
        const adminPanelUrl = localStorage.getItem('adminPanelUrlCache');
        debugInfo.localStorage.adminPanelUrlCache = adminPanelUrl ? 'cached' : 'not cached';
    } catch (error) {
        debugInfo.localStorage.error = error.message;
    }
    
    // コンソールに出力
    console.group('🔍 デバッグ情報');
    console.table(debugInfo);
    console.groupEnd();
    
    // UI通知
    const statusText = document.getElementById('debug-mode-status');
    if (statusText) {
        const originalContent = statusText.innerHTML;
        statusText.innerHTML = '<span class="text-blue-400">🔍 デバッグ情報をコンソールに出力しました</span>';
        
        setTimeout(() => {
            statusText.innerHTML = originalContent;
        }, 3000);
    }
    
    return debugInfo;
}
</script>