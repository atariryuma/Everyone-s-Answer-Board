<script>
/**
 * AppSetupPage ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡æ©Ÿèƒ½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
 * DEBUG_MODEè¨­å®šã®ç®¡ç†ã¨åˆ‡ã‚Šæ›¿ãˆ
 */

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let debugModeState = null;
let debugModeLoading = false;

/**
 * ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿
 */
function loadDebugModeStatus() {
    debugModeLoading = true;
    
    google.script.run
        .withSuccessHandler(result => {
            debugModeLoading = false;
            
            if (result.status === 'success') {
                debugModeState = result.debugMode;
                updateDebugModeUI();
            } else {
                console.error('Failed to load debug mode status:', result);
                showDebugModeError('ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .withFailureHandler(error => {
            debugModeLoading = false;
            console.error('Load debug mode status error:', error);
            showDebugModeError('ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getDebugModeStatus();
}

/**
 * ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰UIã‚’æ›´æ–°
 */
function updateDebugModeUI() {
    const toggle = document.getElementById('debugModeToggle');
    const statusText = document.getElementById('debug-mode-status');
    const lastModifiedText = document.getElementById('debug-mode-last-modified');
    
    if (toggle && debugModeState !== null) {
        toggle.checked = debugModeState;
    }
    
    if (statusText) {
        const statusIcon = debugModeState ? 'ğŸŸ¢' : 'ğŸ”´';
        const statusMessage = debugModeState ? 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ã™' : 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã§ã™';
        const statusClass = debugModeState ? 'text-green-400' : 'text-red-400';
        
        statusText.innerHTML = `<span class="${statusClass}">${statusIcon} ${statusMessage}</span>`;
    }
    
    // æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’è¡¨ç¤ºï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
    if (lastModifiedText) {
        lastModifiedText.textContent = ''; // å¿…è¦ã«å¿œã˜ã¦å®Ÿè£…
    }
}

/**
 * ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
 */
function showDebugModeError(errorMessage) {
    const statusText = document.getElementById('debug-mode-status');
    if (statusText) {
        statusText.innerHTML = `<span class="text-red-400">âŒ ${errorMessage}</span>`;
    }
}

/**
 * ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
 */
function toggleDebugModeState() {
    const toggle = document.getElementById('debugModeToggle');
    const updateBtn = document.getElementById('updateDebugModeBtn');
    const spinner = document.getElementById('debug-update-spinner');
    const text = document.getElementById('debug-update-text');

    if (!toggle || debugModeLoading) return;

    const newState = toggle.checked;
    debugModeLoading = true;

    // UI feedback
    if (updateBtn) updateBtn.disabled = true;
    if (spinner) spinner.classList.remove('hidden');
    if (text) text.classList.add('hidden');

    google.script.run
        .withSuccessHandler(result => {
            debugModeLoading = false;
            
            if (result.status === 'success') {
                debugModeState = result.debugMode;
                updateDebugModeUI();
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                showDebugModeSuccessMessage(newState);
            } else {
                console.error('Failed to toggle debug mode:', result);
                // UI ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (toggle) toggle.checked = debugModeState;
                showDebugModeError('ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
            }
            
            // UIå¾©å…ƒ
            if (updateBtn) updateBtn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            if (text) text.classList.remove('hidden');
        })
        .withFailureHandler(error => {
            debugModeLoading = false;
            console.error('Toggle debug mode error:', error);
            
            // UI ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if (toggle) toggle.checked = debugModeState;
            showDebugModeError('ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            
            // UIå¾©å…ƒ
            if (updateBtn) updateBtn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            if (text) text.classList.remove('hidden');
        })
        .toggleDebugMode(newState);
}

/**
 * ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
 */
function showDebugModeSuccessMessage(newState) {
    const statusText = document.getElementById('debug-mode-status');
    if (!statusText) return;
    
    const message = newState ? 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ' : 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸ';
    const icon = newState ? 'âœ…' : 'âšª';
    const color = newState ? 'text-green-400' : 'text-gray-400';
    
    // ä¸€æ™‚çš„ã«æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    statusText.innerHTML = `<span class="${color}">${icon} ${message}</span>`;
    
    // 3ç§’å¾Œã«é€šå¸¸ã®çŠ¶æ…‹è¡¨ç¤ºã«æˆ»ã™
    setTimeout(() => {
        updateDebugModeUI();
    }, 3000);
}

/**
 * ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æƒ…å ±ã®è©³ç´°ã‚’è¡¨ç¤º
 */
function showDebugModeInfo() {
    const infoHtml = `
        <div class="bg-gray-800 border border-gray-600 rounded-lg p-4 mt-4">
            <h4 class="text-white font-semibold mb-3">ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦</h4>
            <div class="space-y-2 text-sm text-gray-300">
                <div><strong>æœ‰åŠ¹æ™‚:</strong> è©³ç´°ãƒ­ã‚°ã€APIè©³ç´°æƒ…å ±ã€UIå¯è¦–åŒ–ã€ã‚¨ãƒ©ãƒ¼å®Œå…¨è¡¨ç¤º</div>
                <div><strong>ç„¡åŠ¹æ™‚:</strong> è»½é‡ãƒ­ã‚°ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€å¿…è¦æœ€å°é™æƒ…å ±</div>
                <div><strong>å½±éŸ¿ç¯„å›²:</strong> PropertiesServiceã§ç®¡ç†ã•ã‚Œã€å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å½±éŸ¿</div>
                <div><strong>æ¨å¥¨:</strong> æœ¬ç•ªç’°å¢ƒã§ã¯ç„¡åŠ¹ã€é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°æ™‚ã®ã¿æœ‰åŠ¹</div>
            </div>
        </div>
    `;
    
    // æ—¢å­˜ã®æƒ…å ±ãŒã‚ã‚Œã°å‰Šé™¤
    const existingInfo = document.getElementById('debug-mode-info');
    if (existingInfo) {
        existingInfo.remove();
        return;
    }
    
    // æ–°ã—ã„æƒ…å ±ã‚’è¿½åŠ 
    const debugSection = document.querySelector('.glass-panel h2:contains("ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡")');
    if (debugSection && debugSection.parentElement) {
        const infoDiv = document.createElement('div');
        infoDiv.id = 'debug-mode-info';
        infoDiv.innerHTML = infoHtml;
        debugSection.parentElement.appendChild(infoDiv);
    }
}

/**
 * ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ã‚¯ãƒªã‚¢ï¼ˆé–‹ç™ºç”¨ï¼‰
 */
function clearDebugLogs() {
    if (!confirm('ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    
    try {
        // ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ã‚¯ãƒªã‚¢
        console.clear();
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        console.log('ğŸ§¹ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        
        // UIé€šçŸ¥
        const statusText = document.getElementById('debug-mode-status');
        if (statusText) {
            const originalContent = statusText.innerHTML;
            statusText.innerHTML = '<span class="text-blue-400">ğŸ§¹ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</span>';
            
            setTimeout(() => {
                statusText.innerHTML = originalContent;
            }, 2000);
        }
    } catch (error) {
        console.error('Failed to clear debug logs:', error);
    }
}

/**
 * ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®åé›†ã¨è¡¨ç¤º
 */
function collectDebugInfo() {
    const debugInfo = {
        timestamp: new Date().toISOString(),
        debugMode: debugModeState,
        userAgent: navigator.userAgent,
        url: window.location.href,
        localStorage: {
            diagnosticHistoryCount: 0,
            adminPanelUrlCache: null
        }
    };
    
    // localStorageã®æƒ…å ±ã‚’å®‰å…¨ã«å–å¾—
    try {
        const diagnosticHistory = localStorage.getItem('diagnosticHistoryCache');
        debugInfo.localStorage.diagnosticHistoryCount = diagnosticHistory ? JSON.parse(diagnosticHistory).length : 0;
        
        const adminPanelUrl = localStorage.getItem('adminPanelUrlCache');
        debugInfo.localStorage.adminPanelUrlCache = adminPanelUrl ? 'cached' : 'not cached';
    } catch (error) {
        debugInfo.localStorage.error = error.message;
    }
    
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
    console.group('ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±');
    console.table(debugInfo);
    console.groupEnd();
    
    // UIé€šçŸ¥
    const statusText = document.getElementById('debug-mode-status');
    if (statusText) {
        const originalContent = statusText.innerHTML;
        statusText.innerHTML = '<span class="text-blue-400">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸ</span>';
        
        setTimeout(() => {
            statusText.innerHTML = originalContent;
        }, 3000);
    }
    
    return debugInfo;
}
</script>