<script>
// =============================================================================
// ADMIN PANEL EVENT LISTENERS & UI INTERACTIONS
// =============================================================================

// DOM Elements Cache
var elements = {};

// Event handler state tracking to prevent duplicate attachments
var eventHandlersAttached = {
  setupEventListeners: false,
  formConfigModal: false,
  resourceHandlers: false,
  accountManagement: false,
  externalLinks: false,
  modalHandlers: false,
  realtimeValidation: false
};

// 履歴管理用定数 - adminPanel-ui.js.htmlで定義済みのため、ここでは参照のみ
// const HISTORY_STORAGE_KEY = 'answerBoardHistory'; // 重複宣言を回避

// =============================================================================
// MAIN EVENT LISTENERS SETUP
// =============================================================================

function setupEventListeners() {
  // Prevent duplicate event handler attachment
  if (eventHandlersAttached.setupEventListeners) {
    console.log('CRITICAL: Event handlers already attached, skipping duplicate setup');
    return;
  }
  
  eventHandlersAttached.setupEventListeners = true;
  
  // Cache frequently used elements
  elements = {
    'sheet-select': getCachedElement('sheet-select'),
    'save-publish-btn': getCachedElement('save-publish-btn'),
    'unpublish-board-btn': getCachedElement('unpublish-board-btn'),
    'delete-account-btn': getCachedElement('delete-account-btn'),
    'open-spreadsheet-btn': getCachedElement('open-spreadsheet-btn'),
    'open-form-btn': getCachedElement('open-form-btn')
  };
  
  
  // AI column detection button - Safe event handling
  var reguessBtn = document.getElementById('reguess-headers-btn');
  if (reguessBtn) {
    reguessBtn.addEventListener('click', function() {
      if (typeof runHeaderGuessing === 'function') {
        runHeaderGuessing();
      } else {
        console.error('CRITICAL: runHeaderGuessing is not available');
        showMessage('AI列判定機能が利用できません。ページを再読み込みしてください。', 'warning');
      }
    });
  }
  
  // Save and publish button
  if (elements['save-publish-btn']) {
    elements['save-publish-btn'].addEventListener('click', function() {
      if (!selectedSheet) {
        showMessage('まずシートを選択してください。', 'warning');
        return;
      }
      saveAndPublish();
    });
  }
  
  // Unpublish button
  if (elements['unpublish-board-btn']) {
    elements['unpublish-board-btn'].addEventListener('click', function() {
      showStopConfirmationModal(
        '公開停止の確認',
        '回答ボードの公開を停止しますか？',
        function() {
          unpublishBoard()
            .then(function(unpublishResult) {
              console.log('✅ 公開停止完了:', unpublishResult);
              
              // unpublishBoard()内で既にキャッシュクリア処理が実行されているため、
              // ここでは重複処理を避けて、状態同期に集中
              console.log('🔄 公開停止後の状態同期を開始（キャッシュクリア済み）');
              
              // 改善された非同期処理完了待機
              return new Promise(async (resolve) => {
                try {
                  // Step 1: DOM状態の安定化待機（短縮）
                  await new Promise(r => setTimeout(r, 300));
                  
                  // Step 2: 状態再読み込み（強制リフレッシュ）
                  await loadStatus(true);
                  console.log('🔄 公開停止後の状態更新完了');
                  
                  // Step 3: 最終的なUI状態確認
                  await new Promise(r => setTimeout(r, 100));
                  
                  resolve(unpublishResult);
                } catch (error) {
                  console.warn('⚠️ 状態同期エラー:', error);
                  resolve(unpublishResult); // エラーでも続行
                }
              });
            })
            .then(function() {
              console.log('🔧 公開停止後の完全リセットUI更新開始');
              
              // ステップ1に戻すためのUI更新
              if (typeof updateStepIndicators === 'function') {
                console.log('🎯 updateStepIndicators実行中: ステップ1に完全リセット');
                updateStepIndicators(1, null);
              } else {
                console.warn('⚠️ updateStepIndicators関数が見つかりません');
              }
              
              if (typeof updateGuidanceForStep === 'function') {
                const guidanceText = document.getElementById('guidance-text');
                if (guidanceText) {
                  console.log('🎯 updateGuidanceForStep実行中: ステップ1ガイダンス');
                  updateGuidanceForStep(1, guidanceText);
                } else {
                  console.warn('⚠️ guidance-text要素が見つかりません');
                }
              } else {
                console.warn('⚠️ updateGuidanceForStep関数が見つかりません');
              }
              
              // フォーム関連要素の初期化
              try {
                console.log('🧹 フォーム関連UI要素を初期状態にリセット');
                
                // シート選択ドロップダウンをクリア
                const sheetSelect = document.getElementById('sheet-select');
                if (sheetSelect) {
                  sheetSelect.innerHTML = '<option value="">シートを選択してください</option>';
                  sheetSelect.selectedIndex = 0;
                  console.log('✅ シート選択ドロップダウンをリセット');
                }
                
                // 列設定フォームをクリア
                const columnSelects = ['opinion-column', 'name-column', 'reason-column', 'class-column'];
                columnSelects.forEach(selectId => {
                  const selectElement = document.getElementById(selectId);
                  if (selectElement) {
                    selectElement.innerHTML = '<option value="">選択してください</option>';
                    selectElement.selectedIndex = 0;
                  }
                });
                console.log('✅ 列設定フォームをリセット');
                
                // チェックボックスの初期化
                const checkboxes = ['show-names', 'show-counts'];
                checkboxes.forEach(checkboxId => {
                  const checkbox = document.getElementById(checkboxId);
                  if (checkbox) {
                    checkbox.checked = false;
                  }
                });
                console.log('✅ 表示設定チェックボックスをリセット');
                
              } catch (resetError) {
                console.warn('⚠️ UI要素リセット中にエラー:', resetError);
              }
              
              console.log('✅ 公開停止後の完全リセットUI更新完了');
              showMessage('回答ボードは非公開になり、設定は初期状態にリセットされました。', 'success');
            })
            .catch(function(error) {
              console.error('❌ 公開停止に失敗しました:', error);
              let errorMessage = '❌ 公開停止に失敗しました。再度お試しください。';
              
              // エラーの種類に応じてより具体的なメッセージを表示
              if (error.message && error.message.includes('customFormInfo')) {
                errorMessage = '❌ カスタムフォーム設定の更新に失敗しました。ページを再読み込みしてから再度お試しください。';
              } else if (error.message && error.message.includes('許可されていない')) {
                errorMessage = '❌ データ更新権限エラーが発生しました。管理者にお問い合わせください。';
              } else if (error.message && error.message.includes('ネットワーク')) {
                errorMessage = '❌ ネットワークエラーが発生しました。インターネット接続を確認してください。';
              }
              
              showMessage(errorMessage, 'error');
            });
        }
      );
    });
  }
  
  // クイックスタートボタンのイベントリスナー
  var quickstartBtn = document.getElementById('quickstart-btn');
  if (quickstartBtn) {
    quickstartBtn.addEventListener('click', function() {
      if (typeof handleQuickStart === 'function') {
        handleQuickStart();
      } else {
        console.error('handleQuickStart function not found');
        showMessage('クイックスタート機能を読み込み中です。少し待ってから再度お試しください。', 'warning');
      }
    });
  }

  // Create board button
  var createBoardBtn = document.getElementById('create-board-btn');
  if (createBoardBtn) {
    createBoardBtn.addEventListener('click', function() {
      // 公開状態をチェックしてカスタムセットアップ選択モーダルを表示
      if (currentStatus && currentStatus._normalized && currentStatus._normalized.isPublished) {
        // 公開中の場合、選択モーダルを表示
        window.sharedModals.showCustomSetupSelection(
          (selectedOption) => {
            if (selectedOption === 'stop') {
              // 停止して作成を選択
              proceedWithCustomFormCreation(true);
            } else if (selectedOption === 'continue') {
              // 継続しながら作成を選択
              proceedWithCustomFormCreation(false);
            }
          },
          () => {
            console.log('❌ カスタムセットアップがキャンセルされました');
          }
        );
      } else {
        // 公開していない場合、直接フォーム作成モーダルを表示
        proceedWithCustomFormCreation(false);
      }
    });
  }

  // カスタムフォーム作成を進行
  function proceedWithCustomFormCreation(shouldStop) {
    if (shouldStop) {
      
      // 実際に公開停止処理を実行
      if (typeof unpublishBoard === 'function') {
        console.log('🛑 公開停止処理を開始します...');
        
        // 公開停止の確認ダイアログを表示
        showStopConfirmationModal(
          '公開停止の確認',
          '現在公開中のボードを停止してから、カスタムフォームを作成します。よろしいですか？',
          function() {
            // 確認後、実際に停止処理を実行
            executeStopAndCreateForm();
          },
          function() {
            console.log('❌ 公開停止がキャンセルされました');
          }
        );
      } else {
        console.error('unpublishBoard function not found');
        showMessage('公開停止機能を読み込み中です。少し待ってから再度お試しください。', 'warning');
      }
    } else {
      
      // カスタムセットアップ時は全セクション展開フラグを設定
      try {
        localStorage.setItem('expandAllSections', 'true');
      } catch (e) {
        console.warn('⚠️ localStorage設定に失敗:', e);
      }
      
      // 継続の場合は直接フォーム作成モーダルを表示
      showFormConfigModalSafely();
    }
  }

  // 公開停止→フォーム作成の実行
  function executeStopAndCreateForm() {

    // unpublishBoard関数を呼び出し
    unpublishBoard()
      .then(function(response) {
        // Use debounced loadStatus to prevent rapid successive calls
        if (window.AdminPanel && window.AdminPanel.debounce) {
          window.AdminPanel.debounce.loadStatus(() => loadStatus(true), 300);
          return Promise.resolve(response);
        } else {
          return loadStatus(true).then(() => response);
        }
      })
      .then(function(response) {
        // 公開停止が確実に完了した旨を表示
        showMessage('✅ 公開停止が完了しました。カスタムフォームを作成できます。', 'success');

        // 全セクション展開フラグを設定（公開停止後の管理パネル表示改善）
        try {
          localStorage.setItem('expandAllSections', 'true');
          console.log('📂 公開停止後の全セクション展開フラグを設定しました');
        } catch (e) {
          console.warn('⚠️ localStorage設定に失敗:', e);
        }

        // 少し遅延してからフォーム作成モーダルを表示
        setTimeout(function() {
          console.log('🎨 フォーム作成モーダルを表示します');
          showFormConfigModalSafely();
        }, 1500); // 1.5秒後に表示（UIフィードバック時間を確保）
      })
      .catch(function(error) {
        console.error('❌ 公開停止に失敗しました:', error);
        let errorMessage = '❌ 公開停止に失敗しました。再度お試しください。';
        
        // エラーの種類に応じてより具体的なメッセージを表示
        if (error.message && error.message.includes('customFormInfo')) {
          errorMessage = '❌ カスタムフォーム設定の更新に失敗しました。ページを再読み込みしてから再度お試しください。';
        } else if (error.message && error.message.includes('許可されていない')) {
          errorMessage = '❌ データ更新権限エラーが発生しました。管理者にお問い合わせください。';
        } else if (error.message && error.message.includes('ネットワーク')) {
          errorMessage = '❌ ネットワークエラーが発生しました。インターネット接続を確認してください。';
        }
        
        showMessage(errorMessage, 'error');
      });
  }

  // 安全なフォーム作成モーダル表示
  function showFormConfigModalSafely() {
    if (typeof showFormConfigModal === 'function') {
      showFormConfigModal();
    } else {
      console.error('showFormConfigModal function not found');
      showMessage('フォーム作成機能を読み込み中です。少し待ってから再度お試しください。', 'warning');
    }
  }

  // Create additional form button
  var createAdditionalFormBtn = document.getElementById('create-additional-form-btn');
  if (createAdditionalFormBtn) {
    createAdditionalFormBtn.addEventListener('click', function() {
      if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
        showMessage('スプレッドシートの情報が見つかりません。', 'error');
        return;
      }
      showFormConfigModal();
    });
  }
  
  // Form configuration modal handlers
  setupFormConfigModalHandlers();
  
  // Resource management
  setupResourceHandlers();
  
  // Account management
  setupAccountManagementHandlers();
  
  // External links
  setupExternalLinkHandlers();
  
  // Modal handlers
  setupModalHandlers();
  
  // Real-time validation
  setupRealtimeValidation();
  
}

// =============================================================================
// FORM CONFIGURATION MODAL HANDLERS
// =============================================================================

function setupFormConfigModalHandlers() {
  if (eventHandlersAttached.formConfigModal) {
    logDebug('Form config modal handlers already attached');
    return;
  }
  eventHandlersAttached.formConfigModal = true;
  
  var formConfigClose = document.getElementById('form-config-close');
  var formConfigCancel = document.getElementById('form-config-cancel');
  var formConfigCreate = document.getElementById('form-config-create');
  
  if (formConfigClose) {
    formConfigClose.addEventListener('click', function() {
      if (typeof hideFormConfigModal === 'function') {
        hideFormConfigModal();
      } else {
        console.warn('hideFormConfigModal not available');
      }
    });
  }
  
  if (formConfigCancel) {
    formConfigCancel.addEventListener('click', function() {
      if (typeof hideFormConfigModal === 'function') {
        hideFormConfigModal();
      } else {
        console.warn('hideFormConfigModal not available');
      }
    });
  }
  
  if (formConfigCreate && typeof createFormWithConfig === 'function') {
    formConfigCreate.addEventListener('click', createFormWithConfig);
  }
}

// =============================================================================
// RESOURCE MANAGEMENT HANDLERS
// =============================================================================

function setupResourceHandlers() {
  if (eventHandlersAttached.resourceHandlers) {
    logDebug('Resource handlers already attached');
    return;
  }
  eventHandlersAttached.resourceHandlers = true;
  
  var addResourceBtn = document.getElementById('add-resource-btn');
  var resourceUrlInput = document.getElementById('resource-url-input');
  var initializeSettingsBtn = document.getElementById('initialize-settings-btn');
  
  if (addResourceBtn) {
    addResourceBtn.addEventListener('click', addResource);
  }
  
  if (resourceUrlInput) {
    resourceUrlInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addResource();
      }
    });
  }
  
  if (initializeSettingsBtn) {
    initializeSettingsBtn.addEventListener('click', initializeUserSettingsWithUI);
  }
}

// =============================================================================
// ACCOUNT MANAGEMENT HANDLERS
// =============================================================================

function setupAccountManagementHandlers() {
  if (eventHandlersAttached.accountManagement) {
    logDebug('Account management handlers already attached');
    return;
  }
  eventHandlersAttached.accountManagement = true;
  
  // Delete account handler - 防御的実装
  const deleteBtn = elements['delete-account-btn'] || getCachedElement('delete-account-btn');
  if (deleteBtn) {
    // 重複登録防止のためフラグで管理
    if (!deleteBtn._deleteListenerAttached) {
      deleteBtn.addEventListener('click', handleDeleteRequest);
      deleteBtn._deleteListenerAttached = true;
      if (window.DEBUG_MODE || window.location.hostname === 'localhost') {
        console.log('Delete account button event listener attached successfully');
      }
    }
  } else {
    console.warn('Delete account button not found');
  }
  
  // Switch account handlers
  var switchAccountBtns = document.querySelectorAll('[onclick*="switchToAnotherAccount"]');
  switchAccountBtns.forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      switchToAnotherAccount();
    });
  });
}

// =============================================================================
// EXTERNAL LINK HANDLERS
// =============================================================================

function setupExternalLinkHandlers() {
  if (eventHandlersAttached.externalLinks) {
    logDebug('External link handlers already attached');
    return;
  }
  eventHandlersAttached.externalLinks = true;
  
  // Open spreadsheet
  if (elements['open-spreadsheet-btn']) {
    elements['open-spreadsheet-btn'].addEventListener('click', openDatabaseSpreadsheet);
  }
  
  // Open form
  if (elements['open-form-btn']) {
    elements['open-form-btn'].addEventListener('click', openForm);
  }
  
  // Digital citizenship
  var digitalCitizenshipBtn = document.getElementById('digital-citizenship-btn');
  if (digitalCitizenshipBtn) {
    digitalCitizenshipBtn.addEventListener('click', showDigitalCitizenshipModal);
  }
  
  // Copy board URL
  var copyUrlBtn = document.getElementById('copy-url-btn');
  if (copyUrlBtn) {
    copyUrlBtn.addEventListener('click', copyBoardUrl);
  }
  
  // Copy form URL
  var copyFormUrlBtn = document.getElementById('copy-form-url-btn');
  if (copyFormUrlBtn) {
    copyFormUrlBtn.addEventListener('click', copyFormUrl);
  }
}

// =============================================================================
// MODAL HANDLERS
// =============================================================================

function setupModalHandlers() {
  if (eventHandlersAttached.modalHandlers) {
    logDebug('Modal handlers already attached');
    return;
  }
  eventHandlersAttached.modalHandlers = true;
  
  // Privacy modal
  var privacyClose = document.getElementById('privacy-modal-close');
  var privacyCancel = document.getElementById('privacy-modal-cancel');
  
  if (privacyClose) {
    privacyClose.addEventListener('click', hidePrivacyModal);
  }
  
  if (privacyCancel) {
    privacyCancel.addEventListener('click', hidePrivacyModal);
  }
  
  // Digital citizenship modal
  var dcClose = document.getElementById('digital-citizenship-close');
  if (dcClose) {
    dcClose.addEventListener('click', hideDigitalCitizenshipModal);
  }
  
  // Confirmation modal
  var confirmClose = document.getElementById('confirmation-modal-close');
  var confirmCancel = document.getElementById('confirmation-modal-cancel');
  
  if (confirmClose) {
    confirmClose.addEventListener('click', hideConfirmationModal);
  }
  
  if (confirmCancel) {
    confirmCancel.addEventListener('click', hideConfirmationModal);
  }
  
  // Close modals on backdrop click
  setupBackdropClickHandlers();
}

// =============================================================================
// BACKDROP CLICK HANDLERS
// =============================================================================

function setupBackdropClickHandlers() {
  var modals = [
    'form-config-modal',
    'privacy-modal',
    'digital-citizenship-modal',
    'confirmation-modal'
  ];
  
  modals.forEach(function(modalId) {
    var modal = document.getElementById(modalId);
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          // Close modal when clicking backdrop
          switch(modalId) {
            case 'form-config-modal':
              if (typeof hideFormConfigModal === 'function') {
                hideFormConfigModal();
              }
              break;
            case 'privacy-modal':
              hidePrivacyModal();
              break;
            case 'digital-citizenship-modal':
              hideDigitalCitizenshipModal();
              break;
            case 'confirmation-modal':
              hideConfirmationModal();
              break;
          }
        }
      });
    }
  });
}

// =============================================================================
// REAL-TIME VALIDATION
// =============================================================================

function setupRealtimeValidation() {
  if (eventHandlersAttached.realtimeValidation) {
    logDebug('Realtime validation handlers already attached');
    return;
  }
  eventHandlersAttached.realtimeValidation = true;
  
  // Opinion column validation
  var opinionSelect = document.getElementById('opinion-column');
  if (opinionSelect) {
    opinionSelect.addEventListener('change', updateConfigButtons);
  }
  
  // Show names checkbox
  var showNamesCheckbox = document.getElementById('show-names');
  if (showNamesCheckbox) {
    showNamesCheckbox.addEventListener('change', updateConfigButtons);
  }
  
  // Show counts checkbox
  var showCountsCheckbox = document.getElementById('show-counts');
  if (showCountsCheckbox) {
    showCountsCheckbox.addEventListener('change', updateConfigButtons);
  }
  
  // Name column validation
  var nameSelect = document.getElementById('name-column');
  if (nameSelect) {
    nameSelect.addEventListener('change', function() {
      var showNamesCheckbox = document.getElementById('show-names');
      if (showNamesCheckbox && this.value) {
        showNamesCheckbox.disabled = false;
      } else if (showNamesCheckbox) {
        showNamesCheckbox.disabled = true;
        showNamesCheckbox.checked = false;
      }
      updateConfigButtons();
    });
  }
}

// =============================================================================
// SPECIFIC EVENT HANDLERS
// =============================================================================

// Handle delete account request
function handleDeleteRequest() {
  window.sharedModals.showConfirmation(
    'アカウント削除の確認',
    '本当にこのアカウントを削除しますか？この操作は元に戻せず、すべてのデータが失われます。',
    function() {
      runGasWithUserId('deleteCurrentUserAccount', 'アカウントを完全に削除しています...')
        .then(function(response) {
          showMessage(response.message || 'アカウントが削除されました。ログイン画面に移動します。', 'success');
          
          // 完全なキャッシュクリア実行
          try {
            if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
              window.unifiedCache.clear();
            }
            if (window.gasOptimizer && typeof window.gasOptimizer.clearCache === 'function') {
              window.gasOptimizer.clearCache();
            }
            if (window.localStorage) {
              const allKeys = Object.keys(localStorage);
              allKeys.forEach(key => {
                try {
                  localStorage.removeItem(key);
                } catch (e) {
                  console.warn('⚠️ Failed to remove localStorage key:', key);
                }
              });
            }
            if (window.sessionStorage) {
              window.sessionStorage.clear();
            }
          } catch (clearError) {
            console.warn('キャッシュクリアエラー:', clearError);
          }
          
          // 強制的なログイン画面リダイレクト
          setTimeout(function() {
            // サーバーサイドのセッションをクリアしてログイン画面にリダイレクト
            runGasWithUserId('resetUserAuthentication')
              .then(function(loginUrl) {
                console.log('ログイン画面にリダイレクト:', loginUrl);
                window.location.href = loginUrl || window.location.origin + window.location.pathname;
              })
              .catch(function(error) {
                console.warn('リダイレクトエラー:', error);
                // フォールバック: ページを強制リロードしてログイン状態をリセット
                window.location.href = window.location.origin + window.location.pathname;
              });
          }, 1500);
        })
        .catch(function(error) {
          handleError(error, 'deleteAccount', 'アカウントの削除に失敗しました。');
        });
    }
  );
}

/**
 * Show stop/unpublish confirmation modal with appropriate button text
 * @param {string} title - Modal title
 * @param {string} message - Modal message
 * @param {Function} onConfirm - Confirmation callback
 */
function showStopConfirmationModal(title, message, onConfirm) {
  const modal = document.getElementById('confirmation-modal');
  const titleElement = document.getElementById('modal-title');
  const messageElement = document.getElementById('modal-message');
  const confirmBtn = document.getElementById('modal-confirm-btn');
  const cancelBtn = document.getElementById('modal-cancel-btn');
  
  if (modal && titleElement && messageElement && confirmBtn && cancelBtn) {
    titleElement.textContent = title;
    messageElement.textContent = message;
    confirmBtn.textContent = '停止する';
    cancelBtn.textContent = 'キャンセル';
    
    // Set up event handlers
    const handleConfirm = () => {
      modal.classList.add('hidden');
      onConfirm();
      cleanup();
    };
    
    const handleCancel = () => {
      modal.classList.add('hidden');
      cleanup();
    };
    
    const cleanup = () => {
      confirmBtn.removeEventListener('click', handleConfirm);
      cancelBtn.removeEventListener('click', handleCancel);
    };
    
    confirmBtn.addEventListener('click', handleConfirm);
    cancelBtn.addEventListener('click', handleCancel);
    
    // Show modal
    modal.classList.remove('hidden');
  } else {
    console.warn('⚠️ Modal elements not found, using fallback');
    if (confirm(`${title}\n\n${message}`)) {
      onConfirm();
    }
  }
}

// Switch to another account
function switchToAnotherAccount() {
  showConfirmationModal(
    'アカウント切り替え',
    '別のアカウントでログインしますか？現在のセッションがクリアされます。',
    function() {
      sharedUtilities.gas.callWithLoading('resetUserAuthentication', 'セッションをクリアしています...', 'overlay')
        .then(function(result) {
          console.log('Session cleanup result:', result);
          window.location.href = 'https://accounts.google.com/logout';
        })
        .catch(function(error) {
          console.error('Session cleanup failed:', error);
          alert('セッションクリアに失敗しました。手動でGoogleアカウントからログアウトしてください。');
          window.location.href = 'https://accounts.google.com/logout';
        });
    }
  );
}

// updateUIForSelectedSheet function moved to adminPanel-ui.js.html to resolve loading order issues

// =============================================================================
// KEYBOARD SHORTCUTS
// =============================================================================

// Setup keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + S for save and publish
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    if (selectedSheet && elements['save-publish-btn'] && !elements['save-publish-btn'].disabled) {
      saveAndPublish();
    }
  }
  
  // Escape to close modals
  if (e.key === 'Escape') {
    var openModals = document.querySelectorAll('.modal:not(.hidden)');
    if (openModals.length > 0) {
      var lastModal = openModals[openModals.length - 1];
      var modalId = lastModal.id;
      
      switch(modalId) {
        case 'form-config-modal':
          if (typeof hideFormConfigModal === 'function') {
            hideFormConfigModal();
          }
          break;
        case 'privacy-modal':
          hidePrivacyModal();
          break;
        case 'digital-citizenship-modal':
          hideDigitalCitizenshipModal();
          break;
        case 'confirmation-modal':
          hideConfirmationModal();
          break;
      }
    }
  }
});


// =============================================================================
// ACCESSIBILITY ENHANCEMENTS
// =============================================================================

// Focus management for modals
function manageFocusForModal(modalId, show) {
  var modal = document.getElementById(modalId);
  if (!modal) return;
  
  if (show) {
    // Store currently focused element
    modal.setAttribute('data-previous-focus', (document.activeElement && document.activeElement.id) || '');
    
    // Focus first interactive element in modal
    var firstFocusable = modal.querySelector('button, input, textarea, select, [tabindex]:not([tabindex="-1"])');
    if (firstFocusable) {
      firstFocusable.focus();
    }
  } else {
    // Restore focus to previous element
    var previousFocusId = modal.getAttribute('data-previous-focus');
    if (previousFocusId) {
      var previousElement = document.getElementById(previousFocusId);
      if (previousElement) {
        previousElement.focus();
      }
    }
  }
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Event listener initialization is now handled in adminPanel-framework.js.html

//# sourceURL=adminPanel-events.js.html
</script>
