<script>
// =============================================================================
// ADMIN PANEL EVENT LISTENERS & UI INTERACTIONS
// =============================================================================

// DOM Elements Cache
var elements = {};

// å±¥æ­´ç®¡ç†ç”¨å®šæ•° - adminPanel-ui.js.htmlã§å®šç¾©æ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯å‚ç…§ã®ã¿
// const HISTORY_STORAGE_KEY = 'answerBoardHistory'; // é‡è¤‡å®£è¨€ã‚’å›é¿

// =============================================================================
// MAIN EVENT LISTENERS SETUP
// =============================================================================

function setupEventListeners() {
  console.log('âœ… AdminPanel: Initializing event handlers');
  
  // Cache frequently used elements
  elements = {
    'sheet-select': getCachedElement('sheet-select'),
    'save-publish-btn': getCachedElement('save-publish-btn'),
    'unpublish-board-btn': getCachedElement('unpublish-board-btn'),
    'delete-account-btn': getCachedElement('delete-account-btn'),
    'open-spreadsheet-btn': getCachedElement('open-spreadsheet-btn'),
    'open-form-btn': getCachedElement('open-form-btn'),
    'clear-history-btn': getCachedElement('clear-history-btn')
  };
  
  
  // AI column detection button
  var reguessBtn = document.getElementById('reguess-headers-btn');
  if (reguessBtn) {
    reguessBtn.addEventListener('click', runHeaderGuessing);
  }
  
  // Save and publish button - é˜²å¾¡çš„å®Ÿè£…
  const savePublishBtn = elements['save-publish-btn'] || getCachedElement('save-publish-btn');
  if (savePublishBtn) {
    // æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    const newSaveBtn = savePublishBtn.cloneNode(true);
    savePublishBtn.parentNode.replaceChild(newSaveBtn, savePublishBtn);
    
    newSaveBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('ğŸ’¾ Save and publish button clicked');
      
      // ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡è¦–
      if (newSaveBtn.disabled) {
        console.log('âš ï¸ Save button is disabled, ignoring click');
        return;
      }
      
      // selectedSheet ã®ç¢ºèªï¼ˆã‚ˆã‚Šå …ç‰¢ãªãƒã‚§ãƒƒã‚¯ï¼‰
      const sheetSelect = document.getElementById('sheet-select');
      const selectedSheetValue = sheetSelect ? sheetSelect.value : null;
      
      if (!selectedSheetValue || selectedSheetValue === '') {
        showMessage('ã¾ãšã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
        return;
      }
      
      // saveAndPublishé–¢æ•°ã®å­˜åœ¨ç¢ºèª
      if (typeof saveAndPublish === 'function') {
        saveAndPublish();
      } else {
        console.error('saveAndPublish function not found');
        showMessage('ä¿å­˜æ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'warning');
      }
    });
    
    // è¦ç´ ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«æ›´æ–°
    elements['save-publish-btn'] = newSaveBtn;
    console.log('âœ… Save and publish button handler attached');
  } else {
    console.warn('âš ï¸ Save and publish button not found');
  }
  
  // Unpublish button - é˜²å¾¡çš„å®Ÿè£…
  const unpublishBtn = elements['unpublish-board-btn'] || getCachedElement('unpublish-board-btn');
  if (unpublishBtn) {
    // æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    const newUnpublishBtn = unpublishBtn.cloneNode(true);
    unpublishBtn.parentNode.replaceChild(newUnpublishBtn, unpublishBtn);
    
    newUnpublishBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('ğŸ›‘ Unpublish button clicked');
      
      if (typeof showConfirmationModal === 'function' && typeof unpublishBoard === 'function') {
        showConfirmationModal(
          'å…¬é–‹åœæ­¢ã®ç¢ºèª',
          'å›ç­”ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ',
          () => {
            unpublishBoard().then(() => {
              if (typeof loadStatus === 'function') {
                loadStatus(true);
              }
            });
          }
        );
      } else {
        console.error('Required functions not found for unpublish');
        showMessage('å…¬é–‹åœæ­¢æ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'warning');
      }
    });
    
    // è¦ç´ ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«æ›´æ–°
    elements['unpublish-board-btn'] = newUnpublishBtn;
    console.log('âœ… Unpublish button handler attached');
  } else {
    console.warn('âš ï¸ Unpublish button not found');
  }
  
  // Clear history button - ç›´æ¥å–å¾—ã§ç¢ºå®Ÿã«å‡¦ç†
  var clearHistoryBtn = document.getElementById('clear-history-btn');
  if (clearHistoryBtn) {
    clearHistoryBtn.addEventListener('click', function() {
      console.log('ğŸ—‘ï¸ å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      
      if (typeof showConfirmationModal === 'function') {
        showConfirmationModal(
          'å±¥æ­´å‰Šé™¤ã®ç¢ºèª',
          'ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚',
          function() {
            console.log('ğŸ“ å±¥æ­´å‰Šé™¤ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ');
            try {
              localStorage.removeItem(HISTORY_STORAGE_KEY);
              console.log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
              
              // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢
              runGasWithUserId('clearHistoryFromServerAPI', 'ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ä¸­...')
                .then(function(serverResponse) {
                  console.log('âœ… ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ:', serverResponse);
                  showMessage('âœ… å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ»ã‚µãƒ¼ãƒãƒ¼ä¸¡æ–¹ï¼‰', 'success');
                  
                  // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
                  if (typeof loadSimpleHistoryTable === 'function') {
                    loadSimpleHistoryTable();
                    console.log('ğŸ“Š å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                  } else {
                    console.warn('âš ï¸ loadSimpleHistoryTableé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                  }
                })
                .catch(function(serverError) {
                  console.warn('âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å±¥æ­´ã‚¯ãƒªã‚¢ã«å¤±æ•—:', serverError);
                  showMessage('âœ… ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã¯æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'success');
                  
                  // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
                  if (typeof loadSimpleHistoryTable === 'function') {
                    loadSimpleHistoryTable();
                    console.log('ğŸ“Š å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                  } else {
                    console.warn('âš ï¸ loadSimpleHistoryTableé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                  }
                });
            } catch (error) {
              console.error('âŒ å±¥æ­´ã‚¯ãƒªã‚¢ã«å¤±æ•—:', error);
              showMessage('âŒ å±¥æ­´ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
          }
        );
      } else {
        console.error('âŒ showConfirmationModalé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ç¢ºèª
        if (confirm('ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
          try {
            localStorage.removeItem(HISTORY_STORAGE_KEY);
            console.log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰');
            
            // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            runGasWithUserId('clearHistoryFromServerAPI', 'ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ä¸­...')
              .then(function(serverResponse) {
                console.log('âœ… ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰:', serverResponse);
                showMessage('âœ… å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ»ã‚µãƒ¼ãƒãƒ¼ä¸¡æ–¹ï¼‰', 'success');
              })
              .catch(function(serverError) {
                console.warn('âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å±¥æ­´ã‚¯ãƒªã‚¢ã«å¤±æ•—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰:', serverError);
                showMessage('âœ… ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã¯æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'success');
              });
            
            if (typeof loadSimpleHistoryTable === 'function') {
              loadSimpleHistoryTable();
            }
          } catch (error) {
            console.error('âŒ å±¥æ­´ã‚¯ãƒªã‚¢ã«å¤±æ•—:', error);
            showMessage('âŒ å±¥æ­´ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        }
      }
    });
    console.log('âœ… å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
  } else {
    console.error('âŒ clear-history-btnãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ - é˜²å¾¡çš„å®Ÿè£…
  var quickstartBtn = document.getElementById('quickstart-btn');
  if (quickstartBtn) {
    // æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    const newQuickstartBtn = quickstartBtn.cloneNode(true);
    quickstartBtn.parentNode.replaceChild(newQuickstartBtn, quickstartBtn);
    
    newQuickstartBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('ğŸš€ Quickstart button clicked');
      
      if (typeof handleQuickStart === 'function') {
        handleQuickStart();
      } else {
        console.error('handleQuickStart function not found');
        showMessage('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'warning');
      }
    });
    console.log('âœ… Quickstart button handler attached');
  } else {
    console.warn('âš ï¸ Quickstart button not found');
  }

  // Create board button - é˜²å¾¡çš„å®Ÿè£…
  var createBoardBtn = document.getElementById('create-board-btn');
  if (createBoardBtn) {
    // æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    const newCreateBoardBtn = createBoardBtn.cloneNode(true);
    createBoardBtn.parentNode.replaceChild(newCreateBoardBtn, createBoardBtn);
    
    newCreateBoardBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('ğŸ¨ Create board button clicked');
      
      // å…¬é–‹çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      if (currentStatus && currentStatus._normalized && currentStatus._normalized.isPublished) {
        // å…¬é–‹ä¸­ã®å ´åˆã€é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        if (window.sharedModals && typeof window.sharedModals.showCustomSetupSelection === 'function') {
          window.sharedModals.showCustomSetupSelection(
            (selectedOption) => {
              console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠ:', selectedOption);
              if (selectedOption === 'stop') {
                // åœæ­¢ã—ã¦ä½œæˆã‚’é¸æŠ
                proceedWithCustomFormCreation(true);
              } else if (selectedOption === 'continue') {
                // ç¶™ç¶šã—ãªãŒã‚‰ä½œæˆã‚’é¸æŠ
                proceedWithCustomFormCreation(false);
              }
            },
            () => {
              console.log('âŒ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
            }
          );
        } else {
          console.error('sharedModals.showCustomSetupSelection not found');
          proceedWithCustomFormCreation(false);
        }
      } else {
        // å…¬é–‹ã—ã¦ã„ãªã„å ´åˆã€ç›´æ¥ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        proceedWithCustomFormCreation(false);
      }
    });
    console.log('âœ… Create board button handler attached');
  } else {
    console.warn('âš ï¸ Create board button not found');
  }

  // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚’é€²è¡Œ
  function proceedWithCustomFormCreation(shouldStop) {
    if (shouldStop) {
      console.log('ğŸ“ å…¬é–‹åœæ­¢ã—ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™');
      
      // å®Ÿéš›ã«å…¬é–‹åœæ­¢å‡¦ç†ã‚’å®Ÿè¡Œ
      if (typeof unpublishBoard === 'function') {
        console.log('ğŸ›‘ å…¬é–‹åœæ­¢å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...');
        
        // å…¬é–‹åœæ­¢ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        window.sharedModals.showConfirmation(
          'å…¬é–‹åœæ­¢ã®ç¢ºèª',
          'ç¾åœ¨å…¬é–‹ä¸­ã®ãƒœãƒ¼ãƒ‰ã‚’åœæ­¢ã—ã¦ã‹ã‚‰ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
          function() {
            // ç¢ºèªå¾Œã€å®Ÿéš›ã«åœæ­¢å‡¦ç†ã‚’å®Ÿè¡Œ
            executeStopAndCreateForm();
          },
          function() {
            console.log('âŒ å…¬é–‹åœæ­¢ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
          }
        );
      } else {
        console.error('unpublishBoard function not found');
        showMessage('å…¬é–‹åœæ­¢æ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'warning');
      }
    } else {
      console.log('ğŸ“ å…¬é–‹ã‚’ç¶™ç¶šã—ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™');
      
      // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ã¯å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
      try {
        localStorage.setItem('expandAllSections', 'true');
        console.log('ğŸ“‚ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨ã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ã¾ã—ãŸ');
      } catch (e) {
        console.warn('âš ï¸ localStorageè¨­å®šã«å¤±æ•—:', e);
      }
      
      // ç¶™ç¶šã®å ´åˆã¯ç›´æ¥ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      showFormConfigModalSafely();
    }
  }

  // å…¬é–‹åœæ­¢â†’ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã®å®Ÿè¡Œ
  function executeStopAndCreateForm() {
    console.log('ğŸ›‘ å…¬é–‹åœæ­¢å‡¦ç†ã‚’å®Ÿè¡Œä¸­...');
    
    // unpublishBoardé–¢æ•°ã‚’å‘¼ã³å‡ºã—
    unpublishBoard()
      .then(function(response) {
        console.log('âœ… å…¬é–‹åœæ­¢ãŒå®Œäº†ã—ã¾ã—ãŸ:', response);
        
        // å…¬é–‹åœæ­¢ãŒç¢ºå®Ÿã«å®Œäº†ã—ãŸæ—¨ã‚’è¡¨ç¤º
        showMessage('âœ… å…¬é–‹åœæ­¢ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã§ãã¾ã™ã€‚', 'success');
        
        // å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆå…¬é–‹åœæ­¢å¾Œã®ç®¡ç†ãƒ‘ãƒãƒ«è¡¨ç¤ºæ”¹å–„ï¼‰
        try {
          localStorage.setItem('expandAllSections', 'true');
          console.log('ğŸ“‚ å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ã¾ã—ãŸ');
        } catch (e) {
          console.warn('âš ï¸ localStorageè¨­å®šã«å¤±æ•—:', e);
        }
        
        // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        setTimeout(function() {
          console.log('ğŸ¨ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™');
          showFormConfigModalSafely();
        }, 1500); // 1.5ç§’å¾Œã«è¡¨ç¤ºï¼ˆUIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ™‚é–“ã‚’ç¢ºä¿ï¼‰
      })
      .catch(function(error) {
        console.error('âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        showMessage('âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
      });
  }

  // å®‰å…¨ãªãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  function showFormConfigModalSafely() {
    safeCall('showFormConfigModal');
  }

  // Create additional form button
  var createAdditionalFormBtn = document.getElementById('create-additional-form-btn');
  if (createAdditionalFormBtn) {
    createAdditionalFormBtn.addEventListener('click', function() {
      if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
        showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
        return;
      }
      safeCall('showFormConfigModal');
    });
  }
  
  // Form configuration modal handlers
  setupFormConfigModalHandlers();
  
  // Resource management
  setupResourceHandlers();
  
  // Account management
  setupAccountManagementHandlers();
  
  // External links
  setupExternalLinkHandlers();
  
  // Modal handlers
  setupModalHandlers();
  
  // Real-time validation
  setupRealtimeValidation();
  
  console.log('âœ… AdminPanel: Event handlers ready');
}

// =============================================================================
// FORM CONFIGURATION MODAL HANDLERS
// =============================================================================

function setupFormConfigModalHandlers() {
  var formConfigClose = document.getElementById('form-config-close');
  var formConfigCancel = document.getElementById('form-config-cancel');
  var formConfigCreate = document.getElementById('form-config-create');
  
  if (formConfigClose) {
    formConfigClose.addEventListener('click', hideFormConfigModal);
  }
  
  if (formConfigCancel) {
    formConfigCancel.addEventListener('click', hideFormConfigModal);
  }
  
  if (formConfigCreate) {
    formConfigCreate.addEventListener('click', function() {
      // ğŸ”§ å‹•çš„é–¢æ•°ãƒã‚§ãƒƒã‚¯: èª­ã¿è¾¼ã¿é †åºå•é¡Œã‚’è§£æ±º
      if (typeof createFormWithConfig === 'function') {
        createFormWithConfig();
      } else {
        console.warn('âš ï¸ createFormWithConfig not available, retrying...');
        // çŸ­æ™‚é–“å¾…æ©Ÿã—ã¦ã‹ã‚‰å†è©¦è¡Œ
        setTimeout(() => {
          if (typeof createFormWithConfig === 'function') {
            createFormWithConfig();
          } else {
            console.error('âŒ createFormWithConfig still not available');
            showMessage('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
          }
        }, 500);
      }
    });
  }
}

// =============================================================================
// RESOURCE MANAGEMENT HANDLERS
// =============================================================================

function setupResourceHandlers() {
  var addResourceBtn = document.getElementById('add-resource-btn');
  var resourceUrlInput = document.getElementById('resource-url-input');
  
  if (addResourceBtn) {
    addResourceBtn.addEventListener('click', addResource);
  }
  
  if (resourceUrlInput) {
    resourceUrlInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addResource();
      }
    });
  }
  
  // Note: resetConfigBtn handler is now handled in setupAccountManagementHandlers
}

// =============================================================================
// ACCOUNT MANAGEMENT HANDLERS
// =============================================================================

function setupAccountManagementHandlers() {
  console.log('ğŸ”§ Setting up account management handlers...');
  
  // Delete account handler - ã‚·ãƒ³ãƒ—ãƒ«ã§ç¢ºå®Ÿãªå®Ÿè£…
  const deleteBtn = elements['delete-account-btn'] || 
                   getCachedElement('delete-account-btn') || 
                   document.getElementById('delete-account-btn');
  
  if (deleteBtn) {
    // æ—¢å­˜ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
    
    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    newDeleteBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('ğŸ—‘ï¸ Delete account button clicked');
      handleDeleteRequest();
    });
    
    // è¦ç´ ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«æ›´æ–°
    elements['delete-account-btn'] = newDeleteBtn;
    console.log('âœ… Delete account button handler attached');
  } else {
    console.warn('âš ï¸ Delete account button not found');
  }
  
  // Reset config handler - ã‚·ãƒ³ãƒ—ãƒ«ã§ç¢ºå®Ÿãªå®Ÿè£…
  const resetBtn = document.getElementById('reset-config-btn');
  
  if (resetBtn) {
    // æ—¢å­˜ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    const newResetBtn = resetBtn.cloneNode(true);
    resetBtn.parentNode.replaceChild(newResetBtn, resetBtn);
    
    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    newResetBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('ğŸ”„ Reset config button clicked');
      resetConfigJson();
    });
    
    console.log('âœ… Reset config button handler attached');
  } else {
    console.warn('âš ï¸ Reset config button not found');
  }
  
  // Switch account handlers
  var switchAccountBtns = document.querySelectorAll('[onclick*="switchToAnotherAccount"]');
  switchAccountBtns.forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      switchToAnotherAccount();
    });
  });
  
  console.log('âœ… Account management handlers setup complete');
}

// =============================================================================
// EXTERNAL LINK HANDLERS
// =============================================================================

function setupExternalLinkHandlers() {
  console.log('ğŸ”— Setting up external link handlers...');
  
  // Open spreadsheet - é˜²å¾¡çš„å®Ÿè£…
  const spreadsheetBtn = elements['open-spreadsheet-btn'] || getCachedElement('open-spreadsheet-btn');
  if (spreadsheetBtn) {
    const newSpreadsheetBtn = spreadsheetBtn.cloneNode(true);
    spreadsheetBtn.parentNode.replaceChild(newSpreadsheetBtn, spreadsheetBtn);
    
    newSpreadsheetBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('ğŸ“Š Open spreadsheet button clicked');
      
      if (typeof openDatabaseSpreadsheet === 'function') {
        openDatabaseSpreadsheet();
      } else {
        console.error('openDatabaseSpreadsheet function not found');
        showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚', 'warning');
      }
    });
    
    elements['open-spreadsheet-btn'] = newSpreadsheetBtn;
    console.log('âœ… Open spreadsheet button handler attached');
  }
  
  // Open form - é˜²å¾¡çš„å®Ÿè£…
  const formBtn = elements['open-form-btn'] || getCachedElement('open-form-btn');
  if (formBtn) {
    const newFormBtn = formBtn.cloneNode(true);
    formBtn.parentNode.replaceChild(newFormBtn, formBtn);
    
    newFormBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('ğŸ“ Open form button clicked');
      
      if (typeof openForm === 'function') {
        openForm();
      } else {
        console.error('openForm function not found');
        showMessage('ãƒ•ã‚©ãƒ¼ãƒ æ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚', 'warning');
      }
    });
    
    elements['open-form-btn'] = newFormBtn;
    console.log('âœ… Open form button handler attached');
  }
  
  // Digital citizenship
  var digitalCitizenshipBtn = document.getElementById('digital-citizenship-btn');
  if (digitalCitizenshipBtn) {
    digitalCitizenshipBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('ğŸ›ï¸ Digital citizenship button clicked');
      
      if (typeof showDigitalCitizenshipModal === 'function') {
        showDigitalCitizenshipModal();
      } else {
        console.error('showDigitalCitizenshipModal function not found');
      }
    });
  }
  
  // Copy board URL
  var copyUrlBtn = document.getElementById('copy-url-btn');
  if (copyUrlBtn) {
    copyUrlBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('ğŸ“‹ Copy board URL button clicked');
      
      if (typeof copyBoardUrl === 'function') {
        copyBoardUrl();
      } else {
        console.error('copyBoardUrl function not found');
      }
    });
  }
  
  // Copy form URL
  var copyFormUrlBtn = document.getElementById('copy-form-url-btn');
  if (copyFormUrlBtn) {
    copyFormUrlBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('ğŸ“‹ Copy form URL button clicked');
      
      if (typeof copyFormUrl === 'function') {
        copyFormUrl();
      } else {
        console.error('copyFormUrl function not found');
      }
    });
  }
  
  console.log('âœ… External link handlers setup complete');
}

// =============================================================================
// MODAL HANDLERS
// =============================================================================

function setupModalHandlers() {
  // Privacy modal
  var privacyClose = document.getElementById('privacy-modal-close');
  var privacyCancel = document.getElementById('privacy-modal-cancel');
  
  if (privacyClose) {
    privacyClose.addEventListener('click', function() { safeCall('hidePrivacyModal'); });
  }
  
  if (privacyCancel) {
    privacyCancel.addEventListener('click', function() { safeCall('hidePrivacyModal'); });
  }
  
  // Digital citizenship modal
  var dcClose = document.getElementById('digital-citizenship-close');
  if (dcClose) {
    dcClose.addEventListener('click', hideDigitalCitizenshipModal);
  }
  
  // Confirmation modal
  var confirmClose = document.getElementById('confirmation-modal-close');
  var confirmCancel = document.getElementById('confirmation-modal-cancel');
  
  if (confirmClose) {
    confirmClose.addEventListener('click', hideConfirmationModal);
  }
  
  if (confirmCancel) {
    confirmCancel.addEventListener('click', hideConfirmationModal);
  }
  
  // Close modals on backdrop click
  setupBackdropClickHandlers();
}

// =============================================================================
// BACKDROP CLICK HANDLERS
// =============================================================================

function setupBackdropClickHandlers() {
  var modals = [
    'form-config-modal',
    'privacy-modal',
    'digital-citizenship-modal',
    'confirmation-modal'
  ];
  
  modals.forEach(function(modalId) {
    var modal = document.getElementById(modalId);
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          // Close modal when clicking backdrop
          switch(modalId) {
            case 'form-config-modal':
              safeCall('hideFormConfigModal');
              break;
            case 'privacy-modal':
              safeCall('hidePrivacyModal');
              break;
            case 'digital-citizenship-modal':
              hideDigitalCitizenshipModal();
              break;
            case 'confirmation-modal':
              hideConfirmationModal();
              break;
          }
        }
      });
    }
  });
}

// =============================================================================
// REAL-TIME VALIDATION
// =============================================================================

function setupRealtimeValidation() {
  // Opinion column validation
  var opinionSelect = document.getElementById('opinion-column');
  if (opinionSelect) {
    opinionSelect.addEventListener('change', function() { safeCall('updateConfigButtons'); });
  }
  
  // Show names checkbox
  var showNamesCheckbox = document.getElementById('show-names');
  if (showNamesCheckbox) {
    showNamesCheckbox.addEventListener('change', function() { safeCall('updateConfigButtons'); });
  }
  
  // Show counts checkbox
  var showCountsCheckbox = document.getElementById('show-counts');
  if (showCountsCheckbox) {
    showCountsCheckbox.addEventListener('change', function() { safeCall('updateConfigButtons'); });
  }
  
  // Name column validation
  var nameSelect = document.getElementById('name-column');
  if (nameSelect) {
    nameSelect.addEventListener('change', function() {
      var showNamesCheckbox = document.getElementById('show-names');
      if (showNamesCheckbox && this.value) {
        showNamesCheckbox.disabled = false;
      } else if (showNamesCheckbox) {
        showNamesCheckbox.disabled = true;
        showNamesCheckbox.checked = false;
      }
      safeCall('updateConfigButtons');
    });
  }
}

// =============================================================================
// SPECIFIC EVENT HANDLERS
// =============================================================================

// Handle delete account request
function handleDeleteRequest() {
  window.sharedModals.showConfirmation(
    'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã®ç¢ºèª',
    'æœ¬å½“ã«ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ãšã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ã€‚',
    function() {
      runGasWithUserId('deleteCurrentUserAccount', 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã„ã¾ã™...')
        .then(function(response) {
          showMessage(response.message || 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ', 'success');
          if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
            window.unifiedCache.clear();
          }
          if (window.gasOptimizer && typeof window.gasOptimizer.clearCache === 'function') {
            window.gasOptimizer.clearCache();
          }
          if (window.localStorage) {
            window.localStorage.clear();
          }
          setTimeout(function() {
            runGasWithUserId('getProductionWebAppUrl')
              .then(function(webAppUrl) {
                window.location.href = webAppUrl;
              })
              .catch(function() {
                window.location.reload();
              });
          }, 2000);
        })
        .catch(function(error) {
          handleError(error, 'deleteAccount', 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        });
    }
  );
}

// Switch to another account
function switchToAnotherAccount() {
  showConfirmationModal(
    'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ',
    'åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚',
    function() {
      sharedUtilities.gas.callWithLoading('resetUserAuthentication', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™...', 'overlay')
        .then(function(result) {
          console.log('Session cleanup result:', result);
          window.location.href = 'https://accounts.google.com/logout';
        })
        .catch(function(error) {
          console.error('Session cleanup failed:', error);
          alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãã ã•ã„ã€‚');
          window.location.href = 'https://accounts.google.com/logout';
        });
    }
  );
}

// updateUIForSelectedSheet function moved to adminPanel-ui.js.html to resolve loading order issues

// =============================================================================
// KEYBOARD SHORTCUTS
// =============================================================================

// Setup keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + S for save and publish
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    if (selectedSheet && elements['save-publish-btn'] && !elements['save-publish-btn'].disabled) {
      saveAndPublish();
    }
  }
  
  // Escape to close modals
  if (e.key === 'Escape') {
    var openModals = document.querySelectorAll('.modal:not(.hidden)');
    if (openModals.length > 0) {
      var lastModal = openModals[openModals.length - 1];
      var modalId = lastModal.id;
      
      switch(modalId) {
        case 'form-config-modal':
          safeCall('hideFormConfigModal');
          break;
        case 'privacy-modal':
          hidePrivacyModal();
          break;
        case 'digital-citizenship-modal':
          hideDigitalCitizenshipModal();
          break;
        case 'confirmation-modal':
          hideConfirmationModal();
          break;
      }
    }
  }
});


// =============================================================================
// ACCESSIBILITY ENHANCEMENTS
// =============================================================================

// Focus management for modals
function manageFocusForModal(modalId, show) {
  var modal = document.getElementById(modalId);
  if (!modal) return;
  
  if (show) {
    // Store currently focused element
    modal.setAttribute('data-previous-focus', document.activeElement?.id || '');
    
    // Focus first interactive element in modal
    var firstFocusable = modal.querySelector('button, input, textarea, select, [tabindex]:not([tabindex="-1"])');
    if (firstFocusable) {
      firstFocusable.focus();
    }
  } else {
    // Restore focus to previous element
    var previousFocusId = modal.getAttribute('data-previous-focus');
    if (previousFocusId) {
      var previousElement = document.getElementById(previousFocusId);
      if (previousElement) {
        previousElement.focus();
      }
    }
  }
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize event listeners when DOM is ready
// Add additional delay to ensure all JavaScript modules are loaded
function initializeEventListeners() {
  console.log('ğŸ¯ Starting event listeners initialization...');
  
  // Check if essential functions are available, but continue even if some are missing
  const requiredFunctions = ['handleQuickStart', 'showFormConfigModal', 'toggleSection'];
  const missingFunctions = requiredFunctions.filter(func => typeof window[func] !== 'function');

  if (missingFunctions.length > 0) {
    console.warn('âš ï¸ AdminPanel: Missing functions during event initialization:', missingFunctions);
    console.log('âš ï¸ Will retry after 1 second...');
    
    // 1ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤
    setTimeout(() => {
      console.log('ğŸ”„ Retrying event listeners setup...');
      setupEventListeners();
    }, 1000);
  } else {
    console.log('âœ… All required functions available, setting up event listeners');
  }

  // å¿…é ˆé–¢æ•°ãŒãªãã¦ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯è¨­å®šã™ã‚‹ï¼ˆé˜²å¾¡çš„å®Ÿè£…ã«ã‚ˆã‚Šå¯¾å¿œï¼‰
  setupEventListeners();
}

// åˆæœŸåŒ–ã¯ adminPanel-core.js ã®çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ã§ç®¡ç†ã•ã‚Œã¾ã™

</script>
