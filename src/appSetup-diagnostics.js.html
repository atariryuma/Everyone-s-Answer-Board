<script>
/**
 * AppSetupPage 診断機能モジュール
 * システム診断、データ整合性チェック、診断履歴管理
 */

// グローバル変数
let diagnosticHistoryCache = [];

/**
 * システム診断を実行
 */
function runSystemDiagnosis() {
    executeSystemFunction('run-diagnosis-btn', 'システム診断中...', 'diagnoseDatabase', '診断実行');
}

/**
 * データ整合性チェックを実行
 */
function runIntegrityCheck() {
    executeSystemFunction('run-integrity-btn', '整合性チェック中...', 'performDataIntegrityCheck', '整合性チェック');
}

/**
 * 共通のシステム機能実行関数
 */
function executeSystemFunction(buttonId, progressMessage, functionName, originalText) {
    const button = document.getElementById(buttonId);
    const spinner = button ? button.querySelector('.spinner') : null;
    const text = button ? button.querySelector('.btn-text') : null;
    
    if (button) {
        button.disabled = true;
        if (spinner) spinner.classList.remove('hidden');
        if (text) text.textContent = progressMessage;
    }

    google.script.run
        .withSuccessHandler(result => {
            displayDiagnosticResult(functionName, result);
            
            // UI復元
            if (button) {
                button.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (text) text.textContent = originalText;
            }
        })
        .withFailureHandler(error => {
            console.error(`${functionName} error:`, error);
            displayDiagnosticResult(functionName, {
                error: error.message,
                timestamp: new Date().toISOString(),
                summary: {
                    overallStatus: 'error',
                    criticalIssues: [`${functionName}の実行に失敗: ${error.message}`]
                }
            });
            
            // UI復元
            if (button) {
                button.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (text) text.textContent = originalText;
            }
        })
        [functionName]();
}

/**
 * 診断結果を表示
 */
function displayDiagnosticResult(functionName, result) {
    const resultsContainer = document.getElementById('diagnostic-results');
    if (!resultsContainer) return;

    // 結果のフォーマット
    const formattedResult = formatDiagnosticResult(functionName, result);
    
    // 履歴にキャッシュ
    cacheDiagnosticResult(functionName, result, formattedResult);
    
    // 新しい結果を上部に追加
    const resultDiv = document.createElement('div');
    resultDiv.className = `diagnostic-result mt-4 p-4 rounded-lg border ${formattedResult.cssClass}`;
    resultDiv.innerHTML = formattedResult.html;
    
    // 既存の結果の上に挿入
    resultsContainer.insertBefore(resultDiv, resultsContainer.firstChild);
    
    // 5件以上ある場合は古いものを削除
    const existingResults = resultsContainer.querySelectorAll('.diagnostic-result');
    if (existingResults.length > 5) {
        for (let i = 5; i < existingResults.length; i++) {
            existingResults[i].remove();
        }
    }
}

/**
 * 診断結果をフォーマット
 */
function formatDiagnosticResult(functionName, result) {
    const timestamp = new Date(result.timestamp || Date.now()).toLocaleString('ja-JP');
    let message, type, problemCount, repairCount, successfulRepairs;

    // エラー処理
    if (result.error) {
        return {
            html: `
                <div class="flex items-start space-x-3">
                    <span class="text-2xl">❌</span>
                    <div>
                        <h4 class="font-semibold text-red-400">${getFunctionDisplayName(functionName)} - エラー</h4>
                        <p class="text-red-300 mt-1">${result.error}</p>
                        <p class="text-gray-400 text-sm mt-2">${timestamp}</p>
                    </div>
                </div>
            `,
            cssClass: 'border-red-500 bg-red-900/20',
            type: 'error',
            problemCount: 1,
            repairCount: 0,
            successfulRepairs: 0
        };
    }

    // 通常の結果処理
    if (functionName === 'diagnoseDatabase') {
        problemCount = (result.summary?.criticalIssues?.length || 0) + (result.summary?.warnings?.length || 0);
        repairCount = 0;
        successfulRepairs = 0;
        
        if (result.summary?.overallStatus === 'critical') {
            message = `❌ ${getFunctionDisplayName(functionName)}: ${problemCount}件の重要な問題を検出`;
            type = 'error';
        } else if (result.summary?.overallStatus === 'warning' || problemCount > 0) {
            message = `⚠️ ${getFunctionDisplayName(functionName)}: ${problemCount}件の警告を検出`;
            type = 'warning';
        } else {
            message = `✅ ${getFunctionDisplayName(functionName)}: システムは正常です`;
            type = 'success';
        }
    } else if (functionName === 'performDataIntegrityCheck') {
        problemCount = (result.summary?.issues?.length || 0) + (result.summary?.warnings?.length || 0);
        repairCount = result.summary?.fixed?.length || 0;
        successfulRepairs = repairCount;
        
        if (result.summary?.status === 'critical') {
            message = `❌ ${getFunctionDisplayName(functionName)}: ${problemCount}件の問題を検出。${successfulRepairs}/${repairCount}件の修復が成功しました。`;
            type = 'error';
        } else if (result.summary?.status === 'warning' || problemCount > 0) {
            message = `⚠️ ${getFunctionDisplayName(functionName)}: ${problemCount}件の問題を検出。${successfulRepairs}/${repairCount}件の修復が成功しました。`;
            type = 'warning';
        } else {
            message = `✅ ${getFunctionDisplayName(functionName)}: データ整合性に問題はありません`;
            type = 'success';
        }
    }

    // CSS クラスの決定
    let cssClass;
    if (type === 'error') {
        cssClass = 'border-red-500 bg-red-900/20';
    } else if (type === 'warning') {
        cssClass = 'border-yellow-500 bg-yellow-900/20';
    } else {
        cssClass = 'border-green-500 bg-green-900/20';
    }

    return {
        html: `
            <div class="flex items-start space-x-3">
                <span class="text-2xl">${type === 'error' ? '❌' : type === 'warning' ? '⚠️' : '✅'}</span>
                <div>
                    <h4 class="font-semibold ${type === 'error' ? 'text-red-400' : type === 'warning' ? 'text-yellow-400' : 'text-green-400'}">${message}</h4>
                    <p class="text-gray-400 text-sm mt-2">${timestamp}</p>
                </div>
            </div>
        `,
        cssClass,
        type,
        problemCount,
        repairCount,
        successfulRepairs
    };
}

/**
 * 関数名を表示用に変換
 */
function getFunctionDisplayName(functionName) {
    const displayNames = {
        'diagnoseDatabase': 'データベース診断',
        'performDataIntegrityCheck': 'データ整合性チェック'
    };
    return displayNames[functionName] || functionName;
}

/**
 * 診断結果をローカルキャッシュに保存
 */
function cacheDiagnosticResult(functionName, result, formattedResult) {
    const cacheEntry = {
        timestamp: result.timestamp || new Date().toISOString(),
        functionName,
        status: formattedResult.type,
        problemCount: formattedResult.problemCount || 0,
        repairCount: formattedResult.repairCount || 0,
        successfulRepairs: formattedResult.successfulRepairs || 0,
        summary: formattedResult.html.replace(/<[^>]*>/g, '').trim(),
        details: result
    };

    // キャッシュに追加（最新順）
    diagnosticHistoryCache.unshift(cacheEntry);
    
    // 最大50件に制限
    if (diagnosticHistoryCache.length > 50) {
        diagnosticHistoryCache = diagnosticHistoryCache.slice(0, 50);
    }
    
    // localStorageに保存
    try {
        localStorage.setItem('diagnosticHistoryCache', JSON.stringify(diagnosticHistoryCache));
    } catch (error) {
        console.warn('Failed to save diagnostic history to localStorage:', error);
    }
}

/**
 * 診断履歴を表示
 */
function showDiagnosticHistory() {
    // サーバーから最新の診断ログを取得
    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                showDiagnosticHistoryModal(result.logs);
            } else {
                // フォールバック: ローカルキャッシュを使用
                showDiagnosticHistoryModal(diagnosticHistoryCache);
            }
        })
        .withFailureHandler(error => {
            console.error('Failed to fetch diagnostic history:', error);
            // フォールバック: ローカルキャッシュを使用
            showDiagnosticHistoryModal(diagnosticHistoryCache);
        })
        .getDiagnosticLogsForUI(50);
}

/**
 * 診断履歴モーダルを表示
 */
function showDiagnosticHistoryModal(logs) {
    const modal = document.getElementById('logs-modal');
    const title = modal.querySelector('h3');
    const header = document.getElementById('dynamic-header');
    const tbody = document.getElementById('logs-table-body');
    
    if (!modal || !header || !tbody) return;
    
    title.textContent = '📊 診断履歴';
    
    // ヘッダーを設定
    header.innerHTML = `
        <tr>
            <th class="px-4 py-2 text-left">実行時刻</th>
            <th class="px-4 py-2 text-left">機能</th>
            <th class="px-4 py-2 text-left">状態</th>
            <th class="px-4 py-2 text-center">問題数</th>
            <th class="px-4 py-2 text-center">修復数</th>
            <th class="px-4 py-2 text-left">概要</th>
        </tr>
    `;
    
    // データを表示
    if (!logs || logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                    診断履歴がありません
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = logs.map(log => {
            const timestamp = new Date(log.timestamp).toLocaleString('ja-JP');
            const functionDisplayName = getFunctionDisplayName(log.functionName);
            const statusIcon = log.status === 'error' ? '❌' : log.status === 'warning' ? '⚠️' : '✅';
            const statusClass = log.status === 'error' ? 'text-red-400' : log.status === 'warning' ? 'text-yellow-400' : 'text-green-400';
            
            return `
                <tr class="hover:bg-gray-700/50">
                    <td class="px-4 py-2 text-sm text-gray-300">${timestamp}</td>
                    <td class="px-4 py-2 text-sm text-white">${functionDisplayName}</td>
                    <td class="px-4 py-2 text-sm ${statusClass}">${statusIcon} ${log.status}</td>
                    <td class="px-4 py-2 text-sm text-center text-gray-300">${log.problemCount || 0}</td>
                    <td class="px-4 py-2 text-sm text-center text-gray-300">${log.successfulRepairs || 0}</td>
                    <td class="px-4 py-2 text-sm text-gray-300">${log.summary || log.message || ''}</td>
                </tr>
            `;
        }).join('');
    }
    
    modal.classList.remove('hidden');
}

/**
 * 初期化時にローカルキャッシュを読み込み
 */
function initializeDiagnosticHistory() {
    try {
        const cached = localStorage.getItem('diagnosticHistoryCache');
        if (cached) {
            diagnosticHistoryCache = JSON.parse(cached);
        }
    } catch (error) {
        console.warn('Failed to load diagnostic history from localStorage:', error);
        diagnosticHistoryCache = [];
    }
}

// 初期化
initializeDiagnosticHistory();
</script>