<script>
/**
 * AppSetupPage è¨ºæ–­æ©Ÿèƒ½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
 * ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã€è¨ºæ–­å±¥æ­´ç®¡ç†
 */

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let diagnosticHistoryCache = [];

/**
 * ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã‚’å®Ÿè¡Œ
 */
function runSystemDiagnosis() {
    executeSystemFunction('run-diagnosis-btn', 'ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ä¸­...', 'diagnoseDatabase', 'è¨ºæ–­å®Ÿè¡Œ');
}

/**
 * ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
 */
function runIntegrityCheck() {
    executeSystemFunction('run-integrity-btn', 'æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ä¸­...', 'performDataIntegrityCheck', 'æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯');
}

/**
 * å…±é€šã®ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½å®Ÿè¡Œé–¢æ•°
 */
function executeSystemFunction(buttonId, progressMessage, functionName, originalText) {
    const button = document.getElementById(buttonId);
    const spinner = button ? button.querySelector('.spinner') : null;
    const text = button ? button.querySelector('.btn-text') : null;
    
    if (button) {
        button.disabled = true;
        if (spinner) spinner.classList.remove('hidden');
        if (text) text.textContent = progressMessage;
    }

    google.script.run
        .withSuccessHandler(result => {
            displayDiagnosticResult(functionName, result);
            
            // UIå¾©å…ƒ
            if (button) {
                button.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (text) text.textContent = originalText;
            }
        })
        .withFailureHandler(error => {
            console.error(`${functionName} error:`, error);
            displayDiagnosticResult(functionName, {
                error: error.message,
                timestamp: new Date().toISOString(),
                summary: {
                    overallStatus: 'error',
                    criticalIssues: [`${functionName}ã®å®Ÿè¡Œã«å¤±æ•—: ${error.message}`]
                }
            });
            
            // UIå¾©å…ƒ
            if (button) {
                button.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (text) text.textContent = originalText;
            }
        })
        [functionName]();
}

/**
 * è¨ºæ–­çµæœã‚’è¡¨ç¤º
 */
function displayDiagnosticResult(functionName, result) {
    const resultsContainer = document.getElementById('diagnostic-results');
    if (!resultsContainer) return;

    // çµæœã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    const formattedResult = formatDiagnosticResult(functionName, result);
    
    // å±¥æ­´ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    cacheDiagnosticResult(functionName, result, formattedResult);
    
    // æ–°ã—ã„çµæœã‚’ä¸Šéƒ¨ã«è¿½åŠ 
    const resultDiv = document.createElement('div');
    resultDiv.className = `diagnostic-result mt-4 p-4 rounded-lg border ${formattedResult.cssClass}`;
    resultDiv.innerHTML = formattedResult.html;
    
    // æ—¢å­˜ã®çµæœã®ä¸Šã«æŒ¿å…¥
    resultsContainer.insertBefore(resultDiv, resultsContainer.firstChild);
    
    // 5ä»¶ä»¥ä¸Šã‚ã‚‹å ´åˆã¯å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
    const existingResults = resultsContainer.querySelectorAll('.diagnostic-result');
    if (existingResults.length > 5) {
        for (let i = 5; i < existingResults.length; i++) {
            existingResults[i].remove();
        }
    }
}

/**
 * è¨ºæ–­çµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
 */
function formatDiagnosticResult(functionName, result) {
    const timestamp = new Date(result.timestamp || Date.now()).toLocaleString('ja-JP');
    let message, type, problemCount, repairCount, successfulRepairs;

    // ã‚¨ãƒ©ãƒ¼å‡¦ç†
    if (result.error) {
        return {
            html: `
                <div class="flex items-start space-x-3">
                    <span class="text-2xl">âŒ</span>
                    <div>
                        <h4 class="font-semibold text-red-400">${getFunctionDisplayName(functionName)} - ã‚¨ãƒ©ãƒ¼</h4>
                        <p class="text-red-300 mt-1">${result.error}</p>
                        <p class="text-gray-400 text-sm mt-2">${timestamp}</p>
                    </div>
                </div>
            `,
            cssClass: 'border-red-500 bg-red-900/20',
            type: 'error',
            problemCount: 1,
            repairCount: 0,
            successfulRepairs: 0
        };
    }

    // é€šå¸¸ã®çµæœå‡¦ç†
    if (functionName === 'diagnoseDatabase') {
        problemCount = (result.summary?.criticalIssues?.length || 0) + (result.summary?.warnings?.length || 0);
        repairCount = 0;
        successfulRepairs = 0;
        
        if (result.summary?.overallStatus === 'critical') {
            message = `âŒ ${getFunctionDisplayName(functionName)}: ${problemCount}ä»¶ã®é‡è¦ãªå•é¡Œã‚’æ¤œå‡º`;
            type = 'error';
        } else if (result.summary?.overallStatus === 'warning' || problemCount > 0) {
            message = `âš ï¸ ${getFunctionDisplayName(functionName)}: ${problemCount}ä»¶ã®è­¦å‘Šã‚’æ¤œå‡º`;
            type = 'warning';
        } else {
            message = `âœ… ${getFunctionDisplayName(functionName)}: ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã§ã™`;
            type = 'success';
        }
    } else if (functionName === 'performDataIntegrityCheck') {
        problemCount = (result.summary?.issues?.length || 0) + (result.summary?.warnings?.length || 0);
        repairCount = result.summary?.fixed?.length || 0;
        successfulRepairs = repairCount;
        
        if (result.summary?.status === 'critical') {
            message = `âŒ ${getFunctionDisplayName(functionName)}: ${problemCount}ä»¶ã®å•é¡Œã‚’æ¤œå‡ºã€‚${successfulRepairs}/${repairCount}ä»¶ã®ä¿®å¾©ãŒæˆåŠŸã—ã¾ã—ãŸã€‚`;
            type = 'error';
        } else if (result.summary?.status === 'warning' || problemCount > 0) {
            message = `âš ï¸ ${getFunctionDisplayName(functionName)}: ${problemCount}ä»¶ã®å•é¡Œã‚’æ¤œå‡ºã€‚${successfulRepairs}/${repairCount}ä»¶ã®ä¿®å¾©ãŒæˆåŠŸã—ã¾ã—ãŸã€‚`;
            type = 'warning';
        } else {
            message = `âœ… ${getFunctionDisplayName(functionName)}: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã«å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“`;
            type = 'success';
        }
    }

    // CSS ã‚¯ãƒ©ã‚¹ã®æ±ºå®š
    let cssClass;
    if (type === 'error') {
        cssClass = 'border-red-500 bg-red-900/20';
    } else if (type === 'warning') {
        cssClass = 'border-yellow-500 bg-yellow-900/20';
    } else {
        cssClass = 'border-green-500 bg-green-900/20';
    }

    return {
        html: `
            <div class="flex items-start space-x-3">
                <span class="text-2xl">${type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'âœ…'}</span>
                <div>
                    <h4 class="font-semibold ${type === 'error' ? 'text-red-400' : type === 'warning' ? 'text-yellow-400' : 'text-green-400'}">${message}</h4>
                    <p class="text-gray-400 text-sm mt-2">${timestamp}</p>
                </div>
            </div>
        `,
        cssClass,
        type,
        problemCount,
        repairCount,
        successfulRepairs
    };
}

/**
 * é–¢æ•°åã‚’è¡¨ç¤ºç”¨ã«å¤‰æ›
 */
function getFunctionDisplayName(functionName) {
    const displayNames = {
        'diagnoseDatabase': 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨ºæ–­',
        'performDataIntegrityCheck': 'ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯'
    };
    return displayNames[functionName] || functionName;
}

/**
 * è¨ºæ–­çµæœã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
 */
function cacheDiagnosticResult(functionName, result, formattedResult) {
    const cacheEntry = {
        timestamp: result.timestamp || new Date().toISOString(),
        functionName,
        status: formattedResult.type,
        problemCount: formattedResult.problemCount || 0,
        repairCount: formattedResult.repairCount || 0,
        successfulRepairs: formattedResult.successfulRepairs || 0,
        summary: formattedResult.html.replace(/<[^>]*>/g, '').trim(),
        details: result
    };

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¿½åŠ ï¼ˆæœ€æ–°é †ï¼‰
    diagnosticHistoryCache.unshift(cacheEntry);
    
    // æœ€å¤§50ä»¶ã«åˆ¶é™
    if (diagnosticHistoryCache.length > 50) {
        diagnosticHistoryCache = diagnosticHistoryCache.slice(0, 50);
    }
    
    // localStorageã«ä¿å­˜
    try {
        localStorage.setItem('diagnosticHistoryCache', JSON.stringify(diagnosticHistoryCache));
    } catch (error) {
        console.warn('Failed to save diagnostic history to localStorage:', error);
    }
}

/**
 * è¨ºæ–­å±¥æ­´ã‚’è¡¨ç¤º
 */
function showDiagnosticHistory() {
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®è¨ºæ–­ãƒ­ã‚°ã‚’å–å¾—
    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                showDiagnosticHistoryModal(result.logs);
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
                showDiagnosticHistoryModal(diagnosticHistoryCache);
            }
        })
        .withFailureHandler(error => {
            console.error('Failed to fetch diagnostic history:', error);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
            showDiagnosticHistoryModal(diagnosticHistoryCache);
        })
        .getDiagnosticLogsForUI(50);
}

/**
 * è¨ºæ–­å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
 */
function showDiagnosticHistoryModal(logs) {
    const modal = document.getElementById('logs-modal');
    const title = modal.querySelector('h3');
    const header = document.getElementById('dynamic-header');
    const tbody = document.getElementById('logs-table-body');
    
    if (!modal || !header || !tbody) return;
    
    title.textContent = 'ğŸ“Š è¨ºæ–­å±¥æ­´';
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
    header.innerHTML = `
        <tr>
            <th class="px-4 py-2 text-left">å®Ÿè¡Œæ™‚åˆ»</th>
            <th class="px-4 py-2 text-left">æ©Ÿèƒ½</th>
            <th class="px-4 py-2 text-left">çŠ¶æ…‹</th>
            <th class="px-4 py-2 text-center">å•é¡Œæ•°</th>
            <th class="px-4 py-2 text-center">ä¿®å¾©æ•°</th>
            <th class="px-4 py-2 text-left">æ¦‚è¦</th>
        </tr>
    `;
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    if (!logs || logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                    è¨ºæ–­å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = logs.map(log => {
            const timestamp = new Date(log.timestamp).toLocaleString('ja-JP');
            const functionDisplayName = getFunctionDisplayName(log.functionName);
            const statusIcon = log.status === 'error' ? 'âŒ' : log.status === 'warning' ? 'âš ï¸' : 'âœ…';
            const statusClass = log.status === 'error' ? 'text-red-400' : log.status === 'warning' ? 'text-yellow-400' : 'text-green-400';
            
            return `
                <tr class="hover:bg-gray-700/50">
                    <td class="px-4 py-2 text-sm text-gray-300">${timestamp}</td>
                    <td class="px-4 py-2 text-sm text-white">${functionDisplayName}</td>
                    <td class="px-4 py-2 text-sm ${statusClass}">${statusIcon} ${log.status}</td>
                    <td class="px-4 py-2 text-sm text-center text-gray-300">${log.problemCount || 0}</td>
                    <td class="px-4 py-2 text-sm text-center text-gray-300">${log.successfulRepairs || 0}</td>
                    <td class="px-4 py-2 text-sm text-gray-300">${log.summary || log.message || ''}</td>
                </tr>
            `;
        }).join('');
    }
    
    modal.classList.remove('hidden');
}

/**
 * åˆæœŸåŒ–æ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã¿
 */
function initializeDiagnosticHistory() {
    try {
        const cached = localStorage.getItem('diagnosticHistoryCache');
        if (cached) {
            diagnosticHistoryCache = JSON.parse(cached);
        }
    } catch (error) {
        console.warn('Failed to load diagnostic history from localStorage:', error);
        diagnosticHistoryCache = [];
    }
}

// åˆæœŸåŒ–
initializeDiagnosticHistory();
</script>