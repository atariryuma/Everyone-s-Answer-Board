<script>

        let setupInProgress = false;

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const colors = {
                success: 'bg-green-600/20 border-green-500/50 text-green-100',
                error: 'bg-red-600/20 border-red-500/50 text-red-100',
                warning: 'bg-yellow-600/20 border-yellow-500/50 text-yellow-100',
                info: 'bg-blue-600/20 border-blue-500/50 text-blue-100'
            };
            
            messageArea.innerHTML = `
                <div class="message show glass-panel rounded-lg p-4 border ${colors[type]}">
                    <div class="flex items-center">
                        <div class="mr-3">
                            ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}
                        </div>
                        <div class="flex-1">${message}</div>
                        <button onclick="this.closest('.message').style.display='none'" class="ml-4 text-gray-400 hover:text-white">âœ•</button>
                    </div>
                </div>
            `;
        }

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
        function validateJSON(jsonString) {
            try {
                const parsed = JSON.parse(jsonString);
                const required = ['type', 'project_id', 'private_key_id', 'private_key', 'client_email'];
                for (const field of required) {
                    if (!parsed[field]) {
                        throw new Error(`å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ '${field}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                    }
                }
                if (parsed.type !== 'service_account') {
                    throw new Error('ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã®JSONã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                }
                return true;
            } catch (e) {
                throw new Error(`JSONå½¢å¼ãŒç„¡åŠ¹ã§ã™: ${e.message}`);
            }
        }

        function validateSpreadsheetId(id) {
            if (!id || id.length !== 44) {
                throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¯44æ–‡å­—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
            }
            if (!/^[a-zA-Z0-9_-]+$/.test(id)) {
                throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã«ç„¡åŠ¹ãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
            }
            return true;
        }

        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        document.getElementById('setup-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (setupInProgress) return;
            setupInProgress = true;

            const setupBtn = document.getElementById('setup-btn');
            const setupText = document.getElementById('setup-text');
            const setupSpinner = document.getElementById('setup-spinner');
            
            try {
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’å¤‰æ›´
                setupBtn.disabled = true;
                setupText.style.display = 'none';
                setupSpinner.classList.remove('hidden');
                
                // å…¥åŠ›å€¤å–å¾—
                const serviceAccountJson = document.getElementById('service-account-json').value.trim();
                const databaseId = document.getElementById('database-id').value.trim();
                
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                validateJSON(serviceAccountJson);
                validateSpreadsheetId(databaseId);
                
                showMessage('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œä¸­...', 'info');
                
                // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè¡Œ
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler((result) => {
                            showMessage('âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                            document.getElementById('test-section').classList.remove('hidden');
                            resolve(result);
                        })
                        .withFailureHandler((error) => {
                            console.error('Setup error:', error);
                            let displayMessage = `âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`;
                            if (error.message && error.message.includes('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šãŒã€Œåˆ¶é™ä»˜ãã€ã«ãªã£ã¦ã„ã¾ã›ã‚“')) {
                                displayMessage = `
                                    <p class="font-bold">${error.message}</p>
                                    <p class="mt-2">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’ã€Œåˆ¶é™ä»˜ãã€ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
                                    <p>å¤‰æ›´æ–¹æ³•: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ãã€ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ â†’ ã€Œä¸€èˆ¬çš„ãªã‚¢ã‚¯ã‚»ã‚¹ã€ã‚’ã€Œåˆ¶é™ä»˜ãã€ã«å¤‰æ›´ã€‚</p>
                                `;
                            }
                            showMessage(displayMessage, 'error');
                            reject(error);
                        })
                        .setupApplication(serviceAccountJson, databaseId);
                });
                
            } catch (error) {
                showMessage(`âŒ ${error.message}`, 'error');
            } finally {
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                setupBtn.disabled = false;
                setupText.style.display = 'inline';
                setupSpinner.classList.add('hidden');
                setupInProgress = false;
            }
        });

        // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³å‡¦ç†
        document.getElementById('test-btn').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<div class="loading-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mx-auto"></div>';
            
            google.script.run
                .withSuccessHandler((result) => {
                    showMessage(`${result.message}`, result.status === 'success' ? 'success' : 'warning');
                    this.disabled = false;
                    this.innerHTML = 'ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ';
                })
                .withFailureHandler((error) => {
                    showMessage(`ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`, 'error');
                    this.disabled = false;
                    this.innerHTML = 'ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ';
                })
                .testSetup();
        });

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        document.getElementById('service-account-json').addEventListener('blur', function() {
            try {
                if (this.value.trim()) {
                    validateJSON(this.value.trim());
                    this.style.borderColor = '#10b981';
                }
            } catch (e) {
                this.style.borderColor = '#ef4444';
            }
        });

        document.getElementById('database-id').addEventListener('input', function() {
            try {
                if (this.value.trim()) {
                    validateSpreadsheetId(this.value.trim());
                    this.style.borderColor = '#10b981';
                }
            } catch (e) {
                this.style.borderColor = '#ef4444';
            }
        });

        function startApp() {
            const btn = document.getElementById('start-studyquest-btn');
            if (btn) {
                btn.innerHTML = '<span>èª­ã¿è¾¼ã¿ä¸­...</span>';
                btn.disabled = true;
            }

            google.script.run
                .withSuccessHandler(function(url) {
                    window.top.location.href = url;
                })
                .withFailureHandler(function(error) {
                    alert('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®URLå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    if (btn) {
                        btn.innerHTML = 'ğŸ“š StudyQuestã‚’é–‹å§‹';
                        btn.disabled = false;
                    }
                })
                .getWebAppUrl();
        }
    
</script>
