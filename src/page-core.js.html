<script>
// =============================================================================
// STUDYQUEST APP CORE CLASS
// メインアプリケーションクラス - 初期化とコア機能
// =============================================================================

class StudyQuestApp {
  constructor() {
    this.cache = window.unifiedCache || new UnifiedCache();
    this.weakCache = new WeakMap();
    this.performanceMetrics = { frameTime: 0, domOperations: 0 };
    this.visibilityObserver = null;
    this.resizeObserver = null;
    this.deferredUpdates = new Set();
    this.animationFrameId = null;
    this.idleCallbackId = null;
    this.domFragmentPool = [];
    this.isLowPerformanceMode = true;
    
    // DOM Elements Cache
    this.elements = {
      body: document.body,
      mainContainer: document.getElementById('main-container'),
      answersContainer: document.getElementById('answers'),
      sizeSlider: document.getElementById('sizeSlider'),
      sliderValue: document.getElementById('sliderValue'),
      headingLabel: document.getElementById('headingLabel'),
      sheetNameText: document.getElementById('sheetNameText'),
      endPublicationBtn: document.getElementById('endPublicationBtn'),
      adminToggleBtn: document.getElementById('adminToggleBtn'),
      answerCount: document.getElementById('answerCount'),
      answerModalContainer: document.getElementById('answerModalContainer'),
      answerModalCloseBtn: document.getElementById('answerModalCloseBtn'),
      answerModalCard: document.getElementById('answerModalCard'),
      modalAnswer: document.getElementById('modalAnswer'),
      modalStudentName: document.getElementById('modalStudentName'),
      modalReactionContainer: document.getElementById('modalReactions'),
      modalFooter: document.getElementById('modalFooter'),
      infoModalContainer: document.getElementById('infoModalContainer'),
      infoModalCard: document.getElementById('infoModalCard'),
      infoModalConfirmBtn: document.getElementById('infoModalConfirmBtn'),
      infoIconLike: document.getElementById('infoIconLike'),
      infoIconUnderstand: document.getElementById('infoIconUnderstand'),
      infoIconCurious: document.getElementById('infoIconCurious'),
      infoIconHighlight: document.getElementById('infoIconHighlight'),
      newContentBanner: document.getElementById('newContentBanner'),
      newContentText: document.getElementById('newContentText'),
      refreshContentBtn: document.getElementById('refreshContentBtn'),
      dismissBannerBtn: document.getElementById('dismissBannerBtn'),
      iconClose: document.getElementById('iconClose'),
      iconGrid: document.getElementById('iconGrid'),
      classFilter: document.getElementById('classFilter'),
      sortOrder: document.getElementById('sortOrder'),
      scoreOption: document.getElementById('scoreOption'),
      footer: document.getElementById('controlsFooter'),
      loadingOverlay: document.getElementById('loading-overlay')
    };
    
    // Application State
    this.state = {
      currentAnswers: [],
      isLoading: false,
      lastFocusedElement: null,
      isStudentMode: window.isStudentMode,
      isAdminUser: window.isAdminUser,
      showCounts: window.showCounts,
      showAdminFeatures: false,
      showHighlightToggle: window.isAdminUser,
      showScoreSort: window.showScoreSort,
      displayMode: window.displayMode,
      sheetName: SHEET_NAME,
      userId: USER_ID,
      hasNewContent: false,
      newContentCount: 0,
      lastSeenCount: 0,
      pollingFailureCount: 0
    };
    
    // Initialization properties
    this.lastViewKey = null;
    this.initialDataLoaded = false;
    this.serverShowCounts = window.showCounts;
    this.serverDisplayMode = window.displayMode;
    this.pollingInterval = null;
    this.handlers = {};
    this.adminModeVerified = false;
    this.reactionDebounce = new Map();
    this.highlightDebounce = new Map();
    this.pendingReactions = new Set();
    this.eventDelegationSetup = false;
    this.nonCriticalListenersSetup = false;
    this.modalOperationPending = false;
    
    // Reaction types configuration
    this.reactionTypes = [
      { key: 'LIKE', icon: 'hand-thumb-up' },
      { key: 'UNDERSTAND', icon: 'lightbulb' },
      { key: 'CURIOUS', icon: 'magnifying-glass-plus' }
    ];
    
    this.reactionStorageKey = `reactions_${USER_ID}_${SHEET_NAME}`;
    
    // GAS API endpoints
    this.gas = {
      getPublishedSheetData: (classFilter, sort, adminMode, bypassCache) => 
        this.runGas('getPublishedSheetData', this.state.userId, classFilter, sort, adminMode, bypassCache),
      getIncrementalSheetData: (classFilter, sort, adminMode, sinceRowCount) => 
        this.runGas('getIncrementalSheetData', this.state.userId, classFilter, sort, adminMode, sinceRowCount),
      getAvailableSheets: () => 
        this.runGas('getAvailableSheets', this.state.userId),
      addReaction: (rowIndex, reaction, sheetName) => 
        this.runGas('addReaction', this.state.userId, rowIndex, reaction, sheetName),
      toggleHighlight: (rowIndex, sheetName) => 
        this.runGas('toggleHighlight', this.state.userId, rowIndex, sheetName),
      checkAdmin: () => 
        this.runGas('checkAdmin', this.state.userId),
      clearCache: () => 
        this.runGas('refreshBoardData', this.state.userId),
      getDataCount: (classFilter, sortOrder, adminMode) => 
        this.runGas('getDataCount', this.state.userId, classFilter, sortOrder, adminMode)
    };
    
    // Restore saved column setting
    const savedCols = localStorage.getItem('boardColumns');
    if (savedCols && this.elements.sizeSlider && this.elements.sliderValue) {
      this.elements.sizeSlider.value = savedCols;
      this.elements.sliderValue.textContent = savedCols;
    }
    
    this.init();
  }

  init() {
    pageLog('info', 'StudyQuestApp initialization started');
    
    // Show loading overlay
    this.showLoadingOverlay();
    
    // Timeout for initialization (15 seconds)
    this.initTimeoutId = setTimeout(() => {
      this.hideLoadingOverlay();
      pageLog('warn', 'Page initialization timeout');
    }, 15000);
    
    // Critical path only - non-blocking
    this.setupCriticalElements();
    this.showMinimalSkeleton();
    
    // Apply default low performance tweaks
    this.optimizeForLowPerformance();
    
    // Immediate async loading for data
    this.loadDataImmediate();
    
    // Defer all non-critical operations
    requestIdleCallback(() => {
      this.setupNonCriticalEventListeners();
      this.renderIcons();
      this.adjustLayout();
      this.updateSortOptions();
      this.setupObservers();
      
      // Initial admin state setup
      if (window.hasAdminCapability && window.isAdminUser) {
        this.state.isAdminUser = true;
        this.state.showAdminFeatures = false;
        if (this.elements.adminToggleBtn) {
          this.elements.adminToggleBtn.classList.remove('hidden');
          this.elements.adminToggleBtn.removeAttribute('hidden');
          this.elements.adminToggleBtn.style.display = '';
          this.elements.adminToggleBtn.textContent = '管理モード';
        }
      } else {
        this.state.isAdminUser = false;
        this.state.showAdminFeatures = false;
        if (this.elements.adminToggleBtn) {
          this.elements.adminToggleBtn.classList.add('hidden');
          this.elements.adminToggleBtn.setAttribute('hidden', '');
          this.elements.adminToggleBtn.style.display = 'none';
        }
      }
      
      // Check if modal should be shown
      const introSeen = localStorage.getItem('introSeen');
      if (!introSeen) {
        setTimeout(() => this.showInfoModal(), 500);
      }
    }, { timeout: 50 });

    // Listen for messages from AdminPanel
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'REFRESH_BOARD_DATA') {
        this.loadSheetData(true);
      }
    });
    
    pageLog('info', 'StudyQuestApp initialization completed');
  }

  setupCriticalElements() {
    if (this.elements.headingLabel) {
      const opinionHeader = __OPINION_HEADER__.startsWith('<') || __OPINION_HEADER__.includes('読み込み')
        ? 'お題'
        : this.escapeHtml(__OPINION_HEADER__);
      this.elements.headingLabel.textContent = opinionHeader;
    }

    // Setup critical event listeners
    this.setupEventDelegation();
    this.handlers.onAnswerModalCloseClick = () => this.hideAnswerModal();
    if (this.elements.answerModalCloseBtn) {
      this.elements.answerModalCloseBtn.addEventListener('click', this.handlers.onAnswerModalCloseClick);
    }
    
    // Size slider with throttling
    const debouncedRender = debounce(() => this.renderBoard(true), 200);
    this.handlers.onSizeSliderInput = throttle((e) => {
      localStorage.setItem('boardColumns', e.target.value);
      debouncedRender();
    }, 100);
    
    if (this.elements.sizeSlider) {
      this.elements.sizeSlider.addEventListener('input', this.handlers.onSizeSliderInput, { passive: true });
    }
  }

  // Essential utilities
  escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  showLoadingOverlay() {
    if (this.elements.loadingOverlay) {
      this.elements.loadingOverlay.classList.remove('hidden');
    }
  }

  hideLoadingOverlay() {
    if (this.elements.loadingOverlay) {
      this.elements.loadingOverlay.classList.add('hidden');
    }
    if (this.initTimeoutId) {
      clearTimeout(this.initTimeoutId);
      this.initTimeoutId = null;
    }
  }

  showMinimalSkeleton() {
    if (!this.elements.answersContainer) return;
    
    const skeletonHTML = Array(6).fill().map(() => `
      <div class="answer-card skeleton rounded-xl p-4 mb-4">
        <div class="h-4 bg-gray-600 rounded mb-2"></div>
        <div class="h-3 bg-gray-700 rounded mb-1"></div>
        <div class="h-3 bg-gray-700 rounded w-3/4"></div>
      </div>
    `).join('');
    
    this.elements.answersContainer.innerHTML = skeletonHTML;
  }

  // Placeholder methods to be extended by other modules
  setupEventDelegation() { /* Implemented in page-events.js */ }
  setupNonCriticalEventListeners() { /* Implemented in page-events.js */ }
  renderIcons() { /* Implemented in page-ui.js */ }
  adjustLayout() { /* Implemented in page-ui.js */ }
  updateSortOptions() { /* Implemented in page-ui.js */ }
  setupObservers() { /* Implemented in page-ui.js */ }
  loadDataImmediate() { /* Implemented in page-api.js */ }
  loadSheetData() { /* Implemented in page-api.js */ }
  runGas() { /* Implemented in page-api.js */ }
  optimizeForLowPerformance() { /* Implemented in page-ui.js */ }
  renderBoard() { /* Implemented in page-ui.js */ }
  showInfoModal() { /* Implemented in page-ui.js */ }
  hideAnswerModal() { /* Implemented in page-ui.js */ }
}

// Global app instance initialization
if (typeof window.app === 'undefined') {
  try {
    window.app = new StudyQuestApp();
    pageLog('info', 'StudyQuestApp global instance created');
  } catch (error) {
    pageLog('error', 'Failed to initialize StudyQuestApp:', error);
    handleError(error, 'StudyQuestApp initialization');
  }
}
</script>