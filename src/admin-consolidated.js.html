<script>
// =============================================================================
// CONSOLIDATED ADMIN PANEL CORE FUNCTIONALITY
// =============================================================================
// This file consolidates adminPanel.js.html and adminPanel-core.js.html
// to reduce redundancy and improve maintainability

// =============================================================================
// UNIFIED MANAGEMENT SYSTEM API - çµ±ä¸€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ API
// =============================================================================

/**
 * çµ±ä¸€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - å…¨ç®¡ç†ã‚¯ãƒ©ã‚¹ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 */
window.unifiedManagement = {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç† (CacheManager)
  cache: {
    get: function(key, valueFn, options) {
      return typeof cacheManager !== 'undefined' ? cacheManager.get(key, valueFn, options) : (valueFn ? valueFn() : null);
    },
    remove: function(key) {
      return typeof cacheManager !== 'undefined' ? cacheManager.remove(key) : null;
    },
    clearAll: function() {
      return typeof cacheManager !== 'undefined' ? cacheManager.clearAll() : null;
    },
    clearFrontend: function(options) {
      return typeof cacheManager !== 'undefined' ? cacheManager.clearAllFrontendCaches(options) : Promise.resolve({ success: false });
    },
    clearSpecific: function(type) {
      return typeof cacheManager !== 'undefined' ? cacheManager.clearSpecificCache(type) : Promise.resolve({ success: false });
    },
    diagnose: function() {
      return typeof cacheManager !== 'undefined' ? cacheManager.diagnoseFrontendCache() : { available: false };
    },
    getHealth: function() {
      return typeof cacheManager !== 'undefined' ? cacheManager.getHealth() : { status: 'unavailable' };
    }
  },

  // ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡ (TimingManager)  
  timing: {
    delay: function(ms, id) {
      return typeof TimingManager !== 'undefined' ? TimingManager.delay(ms, id) : new Promise(function(resolve) {
        setTimeout(resolve, ms);
      });
    },
    sequence: function(operations, intervalMs, sequenceId) {
      return typeof TimingManager !== 'undefined' ? TimingManager.sequence(operations, intervalMs, sequenceId) : Promise.resolve([]);
    },
    parallel: function(operations, concurrency) {
      return typeof TimingManager !== 'undefined' ? TimingManager.parallel(operations, concurrency) : Promise.all(operations.map(function(op) {
        return op();
      }));
    },
    debounce: function(func, key, delay) {
      return typeof TimingManager !== 'undefined' ? TimingManager.debounce(func, key, delay) : func;
    },
    throttle: function(func, key, delay) {
      return typeof TimingManager !== 'undefined' ? TimingManager.throttle(func, key, delay) : func;
    }
  },

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¶å¾¡
  loading: {
    show: function(options) {
      if (typeof UnifiedLoadingManager !== 'undefined') {
        return UnifiedLoadingManager.showLoading(options);
      }
      return { success: false };
    },
    hide: function(options) {
      if (typeof UnifiedLoadingManager !== 'undefined') {
        return UnifiedLoadingManager.hideLoading(options);
      }
      return { success: false };
    },
    update: function(progress, message) {
      if (typeof UnifiedLoadingManager !== 'undefined') {
        return UnifiedLoadingManager.updateProgress(progress, message);
      }
      return { success: false };
    }
  }
};

// =============================================================================
// STEP VALIDATION AND MANAGEMENT
// =============================================================================

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰å–å¾—
 */
function getSetupStatusFromGlobalStatus() {
  try {
    if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
      var config = typeof currentStatus.userInfo.configJson === 'string' 
        ? JSON.parse(currentStatus.userInfo.configJson) 
        : currentStatus.userInfo.configJson;
      return config.setupStatus || 'pending';
    }
    return 'pending';
  } catch (error) {
    logWarn('getSetupStatusFromGlobalStatus ã‚¨ãƒ©ãƒ¼:', error);
    return 'pending';
  }
}

/**
 * ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ¤œè¨¼ã—ã€UIçŠ¶æ…‹ã‚’æ›´æ–°
 */
function validateCurrentStep() {
  var savePublishBtn = document.getElementById('save-publish-btn');
  if (!savePublishBtn) return;
  
  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ç¢ºèª
  var setupStatus = getSetupStatusFromGlobalStatus();
  
  var isValid = false;
  
  // currentStepãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
  if (typeof currentStep === 'undefined') {
    console.warn('currentStep is not defined, defaulting to 1');
    currentStep = 1;
  }
  
  switch (currentStep) {
    case 1:
      isValid = (typeof selectedSheetId !== 'undefined' && selectedSheetId) || 
                (typeof selectedFormId !== 'undefined' && selectedFormId);
      break;
    case 2:
      // Step 2 validation: check for both config validation AND setup completion
      var configValid = (typeof currentConfig !== 'undefined' && currentConfig) && 
                       (typeof validateConfiguration === 'function' ? validateConfiguration() : true);
      var step2Complete = typeof checkStep2Completion === 'function' ? checkStep2Completion() : false;
      isValid = configValid || step2Complete;
      logDebug('Step 2 validation: configValid=' + configValid + ', step2Complete=' + step2Complete + ', isValid=' + isValid);
      break;
    case 3:
      isValid = true;
      break;
    default:
      isValid = false;
  }
  
  savePublishBtn.disabled = !isValid;
}

/**
 * Step 2ã®å®Œäº†çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
 */
function checkStep2Completion() {
  try {
    // åŸºæœ¬çš„ãªè¨­å®šé …ç›®ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    var hasValidConfig = currentConfig && 
                        typeof currentConfig === 'object' && 
                        Object.keys(currentConfig).length > 0;
    
    // UIè¦ç´ ã®çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯  
    var hasFormSelection = document.querySelector('input[name="form-option"]:checked');
    var hasSheetSelection = document.getElementById('sheet-select') && 
                           document.getElementById('sheet-select').value;
    
    return hasValidConfig || hasFormSelection || hasSheetSelection;
  } catch (error) {
    logWarn('checkStep2Completion ã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}

/**
 * è¨­å®šã®å¦¥å½“æ€§ã‚’æ¤œè¨¼
 */
function validateConfiguration() {
  try {
    if (!currentConfig || typeof currentConfig !== 'object') {
      return false;
    }
    
    // åŸºæœ¬çš„ãªå¿…é ˆé …ç›®ã®ãƒã‚§ãƒƒã‚¯
    var requiredFields = ['timestampHeader', 'opinionHeader'];
    for (var i = 0; i < requiredFields.length; i++) {
      var field = requiredFields[i];
      if (!currentConfig[field]) {
        logDebug('Missing required field: ' + field);
        return false;
      }
    }
    
    return true;
  } catch (error) {
    logWarn('validateConfiguration ã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}

// =============================================================================
// UI HELPER FUNCTIONS
// =============================================================================

/**
 * å®‰å…¨ãªDOMè¦ç´ å–å¾—
 */
function safeGetElement(selector) {
  try {
    return document.querySelector(selector);
  } catch (error) {
    console.warn('DOMè¦ç´ ã®å–å¾—ã«å¤±æ•—:', selector, error);
    return null;
  }
}

/**
 * å®‰å…¨ãªã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
 */
function safeAddEventListener(element, event, handler) {
  if (!element) return false;
  
  try {
    element.addEventListener(event, handler);
    return true;
  } catch (error) {
    console.warn('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²ã«å¤±æ•—:', event, error);
    return false;
  }
}

/**
 * è¦ç´ ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’å®‰å…¨ã«åˆ‡ã‚Šæ›¿ãˆ
 */
function safeToggleVisibility(selector, isVisible) {
  var element = safeGetElement(selector);
  if (!element) return false;
  
  try {
    if (isVisible) {
      element.style.display = '';
      element.classList.remove('hidden');
    } else {
      element.style.display = 'none';
      element.classList.add('hidden');
    }
    return true;
  } catch (error) {
    console.warn('è¦ç´ ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—:', selector, error);
    return false;
  }
}

// =============================================================================
// INITIALIZATION
// =============================================================================

/**
 * çµ±åˆã‚³ã‚¢æ©Ÿèƒ½ã®åˆæœŸåŒ–
 */
function initializeAdminCore() {
  console.log('ğŸ”§ Admin Core initializing...');
  
  try {
    // åŸºæœ¬çš„ãªUIçŠ¶æ…‹ã®åˆæœŸåŒ–
    if (typeof validateCurrentStep === 'function') {
      validateCurrentStep();
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¨­å®š
    window.addEventListener('error', function(event) {
      if (event.error && event.error.message) {
        logError('Global error caught:', event.error.message);
      }
    });
    
    // Promiseã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('unhandledrejection', function(event) {
      logError('Unhandled promise rejection:', event.reason);
      event.preventDefault(); // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’é˜²ã
    });
    
    console.log('âœ… Admin Core initialized successfully');
    return true;
  } catch (error) {
    console.error('âŒ Admin Core initialization failed:', error);
    return false;
  }
}

// DOMæº–å‚™å®Œäº†å¾Œã«åˆæœŸåŒ–å®Ÿè¡Œ
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeAdminCore);
} else {
  initializeAdminCore();
}

// =============================================================================
// LEGACY COMPATIBILITY
// =============================================================================

// æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ã€ä¸»è¦ãªé–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é…ç½®
window.validateCurrentStep = validateCurrentStep;
window.getSetupStatusFromGlobalStatus = getSetupStatusFromGlobalStatus;
window.checkStep2Completion = checkStep2Completion;
window.validateConfiguration = validateConfiguration;
window.safeGetElement = safeGetElement;
window.safeAddEventListener = safeAddEventListener;
window.safeToggleVisibility = safeToggleVisibility;

</script>