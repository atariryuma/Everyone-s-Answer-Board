<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content="2;url=<?= htmlEncode(targetUrl) ?>">
  <title>リダイレクト中...</title>
  <style>
    body { text-align:center; padding:50px; font-family:sans-serif; background-color:#f5f5f5; }
    div { max-width:600px; margin:0 auto; background:white; padding:40px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    h2 { color:#333; margin-bottom:20px; }
    p { color:#666; margin-bottom:30px; }
    a { display:inline-block; background:#4CAF50; color:white; padding:12px 24px; text-decoration:none; border-radius:5px; font-weight:bold; }
    .small { color:#999; font-size:14px; margin-top:20px; }
  </style>
</head>
<body>
  <div>
    <h2><?= message ?></h2>
    <p>2秒後に自動的にリダイレクトされます...</p>
    <a href="<?= htmlEncode(targetUrl) ?>" onclick="handleRedirectClick(event)">今すぐ移動</a>
    <p class="small">自動的にリダイレクトされない場合は上のリンクをクリックしてください。</p>
  </div>
  <script>
    // Safe URL variable with robust handling
    var safeTargetUrl = '<?= escapeJavaScript(targetUrl) ?>';
    
    // URL validation and cleanup
    function validateAndCleanUrl(url) {
      if (!url) return '';
      
      // Remove any quotes that might have been added
      var cleanUrl = url.replace(/^["']|["']$/g, '');
      
      // Basic URL validation
      if (cleanUrl.match(/^https?:\/\/[^\s<>"']+$/)) {
        return cleanUrl;
      }
      
      console.warn('Invalid URL format:', cleanUrl);
      return '';
    }
    
    function handleRedirectClick(event) {
      event.preventDefault();
      var finalUrl = validateAndCleanUrl(safeTargetUrl);
      if (!finalUrl) {
        console.error('Invalid redirect URL');
        return;
      }
      
      try {
        window.top.location.href = finalUrl;
      } catch(e) {
        window.location.href = finalUrl;
      }
    }
    
    setTimeout(function() {
      var finalUrl = validateAndCleanUrl(safeTargetUrl);
      if (!finalUrl) {
        console.error('Invalid redirect URL for auto-redirect');
        return;
      }
      
      try {
        window.top.location.href = finalUrl;
      } catch(e) {
        window.location.href = finalUrl;
      }
    }, 2000);
  </script>
</body>
</html>