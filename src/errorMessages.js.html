<script>
/**
 * 多言語対応エラーメッセージシステム
 * UI/UX向上のための統一されたエラーハンドリング
 */

// エラーメッセージの多言語定義
const ERROR_MESSAGES = {
  ja: {
    // 一般的なエラー
    GENERIC_ERROR: 'エラーが発生しました',
    NETWORK_ERROR: 'ネットワーク接続に問題があります',
    TIMEOUT_ERROR: 'リクエストがタイムアウトしました',
    PERMISSION_ERROR: 'アクセス権限がありません',
    
    // CustomSetup関連
    CUSTOM_SETUP_FAILED: 'カスタムセットアップに失敗しました',
    CUSTOM_SETUP_CANCELLED: 'カスタムセットアップが中断されました',
    CUSTOM_SETUP_TIMEOUT: 'カスタムセットアップがタイムアウトしました',
    AI_DETECTION_FAILED: 'AI列判定に失敗しました',
    FORM_CREATION_FAILED: 'フォーム作成に失敗しました',
    PUBLISH_FAILED: '公開処理に失敗しました',
    
    // QuickStart関連
    QUICK_START_FAILED: 'クイックスタートに失敗しました',
    QUICK_START_TIMEOUT: 'クイックスタートがタイムアウトしました',
    
    // キャッシュ関連
    CACHE_ERROR: 'キャッシュの処理中にエラーが発生しました',
    CACHE_CLEAR_FAILED: 'キャッシュのクリアに失敗しました',
    
    // データベース関連
    DATABASE_ERROR: 'データベース処理中にエラーが発生しました',
    USER_NOT_FOUND: 'ユーザーが見つかりません',
    CONFIG_SAVE_FAILED: '設定の保存に失敗しました',
    
    // Google Apps Script関連
    GAS_API_ERROR: 'Google Apps Script APIでエラーが発生しました',
    SPREADSHEET_ACCESS_ERROR: 'スプレッドシートにアクセスできません',
    FORM_ACCESS_ERROR: 'フォームにアクセスできません',
    
    // 解決策の提案
    SOLUTIONS: {
      NETWORK_ERROR: '・インターネット接続を確認してください\n・しばらく時間をおいて再試行してください',
      TIMEOUT_ERROR: '・処理に時間がかかっています\n・しばらく待ってから再度確認してください',
      PERMISSION_ERROR: '・ログイン状態を確認してください\n・必要な権限が付与されているか確認してください',
      CUSTOM_SETUP_FAILED: '・入力内容を確認してください\n・ブラウザを更新して再試行してください',
      AI_DETECTION_FAILED: '・スプレッドシートのデータを確認してください\n・データが正しい形式で入力されているか確認してください'
    }
  },
  
  en: {
    // General errors
    GENERIC_ERROR: 'An error occurred',
    NETWORK_ERROR: 'Network connection issue',
    TIMEOUT_ERROR: 'Request timed out',
    PERMISSION_ERROR: 'Access permission denied',
    
    // CustomSetup related
    CUSTOM_SETUP_FAILED: 'Custom setup failed',
    CUSTOM_SETUP_CANCELLED: 'Custom setup was cancelled',
    CUSTOM_SETUP_TIMEOUT: 'Custom setup timed out',
    AI_DETECTION_FAILED: 'AI detection failed',
    FORM_CREATION_FAILED: 'Form creation failed',
    PUBLISH_FAILED: 'Publishing failed',
    
    // QuickStart related
    QUICK_START_FAILED: 'Quick start failed',
    QUICK_START_TIMEOUT: 'Quick start timed out',
    
    // Cache related
    CACHE_ERROR: 'Cache processing error',
    CACHE_CLEAR_FAILED: 'Cache clearing failed',
    
    // Database related
    DATABASE_ERROR: 'Database processing error',
    USER_NOT_FOUND: 'User not found',
    CONFIG_SAVE_FAILED: 'Configuration save failed',
    
    // Google Apps Script related
    GAS_API_ERROR: 'Google Apps Script API error',
    SPREADSHEET_ACCESS_ERROR: 'Cannot access spreadsheet',
    FORM_ACCESS_ERROR: 'Cannot access form',
    
    // Solution suggestions
    SOLUTIONS: {
      NETWORK_ERROR: '• Check your internet connection\n• Try again after a moment',
      TIMEOUT_ERROR: '• Processing is taking time\n• Please check again later',
      PERMISSION_ERROR: '• Check your login status\n• Verify required permissions are granted',
      CUSTOM_SETUP_FAILED: '• Check your input\n• Refresh browser and try again',
      AI_DETECTION_FAILED: '• Check spreadsheet data\n• Verify data is in correct format'
    }
  }
};

// エラーの重要度レベル
const ERROR_SEVERITY = {
  LOW: 'low',
  MEDIUM: 'medium',
  HIGH: 'high',
  CRITICAL: 'critical'
};

// エラータイプの定義
const ERROR_TYPES = {
  NETWORK: 'network',
  TIMEOUT: 'timeout',
  PERMISSION: 'permission',
  VALIDATION: 'validation',
  SYSTEM: 'system',
  USER: 'user'
};

/**
 * 統一エラーハンドラークラス
 */
class UnifiedErrorHandler {
  constructor() {
    this.language = this.detectLanguage();
    this.errorHistory = [];
    this.maxHistorySize = 50;
  }
  
  /**
   * 言語を自動検出
   */
  detectLanguage() {
    const browserLang = navigator.language || navigator.userLanguage;
    return browserLang.startsWith('ja') ? 'ja' : 'en';
  }
  
  /**
   * エラーメッセージを取得
   */
  getMessage(errorKey, fallbackMessage = null) {
    const messages = ERROR_MESSAGES[this.language] || ERROR_MESSAGES.ja;
    return messages[errorKey] || fallbackMessage || messages.GENERIC_ERROR;
  }
  
  /**
   * 解決策を取得
   */
  getSolution(errorKey) {
    const messages = ERROR_MESSAGES[this.language] || ERROR_MESSAGES.ja;
    return messages.SOLUTIONS[errorKey] || null;
  }
  
  /**
   * エラーを処理して表示
   */
  handleError(error, context = '', severity = ERROR_SEVERITY.MEDIUM, type = ERROR_TYPES.SYSTEM) {
    const errorInfo = this.categorizeError(error, context, severity, type);
    
    // エラー履歴に追加
    this.addToHistory(errorInfo);
    
    // 重要度に応じてログ出力
    this.logError(errorInfo);
    
    // ユーザーに表示
    this.displayError(errorInfo);
    
    return errorInfo;
  }
  
  /**
   * エラーを分類
   */
  categorizeError(error, context, severity, type) {
    let errorKey = 'GENERIC_ERROR';
    let specificMessage = error.message || error.toString();
    
    // エラーメッセージからキーを推定
    if (specificMessage.includes('timeout') || specificMessage.includes('タイムアウト')) {
      errorKey = 'TIMEOUT_ERROR';
      type = ERROR_TYPES.TIMEOUT;
    } else if (specificMessage.includes('network') || specificMessage.includes('ネットワーク')) {
      errorKey = 'NETWORK_ERROR';
      type = ERROR_TYPES.NETWORK;
    } else if (specificMessage.includes('permission') || specificMessage.includes('権限')) {
      errorKey = 'PERMISSION_ERROR';
      type = ERROR_TYPES.PERMISSION;
    } else if (context.includes('customSetup') || context.includes('カスタムセットアップ')) {
      errorKey = 'CUSTOM_SETUP_FAILED';
    } else if (context.includes('quickStart') || context.includes('クイックスタート')) {
      errorKey = 'QUICK_START_FAILED';
    }
    
    return {
      originalError: error,
      errorKey,
      message: this.getMessage(errorKey),
      solution: this.getSolution(errorKey),
      specificMessage,
      context,
      severity,
      type,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      url: window.location.href
    };
  }
  
  /**
   * エラー履歴に追加
   */
  addToHistory(errorInfo) {
    this.errorHistory.unshift(errorInfo);
    if (this.errorHistory.length > this.maxHistorySize) {
      this.errorHistory = this.errorHistory.slice(0, this.maxHistorySize);
    }
  }
  
  /**
   * エラーをログ出力
   */
  logError(errorInfo) {
    const logMessage = `[${errorInfo.context}] ${errorInfo.message}`;
    
    switch (errorInfo.severity) {
      case ERROR_SEVERITY.CRITICAL:
        logError(' CRITICAL:', logMessage, errorInfo);
        break;
      case ERROR_SEVERITY.HIGH:
        logError(' HIGH:', logMessage, errorInfo.specificMessage);
        break;
      case ERROR_SEVERITY.MEDIUM:
        logWarn('️ MEDIUM:', logMessage, errorInfo.specificMessage);
        break;
      case ERROR_SEVERITY.LOW:
        logDebug('️ LOW:', logMessage);
        break;
    }
  }
  
  /**
   * ユーザーにエラーを表示
   */
  displayError(errorInfo) {
    const displayMessage = this.formatErrorDisplay(errorInfo);
    
    // 既存のshowMessage関数を使用
    if (typeof showMessage === 'function') {
      const messageType = this.getMessageType(errorInfo.severity);
      showMessage(displayMessage, messageType);
    } else {
      // フォールバック表示
      alert(displayMessage);
    }
  }
  
  /**
   * エラー表示をフォーマット
   */
  formatErrorDisplay(errorInfo) {
    let message = errorInfo.message;
    
    if (errorInfo.solution && errorInfo.severity !== ERROR_SEVERITY.LOW) {
      message += '\n\n' + (this.language === 'ja' ? '解決策:' : 'Solutions:') + '\n' + errorInfo.solution;
    }
    
    return message;
  }
  
  /**
   * 重要度からメッセージタイプを取得
   */
  getMessageType(severity) {
    switch (severity) {
      case ERROR_SEVERITY.CRITICAL:
      case ERROR_SEVERITY.HIGH:
        return 'error';
      case ERROR_SEVERITY.MEDIUM:
        return 'warning';
      case ERROR_SEVERITY.LOW:
        return 'info';
      default:
        return 'error';
    }
  }
  
  /**
   * エラー履歴を取得
   */
  getErrorHistory() {
    return this.errorHistory;
  }
  
  /**
   * エラー履歴をクリア
   */
  clearErrorHistory() {
    this.errorHistory = [];
  }
  
  /**
   * 言語を変更
   */
  setLanguage(lang) {
    if (ERROR_MESSAGES[lang]) {
      this.language = lang;
    }
  }
}

// グローバルインスタンスを作成
window.unifiedErrorHandler = new UnifiedErrorHandler();

// Attach to AdminPanel namespace
window.AdminPanel = window.AdminPanel || {};
window.AdminPanel.errors = window.AdminPanel.errors || {};
window.AdminPanel.errors.handle = (error, context, severity, type) => {
  return window.unifiedErrorHandler.handleError(error, context, severity, type);
};

// Backward compatibility
window.handleError = window.AdminPanel.errors.handle;
window.ERROR_SEVERITY = ERROR_SEVERITY;
window.ERROR_TYPES = ERROR_TYPES;

logDebug(' Unified Error Handler initialized');
</script>