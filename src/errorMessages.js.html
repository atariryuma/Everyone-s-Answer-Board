<script>
/**
 * å¤šè¨€èªžå¯¾å¿œã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ 
 * UI/UXå‘ä¸Šã®ãŸã‚ã®çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
 */

// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¤šè¨€èªžå®šç¾©
const ERROR_MESSAGES = {
  ja: {
    // ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼
    GENERIC_ERROR: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
    NETWORK_ERROR: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æŽ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™',
    TIMEOUT_ERROR: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ',
    PERMISSION_ERROR: 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“',
    
    // CustomSetupé–¢é€£
    CUSTOM_SETUP_FAILED: 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ',
    CUSTOM_SETUP_CANCELLED: 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸ',
    CUSTOM_SETUP_TIMEOUT: 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ',
    AI_DETECTION_FAILED: 'AIåˆ—åˆ¤å®šã«å¤±æ•—ã—ã¾ã—ãŸ',
    FORM_CREATION_FAILED: 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ',
    PUBLISH_FAILED: 'å…¬é–‹å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ',
    
    // QuickStarté–¢é€£
    QUICK_START_FAILED: 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ',
    QUICK_START_TIMEOUT: 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ',
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥é–¢é€£
    CACHE_ERROR: 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
    CACHE_CLEAR_FAILED: 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ',
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£
    DATABASE_ERROR: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
    USER_NOT_FOUND: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
    CONFIG_SAVE_FAILED: 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ',
    
    // Google Apps Scripté–¢é€£
    GAS_API_ERROR: 'Google Apps Script APIã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
    SPREADSHEET_ACCESS_ERROR: 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“',
    FORM_ACCESS_ERROR: 'ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“',
    
    // è§£æ±ºç­–ã®ææ¡ˆ
    SOLUTIONS: {
      NETWORK_ERROR: 'ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„\nãƒ»ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„',
      TIMEOUT_ERROR: 'ãƒ»å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™\nãƒ»ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ç¢ºèªã—ã¦ãã ã•ã„',
      PERMISSION_ERROR: 'ãƒ»ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„\nãƒ»å¿…è¦ãªæ¨©é™ãŒä»˜ä¸Žã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„',
      CUSTOM_SETUP_FAILED: 'ãƒ»å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„\nãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„',
      AI_DETECTION_FAILED: 'ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„\nãƒ»ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„'
    }
  },
  
  en: {
    // General errors
    GENERIC_ERROR: 'An error occurred',
    NETWORK_ERROR: 'Network connection issue',
    TIMEOUT_ERROR: 'Request timed out',
    PERMISSION_ERROR: 'Access permission denied',
    
    // CustomSetup related
    CUSTOM_SETUP_FAILED: 'Custom setup failed',
    CUSTOM_SETUP_CANCELLED: 'Custom setup was cancelled',
    CUSTOM_SETUP_TIMEOUT: 'Custom setup timed out',
    AI_DETECTION_FAILED: 'AI detection failed',
    FORM_CREATION_FAILED: 'Form creation failed',
    PUBLISH_FAILED: 'Publishing failed',
    
    // QuickStart related
    QUICK_START_FAILED: 'Quick start failed',
    QUICK_START_TIMEOUT: 'Quick start timed out',
    
    // Cache related
    CACHE_ERROR: 'Cache processing error',
    CACHE_CLEAR_FAILED: 'Cache clearing failed',
    
    // Database related
    DATABASE_ERROR: 'Database processing error',
    USER_NOT_FOUND: 'User not found',
    CONFIG_SAVE_FAILED: 'Configuration save failed',
    
    // Google Apps Script related
    GAS_API_ERROR: 'Google Apps Script API error',
    SPREADSHEET_ACCESS_ERROR: 'Cannot access spreadsheet',
    FORM_ACCESS_ERROR: 'Cannot access form',
    
    // Solution suggestions
    SOLUTIONS: {
      NETWORK_ERROR: 'â€¢ Check your internet connection\nâ€¢ Try again after a moment',
      TIMEOUT_ERROR: 'â€¢ Processing is taking time\nâ€¢ Please check again later',
      PERMISSION_ERROR: 'â€¢ Check your login status\nâ€¢ Verify required permissions are granted',
      CUSTOM_SETUP_FAILED: 'â€¢ Check your input\nâ€¢ Refresh browser and try again',
      AI_DETECTION_FAILED: 'â€¢ Check spreadsheet data\nâ€¢ Verify data is in correct format'
    }
  }
};

// ã‚¨ãƒ©ãƒ¼ã®é‡è¦åº¦ãƒ¬ãƒ™ãƒ«
// ERROR_SEVERITY is defined in constants.gs

// ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã®å®šç¾©
// ERROR_TYPES is defined in constants.gs

/**
 * çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
 */
class UnifiedErrorHandler {
  constructor() {
    this.language = this.detectLanguage();
    this.errorHistory = [];
    this.maxHistorySize = 50;
  }
  
  /**
   * è¨€èªžã‚’è‡ªå‹•æ¤œå‡º
   */
  detectLanguage() {
    const browserLang = navigator.language || navigator.userLanguage;
    return browserLang.startsWith('ja') ? 'ja' : 'en';
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
   */
  getMessage(errorKey, fallbackMessage = null) {
    const messages = ERROR_MESSAGES[this.language] || ERROR_MESSAGES.ja;
    return messages[errorKey] || fallbackMessage || messages.GENERIC_ERROR;
  }
  
  /**
   * è§£æ±ºç­–ã‚’å–å¾—
   */
  getSolution(errorKey) {
    const messages = ERROR_MESSAGES[this.language] || ERROR_MESSAGES.ja;
    return messages.SOLUTIONS[errorKey] || null;
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã—ã¦è¡¨ç¤º
   */
  handleError(error, context = '', severity = ERROR_SEVERITY.MEDIUM, type = ERROR_TYPES.SYSTEM) {
    const errorInfo = this.categorizeError(error, context, severity, type);
    
    // ã‚¨ãƒ©ãƒ¼å±¥æ­´ã«è¿½åŠ 
    this.addToHistory(errorInfo);
    
    // é‡è¦åº¦ã«å¿œã˜ã¦ãƒ­ã‚°å‡ºåŠ›
    this.logError(errorInfo);
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
    this.displayError(errorInfo);
    
    return errorInfo;
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼ã‚’åˆ†é¡ž
   */
  categorizeError(error, context, severity, type) {
    let errorKey = 'GENERIC_ERROR';
    let specificMessage = error.message || error.toString();
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã‚­ãƒ¼ã‚’æŽ¨å®š
    if (specificMessage.includes('timeout') || specificMessage.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
      errorKey = 'TIMEOUT_ERROR';
      type = ERROR_TYPES.TIMEOUT;
    } else if (specificMessage.includes('network') || specificMessage.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯')) {
      errorKey = 'NETWORK_ERROR';
      type = ERROR_TYPES.NETWORK;
    } else if (specificMessage.includes('permission') || specificMessage.includes('æ¨©é™')) {
      errorKey = 'PERMISSION_ERROR';
      type = ERROR_TYPES.PERMISSION;
    } else if (context.includes('customSetup') || context.includes('ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—')) {
      errorKey = 'CUSTOM_SETUP_FAILED';
    } else if (context.includes('quickStart') || context.includes('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ')) {
      errorKey = 'QUICK_START_FAILED';
    }
    
    return {
      originalError: error,
      errorKey,
      message: this.getMessage(errorKey),
      solution: this.getSolution(errorKey),
      specificMessage,
      context,
      severity,
      type,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      url: window.location.href
    };
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼å±¥æ­´ã«è¿½åŠ 
   */
  addToHistory(errorInfo) {
    this.errorHistory.unshift(errorInfo);
    if (this.errorHistory.length > this.maxHistorySize) {
      this.errorHistory = this.errorHistory.slice(0, this.maxHistorySize);
    }
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°å‡ºåŠ›
   */
  logError(errorInfo) {
    const logMessage = `[${errorInfo.context}] ${errorInfo.message}`;
    
    switch (errorInfo.severity) {
      case ERROR_SEVERITY.CRITICAL:
        console.error('ðŸš¨ CRITICAL:', logMessage, errorInfo);
        break;
      case ERROR_SEVERITY.HIGH:
        console.error('âŒ HIGH:', logMessage, errorInfo.specificMessage);
        break;
      case ERROR_SEVERITY.MEDIUM:
        console.warn('âš ï¸ MEDIUM:', logMessage, errorInfo.specificMessage);
        break;
      case ERROR_SEVERITY.LOW:
        console.log('â„¹ï¸ LOW:', logMessage);
        break;
    }
  }
  
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
   */
  displayError(errorInfo) {
    const displayMessage = this.formatErrorDisplay(errorInfo);
    
    // æ—¢å­˜ã®showMessageé–¢æ•°ã‚’ä½¿ç”¨
    if (typeof showMessage === 'function') {
      const messageType = this.getMessageType(errorInfo.severity);
      showMessage(displayMessage, messageType);
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
      alert(displayMessage);
    }
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
   */
  formatErrorDisplay(errorInfo) {
    let message = errorInfo.message;
    
    if (errorInfo.solution && errorInfo.severity !== ERROR_SEVERITY.LOW) {
      message += '\n\n' + (this.language === 'ja' ? 'è§£æ±ºç­–:' : 'Solutions:') + '\n' + errorInfo.solution;
    }
    
    return message;
  }
  
  /**
   * é‡è¦åº¦ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã‚’å–å¾—
   */
  getMessageType(severity) {
    switch (severity) {
      case ERROR_SEVERITY.CRITICAL:
      case ERROR_SEVERITY.HIGH:
        return 'error';
      case ERROR_SEVERITY.MEDIUM:
        return 'warning';
      case ERROR_SEVERITY.LOW:
        return 'info';
      default:
        return 'error';
    }
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼å±¥æ­´ã‚’å–å¾—
   */
  getErrorHistory() {
    return this.errorHistory;
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
   */
  clearErrorHistory() {
    this.errorHistory = [];
  }
  
  /**
   * è¨€èªžã‚’å¤‰æ›´
   */
  setLanguage(lang) {
    if (ERROR_MESSAGES[lang]) {
      this.language = lang;
    }
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
window.unifiedErrorHandler = new UnifiedErrorHandler();

// Attach to AdminPanel namespace
window.AdminPanel = window.AdminPanel || {};
window.AdminPanel.errors = window.AdminPanel.errors || {};
window.AdminPanel.errors.handle = (error, context, severity, type) => {
  return window.unifiedErrorHandler.handleError(error, context, severity, type);
};

// Backward compatibility
window.handleError = window.AdminPanel.errors.handle;
window.ERROR_SEVERITY = ERROR_SEVERITY;
window.ERROR_TYPES = ERROR_TYPES;

console.log('âœ… Unified Error Handler initialized');
</script>