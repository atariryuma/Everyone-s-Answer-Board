  <script>
    'use strict';
    
    const CONFIG = Object.freeze({
      CACHE_DURATION: 120000,      // 2åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      POLLING_INTERVAL: 90000,     // 90ç§’ãƒãƒ¼ãƒªãƒ³ã‚°
      SEARCH_DEBOUNCE: 400,        // 400msæ¤œç´¢ãƒ‡ãƒã‚¦ãƒ³ã‚¹
      ANIMATION_DURATION: 300,     // 300msã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      MAX_DISPLAY_COLUMNS: 6,      // æœ€å¤§è¡¨ç¤ºåˆ—æ•°
      MIN_DISPLAY_COLUMNS: 1       // æœ€å°è¡¨ç¤ºåˆ—æ•°
    });
    
    const getSecureVars = () => ({
      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰å¤‰æ•°ã§ã¯ãªãã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸè¨­å®šã‚’ä½¿ç”¨
      showAdminFeatures: false,  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§åˆ¤å®š
      isAdminUser: false,        // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§åˆ¤å®š
      userId: (typeof window !== 'undefined' && window.userId) || null,
      userEmail: (typeof window !== 'undefined' && window.userEmail) || null
    });
    
    const ICONS = Object.freeze({
      lightbulb: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2m8.66-10H20M4 12H2m15.07-7.07L17.66 6.34M6.34 6.34L4.93 4.93m12.14 12.14L15.66 15.66M6.34 17.66L4.93 19.07"/></svg>',
      thumbup: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 10v12l5-3 5 3V10l-5-8-5 8z"/></svg>',
      search: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/><path d="M11 8v6M8 11h6"/></svg>',
      x: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>',
      star: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26 12,2"/></svg>',
      grid: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18"/><path d="M12 3v18M3 12h18"/></svg>',
      users: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>'
    });

    /**
     * DOMæ“ä½œã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ - æœªå®šç¾©ã‚¨ãƒ©ãƒ¼ã‚’é˜²æ­¢
     */
    const DOMHelpers = Object.freeze({
      /**
       * å®‰å…¨ãªDOMè¦ç´ å–å¾—
       * @param {string} id - è¦ç´ ID
       * @param {string} context - ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
       * @returns {Element|null}
       */
      safeGetById(id, context = '') {
        try {
          const element = document.getElementById(id);
          if (!element && context) {
            console.warn(`DOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${id} (${context})`);
          }
          return element;
        } catch (error) {
          console.error(`DOMè¦ç´ å–å¾—ã‚¨ãƒ©ãƒ¼: ${id}`, error);
          return null;
        }
      },

      /**
       * å®‰å…¨ãªDOMè¦ç´ å€¤è¨­å®š
       * @param {string} id - è¦ç´ ID
       * @param {*} value - è¨­å®šã™ã‚‹å€¤
       * @param {string} property - ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'value'ï¼‰
       * @returns {boolean} æˆåŠŸãƒ»å¤±æ•—
       */
      safeSetValue(id, value, property = 'value') {
        const element = this.safeGetById(id, 'value setting');
        if (element && property in element) {
          element[property] = value;
          return true;
        }
        return false;
      },

      /**
       * å®‰å…¨ãªDOMè¦ç´ å€¤å–å¾—
       * @param {string} id - è¦ç´ ID
       * @param {string} property - ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'value'ï¼‰
       * @param {*} fallback - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
       * @returns {*}
       */
      safeGetValue(id, property = 'value', fallback = '') {
        const element = this.safeGetById(id, 'value getting');
        return (element && property in element) ? element[property] : fallback;
      },

      /**
       * è¤‡æ•°è¦ç´ ã®å®‰å…¨ãªå–å¾—
       * @param {Array<string>} ids - è¦ç´ IDã®é…åˆ—
       * @returns {Object} IDã‚’ã‚­ãƒ¼ã¨ã—ãŸè¦ç´ ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
       */
      safeGetMultiple(ids) {
        const result = {};
        ids.forEach(id => {
          result[id] = this.safeGetById(id);
        });
        return result;
      }
    });
    
    /**
     * FilterManager - ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½å°‚é–€ã‚¯ãƒ©ã‚¹
     * æ•™è‚²ç¾å ´ã§ã®é‡è¦ãªæ©Ÿèƒ½ï¼ˆã‚¯ãƒ©ã‚¹çµã‚Šè¾¼ã¿ã€æ¤œç´¢ã€ã‚½ãƒ¼ãƒˆï¼‰ã‚’ç®¡ç†
     */
    class FilterManager {
      constructor() {
        this.filters = {
          classFilter: '',
          searchQuery: '',
          sortOrder: 'newest'
        };
        this.originalData = [];
        this.filteredData = [];
        this.availableClasses = new Set();
      }

      setData(data) {
        this.originalData = data || [];
        this.extractAvailableClasses();
        this.updateClassFilter();
        this.applyFilters();
      }

      extractAvailableClasses() {
        this.availableClasses.clear();
        this.originalData.forEach(item => {
          if (item.class && typeof item.class === 'string' && item.class.trim()) {
            this.availableClasses.add(item.class.trim());
          }
        });
      }

      updateClassFilter() {
        const classFilterEl = DOMHelpers.safeGetById('classFilter', 'class filter update');
        if (!classFilterEl) return;

        const currentValue = classFilterEl.value;
        const firstOption = classFilterEl.querySelector('option[value=""]');
        classFilterEl.innerHTML = '';
        if (firstOption) {
          classFilterEl.appendChild(firstOption);
        }

        const sortedClasses = Array.from(this.availableClasses).sort();
        sortedClasses.forEach(className => {
          const option = document.createElement('option');
          option.value = className;
          option.textContent = className;
          classFilterEl.appendChild(option);
        });

        classFilterEl.value = currentValue;
      }

      setFilter(filterType, value) {
        if (this.filters.hasOwnProperty(filterType)) {
          this.filters[filterType] = value;
          this.applyFilters();
        }
      }

      clearFilters() {
        this.filters = {
          classFilter: '',
          searchQuery: '',
          sortOrder: 'newest'
        };

        const elements = DOMHelpers.safeGetMultiple(['classFilter', 'searchInput', 'sortOrder']);

        Object.entries(elements).forEach(([key, element]) => {
          if (element) {
            element.value = key === 'sortOrder' ? 'newest' : '';
          }
        });

        this.applyFilters();
      }

      applyFilters() {
        let filtered = [...this.originalData];

        if (this.filters.classFilter) {
          filtered = filtered.filter(item => 
            item.class && item.class.trim() === this.filters.classFilter
          );
        }

        if (this.filters.searchQuery) {
          const query = this.filters.searchQuery.toLowerCase().trim();
          filtered = filtered.filter(item => {
            return (
              (item.opinion && item.opinion.toLowerCase().includes(query)) ||
              (item.reason && item.reason.toLowerCase().includes(query)) ||
              (item.name && item.name.toLowerCase().includes(query)) ||
              (item.class && item.class.toLowerCase().includes(query))
            );
          });
        }

        switch (this.filters.sortOrder) {
          case 'newest':
            filtered.sort((a, b) => (b.rowIndex || 0) - (a.rowIndex || 0));
            break;
          case 'reactions':
            filtered.sort((a, b) => {
              const reactionA = this.getTotalReactions(a);
              const reactionB = this.getTotalReactions(b);
              return reactionB - reactionA;
            });
            break;
        }

        this.filteredData = filtered;
        return filtered;
      }

      getTotalReactions(item) {
        if (!item.reactions) return 0;
        return Object.values(item.reactions).reduce((total, reaction) => {
          return total + (reaction.count || 0);
        }, 0);
      }

      getFilteredData() {
        return this.filteredData;
      }

      getFilterStatus() {
        const hasFilters = Object.values(this.filters).some(value => 
          value && value !== 'newest'
        );
        
        return {
          hasFilters,
          totalItems: this.originalData.length,
          filteredItems: this.filteredData.length,
          filters: { ...this.filters }
        };
      }
    }

    /**
     * AnswerApp - ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ã‚¯ãƒ©ã‚¹
     * ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã€çŠ¶æ…‹ç®¡ç†ã€APIé€šä¿¡ã‚’çµ±åˆ
     */
    class AnswerApp {
      constructor() {
        console.log('ğŸš€ [AnswerApp] åˆæœŸåŒ–é–‹å§‹', {
          timestamp: new Date().toISOString(),
          location: window.location.href,
          userAgent: navigator.userAgent.substring(0, 100)
        });

        try {
          this.vars = getSecureVars();
          console.log('âœ… [AnswerApp] ã‚»ã‚­ãƒ¥ã‚¢å¤‰æ•°å–å¾—å®Œäº†', {
            userId: this.vars.userId ? this.vars.userId.substring(0, 8) + '...' : 'ãªã—',
            userEmail: this.vars.userEmail ? this.vars.userEmail.split('@')[0] + '@...' : 'ãªã—',
            isAdminUser: this.vars.isAdminUser
          });

          this.config = null;
          this.answers = [];
          this.isLoading = false;
          this.pollingInterval = null;
          this.cache = new Map();
          this.cacheTimers = new Map();
          this.isProduction = typeof google !== 'undefined' && google.script?.run;
          this.retryCount = 0;
          this.maxRetries = 3;

          console.log('âœ… [AnswerApp] åŸºæœ¬ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®šå®Œäº†', {
            isProduction: this.isProduction,
            googleScriptAvailable: typeof google !== 'undefined',
            googleScriptRun: !!(google && google.script && google.script.run)
          });

          this.answerRenderer = new AnswerRenderer();
          console.log('âœ… [AnswerApp] AnswerRendererç”Ÿæˆå®Œäº†');

          this.filterManager = new FilterManager();
          console.log('âœ… [AnswerApp] FilterManagerç”Ÿæˆå®Œäº†');

          console.log('ğŸ¯ [AnswerApp] init()ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—é–‹å§‹');
          this.init();

        } catch (error) {
          console.error('âŒ [AnswerApp] ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¨ãƒ©ãƒ¼', {
            message: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
          });
          throw error;
        }
      }
      
      async init() {
        console.log('ğŸ¯ [AnswerApp] init()é–‹å§‹');

        try {
          console.log('ğŸ”„ [AnswerApp] ä¸¦åˆ—åˆæœŸåŒ–å‡¦ç†é–‹å§‹ (loadConfig, setupUI, setupEventListeners)');

          const [config] = await Promise.all([
            this.loadConfig(),
            this.setupUI(),
            this.setupEventListeners()
          ]);

          console.log('âœ… [AnswerApp] ä¸¦åˆ—åˆæœŸåŒ–å‡¦ç†å®Œäº†', {
            configLoaded: !!config,
            configKeys: config ? Object.keys(config) : []
          });

          this.config = config;

          console.log('ğŸ¯ [AnswerApp] loadAnswers()å‘¼ã³å‡ºã—é–‹å§‹');
          await this.loadAnswers();
          console.log('âœ… [AnswerApp] loadAnswers()å®Œäº†');

          console.log('ğŸ¯ [AnswerApp] ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹');
          this.startPolling();

          console.log('ğŸ‰ [AnswerApp] åˆæœŸåŒ–å®Œå…¨å®Œäº†');

        } catch (error) {
          console.error('âŒ [AnswerApp] init()ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', {
            message: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
          });
          this.handleError('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', error);
        }
      }
      
      async loadConfig() {
        const cacheKey = `config_${this.vars.userId}`;
        const cached = this.getCache(cacheKey);
        if (cached) return cached;
        
        try {
          const config = await this.callGAS('getUserConfig', this.vars.userId);

          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼
          if (!config) {
            console.error('âŒ [loadConfig] è¨­å®šå–å¾—å¤±æ•—: nullãƒ¬ã‚¹ãƒãƒ³ã‚¹');
            throw new Error('è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          }

          if (config.success === false) {
            console.error('âŒ [loadConfig] è¨­å®šå–å¾—å¤±æ•—:', config.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
            throw new Error(config.error || 'è¨­å®šå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }

          console.log('âœ… [loadConfig] è¨­å®šå–å¾—æˆåŠŸ', {
            configType: typeof config,
            hasUserPermissions: !!config.userPermissions,
            spreadsheetId: config.spreadsheetId ? 'ã‚ã‚Š' : 'ãªã—'
          });

          // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰æ¨©é™æƒ…å ±ã‚’å–å¾—
          if (config.userPermissions) {
            this.vars.showAdminFeatures = config.userPermissions.isOwner || config.userPermissions.isSystemAdmin;
            this.vars.isAdminUser = config.userPermissions.isOwner || config.userPermissions.isSystemAdmin;
            this.vars.isOwner = config.userPermissions.isOwner;
            this.vars.isSystemAdmin = config.userPermissions.isSystemAdmin;
            this.vars.accessLevel = config.userPermissions.accessLevel;

            console.log('ğŸ” [AnswerApp] æ¨©é™æƒ…å ±è¨­å®šå®Œäº†', {
              isOwner: this.vars.isOwner,
              isSystemAdmin: this.vars.isSystemAdmin,
              accessLevel: this.vars.accessLevel,
              showAdminFeatures: this.vars.showAdminFeatures
            });
          }
          
          this.setCache(cacheKey, config, CONFIG.CACHE_DURATION);
          return config;
        } catch (error) {
          console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          return {};
        }
      }
      
      async loadAnswers(sortOrder = 'newest') {
        console.log('ğŸ“Š [loadAnswers] ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹', {
          sortOrder,
          isLoading: this.isLoading,
          userId: this.vars.userId ? this.vars.userId.substring(0, 8) + '...' : 'ãªã—'
        });

        if (this.isLoading) {
          console.warn('âš ï¸ [loadAnswers] ã™ã§ã«èª­ã¿è¾¼ã¿ä¸­ã®ãŸã‚ä¸­æ­¢');
          return;
        }
        this.isLoading = true;

        try {
          console.log('ğŸ“¡ [loadAnswers] GASé–¢æ•°å‘¼ã³å‡ºã—: getPublishedSheetData');
          const rawData = await this.callGAS('getPublishedSheetData', this.vars.userId, 'ã™ã¹ã¦', sortOrder);

          console.log('ğŸ“¦ [loadAnswers] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡', {
            responseType: typeof rawData,
            hasData: !!rawData?.data,
            hasRows: !!rawData?.rows,
            dataLength: rawData?.data?.length || rawData?.rows?.length || 0,
            rawDataKeys: rawData ? Object.keys(rawData) : 'ãªã—'
          });
          
          if (!rawData?.data && !rawData?.rows) {
            console.warn('âš ï¸ [loadAnswers] ãƒ‡ãƒ¼ã‚¿ãŒç©ºã¾ãŸã¯null', {
              rawData: rawData,
              hasHeader: !!rawData?.header,
              hasSheetName: !!rawData?.sheetName
            });

            const emptyResult = {
              answers: [],
              header: rawData?.header || 'å•é¡Œ',
              sheetName: rawData?.sheetName || 'ä¸æ˜'
            };

            console.log('ğŸ”„ [loadAnswers] ç©ºãƒ‡ãƒ¼ã‚¿ã§UIæ›´æ–°');
            this.updateUI(emptyResult);
            return;
          }
          
          const data = rawData.data || rawData.rows || [];
          // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°: ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèª
          console.log('âœ… ãƒ‡ãƒ¼ã‚¿å¤‰æ›é–‹å§‹:', {
            totalItems: data.length,
            sampleItem: data[0] ? Object.keys(data[0]) : 'ãƒ‡ãƒ¼ã‚¿ãªã—'
          });

          const answers = data
            .filter(item => item?.answer || item?.opinion) // answerã¾ãŸã¯opinionãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹é …ç›®
            .map(item => this.normalizeAnswer(item))
            .filter(answer => answer.opinion); // æ­£è¦åŒ–å¾Œã®opinionã‚’ãƒã‚§ãƒƒã‚¯

          console.log('âœ… ãƒ‡ãƒ¼ã‚¿å¤‰æ›å®Œäº†:', {
            filteredCount: answers.length,
            sampleAnswer: answers[0] ? Object.keys(answers[0]) : 'ãƒ‡ãƒ¼ã‚¿ãªã—'
          });
          
          const result = {
            answers,
            header: rawData.header || 'å•é¡Œ',
            sheetName: rawData.sheetName || 'ä¸æ˜'
          };

          console.log('ğŸ“‹ [loadAnswers] æœ€çµ‚ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèª', {
            answersCount: result.answers.length,
            header: result.header,
            sheetName: result.sheetName,
            firstAnswerKeys: result.answers[0] ? Object.keys(result.answers[0]) : 'ãªã—'
          });

          this.answers = result.answers;

          console.log('ğŸ¨ [loadAnswers] updateUI()å‘¼ã³å‡ºã—é–‹å§‹');
          this.updateUI(result);
          console.log('âœ… [loadAnswers] updateUI()å‘¼ã³å‡ºã—å®Œäº†');

        } catch (error) {
          console.error('âŒ [loadAnswers] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', {
            message: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
          });
          this.handleError('ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼', error);
        } finally {
          console.log('ğŸ [loadAnswers] å‡¦ç†çµ‚äº† - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è§£é™¤');
          this.isLoading = false;
        }
      }
      
      async updateReaction(rowIndex, reactionKey) {
        console.log('ğŸ¯ [updateReaction] ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†é–‹å§‹', {
          rowIndex,
          reactionKey,
          userEmail: this.vars.userEmail ? this.vars.userEmail.split('@')[0] + '@...' : 'ãªã—',
          hasUserEmail: !!this.vars.userEmail
        });

        if (!this.vars.userEmail) {
          console.error('âŒ [updateReaction] userEmailãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return { success: false, error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™' };
        }

        return await this.callGAS('processReactionByEmail', this.vars.userEmail, rowIndex, reactionKey);
      }
      
      updateUI(data) {
        console.log('ğŸ¨ [updateUI] UIæ›´æ–°é–‹å§‹', {
          answersCount: data.answers.length,
          header: data.header,
          sheetName: data.sheetName
        });

        console.log('ğŸ”„ [updateUI] FilterManagerã«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ');
        this.filterManager.setData(data.answers);

        console.log('ğŸ”„ [updateUI] AnswerRendererã§ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°');
        this.answerRenderer.updateHeader(data.header, data.sheetName);

        console.log('ğŸ”„ [updateUI] ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°');
        this.renderFilteredResults();

        console.log('âœ… [updateUI] UIæ›´æ–°å®Œäº†');
      }

      renderFilteredResults() {
        console.log('ğŸ” [renderFilteredResults] ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†é–‹å§‹');

        const filteredData = this.filterManager.getFilteredData();
        const status = this.filterManager.getFilterStatus();

        console.log('ğŸ“Š [renderFilteredResults] ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœ', {
          filteredCount: filteredData.length,
          totalCount: status.totalItems,
          hasFilters: status.hasFilters
        });

        // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
        const answersContainer = document.getElementById('answers');
        console.log('ğŸ¯ [renderFilteredResults] DOMè¦ç´ ç¢ºèª', {
          answersContainer: !!answersContainer,
          containerClass: answersContainer?.className || 'ãªã—',
          containerChildren: answersContainer?.children.length || 0
        });

        console.log('ğŸ¨ [renderFilteredResults] AnswerRenderer.renderAnswers()å‘¼ã³å‡ºã—');
        this.answerRenderer.renderAnswers(filteredData);

        console.log('ğŸ¨ [renderFilteredResults] ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºæ›´æ–°');
        this.answerRenderer.updateAnswerCount(status.filteredItems);

        console.log('ğŸ¨ [renderFilteredResults] ãƒ•ã‚£ãƒ«ã‚¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°');
        this.updateFilterStatusDisplay(status);

        console.log('âœ… [renderFilteredResults] ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†');
      }
      
      normalizeAnswer(item) {
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®answerãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®opinionãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒãƒƒãƒ”ãƒ³ã‚°
        const opinionText = String(item.answer || item.opinion || '').trim();

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª
        if (item.answer && !item.opinion) {
          console.log('ğŸ”„ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›: answer â†’ opinion', {
            originalField: 'answer',
            value: item.answer?.substring(0, 50) + '...'
          });
        }

        return {
          rowIndex: parseInt(item.rowIndex) || 1,
          opinion: opinionText,
          reason: String(item.reason || '').trim(),
          name: String(item.name || '').trim(),
          class: String(item.class || '').trim(),
          email: String(item.email || '').trim(),
          reactions: this.normalizeReactions(item.reactions),
          highlight: Boolean(item.highlight),
          timestamp: item.timestamp || new Date().toISOString()
        };
      }
      
      normalizeReactions(reactions) {
        const defaults = {
          UNDERSTAND: { count: 0, reacted: false },
          LIKE: { count: 0, reacted: false },
          CURIOUS: { count: 0, reacted: false }
        };
        
        if (!reactions) return defaults;
        
        const normalized = {};
        for (const [key, defaultValue] of Object.entries(defaults)) {
          normalized[key] = {
            count: Math.max(0, parseInt(reactions[key]?.count) || 0),
            reacted: Boolean(reactions[key]?.reacted)
          };
        }
        
        return normalized;
      }

      /**
       * é–¢æ•°åã‹ã‚‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®é©åˆ‡ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’å–å¾—
       * @param {string} funcName - é–¢æ•°å
       * @returns {string} - ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼.ãƒ¡ã‚½ãƒƒãƒ‰å
       */
      getControllerFunction(funcName) {
        const functionMap = {
          getUserConfig: 'getUserConfig',
          getPublishedSheetData: 'getPublishedSheetData',
          addReaction: 'addReaction'
        };

        return functionMap[funcName] || funcName;
      }

      async callGAS(funcName, ...args) {
        console.log('ğŸ“¡ [GAS] å‘¼ã³å‡ºã—é–‹å§‹', {
          function: funcName,
          args: args.length > 0 ? args.map(arg =>
            typeof arg === 'string' && arg.length > 50 ? arg.substring(0, 50) + '...' : arg
          ) : 'ãªã—',
          timestamp: new Date().toISOString(),
          isProduction: this.isProduction
        });

        return new Promise((resolve, reject) => {
          if (this.isProduction) {
            google.script.run
              .withSuccessHandler((result) => {
                console.log('âœ… [GAS] å‘¼ã³å‡ºã—æˆåŠŸ', {
                  function: funcName,
                  resultType: typeof result,
                  hasData: result?.data ? `${result.data.length}ä»¶` : 'ãƒ‡ãƒ¼ã‚¿ãªã—',
                  success: result?.success,
                  executionTime: `${Date.now() - this.callStartTime}ms`
                });

                this.retryCount = 0; // æˆåŠŸæ™‚ã¯ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                resolve(result);
              })
              .withFailureHandler((error) => {
                console.error('âŒ [GAS] å‘¼ã³å‡ºã—å¤±æ•—', {
                  function: funcName,
                  error: error,
                  errorString: String(error),
                  retryCount: this.retryCount,
                  timestamp: new Date().toISOString()
                });

                // ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã‹ãƒã‚§ãƒƒã‚¯
                const isRetryable = this.isRetryableError(error);

                if (isRetryable && this.retryCount < this.maxRetries) {
                  this.retryCount++;
                  console.warn(`ğŸ”„ [GAS] ãƒªãƒˆãƒ©ã‚¤å®Ÿè¡Œ: ${this.retryCount}/${this.maxRetries} (${funcName})`);

                  // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ãƒªãƒˆãƒ©ã‚¤
                  setTimeout(() => {
                    this.callGAS(funcName, ...args).then(resolve).catch(reject);
                  }, Math.pow(2, this.retryCount) * 1000);
                } else {
                  this.retryCount = 0;
                  console.error('ğŸš« [GAS] æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ã¾ã—ãŸ', {
                    function: funcName,
                    finalError: error
                  });
                  reject(this.normalizeError(error, funcName));
                }
              });

            // å®Ÿè¡Œæ™‚é–“è¨ˆæ¸¬é–‹å§‹
            this.callStartTime = Date.now();

            // GASé–¢æ•°å®Ÿè¡Œ
            const controllerFunction = this.getControllerFunction(funcName);
            console.log('ğŸ¯ [GAS] å®Ÿéš›ã®é–¢æ•°å®Ÿè¡Œ', {
              mappedFunction: controllerFunction,
              originalFunction: funcName
            });

            google.script.run[controllerFunction](...args);
          } else {
            this.mockResponse(funcName, resolve);
          }
        });
      }


      /**
       * ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã‹ã©ã†ã‹ã‚’åˆ¤å®š
       * @param {*} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
       * @returns {boolean}
       */
      isRetryableError(error) {
        const errorString = String(error).toLowerCase();
        const retryablePatterns = [
          'timeout',
          'network',
          'connection',
          'temporary',
          'service unavailable',
          'internal error'
        ];
        
        return retryablePatterns.some(pattern => errorString.includes(pattern));
      }

      /**
       * ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ­£è¦åŒ–
       * @param {*} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
       * @param {string} funcName - é–¢æ•°å
       * @returns {Error}
       */
      normalizeError(error, funcName) {
        if (error instanceof Error) {
          return error;
        }
        
        const message = typeof error === 'string' ? error : 
                       error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        
        const normalizedError = new Error(`${funcName}: ${message}`);
        normalizedError.originalError = error;
        normalizedError.functionName = funcName;
        
        return normalizedError;
      }
      
      mockResponse(funcName, resolve) {
        setTimeout(() => {
          if (funcName === 'getPublishedSheetData') {
            resolve({
              header: 'ãƒ†ã‚¹ãƒˆå•é¡Œ: ã‚ãªãŸãŒæ€ã†ç†æƒ³çš„ãªå­¦ç¿’æ–¹æ³•ã¯ï¼Ÿ',
              sheetName: 'ãƒ†ã‚¹ãƒˆå›ç­”ã‚·ãƒ¼ãƒˆ',
              data: [
                {
                  rowIndex: 1, name: 'ç”°ä¸­å¤ªéƒ', class: '3å¹´Açµ„',
                  opinion: 'ã‚°ãƒ«ãƒ¼ãƒ—ã§ã®è¨è«–ã‚’é€šã˜ã¦ã€äº’ã„ã®æ„è¦‹ã‚’äº¤æ›ã—ãªãŒã‚‰å­¦ã¶ã“ã¨ãŒåŠ¹æœçš„ã ã¨æ€ã„ã¾ã™ã€‚',
                  reason: 'ä¸€äººã§å‹‰å¼·ã™ã‚‹ã‚ˆã‚Šã‚‚ã€ä»–ã®äººã®è€ƒãˆã‚’èãã“ã¨ã§æ–°ã—ã„è¦–ç‚¹ã‚’å¾—ã‚‰ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚',
                  reactions: { UNDERSTAND: {count: 8, reacted: false}, LIKE: {count: 12, reacted: true}, CURIOUS: {count: 3, reacted: false} },
                  highlight: true
                },
                {
                  rowIndex: 2, name: 'ä½è—¤èŠ±å­', class: '3å¹´Bçµ„',
                  opinion: 'å®Ÿéš›ã®ä½“é¨“ã‚„å®Ÿé¨“ã‚’é€šã˜ã¦ã€æ‰‹ã‚’å‹•ã‹ã—ãªãŒã‚‰å­¦ã¶ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚',
                  reason: 'æœ¬ã‚„è³‡æ–™ã ã‘ã§ã¯ç†è§£ã—ã«ãã„ã“ã¨ã‚‚ã€ä½“é¨“ã™ã‚‹ã“ã¨ã§è¨˜æ†¶ã«æ®‹ã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚',
                  reactions: { UNDERSTAND: {count: 15, reacted: true}, LIKE: {count: 6, reacted: false}, CURIOUS: {count: 9, reacted: false} },
                  highlight: false
                }
              ]
            });
          } else if (funcName === 'addReaction') {
            resolve({ success: true, count: Math.floor(Math.random() * 20) + 1 });
          } else if (funcName === 'getUserConfig') {
            resolve({ displaySettings: { showName: true, showClass: true, showEmail: false } });
          } else {
            resolve({});
          }
        }, 200 + Math.random() * 300);
      }
      
      setCache(key, value, ttl) {
        this.cache.set(key, value);
        
        if (ttl) {
          const timer = setTimeout(() => {
            this.cache.delete(key);
            this.cacheTimers.delete(key);
          }, ttl);
          
          if (this.cacheTimers.has(key)) {
            clearTimeout(this.cacheTimers.get(key));
          }
          this.cacheTimers.set(key, timer);
        }
      }
      
      getCache(key) {
        return this.cache.get(key);
      }
      
      clearCache() {
        this.cache.clear();
        this.cacheTimers.forEach(timer => clearTimeout(timer));
        this.cacheTimers.clear();
      }
      
      setupUI() {
        this.answerRenderer.renderIcons();
        this.updateUIState();
        return Promise.resolve();
      }
      
      setupEventListeners() {
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
        const slider = document.getElementById('sizeSlider');
        if (slider) {
          slider.addEventListener('input', () => {
            localStorage.setItem('boardColumns', slider.value);
            this.answerRenderer.updateGridColumns(slider.value);
          });
          
          const saved = localStorage.getItem('boardColumns');
          if (saved) {
            slider.value = saved;
            this.answerRenderer.updateGridColumns(saved);
          }
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
        this.setupFilterEvents();
        
        // ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ™ãƒ³ãƒˆ
        const container = document.getElementById('answers');
        if (container) {
          container.addEventListener('click', (e) => {
            const btn = e.target.closest('.reaction-btn');
            const card = e.target.closest('.answer-card');
            
            if (btn) {
              e.stopPropagation();
              const rowIndex = parseInt(btn.dataset.rowIndex);
              const reaction = btn.dataset.reaction;
              if (rowIndex && reaction) {
                this.handleReaction(rowIndex, reaction, btn);
              }
            } else if (card && !btn) {
              const rowIndex = parseInt(card.dataset.rowIndex);
              if (rowIndex) this.showModal(rowIndex);
            }
          });
        }
        
        // ç®¡ç†è€…åˆ‡ã‚Šæ›¿ãˆ
        const adminBtn = document.getElementById('adminToggleBtn');
        if (adminBtn) {
          adminBtn.addEventListener('click', () => {
            // ç¾åœ¨ã®URLã‚’è§£æ
            const currentUrl = new URL(window.location.href);

            // adminãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´
            currentUrl.searchParams.set('mode', 'admin');

            // userIdãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯è¿½åŠ 
            if (!currentUrl.searchParams.has('userId') && this.vars.userId) {
              currentUrl.searchParams.set('userId', this.vars.userId);
            }

            window.location.href = currentUrl.toString();
          });
        }
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const modal = document.getElementById('answerModalContainer');
            if (modal && !modal.classList.contains('hidden')) {
              modal.classList.add('opacity-0');
              setTimeout(() => modal.classList.add('hidden'), CONFIG.ANIMATION_DURATION);
            }
          }
        });
        
        return Promise.resolve();
      }
      
      setupFilterEvents() {
        const classFilter = document.getElementById('classFilter');
        if (classFilter) {
          classFilter.addEventListener('change', (e) => {
            this.filterManager.setFilter('classFilter', e.target.value);
            this.renderFilteredResults();
          });
        }
        
        // æ¤œç´¢å…¥åŠ›ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãï¼‰
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          let debounceTimer;
          searchInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
              this.filterManager.setFilter('searchQuery', e.target.value);
              this.renderFilteredResults();
            }, CONFIG.SEARCH_DEBOUNCE);
          });
        }
        
        // ã‚½ãƒ¼ãƒˆé †å¤‰æ›´
        const sortOrder = document.getElementById('sortOrder');
        if (sortOrder) {
          sortOrder.addEventListener('change', (e) => {
            this.loadAnswers(e.target.value);
          });
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        if (clearFiltersBtn) {
          clearFiltersBtn.addEventListener('click', () => {
            this.filterManager.clearFilters();
            this.renderFilteredResults();
          });
        }
      }
      
      updateUIState() {
        const adminBtn = document.getElementById('adminToggleBtn');
        const modeLabel = document.getElementById('modeLabel');
        
        if (adminBtn && this.vars.showAdminFeatures && this.vars.isAdminUser) {
          adminBtn.classList.remove('hidden');
          adminBtn.textContent = 'ç®¡ç†ãƒ‘ãƒãƒ«';
        }
        
        if (modeLabel) {
          let modeText = 'å­¦ç¿’è€…';
          if (this.vars.isOwner) {
            modeText = 'ğŸ‘‘ æ‰€æœ‰è€…';
          } else if (this.vars.isSystemAdmin) {
            modeText = 'ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…';
          } else if (this.vars.isAdminUser) {
            modeText = 'ç®¡ç†è€…';
          }
          modeLabel.textContent = modeText;

          console.log('ğŸ¨ [UI] ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°', {
            modeText,
            isOwner: this.vars.isOwner,
            isSystemAdmin: this.vars.isSystemAdmin,
            isAdminUser: this.vars.isAdminUser
          });
        }
      }
      
      updateFilterStatusDisplay(status) {
        const answerCount = document.getElementById('answerCount');
        if (answerCount) {
          // XSSé˜²æ­¢: HTMLç›´æ¥æ³¨å…¥ã§ã¯ãªãã€DOMæ“ä½œã‚’ä½¿ç”¨
          answerCount.innerHTML = '';
          
          // SVGã‚¢ã‚¤ã‚³ãƒ³
          const svg = this.answerRenderer.createIcon('users', 'w-4 h-4');
          answerCount.appendChild(svg);
          
          // ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ï¼‰
          const filterText = status.hasFilters 
            ? `${parseInt(status.filteredItems)}/${parseInt(status.totalItems)} ä»¶` 
            : `${parseInt(status.totalItems)} ä»¶`;
          
          const textNode = document.createTextNode(` ${filterText}`);
          answerCount.appendChild(textNode);
          
          // ãƒ•ã‚£ãƒ«ã‚¿çŠ¶æ…‹è¡¨ç¤º
          if (status.hasFilters) {
            const filterSpan = document.createElement('span');
            filterSpan.className = 'text-cyan-400';
            filterSpan.textContent = 'ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ä¸­ï¼‰';
            answerCount.appendChild(filterSpan);
          }
        }
        
        // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        if (clearFiltersBtn) {
          clearFiltersBtn.style.display = status.hasFilters ? 'block' : 'none';
        }
      }
      
      // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
      async handleReaction(rowIndex, reactionKey, btn) {
        if (btn.classList.contains('loading')) return;
        
        try {
          btn.classList.add('loading');
          
          const result = await this.updateReaction(rowIndex, reactionKey);
          
          if (result.success) {
            // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
            const countEl = btn.querySelector('span');
            if (countEl) {
              countEl.textContent = result.count || 0;
            }
            
            // çŠ¶æ…‹æ›´æ–°
            const wasReacted = btn.classList.contains('reacted');
            btn.classList.toggle('reacted', !wasReacted);
            btn.classList.toggle('liked', !wasReacted);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            this.answerRenderer.animateReactionSuccess(btn);
            
            // åŒã˜è¡Œã®ä»–ã®ãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
            const card = btn.closest('.answer-card');
            if (card) {
              const allReactionBtns = card.querySelectorAll('.reaction-btn');
              allReactionBtns.forEach(otherBtn => {
                if (otherBtn.dataset.reaction === reactionKey && otherBtn !== btn) {
                  const otherCountEl = otherBtn.querySelector('span');
                  if (otherCountEl) {
                    otherCountEl.textContent = result.count || 0;
                  }
                  otherBtn.classList.toggle('reacted', !wasReacted);
                  otherBtn.classList.toggle('liked', !wasReacted);
                }
              });
            }
            
          } else {
            this.showUserError(result.message || 'ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          
        } catch (error) {
          console.error('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
          this.handleError('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
        } finally {
          btn.classList.remove('loading');
        }
      }
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      showModal(rowIndex) {
        const answer = this.answers.find(a => a.rowIndex === rowIndex);
        if (answer) {
          this.answerRenderer.showModal(answer);
        }
      }
      
      // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
      startPolling() {
        // æ—¢å­˜ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        this.stopPolling();
        
        // 90ç§’é–“éš”ã§ãƒãƒ¼ãƒªãƒ³ã‚°
        this.pollingInterval = setInterval(() => {
          if (!document.hidden) {
            this.loadAnswers();
          }
        }, CONFIG.POLLING_INTERVAL);
        
        // ãƒšãƒ¼ã‚¸ã®å¯è¦–æ€§å¤‰åŒ–ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¿å­˜ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç”¨ï¼‰
        this.visibilityChangeHandler = () => {
          if (document.hidden) {
            this.stopPolling();
          } else if (!this.pollingInterval) {
            this.startPolling();
          }
        };
        
        document.addEventListener('visibilitychange', this.visibilityChangeHandler);
      }
      
      // ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
      stopPolling() {
        if (this.pollingInterval) {
          clearInterval(this.pollingInterval);
          this.pollingInterval = null;
        }
      }
      
      handleError(context, error) {
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname.includes('script.google.com');
        
        console.error(`[ã‚¨ãƒ©ãƒ¼] ${context}:`, {
          message: error.message,
          stack: isDevelopment ? error.stack : undefined,
          timestamp: new Date().toISOString(),
          userId: this.vars.userId,
          userAgent: navigator.userAgent.substring(0, 100)
        });
        
        const userMessage = isDevelopment 
          ? `${context}: ${error.message}` 
          : 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
          
        this.showUserError(userMessage);
      }
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆXSSé˜²æ­¢ï¼‰
      showUserError(message) {
        const existing = document.querySelector('.error-notification');
        if (existing) existing.remove();
        
        const notification = document.createElement('div');
        notification.className = 'error-notification fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm opacity-0 transform translate-x-full transition-all duration-300';
        
        // XSSé˜²æ­¢: DOMæ§‹ç¯‰ã§å®‰å…¨ã«ä½œæˆ
        const container = document.createElement('div');
        container.className = 'flex items-center gap-2';
        
        // ã‚¨ãƒ©ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
        const errorIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        errorIcon.className = 'w-5 h-5';
        errorIcon.setAttribute('viewBox', '0 0 24 24');
        errorIcon.setAttribute('fill', 'none');
        errorIcon.setAttribute('stroke', 'currentColor');
        errorIcon.setAttribute('stroke-width', '2');
        errorIcon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>';
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã§å®‰å…¨ã«è¨­å®šï¼‰
        const messageSpan = document.createElement('span');
        messageSpan.className = 'flex-1';
        messageSpan.textContent = String(message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        
        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        const closeBtn = document.createElement('button');
        closeBtn.className = 'ml-2 hover:bg-red-700 rounded p-1';
        closeBtn.addEventListener('click', () => notification.remove());
        
        const closeIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        closeIcon.className = 'w-4 h-4';
        closeIcon.setAttribute('viewBox', '0 0 24 24');
        closeIcon.setAttribute('fill', 'none');
        closeIcon.setAttribute('stroke', 'currentColor');
        closeIcon.setAttribute('stroke-width', '2');
        closeIcon.innerHTML = '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>';
        
        closeBtn.appendChild(closeIcon);
        container.appendChild(errorIcon);
        container.appendChild(messageSpan);
        container.appendChild(closeBtn);
        notification.appendChild(container);
        
        document.body.appendChild(notification);
        
        requestAnimationFrame(() => {
          notification.classList.remove('opacity-0', 'translate-x-full');
        });
        setTimeout(() => {
          if (notification.parentNode) {
            notification.classList.add('opacity-0', 'translate-x-full');
            setTimeout(() => notification.remove(), 300);
          }
        }, 8000);
      }
      
      // ç ´æ£„å‡¦ç†
      destroy() {
        // ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
        this.stopPolling();
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if (this.visibilityChangeHandler) {
          document.removeEventListener('visibilitychange', this.visibilityChangeHandler);
          this.visibilityChangeHandler = null;
        }
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
        this.clearCache();
        
        // DOMå‚ç…§ã‚¯ãƒªã‚¢
        this.answerRenderer = null;
        this.filterManager = null;
        this.config = null;
        this.answers = [];
        
        console.info('[AnswerApp] ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      }
    }


    /**
     * AnswerRenderer - DOMæ“ä½œãƒ»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å°‚é–€ã‚¯ãƒ©ã‚¹
     */
    class AnswerRenderer {
      constructor() {
        this.reactions = [
          {key: 'LIKE', icon: 'thumbup', color: 'red'},
          {key: 'UNDERSTAND', icon: 'lightbulb', color: 'yellow'},
          {key: 'CURIOUS', icon: 'search', color: 'green'}
        ];
      }
      
      // å›ç­”ä¸€è¦§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      renderAnswers(answers) {
        const container = document.getElementById('answers');
        if (!container) return;
        
        container.innerHTML = '';
        
        answers.forEach((answer, index) => {
          const card = this.createAnswerCard(answer);
          container.appendChild(card);
          
          // ãƒã‚¤ãƒ†ã‚£ãƒ–CSS ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
          card.style.opacity = '0';
          card.style.transform = 'translateY(20px)';
          
          setTimeout(() => {
            card.style.transition = `opacity ${CONFIG.ANIMATION_DURATION}ms ease-out, transform ${CONFIG.ANIMATION_DURATION}ms ease-out`;
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          }, index * 50);
        });
      }
      
      // å›ç­”ã‚«ãƒ¼ãƒ‰ä½œæˆ
      createAnswerCard(answer) {
        const card = document.createElement('div');
        card.className = `answer-card glass-panel rounded-xl p-4 flex flex-col shadow-lg border-2 border-cyan-400/80 cursor-pointer${answer.highlight ? ' highlighted' : ''}`;
        card.dataset.rowIndex = answer.rowIndex;
        card.tabIndex = 0;
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
        const content = document.createElement('div');
        content.className = 'flex-grow mb-3';
        
        const opinion = document.createElement('h3');
        opinion.className = 'text-cyan-200 text-xl font-semibold leading-tight mb-2';
        opinion.textContent = answer.opinion;
        content.appendChild(opinion);
        
        if (answer.reason) {
          const reason = document.createElement('p');
          reason.className = 'text-gray-100 mt-2';
          reason.textContent = answer.reason;
          content.appendChild(reason);
        }
        
        card.appendChild(content);
        
        // ãƒ•ãƒƒã‚¿ãƒ¼
        const footer = document.createElement('div');
        footer.className = 'text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex justify-between items-center';
        
        // IDæƒ…å ±
        const identity = this.createIdentity(answer);
        if (identity) footer.appendChild(identity);
        
        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        const reactions = document.createElement('div');
        reactions.className = 'flex items-center gap-1';
        
        this.reactions.forEach(r => {
          const btn = this.createReactionButton(answer, r);
          reactions.appendChild(btn);
        });
        
        footer.appendChild(reactions);
        card.appendChild(footer);
        
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒãƒƒã‚¸
        if (answer.highlight) {
          const badge = document.createElement('span');
          badge.className = 'absolute top-1 right-1 text-yellow-300';
          badge.appendChild(this.createIcon('star', 'w-6 h-6'));
          card.appendChild(badge);
        }
        
        return card;
      }
      
      // IDæƒ…å ±ä½œæˆ
      createIdentity(answer) {
        const config = window.answerController?.config?.displaySettings || {};
        const parts = [];
        
        if (config.showName && answer.name) parts.push(answer.name);
        if (config.showClass && answer.class) parts.push(`(${answer.class})`);
        if (config.showEmail && answer.email) parts.push(answer.email);
        
        if (!parts.length) return null;
        
        const div = document.createElement('div');
        div.className = 'text-sm text-gray-200';
        div.textContent = parts.join(' ');
        return div;
      }
      
      // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ä½œæˆ
      createReactionButton(answer, reaction) {
        const info = answer.reactions[reaction.key] || {count: 0, reacted: false};
        const btn = document.createElement('button');
        
        btn.type = 'button';
        btn.dataset.rowIndex = answer.rowIndex;
        btn.dataset.reaction = reaction.key;
        btn.className = this.getReactionClass(reaction.color, info.reacted);
        
        btn.appendChild(this.createIcon(reaction.icon, 'w-4 h-4'));
        
        const count = document.createElement('span');
        count.className = 'ml-1 text-xs';
        count.textContent = info.count;
        btn.appendChild(count);
        
        return btn;
      }
      
      // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹å–å¾—
      getReactionClass(color, reacted) {
        const base = 'reaction-btn flex items-center px-2 py-1 rounded border-2 transition-all ';
        if (reacted) {
          return base + `bg-${color}-500/20 border-${color}-500 text-${color}-400`;
        }
        return base + `bg-transparent border-${color}-500/30 text-${color}-500/60 hover:bg-${color}-500/10`;
      }
      
      /**
       * ğŸ–¼ï¸ ã‚¢ã‚¤ã‚³ãƒ³ä½œæˆ
       */
      createIcon(name, classes = '') {
        const svg = ICONS[name];
        if (!svg) return document.createElement('span');
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(svg, 'image/svg+xml');
        const element = doc.documentElement;
        
        if (classes) element.className = classes;
        element.setAttribute('aria-hidden', 'true');
        
        return element;
      }
      
      /**
       * ğŸ“Š ã‚°ãƒªãƒƒãƒ‰åˆ—æ•°æ›´æ–°
       */
      updateGridColumns(columnCount) {
        const container = document.getElementById('answers');
        const sliderValue = document.getElementById('sliderValue');
        
        if (container && sliderValue) {
          const validColumns = [1, 2, 3, 4, 5, 6];
          const columns = validColumns.includes(parseInt(columnCount)) ? parseInt(columnCount) : 4;
          sliderValue.textContent = columns;
          container.className = `grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-${columns}`;
        }
      }
      
      /**
       * ğŸ“Š å›ç­”æ•°æ›´æ–°
       */
      updateAnswerCount(count) {
        const el = document.getElementById('answerCount');
        if (el) {
          el.innerHTML = '';
          el.appendChild(this.createIcon('users', 'w-4 h-4 mr-2'));
          el.appendChild(document.createTextNode(`${count}ä»¶`));
        }
      }
      
      /**
       * ğŸ“ ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
       */
      updateHeader(header, sheetName) {
        const headingEl = document.getElementById('headingLabel');
        const sheetEl = document.getElementById('sheetNameText');
        
        if (headingEl) headingEl.textContent = header;
        if (sheetEl) sheetEl.textContent = 'ã‚·ãƒ¼ãƒˆ: ' + sheetName;
      }
      
      // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      animateReactionSuccess(button) {
        button.style.transition = 'transform 0.2s ease-out';
        button.style.transform = 'scale(1.2)';
        
        setTimeout(() => {
          button.style.transform = 'scale(1)';
        }, 200);
        
        setTimeout(() => {
          button.style.transition = '';
        }, 400);
      }
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      showModal(answer) {
        const modal = document.getElementById('answerModalContainer');
        const modalContent = document.getElementById('modalAnswer');
        const modalName = document.getElementById('modalStudentName');
        const modalReactions = document.getElementById('modalReactions');
        
        if (!modal || !modalContent) return;
        
        // XSSå¯¾ç­–: DOMæ“ä½œã§å®‰å…¨ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¨­å®š
        modalContent.innerHTML = ''; // æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
        
        // ã‚¿ã‚¤ãƒˆãƒ«ä½œæˆ
        const title = document.createElement('h2');
        title.className = 'text-2xl font-bold text-cyan-200 mb-4';
        title.textContent = 'å›ç­”å†…å®¹';
        modalContent.appendChild(title);
        
        // å›ç­”å†…å®¹ä½œæˆ
        const opinionPara = document.createElement('p');
        opinionPara.className = 'text-xl leading-relaxed mb-4';
        opinionPara.textContent = answer.opinion || '';
        modalContent.appendChild(opinionPara);
        
        // ç†ç”±ãƒ»æ ¹æ‹ ãŒã‚ã‚‹å ´åˆ
        if (answer.reason) {
          const reasonTitle = document.createElement('h3');
          reasonTitle.className = 'text-lg font-semibold text-cyan-400 mb-2';
          reasonTitle.textContent = 'ç†ç”±ãƒ»æ ¹æ‹ ';
          modalContent.appendChild(reasonTitle);
          
          const reasonPara = document.createElement('p');
          reasonPara.className = 'text-gray-200 leading-relaxed';
          reasonPara.textContent = answer.reason;
          modalContent.appendChild(reasonPara);
        }
        
        if (modalName) {
          modalName.textContent = answer.name || 'åŒ¿å';
        }
        
        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ä½œæˆ
        if (modalReactions) {
          modalReactions.innerHTML = '';
          this.reactions.forEach(r => {
            const btn = this.createReactionButton(answer, r);
            modalReactions.appendChild(btn);
          });
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
          modal.classList.remove('opacity-0');
        });
        
        // ã‚¯ãƒ­ãƒ¼ã‚ºã‚¤ãƒ™ãƒ³ãƒˆ
        this.setupModalCloseEvents(modal);
      }
      
      /**
       * âœ–ï¸ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒ­ãƒ¼ã‚ºã‚¤ãƒ™ãƒ³ãƒˆ
       */
      setupModalCloseEvents(modal) {
        const closeModal = () => {
          modal.classList.add('opacity-0');
          setTimeout(() => modal.classList.add('hidden'), 300);
        };
        
        // ESCã‚­ãƒ¼
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            closeModal();
            document.removeEventListener('keydown', handleEsc);
          }
        };
        document.addEventListener('keydown', handleEsc);
        
        // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        }, { once: true });
        
        // ã‚¯ãƒ­ãƒ¼ã‚ºãƒœã‚¿ãƒ³
        const closeBtn = document.getElementById('answerModalCloseBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', closeModal, { once: true });
        }
      }
      
      /**
       * ğŸ–¼ï¸ ã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–
       */
      renderIcons() {
        const iconConfigs = [
          ['answerModalCloseBtn', 'x', 'w-6 h-6'],
          ['footerIcon', 'grid', 'w-4 h-4'],
          ['infoIconLike', 'thumbup', 'w-5 h-5'],
          ['infoIconUnderstand', 'lightbulb', 'w-5 h-5'],
          ['infoIconCurious', 'search', 'w-5 h-5'],
          ['infoIconHighlight', 'star', 'w-5 h-5']
        ];
        
        iconConfigs.forEach(([elementId, iconName, className]) => {
          const element = document.getElementById(elementId);
          if (element) {
            element.innerHTML = '';
            const icon = this.createIcon(iconName, className);
            element.appendChild(icon);
          }
        });
      }
    }
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    try {
      if (window.answerController?.destroy) {
        window.answerController.destroy();
      }
      window.answerController = new AnswerApp();
      
      window.addEventListener('beforeunload', () => {
        window.answerController?.destroy();
      });

    } catch (error) {
      console.error('[åˆæœŸåŒ–å¤±æ•—]', {
        message: error.message,
        stack: error.stack,
        timestamp: new Date().toISOString(),
        url: window.location.href
      });
      
      const container = document.getElementById('answers') || document.body;
      const errorDiv = document.createElement('div');
      errorDiv.className = 'fixed inset-0 bg-gray-900 text-white p-8 flex items-center justify-center z-50';
      errorDiv.innerHTML = `
        <div class="text-center max-w-md">
          <svg class="w-16 h-16 text-red-400 mx-auto mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
          <h2 class="text-xl font-bold mb-2">ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼</h2>
          <p class="text-gray-300 mb-4">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
          <button onclick="window.location.reload()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
            å†èª­ã¿è¾¼ã¿
          </button>
        </div>
      `;
      container.appendChild(errorDiv);
    }
  </script>