<script>
'use strict';

// ğŸ¯ Everyone's Answer Board - å®Œå…¨å¾©å…ƒç‰ˆ (e121b12ãƒ™ãƒ¼ã‚¹)
// ç¾åœ¨ã®GASã‚·ã‚¹ãƒ†ãƒ  (2025) ã«å®Œå…¨é©å¿œã—ãŸãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ç‰ˆ

// === åŸºæœ¬è¨­å®šã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
const CONFIG = Object.freeze({
  CACHE_DURATION: 120000,      // 2åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  POLLING_INTERVAL: 90000,     // 90ç§’ãƒãƒ¼ãƒªãƒ³ã‚°
  ANIMATION_DURATION: 300,     // 300msã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  MAX_DISPLAY_COLUMNS: 6,      // æœ€å¤§è¡¨ç¤ºåˆ—æ•°
  MIN_DISPLAY_COLUMNS: 1,      // æœ€å°è¡¨ç¤ºåˆ—æ•°
  RENDER_BATCH_SIZE: 10,       // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒãƒƒãƒã‚µã‚¤ã‚º
  CHUNK_SIZE: 5,               // DOMæ“ä½œãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º
  ERROR_RETRY_ATTEMPTS: 3,     // ã‚¨ãƒ©ãƒ¼ãƒªãƒˆãƒ©ã‚¤å›æ•°
  ERROR_RETRY_DELAY: 1000      // ãƒªãƒˆãƒ©ã‚¤é…å»¶(ms)
});

// ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©
const ICONS = Object.freeze({
  lightbulb: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2m8.66-10H20M4 12H2m15.07-7.07L17.66 6.34M6.34 6.34L4.93 4.93m12.14 12.14L15.66 15.66M6.34 17.66L4.93 19.07"/></svg>',
  thumbup: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 10v12l5-3 5 3V10l-5-8-5 8z"/></svg>',
  search: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/><path d="M11 8v6M8 11h6"/></svg>',
  star: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26 12,2"/></svg>',
  users: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
  x: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>'
});

// ã‚·ã‚¹ãƒ†ãƒ å®šæ•°
const SYSTEM_CONSTANTS = Object.freeze({
  REACTIONS: Object.freeze({
    KEYS: ['UNDERSTAND', 'LIKE', 'CURIOUS'],
    LABELS: Object.freeze({
      UNDERSTAND: 'ãªã‚‹ã»ã©ï¼',
      LIKE: 'ã„ã„ã­ï¼',
      CURIOUS: 'ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ï¼',
      HIGHLIGHT: 'ãƒã‚¤ãƒ©ã‚¤ãƒˆ'
    })
  }),
  DISPLAY_MODES: Object.freeze({
    ANONYMOUS: 'anonymous',
    SHOW_NAME: 'show_name',
    SHOW_COUNTS: 'show_counts'
  })
});

// DOMæ“ä½œãƒ˜ãƒ«ãƒ‘ãƒ¼
const DOMHelpers = Object.freeze({
  safeGetById(id) {
    return document.getElementById(id);
  },

  safeGetMultiple(ids) {
    return ids.reduce((acc, id) => {
      acc[id] = this.safeGetById(id);
      return acc;
    }, {});
  },

  createElement(tag, className = '', innerHTML = '') {
    const element = document.createElement(tag);
    if (className) element.className = className;
    if (innerHTML) element.innerHTML = innerHTML;
    return element;
  }
});

// === GAS APIå‘¼ã³å‡ºã—çµ±åˆã‚¯ãƒ©ã‚¹ ===
class UnifiedDataLoader {
  constructor() {
    this.cache = new Map();
    this.loadingStates = new Map();
    this.lastDataHash = null;
    this.newContentCount = 0;
  }

  // ç¾åœ¨ã®GAS APIé–¢æ•°ã«åˆã‚ã›ãŸå‘¼ã³å‡ºã—
  async callGAS(funcName, ...args) {
    const key = `${funcName}_${JSON.stringify(args)}`;

    if (this.loadingStates.get(key)) {
      return this.loadingStates.get(key);
    }

    const promise = this.executeWithRetry(() => {
      return new Promise((resolve, reject) => {
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            [funcName](...args);
        } else {
          resolve(this.getMockData(funcName, args));
        }
      });
    });

    this.loadingStates.set(key, promise);

    try {
      const result = await promise;
      this.loadingStates.delete(key);
      return result;
    } catch (error) {
      this.loadingStates.delete(key);
      console.error(`GASå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼ [${funcName}]:`, error);
      throw error;
    }
  }

  // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ãƒªãƒˆãƒ©ã‚¤ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
  async executeWithRetry(operation, maxRetries = CONFIG.ERROR_RETRY_ATTEMPTS) {
    let retryCount = 0;
    while (retryCount < maxRetries) {
      try {
        return await operation();
      } catch (error) {
        retryCount++;
        if (retryCount >= maxRetries) {
          throw error;
        }
        const delay = Math.pow(2, retryCount) * CONFIG.ERROR_RETRY_DELAY;
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
  getFromCache(key) {
    const cached = this.cache.get(key);
    if (cached && Date.now() - cached.timestamp < CONFIG.CACHE_DURATION) {
      return cached.data;
    }
    return null;
  }

  setCache(key, data) {
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }

  // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆé–‹ç™ºç”¨ï¼‰
  getMockData(funcName, args) {
    if (funcName === 'getUserConfig') {
      return {
        success: true,
        config: {
          spreadsheetId: 'mock-spreadsheet-id',
          sheetName: 'ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒˆ',
          title: 'ãƒ†ã‚¹ãƒˆå•é¡Œ',
          showDetails: true,
          userPermissions: {
            isOwner: false,
            isSystemAdmin: false,
            accessLevel: 'viewer'
          }
        }
      };
    }

    if (funcName === 'getPublishedSheetData') {
      return {
        success: true,
        header: 'ãƒ†ã‚¹ãƒˆå•é¡Œ',
        sheetName: 'ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒˆ',
        rows: [
          {
            rowIndex: 1,
            name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
            class: '3å¹´Açµ„',
            opinion: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆå›ç­”ã§ã™ã€‚',
            reason: 'ãƒ†ã‚¹ãƒˆç”¨ã®ç†ç”±ã§ã™ã€‚',
            reactions: {
              UNDERSTAND: { count: 2, reacted: false },
              LIKE: { count: 1, reacted: false },
              CURIOUS: { count: 0, reacted: false }
            },
            highlight: false
          }
        ]
      };
    }

    return { success: false, error: 'Mock data not available' };
  }

  // æ–°ç€é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
  async checkForNewContent(currentData) {
    try {
      const currentHash = this.generateDataHash(currentData);

      if (this.lastDataHash && this.lastDataHash !== currentHash) {
        const newCount = this.calculateNewContent(currentData);
        if (newCount > 0) {
          this.showNewContentNotification(newCount);
          return true;
        }
      }

      this.lastDataHash = currentHash;
      return false;
    } catch (error) {
      console.error('æ–°ç€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
      return false;
    }
  }

  generateDataHash(data) {
    if (!data || !data.rows) return '';
    return data.rows.map(row => `${row.rowIndex}-${row.opinion}-${JSON.stringify(row.reactions)}`).join('|');
  }

  calculateNewContent(data) {
    // ç°¡æ˜“å®Ÿè£…ï¼šãƒ‡ãƒ¼ã‚¿ã®é•·ã•ã§åˆ¤å®š
    const currentCount = data.rows ? data.rows.length : 0;
    const previousCount = this.newContentCount;
    this.newContentCount = currentCount;
    return Math.max(0, currentCount - previousCount);
  }

  showNewContentNotification(count) {
    const banner = DOMHelpers.safeGetById('newContentBanner');
    const text = DOMHelpers.safeGetById('newContentText');

    if (banner && text) {
      text.textContent = `${count}ä»¶ã®æ–°ã—ã„å›ç­”ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ`;
      banner.classList.remove('hidden');

      // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
      if (window.notifications) {
        window.notifications.info(`æ–°ã—ã„å›ç­”ãŒ${count}ä»¶è¿½åŠ ã•ã‚Œã¾ã—ãŸ`);
      }
    }
  }
}

// === ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ ===
class AnswerApp {
  constructor() {
    this.loader = new UnifiedDataLoader();
    this.appConfig = {};
    this.answers = [];
    this.isLoading = false;
    this.pollingInterval = null;
    this.currentSort = 'newest';

    this.init();
  }

  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
  async init() {
    try {
      // Step 1: ã‚»ã‚­ãƒ¥ã‚¢ãªå¤‰æ•°å–å¾—
      await this.initializeSecureContext();

      // Step 2: è¨­å®šèª­ã¿è¾¼ã¿ï¼ˆcurrent GAS functionsä½¿ç”¨ï¼‰
      await this.loadConfiguration();

      // Step 3: UIåˆæœŸåŒ–
      this.initializeUI();

      // Step 4: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      await this.loadAnswers();

      // Step 5: ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
      this.startPolling();

      console.log('âœ… AnswerApp initialization complete');
    } catch (error) {
      console.error('âŒ AnswerApp initialization error:', error);
      this.showError('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  // ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åˆæœŸåŒ–
  async initializeSecureContext() {
    // windowå¤‰æ•°ã‹ã‚‰å–å¾—
    this.userId = window.userId || null;
    this.userEmail = window.userEmail || null;

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å–å¾—
    if (!this.userId) {
      const urlParams = new URLSearchParams(window.location.search);
      this.userId = urlParams.get('userId');
    }

    // åŸºæœ¬æ¤œè¨¼
    if (this.userId && typeof this.userId !== 'string') {
      console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å½¢å¼ä¸æ­£:', this.userId);
    }
    if (this.userEmail && typeof this.userEmail !== 'string') {
      console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å½¢å¼ä¸æ­£:', this.userEmail);
    }
  }

  // è¨­å®šèª­ã¿è¾¼ã¿ï¼ˆç¾åœ¨ã®GASé–¢æ•°ä½¿ç”¨ï¼‰
  async loadConfiguration() {
    const cacheKey = `config_${this.userId}`;
    let config = this.loader.getFromCache(cacheKey);

    if (!config) {
      try {
        // ç¾åœ¨ã®GASé–¢æ•°ã‚’ä½¿ç”¨
        const response = await this.loader.callGAS('getUserConfig', this.userId);
        config = response.success ? response.config : {};
        this.loader.setCache(cacheKey, config);
      } catch (error) {
        console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
        config = {
          title: 'å•é¡Œ',
          sheetName: 'æœªè¨­å®š',
          showDetails: true,
          userPermissions: {
            isOwner: false,
            isSystemAdmin: false,
            accessLevel: 'viewer'
          }
        };
      }
    }

    this.appConfig = config;

    // æ¨©é™æƒ…å ±è¨­å®š
    if (config.userPermissions) {
      this.showAdminFeatures = Boolean(config.userPermissions.isOwner || config.userPermissions.isSystemAdmin);
      this.isAdminUser = Boolean(config.userPermissions.isOwner || config.userPermissions.isSystemAdmin);
      this.isOwner = Boolean(config.userPermissions.isOwner);
      this.isSystemAdmin = Boolean(config.userPermissions.isSystemAdmin);
    } else {
      this.showAdminFeatures = false;
      this.isAdminUser = false;
      this.isOwner = false;
      this.isSystemAdmin = false;
    }
  }

  // UIåˆæœŸåŒ–
  initializeUI() {
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
    const headingLabel = DOMHelpers.safeGetById('headingLabel');
    if (headingLabel) {
      headingLabel.innerHTML = this.escapeHtml(this.appConfig.title || this.appConfig.header || 'å•é¡Œ');
    }

    // ã‚·ãƒ¼ãƒˆåè¨­å®š
    const sheetNameText = DOMHelpers.safeGetById('sheetNameText');
    if (sheetNameText) {
      sheetNameText.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> ${this.escapeHtml(this.appConfig.sheetName || 'ä¸æ˜')}`;
    }

    // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
    this.updateModeDisplay();

    // ç®¡ç†è€…æ©Ÿèƒ½è¡¨ç¤º
    this.setupAdminFeatures();

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    this.setupEventListeners();

    // ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š
    this.setupIcons();
  }

  // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
  updateModeDisplay() {
    const modeLabel = DOMHelpers.safeGetById('modeLabel');
    if (modeLabel) {
      let modeText = 'å­¦ç¿’è€…';
      if (this.isSystemAdmin) {
        modeText = 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…';
      } else if (this.isOwner) {
        modeText = 'ä½œæˆè€…';
      } else if (this.showAdminFeatures) {
        modeText = 'ç®¡ç†è€…';
      }
      modeLabel.textContent = modeText;
    }
  }

  // ç®¡ç†è€…æ©Ÿèƒ½ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setupAdminFeatures() {
    if (this.showAdminFeatures) {
      // ç®¡ç†è€…ãƒœã‚¿ãƒ³è¡¨ç¤º
      const adminToggleBtn = DOMHelpers.safeGetById('adminToggleBtn');
      if (adminToggleBtn) {
        adminToggleBtn.classList.remove('hidden');
        adminToggleBtn.removeAttribute('hidden');
      }

      // ã‚¹ã‚³ã‚¢é †ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤º
      const scoreOption = DOMHelpers.safeGetById('scoreOption');
      if (scoreOption) {
        scoreOption.classList.remove('hidden');
        scoreOption.style.display = '';
      }
    }
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  setupEventListeners() {
    // ã‚½ãƒ¼ãƒˆé †å¤‰æ›´
    const sortOrder = DOMHelpers.safeGetById('sortOrder');
    if (sortOrder) {
      sortOrder.addEventListener('change', (e) => {
        this.currentSort = e.target.value;
        this.loadAnswers(this.currentSort);
      });
    }

    // ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´
    const classFilter = DOMHelpers.safeGetById('classFilter');
    if (classFilter) {
      classFilter.addEventListener('change', () => {
        this.loadAnswers(this.currentSort);
      });
    }

    // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºå¤‰æ›´
    const sizeSlider = DOMHelpers.safeGetById('sizeSlider');
    const sliderValue = DOMHelpers.safeGetById('sliderValue');
    if (sizeSlider && sliderValue) {
      sizeSlider.addEventListener('input', (e) => {
        const size = e.target.value;
        sliderValue.textContent = size;
        this.updateGridSize(size);
      });
    }

    // æ–°ç€é€šçŸ¥ãƒãƒŠãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    this.setupNewContentBanner();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
    this.setupModalEvents();
  }

  // æ–°ç€é€šçŸ¥ãƒãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setupNewContentBanner() {
    const refreshBtn = DOMHelpers.safeGetById('refreshContentBtn');
    const dismissBtn = DOMHelpers.safeGetById('dismissBannerBtn');
    const banner = DOMHelpers.safeGetById('newContentBanner');

    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        this.loadAnswers(this.currentSort);
        if (banner) banner.classList.add('hidden');
      });
    }

    if (dismissBtn) {
      dismissBtn.addEventListener('click', () => {
        if (banner) banner.classList.add('hidden');
      });
    }
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setupModalEvents() {
    const modalCloseBtn = DOMHelpers.safeGetById('answerModalCloseBtn');
    const modalContainer = DOMHelpers.safeGetById('answerModalContainer');

    if (modalCloseBtn) {
      modalCloseBtn.addEventListener('click', () => {
        this.closeModal();
      });
    }

    if (modalContainer) {
      modalContainer.addEventListener('click', (e) => {
        if (e.target === modalContainer) {
          this.closeModal();
        }
      });
    }
  }

  // ã‚¢ã‚¤ã‚³ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setupIcons() {
    const iconElements = {
      iconClose: 'x',
      infoIconLike: 'thumbup',
      infoIconUnderstand: 'lightbulb',
      infoIconCurious: 'search',
      infoIconHighlight: 'star',
      footerIcon: 'users'
    };

    Object.entries(iconElements).forEach(([elementId, iconKey]) => {
      const element = DOMHelpers.safeGetById(elementId);
      if (element && ICONS[iconKey]) {
        element.innerHTML = ICONS[iconKey];
      }
    });
  }

  // å›ç­”ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆç¾åœ¨ã®GASé–¢æ•°ä½¿ç”¨ï¼‰
  async loadAnswers(sortOrder = 'newest') {
    if (this.isLoading) return;

    this.isLoading = true;
    this.showLoading(true);

    try {
      const classFilter = DOMHelpers.safeGetById('classFilter');
      const filterValue = classFilter ? classFilter.value || 'ã™ã¹ã¦' : 'ã™ã¹ã¦';

      // ç¾åœ¨ã®GASé–¢æ•°ã‚’ä½¿ç”¨
      const data = await this.loader.callGAS('getPublishedSheetData', filterValue, sortOrder);

      if (!data.success && data.error) {
        throw new Error(data.error);
      }

      this.answers = data.rows || [];

      // æ–°ç€é€šçŸ¥ãƒã‚§ãƒƒã‚¯
      await this.loader.checkForNewContent(data);

      this.populateClassFilter(this.answers);
      this.renderAnswers();

    } catch (error) {
      console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      this.showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      this.isLoading = false;
      this.showLoading(false);
    }
  }

  // å›ç­”ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  renderAnswers() {
    const container = DOMHelpers.safeGetById('answers');
    if (!container) return;

    // å›ç­”æ•°è¡¨ç¤ºæ›´æ–°
    this.updateAnswerCount(this.answers.length);

    if (this.answers.length === 0) {
      container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    // å›ç­”ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
    const fragment = document.createDocumentFragment();
    this.answers.forEach(answer => {
      const card = this.createAnswerCard(answer);
      fragment.appendChild(card);
    });

    container.innerHTML = '';
    container.appendChild(fragment);
  }

  // å›ç­”ã‚«ãƒ¼ãƒ‰ä½œæˆ
  createAnswerCard(answer) {
    const card = DOMHelpers.createElement('div', 'answer-card glass-panel rounded-xl p-4 cursor-pointer transition-all duration-300 hover:scale-105');

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆè£…é£¾
    if (answer.highlight) {
      card.classList.add('highlighted');
    }

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è£…é£¾
    this.addReactionDecorations(card, answer.reactions);

    const showName = this.appConfig.showDetails !== false;
    const nameHtml = showName ? `<div class="font-bold text-sm mb-2">${this.escapeHtml(answer.name || '')}</div>` : '';

    card.innerHTML = `
      <div class="mb-3">
        ${nameHtml}
        <h3 class="text-cyan-200 font-semibold mb-2">${this.escapeHtml(answer.opinion || '')}</h3>
        <p class="text-gray-300 text-sm answer-preview">${this.escapeHtml(answer.reason || '')}</p>
      </div>
      ${this.createReactionButtons(answer)}
      ${answer.highlight ? '<div class="highlight-badge"><span class="text-yellow-300">' + ICONS.star + '</span></div>' : ''}
    `;

    // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    card.addEventListener('click', (e) => {
      if (!e.target.closest('.reaction-btn')) {
        this.showModal(answer);
      }
    });

    return card;
  }

  // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è£…é£¾è¿½åŠ 
  addReactionDecorations(card, reactions) {
    if (!reactions) return;

    const reactionTypes = Object.keys(reactions).filter(key => reactions[key].count > 0);

    if (reactionTypes.length > 0) {
      // è¤‡æ•°ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (reactionTypes.length > 1) {
        const colors = {
          LIKE: '#ef4444',
          UNDERSTAND: '#fbbf24',
          CURIOUS: '#10b981'
        };
        const gradientColors = reactionTypes.map(type => colors[type]).filter(Boolean);
        if (gradientColors.length > 1) {
          card.style.borderImage = `linear-gradient(45deg, ${gradientColors.join(', ')}) 1`;
          card.style.borderWidth = '2px';
        }
      } else {
        // å˜ä¸€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆ
        const type = reactionTypes[0];
        const colorClass = {
          LIKE: 'reaction-bg-like',
          UNDERSTAND: 'reaction-bg-understand',
          CURIOUS: 'reaction-bg-curious'
        }[type];
        if (colorClass) {
          card.classList.add(colorClass);
        }
      }

      // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã«å¿œã˜ã¦ãƒœãƒ¼ãƒ€ãƒ¼ã®å¤ªã•ã‚’èª¿æ•´
      const totalReactions = reactionTypes.reduce((sum, type) => sum + reactions[type].count, 0);
      if (totalReactions >= 5) {
        card.classList.add('reaction-border-3');
      } else if (totalReactions >= 3) {
        card.classList.add('reaction-border-2');
      } else {
        card.classList.add('reaction-border-1');
      }
    }
  }

  // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ä½œæˆ
  createReactionButtons(answer) {
    if (!this.showAdminFeatures && !this.appConfig.showDetails) return '';

    const reactions = answer.reactions || {};
    const reactionButtons = Object.entries(reactions).map(([type, data]) => {
      const isReacted = data.reacted || false;
      const count = data.count || 0;
      const icon = {
        LIKE: ICONS.thumbup,
        UNDERSTAND: ICONS.lightbulb,
        CURIOUS: ICONS.search
      }[type] || ICONS.thumbup;

      return `
        <button class="reaction-btn flex items-center gap-1 text-xs px-2 py-1 rounded transition-all ${isReacted ? 'reacted' : 'bg-gray-800 hover:bg-gray-700'}"
                data-type="${type}" data-row="${answer.rowIndex}">
          ${icon}
          <span>${count}</span>
        </button>
      `;
    }).join('');

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒœã‚¿ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
    let highlightButton = '';
    if (this.showAdminFeatures) {
      highlightButton = `
        <button class="highlight-btn ml-2 p-1 rounded transition-all ${answer.highlight ? 'liked' : 'hover:bg-gray-700'}"
                data-action="highlight" data-row="${answer.rowIndex}">
          ${ICONS.star}
        </button>
      `;
    }

    return `
      <div class="flex items-center gap-2 pt-2 border-t border-gray-700">
        ${reactionButtons}
        ${highlightButton}
      </div>
    `;
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  showModal(answer) {
    const modalContainer = DOMHelpers.safeGetById('answerModalContainer');
    const modalCard = DOMHelpers.safeGetById('answerModalCard');
    const modalAnswer = DOMHelpers.safeGetById('modalAnswer');
    const modalStudentName = DOMHelpers.safeGetById('modalStudentName');
    const modalReactions = DOMHelpers.safeGetById('modalReactions');

    if (!modalContainer || !modalCard || !modalAnswer) return;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å®¹è¨­å®š
    const showName = this.appConfig.showDetails !== false;
    modalAnswer.innerHTML = `
      <div class="space-y-4">
        <div>
          <h2 class="text-2xl font-bold text-cyan-200 mb-4">${this.escapeHtml(answer.opinion || '')}</h2>
          <div class="text-gray-200 text-lg leading-relaxed whitespace-pre-wrap">${this.escapeHtml(answer.reason || '')}</div>
        </div>
      </div>
    `;

    if (modalStudentName) {
      modalStudentName.textContent = showName ? (answer.name || '') : '';
    }

    if (modalReactions) {
      modalReactions.innerHTML = this.createReactionButtons(answer);
    }

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆè£…é£¾ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚‚é©ç”¨
    if (answer.highlight) {
      modalCard.classList.add('highlighted');
    } else {
      modalCard.classList.remove('highlighted');
    }

    this.addReactionDecorations(modalCard, answer.reactions);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    modalContainer.classList.remove('hidden');
    modalContainer.classList.add('modal-fade');
    modalCard.classList.add('modal-scale');

    setTimeout(() => {
      modalContainer.style.opacity = '1';
      modalCard.style.transform = 'scale(1)';
    }, 10);
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
  closeModal() {
    const modalContainer = DOMHelpers.safeGetById('answerModalContainer');
    const modalCard = DOMHelpers.safeGetById('answerModalCard');

    if (modalContainer && modalCard) {
      modalContainer.style.opacity = '0';
      modalCard.style.transform = 'scale(0.95)';

      setTimeout(() => {
        modalContainer.classList.add('hidden');
        modalCard.classList.remove('highlighted', 'reaction-bg-like', 'reaction-bg-understand', 'reaction-bg-curious', 'reaction-border-1', 'reaction-border-2', 'reaction-border-3');
        modalCard.style.borderImage = '';
        modalCard.style.borderWidth = '';
      }, 300);
    }
  }

  // ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”Ÿæˆ
  populateClassFilter(answers) {
    const classFilter = DOMHelpers.safeGetById('classFilter');
    if (!classFilter) return;

    const classes = [...new Set(answers.map(a => a.class).filter(Boolean))];

    if (classes.length > 0) {
      classFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¹</option>' +
        classes.map(cls => `<option value="${this.escapeHtml(cls)}">${this.escapeHtml(cls)}</option>`).join('');
      classFilter.classList.remove('hidden');
    }
  }

  // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
  startPolling() {
    if (this.pollingInterval) {
      clearInterval(this.pollingInterval);
    }
    this.pollingInterval = setInterval(() => {
      if (!this.isLoading) {
        this.loadAnswers(this.currentSort);
      }
    }, CONFIG.POLLING_INTERVAL);
  }

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¡ã‚½ãƒƒãƒ‰
  updateAnswerCount(count) {
    const answerCount = DOMHelpers.safeGetById('answerCount');
    const answerCountText = DOMHelpers.safeGetById('answerCountText');

    if (answerCountText) {
      answerCountText.textContent = `${count} ä»¶ã®å›ç­”`;
    }
  }

  updateGridSize(size) {
    const container = DOMHelpers.safeGetById('answers');
    if (container) {
      container.className = `grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-${Math.min(size, CONFIG.MAX_DISPLAY_COLUMNS)}`;
    }
  }

  showLoading(show) {
    const headingLabel = DOMHelpers.safeGetById('headingLabel');
    if (headingLabel) {
      if (show) {
        headingLabel.innerHTML = `
          <svg class="w-5 h-5 md:w-6 md:h-6 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
          </svg>
        `;
      }
    }
  }

  showError(message) {
    const container = DOMHelpers.safeGetById('answers');
    if (container) {
      container.innerHTML = `<div class="col-span-full text-center text-red-400 py-8">${this.escapeHtml(message)}</div>`;
    }

    // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã§ã‚‚ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    if (window.notifications) {
      window.notifications.error(message);
    }
  }

  escapeHtml(str) {
    if (!str) return '';
    return str.toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
}

// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
document.addEventListener('click', async (e) => {
  // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  if (e.target.closest('.reaction-btn')) {
    e.preventDefault();
    const btn = e.target.closest('.reaction-btn');
    const type = btn.dataset.type;
    const rowIndex = btn.dataset.row;

    if (!window.answerApp || !window.answerApp.userEmail) {
      if (window.notifications) {
        window.notifications.error('èªè¨¼ãŒå¿…è¦ã§ã™');
      }
      return;
    }

    try {
      btn.classList.add('loading');

      // ç¾åœ¨ã®GASé–¢æ•°ã‚’ä½¿ç”¨
      await window.answerApp.loader.callGAS('addReaction', window.answerApp.userEmail, parseInt(rowIndex), type);

      // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
      await window.answerApp.loadAnswers(window.answerApp.currentSort);

      if (window.notifications) {
        window.notifications.success('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
      if (window.notifications) {
        window.notifications.error('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } finally {
      btn.classList.remove('loading');
    }
  }

  // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  if (e.target.closest('.highlight-btn')) {
    e.preventDefault();
    const btn = e.target.closest('.highlight-btn');
    const rowIndex = btn.dataset.row;

    if (!window.answerApp || !window.answerApp.showAdminFeatures) {
      return;
    }

    try {
      btn.classList.add('loading');

      // ç¾åœ¨ã®GASé–¢æ•°ã‚’ä½¿ç”¨ï¼ˆtoggleHighlighté–¢æ•°ã‚’ç¢ºèªï¼‰
      await window.answerApp.loader.callGAS('toggleHighlight', window.answerApp.userEmail, parseInt(rowIndex));

      // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
      await window.answerApp.loadAnswers(window.answerApp.currentSort);

      if (window.notifications) {
        window.notifications.success('ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('ãƒã‚¤ãƒ©ã‚¤ãƒˆå¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
      if (window.notifications) {
        window.notifications.error('ãƒã‚¤ãƒ©ã‚¤ãƒˆã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } finally {
      btn.classList.remove('loading');
    }
  }
});

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
document.addEventListener('DOMContentLoaded', () => {
  window.answerApp = new AnswerApp();
});

</script>