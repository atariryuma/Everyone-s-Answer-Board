<script>
'use strict';

// Everyone's Answer Board - Complete Restoration Version (e121b12 base)
// Fully adapted refactoring for current GAS system (2025)

// Basic Configuration and Utilities
const CONFIG = Object.freeze({
  CACHE_DURATION: 120000,      // 2-minute cache
  POLLING_INTERVAL: 90000,     // 90-second polling
  ANIMATION_DURATION: 300,     // 300ms animation
  MAX_DISPLAY_COLUMNS: 6,      // Maximum display columns
  MIN_DISPLAY_COLUMNS: 1,      // Minimum display columns
  RENDER_BATCH_SIZE: 10,       // Rendering batch size
  CHUNK_SIZE: 5,               // DOM operation chunk size
  ERROR_RETRY_ATTEMPTS: 3,     // Error retry attempts
  ERROR_RETRY_DELAY: 1000,     // Retry delay (ms)
  // Modal animation values
  MODAL_OPACITY_VISIBLE: 1,    // Modal visible opacity
  MODAL_OPACITY_HIDDEN: 0,     // Modal hidden opacity
  MODAL_SCALE_NORMAL: 1,       // Modal normal scale
  MODAL_SCALE_SMALL: 0.95      // Modal small scale
});

// Complete SVG icon library (cloned from docs/page.f0068fa)
const ICONS = Object.freeze({
  'lightbulb-outline': '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6zM9 16.5h6v4H9v-4zm0 1h6zm0 1h6zM10.5 11l.5 2h2l.5-2m-3 1h3"/></svg>',
  'lightbulb-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6z M10.5 11.25 L11 13 L13 13 L13.5 11.25 H 10.5 Z"/><path d="M9 16.5h6v1H9z M9 18h6v1H9z M9 19.5h6v1H9z"/></svg>',
  'hand-thumb-up-outline': '<svg fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.338 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>',
  'hand-thumb-up-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z M6.5 10v12h1V10h-1z"/></svg>',
  'magnifying-glass-plus-outline': '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6"/></svg>',
  'magnifying-glass-plus-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1116.5 0 8.25 8.25 0 01-16.5 0zM10.5 7.125a3.375 3.375 0 100 6.75 3.375 3.375 0 000-6.75zM6.75 10.5a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0z" clip-rule="evenodd"/></svg>',
  'x': '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>',
  'star-outline': '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>',
  'star-solid': '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z"/></svg>',
  'grid-2x2': '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>',
  'users': '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m0 0a4 4 0 017.5 1.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>',
  'check-circle': '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
  'exclamation-triangle': '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>',
  'information-circle': '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"/></svg>',
  'chevron-down': '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>',
  'cog': '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',
  'clipboard': '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>',
  'x-circle': '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636"/></svg>',
  // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ—¢å­˜ã®ã‚­ãƒ¼åã‚‚ä¿æŒ
  lightbulb: '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2V.5M5.25 6.75L4.2 5.7M18.75 6.75l1.05-1.05M12 4a6 6 0 00-6 6c0 2.25 1 4.2 2.5 5.34V16.5h7v-1.16A6.002 6.002 0 0018 10a6 6 0 00-6-6zM9 16.5h6v4H9v-4zm0 1h6zm0 1h6zM10.5 11l.5 2h2l.5-2m-3 1h3"/></svg>',
  thumbup: '<svg fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.338 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>',
  search: '<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6"/></svg>',
  star: '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z"/></svg>'
});

// System constants
const SYSTEM_CONSTANTS = Object.freeze({
  REACTIONS: Object.freeze({
    KEYS: ['UNDERSTAND', 'LIKE', 'CURIOUS'],
    LABELS: Object.freeze({
      UNDERSTAND: 'ãªã‚‹ã»ã©ï¼',
      LIKE: 'ã„ã„ã­ï¼',
      CURIOUS: 'ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ï¼',
      HIGHLIGHT: 'ãƒã‚¤ãƒ©ã‚¤ãƒˆ'
    })
  }),
  DISPLAY_MODES: Object.freeze({
    ANONYMOUS: 'anonymous',
    SHOW_NAME: 'show_name',
    SHOW_COUNTS: 'show_counts'
  })
});

// DOM operation helpers
const DOMHelpers = Object.freeze({
  safeGetById(id) {
    return document.getElementById(id);
  },

  safeGetMultiple(ids) {
    return ids.reduce((acc, id) => {
      acc[id] = this.safeGetById(id);
      return acc;
    }, {});
  },

  createElement(tag, className = '', innerHTML = '') {
    const element = document.createElement(tag);
    if (className) element.className = className;
    if (innerHTML) element.innerHTML = innerHTML;
    return element;
  }
});

// === GAS APIå‘¼ã³å‡ºã—çµ±åˆã‚¯ãƒ©ã‚¹ ===
class AnswerBoardDataLoader {
  constructor() {
    this.cache = new Map();
    this.loadingStates = new Map();
    this.lastDataHash = null;
    this.newContentCount = 0;
  }

  // === f0068faç‰ˆå¾©å…ƒæ©Ÿèƒ½ ===

  // ãƒ•ã‚©ãƒ¼ãƒ URLæ¤œå‡ºï¼ˆæ–°æ©Ÿèƒ½ï¼‰
  async detectFormUrl(sheetId = null) {
    try {
      return await this.callGAS('detectFormUrl', sheetId);
    } catch (error) {
      console.warn('Form URL detection failed:', error);
      return { success: false, formUrl: null };
    }
  }

  // ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
  async checkDomainAuth(userEmail = null) {
    try {
      return await this.callGAS('checkDomainAuth', userEmail);
    } catch (error) {
      console.warn('Domain auth check failed:', error);
      return { success: false, domainStatus: 'unknown' };
    }
  }

  // æ–°ç€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œå‡ºï¼ˆæ–°æ©Ÿèƒ½ï¼‰
  async detectNewContent(lastUpdateTime) {
    try {
      return await this.callGAS('detectNewContent', lastUpdateTime);
    } catch (error) {
      console.warn('New content detection failed:', error);
      return { success: false, hasNewContent: false };
    }
  }

  // Diff update check (advanced feature)
  async checkForUpdates() {
    const now = new Date().toISOString();
    const lastCheck = localStorage.getItem('lastUpdateCheck') || new Date(0).toISOString();

    const result = await this.detectNewContent(lastCheck);

    if (result.success && result.hasNewContent) {
      this.showNewContentBanner(result.newItemsCount, result.newItems);
    }

    localStorage.setItem('lastUpdateCheck', now);
    return result;
  }

  // New content banner display
  showNewContentBanner(count, items) {
    const banner = document.getElementById('newContentBanner');
    if (!banner) return;

    const textElement = document.getElementById('newContentText');
    if (textElement) {
      textElement.textContent = `${count}ä»¶ã®æ–°ã—ã„å›ç­”ãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ`;
    }

    banner.classList.add('show');

    // 10ç§’å¾Œã«è‡ªå‹•éè¡¨ç¤º
    setTimeout(() => {
      if (banner.classList.contains('show')) {
        banner.classList.remove('show');
      }
    }, 10000);
  }

  // ç¾åœ¨ã®GAS APIé–¢æ•°ã«åˆã‚ã›ãŸå‘¼ã³å‡ºã—
  async callGAS(funcName, ...args) {
    const key = `${funcName}_${JSON.stringify(args)}`;

    if (this.loadingStates.get(key)) {
      console.log(`ğŸ”„ GAS Cache Hit: ${funcName}`, { args });
      return this.loadingStates.get(key);
    }

    console.log(`ğŸ“¡ GAS Call Start: ${funcName}`, {
      args,
      timestamp: new Date().toISOString(),
      hasGoogleAPI: typeof google !== 'undefined' && !!google.script?.run
    });

    const promise = this.executeWithRetry(() => {
      return new Promise((resolve, reject) => {
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          const startTime = performance.now();

          google.script.run
            .withSuccessHandler((result) => {
              const endTime = performance.now();
              console.log(`âœ… GAS Success: ${funcName}`, {
                args,
                result: result?.success ? 'success' : 'failed',
                executionTime: `${(endTime - startTime).toFixed(2)}ms`,
                dataSize: JSON.stringify(result).length,
                timestamp: new Date().toISOString()
              });
              resolve(result);
            })
            .withFailureHandler((error) => {
              const endTime = performance.now();
              console.error(`âŒ GAS Error: ${funcName}`, {
                args,
                error: error.message || error,
                executionTime: `${(endTime - startTime).toFixed(2)}ms`,
                timestamp: new Date().toISOString()
              });
              reject(error);
            })
            [funcName](...args);
        } else {
          console.warn(`ğŸ”§ GAS Mock Mode: ${funcName}`, { args });
          resolve(this.getMockData(funcName, args));
        }
      });
    });

    this.loadingStates.set(key, promise);

    try {
      const result = await promise;
      this.loadingStates.delete(key);
      console.log(`ğŸ¯ GAS Complete: ${funcName}`, {
        success: result?.success !== false,
        hasData: !!result?.rows || !!result?.config,
        timestamp: new Date().toISOString()
      });
      return result;
    } catch (error) {
      this.loadingStates.delete(key);
      console.error(`ğŸ’¥ GAS Exception: ${funcName}`, {
        args,
        error: error.message || error,
        timestamp: new Date().toISOString()
      });
      throw error;
    }
  }

  // Exponential backoff retry mechanism
  async executeWithRetry(operation, maxRetries = CONFIG.ERROR_RETRY_ATTEMPTS) {
    let retryCount = 0;
    while (retryCount < maxRetries) {
      try {
        return await operation();
      } catch (error) {
        retryCount++;
        if (retryCount >= maxRetries) {
          throw error;
        }
        const delay = Math.pow(2, retryCount) * CONFIG.ERROR_RETRY_DELAY;
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
  getFromCache(key) {
    const cached = this.cache.get(key);
    if (cached && Date.now() - cached.timestamp < CONFIG.CACHE_DURATION) {
      return cached.data;
    }
    return null;
  }

  setCache(key, data) {
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }

  // Mock data (development)
  getMockData(funcName, args) {
    if (funcName === 'getUserConfig') {
      return {
        success: true,
        config: {
          spreadsheetId: 'mock-spreadsheet-id',
          sheetName: 'ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒˆ',
          title: 'ãƒ†ã‚¹ãƒˆå•é¡Œ',
          showDetails: true,
          userPermissions: {
            isOwner: false,
            isSystemAdmin: false,
            accessLevel: 'viewer'
          }
        }
      };
    }

    if (funcName === 'getPublishedSheetData') {
      return {
        success: true,
        header: 'ãƒ†ã‚¹ãƒˆå•é¡Œ',
        sheetName: 'ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒˆ',
        rows: [
          {
            rowIndex: 1,
            name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
            class: '3å¹´Açµ„',
            opinion: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆå›ç­”ã§ã™ã€‚',
            reason: 'ãƒ†ã‚¹ãƒˆç”¨ã®ç†ç”±ã§ã™ã€‚',
            reactions: {
              UNDERSTAND: { count: 2, reacted: false },
              LIKE: { count: 1, reacted: false },
              CURIOUS: { count: 0, reacted: false }
            },
            highlight: false
          }
        ]
      };
    }

    return { success: false, error: 'Mock data not available' };
  }

  // æ–°ç€é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
  async checkForNewContent(currentData) {
    try {
      const currentHash = this.generateDataHash(currentData);

      if (this.lastDataHash && this.lastDataHash !== currentHash) {
        const newCount = this.calculateNewContent(currentData);
        if (newCount > 0) {
          this.showNewContentNotification(newCount);
          return true;
        }
      }

      this.lastDataHash = currentHash;
      return false;
    } catch (error) {
      console.error('New content check error:', error);
      return false;
    }
  }

  generateDataHash(data) {
    if (!data || !data.rows) return '';
    return data.rows.map(row => `${row.rowIndex}-${row.opinion}-${JSON.stringify(row.reactions)}`).join('|');
  }

  calculateNewContent(data) {
    // Simple implementation: judge by data length
    const currentCount = data.rows ? data.rows.length : 0;
    const previousCount = this.newContentCount;
    this.newContentCount = currentCount;
    return Math.max(0, currentCount - previousCount);
  }

  showNewContentNotification(count) {
    const banner = DOMHelpers.safeGetById('newContentBanner');
    const text = DOMHelpers.safeGetById('newContentText');

    if (banner && text) {
      text.textContent = `${count}ä»¶ã®æ–°ã—ã„å›ç­”ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ`;
      banner.classList.remove('hidden');

      // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
      if (window.notifications) {
        window.notifications.info(`æ–°ã—ã„å›ç­”ãŒ${count}ä»¶è¿½åŠ ã•ã‚Œã¾ã—ãŸ`);
      }
    }
  }
}

// === ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ ===
class AnswerApp {
  constructor() {
    this.loader = new AnswerBoardDataLoader();
    this.appConfig = {};
    this.answers = [];
    this.isLoading = false;
    this.pollingInterval = null;
    this.currentSort = 'newest';

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã¨ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆè¦‹æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã¨äº’æ›ï¼‰
    this.reactionTypes = [
      { key: 'LIKE', icon: 'hand-thumb-up' },
      { key: 'UNDERSTAND', icon: 'lightbulb' },
      { key: 'CURIOUS', icon: 'magnifying-glass-plus' }
    ];

    this.init();
  }

  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
  async init() {
    try {
      // Display digital citizenship modal on first access (concurrent with loading)
      const hasSeenDigitalCitizenship = localStorage.getItem('hasSeenDigitalCitizenship');
      const shouldShowModal = !hasSeenDigitalCitizenship ||
        (hasSeenDigitalCitizenship && Date.now() > parseInt(hasSeenDigitalCitizenship));

      if (shouldShowModal && window.sharedModals) {
        console.log('ğŸŒ First access/expired: Show digital citizenship modal');
        window.sharedModals.showDigitalCitizenship();
        // è¡¨ç¤ºæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆ24æ™‚é–“æœ‰åŠ¹ï¼‰
        const expiry = Date.now() + (24 * 60 * 60 * 1000);
        localStorage.setItem('hasSeenDigitalCitizenship', expiry.toString());
      }

      // Step 1: Secure variable acquisition
      await this.initializeSecureContext();

      // Step 2: è¨­å®šèª­ã¿è¾¼ã¿ï¼ˆcurrent GAS functionsä½¿ç”¨ï¼‰
      await this.loadConfiguration();

      // Step 3: UIåˆæœŸåŒ–
      this.initializeUI();

      // Step 4: Data loading
      await this.loadAnswers();

      // Step 5: ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
      this.startPolling();

      console.log('âœ… AnswerApp initialization complete');
    } catch (error) {
      console.error('âŒ AnswerApp initialization error:', error);
      this.showError('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  // ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åˆæœŸåŒ–
  async initializeSecureContext() {
    // Get from window variables
    this.userId = window.userId || null;
    this.userEmail = window.userEmail || null;

    // Fallback from URL parameters
    if (!this.userId) {
      const urlParams = new URLSearchParams(window.location.search);
      this.userId = urlParams.get('userId');
    }

    // åŸºæœ¬æ¤œè¨¼
    if (this.userId && typeof this.userId !== 'string') {
      console.error('Invalid userId field format:', this.userId);
    }
    if (this.userEmail && typeof this.userEmail !== 'string') {
      console.error('Invalid userEmail field format:', this.userEmail);
    }
  }

  // è¨­å®šèª­ã¿è¾¼ã¿ï¼ˆç¾åœ¨ã®GASé–¢æ•°ä½¿ç”¨ï¼‰
  async loadConfiguration() {
    const cacheKey = `config_${this.userId}`;
    let config = this.loader.getFromCache(cacheKey);

    console.log('âš™ï¸ LoadConfiguration Start', {
      userId: this.userId,
      hasCachedConfig: !!config,
      timestamp: new Date().toISOString()
    });

    if (!config) {
      try {
        // ç¾åœ¨ã®GASé–¢æ•°ã‚’ä½¿ç”¨
        console.log('ğŸ“¡ LoadConfiguration: Calling getUserConfig API');
        const response = await this.loader.callGAS('getUserConfig', this.userId);

        console.log('ğŸ“Š LoadConfiguration: API response', {
          success: response.success,
          hasConfig: !!response.config,
          configKeys: response.config ? Object.keys(response.config) : []
        });

        config = response.success ? response.config : {};
        this.loader.setCache(cacheKey, config);
      } catch (error) {
        console.error('âŒ Configuration loading error', {
          error: error.message || error,
          userId: this.userId,
          timestamp: new Date().toISOString()
        });
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
        config = {
          title: 'å•é¡Œ',
          sheetName: 'æœªè¨­å®š',
          showDetails: true,
          userPermissions: {
            isOwner: false,
            isSystemAdmin: false,
            accessLevel: 'viewer'
          }
        };
        console.log('ğŸ”„ LoadConfiguration: Using fallback config', config);
      }
    } else {
      console.log('ğŸ”„ LoadConfiguration: Using cached config');
    }

    this.appConfig = config;
    console.log('âœ… LoadConfiguration Complete', {
      title: config.title,
      sheetName: config.sheetName,
      showDetails: config.showDetails,
      hasPermissions: !!config.userPermissions,
      timestamp: new Date().toISOString()
    });

    // æ¨©é™æƒ…å ±è¨­å®š
    if (config.userPermissions) {
      this.showAdminFeatures = Boolean(config.userPermissions.isOwner || config.userPermissions.isSystemAdmin);
      this.isAdminUser = Boolean(config.userPermissions.isOwner || config.userPermissions.isSystemAdmin);
      this.isOwner = Boolean(config.userPermissions.isOwner);
      this.isSystemAdmin = Boolean(config.userPermissions.isSystemAdmin);
    } else {
      this.showAdminFeatures = false;
      this.isAdminUser = false;
      this.isOwner = false;
      this.isSystemAdmin = false;
    }

    // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯OFFï¼‰
    this.adminMode = false;
  }

  // UIåˆæœŸåŒ–
  initializeUI() {
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ã¿ã€å®Ÿéš›ã®å•é¡Œæ–‡ã¯loadAnswers()ã§è¨­å®šï¼‰
    const headingLabel = DOMHelpers.safeGetById('headingLabel');
    if (headingLabel) {
      headingLabel.innerHTML = this.escapeHtml('ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰');
    }

    // ã‚·ãƒ¼ãƒˆåè¨­å®š
    const sheetNameText = DOMHelpers.safeGetById('sheetNameText');
    if (sheetNameText) {
      sheetNameText.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> ${this.escapeHtml(this.appConfig.sheetName || 'ä¸æ˜')}`;
    }

    // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
    this.updateModeDisplay();

    // ç®¡ç†è€…æ©Ÿèƒ½è¡¨ç¤º
    this.setupAdminFeatures();

    // Event listener setup
    this.setupEventListeners();

    // ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š
    this.setupIcons();
  }

  // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
  updateModeDisplay() {
    const modeLabel = DOMHelpers.safeGetById('modeLabel');
    if (modeLabel) {
      let modeText = 'å­¦ç¿’è€…';
      if (this.isSystemAdmin) {
        modeText = 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…';
      } else if (this.isOwner) {
        modeText = 'ä½œæˆè€…';
      } else if (this.showAdminFeatures) {
        modeText = 'ç®¡ç†è€…';
      }
      modeLabel.textContent = modeText;
    }
  }

  // ç®¡ç†è€…æ©Ÿèƒ½ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setupAdminFeatures() {
    if (this.showAdminFeatures) {
      // Admin button display
      const adminToggleBtn = DOMHelpers.safeGetById('adminToggleBtn');
      if (adminToggleBtn) {
        adminToggleBtn.classList.remove('hidden');
        adminToggleBtn.removeAttribute('hidden');
      }

      // End publication button display
      const endPublicationBtn = DOMHelpers.safeGetById('endPublicationBtn');
      if (endPublicationBtn) {
        endPublicationBtn.classList.remove('hidden');
        endPublicationBtn.removeAttribute('hidden');
      }

      // ã‚¹ã‚³ã‚¢é †ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤º
      const scoreOption = DOMHelpers.safeGetById('scoreOption');
      if (scoreOption) {
        scoreOption.classList.remove('hidden');
        scoreOption.style.display = '';
      }
    }
  }

  // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
  toggleAdminMode() {
    this.adminMode = !this.adminMode;
    console.log('Admin mode toggled:', this.adminMode);

    // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
    this.updateModeDisplay();

    // å›ç­”ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç®¡ç†æ©Ÿèƒ½ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    this.loadAnswers(this.currentSort);

    // Update button appearance
    const adminToggleBtn = DOMHelpers.safeGetById('adminToggleBtn');
    if (adminToggleBtn) {
      if (this.adminMode) {
        adminToggleBtn.classList.add('bg-cyan-600', 'text-white');
        adminToggleBtn.classList.remove('text-gray-500');
        adminToggleBtn.title = 'ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ON (ã‚¯ãƒªãƒƒã‚¯ã§OFF)';
      } else {
        adminToggleBtn.classList.remove('bg-cyan-600', 'text-white');
        adminToggleBtn.classList.add('text-gray-500');
        adminToggleBtn.title = 'ç®¡ç†ãƒ¢ãƒ¼ãƒ‰OFF (ã‚¯ãƒªãƒƒã‚¯ã§ON)';
      }
    }
  }

  // Event listener setup
  setupEventListeners() {
    // ã‚½ãƒ¼ãƒˆé †å¤‰æ›´
    const sortOrder = DOMHelpers.safeGetById('sortOrder');
    if (sortOrder) {
      sortOrder.addEventListener('change', (e) => {
        this.currentSort = e.target.value;
        this.loadAnswers(this.currentSort);
      });
    }

    // Class filter change
    const classFilter = DOMHelpers.safeGetById('classFilter');
    if (classFilter) {
      classFilter.addEventListener('change', () => {
        this.loadAnswers(this.currentSort);
      });
    }

    // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºå¤‰æ›´
    const sizeSlider = DOMHelpers.safeGetById('sizeSlider');
    const sliderValue = DOMHelpers.safeGetById('sliderValue');
    if (sizeSlider && sliderValue) {
      sizeSlider.addEventListener('input', (e) => {
        const size = e.target.value;
        sliderValue.textContent = size;
        this.updateGridSize(size);
      });
    }

    // Admin mode toggle button
    const adminToggleBtn = DOMHelpers.safeGetById('adminToggleBtn');
    if (adminToggleBtn) {
      adminToggleBtn.addEventListener('click', () => {
        this.toggleAdminMode();
      });
    }

    // End publication button
    const endPublicationBtn = DOMHelpers.safeGetById('endPublicationBtn');
    if (endPublicationBtn) {
      endPublicationBtn.addEventListener('click', async () => {
        if (confirm('å›ç­”ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ\nçµ‚äº†å¾Œã¯å›ç­”ã®è¿½åŠ ãŒã§ããªããªã‚Šã¾ã™ã€‚')) {
          try {
            console.log('Executing publication end process');
            // å®Ÿè£…äºˆå®š: å…¬é–‹çµ‚äº†ã®APIå‘¼ã³å‡ºã—
            alert('å…¬é–‹çµ‚äº†æ©Ÿèƒ½ã¯å®Ÿè£…äºˆå®šã§ã™');
          } catch (error) {
            console.error('Publication end error:', error);
            alert('å…¬é–‹çµ‚äº†ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        }
      });
    }

    // New content banner events
    this.setupNewContentBanner();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
    this.setupModalEvents();
  }

  // New content banner setup
  setupNewContentBanner() {
    const refreshBtn = DOMHelpers.safeGetById('refreshContentBtn');
    const dismissBtn = DOMHelpers.safeGetById('dismissBannerBtn');
    const banner = DOMHelpers.safeGetById('newContentBanner');

    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        this.loadAnswers(this.currentSort);
        if (banner) banner.classList.add('hidden');
      });
    }

    if (dismissBtn) {
      dismissBtn.addEventListener('click', () => {
        if (banner) banner.classList.add('hidden');
      });
    }
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setupModalEvents() {
    const modalCloseBtn = DOMHelpers.safeGetById('answerModalCloseBtn');
    const modalContainer = DOMHelpers.safeGetById('answerModalContainer');

    if (modalCloseBtn) {
      modalCloseBtn.addEventListener('click', () => {
        this.closeModal();
      });
    }

    if (modalContainer) {
      modalContainer.addEventListener('click', (e) => {
        if (e.target === modalContainer) {
          this.closeModal();
        }
      });
    }
  }

  // ã‚¢ã‚¤ã‚³ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setupIcons() {
    const iconElements = {
      iconClose: 'x',
      infoIconLike: 'thumbup',
      infoIconUnderstand: 'lightbulb',
      infoIconCurious: 'search',
      infoIconHighlight: 'star',
      footerIcon: 'users'
    };

    Object.entries(iconElements).forEach(([elementId, iconKey]) => {
      const element = DOMHelpers.safeGetById(elementId);
      if (element && ICONS[iconKey]) {
        element.innerHTML = ICONS[iconKey];
      }
    });
  }

  // Answer data loading (using current GAS functions)
  async loadAnswers(sortOrder = 'newest') {
    if (this.isLoading) {
      console.log('â³ LoadAnswers: Already loading, skipping');
      return;
    }

    console.log('ğŸ”„ LoadAnswers Start', {
      sortOrder,
      userId: this.userId,
      timestamp: new Date().toISOString()
    });

    this.isLoading = true;
    this.showLoading(true);

    try {
      const classFilter = DOMHelpers.safeGetById('classFilter');
      const filterValue = classFilter ? classFilter.value || 'ã™ã¹ã¦' : 'ã™ã¹ã¦';

      console.log('ğŸ“‹ LoadAnswers: Filter parameters', {
        classFilter: filterValue,
        sortOrder,
        userId: this.userId
      });

      // ç¾åœ¨ã®GASé–¢æ•°ã‚’ä½¿ç”¨
      const data = await this.loader.callGAS('getPublishedSheetData', filterValue, sortOrder);

      console.log('ğŸ“Š LoadAnswers: Data received', {
        success: data.success,
        rowCount: data.rows?.length || 0,
        hasHeader: !!data.header,
        hasError: !!data.error,
        sheetName: data.sheetName,
        timestamp: new Date().toISOString()
      });

      if (!data.success && data.error) {
        throw new Error(data.error);
      }

      this.answers = data.rows || [];

      // å•é¡Œæ–‡ã‚’å‹•çš„æ›´æ–°ï¼ˆgetPublishedSheetDataã®headerã‚’ä½¿ç”¨ï¼‰
      if (data.header) {
        const headingLabel = DOMHelpers.safeGetById('headingLabel');
        if (headingLabel) {
          headingLabel.innerHTML = this.escapeHtml(data.header);
        }
        console.log('ğŸ·ï¸ LoadAnswers: Header updated', { header: data.header });
      }

      // æ–°ç€é€šçŸ¥ãƒã‚§ãƒƒã‚¯
      await this.loader.checkForNewContent(data);

      this.populateClassFilter(this.answers);
      this.renderAnswers();

      console.log('âœ… LoadAnswers Complete', {
        answersCount: this.answers.length,
        classFiltersPopulated: !!classFilter?.options?.length,
        timestamp: new Date().toISOString()
      });

    } catch (error) {
      console.error('âŒ LoadAnswers Error', {
        error: error.message || error,
        sortOrder,
        userId: this.userId,
        timestamp: new Date().toISOString()
      });
      this.showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      this.isLoading = false;
      this.showLoading(false);
      console.log('ğŸ LoadAnswers: Finished loading process');
    }
  }

  // å›ç­”ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  renderAnswers() {
    const container = DOMHelpers.safeGetById('answers');
    if (!container) return;

    // å›ç­”æ•°è¡¨ç¤ºæ›´æ–°
    this.updateAnswerCount(this.answers.length);

    if (this.answers.length === 0) {
      container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    // Answer card generation
    const fragment = document.createDocumentFragment();
    this.answers.forEach(answer => {
      const card = this.createAnswerCard(answer);
      fragment.appendChild(card);
    });

    container.innerHTML = '';
    container.appendChild(fragment);
  }

  // Answer card creation (sample file specification)
  createAnswerCard(data) {
    const card = document.createElement('div');
    card.className = 'answer-card glass-panel rounded-xl p-4 flex flex-col justify-between shadow-lg border-2 border-cyan-400/80 cursor-pointer';
    card.setAttribute('tabindex', '0');
    card.setAttribute('role', 'button');

    const instructionId = 'instruction-' + data.rowIndex;
    card.setAttribute('aria-describedby', instructionId);

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆçŠ¶æ…‹ã®é©ç”¨
    if (data.highlight) {
      card.classList.add('highlighted');
    }

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç·æ•°ã«åŸºã¥ããƒœãƒ¼ãƒ€ãƒ¼è¨­å®š
    const totalReactions = this.reactionTypes.reduce((sum, rt) =>
      sum + ((data.reactions && data.reactions[rt.key]) ? data.reactions[rt.key].count : 0), 0);

    if (totalReactions >= 10) {
      card.classList.add('reaction-border-3');
    } else if (totalReactions >= 5) {
      card.classList.add('reaction-border-2');
    } else if (totalReactions > 0) {
      card.classList.add('reaction-border-1');
    }

    let highlightBtnHtml = '';
    // Generate button only when highlight toggle is enabled and admin mode is ON
    if (this.appConfig.showHighlightToggle && this.adminMode && this.showAdminFeatures) {
      const cls = data.highlight ? 'liked' : '';
      const highlightAriaLabel = data.highlight ? 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤ã™ã‚‹' : 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹';
      highlightBtnHtml = '<button type="button" class="highlight-btn like-btn text-yellow-400 ' + cls + '" aria-label="' + highlightAriaLabel + '" aria-pressed="' + data.highlight + '" data-row-index="' + data.rowIndex + '">' +
                         this.getIcon('star', 'w-5 h-5', true) +
                         '</button>';
    }

    // Name display - when admin mode ON with admin privileges, or when named in settings
    const showName = (this.adminMode && this.showAdminFeatures) || this.appConfig.displayMode === 'named';
    const nameHtml = showName ? '<div><span class="font-bold text-sm text-gray-200">' + this.escapeHtml(data.name) + '</span></div>' : '';
    const containerClass = nameHtml ? 'text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex justify-between items-center' : 'text-xs text-gray-400 pt-3 border-t-2 border-cyan-400/80 border-dashed flex justify-end items-center';

    // Generate reaction button HTML (accessibility enhanced)
    const reactionButtonsHtml = this.reactionTypes.map(rt => {
      const info = data.reactions ? data.reactions[rt.key] : { count: 0, reacted: false };
      const cls = info.reacted ? 'liked' : '';
      const colorClass = rt.key === 'LIKE' ? 'text-red-500' : rt.key === 'UNDERSTAND' ? 'text-yellow-500' : 'text-green-500';

      // Display count only when showCounts is true
      const countSpan = this.appConfig.showCounts ? '<span class="reaction-count font-bold text-lg text-gray-200" aria-hidden="true">' + (info.count || 0) + '</span>' : '';

      // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚ã®aria-label
      const reactionNames = {
        'LIKE': 'ã„ã„ã­',
        'UNDERSTAND': 'ãªã‚‹ã»ã©',
        'CURIOUS': 'æ°—ã«ãªã‚‹'
      };
      const reactionName = reactionNames[rt.key] || rt.key;
      const ariaLabel = `${reactionName}${info.reacted ? 'ã‚’å–ã‚Šæ¶ˆã™' : 'ã™ã‚‹'}${this.appConfig.showCounts ? ` (ç¾åœ¨${info.count || 0}ä»¶)` : ''}`;

      return '<button type="button" class="reaction-btn like-btn flex items-center gap-1 ' + colorClass + ' ' + cls + '" data-row-index="' + data.rowIndex + '" data-reaction="' + rt.key + '" aria-label="' + ariaLabel + '" aria-pressed="' + info.reacted + '">' +
               this.getIcon(rt.icon, 'w-5 h-5', info.reacted) +
               countSpan +
               '</button>';
    }).join('');

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆçŠ¶æ…‹ã‚’éš ã‚ŒãŸè¦ç´ ã§é€šçŸ¥ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ï¼‰
    const highlightStatusHtml = data.highlight ?
      '<div id="highlight-status-' + data.rowIndex + '" class="sr-only">ã“ã®å›ç­”ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¦ã„ã¾ã™</div>' : '';
    // è©³ç´°è¡¨ç¤ºã®ãƒ’ãƒ³ãƒˆã‚’éš ã‚ŒãŸè¦ç´ ã§æä¾›
    const instructionHtml = '<div id="' + instructionId + '" class="sr-only">Enter ã¾ãŸã¯ Space ã§è©³ç´°è¡¨ç¤º</div>';

    card.innerHTML =
      '<div class="relative flex-grow mb-3 answer-preview">' +
      '<h3 class="opinion-text text-cyan-200 whitespace-pre-wrap break-words text-xl md:text-2xl font-semibold leading-tight">' +
      this.escapeHtml(data.opinion || '') + '</h3>' +
      '<p class="text-gray-100 whitespace-pre-wrap break-words mt-4">' +
      this.escapeHtml(data.reason || '') + '</p>' +
      '</div>' +
      '<div class="' + containerClass + '">' +
      nameHtml + // å­¦ç”Ÿåï¼ˆç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
      '<div class="flex items-center gap-1" role="group" aria-label="å›ç­”ã¸ã®åå¿œ">' +
      reactionButtonsHtml + // Reaction button group
      highlightBtnHtml + // Highlight button (admin mode only)
      '</div>' +
      '</div>' +
      highlightStatusHtml + // ãƒã‚¤ãƒ©ã‚¤ãƒˆçŠ¶æ…‹é€šçŸ¥
      instructionHtml; // è©³ç´°è¡¨ç¤ºãƒ’ãƒ³ãƒˆ

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒãƒƒã‚¸ã‚’å‹•çš„ã«è¿½åŠ 
    if (data.highlight) {
      const badge = document.createElement('span');
      badge.className = 'highlight-badge';
      badge.innerHTML = this.getIcon('star', '', true);
      card.appendChild(badge);
    }

    // Card click event listeners are handled in setupEventDelegation() so not needed here
    // Remove individual event listener additions to improve performance

    // ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ setupEventDelegation() ã«ç§»è¡Œæ¸ˆã¿:
    // - Reaction button click handling
    // - Highlight button click handling
    // - Card body click handling (modal display)

    return card;
  }


  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  showModal(answer) {
    const modalContainer = DOMHelpers.safeGetById('answerModalContainer');
    const modalCard = DOMHelpers.safeGetById('answerModalCard');
    const modalAnswer = DOMHelpers.safeGetById('modalAnswer');
    const modalStudentName = DOMHelpers.safeGetById('modalStudentName');
    const modalReactions = DOMHelpers.safeGetById('modalReactions');

    if (!modalContainer || !modalCard || !modalAnswer) return;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å®¹è¨­å®š
    const showName = this.appConfig.showDetails !== false;
    modalAnswer.innerHTML = `
      <div class="space-y-4">
        <div>
          <h2 class="text-2xl font-bold text-cyan-200 mb-4">${this.escapeHtml(answer.opinion || '')}</h2>
          <div class="text-gray-200 text-lg leading-relaxed whitespace-pre-wrap">${this.escapeHtml(answer.reason || '')}</div>
        </div>
      </div>
    `;

    if (modalStudentName) {
      modalStudentName.textContent = showName ? (answer.name || '') : '';
    }

    if (modalReactions) {
      modalReactions.innerHTML = this.createReactionButtons(answer);
    }

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆè£…é£¾ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚‚é©ç”¨
    if (answer.highlight) {
      modalCard.classList.add('highlighted');
    } else {
      modalCard.classList.remove('highlighted');
    }

    this.addReactionDecorations(modalCard, answer.reactions);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    modalContainer.classList.remove('hidden');
    modalContainer.classList.add('modal-fade');
    modalCard.classList.add('modal-scale');

    setTimeout(() => {
      modalContainer.style.opacity = CONFIG.MODAL_OPACITY_VISIBLE;
      modalCard.style.transform = `scale(${CONFIG.MODAL_SCALE_NORMAL})`;
    }, 10);
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
  closeModal() {
    const modalContainer = DOMHelpers.safeGetById('answerModalContainer');
    const modalCard = DOMHelpers.safeGetById('answerModalCard');

    if (modalContainer && modalCard) {
      modalContainer.style.opacity = CONFIG.MODAL_OPACITY_HIDDEN;
      modalCard.style.transform = `scale(${CONFIG.MODAL_SCALE_SMALL})`;

      setTimeout(() => {
        modalContainer.classList.add('hidden');
        modalCard.classList.remove('highlighted', 'reaction-bg-like', 'reaction-bg-understand', 'reaction-bg-curious', 'reaction-border-1', 'reaction-border-2', 'reaction-border-3');
        modalCard.style.borderImage = '';
        modalCard.style.borderWidth = '';
      }, 300);
    }
  }

  // Class filter generation
  populateClassFilter(answers) {
    const classFilter = DOMHelpers.safeGetById('classFilter');
    if (!classFilter) return;

    const classes = [...new Set(answers.map(a => a.class).filter(Boolean))];

    if (classes.length > 0) {
      classFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¹</option>' +
        classes.map(cls => `<option value="${this.escapeHtml(cls)}">${this.escapeHtml(cls)}</option>`).join('');
      classFilter.classList.remove('hidden');
    }
  }

  // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
  startPolling() {
    if (this.pollingInterval) {
      clearInterval(this.pollingInterval);
    }
    this.pollingInterval = setInterval(() => {
      if (!this.isLoading) {
        this.loadAnswers(this.currentSort);
      }
    }, CONFIG.POLLING_INTERVAL);
  }

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¡ã‚½ãƒƒãƒ‰
  updateAnswerCount(count) {
    const answerCount = DOMHelpers.safeGetById('answerCount');
    const answerCountText = DOMHelpers.safeGetById('answerCountText');

    if (answerCountText) {
      answerCountText.textContent = `${count} ä»¶ã®å›ç­”`;
    }
  }

  updateGridSize(size) {
    const container = DOMHelpers.safeGetById('answers');
    if (container) {
      container.className = `grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-${Math.min(size, CONFIG.MAX_DISPLAY_COLUMNS)}`;
    }
  }

  showLoading(show) {
    const headingLabel = DOMHelpers.safeGetById('headingLabel');
    if (headingLabel) {
      if (show) {
        headingLabel.innerHTML = `
          <svg class="w-5 h-5 md:w-6 md:h-6 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
          </svg>
        `;
      }
    }
  }

  showError(message) {
    const container = DOMHelpers.safeGetById('answers');
    if (container) {
      container.innerHTML = `<div class="col-span-full text-center text-red-400 py-8">${this.escapeHtml(message)}</div>`;
    }

    // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã§ã‚‚ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    if (window.notifications) {
      window.notifications.error(message);
    }
  }

  escapeHtml(str) {
    if (!str) return '';
    return str.toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // ã‚¢ã‚¤ã‚³ãƒ³å–å¾—ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆè¦‹æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã¨å®Œå…¨äº’æ›ï¼‰
  getIcon(name, classes = '', solid = false) {
    // ã‚¢ã‚¤ã‚³ãƒ³ã‚­ãƒ¼ã®å„ªå…ˆé †ä½: solidç‰ˆ > outlineç‰ˆ > ãƒ—ãƒ¬ãƒ¼ãƒ³ç‰ˆ
    let key;
    if (solid && ICONS[name + '-solid']) {
      key = name + '-solid';
    } else if (ICONS[name + '-outline']) {
      key = name + '-outline';
    } else if (ICONS[name]) {
      key = name;
    } else {
      console.warn('Icon not found:', name);
      return '<span aria-hidden="true" class="' + classes + '">â­</span>'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    }
    // å­˜åœ¨ã™ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿”ã™
    return '<span aria-hidden="true" class="' + classes + '">' + ICONS[key] + '</span>';
  }
}

// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
document.addEventListener('click', async (e) => {
  // Reaction button click
  if (e.target.closest('.reaction-btn')) {
    e.preventDefault();
    const btn = e.target.closest('.reaction-btn');
    const type = btn.dataset.reaction;
    const rowIndex = btn.dataset.rowIndex;

    console.log('ğŸ‘† Reaction Click', {
      type,
      rowIndex,
      userEmail: window.answerApp?.userEmail,
      hasAuth: !!window.answerApp?.userEmail,
      timestamp: new Date().toISOString()
    });

    if (!window.answerApp || !window.answerApp.userEmail) {
      console.warn('âŒ Reaction: No authentication', {
        hasApp: !!window.answerApp,
        hasEmail: !!window.answerApp?.userEmail
      });
      if (window.notifications) {
        window.notifications.error('èªè¨¼ãŒå¿…è¦ã§ã™');
      }
      return;
    }

    try {
      btn.classList.add('loading');
      console.log('â³ Reaction: Starting API call', {
        type,
        rowIndex: parseInt(rowIndex),
        userEmail: window.answerApp.userEmail
      });

      // ç¾åœ¨ã®GASé–¢æ•°ã‚’ä½¿ç”¨
      const result = await window.answerApp.loader.callGAS('addReaction', window.answerApp.userEmail, parseInt(rowIndex), type);

      console.log('ğŸ¯ Reaction: API result', {
        success: result?.success,
        type,
        rowIndex,
        result
      });

      // Data reload
      await window.answerApp.loadAnswers(window.answerApp.currentSort);

      if (window.notifications) {
        window.notifications.success('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      }
      console.log('âœ… Reaction: Complete', { type, rowIndex });
    } catch (error) {
      console.error('âŒ Reaction Error', {
        error: error.message || error,
        type,
        rowIndex,
        userEmail: window.answerApp.userEmail,
        timestamp: new Date().toISOString()
      });
      if (window.notifications) {
        window.notifications.error('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } finally {
      btn.classList.remove('loading');
      console.log('ğŸ Reaction: Cleanup complete', { type, rowIndex });
    }
  }

  // Highlight button click
  if (e.target.closest('.highlight-btn')) {
    e.preventDefault();
    const btn = e.target.closest('.highlight-btn');
    const rowIndex = btn.dataset.rowIndex;

    console.log('ğŸŒŸ Highlight Click', {
      rowIndex,
      hasAdminFeatures: !!window.answerApp?.showAdminFeatures,
      adminMode: window.answerApp?.adminMode,
      timestamp: new Date().toISOString()
    });

    if (!window.answerApp || !window.answerApp.showAdminFeatures) {
      console.warn('âŒ Highlight: No admin privileges', {
        hasApp: !!window.answerApp,
        hasAdminFeatures: !!window.answerApp?.showAdminFeatures
      });
      return;
    }

    try {
      btn.classList.add('loading');
      console.log('â³ Highlight: Starting API call', {
        rowIndex: parseInt(rowIndex),
        userEmail: window.answerApp.userEmail
      });

      // ç¾åœ¨ã®GASé–¢æ•°ã‚’ä½¿ç”¨ï¼ˆtoggleHighlighté–¢æ•°ã‚’ç¢ºèªï¼‰
      const result = await window.answerApp.loader.callGAS('toggleHighlight', window.answerApp.userEmail, parseInt(rowIndex));

      console.log('ğŸ¯ Highlight: API result', {
        success: result?.success,
        rowIndex,
        result
      });

      // Data reload
      await window.answerApp.loadAnswers(window.answerApp.currentSort);

      if (window.notifications) {
        window.notifications.success('ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
      }
      console.log('âœ… Highlight: Complete', { rowIndex });
    } catch (error) {
      console.error('âŒ Highlight Error', {
        error: error.message || error,
        rowIndex,
        userEmail: window.answerApp.userEmail,
        timestamp: new Date().toISOString()
      });
      if (window.notifications) {
        window.notifications.error('ãƒã‚¤ãƒ©ã‚¤ãƒˆã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } finally {
      btn.classList.remove('loading');
      console.log('ğŸ Highlight: Cleanup complete', { rowIndex });
    }
  }
});

// === f0068fa Advanced Initialization System ===

// ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼ã¨ãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡º
async function initializeAdvancedFeatures() {
  console.log('ğŸš€ InitializeAdvancedFeatures Start', {
    hasApp: !!window.answerApp,
    hasLoader: !!window.answerApp?.loader,
    timestamp: new Date().toISOString()
  });

  try {
    // ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼ãƒã‚§ãƒƒã‚¯
    console.log('ğŸ” Starting domain auth check');
    const domainAuthResult = await window.answerApp.loader.checkDomainAuth();
    console.log('ğŸ” Domain auth result', domainAuthResult);
    updateDomainAuthDisplay(domainAuthResult);

    // ãƒ•ã‚©ãƒ¼ãƒ URLæ¤œå‡º
    console.log('ğŸ“ Starting form URL detection');
    const formResult = await window.answerApp.loader.detectFormUrl();
    console.log('ğŸ“ Form detection result', formResult);
    updateFormLinkDisplay(formResult);

    // æ–°ç€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒã‚§ãƒƒã‚¯é–‹å§‹
    console.log('ğŸ”„ Starting new content polling');
    startNewContentPolling();

    console.log('âœ… InitializeAdvancedFeatures Complete');
  } catch (error) {
    console.error('âŒ Advanced features initialization failed', {
      error: error.message || error,
      timestamp: new Date().toISOString()
    });
  }
}

// ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼è¡¨ç¤ºæ›´æ–°
function updateDomainAuthDisplay(result) {
  const initialEl = document.getElementById('header-domain-initial');
  const matchEl = document.getElementById('header-domain-match');
  const mismatchEl = document.getElementById('header-domain-mismatch');

  if (!result.success) {
    console.warn('Domain auth check failed');
    return;
  }

  // åˆæœŸçŠ¶æ…‹ã‚’éš ã™
  if (initialEl) initialEl.classList.add('hidden');

  // æœ€é©åŒ–ã•ã‚ŒãŸcheckDomainAuthé–¢æ•°ã®æˆ»ã‚Šå€¤ã«å¯¾å¿œ
  if (result.authenticated) {
    if (matchEl) {
      matchEl.classList.remove('hidden');
      const textEl = document.getElementById('header-domain-match-text');
      if (textEl) textEl.textContent = 'èªè¨¼æ¸ˆã¿';
    }
    // éèªè¨¼ã‚¢ã‚¯ã‚»ã‚¹ã®è¡¨ç¤ºã¯ä¸è¦ï¼ˆèªè¨¼æ¸ˆã¿ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰
    if (mismatchEl) mismatchEl.classList.add('hidden');
  } else {
    // Display nothing for unauthenticated users
    if (matchEl) matchEl.classList.add('hidden');
    if (mismatchEl) mismatchEl.classList.add('hidden');
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯è¡¨ç¤ºæ›´æ–°
function updateFormLinkDisplay(result) {
  const formLinkBtn = document.getElementById('form-link-btn');

  if (result.success && result.formUrl) {
    if (formLinkBtn) {
      formLinkBtn.href = result.formUrl;
      formLinkBtn.classList.remove('hidden');

      // Update display if form title exists
      if (result.formTitle) {
        const titleSpan = formLinkBtn.querySelector('span');
        if (titleSpan) {
          titleSpan.textContent = `ğŸ“ ${result.formTitle}`;
        }
      }
    }
  }
}

// æ–°ç€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
function startNewContentPolling() {
  // åˆå›ãƒã‚§ãƒƒã‚¯
  setTimeout(() => {
    if (window.answerApp && window.answerApp.loader) {
      window.answerApp.loader.checkForUpdates();
    }
  }, 30000); // 30ç§’å¾Œã«åˆå›ãƒã‚§ãƒƒã‚¯

  // å®šæœŸçš„ãƒã‚§ãƒƒã‚¯ï¼ˆ3åˆ†é–“éš”ï¼‰
  setInterval(() => {
    if (window.answerApp && window.answerApp.loader) {
      window.answerApp.loader.checkForUpdates();
    }
  }, 180000);
}

// New content banner event listeners
document.addEventListener('click', (e) => {
  // Update and display button
  if (e.target.id === 'refreshContentBtn') {
    e.preventDefault();
    if (window.answerApp) {
      window.answerApp.loadAnswers(window.answerApp.currentSort);
    }
    const banner = document.getElementById('newContentBanner');
    if (banner) banner.classList.remove('show');
  }

  // Close notification button
  if (e.target.id === 'dismissBannerBtn') {
    e.preventDefault();
    const banner = document.getElementById('newContentBanner');
    if (banner) banner.classList.remove('show');
  }
});

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
document.addEventListener('DOMContentLoaded', () => {
  window.answerApp = new AnswerApp();

  // Initialize advanced features with lazy loading (after UI load)
  setTimeout(() => {
    initializeAdvancedFeatures();
  }, 2000);
});

</script>