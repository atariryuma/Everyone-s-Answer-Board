<!DOCTYPE html>
<html lang="ja">
<head>
    <base target="_top">
    <title>公開終了</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-800 text-white flex items-center justify-center h-screen">
    <div class="text-center p-4">
        <h1 class="text-4xl font-bold mb-4">現在は公開されていません</h1>
        <p class="text-gray-400">先生がアプリの公開を始めたら、また見てみましょう。</p>
        
        <!-- ★管理者用パネル（管理者にのみ表示） -->
        <div id="admin-panel" class="hidden mt-12 p-6 bg-gray-700 rounded-xl max-w-sm mx-auto shadow-lg border border-gray-600">
            <h2 class="text-lg font-bold mb-4 text-yellow-300">管理者用パネル</h2>
            <p class="text-sm text-gray-300 mb-4">表示するシートを選択して公開してください。</p>
            <div class="flex flex-col gap-4">
                <select id="sheet-selector" class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-white focus:ring-2 focus:ring-yellow-400 focus:outline-none">
                    <option>シートを読み込み中...</option>
                </select>
                <input id="admin-emails" type="text" placeholder="admin@example.com" class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-white" />
                <select id="display-mode" class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-white">
                    <option value="anonymous">匿名表示</option>
                    <option value="named">実名表示</option>
                </select>
                <label class="text-left text-sm flex items-center gap-2">
                    <input id="reaction-toggle" type="checkbox" class="accent-yellow-500" />
                    <span>リアクション数を表示</span>
                </label>
                <label class="text-left text-sm flex items-center gap-2">
                    <input id="score-sort-toggle" type="checkbox" class="accent-yellow-500" />
                    <span>スコア順ソートを有効化</span>
                </label>
                <input id="deploy-id" type="text" placeholder="Deploy ID" class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-white" />
                <button id="publish-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded transition disabled:opacity-50">
                    このシートで公開する
                </button>
                <button id="open-admin-btn" class="w-full bg-green-500 hover:bg-green-600 text-gray-900 font-bold py-2 px-4 rounded transition">
                    ボードを開く
                </button>
            </div>
            <p id="message-area" class="mt-4 text-sm h-5"></p>
        </div>
        
        <!-- ★非管理者用メッセージ -->
        <div id="non-admin-message" class="hidden mt-8 p-4 bg-gray-700 rounded-xl max-w-sm mx-auto shadow-lg border border-gray-600">
            <p class="text-gray-300 text-sm">アプリが公開されるまでお待ちください。</p>
        </div>
    </div>

    <script>
        const userEmail = "<?= userEmail ?>";
        const isAdmin = <?= isAdmin ? 'true' : 'false' ?>;
        const adminPanel = document.getElementById('admin-panel');
        const nonAdminMessage = document.getElementById('non-admin-message');

        // ★修正: 管理者権限に基づいて表示を制御
        if (isAdmin) {
            // 管理者の場合: 管理パネルを表示
            adminPanel.classList.remove('hidden');

            const sheetSelector = document.getElementById('sheet-selector');
            const publishBtn = document.getElementById('publish-btn');
            const messageArea = document.getElementById('message-area');
            const adminEmailsInput = document.getElementById('admin-emails');
            const displayModeSelect = document.getElementById('display-mode');
            const reactionToggle = document.getElementById('reaction-toggle');
            const scoreSortToggle = document.getElementById('score-sort-toggle');
            const deployIdInput = document.getElementById('deploy-id');

            // シートリストを取得してプルダウンを生成
            google.script.run
                .withSuccessHandler(populateSheets)
                .withFailureHandler(showError)
                .getSheets();

            // 現在の設定を取得
            google.script.run
                .withSuccessHandler(populateSettings)
                .withFailureHandler(showError)
                .getAdminSettings();

            function populateSheets(sheetNames) {
                sheetSelector.innerHTML = '<option value="">-- シートを選択してください --</option>';
                if (sheetNames && sheetNames.length > 0) {
                    sheetNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        sheetSelector.appendChild(option);
                    });
                } else {
                    sheetSelector.innerHTML = '<option>表示できるシートがありません</option>';
                    publishBtn.disabled = true;
                }
            }

            function showError(error) {
                messageArea.textContent = `エラー: ${error.message}`;
                messageArea.className = 'mt-4 text-sm h-5 text-red-400';
            }

            function showMessage(msg) {
                messageArea.textContent = msg;
                messageArea.className = 'mt-4 text-sm h-5 text-green-400';
            }

            function populateSettings(settings) {
                adminEmailsInput.value = (settings.adminEmails || []).join(',');
                displayModeSelect.value = settings.displayMode || 'anonymous';
                reactionToggle.checked = settings.reactionCountEnabled || false;
                scoreSortToggle.checked = settings.scoreSortEnabled || false;
                deployIdInput.value = settings.deployId || '';
            }

            publishBtn.addEventListener('click', () => {
                const selectedSheet = sheetSelector.value;
                if (!selectedSheet) {
                    messageArea.textContent = 'シートを選択してください。';
                    messageArea.className = 'mt-4 text-sm h-5 text-yellow-300';
                    return;
                }
                
                publishBtn.disabled = true;
                publishBtn.textContent = '公開処理中...';
                messageArea.textContent = '';

                google.script.run
                    .withSuccessHandler(onPublishSuccess)
                    .withFailureHandler(onPublishError)
                    .publishApp(selectedSheet);
            });

            function onPublishSuccess(message) {
                messageArea.textContent = message;
                messageArea.className = 'mt-4 text-sm h-5 text-green-400';
                publishBtn.disabled = false;
                publishBtn.textContent = 'このシートで公開する';
            }

            function onPublishError(error) {
                showError(error);
                publishBtn.disabled = false;
                publishBtn.textContent = 'このシートで公開する';
            }

            // ★管理者メールアドレス設定
            adminEmailsInput.addEventListener('change', () => {
                google.script.run
                    .withSuccessHandler(showMessage)
                    .withFailureHandler(showError)
                    .saveAdminEmails(adminEmailsInput.value);
            });

            // ★表示モード設定
            displayModeSelect.addEventListener('change', () => {
                google.script.run
                    .withSuccessHandler(showMessage)
                    .withFailureHandler(showError)
                    .saveDisplayMode(displayModeSelect.value);
            });

            // ★リアクション数表示設定
            reactionToggle.addEventListener('change', () => {
                google.script.run
                    .withSuccessHandler(showMessage)
                    .withFailureHandler(showError)
                    .saveReactionCountSetting(reactionToggle.checked);
            });

            // ★スコア順ソート設定（新規追加）
            scoreSortToggle.addEventListener('change', () => {
                google.script.run
                    .withSuccessHandler(showMessage)
                    .withFailureHandler(showError)
                    .saveScoreSortSetting(scoreSortToggle.checked);
            });

            // ★デプロイID設定
            deployIdInput.addEventListener('change', () => {
                google.script.run
                    .withSuccessHandler(showMessage)
                    .withFailureHandler(showError)
                    .saveDeployId(deployIdInput.value);
            });

            // ★管理者ボード表示ボタン
            document.getElementById('open-admin-btn').addEventListener('click', () => {
                window.top.location.href = '?view=board&mode=admin';
            });
        } else {
            // ★非管理者の場合: 簡潔なメッセージのみ表示
            nonAdminMessage.classList.remove('hidden');
        }
    </script>
</body>
</html>
