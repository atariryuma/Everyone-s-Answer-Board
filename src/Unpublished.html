<!doctype html>
<html lang="ja">
  <head>
    <base target="_top" />
    <title>ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰ - æœªå…¬é–‹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Shared Security Headers -->
    <?!= include('SharedSecurityHeaders'); ?>

    <!-- TailwindCSS Optimized Loading - highest priority, no warnings -->
    <script>
      window.__TAILWIND_DISABLE_TOUCH__ = true;
      window.tailwind = {
        config: {
          corePlugins: { preflight: false },
          important: true,
        },
      };

      if (!window.__WARN_SUPPRESSION_INITIALIZED__) {
        const originalWarnUnpub = console.warn;
        console.warn = function (...args) {
          const message = args.join(' ');
          if (
            message.includes('cdn.tailwindcss.com should not be used in production') ||
            message.includes('cdnjs.cloudflare.com') ||
            message.includes('tailwind') ||
            message.includes('TailwindCSS')
          ) {
            return; // Completely suppress
          }
          originalWarnUnpub.apply(console, args);
        };
        window.__WARN_SUPPRESSION_INITIALIZED__ = true;
      }
    </script>
    <!-- Shared TailwindCSS Configuration -->
    <?!= include('SharedTailwindConfig'); ?>

    <!-- Unified Styles and Shared Components -->
    <?!= include('UnifiedStyles.css'); ?>
    <style>
      body {
        margin: 0;
      }
      .glass-panel {
        background: rgba(26, 27, 38, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
    </style>
  </head>
  <body style="background: var(--brand-background); color: var(--brand-text);" class="font-sans flex items-center justify-center h-screen">
    <!-- Loading Overlay for UnifiedLoadingManager -->
    <div id="loading-overlay" class="loading-overlay page-specific hidden">
      <div
        class="global-spinner"
      ></div>
    </div>

    <!-- Notification Container for unified notification system -->
    <div id="notification-container" class="fixed top-4 right-4 z-[10000] space-y-2"></div>
    <div class="w-full max-w-2xl mx-auto px-4 py-8">
      <? if (typeof isEditor !== 'undefined' && isEditor) { ?>
      <!-- ç·¨é›†è€…ç”¨: å†å…¬é–‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="glass-panel rounded-xl p-6 md:p-8 shadow-2xl">
        <h1 class="text-2xl md:text-3xl font-bold mb-3 text-yellow-300">å›ç­”ãƒœãƒ¼ãƒ‰ç®¡ç†</h1>
        <p class="text-gray-400 mb-5">å›ç­”ãƒœãƒ¼ãƒ‰ã¯ç¾åœ¨éå…¬é–‹çŠ¶æ…‹ã§ã™</p>

        <? if (typeof editorName !== 'undefined' && editorName) { ?>
        <p class="text-xs text-gray-500 mb-4">ç®¡ç†è€…: <?= editorName ?></p>
        <? } ?>

        <!-- ç”Ÿå¾’ç”¨URLè¡¨ç¤º -->
        <div class="mb-6 p-4 bg-gray-700 rounded-lg">
          <p class="text-sm text-gray-400 mb-2">ç”Ÿå¾’ç”¨URL:</p>
          <div class="flex gap-2">
            <input
              type="text"
              id="board-url"
              readonly
              value="<?= typeof boardUrl !== 'undefined' ? boardUrl : '' ?>"
              class="flex-1 p-2 bg-gray-600 border border-gray-500 rounded text-sm cursor-pointer hover:bg-gray-500"
              onclick="this.select()"
              aria-label="ç”Ÿå¾’ç”¨URL"
              title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦URLã‚’é¸æŠ"
            />
            <button
              type="button"
              onclick="copyBoardUrl()"
              class="px-3 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-sm"
            >
              ã‚³ãƒ”ãƒ¼
            </button>
          </div>
        </div>

        <!-- å†å…¬é–‹ãƒœã‚¿ãƒ³ -->
        <button
          type="button"
          id="republish-btn"
          onclick="republishBoard()"
          class="w-full px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-semibold text-base transition-all transform hover:scale-105 shadow-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 focus:ring-offset-gray-800"
        >
          <span role="img" aria-label="å…¬é–‹">ğŸŒŸ</span> å›ç­”ãƒœãƒ¼ãƒ‰ã‚’å†å…¬é–‹
        </button>

        <!-- ç®¡ç†ãƒ‘ãƒãƒ«é·ç§»ãƒœã‚¿ãƒ³ -->
        <button
          type="button"
          id="admin-panel-btn"
          onclick="openAdminPanel()"
          class="w-full mt-3 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg font-medium text-base transition-all shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800"
        >
          <span role="img" aria-label="è¨­å®š">âš™ï¸</span> ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã
        </button>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
        <div
          id="message-area"
          class="mt-4 text-center text-sm h-5"
          aria-live="polite"
          role="status"
        ></div>
      </div>
      <? } else { ?>
      <!-- é–²è¦§è€…ç”¨: æº–å‚™ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div class="glass-panel rounded-xl p-8 shadow-2xl">
        <h1 class="text-4xl font-bold mb-4 text-yellow-300">ç¾åœ¨ã¯æº–å‚™ä¸­ã§ã™</h1>
        <p class="text-gray-400 mb-4">å…ˆç”ŸãŒå›ç­”ãƒœãƒ¼ãƒ‰ã‚’è¨­å®šä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>

        <? if (typeof editorName !== 'undefined' && editorName) { ?>
        <p class="text-xs text-gray-500 mb-4">ç®¡ç†è€…: <?= editorName ?></p>
        <? } ?>

        <div class="mt-6">
          <button
            type="button"
            onclick="window.safeReload()"
            class="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 rounded-lg font-semibold"
          >
            æ›´æ–°
          </button>
        </div>
      </div>
      <? } ?>
    </div>

    <!-- GASæ¨å¥¨: JavaScriptèª­ã¿è¾¼ã¿ã¯</body>ç›´å‰ã«é›†ç´„ -->
    <?!= include('SharedUtilities'); ?>
    <?!= include('SharedErrorHandling'); ?>

    <script>
      function copyBoardUrl() {
        const urlInput = document.getElementById('board-url');
        if (urlInput) {
          try {
            if (navigator.clipboard && window.isSecureContext) {
              navigator.clipboard.writeText(urlInput.value);
            } else {
              urlInput.select();
              document.execCommand('copy');
            }
            showMessage('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
          } catch (error) {
            showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        }
      }

      function showMessage(message, type = 'info') {
        if (window.notifications) {
          const durations = { success: 4000, error: 7000, warning: 6000, info: 5000 };
          window.notifications.showMessage(message, type, durations[type] || 5000);
        } else {
          console.warn('Notification system not available:', type, message);
        }
      }

      function republishBoard() {
        const button = document.getElementById('republish-btn');
        if (!button) return;

        const originalContent = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span role="img" aria-label="èª­ã¿è¾¼ã¿ä¸­">â³</span> å†å…¬é–‹ä¸­...';

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              showMessage('å›ç­”ãƒœãƒ¼ãƒ‰ã‚’å†å…¬é–‹ã—ã¾ã—ãŸï¼', 'success');

              google.script.history.replace(null, {}, window.location.href);
            } else {
              showMessage(result.message || 'å†å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
              button.disabled = false;
              button.innerHTML = originalContent;
            }
          })
          .withFailureHandler(function(error) {
            showMessage('å†å…¬é–‹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || error), 'error');
            button.disabled = false;
            button.innerHTML = originalContent;
          })
          .republishMyBoard();
      }

      function openAdminPanel() {
        const button = document.getElementById('admin-panel-btn');
        if (!button) return;

        const originalContent = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span role="img" aria-label="èª­ã¿è¾¼ã¿ä¸­">â³</span> èª­ã¿è¾¼ã¿ä¸­...';

        google.script.run
          .withSuccessHandler(function(webAppUrl) {
            if (webAppUrl) {
              const userId = '<?= typeof userId !== "undefined" ? userId : "" ?>';
              const adminUrl = webAppUrl + '?mode=admin&userId=' + userId;
              window.open(adminUrl, '_top');
            } else {
              showMessage('ç®¡ç†ãƒ‘ãƒãƒ«URLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
              button.disabled = false;
              button.innerHTML = originalContent;
            }
          })
          .withFailureHandler(function(error) {
            showMessage('ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: ' + (error.message || error), 'error');
            button.disabled = false;
            button.innerHTML = originalContent;
          })
          .getWebAppUrl();
      }
    </script>

  </body>
</html>
