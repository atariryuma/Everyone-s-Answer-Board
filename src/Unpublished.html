<!DOCTYPE html>
<html lang="ja">
<head>
    <base target="_top">
    <title>公開終了</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-800 text-white flex items-center justify-center h-screen">
    <div class="text-center p-4">
        <h1 class="text-4xl font-bold mb-4">現在は公開されていません</h1>
        <p class="text-gray-400">先生がアプリの公開を始めたら、また見てみましょう。</p>
        
        <!-- ★管理者用パネル（条件を満たすユーザーにのみJSで表示） -->
        <div id="admin-panel" class="hidden mt-12 p-6 bg-gray-700 rounded-xl max-w-sm mx-auto shadow-lg border border-gray-600">
            <h2 class="text-lg font-bold mb-4 text-yellow-300">管理者用パネル</h2>
            <p class="text-sm text-gray-300 mb-4">表示するシートを選択して公開してください。</p>
            <div class="flex flex-col gap-4">
                <select id="sheet-selector" class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-white focus:ring-2 focus:ring-yellow-400 focus:outline-none">
                    <option>シートを読み込み中...</option>
                </select>
                <button id="publish-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded transition disabled:opacity-50">
                    このシートで公開する
                </button>
            </div>
            <p id="message-area" class="mt-4 text-sm h-5"></p>
        </div>
    </div>

    <script>
        const userEmail = "<?= userEmail ?>";
        const emailName = userEmail.split('@')[0];

        // メールアドレスのネーム部分に 't' が含まれているかチェック
        if (emailName.includes('t')) {
            const adminPanel = document.getElementById('admin-panel');
            adminPanel.classList.remove('hidden');

            const sheetSelector = document.getElementById('sheet-selector');
            const publishBtn = document.getElementById('publish-btn');
            const messageArea = document.getElementById('message-area');

            // シートリストを取得してプルダウンを生成
            google.script.run
                .withSuccessHandler(populateSheets)
                .withFailureHandler(showError)
                .getSheets();

            function populateSheets(sheetNames) {
                sheetSelector.innerHTML = '<option value="">-- シートを選択してください --</option>';
                if (sheetNames && sheetNames.length > 0) {
                    sheetNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        sheetSelector.appendChild(option);
                    });
                } else {
                    sheetSelector.innerHTML = '<option>表示できるシートがありません</option>';
                    publishBtn.disabled = true;
                }
            }

            function showError(error) {
                messageArea.textContent = `エラー: ${error.message}`;
                messageArea.className = 'mt-4 text-sm h-5 text-red-400';
            }

            publishBtn.addEventListener('click', () => {
                const selectedSheet = sheetSelector.value;
                if (!selectedSheet) {
                    messageArea.textContent = 'シートを選択してください。';
                    messageArea.className = 'mt-4 text-sm h-5 text-yellow-300';
                    return;
                }
                
                publishBtn.disabled = true;
                publishBtn.textContent = '公開処理中...';
                messageArea.textContent = '';

                google.script.run
                    .withSuccessHandler(onPublishSuccess)
                    .withFailureHandler(onPublishError)
                    .publishApp(selectedSheet);
            });

            function onPublishSuccess(message) {
                messageArea.textContent = `${message} ページを更新します...`;
                messageArea.className = 'mt-4 text-sm h-5 text-green-400';
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }

            function onPublishError(error) {
                showError(error);
                publishBtn.disabled = false;
                publishBtn.textContent = 'このシートで公開する';
            }
        }
    </script>
</body>
</html>
