<script>
/**
 * AdminPanel Enterprise Error Handling Module
 * ä¼æ¥­ãƒ¬ãƒ™ãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªã‚«ãƒãƒªæ©Ÿèƒ½
 */

'use strict';

// =============================================================================
// ENTERPRISE ERROR HANDLING
// =============================================================================

window.AdminPanelErrorHandler = (function() {
  'use strict';
  
  let errorHistory = [];
  let criticalErrorCount = 0;
  let lastErrorTime = 0;
  
  /**
   * å¼·åŒ–ã•ã‚ŒãŸã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
   */
  function initializeGlobalErrorHandling() {
    // Window error event handler
    window.addEventListener('error', function(event) {
      handleError(event.error, {
        type: 'javascript_error',
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        message: event.message
      });
    });
    
    // Unhandled promise rejection handler
    window.addEventListener('unhandledrejection', function(event) {
      handleError(event.reason, {
        type: 'promise_rejection',
        promise: event.promise
      });
    });
    
    console.log('âœ… Enterprise Error Handling åˆæœŸåŒ–å®Œäº†');
  }
  
  /**
   * çµ±åˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
   */
  function handleError(error, context = {}) {
    const errorMessage = error?.message || error?.toString() || 'Unknown error';
    const errorStack = error?.stack || '';
    const timestamp = new Date().toISOString();
    
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—
    const securityContext = {
      userId: window.SECURE_URL_USER_ID || 'unknown',
      sessionId: window.MULTI_TENANT_CONTEXT?.sessionId || 'unknown',
      timestamp: timestamp,
      userAgent: navigator.userAgent,
      url: window.location.href
    };
    
    // ã‚¨ãƒ©ãƒ¼åˆ†é¡
    const errorCategory = categorizeError(errorMessage, errorStack);
    
    // ã‚¨ãƒ©ãƒ¼å±¥æ­´ã«è¨˜éŒ²
    recordError({
      message: errorMessage,
      stack: errorStack,
      context: context,
      security: securityContext,
      category: errorCategory,
      timestamp: timestamp
    });
    
    // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®å®Ÿè¡Œ
    if (shouldSuppressError(errorMessage, errorStack)) {
      handleSuppressedError(errorMessage, context);
    } else if (isCriticalError(errorMessage, errorStack)) {
      handleCriticalError(errorMessage, errorStack, context, securityContext);
    } else {
      handleStandardError(errorMessage, context);
    }
    
    // ã‚¨ãƒ©ãƒ¼çµ±è¨ˆã®æ›´æ–°
    updateErrorStatistics(errorCategory);
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼ã®åˆ†é¡
   */
  function categorizeError(message, stack) {
    const categories = {
      SECURITY: ['security', 'violation', 'unauthorized', 'forbidden'],
      NETWORK: ['network', 'fetch', 'ajax', 'connection', 'timeout'],
      VALIDATION: ['validation', 'invalid', 'required', 'format'],
      SYSTEM: ['system', 'internal', 'server', 'database'],
      UI: ['element', 'undefined', 'null', 'not found'],
      SCRIPT: ['script', 'syntax', 'reference', 'type'],
      SUPPRESSED: ['document.write', 'mae_html_user', 'warden_bin', 'tailwindcss']
    };
    
    const fullText = (message + ' ' + stack).toLowerCase();
    
    for (const [category, keywords] of Object.entries(categories)) {
      if (keywords.some(keyword => fullText.includes(keyword))) {
        return category;
      }
    }
    
    return 'UNKNOWN';
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼æŠ‘åˆ¶åˆ¤å®š
   */
  function shouldSuppressError(message, stack) {
    const suppressedPatterns = [
      'document.write',
      'Unexpected token',
      'Failed to execute \'write\' on \'Document\'',
      'SyntaxError: Failed to execute \'write\'',
      'Identifier \'userId\' has already been declared',
      'mae_html_user_bin_i18n_mae_html_user',
      'warden_bin_i18n_warden',
      'unrecognized feature',
      'Unrecognized feature',
      'cdn.tailwindcss.com should not be used in production',
      'tailwindcss.com/docs/installation',
      'should not be used in production',
      'PostCSS plugin',
      'Tailwind CLI',
      'navigateToStep is not defined',
      'hidePrivacyModal is not defined', 
      'updateUIWithNewStatus is not defined',
      'showFormConfigModal is not defined',
      'toggleSection is not defined',
      'function not yet loaded',
      'function not available'
    ];
    
    return suppressedPatterns.some(pattern => 
      message.includes(pattern) || stack.includes(pattern)
    );
  }
  
  /**
   * é‡è¦ã‚¨ãƒ©ãƒ¼åˆ¤å®š
   */
  function isCriticalError(message, stack) {
    const criticalPatterns = [
      'await is only valid in async functions',
      'Cannot set property',
      'Cannot read property',
      'is not defined',
      'is not a function',
      'security',
      'violation',
      'unauthorized'
    ];
    
    return criticalPatterns.some(pattern => 
      message.includes(pattern) || stack.includes(pattern)
    );
  }
  
  /**
   * æŠ‘åˆ¶ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
   */
  function handleSuppressedError(message, context) {
    console.debug('ğŸ”‡ Suppressed Error:', message.substring(0, 100));
    // æŠ‘åˆ¶ã‚¨ãƒ©ãƒ¼ã¯é™ã‹ã«è¨˜éŒ²ã®ã¿
  }
  
  /**
   * é‡è¦ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
   */
  function handleCriticalError(message, stack, context, securityContext) {
    criticalErrorCount++;
    lastErrorTime = Date.now();
    
    console.error('ğŸš¨ Critical Error Detected:', {
      message: message,
      context: context,
      securityContext: securityContext,
      criticalCount: criticalErrorCount
    });
    
    // ä¼æ¥­ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: é‡è¦ã‚¨ãƒ©ãƒ¼ã®ç›£æŸ»ãƒ­ã‚°
    if (window.MULTI_TENANT_CONTEXT?.securityLevel === 'ENTERPRISE') {
      logSecurityIncident('CRITICAL_FRONTEND_ERROR', {
        errorMessage: message.substring(0, 200), // æ©Ÿå¯†æƒ…å ±æ¼æ´©é˜²æ­¢
        userId: securityContext.userId,
        sessionId: securityContext.sessionId,
        timestamp: securityContext.timestamp,
        criticalCount: criticalErrorCount
      });
    }
    
    // ã‚¨ãƒ©ãƒ¼ç›£è¦–ãƒ‘ãƒãƒ«ã¸ã®é€šçŸ¥
    if (window.AdminPanelMonitoring) {
      window.AdminPanelMonitoring.showAlert(
        `é‡è¦ã‚¨ãƒ©ãƒ¼: ${message.substring(0, 100)}...`,
        'error'
      );
    }
    
    // è‡ªå‹•ãƒªã‚«ãƒãƒªã®è©¦è¡Œ
    attemptRecovery(message, context);
    
    // é€£ç¶šé‡è¦ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡º
    if (criticalErrorCount >= 5) {
      handleRepeatedCriticalErrors();
    }
  }
  
  /**
   * æ¨™æº–ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
   */
  function handleStandardError(message, context) {
    console.warn('âš ï¸ Standard Error:', message, context);
    
    // ã‚¨ãƒ©ãƒ¼ç›£è¦–ãƒ‘ãƒãƒ«ã¸ã®é€šçŸ¥
    if (window.AdminPanelMonitoring) {
      window.AdminPanelMonitoring.showAlert(
        `ã‚¨ãƒ©ãƒ¼: ${message.substring(0, 80)}...`,
        'warning'
      );
    }
  }
  
  /**
   * è‡ªå‹•ãƒªã‚«ãƒãƒªã®è©¦è¡Œ
   */
  function attemptRecovery(message, context) {
    console.log('ğŸ”§ Attempting automatic recovery...');
    
    // é–¢æ•°æœªå®šç¾©ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®å¯¾å¿œ
    if (message.includes('is not defined') || message.includes('is not a function')) {
      setTimeout(() => {
        if (typeof window.initializeAdminPanelMaster === 'function') {
          console.log('ğŸ”„ Re-initializing admin panel...');
          try {
            window.initializeAdminPanelMaster();
          } catch (reinitError) {
            console.error('âŒ Re-initialization failed:', reinitError);
          }
        }
      }, 1000);
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¾©æ—§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    setTimeout(() => {
      if (window.showMessage && typeof window.showMessage === 'function') {
        window.showMessage('ã‚·ã‚¹ãƒ†ãƒ ã®è‡ªå‹•å¾©æ—§ã‚’è©¦è¡Œä¸­ã§ã™ã€‚', 'info');
      }
    }, 2000);
  }
  
  /**
   * é€£ç¶šé‡è¦ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
   */
  function handleRepeatedCriticalErrors() {
    console.error('ğŸš¨ Repeated critical errors detected. Initiating emergency protocol.');
    
    // ç·Šæ€¥ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å®Ÿè¡Œ
    if (window.AdminPanelMonitoring) {
      window.AdminPanelMonitoring.handleEmergency(
        'REPEATED_CRITICAL_ERRORS',
        { count: criticalErrorCount, lastError: lastErrorTime }
      );
    }
    
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é•åã¨ã—ã¦è¨˜éŒ²
    if (window.AdminPanelSecurity) {
      window.AdminPanelSecurity.handleViolation(
        'REPEATED_CRITICAL_ERRORS',
        { count: criticalErrorCount }
      );
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç·Šæ€¥é€šçŸ¥
    if (window.showMessage && typeof window.showMessage === 'function') {
      window.showMessage(
        'é‡è¦ãªã‚¨ãƒ©ãƒ¼ãŒé€£ç¶šã—ã¦ç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚',
        'error'
      );
    }
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼ã®è¨˜éŒ²
   */
  function recordError(errorData) {
    errorHistory.push(errorData);
    
    // æœ€æ–°50ä»¶ã®ã¿ä¿æŒ
    if (errorHistory.length > 50) {
      errorHistory = errorHistory.slice(-50);
    }
  }
  
  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®ãƒ­ã‚°
   */
  function logSecurityIncident(incidentType, details) {
    console.warn('ğŸ”’ Security Incident Logged:', {
      type: incidentType,
      details: details,
      timestamp: new Date().toISOString()
    });
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼çµ±è¨ˆã®æ›´æ–°
   */
  function updateErrorStatistics(category) {
    if (!window.ErrorStats) {
      window.ErrorStats = {};
    }
    
    if (!window.ErrorStats[category]) {
      window.ErrorStats[category] = 0;
    }
    
    window.ErrorStats[category]++;
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼çµ±è¨ˆã®å–å¾—
   */
  function getErrorStatistics() {
    return {
      history: errorHistory.length,
      critical: criticalErrorCount,
      categories: window.ErrorStats || {},
      lastError: lastErrorTime ? new Date(lastErrorTime).toLocaleString() : 'ãªã—'
    };
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼å±¥æ­´ã®ã‚¯ãƒªã‚¢
   */
  function clearErrorHistory() {
    errorHistory = [];
    criticalErrorCount = 0;
    lastErrorTime = 0;
    window.ErrorStats = {};
    console.log('ğŸ§¹ Error history cleared');
  }
  
  // å…¬é–‹API
  return {
    init: initializeGlobalErrorHandling,
    handle: handleError,
    getStats: getErrorStatistics,
    clear: clearErrorHistory,
    recover: attemptRecovery
  };
})();

// =============================================================================
// AUTO INITIALIZATION
// =============================================================================

/**
 * ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è‡ªå‹•åˆæœŸåŒ–
 */
(function autoInitializeErrorHandling() {
  'use strict';
  
  // å³åº§ã«åˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯æœ€å„ªå…ˆï¼‰
  window.AdminPanelErrorHandler.init();
  
  console.log('ğŸ“¦ AdminPanel Error Handling Module loaded');
})();
</script>