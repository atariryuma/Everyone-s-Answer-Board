<script>
// =============================================================================
// ADMIN PANEL API COMMUNICATIONS & BACKEND CALLS
// =============================================================================

// =============================================================================
// BACKEND FUNCTION WRAPPERS
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: æ–°ã—ã„runGasWithUserIdé–¢æ•° - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ã
function runGasWithUserId(functionName, loadingMessage = 'å‡¦ç†ä¸­...', ...args) {
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãŒå¿…è¦ãªå ´åˆã¯ callWithLoading ã‚’ä½¿ç”¨
  if (loadingMessage && loadingMessage !== false) {
    // userIdãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–ã‚’å¾…ã¤
    if (!userId) {
      return userIdPromise.then(() => {
        if (!userId) {
          logError('No userId available for:', functionName);
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ãã§userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ  - Admin Panel uses overlay loading
        return sharedUtilities.gas.callWithLoading(functionName, loadingMessage, 'overlay', userId, ...args);
      }).catch((error) => {
        logError('Error in runGasWithUserId (after userIdPromise):', error);
        throw error;
      });
    }
    
    // userIdãŒæ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ã - Admin Panel uses overlay loading
    return sharedUtilities.gas.callWithLoading(functionName, loadingMessage, 'overlay', userId, ...args).catch((error) => {
      logError('Error in runGasWithUserId (direct call with loading):', error);
      throw error;
    });
  }
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸è¦ã®å ´åˆï¼ˆloadingMessage = falseï¼‰ã¯å¾“æ¥é€šã‚Š
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        logError('No userId available for:', functionName);
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }
      
      // userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ 
      return gasOptimizer.call(functionName, userId, ...args);
    }).catch((error) => {
      logError('userIdPromise rejected:', error);
      throw error;
    });
  }
  
  // userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ 
  return gasOptimizer.call(functionName, userId, ...args);
}

// callWithCache é–¢æ•° - èª­ã¿å–ã‚Šå°‚ç”¨æ“ä½œç”¨
function callWithCache(functionName, cacheKey, ttl, ...args) {
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, ...args);
  }, ttl);
}

// runGasWithUserId with cache support
function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
      return unifiedCache.getOrSet(cacheKey, function() {
        return gasOptimizer.call(functionName, userId, ...args);
      }, ttl);
    });
  }
  
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, userId, ...args);
  }, ttl);
}

// =============================================================================
// STATUS AND DATA LOADING
// =============================================================================

// Load system status - OPTIMIZED with integrated API
function loadStatus(bypassCache = false) {
  console.group('ğŸ”„ loadStatus - Integrated API');
  logDebug('ğŸš€ Loading system status with integrated API, bypassCache:', bypassCache);
  logDebug('ğŸ“ About to call runGasWithUserId for getInitialData');

  // userIdPromise ãŒè§£æ±ºã•ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰ getInitialData ã‚’å‘¼ã³å‡ºã™
  userIdPromise.then(() => {
    if (!userId) {
      console.error('âŒ userId is not available after userIdPromise resolution in loadStatus!');
      showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
      console.groupEnd();
      return;
    }

    logDebug('âœ… userId is available:', userId);
    logDebug('ğŸŒ Calling getInitialData with userId:', userId);

  // runGasWithUserId ã‚’ä½¿ç”¨ã—ã¦ getInitialData ã‚’å‘¼ã³å‡ºã™
  // æœ€æ–°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ã™ã‚‹ãŸã‚è¿½åŠ ã®å¼•æ•°ã¯ä¸è¦
    runGasWithUserId('getInitialData', 'ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...')
      .then(response => {
        logDebug('âœ… Integrated data loaded:', response);

        // Update UI with integrated response
        updateUIWithNewStatus(response);

        // If sheet details are included, apply them immediately
        if (response.sheetDetails && response.activeSheetName) {
          logDebug('âœ… Sheet details included in integrated response, applying configuration');
          try {
            populateHeaderOptions(response.sheetDetails.allHeaders);
            logDebug('âœ… Header options populated from integrated data');
            populateConfig(response.sheetDetails.guessedConfig);
            logDebug('âœ… AI configuration applied from integrated data');
          } catch (configError) {
            console.error('Error applying sheet configuration from integrated data:', configError);
          }
        }

        logInfo('âš¡ Performance: Single API call replaced 3-4 separate calls');
      })
      .catch(error => {
        console.error('âŒ Integrated API failed:', error);
        showMessage('ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      })
      .finally(() => {
        console.groupEnd();
      });
  }).catch(error => {
    console.error('âŒ Error resolving userIdPromise in loadStatus:', error);
    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    console.groupEnd();
  });
}

// Load sheet configuration for selected sheet
function loadConfigForSelected() {
  if (!selectedSheet) {
    logWarn('No sheet selected for config loading');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    logError('Missing required data for loadConfigForSelected');
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  runGasWithUserId('getSheetDetails', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
    .then(handleSheetDetailsSuccess)
    .catch(handleSheetDetailsError);
}

// Handle successful sheet details loading
function handleSheetDetailsSuccess(details) {
  if (details && details.allHeaders) {
    populateHeaderOptions(details.allHeaders);
    
    // Show config area and hide placeholder
    const configArea = document.getElementById('config-area');
    const configPlaceholder = document.getElementById('config-placeholder');
    
    if (configArea) {
      configArea.classList.remove('hidden');
    }
    
    if (configPlaceholder) {
      configPlaceholder.classList.add('hidden');
    }
    
    if (details.guessedConfig) {
      // DOMã®æ›´æ–°ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰populateConfigã‚’å‘¼ã³å‡ºã™
      setTimeout(() => {
        populateConfig(details.guessedConfig);
        
        // Enhanced auto-detection success message with specifics
        const detectedColumns = [];
        if (details.guessedConfig.opinionColumn) detectedColumns.push(`å›ç­”åˆ—: ${details.guessedConfig.opinionColumn}`);
        if (details.guessedConfig.nameColumn) detectedColumns.push(`åå‰åˆ—: ${details.guessedConfig.nameColumn}`);
        if (details.guessedConfig.classColumn) detectedColumns.push(`ã‚¯ãƒ©ã‚¹åˆ—: ${details.guessedConfig.classColumn}`);
        
        const message = detectedColumns.length > 0 
          ? `ğŸ¤– AIåˆ—åˆ¤å®šãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼æ¤œå‡ºã•ã‚ŒãŸåˆ—: ${detectedColumns.join(', ')}ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
          : 'ğŸ¤– AIåˆ—åˆ¤å®šãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        
        showMessage(message, 'success');
      }, 0);
    }
  } else {
    logWarn('No headers in sheet details:', details);
    showMessage('ã‚·ãƒ¼ãƒˆã®è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'warning');
  }
}

// Handle sheet details loading error
function handleSheetDetailsError(error) {
  logError('Sheet details failed:', error);
  handleError(error, 'loadConfigForSelected', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
}

// =============================================================================
// AI COLUMN DETECTION
// =============================================================================

// Run AI-powered header guessing
function runHeaderGuessing() {
  if (!selectedSheet) {
    showMessage('ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  // Update button state to show AI is working
  const reguessBtn = document.getElementById('reguess-headers-btn');
  if (reguessBtn) {
    const originalContent = reguessBtn.innerHTML;
    reguessBtn.disabled = true;
    reguessBtn.innerHTML = `
      <span class="relative z-10 flex items-center gap-1">
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <span class="text-xs font-bold">AIåˆ†æä¸­</span>
      </span>
    `;
    
    // Restore button after completion
    const restoreButton = () => {
      reguessBtn.disabled = false;
      reguessBtn.innerHTML = originalContent;
    };
    
    // Show start notification
    showMessage('ğŸ¤– é«˜ç²¾åº¦AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...', 'info');
    
    runGasWithUserId('getSheetDetails', 'AIæ­è¼‰é«˜ç²¾åº¦åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãŒåˆ†æä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
      .then(function(details) {
        if (!details || !details.guessedConfig) {
          restoreButton();
          showMessage('âŒ AIåˆ—åˆ¤å®šãŒå¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'warning');
          return;
        }
        
        const configToUse = {
          ...details.guessedConfig,
          sheetName: selectedSheet
        };
        
        setTimeout(() => {
          populateConfig(configToUse);
          restoreButton();
          
          // Enhanced completion notification with analysis details
          const detectedColumns = [];
          if (configToUse.opinionColumn) detectedColumns.push(`ğŸ’¬ å›ç­”åˆ—: ${configToUse.opinionColumn}`);
          if (configToUse.nameColumn) detectedColumns.push(`ğŸ‘¤ åå‰åˆ—: ${configToUse.nameColumn}`);
          if (configToUse.classColumn) detectedColumns.push(`ğŸ« ã‚¯ãƒ©ã‚¹åˆ—: ${configToUse.classColumn}`);
          if (configToUse.reasonColumn) detectedColumns.push(`ğŸ’­ ç†ç”±åˆ—: ${configToUse.reasonColumn}`);
          
          const message = detectedColumns.length > 0 
            ? `ğŸ‰ é«˜ç²¾åº¦AIåˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\næ¤œå‡ºã•ã‚ŒãŸåˆ—:\n${detectedColumns.join('\n')}\n\nè¨­å®šå†…å®¹ã‚’ç¢ºèªã—ã¦ã€Œä¿å­˜ãƒ»å…¬é–‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`
            : 'ğŸ‰ é«˜ç²¾åº¦AIåˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼è¨­å®šå†…å®¹ã‚’ç¢ºèªã—ã¦ã€Œä¿å­˜ãƒ»å…¬é–‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
          
          showMessage(message, 'success');
        }, 100);
      })
      .catch(function(error) {
        restoreButton();
        console.error('AI column detection error:', error);
        
        // Enhanced error message with specific guidance
        let errorMessage = 'âŒ é«˜ç²¾åº¦AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n';
        if (error?.message?.includes('permission') || error?.message?.includes('æ¨©é™')) {
          errorMessage += 'ğŸ“‹ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        } else if (error?.message?.includes('network') || error?.message?.includes('timeout')) {
          errorMessage += 'ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
        } else {
          errorMessage += 'âš™ï¸ æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã™ã‚‹ã‹ã€å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        }
        
        errorMessage += '\n\nğŸ’¡ å•é¡ŒãŒç¶šãå ´åˆã¯ã€ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
        
        showMessage(errorMessage, 'error');
      });
  }
}

// =============================================================================
// SAVE AND PUBLISH OPERATIONS
// =============================================================================

// Save configuration and publish board - ä¿®æ­£ç‰ˆï¼ˆå…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«çµŒç”±ï¼‰
function saveAndPublish() {
  if (!validateConfig()) {
    showMessage('å¿…é ˆé …ç›®ï¼ˆå›ç­”ãƒ‡ãƒ¼ã‚¿åˆ—ï¼‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  // UIã‹ã‚‰configã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
  const config = buildConfigObject();
  
  // è‡ªå‹•åœæ­¢è¨­å®šã‚’æº–å‚™
  const autoStopSettings = {
    enabled: true,
    minutes: 360 // 6æ™‚é–“ = 360åˆ†ï¼ˆconfig.gsã¨çµ±ä¸€ï¼‰
  };
  
  // Check for privacy-sensitive settings and show warning if enabled
  const showNames = document.getElementById('show-names')?.checked || false;
  const showCounts = document.getElementById('show-counts')?.checked || false;
  
  if (showNames || showCounts) {
    // Show privacy warning modal first
    if (window.sharedModals) {
      const privacySettings = [];
      if (showNames) privacySettings.push('åå‰è¡¨ç¤º');
      if (showCounts) privacySettings.push('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°è¡¨ç¤º');
      
      console.log(`âš ï¸ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è­¦å‘Š: ${privacySettings.join('ãƒ»')}ãŒæœ‰åŠ¹ã§ã™`);
      
      window.sharedModals.showPrivacyWarning(
        // onConfirm - show publish modal after privacy confirmation
        () => {
          console.log('âœ… ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è­¦å‘Šã‚’ç¢ºèªã€å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º');
          showPublishModalAfterChecks(config, autoStopSettings);
        },
        // onCancel - user wants to review settings
        () => {
          console.log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šã®è¦‹ç›´ã—ã‚’é¸æŠ');
          showMessage('è¨­å®šã‚’è¦‹ç›´ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'info');
        }
      );
      return;
    }
  }
  
  // If no privacy concerns, show publish modal directly
  showPublishModalAfterChecks(config, autoStopSettings);
}

// å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒã‚§ãƒƒã‚¯å¾Œï¼‰
function showPublishModalAfterChecks(config, autoStopSettings) {
  if (window.sharedModals && typeof window.sharedModals.showPublish === 'function') {
    window.sharedModals.showPublish(
      // å…¬é–‹å®Ÿè¡Œæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      () => {
        console.log('ğŸ“¤ å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å…¬é–‹ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        proceedWithSaveAndPublish(config);
      },
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      () => {
        console.log('âŒ å…¬é–‹ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      },
      // è‡ªå‹•åœæ­¢è¨­å®š
      autoStopSettings
    );
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ç›´æ¥å®Ÿè¡Œ
    console.warn('âš ï¸ å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ç›´æ¥å®Ÿè¡Œã—ã¾ã™ã€‚');
    proceedWithSaveAndPublish(config);
  }
}

// Proceed with the actual save and publish operation
function proceedWithSaveAndPublish(config) {

  // Set save protection flags to prevent interference
  isSaveInProgress = true;
  freshSaveTimestamp = Date.now();
  window.freshSaveTimestamp = freshSaveTimestamp;
  
  runGasWithUserId('saveAndPublish', 'è¨­å®šã‚’ä¿å­˜ã—ã€ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™...', selectedSheet, config)
    .then(function(result) {
      isSaveInProgress = false;
      
      // Check if result has data (from integrated API) or legacy success status
      if (result && (result.userInfo || result.status === 'success')) {
        showMessage('âœ… è¨­å®šãŒä¿å­˜ã•ã‚Œã€ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
        
        // ãƒœãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã«å³åº§æ›´æ–°ã‚’é€šçŸ¥
        try {
          // ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆã‚ã‚Œã°ï¼‰
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'BOARD_PUBLISHED',
              sheetName: selectedSheet,
              timestamp: Date.now()
            }, '*');
            logInfo('ãƒœãƒ¼ãƒ‰å…¬é–‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€ä¿¡');
          }
          
          // åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä»–ã®ã‚¿ãƒ–ã«ã‚‚é€šçŸ¥
          if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('board-updates');
            channel.postMessage({
              type: 'BOARD_PUBLISHED',
              sheetName: selectedSheet,
              timestamp: Date.now()
            });
            channel.close();
            logInfo('ãƒœãƒ¼ãƒ‰å…¬é–‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’BroadcastChannelã§é€ä¿¡');
          }
        } catch (broadcastError) {
          console.warn('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°é€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼:', broadcastError);
        }
        
        // 6æ™‚é–“è‡ªå‹•åœæ­¢ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        setTimeout(() => {
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ç¢ºå®Ÿã«éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
          if (window.unifiedLoadingManager) {
            window.unifiedLoadingManager.setLoading(false);
            console.log('ğŸ”„ é€šå¸¸å…¬é–‹å¾Œã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
          }
          
          // å…¬é–‹å®Œäº†ç¢ºèªã¨URLç”Ÿæˆå¾Œã«è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          setTimeout(() => {
            // å…¬é–‹çŠ¶æ…‹ã¨URLç”Ÿæˆã®ç¢ºèª
            if (result && (result.publishedAt || result.userInfo)) {
              const publishResult = {
                publishedAt: result.publishedAt || new Date().toISOString(),
                autoStopMinutes: result.autoStopMinutes || 360,
                boardUrl: result.boardUrl || '',
                status: 'success',
                ...result
              };
              
              console.log('ğŸ“Š é€šå¸¸å…¬é–‹å®Œäº†ãƒ‡ãƒ¼ã‚¿ç¢ºèª:', {
                hasPublishedAt: !!publishResult.publishedAt,
                hasAutoStopMinutes: !!publishResult.autoStopMinutes,
                hasBoardUrl: !!publishResult.boardUrl,
                publishResult
              });
              
              if (window.sharedModals && typeof window.sharedModals.showAutoStopConfirmation === 'function') {
                window.sharedModals.showAutoStopConfirmation(publishResult);
                console.log('âœ… é€šå¸¸å…¬é–‹å¾Œã«è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
              } else {
                console.warn('âš ï¸ è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              }
            } else {
              console.warn('âš ï¸ é€šå¸¸å…¬é–‹çµæœãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã®ãŸã‚ã€è‡ªå‹•åœæ­¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™:', result);
            }
          }, 800); // URLç”Ÿæˆå¾…ã¡ã®ãŸã‚å°‘ã—é•·ã‚ã«è¨­å®š
        }, 2000); // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¾Œã«è¡¨ç¤º
        
        // Use fresh data from save response if available
        if (result.userInfo && result._meta) {
          logInfo('Using fresh data from save response');
          updateUIWithNewStatus(result);
        } else {
          // Only force refresh if no fresh data available
          logInfo('No fresh data in response, forcing refresh');
          loadStatus(true);
        }
      } else {
        logError('Save failed:', result);
        showMessage(result.message || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        isSaveInProgress = false;
      }
    })
    .catch(function(error) {
      logError('saveAndPublish error:', error);
      isSaveInProgress = false;
      
      // Clear caches after error and reload
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      
      loadStatus(true);
      handleError(error, 'saveAndPublish', 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸã€‚');
    });
}

// Unpublish board
function unpublishBoard() {
  runGasWithUserId('unpublishBoard', 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ä¸­...')
    .then(function(response) {
      logDebug('å…¬é–‹åœæ­¢ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
      showMessage(response.message || 'âœ… å›ç­”ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚', 'success');
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      
      // Reset column selection dropdowns to default "--åˆ—ã‚’é¸æŠ--" state
      resetColumnSelections();
      
      loadStatus(true); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¼·åˆ¶æ›´æ–°
    })
    .catch(function(error) {
      handleError(error, 'unpublishBoard', 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    });
}

// Reset column selection dropdowns to default state
function resetColumnSelections() {
  console.log('ğŸ”„ Resetting column selections to default state');
  
  const columnSelects = [
    'opinion-column-select',
    'name-column-select', 
    'reason-column-select',
    'class-column-select',
    'timestamp-column-select'
  ];
  
  columnSelects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.value = ''; // Reset to empty value
      console.log(`âœ… Reset ${selectId} to default`);
    }
  });
  
  // Also reset any display checkboxes
  const checkboxes = ['show-names', 'show-counts'];
  checkboxes.forEach(checkboxId => {
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) {
      checkbox.checked = false;
      console.log(`âœ… Reset ${checkboxId} to unchecked`);
    }
  });
}

// =============================================================================
// FORM MANAGEMENT
// =============================================================================

// Load saved class choices
function loadSavedClassChoices() {
    runGasWithUserId('getSavedClassChoices', 'ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’èª­ã¿è¾¼ã¿ä¸­...')
        .then(function(result) {
            if (result.status === 'success' && result.classChoices) {
                const classChoicesTextarea = document.getElementById('class-choices');
                if (classChoicesTextarea) {
                    classChoicesTextarea.value = result.classChoices.join('\n');
                }
            }
        })
        .catch(function(error) {
            console.warn('ä¿å­˜ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error.message);
            showMessage('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        });
}

// Create form with custom configuration
function createFormWithConfig() {
  const questionTextarea = document.getElementById('custom-main-question');
  const questionTypeSelect = document.getElementById('main-question-type');
  const questionChoicesTextarea = document.getElementById('main-question-choices');
  const classChoicesTextarea = document.getElementById('class-choices');
  const includeOthersOption = document.getElementById('include-others-option').checked;
  const enableClassSelection = document.getElementById('enable-class-selection').checked;
  
  if (!questionTextarea || !questionTypeSelect) {
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  const question = questionTextarea.value.trim();
  const questionType = questionTypeSelect.value; // å›ç­”æ–¹æ³•ã‚’å–å¾—
  const questionChoicesText = questionChoicesTextarea ? questionChoicesTextarea.value.trim() : '';
  const classChoicesText = enableClassSelection && classChoicesTextarea ? classChoicesTextarea.value.trim() : '';
  
  if (!question) {
    showMessage('å•é¡Œæ–‡ã¯å¿…é ˆã§ã™ã€‚', 'warning');
    return;
  }
  
  // é¸æŠè‚¢ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯é¸æŠè‚¢ãŒå¿…è¦
  if ((questionType === 'choice' || questionType === 'multiple') && !questionChoicesText) {
    showMessage('é¸æŠè‚¢ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯é¸æŠè‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  // é¸æŠè‚¢ã‚’é…åˆ—ã«å¤‰æ›
  const questionChoices = questionChoicesText ? 
    questionChoicesText.split('\n').map(choice => choice.trim()).filter(choice => choice.length > 0) : [];
  
  // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’é…åˆ—ã«å¤‰æ›  
  const classChoices = classChoicesText ? 
    classChoicesText.split('\n').map(choice => choice.trim()).filter(choice => choice.length > 0) : [];
  
  const config = {
    mainQuestion: question,
    responseType: questionType, // å›ç­”æ–¹æ³•ã‚’è¿½åŠ 
    questionChoices: questionChoices, // ãƒ¡ã‚¤ãƒ³è³ªå•ã®é¸æŠè‚¢
    classChoices: classChoices,
    includeOthers: includeOthersOption,
    enableClass: enableClassSelection && classChoices.length > 0,
  };
  
  console.log('ğŸ“‹ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®š:', config);
  
  hideFormConfigModal();
  
  // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨é€²æ—è¡¨ç¤ºã‚’é–‹å§‹
  showQuickStartProgress();
  simulateCustomFormProgressWithFolderCheck();
  
  // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆä¸­ã¯å°‚ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€æ±ç”¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è¡¨ç¤ºã—ãªã„

  // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æ­£ã—ã„é–¢æ•°ã‚’ä½¿ç”¨: createCustomForm(userEmail, userId, config)
  // userEmailã¯ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‹ã‚‰å–å¾—
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.adminEmail) {
    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }
  
  runGasWithUserId('createCustomFormUI', false, config)
    .then(function(result) {
      logDebug('ğŸ“¥ Received response from createCustomFormUI:', result);
      if (result && result.status === 'success') {
        showMessage('âœ… æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã€é€£æºã•ã‚Œã¾ã—ãŸï¼', 'success');
        
        // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        saveClassChoicesToDatabase(classChoices);
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        loadStatus(true);
        
        // ãƒ•ã‚©ãƒ¼ãƒ URLè¡¨ç¤ºã®å¼·åˆ¶æ›´æ–°ï¼ˆç®¡ç†ãƒ‘ãƒãƒ«ã®ãƒªã‚½ãƒ¼ã‚¹æ¬„ç”¨ï¼‰
        setTimeout(() => {
          updateFormUrlDisplay();
        }, 1000);
        
        // å›ç­”ãƒœãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ã‚’é€šçŸ¥ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯æ›´æ–°ç”¨ï¼‰
        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'FORM_CREATED',
              formUrl: result.formUrl,
              timestamp: Date.now()
            }, '*');
          }
          
          if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('board-updates');
            channel.postMessage({
              type: 'FORM_CREATED',
              formUrl: result.formUrl,
              timestamp: Date.now()
            });
            channel.close();
          }
        } catch (notifyError) {
          console.warn('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆé€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼:', notifyError);
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        hideFormConfigModal();
        
        // é€²æ—ãƒãƒ¼ã‚’3ç§’å¾Œã«éè¡¨ç¤º
        setTimeout(() => {
          hideQuickStartProgress();
        }, 3000);
      } else {
        console.error('âŒ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãŒå¤±æ•—:', result);
        showMessage(result?.message || 'ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        // å¤±æ•—æ™‚ã‚‚é€²æ—ãƒãƒ¼ã‚’éè¡¨ç¤º
        setTimeout(() => {
          hideQuickStartProgress();
        }, 2000);
      }
    })
    .catch(function(error) {
      console.error('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
      
      // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let errorMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      if (error.toString().includes('permission') || error.toString().includes('æ¨©é™')) {
        errorMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Google Drive ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      }
      
      showMessage(errorMessage, 'error');
      
      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚é€²æ—ãƒãƒ¼ã‚’éè¡¨ç¤º
      setTimeout(() => {
        hideQuickStartProgress();
      }, 2000);
    });
}

// Save class choices to database
function saveClassChoicesToDatabase(classChoices) {
    runGasWithUserId('saveClassChoices', classChoices)
        .catch(function(error) {
            console.warn('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®ä¿å­˜ã«å¤±æ•—:', error.message);
        });
}

// =============================================================================
// RESOURCE MANAGEMENT
// =============================================================================

// Add spreadsheet resource
function addResource() {
  const urlInput = document.getElementById('resource-url-input');
  if (!urlInput) {
    showMessage('URLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  const url = urlInput.value.trim();
  if (!url) {
    showMessage('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }

  // URLã®ç¨®é¡ã‚’åˆ¤å®šï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã¿å¯¾å¿œï¼‰
  let resourceType = 'spreadsheet';
  let backendFunction = 'addSpreadsheetUrl';
  
  if (!url.includes('docs.google.com/spreadsheets/')) {
    showMessage('Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  const resourceTypeText = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ';

  runGasWithUserId(backendFunction, `${resourceTypeText}ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™...`, url)
    .then(function(result) {
      if (result.status === 'success') {
        showMessage(result.message, 'success');
        urlInput.value = ''; // Clear input
        loadStatus(true); // Refresh status
      } else {
        showMessage(result.message || `${resourceTypeText}ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`, 'error');
      }
    })
    .catch(function(error) {
      handleError(error, 'addResource', `${resourceTypeText}ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
    });
}

// =============================================================================
// EXTERNAL LINKS AND NAVIGATION
// =============================================================================

// Copy board URL to clipboard
function copyBoardUrl(buttonElement) {
  const urlInput = document.getElementById('board-url');
  if (!urlInput) {
    console.error('board-url input element not found.');
    return;
  }

  const urlToCopy = urlInput.value;

  if (!urlToCopy) {
    showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
    return;
  }

  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(urlToCopy).then(() => {
        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>ã‚³ãƒ”ãƒ¼å®Œäº†!';
        buttonElement.disabled = true;
        setTimeout(() => {
          buttonElement.innerHTML = originalText;
          buttonElement.disabled = false;
        }, 2000);
      }).catch((error) => {
        console.error('Clipboard API failed:', error);
        // Fallback to manual copy message
        const messageElement = document.createElement('span');
        messageElement.textContent = ' (æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)';
        messageElement.style.color = 'orange';
        buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
        setTimeout(() => messageElement.remove(), 5000);
      });
    } else {
      // Fallback for browsers that don't support Clipboard API
      urlInput.select();
      urlInput.setSelectionRange(0, 99999); // For mobile devices
      document.execCommand('copy');
      showMessage('URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success'); // Fallback uses showMessage
    }
  } catch (err) {
    console.error('copyBoardUrl error:', err);
    showMessage('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'warning'); // Fallback uses showMessage
  }
}

// Copy form URL to clipboard
function copyFormUrl() {
  const urlInput = document.getElementById('form-url-input');
  if (urlInput && urlInput.value) {
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      // Try modern clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(urlInput.value).then(() => {
          showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
        }).catch(() => {
          // Fallback to execCommand
          document.execCommand('copy');
          showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
        });
      } else {
        document.execCommand('copy');
        showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
      }
    } catch (err) {
      showMessage('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'warning');
    }
  } else {
    showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
  }
}

// Open database spreadsheet
function openDatabaseSpreadsheet() {
  if (currentSpreadsheetUrl) {
    window.open(currentSpreadsheetUrl, '_blank');
  } else {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'warning');
  }
}

// Open form
function openForm() {
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ URLã‚’å–å¾—ã™ã‚‹å„ªå…ˆé †ä½ã‚’è¨­å®š
  let formUrl = null;
  
  // 1. configJsonã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰
  if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
    try {
      const configJson = typeof currentStatus.userInfo.configJson === 'string' 
        ? JSON.parse(currentStatus.userInfo.configJson) 
        : currentStatus.userInfo.configJson;
      
      if (configJson && configJson.formUrl) {
        formUrl = configJson.formUrl;
        logDebug('âœ… FormURLå–å¾—: configJsonã‹ã‚‰ç›´æ¥å–å¾—æˆåŠŸ');
      }
    } catch (error) {
      logWarn('âš ï¸ configJsonã®è§£æã§ã‚¨ãƒ©ãƒ¼:', error);
    }
  }
  
  // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®formUrlã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  if (!formUrl && currentStatus && currentStatus.userInfo && currentStatus.userInfo.formUrl) {
    formUrl = currentStatus.userInfo.formUrl;
    logDebug('ğŸ“‹ FormURLå–å¾—: userInfo.formUrlã‹ã‚‰å–å¾—');
  }
  
  // 3. ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‹ã‚‰å–å¾—ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
  if (!formUrl && currentStatus && currentStatus.customFormInfo && currentStatus.customFormInfo.formUrl) {
    formUrl = currentStatus.customFormInfo.formUrl;
    logDebug('ğŸ“„ FormURLå–å¾—: customFormInfo.formUrlã‹ã‚‰å–å¾—');
  }
  
  if (formUrl) {
    window.open(formUrl, '_blank');
  } else {
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'warning');
  }
}

// Open app setup page
function openAppSetupPage() {
  const loadingMessage = 'ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã‚’æº–å‚™ä¸­...';
  const errorMessage = 'ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
  const timeoutMessage = 'ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚';
  const fallbackMessage = 'ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚';

  runGasWithUserId('getWebAppUrl', loadingMessage)
    .then(function(webAppUrl) {
      const setupUrl = webAppUrl + '?setup=true&mode=appsetup&userId=' + encodeURIComponent(userId);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹
      showMessage('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ç§»å‹•ä¸­...', 'info');
      window.unifiedLoading.showSimple('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ç§»å‹•ä¸­...');

      const redirectTimeout = setTimeout(() => {
        console.warn('Redirect to app setup page timed out. Attempting fallback.');
        window.unifiedLoading.hide();
        showMessage(timeoutMessage, 'warning');
        window.open(setupUrl, '_blank'); // Fallback: open in new tab
      }, 10000); // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

      // ç›´æ¥ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è©¦ã¿ã‚‹
      try {
        clearTimeout(redirectTimeout);
        window.unifiedLoading.hide();
        window.open(setupUrl, '_top'); // _top ã‚’ä½¿ç”¨ã—ã¦ç¾åœ¨ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
      } catch (e) {
        console.error('Error opening app setup page:', e);
        window.unifiedLoading.hide();
        showMessage(errorMessage + ' ' + (e.message || ''), 'error');
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        showMessage(fallbackMessage, 'info');
        window.open(setupUrl, '_blank');
      }
    })
    .catch(function(error) {
      console.error('Failed to get web app URL for app setup page:', error);
      window.unifiedLoading.hide();
      showMessage('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã®URLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚' + (error.message || ''), 'error');
    });
}

// =============================================================================
// POLLING AND REAL-TIME UPDATES
// =============================================================================

// System status polling variables
let lastUserActivity = Date.now();
let currentPollInterval = 5 * 60 * 1000; // é–‹å§‹ã¯5åˆ†é–“éš”
let statusPollTimer = null;

// Fresh save management to prevent interference
let freshSaveTimestamp = 0;
let isSaveInProgress = false;
const FRESH_SAVE_PROTECTION_DURATION = 30000; // 30 seconds

// Make freshSaveTimestamp globally accessible
window.freshSaveTimestamp = freshSaveTimestamp;

// Get optimal polling interval based on user activity
function getOptimalPollInterval() {
  const timeSinceActivity = Date.now() - lastUserActivity;
  
  if (timeSinceActivity < 2 * 60 * 1000) { // 2åˆ†ä»¥å†…
    return 30 * 1000; // 30ç§’é–“éš”
  } else if (timeSinceActivity < 10 * 60 * 1000) { // 10åˆ†ä»¥å†…
    return 2 * 60 * 1000; // 2åˆ†é–“éš”
  } else {
    return 10 * 60 * 1000; // 10åˆ†é–“éš”
  }
}

// Restart status polling with new interval
function restartStatusPolling() {
  if (statusPollTimer) {
    clearInterval(statusPollTimer);
  }
  currentPollInterval = getOptimalPollInterval();
  startSystemStatusUpdate();
}

// Start system status update polling
function startSystemStatusUpdate() {
  statusPollTimer = setInterval(function() {
    // UIãŒéè¡¨ç¤ºã®æ™‚ã¯æ›´æ–°ã—ãªã„
    if (document.hidden) return;
    
    // Skip background updates if save operation is in progress or recently completed
    if (isSaveInProgress) {
      logDebug('Skipping background update: save in progress');
      return;
    }
    
    const timeSinceFreshSave = Date.now() - freshSaveTimestamp;
    if (timeSinceFreshSave < FRESH_SAVE_PROTECTION_DURATION) {
      logDebug('Skipping background update: fresh save protection active');
      return;
    }
    
    // ç¾åœ¨ã®ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´
    const optimalInterval = getOptimalPollInterval();
    if (Math.abs(currentPollInterval - optimalInterval) > 30000) { // 30ç§’ä»¥ä¸Šã®å·®
      restartStatusPolling();
      return;
    }
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã—ã¦é™ã‹ã«æ›´æ–°
    runGasWithUserId('getStatus', false)
      .then(function(status) {
        // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿UIã‚’æ›´æ–°
        if (JSON.stringify(status) !== JSON.stringify(currentStatus)) {
          updateUIWithNewStatus(status);
        }
      })
      .catch(function(error) {
        logWarn('Background status update failed:', error);
      });
  }, currentPollInterval);
}

// =============================================================================
// CONFIG MANAGEMENT
// =============================================================================

// Reset configJson to initial values
function resetConfigJson() {
  // å±é™ºæ“ä½œã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  const confirmMessage = `âš ï¸ è¨­å®šãƒªã‚»ãƒƒãƒˆã®ç¢ºèª

ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®è¨­å®šãŒåˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼š
â€¢ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šï¼ˆè³ªå•æ–‡ã€å›ç­”æ–¹æ³•ãªã©ï¼‰
â€¢ è¡¨ç¤ºè¨­å®šï¼ˆåŒ¿åè¡¨ç¤ºã€é›†è¨ˆè¡¨ç¤ºãªã©ï¼‰
â€¢ ã‚·ãƒ¼ãƒˆè¨­å®šï¼ˆå›ç­”é€£æºãªã©ï¼‰

â€» ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚„ãƒ•ã‚©ãƒ¼ãƒ è‡ªä½“ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ãŒã€
ã€€ è¨­å®šã®å†æ§‹ç¯‰ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

æœ¬å½“ã«è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`;

  if (!confirm(confirmMessage)) {
    return;
  }
  
  const button = document.getElementById('reset-config-btn');
  const originalHTML = button ? button.innerHTML : '';
  
  try {
    if (button) {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
      button.disabled = true;
      button.innerHTML = `
        <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        ãƒªã‚»ãƒƒãƒˆä¸­...
      `;
    }
    
    logInfo('ğŸ”„ ConfigJsonãƒªã‚»ãƒƒãƒˆé–‹å§‹');
    
    runGasWithUserId('resetConfigJson', 'è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆä¸­...')
      .then(function(result) {
        if (result.success) {
          showMessage('âœ… è¨­å®šã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å¤‰æ›´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'success');
          logInfo('âœ… ConfigJsonãƒªã‚»ãƒƒãƒˆå®Œäº†');
          
          // UIã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          setTimeout(() => {
            runGasWithUserId('getInitialData', 'ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...')
              .then(function(updatedStatus) {
                updateUIWithNewStatus(updatedStatus);
                logInfo('ğŸ”„ ãƒªã‚»ãƒƒãƒˆå¾Œã®UIæ›´æ–°å®Œäº†');
              })
              .catch(function(error) {
                logWarn('âš ï¸ ãƒªã‚»ãƒƒãƒˆå¾Œã®UIæ›´æ–°ã§ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('è¨­å®šã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸãŒã€è¡¨ç¤ºã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'warning');
              });
          }, 1000);
        } else {
          throw new Error(result.message || 'è¨­å®šãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(function(error) {
        logError('âŒ ConfigJsonãƒªã‚»ãƒƒãƒˆã§ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('è¨­å®šãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error), 'error');
      })
      .finally(() => {
        if (button) {
          // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
          button.disabled = false;
          button.innerHTML = originalHTML;
        }
      });
      
  } catch (error) {
    logError('âŒ ConfigJsonãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
    showMessage('è¨­å®šãƒªã‚»ãƒƒãƒˆã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    if (button) {
      button.disabled = false;
      button.innerHTML = originalHTML;
    }
  }
}

// =============================================================================
// QUICKSTART FUNCTIONALITY
// =============================================================================

// QuickStart progress management
const quickStartSteps = [
  { id: 1, text: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', detail: 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’æº–å‚™ä¸­...' },
  { id: 2, text: 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', detail: 'ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...' },
  { id: 3, text: 'ã‚·ãƒ¼ãƒˆè¨­å®šã¨åˆ—æ§‹é€ ã®æœ€é©åŒ–', detail: 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’è¨­å®šä¸­...' },
  { id: 4, text: 'é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã®å®Ÿè¡Œ', detail: 'AIã«ã‚ˆã‚‹åˆ—ã®è‡ªå‹•åˆ¤å®šã‚’å®Ÿè¡Œä¸­...' },
  { id: 5, text: 'å…¬é–‹è¨­å®šã¨æ™‚é–“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º', detail: 'Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¬é–‹ä¸­...' },
  { id: 6, text: 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', detail: 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼' }
];

// Show QuickStart progress bar
function showQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.remove('hidden');
    resetProgressSteps();
  }
}

// Hide QuickStart progress bar
function hideQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.add('hidden');
  }
}

// Reset all progress steps to initial state
function resetProgressSteps() {
  quickStartSteps.forEach(step => {
    updateProgressStep(step.id, 'waiting', step.text, 'å¾…æ©Ÿä¸­...');
  });
  updateOverallProgress(0, 'åˆæœŸåŒ–ä¸­...');
}

// Update individual progress step
function updateProgressStep(stepId, status, text, detail) {
  const stepElement = document.getElementById(`progress-step-${stepId}`);
  const dotElement = document.getElementById(`progress-step-${stepId}-dot`);
  const textElement = document.getElementById(`progress-step-${stepId}-text`);
  const detailElement = document.getElementById(`progress-step-${stepId}-detail`);
  
  if (!stepElement || !dotElement || !textElement || !detailElement) return;
  
  // Update text and detail
  textElement.textContent = text;
  detailElement.textContent = detail;
  
  // Update visual state based on status
  switch (status) {
    case 'waiting':
      dotElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      textElement.className = 'text-sm text-gray-300';
      detailElement.className = 'text-xs text-gray-500';
      break;
    case 'active':
      dotElement.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse';
      textElement.className = 'text-sm text-emerald-300 font-medium';
      detailElement.className = 'text-xs text-emerald-400';
      break;
    case 'completed':
      dotElement.className = 'w-2 h-2 rounded-full bg-green-400';
      textElement.className = 'text-sm text-green-300 font-medium';
      detailElement.className = 'text-xs text-green-400';
      break;
    case 'error':
      dotElement.className = 'w-2 h-2 rounded-full bg-red-400';
      textElement.className = 'text-sm text-red-300 font-medium';
      detailElement.className = 'text-xs text-red-400';
      break;
  }
}

// Update overall progress bar
function updateOverallProgress(percentage, statusMessage) {
  const progressBar = document.getElementById('progress-bar');
  const progressPercentage = document.getElementById('progress-percentage');
  const progressStatus = document.getElementById('progress-status');
  
  if (progressBar) {
    progressBar.style.width = `${percentage}%`;
  }
  
  if (progressPercentage) {
    progressPercentage.textContent = `${percentage}%`;
  }
  
  if (progressStatus) {
    progressStatus.textContent = statusMessage;
  }
}

// Simulate QuickStart progress (for demonstration)
function simulateQuickStartProgress() {
  // Step 1: Real folder creation/check
  updateProgressStep(1, 'active', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’æº–å‚™ä¸­...');
  updateOverallProgress(5, 'ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
  
  // Actually call the folder creation API to sync with real backend progress
  runGasWithUserId('createUserFolder', 'ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªãƒ»ä½œæˆä¸­...')
    .then(function(folderResult) {
      console.log('âœ… QuickStart folder creation successful:', folderResult);
      updateProgressStep(1, 'completed', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
      updateProgressStep(2, 'active', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...');
      updateOverallProgress(20, 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
      
      // Step 2: Form/spreadsheet creation
      setTimeout(() => {
        updateProgressStep(2, 'completed', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
        updateProgressStep(3, 'active', 'ã‚·ãƒ¼ãƒˆè¨­å®šã¨åˆ—æ§‹é€ ã®æœ€é©åŒ–', 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’è¨­å®šä¸­...');
        updateOverallProgress(40, 'ã‚·ãƒ¼ãƒˆè¨­å®šã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™...');
        
        // Step 3: Sheet configuration
        setTimeout(() => {
          updateProgressStep(3, 'completed', 'ã‚·ãƒ¼ãƒˆè¨­å®šã¨åˆ—æ§‹é€ ã®æœ€é©åŒ–', 'âœ… ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ');
          updateProgressStep(4, 'active', 'é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã®å®Ÿè¡Œ', 'AIã«ã‚ˆã‚‹åˆ—ã®è‡ªå‹•åˆ¤å®šã‚’å®Ÿè¡Œä¸­...');
          updateOverallProgress(60, 'AIåˆ—åˆ¤å®šã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
          
          // Step 4: AI column detection (the time-consuming part)
          setTimeout(() => {
            updateProgressStep(4, 'completed', 'é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã®å®Ÿè¡Œ', 'âœ… AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸ');
            updateProgressStep(5, 'active', 'å…¬é–‹è¨­å®šã¨æ™‚é–“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º', 'Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¬é–‹ä¸­...');
            updateOverallProgress(80, 'å…¬é–‹è¨­å®šã‚’é©ç”¨ã—ã¦ã„ã¾ã™...');
            
            // Step 5: Publishing and modal setup
            setTimeout(() => {
              updateProgressStep(5, 'completed', 'å…¬é–‹è¨­å®šã¨æ™‚é–“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º', 'âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸ');
              updateProgressStep(6, 'active', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
              updateOverallProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
              
              setTimeout(() => {
                updateProgressStep(6, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã™ã¹ã¦ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
              }, 500);
            }, 1500);
          }, 3000); // AI processing takes longer
        }, 1000);
      }, 1500);
    })
    .catch(function(error) {
      console.warn('âš ï¸ QuickStart folder creation failed, continuing with fallback:', error);
      updateProgressStep(1, 'error', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'âš ï¸ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒå‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™');
      showMessage('ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆã«è­¦å‘ŠãŒã‚ã‚Šã¾ã—ãŸãŒã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ç¶šè¡Œã—ã¾ã™ã€‚', 'warning');
      
      // Continue with fallback timing even if folder creation fails (updated for 6 steps)
      setTimeout(() => {
        updateProgressStep(2, 'active', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...');
        updateOverallProgress(20, 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
        
        setTimeout(() => {
          updateProgressStep(2, 'completed', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
          updateProgressStep(3, 'active', 'ã‚·ãƒ¼ãƒˆè¨­å®šã¨åˆ—æ§‹é€ ã®æœ€é©åŒ–', 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’è¨­å®šä¸­...');
          updateOverallProgress(40, 'ã‚·ãƒ¼ãƒˆè¨­å®šã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™...');
          
          setTimeout(() => {
            updateProgressStep(3, 'completed', 'ã‚·ãƒ¼ãƒˆè¨­å®šã¨åˆ—æ§‹é€ ã®æœ€é©åŒ–', 'âœ… ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ');
            updateProgressStep(4, 'active', 'é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã®å®Ÿè¡Œ', 'AIã«ã‚ˆã‚‹åˆ—ã®è‡ªå‹•åˆ¤å®šã‚’å®Ÿè¡Œä¸­...');
            updateOverallProgress(60, 'AIåˆ—åˆ¤å®šã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
            
            setTimeout(() => {
              updateProgressStep(4, 'completed', 'é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã®å®Ÿè¡Œ', 'âœ… AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸ');
              updateProgressStep(5, 'active', 'å…¬é–‹è¨­å®šã¨æ™‚é–“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º', 'Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¬é–‹ä¸­...');
              updateOverallProgress(80, 'å…¬é–‹è¨­å®šã‚’é©ç”¨ã—ã¦ã„ã¾ã™...');
              
              setTimeout(() => {
                updateProgressStep(5, 'completed', 'å…¬é–‹è¨­å®šã¨æ™‚é–“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º', 'âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸ');
                updateProgressStep(6, 'active', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
                updateOverallProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                
                setTimeout(() => {
                  updateProgressStep(6, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã™ã¹ã¦ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
                }, 500);
              }, 1500);
            }, 3000);
          }, 1000);
        }, 1500);
      }, 1000);
    });
}



// Handle quick start setup
function handleQuickStart() {
  const quickstartBtn = document.getElementById('quickstart-btn');
  const quickstartText = document.getElementById('quickstart-text');
  
  if (!quickstartBtn || !quickstartText) {
    console.error('QuickStart elements not found');
    return;
  }

  // å…¬é–‹çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  checkPublicationStatusAndProceed(() => {
    // ç¢ºèªå®Œäº†å¾Œã®å‡¦ç†
    executeQuickStart(quickstartBtn, quickstartText);
  }, () => {
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®å‡¦ç†
    console.log('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
  });
}

// å…¬é–‹çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function checkPublicationStatusAndProceed(onProceed, onCancel) {
  // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰å…¬é–‹çŠ¶æ…‹ã‚’ç¢ºèª
  if (currentStatus && currentStatus._normalized && currentStatus._normalized.isPublished) {
    // å…¬é–‹ä¸­ã®å ´åˆã€ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.sharedModals.showQuickStartStopConfirmation(
      () => {
        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåœæ­¢ã—ã¦æ–°è¦ä½œæˆã‚’é¸æŠ');
        if (onProceed) onProceed();
      },
      () => {
        console.log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’é¸æŠ');
        if (onCancel) onCancel();
      }
    );
  } else {
    // å…¬é–‹ã—ã¦ã„ãªã„å ´åˆã€ç›´æ¥é€²è¡Œ
    console.log('ğŸ“ å…¬é–‹ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ç›´æ¥ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹');
    if (onProceed) onProceed();
  }
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®å®Ÿéš›ã®å®Ÿè¡Œ
function executeQuickStart(quickstartBtn, quickstartText) {
  // è‡ªå‹•åœæ­¢è¨­å®šã‚’äº‹å‰ã«æº–å‚™
  const autoStopSettings = {
    enabled: true,
    minutes: 360 // 6æ™‚é–“ = 360åˆ†ï¼ˆconfig.gsã¨çµ±ä¸€ï¼‰
  };
  
  // å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆç”¨ï¼‰
  if (window.sharedModals && typeof window.sharedModals.showPublish === 'function') {
    window.sharedModals.showPublish(
      // å…¬é–‹å®Ÿè¡Œæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ - ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œ
      () => {
        console.log('ğŸ“¤ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ: å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å…¬é–‹ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        executeQuickStartProcess(quickstartBtn, quickstartText);
      },
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      () => {
        console.log('âŒ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
      },
      // è‡ªå‹•åœæ­¢è¨­å®š
      autoStopSettings
    );
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ç›´æ¥å®Ÿè¡Œ
    console.warn('âš ï¸ å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ç›´æ¥å®Ÿè¡Œã—ã¾ã™ã€‚');
    executeQuickStartProcess(quickstartBtn, quickstartText);
  }
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œ
function executeQuickStartProcess(quickstartBtn, quickstartText) {
  // Update button state
  quickstartBtn.disabled = true;
  quickstartText.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...';
  
  // Show progress bar and start simulation
  showQuickStartProgress();
  simulateQuickStartProgress();
  
  // Show loading message optimized for QuickStart
  // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆä¸­ã¯å°‚ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€æ±ç”¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è¡¨ç¤ºã—ãªã„
  
  runGasWithUserId('quickStartSetup', false)
    .then(function(result) {
      if (result && result.status === 'success') {
        // Final progress update
        updateOverallProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        updateProgressStep(6, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã™ã¹ã¦ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
        
        showMessage('âœ… ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚', 'success');
        
        // Update status after quick start
        if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
          window.unifiedCache.clear();
        }
        loadStatus(true);
        
        // ãƒ•ã‚©ãƒ¼ãƒ URLè¡¨ç¤ºã®å¼·åˆ¶æ›´æ–°ï¼ˆç®¡ç†ãƒ‘ãƒãƒ«ã®ãƒªã‚½ãƒ¼ã‚¹æ¬„ç”¨ï¼‰
        setTimeout(() => {
          updateFormUrlDisplay();
        }, 1000);
        
        // å›ç­”ãƒœãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ã‚’é€šçŸ¥ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯æ›´æ–°ç”¨ï¼‰
        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'FORM_CREATED',
              formUrl: result.formUrl,
              timestamp: Date.now()
            }, '*');
          }
          
          if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('board-updates');
            channel.postMessage({
              type: 'FORM_CREATED',
              formUrl: result.formUrl,
              timestamp: Date.now()
            });
            channel.close();
          }
        } catch (notifyError) {
          console.warn('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆé€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼:', notifyError);
        }
        
        // Reset button state
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†';
        
        // å…¬é–‹å®Œäº†ç¢ºèªã¨URLç”Ÿæˆå¾Œã«è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        setTimeout(() => {
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
          if (window.unifiedLoadingManager) {
            window.unifiedLoadingManager.setLoading(false);
          }
          
          // URLç”Ÿæˆç¢ºèªã¨ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’å®Ÿè¡Œ
          const enhancedResult = {
            ...result,
            // URLç”Ÿæˆã®å¾…æ©Ÿæ™‚é–“ã‚’å»¶é•·
            url: result?.url || '',
            autoStopMinutes: result?.autoStopMinutes || 360,
            autoStopTime: result?.autoStopTime || '',
            publicationData: {
              isPublished: result?.success || false,
              hasValidUrl: !!(result?.url && result.url.length > 0),
              timestamp: new Date().toISOString()
            }
          };
          
          console.log('ğŸ“Š QuickStartå…¬é–‹ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼:', {
            hasResult: !!result,
            hasUrl: !!(result?.url && result.url.length > 0),
            autoStopMinutes: result?.autoStopMinutes,
            enhancedResult: enhancedResult
          });
          
          // è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆæ¤œè¨¼æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã§ï¼‰
          setTimeout(() => {
            if (window.sharedModals && typeof window.sharedModals.showAutoStopConfirmation === 'function') {
              window.sharedModals.showAutoStopConfirmation(enhancedResult);
              console.log('âœ… QuickStartå…¬é–‹å¾Œã«è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼ˆURLæ¤œè¨¼æ¸ˆã¿ï¼‰');
            } else {
              console.warn('âš ï¸ è‡ªå‹•åœæ­¢ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
          }, 800); // URLç”Ÿæˆç¢ºèªã«ååˆ†ãªæ™‚é–“ã‚’ç¢ºä¿
        }, 2000);
        
        // Hide progress bar after delay and reset button
        setTimeout(() => {
          hideQuickStartProgress();
          quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
          quickstartBtn.disabled = false;
        }, 5000);
      } else {
        logWarn('QuickStart returned error result:', result);
        
        // Show error in progress
        updateProgressStep(6, 'error', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', result?.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        updateOverallProgress(0, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        let errorMessage = result?.message || 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        if (errorMessage.includes('permission') || errorMessage.includes('æ¨©é™') || 
            errorMessage.includes('Drive') || errorMessage.includes('Sheets')) {
          errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Google Drive ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ãªã„å ´åˆã€æ¨©é™ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
        }
        
        showMessage(errorMessage, 'error');
        
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
        
        // Hide progress bar after delay
        setTimeout(() => {
          hideQuickStartProgress();
        }, 3000);
      }
    })
    .catch(function(error) {
      logError('QuickStart error:', error);
      
      // Show error in progress
      updateProgressStep(6, 'error', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      updateOverallProgress(0, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      
      // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      if (error.toString().includes('permission') || error.toString().includes('æ¨©é™') || 
          error.toString().includes('Drive') || error.toString().includes('Sheets')) {
        errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Google Drive ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ãªã„å ´åˆã€æ¨©é™ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
      }
      
      if (typeof handleError === 'function') {
        handleError(error, 'handleQuickStart', errorMessage);
      } else {
        showMessage(errorMessage, 'error');
      }
      
      quickstartBtn.disabled = false;
      quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
      
      // Hide progress bar after delay
      setTimeout(() => {
        hideQuickStartProgress();
      }, 3000);
    });
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize API communications
function initializeAPI() {
  logDebug('ğŸ”§ APIåˆæœŸåŒ–é–‹å§‹');
  
  // Start background status updates
  startSystemStatusUpdate();
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);

  // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒ­ãƒ¼ãƒ‰
  logDebug('ğŸš€ loadStatus()ã‚’å‘¼ã³å‡ºã—ã¾ã™');
  loadStatus();
  
  logDebug('âœ… APIåˆæœŸåŒ–å®Œäº†');
}

// =============================================================================
// MISSING FUNCTIONS RESTORATION
// =============================================================================

// Wrapper for loadStatus to maintain compatibility
function loadSystemStatus(bypassCache = false) {
  loadStatus(bypassCache);
}

// Basic loadUserInfo implementation
function loadUserInfo() {
  logDebug('ğŸ“‹ loadUserInfo called - delegating to loadStatus');
  loadStatus();
}

// Update answer count function
function updateAnswerCount() {
  if (!currentStatus || !currentStatus._normalized || !currentStatus._normalized.isPublished) {
    return;
  }
  
  const answerCountElement = document.getElementById('answer-count');
  if (answerCountElement && currentStatus.answerCount !== undefined) {
    answerCountElement.textContent = currentStatus.answerCount || '0';
  }
}

// Setup real-time updates
function setupRealtimeUpdates() {
  // Update system status every 30 seconds
  setInterval(loadSystemStatus, 30000);
  
  // Update answer count every 10 seconds when published
  setInterval(() => {
    const publishText = document.getElementById('info-publish-text');
    if (publishText && publishText.textContent === 'å…¬é–‹ä¸­') {
      updateAnswerCount();
    }
  }, 10000);
}

// Initialize when DOM is ready
// åˆæœŸåŒ–ã¯ adminPanel-core.js ã®çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ã§ç®¡ç†ã•ã‚Œã¾ã™


</script>
