<script>
// =============================================================================
// ADMIN PANEL API COMMUNICATIONS & BACKEND CALLS
// =============================================================================

// =============================================================================
// BACKEND FUNCTION WRAPPERS
// =============================================================================

// マルチテナント対応: 新しいrunGasWithUserId関数 - ローディング機能付き
function runGasWithUserId(functionName, loadingMessage = '処理中...', ...args) {
  // ローディング表示が必要な場合は callWithLoading を使用
  if (loadingMessage && loadingMessage !== false) {
    // userIdが設定されていない場合は初期化を待つ
    if (!userId) {
      return userIdPromise.then(() => {
        if (!userId) {
          logError('No userId available for:', functionName);
          throw new Error('ユーザーIDが設定されていません。ページを再読み込みしてください。');
        }
        
        // ローディング機能付きでuserIdを第一引数として追加
        return sharedUtilities.gas.callWithLoading(functionName, loadingMessage, userId, ...args);
      }).catch((error) => {
        logError('Error in runGasWithUserId (after userIdPromise):', error);
        throw error;
      });
    }
    
    // userIdが既に設定されている場合 - ローディング機能付き
    return sharedUtilities.gas.callWithLoading(functionName, loadingMessage, userId, ...args).catch((error) => {
      logError('Error in runGasWithUserId (direct call with loading):', error);
      throw error;
    });
  }
  
  // ローディング不要の場合（loadingMessage = false）は従来通り
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        logError('No userId available for:', functionName);
        throw new Error('ユーザーIDが設定されていません。ページを再読み込みしてください。');
      }
      
      // userIdを第一引数として追加
      return gasOptimizer.call(functionName, userId, ...args);
    }).catch((error) => {
      logError('userIdPromise rejected:', error);
      throw error;
    });
  }
  
  // userIdを第一引数として追加
  return gasOptimizer.call(functionName, userId, ...args);
}

// callWithCache 関数 - 読み取り専用操作用
function callWithCache(functionName, cacheKey, ttl, ...args) {
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, ...args);
  }, ttl);
}

// runGasWithUserId with cache support
function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        throw new Error('ユーザーIDが設定されていません。');
      }
      return unifiedCache.getOrSet(cacheKey, function() {
        return gasOptimizer.call(functionName, userId, ...args);
      }, ttl);
    });
  }
  
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, userId, ...args);
  }, ttl);
}

// =============================================================================
// STATUS AND DATA LOADING
// =============================================================================

// Load system status - OPTIMIZED with integrated API
function loadStatus(bypassCache = false) {
  console.group('🔄 loadStatus - Integrated API');
  logDebug('🚀 Loading system status with integrated API, bypassCache:', bypassCache);
  logDebug('📞 About to call runGasWithUserId for getInitialData');

  // userIdPromise が解決されるのを待ってから getInitialData を呼び出す
  userIdPromise.then(() => {
    if (!userId) {
      console.error('❌ userId is not available after userIdPromise resolution in loadStatus!');
      showMessage('ユーザーIDが取得できません。ページを再読み込みしてください。', 'error');
      console.groupEnd();
      return;
    }

    logDebug('✅ userId is available:', userId);
    logDebug('🌐 Calling getInitialData with userId:', userId);

  // runGasWithUserId を使用して getInitialData を呼び出す
  // 最新のステータスを取得するため追加の引数は不要
    runGasWithUserId('getInitialData', 'システム情報を読み込み中...')
      .then(response => {
        logDebug('✅ Integrated data loaded:', response);

        // Update UI with integrated response
        updateUIWithNewStatus(response);

        // If sheet details are included, apply them immediately
        if (response.sheetDetails && response.activeSheetName) {
          logDebug('✅ Sheet details included in integrated response, applying configuration');
          try {
            populateHeaderOptions(response.sheetDetails.allHeaders);
            logDebug('✅ Header options populated from integrated data');
            populateConfig(response.sheetDetails.guessedConfig);
            logDebug('✅ AI configuration applied from integrated data');
          } catch (configError) {
            console.error('Error applying sheet configuration from integrated data:', configError);
          }
        }

        logInfo('⚡ Performance: Single API call replaced 3-4 separate calls');
      })
      .catch(error => {
        console.error('❌ Integrated API failed:', error);
        showMessage('システムステータスの読み込みに失敗しました', 'error');
      })
      .finally(() => {
        console.groupEnd();
      });
  }).catch(error => {
    console.error('❌ Error resolving userIdPromise in loadStatus:', error);
    showMessage('ユーザーIDの初期化に失敗しました。ページを再読み込みしてください。', 'error');
    console.groupEnd();
  });
}

// Load sheet configuration for selected sheet
function loadConfigForSelected() {
  if (!selectedSheet) {
    logWarn('No sheet selected for config loading');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    logError('Missing required data for loadConfigForSelected');
    showMessage('スプレッドシートの情報が見つかりません。', 'error');
    return;
  }
  
  runGasWithUserId('getSheetDetails', 'シート情報を読み込み中...', currentStatus.userInfo.spreadsheetId, selectedSheet)
    .then(handleSheetDetailsSuccess)
    .catch(handleSheetDetailsError);
}

// Handle successful sheet details loading
function handleSheetDetailsSuccess(details) {
  if (details && details.allHeaders) {
    populateHeaderOptions(details.allHeaders);
    
    // Show config area and hide placeholder
    const configArea = document.getElementById('config-area');
    const configPlaceholder = document.getElementById('config-placeholder');
    
    if (configArea) {
      configArea.classList.remove('hidden');
    }
    
    if (configPlaceholder) {
      configPlaceholder.classList.add('hidden');
    }
    
    if (details.guessedConfig) {
      // DOMの更新が完了するのを待ってからpopulateConfigを呼び出す
      setTimeout(() => {
        populateConfig(details.guessedConfig);
        showMessage('AI列判定が完了しました。設定を確認してください。', 'success');
      }, 0);
    }
  } else {
    logWarn('No headers in sheet details:', details);
    showMessage('シートの詳細情報を取得できませんでした。', 'warning');
  }
}

// Handle sheet details loading error
function handleSheetDetailsError(error) {
  logError('Sheet details failed:', error);
  handleError(error, 'loadConfigForSelected', 'シート情報の読み込みに失敗しました。');
}

// =============================================================================
// AI COLUMN DETECTION
// =============================================================================

// Run AI-powered header guessing
function runHeaderGuessing() {
  if (!selectedSheet) {
    showMessage('シートを選択してください。', 'warning');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    showMessage('スプレッドシートの情報が見つかりません。', 'error');
    return;
  }
  
  runGasWithUserId('getSheetDetails', 'AI搭載高精度列判定システムが分析中...', currentStatus.userInfo.spreadsheetId, selectedSheet)
    .then(function(details) {
      const configToUse = {
        ...details.guessedConfig,
        sheetName: selectedSheet
      };
      
      setTimeout(() => {
        populateConfig(configToUse);
        showMessage('AI列判定が完了しました！設定を確認して「保存・公開」を押してください。', 'success');
      }, 0);
    })
    .catch(function(error) {
      handleError(error, 'runHeaderGuessing', 'AI列判定に失敗しました。');
    });
}

// =============================================================================
// SAVE AND PUBLISH OPERATIONS
// =============================================================================

// Save configuration and publish board
function saveAndPublish() {
  if (!validateConfig()) {
    showMessage('必須項目（回答データ列）が選択されていません。', 'error');
    return;
  }
  
  // UIからconfigオブジェクトを構築
  const config = buildConfigObject(); // ここでconfigを取得

  // Set save protection flags to prevent interference
  isSaveInProgress = true;
  freshSaveTimestamp = Date.now();
  window.freshSaveTimestamp = freshSaveTimestamp;
  
  runGasWithUserId('saveAndPublish', '設定を保存し、ボードを公開しています...', selectedSheet, config)
    .then(function(result) {
      isSaveInProgress = false;
      
      // Check if result has data (from integrated API) or legacy success status
      if (result && (result.userInfo || result.status === 'success')) {
        showMessage('✅ 設定が保存され、ボードが公開されました！', 'success');
        
        // Use fresh data from save response if available
        if (result.userInfo && result._meta) {
          logInfo('Using fresh data from save response');
          updateUIWithNewStatus(result);
        } else {
          // Only force refresh if no fresh data available
          logInfo('No fresh data in response, forcing refresh');
          loadStatus(true);
        }
      } else {
        logError('Save failed:', result);
        showMessage(result.message || '設定の保存に失敗しました。', 'error');
        isSaveInProgress = false;
      }
    })
    .catch(function(error) {
      logError('saveAndPublish error:', error);
      isSaveInProgress = false;
      
      // Clear caches after error and reload
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      
      loadStatus(true);
      handleError(error, 'saveAndPublish', '設定の保存に失敗しました。システム状態を再読み込みしました。');
    });
}

// Unpublish board
function unpublishBoard() {
  runGasWithUserId('unpublishBoard', 'ボードの公開を停止中...')
    .then(function(response) {
      logDebug('公開停止レスポンス:', response);
      showMessage(response.message || '✅ 回答ボードの公開を停止しました。', 'success');
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      loadStatus(true); // ステータスを強制更新
    })
    .catch(function(error) {
      handleError(error, 'unpublishBoard', 'ボードの公開停止に失敗しました。');
    });
}

// =============================================================================
// FORM MANAGEMENT
// =============================================================================

// Load saved class choices
function loadSavedClassChoices() {
    runGasWithUserId('getSavedClassChoices', 'クラス選択肢を読み込み中...')
        .then(function(result) {
            if (result.status === 'success' && result.classChoices) {
                const classChoicesTextarea = document.getElementById('class-choices');
                if (classChoicesTextarea) {
                    classChoicesTextarea.value = result.classChoices.join('\n');
                }
            }
        })
        .catch(function(error) {
            console.warn('保存されたクラス選択肢の読み込みに失敗:', error.message);
            showMessage('クラス選択肢の読み込みに失敗しました。', 'error');
        });
}

// Create form with custom configuration
function createFormWithConfig() {
  const questionTextarea = document.getElementById('custom-main-question');
  const classChoicesTextarea = document.getElementById('class-choices');
  const includeOthersOption = document.getElementById('include-others-option').checked;
  
  if (!questionTextarea || !classChoicesTextarea) {
    showMessage('フォーム作成に必要な要素が見つかりません。', 'error');
    return;
  }
  
  const question = questionTextarea.value.trim();
  const classChoicesText = classChoicesTextarea.value.trim();
  
  if (!question) {
    showMessage('問題文は必須です。', 'warning');
    return;
  }
  
  if (!classChoicesText) {
    showMessage('クラス選択肢を入力してください。', 'warning');
    return;
  }
  
  const classChoices = classChoicesText.split('\n')
    .map(choice => choice.trim())
    .filter(choice => choice.length > 0);
  
  if (classChoices.length === 0) {
    showMessage('有効なクラス選択肢を入力してください。', 'warning');
    return;
  }
  
  const config = {
    mainQuestion: question, // mainQuestionは文字列として送信（バックエンドが期待する形式）
    classChoices: classChoices,
    includeOthers: includeOthersOption,
    enableClass: classChoices && classChoices.length > 0, // クラス選択肢があるかを判定
  };
  
  hideFormConfigModal();
  
  // カスタムセットアップ用進捗表示を開始
  showQuickStartProgress();
  simulateCustomFormProgressWithFolderCheck();
  
  // カスタムフォーム作成中は専用のプログレスバーを使用するため、汎用ローディングは表示しない

  // バックエンドの正しい関数を使用: createCustomForm(userEmail, userId, config)
  // userEmailは現在のユーザー情報から取得
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.adminEmail) {
    showMessage('ユーザー情報が取得できません。ページを再読み込みしてください。', 'error');
    return;
  }
  
  runGasWithUserId('createCustomFormUI', false, config)
    .then(function(result) {
      logDebug('📥 Received response from createCustomFormUI:', result);
      if (result && result.status === 'success') {
        showMessage('✅ 新しいフォームが作成され、連携されました！', 'success');
        
        // クラス選択肢をデータベースに保存
        saveClassChoicesToDatabase(classChoices);
        
        // ステータスを更新
        loadStatus(true);
        
        // モーダルを閉じる
        hideFormConfigModal();
        
        // 進捗バーを3秒後に非表示
        setTimeout(() => {
          hideQuickStartProgress();
        }, 3000);
      } else {
        console.error('❌ カスタムフォーム作成が失敗:', result);
        showMessage(result?.message || 'フォームの作成に失敗しました。', 'error');
        // 失敗時も進捗バーを非表示
        setTimeout(() => {
          hideQuickStartProgress();
        }, 2000);
      }
    })
    .catch(function(error) {
      console.error('フォーム作成エラー:', error);
      
      // 権限エラーの可能性を考慮したメッセージ
      let errorMessage = 'フォームの作成に失敗しました。';
      if (error.toString().includes('permission') || error.toString().includes('権限')) {
        errorMessage = 'フォームの作成に失敗しました。Google Drive やスプレッドシートへのアクセス権限を確認してください。';
      }
      
      showMessage(errorMessage, 'error');
      
      // エラー時も進捗バーを非表示
      setTimeout(() => {
        hideQuickStartProgress();
      }, 2000);
    });
}

// Save class choices to database
function saveClassChoicesToDatabase(classChoices) {
    runGasWithUserId('saveClassChoices', classChoices)
        .catch(function(error) {
            console.warn('クラス選択肢の保存に失敗:', error.message);
        });
}

// =============================================================================
// RESOURCE MANAGEMENT
// =============================================================================

// Add spreadsheet resource
function addResource() {
  const urlInput = document.getElementById('resource-url-input');
  if (!urlInput) {
    showMessage('URL入力フィールドが見つかりません。', 'error');
    return;
  }
  
  const url = urlInput.value.trim();
  if (!url) {
    showMessage('URLを入力してください。', 'warning');
    return;
  }

  // URLの種類を判定（スプレッドシートのみ対応）
  let resourceType = 'spreadsheet';
  let backendFunction = 'addSpreadsheetUrl';
  
  if (!url.includes('docs.google.com/spreadsheets/')) {
    showMessage('GoogleスプレッドシートのURLを入力してください。', 'warning');
    return;
  }
  
  const resourceTypeText = 'スプレッドシート';

  runGasWithUserId(backendFunction, `${resourceTypeText}を追加しています...`, url)
    .then(function(result) {
      if (result.status === 'success') {
        showMessage(result.message, 'success');
        urlInput.value = ''; // Clear input
        loadStatus(true); // Refresh status
      } else {
        showMessage(result.message || `${resourceTypeText}の追加に失敗しました。`, 'error');
      }
    })
    .catch(function(error) {
      handleError(error, 'addResource', `${resourceTypeText}の追加に失敗しました。`);
    });
}

// =============================================================================
// EXTERNAL LINKS AND NAVIGATION
// =============================================================================

// Copy board URL to clipboard
function copyBoardUrl(buttonElement) {
  const urlInput = document.getElementById('board-url');
  if (!urlInput) {
    console.error('board-url input element not found.');
    return;
  }

  const urlToCopy = urlInput.value;

  if (!urlToCopy) {
    showMessage('コピーするURLがありません。', 'warning');
    return;
  }

  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(urlToCopy).then(() => {
        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>コピー完了!';
        buttonElement.disabled = true;
        setTimeout(() => {
          buttonElement.innerHTML = originalText;
          buttonElement.disabled = false;
        }, 2000);
      }).catch((error) => {
        console.error('Clipboard API failed:', error);
        // Fallback to manual copy message
        const messageElement = document.createElement('span');
        messageElement.textContent = ' (手動でコピーしてください)';
        messageElement.style.color = 'orange';
        buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
        setTimeout(() => messageElement.remove(), 5000);
      });
    } else {
      // Fallback for browsers that don't support Clipboard API
      urlInput.select();
      urlInput.setSelectionRange(0, 99999); // For mobile devices
      document.execCommand('copy');
      showMessage('URLがクリップボードにコピーされました！', 'success'); // Fallback uses showMessage
    }
  } catch (err) {
    console.error('copyBoardUrl error:', err);
    showMessage('URLのコピーに失敗しました。手動でコピーしてください。', 'warning'); // Fallback uses showMessage
  }
}

// Copy form URL to clipboard
function copyFormUrl() {
  const urlInput = document.getElementById('form-url-input');
  if (urlInput && urlInput.value) {
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      // Try modern clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(urlInput.value).then(() => {
          showMessage('フォームURLがクリップボードにコピーされました！', 'success');
        }).catch(() => {
          // Fallback to execCommand
          document.execCommand('copy');
          showMessage('フォームURLがクリップボードにコピーされました！', 'success');
        });
      } else {
        document.execCommand('copy');
        showMessage('フォームURLがクリップボードにコピーされました！', 'success');
      }
    } catch (err) {
      showMessage('URLのコピーに失敗しました。手動でコピーしてください。', 'warning');
    }
  } else {
    showMessage('コピーするフォームURLがありません。', 'warning');
  }
}

// Open database spreadsheet
function openDatabaseSpreadsheet() {
  if (currentSpreadsheetUrl) {
    window.open(currentSpreadsheetUrl, '_blank');
  } else {
    showMessage('スプレッドシートのURLが見つかりません。', 'warning');
  }
}

// Open form
function openForm() {
  // データベースからフォームURLを取得する優先順位を設定
  let formUrl = null;
  
  // 1. ユーザー情報のformUrlから取得
  if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.formUrl) {
    formUrl = currentStatus.userInfo.formUrl;
  }
  // 2. カスタムフォーム情報から取得（後方互換性）
  else if (currentStatus && currentStatus.customFormInfo && currentStatus.customFormInfo.formUrl) {
    formUrl = currentStatus.customFormInfo.formUrl;
  }
  
  if (formUrl) {
    window.open(formUrl, '_blank');
  } else {
    showMessage('フォームのURLが見つかりません。先にフォームを作成してください。', 'warning');
  }
}

// Open app setup page
function openAppSetupPage() {
  const loadingMessage = 'アプリ設定ページを準備中...';
  const errorMessage = 'アプリ設定ページへの移動に失敗しました。';
  const timeoutMessage = 'リダイレクトがタイムアウトしました。新しいタブで開きます。';
  const fallbackMessage = 'アプリ設定ページを新しいタブで開きます。';

  runGasWithUserId('getWebAppUrl', loadingMessage)
    .then(function(webAppUrl) {
      const setupUrl = webAppUrl + '?setup=true&mode=appsetup&userId=' + encodeURIComponent(userId);

      // ユーザーにリダイレクト中であることを伝える
      showMessage('アプリ設定ページへ移動中...', 'info');
      window.unifiedLoading.showSimple('アプリ設定ページへ移動中...');

      const redirectTimeout = setTimeout(() => {
        console.warn('Redirect to app setup page timed out. Attempting fallback.');
        window.unifiedLoading.hide();
        showMessage(timeoutMessage, 'warning');
        window.open(setupUrl, '_blank'); // Fallback: open in new tab
      }, 10000); // 10秒でタイムアウト

      // 直接リダイレクトを試みる
      try {
        clearTimeout(redirectTimeout);
        window.unifiedLoading.hide();
        window.open(setupUrl, '_top'); // _top を使用して現在のウィンドウで開く
      } catch (e) {
        console.error('Error opening app setup page:', e);
        window.unifiedLoading.hide();
        showMessage(errorMessage + ' ' + (e.message || ''), 'error');
        // フォールバック: 新しいタブで開く
        showMessage(fallbackMessage, 'info');
        window.open(setupUrl, '_blank');
      }
    })
    .catch(function(error) {
      console.error('Failed to get web app URL for app setup page:', error);
      window.unifiedLoading.hide();
      showMessage('アプリ設定ページのURLを取得できませんでした。' + (error.message || ''), 'error');
    });
}

// =============================================================================
// POLLING AND REAL-TIME UPDATES
// =============================================================================

// System status polling variables
let lastUserActivity = Date.now();
let currentPollInterval = 5 * 60 * 1000; // 開始は5分間隔
let statusPollTimer = null;

// Fresh save management to prevent interference
let freshSaveTimestamp = 0;
let isSaveInProgress = false;
const FRESH_SAVE_PROTECTION_DURATION = 30000; // 30 seconds

// Make freshSaveTimestamp globally accessible
window.freshSaveTimestamp = freshSaveTimestamp;

// Get optimal polling interval based on user activity
function getOptimalPollInterval() {
  const timeSinceActivity = Date.now() - lastUserActivity;
  
  if (timeSinceActivity < 2 * 60 * 1000) { // 2分以内
    return 30 * 1000; // 30秒間隔
  } else if (timeSinceActivity < 10 * 60 * 1000) { // 10分以内
    return 2 * 60 * 1000; // 2分間隔
  } else {
    return 10 * 60 * 1000; // 10分間隔
  }
}

// Restart status polling with new interval
function restartStatusPolling() {
  if (statusPollTimer) {
    clearInterval(statusPollTimer);
  }
  currentPollInterval = getOptimalPollInterval();
  startSystemStatusUpdate();
}

// Start system status update polling
function startSystemStatusUpdate() {
  statusPollTimer = setInterval(function() {
    // UIが非表示の時は更新しない
    if (document.hidden) return;
    
    // Skip background updates if save operation is in progress or recently completed
    if (isSaveInProgress) {
      logDebug('Skipping background update: save in progress');
      return;
    }
    
    const timeSinceFreshSave = Date.now() - freshSaveTimestamp;
    if (timeSinceFreshSave < FRESH_SAVE_PROTECTION_DURATION) {
      logDebug('Skipping background update: fresh save protection active');
      return;
    }
    
    // 現在のポーリング間隔を確認し、必要に応じて調整
    const optimalInterval = getOptimalPollInterval();
    if (Math.abs(currentPollInterval - optimalInterval) > 30000) { // 30秒以上の差
      restartStatusPolling();
      return;
    }
    
    // キャッシュを利用して静かに更新
    runGasWithUserId('getStatus', false)
      .then(function(status) {
        // 変更があった場合のみUIを更新
        if (JSON.stringify(status) !== JSON.stringify(currentStatus)) {
          updateUIWithNewStatus(status);
        }
      })
      .catch(function(error) {
        logWarn('Background status update failed:', error);
      });
  }, currentPollInterval);
}

// =============================================================================
// QUICKSTART FUNCTIONALITY
// =============================================================================

// QuickStart progress management
const quickStartSteps = [
  { id: 1, text: 'ユーザー専用フォルダの作成', detail: 'フォルダ構造を準備中...' },
  { id: 2, text: 'Googleフォームとスプレッドシートの作成', detail: 'データ収集の仕組みを構築中...' },
  { id: 3, text: '回答ボードの設定と公開', detail: 'Webアプリケーションを設定中...' },
  { id: 4, text: 'セットアップ完了', detail: '利用準備が整いました！' }
];

// Show QuickStart progress bar
function showQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.remove('hidden');
    resetProgressSteps();
  }
}

// Hide QuickStart progress bar
function hideQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.add('hidden');
  }
}

// Reset all progress steps to initial state
function resetProgressSteps() {
  quickStartSteps.forEach(step => {
    updateProgressStep(step.id, 'waiting', step.text, '待機中...');
  });
  updateOverallProgress(0, '初期化中...');
}

// Update individual progress step
function updateProgressStep(stepId, status, text, detail) {
  const stepElement = document.getElementById(`progress-step-${stepId}`);
  const dotElement = document.getElementById(`progress-step-${stepId}-dot`);
  const textElement = document.getElementById(`progress-step-${stepId}-text`);
  const detailElement = document.getElementById(`progress-step-${stepId}-detail`);
  
  if (!stepElement || !dotElement || !textElement || !detailElement) return;
  
  // Update text and detail
  textElement.textContent = text;
  detailElement.textContent = detail;
  
  // Update visual state based on status
  switch (status) {
    case 'waiting':
      dotElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      textElement.className = 'text-sm text-gray-300';
      detailElement.className = 'text-xs text-gray-500';
      break;
    case 'active':
      dotElement.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse';
      textElement.className = 'text-sm text-emerald-300 font-medium';
      detailElement.className = 'text-xs text-emerald-400';
      break;
    case 'completed':
      dotElement.className = 'w-2 h-2 rounded-full bg-green-400';
      textElement.className = 'text-sm text-green-300 font-medium';
      detailElement.className = 'text-xs text-green-400';
      break;
    case 'error':
      dotElement.className = 'w-2 h-2 rounded-full bg-red-400';
      textElement.className = 'text-sm text-red-300 font-medium';
      detailElement.className = 'text-xs text-red-400';
      break;
  }
}

// Update overall progress bar
function updateOverallProgress(percentage, statusMessage) {
  const progressBar = document.getElementById('progress-bar');
  const progressPercentage = document.getElementById('progress-percentage');
  const progressStatus = document.getElementById('progress-status');
  
  if (progressBar) {
    progressBar.style.width = `${percentage}%`;
  }
  
  if (progressPercentage) {
    progressPercentage.textContent = `${percentage}%`;
  }
  
  if (progressStatus) {
    progressStatus.textContent = statusMessage;
  }
}

// Simulate QuickStart progress (for demonstration)
function simulateQuickStartProgress() {
  // Step 1: Folder creation
  updateProgressStep(1, 'active', 'ユーザー専用フォルダの作成', 'フォルダ構造を準備中...');
  updateOverallProgress(10, 'フォルダを作成しています...');
  
  setTimeout(() => {
    updateProgressStep(1, 'completed', 'ユーザー専用フォルダの作成', '✅ フォルダが作成されました');
    updateProgressStep(2, 'active', 'Googleフォームとスプレッドシートの作成', 'データ収集の仕組みを構築中...');
    updateOverallProgress(35, 'フォームとスプレッドシートを作成しています...');
  }, 1500);
  
  setTimeout(() => {
    updateProgressStep(2, 'completed', 'Googleフォームとスプレッドシートの作成', '✅ フォームとスプレッドシートが作成されました');
    updateProgressStep(3, 'active', '回答ボードの設定と公開', 'Webアプリケーションを設定中...');
    updateOverallProgress(70, '回答ボードを設定しています...');
  }, 3000);
  
  setTimeout(() => {
    updateProgressStep(3, 'completed', '回答ボードの設定と公開', '✅ 回答ボードが公開されました');
    updateProgressStep(4, 'active', 'セットアップ完了', '利用準備が整いました！');
    updateOverallProgress(100, 'セットアップが完了しました！');
  }, 4500);
  
  setTimeout(() => {
    updateProgressStep(4, 'completed', 'セットアップ完了', '🎉 すべての準備が整いました！');
  }, 5000);
}

// Progress simulation for custom forms with folder check
function simulateCustomFormProgressWithFolderCheck() {
  // Step 1: フォルダ作成・チェック
  updateProgressStep(1, 'active', 'ユーザー専用フォルダの作成・確認', 'フォルダ構造を準備中...');
  updateOverallProgress(10, 'フォルダをチェック・作成しています...');
  
  // 実際にフォルダチェック・作成APIを呼び出し
  runGasWithUserId('createUserFolder', 'フォルダを確認・作成中...')
    .then(function(folderResult) {
      updateProgressStep(1, 'completed', 'ユーザー専用フォルダの作成・確認', '✅ フォルダが準備されました');
      updateProgressStep(2, 'active', 'Googleフォームとスプレッドシートの作成', 'データ収集の仕組みを構築中...');
      updateOverallProgress(35, 'フォームとスプレッドシートを作成しています...');
      
      // Step 2: フォーム・スプレッドシート作成は元の処理に続く
      setTimeout(() => {
        updateProgressStep(2, 'completed', 'Googleフォームとスプレッドシートの作成', '✅ フォームとスプレッドシートが作成されました');
        updateProgressStep(3, 'active', '回答ボードの設定と公開', 'Webアプリケーションを設定中...');
        updateOverallProgress(70, '回答ボードを設定しています...');
      }, 2000);
    })
    .catch(function(error) {
      updateProgressStep(1, 'error', 'ユーザー専用フォルダの作成・確認', '⚠️ フォルダ作成でエラーが発生しましたが処理を続行します');
      console.error('Folder creation failed:', error);
      showMessage('フォルダの作成に失敗しました。処理を続行します。', 'warning');
      
      // エラーでも処理を続行
      setTimeout(() => {
        updateProgressStep(2, 'active', 'Googleフォームとスプレッドシートの作成', 'データ収集の仕組みを構築中...');
        updateOverallProgress(35, 'フォームとスプレッドシートを作成しています...');
        
        setTimeout(() => {
          updateProgressStep(2, 'completed', 'Googleフォームとスプレッドシートの作成', '✅ フォームとスプレッドシートが作成されました');
          updateProgressStep(3, 'active', '回答ボードの設定と公開', 'Webアプリケーションを設定中...');
          updateOverallProgress(70, '回答ボードを設定しています...');
        }, 2000);
      }, 1000);
    });
}

// Simulate Custom Form creation progress
function simulateCustomFormProgress() {
  // Step 1: Form creation
  updateProgressStep(1, 'active', 'カスタムフォームの作成', 'Googleフォームを作成中...');
  updateOverallProgress(15, 'フォームを作成しています...');
  
  setTimeout(() => {
    updateProgressStep(1, 'completed', 'カスタムフォームの作成', '✅ フォームが作成されました');
    updateProgressStep(2, 'active', 'スプレッドシート連携', 'データ収集の設定中...');
    updateOverallProgress(50, 'スプレッドシートと連携しています...');
  }, 2000);
  
  setTimeout(() => {
    updateProgressStep(2, 'completed', 'スプレッドシート連携', '✅ スプレッドシートが連携されました');
    updateProgressStep(3, 'active', '列名の自動設定', 'AI による列名設定中...');
    updateOverallProgress(80, '列名を自動設定しています...');
  }, 4000);
  
  setTimeout(() => {
    updateProgressStep(3, 'completed', '列名の自動設定', '✅ 列名が自動設定されました');
    updateProgressStep(4, 'active', '設定完了', '確認準備が整いました！');
    updateOverallProgress(100, 'カスタムフォーム作成完了！');
  }, 6000);
  
  setTimeout(() => {
    updateProgressStep(4, 'completed', '設定完了', '🎉 設定をご確認ください！');
  }, 6500);
}

// Handle quick start setup
function handleQuickStart() {
  const quickstartBtn = document.getElementById('quickstart-btn');
  const quickstartText = document.getElementById('quickstart-text');
  
  if (!quickstartBtn || !quickstartText) {
    console.error('QuickStart elements not found');
    return;
  }
  
  // Update button state
  quickstartBtn.disabled = true;
  quickstartText.textContent = 'セットアップ中...';
  
  // Show progress bar and start simulation
  showQuickStartProgress();
  simulateQuickStartProgress();
  
  // Show loading message optimized for QuickStart
  // クイックスタート中は専用のプログレスバーを使用するため、汎用ローディングは表示しない
  
  runGasWithUserId('quickStartSetup', false)
    .then(function(result) {
      if (result && result.status === 'success') {
        // Final progress update
        updateOverallProgress(100, 'セットアップが完了しました！');
        updateProgressStep(4, 'completed', 'セットアップ完了', '🎉 すべての準備が整いました！');
        
        showMessage('✅ クイックスタートが完了しました！フォームとボードが自動作成されました。', 'success');
        
        // Update status after quick start
        if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
          window.unifiedCache.clear();
        }
        loadStatus(true);
        
        // Reset button state
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'クイックスタート完了';
        
        // Hide progress bar after delay and reset button
        setTimeout(() => {
          hideQuickStartProgress();
          quickstartText.textContent = 'クイックスタートを開始';
          quickstartBtn.disabled = false;
        }, 5000);
      } else {
        logWarn('QuickStart returned error result:', result);
        
        // Show error in progress
        updateProgressStep(4, 'error', 'セットアップエラー', result?.message || 'エラーが発生しました');
        updateOverallProgress(0, 'セットアップに失敗しました');
        
        // 権限エラーの可能性を考慮したメッセージ
        let errorMessage = result?.message || 'クイックスタートに失敗しました。';
        if (errorMessage.includes('permission') || errorMessage.includes('権限') || 
            errorMessage.includes('Drive') || errorMessage.includes('Sheets')) {
          errorMessage = 'クイックスタートに失敗しました。Google Drive やスプレッドシートへのアクセス権限を確認してください。システム管理者でない場合、権限が制限されている可能性があります。';
        }
        
        showMessage(errorMessage, 'error');
        
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'クイックスタートを開始';
        
        // Hide progress bar after delay
        setTimeout(() => {
          hideQuickStartProgress();
        }, 3000);
      }
    })
    .catch(function(error) {
      logError('QuickStart error:', error);
      
      // Show error in progress
      updateProgressStep(4, 'error', 'セットアップエラー', '通信エラーが発生しました');
      updateOverallProgress(0, 'セットアップに失敗しました');
      
      // 権限エラーの可能性を考慮したメッセージ
      let errorMessage = 'クイックスタートに失敗しました。';
      if (error.toString().includes('permission') || error.toString().includes('権限') || 
          error.toString().includes('Drive') || error.toString().includes('Sheets')) {
        errorMessage = 'クイックスタートに失敗しました。Google Drive やスプレッドシートへのアクセス権限を確認してください。システム管理者でない場合、権限が制限されている可能性があります。';
      }
      
      if (typeof handleError === 'function') {
        handleError(error, 'handleQuickStart', errorMessage);
      } else {
        showMessage(errorMessage, 'error');
      }
      
      quickstartBtn.disabled = false;
      quickstartText.textContent = 'クイックスタートを開始';
      
      // Hide progress bar after delay
      setTimeout(() => {
        hideQuickStartProgress();
      }, 3000);
    });
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize API communications
function initializeAPI() {
  logDebug('🔧 API初期化開始');
  
  // Start background status updates
  startSystemStatusUpdate();
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);

  // 初回ロード時にシステムステータスをロード
  logDebug('🚀 loadStatus()を呼び出します');
  loadStatus();
  
  logDebug('✅ API初期化完了');
}

// Setup real-time updates
function setupRealtimeUpdates() {
  // Update system status every 30 seconds
  setInterval(loadSystemStatus, 30000);
  
  // Update answer count every 10 seconds when published
  setInterval(() => {
    const publishText = document.getElementById('info-publish-text');
    if (publishText && publishText.textContent === '公開中') {
      updateAnswerCount();
    }
  }, 10000);
}

// Initialize when DOM is ready
// 初期化は adminPanel-core.js の統合初期化システムで管理されます


// Load user information
function loadUserInfo() {
  if (typeof sharedUtilities.gas.callWithLoading === 'function') {
    sharedUtilities.gas.callWithLoading('getUserInfo', 'ユーザー情報を読み込み中...')
      .then(userInfo => {
        if (userInfo) {
          document.getElementById('info-admin-email').textContent = userInfo.email || '-';
          document.getElementById('info-user-id').textContent = userInfo.userId || '-';
        }
      })
      .catch(error => {
        console.error('Failed to load user info:', error);
        showMessage('ユーザー情報の読み込みに失敗しました。', 'error');
      });
  }
}

// Load system status
function loadSystemStatus() {
  if (typeof sharedUtilities.gas.callWithLoading === 'function') {
    sharedUtilities.gas.callWithLoading('getAppConfig', 'システム設定を読み込み中...')
      .then(status => {
        updateSystemStatusDisplay(status);
      })
      .catch(error => {
        console.error('Failed to load system status:', error);
        showMessage('システム設定の読み込みに失敗しました。', 'error');
      });
  }
}

// Update answer count
function updateAnswerCount() {
  if (currentStatus && typeof currentStatus.answerCount !== 'undefined') {
    document.getElementById('info-answer-count').textContent = currentStatus.answerCount || '0';
  }
}
</script>
