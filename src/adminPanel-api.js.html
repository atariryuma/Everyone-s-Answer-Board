<script>
// =============================================================================
// ADMIN PANEL API COMMUNICATIONS & BACKEND CALLS
// =============================================================================

// =============================================================================
// BACKEND FUNCTION WRAPPERS
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: æ–°ã—ã„runGasWithUserIdé–¢æ•° - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ã
function runGasWithUserId(functionName, loadingMessage = 'å‡¦ç†ä¸­...', ...args) {
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãŒå¿…è¦ãªå ´åˆã¯ callWithLoading ã‚’ä½¿ç”¨
  if (loadingMessage && loadingMessage !== false) {
    // userIdãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–ã‚’å¾…ã¤
    if (!userId) {
      return userIdPromise.then(() => {
        if (!userId) {
          logError('No userId available for:', functionName);
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ãã§userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ  - Admin Panel uses overlay loading
        return sharedUtilities.gas.callWithLoading(functionName, loadingMessage, 'overlay', userId, ...args);
      }).catch((error) => {
        logError('Error in runGasWithUserId (after userIdPromise):', error);
        throw error;
      });
    }
    
    // userIdãŒæ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ã - Admin Panel uses overlay loading
    return sharedUtilities.gas.callWithLoading(functionName, loadingMessage, 'overlay', userId, ...args).catch((error) => {
      logError('Error in runGasWithUserId (direct call with loading):', error);
      throw error;
    });
  }
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸è¦ã®å ´åˆï¼ˆloadingMessage = falseï¼‰ã¯å¾“æ¥é€šã‚Š
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        logError('No userId available for:', functionName);
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }
      
      // userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ 
      return gasOptimizer.call(functionName, userId, ...args);
    }).catch((error) => {
      logError('userIdPromise rejected:', error);
      throw error;
    });
  }
  
  // userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ 
  return gasOptimizer.call(functionName, userId, ...args);
}

// callWithCache é–¢æ•° - èª­ã¿å–ã‚Šå°‚ç”¨æ“ä½œç”¨
function callWithCache(functionName, cacheKey, ttl, ...args) {
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, ...args);
  }, ttl);
}

// runGasWithUserId with cache support
function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
      return unifiedCache.getOrSet(cacheKey, function() {
        return gasOptimizer.call(functionName, userId, ...args);
      }, ttl);
    });
  }
  
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, userId, ...args);
  }, ttl);
}

// =============================================================================
// STATUS AND DATA LOADING
// =============================================================================

// Load system status - OPTIMIZED with integrated API
// Load system status - OPTIMIZED with integrated API
function loadStatus(bypassCache = false) {
  console.group('ğŸ”„ loadStatus - Integrated API');
  logDebug('ğŸš€ Loading system status with integrated API, bypassCache:', bypassCache);
  logDebug('ğŸ“ About to call runGasWithUserId for getAppConfig'); // getInitialData -> getAppConfig

  // userIdPromise ãŒè§£æ±ºã•ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰ getAppConfig ã‚’å‘¼ã³å‡ºã™
  return userIdPromise.then(() => {
    if (!userId) {
      console.error('âŒ userId is not available after userIdPromise resolution in loadStatus!');
      showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
      console.groupEnd();
      return Promise.reject(new Error('userId is not available'));
    }

    logDebug('âœ… userId is available:', userId);
    logDebug('ğŸŒ Calling getAppConfig with userId:', userId); // getInitialData -> getAppConfig

    // runGasWithUserId ã‚’ä½¿ç”¨ã—ã¦ getAppConfig ã‚’å‘¼ã³å‡ºã™
    // æœ€æ–°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ã™ã‚‹ãŸã‚è¿½åŠ ã®å¼•æ•°ã¯ä¸è¦
    console.log('DEBUG: Calling getAppConfig via runGasWithUserId'); // â˜…è¿½åŠ 
    return runGasWithUserId('getAppConfig', 'ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...') // getInitialData -> getAppConfig
      .then(response => {
        logDebug('âœ… Integrated data loaded:', response);

        // Update UI with integrated response
        try {
          if (typeof updateUIWithNewStatus === 'function') {
            updateUIWithNewStatus(response);
          } else {
            console.error('âŒ updateUIWithNewStatusé–¢æ•°ãŒæœªå®šç¾©ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†å®Ÿè¡Œ');
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã‚’æ›´æ–°
            emergencyUpdateDatabaseInfo(response);
          }
        } catch (updateError) {
          console.error('âŒ updateUIWithNewStatuså®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', updateError);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã‚’æ›´æ–°
          emergencyUpdateDatabaseInfo(response);
        }

        // If sheet details are included, apply them immediately
        if (response.sheetDetails && response.activeSheetName) {
          logDebug('âœ… Sheet details included in integrated response, applying configuration');
          try {
            populateHeaderOptions(response.sheetDetails.allHeaders);
            logDebug('âœ… Header options populated from integrated data');
            populateConfig(response.sheetDetails.guessedConfig);
            logDebug('âœ… AI configuration applied from integrated data');
          } catch (configError) {
            console.error('Error applying sheet configuration from integrated data:', configError);
          }
        }

        logInfo('âš¡ Performance: Single API call replaced 3-4 separate calls');
        return response; // Promiseãƒã‚§ãƒ¼ãƒ³ã‚’ç¶­æŒã™ã‚‹ãŸã‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
      })
      .catch(error => {
        console.error('âŒ Integrated API failed:', error);
        showMessage('ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        throw error; // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
      })
      .finally(() => {
        console.groupEnd();
      });
  }).catch(error => {
    console.error('âŒ Error resolving userIdPromise in loadStatus:', error);
    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    console.groupEnd();
    throw error; // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
  });
}

// ğŸš¨ ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±æ›´æ–°
function emergencyUpdateDatabaseInfo(response) {
  console.log('ğŸš¨ emergencyUpdateDatabaseInfo: é–‹å§‹');
  
  try {
    if (!response || !response.userInfo) {
      console.error('âŒ emergencyUpdateDatabaseInfo: response.userInfoãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // ç›´æ¥DOMè¦ç´ ã‚’æ›´æ–°
    const updateElement = (id, value) => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = value || '-';
        console.log(`âœ… ${id} = "${value}"`);
      } else {
        console.error(`âŒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${id}`);
      }
    };
    
    // åŸºæœ¬æƒ…å ±ã®æ›´æ–°
    updateElement('info-admin-email', response.userInfo.adminEmail);
    updateElement('info-user-id', response.userInfo.userId);
    updateElement('info-answer-count', response.answerCount || '0');
    
    // å…¬é–‹ã‚·ãƒ¼ãƒˆåã®æ›´æ–°
    const publishedSheetName = (response.config && response.config.publishedSheetName) || 
                              response.publishedSheetName || 'ãªã—';
    updateElement('info-published-sheet', publishedSheetName);
    
    // ä½œæˆæ—¥ã¨æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ—¥
    if (response.userInfo.createdAt) {
      const createdAt = new Date(response.userInfo.createdAt).toLocaleDateString('ja-JP');
      updateElement('info-created-at', createdAt);
    }
    
    if (response.userInfo.lastAccessedAt) {
      const lastAccessed = new Date(response.userInfo.lastAccessedAt).toLocaleDateString('ja-JP');
      updateElement('info-last-access', lastAccessed);
    }
    
    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
    const displayMode = (response.config && response.config.showNames) ? 'åå‰è¡¨ç¤º' : 'åŒ¿åè¡¨ç¤º';
    updateElement('info-display-mode', displayMode);
    
    // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º
    const showCounts = (response.config && response.config.showCounts) ? 'è¡¨ç¤º' : 'éè¡¨ç¤º';
    updateElement('info-show-counts', showCounts);
    
    console.log('âœ… emergencyUpdateDatabaseInfo: å®Œäº†');
    
  } catch (error) {
    console.error('âŒ emergencyUpdateDatabaseInfo: ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// Load sheet configuration for selected sheet
function loadConfigForSelected() {
  if (!selectedSheet) {
    logWarn('No sheet selected for config loading');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    logError('Missing required data for loadConfigForSelected');
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  runGasWithUserId('getSheetDetails', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
    .then(handleSheetDetailsSuccess)
    .catch(handleSheetDetailsError);
}

// Handle successful sheet details loading
function handleSheetDetailsSuccess(details) {
  if (details && details.allHeaders) {
    populateHeaderOptions(details.allHeaders);
    
    // Show config area and hide placeholder
    const configArea = document.getElementById('config-area');
    const configPlaceholder = document.getElementById('config-placeholder');
    
    if (configArea) {
      configArea.classList.remove('hidden');
    }
    
    if (configPlaceholder) {
      configPlaceholder.classList.add('hidden');
    }
    
    if (details.guessedConfig) {
      // DOMã®æ›´æ–°ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰populateConfigã‚’å‘¼ã³å‡ºã™
      setTimeout(() => {
        populateConfig(details.guessedConfig);
        
        // Enhanced auto-detection success message with specifics
        const detectedColumns = [];
        if (details.guessedConfig.opinionColumn) detectedColumns.push(`å›ç­”åˆ—: ${details.guessedConfig.opinionColumn}`);
        if (details.guessedConfig.nameColumn) detectedColumns.push(`åå‰åˆ—: ${details.guessedConfig.nameColumn}`);
        if (details.guessedConfig.classColumn) detectedColumns.push(`ã‚¯ãƒ©ã‚¹åˆ—: ${details.guessedConfig.classColumn}`);
        
        const message = detectedColumns.length > 0 
          ? `ğŸ¤– AIåˆ—åˆ¤å®šãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼æ¤œå‡ºã•ã‚ŒãŸåˆ—: ${detectedColumns.join(', ')}ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
          : 'ğŸ¤– AIåˆ—åˆ¤å®šãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        
        showMessage(message, 'success');
      }, 0);
    }
  } else {
    logWarn('No headers in sheet details:', details);
    showMessage('ã‚·ãƒ¼ãƒˆã®è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'warning');
  }
}

// Handle sheet details loading error
function handleSheetDetailsError(error) {
  logError('Sheet details failed:', error);
  handleError(error, 'loadConfigForSelected', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
}

// =============================================================================
// AI COLUMN DETECTION
// =============================================================================

// Run AI-powered header guessing
function runHeaderGuessing() {
  if (!selectedSheet) {
    showMessage('ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  // Update button state to show AI is working
  const reguessBtn = document.getElementById('reguess-headers-btn');
  if (reguessBtn) {
    const originalContent = reguessBtn.innerHTML;
    reguessBtn.disabled = true;
    reguessBtn.innerHTML = `
      <span class="relative z-10 flex items-center gap-1">
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <span class="text-xs font-bold">AIåˆ†æä¸­</span>
      </span>
    `;
    
    // Restore button after completion
    const restoreButton = () => {
      reguessBtn.disabled = false;
      reguessBtn.innerHTML = originalContent;
    };
    
    // Show start notification
    showMessage('ğŸ¤– é«˜ç²¾åº¦AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...', 'info');
    
    runGasWithUserId('getSheetDetails', 'AIæ­è¼‰é«˜ç²¾åº¦åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãŒåˆ†æä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
      .then(function(details) {
        if (!details || !details.guessedConfig) {
          restoreButton();
          showMessage('âŒ AIåˆ—åˆ¤å®šãŒå¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'warning');
          return;
        }
        
        const configToUse = {
          ...details.guessedConfig,
          sheetName: selectedSheet
        };
        
        setTimeout(() => {
          populateConfig(configToUse);
          restoreButton();
          
          // Enhanced completion notification with analysis details
          const detectedColumns = [];
          if (configToUse.opinionColumn) detectedColumns.push(`ğŸ’¬ å›ç­”åˆ—: ${configToUse.opinionColumn}`);
          if (configToUse.nameColumn) detectedColumns.push(`ğŸ‘¤ åå‰åˆ—: ${configToUse.nameColumn}`);
          if (configToUse.classColumn) detectedColumns.push(`ğŸ« ã‚¯ãƒ©ã‚¹åˆ—: ${configToUse.classColumn}`);
          if (configToUse.reasonColumn) detectedColumns.push(`ğŸ’­ ç†ç”±åˆ—: ${configToUse.reasonColumn}`);
          
          const message = detectedColumns.length > 0 
            ? `ğŸ‰ é«˜ç²¾åº¦AIåˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\næ¤œå‡ºã•ã‚ŒãŸåˆ—:\n${detectedColumns.join('\n')}\n\nè‡ªå‹•çš„ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã—ã¾ã™...`
            : 'ğŸ‰ é«˜ç²¾åº¦AIåˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼è‡ªå‹•çš„ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã—ã¾ã™...';
          
          showMessage(message, 'success');
          
          // âœ¨ é‡è¦: AIåˆ¤å®šå®Œäº†å¾Œã«è‡ªå‹•çš„ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†
          setTimeout(() => {
            console.log('ğŸš€ AIåˆ¤å®šå®Œäº† - è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å‡¦ç†ã‚’é–‹å§‹');
            
            // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦å¿…è¦ãªå ´åˆã®ã¿å®Ÿè¡Œ
            if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
              const config = getConfigJSON(currentStatus.userInfo);
              
              if (config.setupStatus === 'pending' || !config.formCreated) {
                console.log('ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†çŠ¶æ…‹ã‚’æ¤œå‡º - è‡ªå‹•å®Œäº†ã‚’å®Ÿè¡Œ');
                completeAIDetectionProcess();
              } else {
                console.log('âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯æ—¢ã«å®Œäº†æ¸ˆã¿ - è‡ªå‹•å®Œäº†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
              }
            } else {
              console.log('ğŸ”§ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ãŒä¸æ˜ - å¿µã®ãŸã‚è‡ªå‹•å®Œäº†ã‚’å®Ÿè¡Œ');
              completeAIDetectionProcess();
            }
          }, 1000);
        }, 100);
      })
      .catch(function(error) {
        restoreButton();
        console.error('AI column detection error:', error);
        
        // Enhanced error message with specific guidance
        let errorMessage = 'âŒ é«˜ç²¾åº¦AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n';
        if (error?.message?.includes('permission') || error?.message?.includes('æ¨©é™')) {
          errorMessage += 'ğŸ“‹ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        } else if (error?.message?.includes('network') || error?.message?.includes('timeout')) {
          errorMessage += 'ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
        } else {
          errorMessage += 'âš™ï¸ æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã™ã‚‹ã‹ã€å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        }
        
        errorMessage += '\n\nğŸ’¡ å•é¡ŒãŒç¶šãå ´åˆã¯ã€ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
        
        showMessage(errorMessage, 'error');
      });
  }
}

// âœ¨ AIåˆ¤å®šå®Œäº†å¾Œã®è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å‡¦ç†
function completeAIDetectionProcess() {
  try {
    console.log('ğŸ”§ AIåˆ¤å®šå®Œäº† - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è‡ªå‹•å®Œäº†ã‚’å®Ÿè¡Œä¸­...');
    
    // 1. è¨­å®šæ¤œè¨¼
    if (!validateConfig()) {
      console.warn('âš ï¸ AIåˆ¤å®šçµæœã®è¨­å®šãŒä¸å®Œå…¨ - æ‰‹å‹•è¨­å®šãŒå¿…è¦');
      showMessage('AIåˆ¤å®šçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚è¨­å®šã«ä¸å‚™ãŒã‚ã‚Šã¾ã™ã€‚', 'warning');
      return;
    }
    
    // 2. ãƒ•ã‚©ãƒ¼ãƒ URLæ¤œå‡ºãƒ»ä½œæˆã®å®Ÿè¡Œ
    console.log('ğŸ” ãƒ•ã‚©ãƒ¼ãƒ URLæ¤œå‡ºã‚’å®Ÿè¡Œä¸­...');
    
    runGasWithUserId('detectFormUrlFromSpreadsheet', 'ãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
      .then(result => {
        console.log('ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºçµæœ:', result);
        
        if (result && result.success && result.formUrl) {
          console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ URLæ¤œå‡ºæˆåŠŸ:', result.formUrl);
          
          // 3. è¨­å®šã®è‡ªå‹•ä¿å­˜ã¨å®Œäº†çŠ¶æ…‹ã¸ã®æ›´æ–°
          const config = buildConfigObject();
          config.formUrl = result.formUrl;
          config.formCreated = true;
          config.setupStatus = 'completed';
          
          console.log('ğŸ’¾ AIåˆ¤å®šå®Œäº†å¾Œã®è¨­å®šã‚’è‡ªå‹•ä¿å­˜ä¸­...', config);
          
          return runGasWithUserId('saveSheetConfig', 'è¨­å®šä¿å­˜ä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet, config);
        } else {
          throw new Error('ãƒ•ã‚©ãƒ¼ãƒ URLã®æ¤œå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .then(saveResult => {
        if (saveResult && saveResult.success) {
          console.log('âœ… AIåˆ¤å®šå®Œäº† - è¨­å®šè‡ªå‹•ä¿å­˜å®Œäº†');
          showMessage('ğŸ‰ AIåˆ¤å®šã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒè‡ªå‹•å®Œäº†ã—ã¾ã—ãŸï¼', 'success');
          
          // 4. UIçŠ¶æ…‹ã®æ›´æ–°
          if (typeof loadSystemStatus === 'function') {
            loadSystemStatus();
          }
          
          // 5. ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºã®æ›´æ–°
          if (typeof navigateToStep === 'function') {
            navigateToStep(3); // ã‚¹ãƒ†ãƒƒãƒ—3ï¼ˆè¡¨ç¤ºè¨­å®šï¼‰ã«é€²ã‚€
          }
          
        } else {
          throw new Error(saveResult?.message || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ AIåˆ¤å®šå®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
        showMessage(`âš ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®è‡ªå‹•å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}\næ‰‹å‹•ã§ã€Œä¿å­˜ãƒ»å…¬é–‹ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚`, 'warning');
      });
      
  } catch (error) {
    console.error('âŒ completeAIDetectionProcess è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:', error);
    showMessage('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è‡ªå‹•å®Œäº†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
  }
}

// âœ¨ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã®è¨ºæ–­ãƒ»ä¿®å¾©æ©Ÿèƒ½
function repairSetupStateInconsistencies() {
  return new Promise((resolve, reject) => {
    try {
      console.log('ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã®è¨ºæ–­ãƒ»ä¿®å¾©ã‚’é–‹å§‹...');
      
      if (!currentStatus || !currentStatus.userInfo) {
        reject(new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'));
        return;
      }
      
      // getConfigJSONé–¢æ•°ã®ä»£æ›¿å‡¦ç†ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é–¢æ•°ãŒæœªå®šç¾©ã®ãŸã‚ï¼‰
      let config;
      try {
        if (currentStatus.userInfo.configJson) {
          config = JSON.parse(currentStatus.userInfo.configJson);
        } else {
          config = {};
        }
      } catch (parseError) {
        console.error('âŒ ConfigJSON parse error:', parseError);
        config = {};
      }
        
      const issues = [];
      const fixes = [];
      
      // 1. ãƒ•ã‚©ãƒ¼ãƒ URL vs formCreated ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (config.formUrl && config.formUrl.trim() && !config.formCreated) {
        issues.push('ãƒ•ã‚©ãƒ¼ãƒ URLãŒå­˜åœ¨ã™ã‚‹ãŒ formCreated=false');
        config.formCreated = true;
        fixes.push('formCreated ã‚’ true ã«ä¿®æ­£');
      }
      
      // 2. formCreated vs setupStatus ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (config.formCreated && config.setupStatus !== 'completed') {
        issues.push('ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆæ¸ˆã¿ã ãŒ setupStatus != completed');
        config.setupStatus = 'completed';
        fixes.push('setupStatus ã‚’ completed ã«ä¿®æ­£');
      }
      
      // 3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¨activeSheetNameã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (currentStatus.userInfo.spreadsheetId && !currentStatus.activeSheetName && selectedSheet) {
        issues.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹ãŒ activeSheetName ãŒæœªè¨­å®š');
        // ã“ã‚Œã¯configã§ã¯ãªãstatusã®å•é¡Œãªã®ã§ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ä¿®æ­£ãŒå¿…è¦
        fixes.push('activeSheetName ã®æ›´æ–°ãŒå¿…è¦ï¼ˆè¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ï¼‰');
      }
      
      // 4. å…¬é–‹çŠ¶æ…‹ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆpublishedSheetName vs appPublishedï¼‰
      if (config.publishedSheetName && !config.appPublished) {
        issues.push('å…¬é–‹ã‚·ãƒ¼ãƒˆåãŒå­˜åœ¨ã™ã‚‹ãŒ appPublished=false');
        // ã“ã‚Œã¯æ…é‡ã«åˆ¤æ–­ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€è­¦å‘Šã®ã¿
        fixes.push('æ³¨æ„: å…¬é–‹çŠ¶æ…‹ã®ç¢ºèªãŒå¿…è¦');
      }
      
      // 5. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: appPublished=true ã ãŒ setupStatus='pending' ã®å ´åˆï¼ˆå…¬é–‹æ¸ˆã¿ä¸æ•´åˆï¼‰
      if (config.appPublished && config.setupStatus === 'pending') {
        issues.push('å…¬é–‹æ¸ˆã¿ã ãŒ setupStatus=pending');
        config.setupStatus = 'completed';
        fixes.push('setupStatus ã‚’ completed ã«ä¿®æ­£ï¼ˆæ—¢ã«å…¬é–‹æ¸ˆã¿ã®ãŸã‚ï¼‰');
      }
      
      // 6. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: å…¬é–‹URLãŒå­˜åœ¨ã™ã‚‹ãŒ formCreated=false ã®å ´åˆ
      if (currentStatus.viewUrl && currentStatus.viewUrl.trim() && !config.formCreated) {
        issues.push('å…¬é–‹URLãŒå­˜åœ¨ã™ã‚‹ãŒ formCreated=false');
        config.formCreated = true;
        fixes.push('formCreated ã‚’ true ã«ä¿®æ­£ï¼ˆå…¬é–‹URLå­˜åœ¨ã®ãŸã‚ï¼‰');
      }
      
      // 7. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: isPublished=true ã ãŒ setupStatus='pending' ã®å ´åˆï¼ˆã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ä¸æ•´åˆï¼‰
      if (currentStatus.isPublished && config.setupStatus === 'pending') {
        issues.push('ã‚·ã‚¹ãƒ†ãƒ ã§å…¬é–‹æ¸ˆã¿åˆ¤å®šã ãŒ setupStatus=pending');
        config.setupStatus = 'completed';
        fixes.push('setupStatus ã‚’ completed ã«ä¿®æ­£ï¼ˆå…¬é–‹çŠ¶æ…‹ç¢ºèªæ¸ˆã¿ï¼‰');
      }
      
      // 8. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: AIåˆ¤å®šçµæœãŒå­˜åœ¨ã™ã‚‹ãŒsetupStatus='pending'ã®å ´åˆï¼ˆAIå®Œäº†å¾Œã®çŠ¶æ…‹æ›´æ–°æ¼ã‚Œï¼‰
      if (currentStatus.sheetDetails?.guessedConfig && 
          currentStatus.sheetDetails.guessedConfig.opinionHeader && 
          config.setupStatus === 'pending') {
        issues.push('AIåˆ—åˆ¤å®šå®Œäº†æ¸ˆã¿ã ãŒ setupStatus=pending');
        config.setupStatus = 'completed';
        config.formCreated = true; // AIåˆ¤å®šå®Œäº†æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚‚æº–å‚™å®Œäº†ã¨ã¿ãªã™
        config.customSetupCompleted = true; // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒ•ãƒ©ã‚°
        fixes.push('AIåˆ¤å®šå®Œäº†ã«åŸºã¥ã„ã¦ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã‚’å®Œäº†ã«æ›´æ–°');
        
        // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®è‡ªå‹•å®Œäº†å‡¦ç†ã‚’ãƒˆãƒªã‚¬ãƒ¼
        setTimeout(() => {
          triggerCustomSetupCompletion(selectedSheet);
        }, 1000);
      }
      
      console.log('ğŸ“‹ è¨ºæ–­çµæœ:', { issues, fixes });
      
      if (fixes.length === 0) {
        resolve({
          success: true,
          message: 'âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã«å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ',
          issues: [],
          fixes: []
        });
        return;
      }
      
      // ä¿®æ­£ã•ã‚ŒãŸè¨­å®šã‚’ä¿å­˜
      console.log('ğŸ’¾ ä¿®æ­£ã•ã‚ŒãŸè¨­å®šã‚’ä¿å­˜ä¸­...', config);

        runGasWithUserId('syncConfigurationState', 'è¨­å®šä¿®å¾©ä¸­...', config, 'repair')
        .then(saveResult => {
          if (saveResult && saveResult.success) {
            console.log('âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã®ä¿®å¾©å®Œäº†');
            
            // UIçŠ¶æ…‹ã®æ›´æ–°
            if (typeof loadSystemStatus === 'function') {
              loadSystemStatus();
            }
            
            resolve({
              success: true,
              message: `ğŸ”§ ${fixes.length}ä»¶ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å•é¡Œã‚’ä¿®å¾©ã—ã¾ã—ãŸ`,
              issues,
              fixes
            });
          } else {
            reject(new Error(saveResult?.message || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'));
          }
        })
        .catch(saveError => {
          reject(new Error(`è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ${saveError.message}`));
        });
        
    } catch (error) {
      console.error('âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ä¿®å¾©ã§ã‚¨ãƒ©ãƒ¼:', error);
      reject(error);
    }
  });
}

// âœ¨ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è¨ºæ–­ãƒ»ä¿®å¾©ã‚’å®Ÿè¡Œã™ã‚‹UIé–¢æ•°
function runSetupRepair() {
  const btn = document.getElementById('setup-repair-btn');
  if (btn) {
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner mr-2"></div>ä¿®å¾©ä¸­...';
    
    repairSetupStateInconsistencies()
      .then(result => {
        if (result.success) {
          showMessage(result.message, 'success');
          if (result.fixes.length > 0) {
            console.log('ä¿®å¾©è©³ç´°:', result.fixes);
            
            // ğŸ”§ ä¿®å¾©å®Ÿè¡Œå¾Œã¯å¼·åˆ¶çš„ã«UIçŠ¶æ…‹ã‚’æ›´æ–°
            setTimeout(() => {
              console.log('ğŸ”„ ä¿®å¾©å¾Œã®UIçŠ¶æ…‹æ›´æ–°ã‚’å®Ÿè¡Œä¸­...');
              if (typeof loadSystemStatus === 'function') {
                loadSystemStatus();
              }
              if (typeof validateCurrentStep === 'function') {
                validateCurrentStep();
              }
            }, 200);
          }
        }
      })
      .catch(error => {
        console.error('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¿®å¾©ã‚¨ãƒ©ãƒ¼:', error);
        showMessage(`ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¿®å¾©ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
      })
      .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
      });
  }
}

// =============================================================================
// SAVE AND PUBLISH OPERATIONS
// =============================================================================

// Save configuration and publish board - ä¿®æ­£ç‰ˆï¼ˆå…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«çµŒç”±ï¼‰
function saveAndPublish() {
  if (!validateConfig()) {
    showMessage('å¿…é ˆé …ç›®ï¼ˆå›ç­”ãƒ‡ãƒ¼ã‚¿åˆ—ï¼‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  // UIã‹ã‚‰configã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
  const config = buildConfigObject();
  
  // è‡ªå‹•åœæ­¢è¨­å®šã‚’æº–å‚™
  const autoStopSettings = {
    enabled: true,
    minutes: 360 // 6æ™‚é–“ = 360åˆ†ï¼ˆconfig.gsã¨çµ±ä¸€ï¼‰
  };
  
  // Check for privacy-sensitive settings and show warning if enabled
  const showNames = document.getElementById('show-names')?.checked || false;
  const showCounts = document.getElementById('show-counts')?.checked || false;
  
  if (showNames || showCounts) {
    // Show privacy warning modal first
    if (window.sharedModals) {
      const privacySettings = [];
      if (showNames) privacySettings.push('åå‰è¡¨ç¤º');
      if (showCounts) privacySettings.push('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°è¡¨ç¤º');
      
      console.log(`âš ï¸ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è­¦å‘Š: ${privacySettings.join('ãƒ»')}ãŒæœ‰åŠ¹ã§ã™`);
      
      window.sharedModals.showPrivacyWarning(
        // onConfirm - show publish modal after privacy confirmation
        () => {
          console.log('âœ… ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è­¦å‘Šã‚’ç¢ºèªã€å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º');
          showPublishModalAfterChecks(config, autoStopSettings);
        },
        // onCancel - user wants to review settings
        () => {
          console.log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šã®è¦‹ç›´ã—ã‚’é¸æŠ');
          showMessage('è¨­å®šã‚’è¦‹ç›´ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'info');
        }
      );
      return;
    }
  }
  
  // If no privacy concerns, show publish modal directly
  showPublishModalAfterChecks(config, autoStopSettings);
}

// å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒã‚§ãƒƒã‚¯å¾Œï¼‰
function showPublishModalAfterChecks(config, autoStopSettings) {
  if (window.sharedModals && typeof window.sharedModals.showPublish === 'function') {
    window.sharedModals.showPublish(
      // å…¬é–‹å®Ÿè¡Œæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      () => {
        console.log('ğŸ“¤ å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å…¬é–‹ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        proceedWithSaveAndPublish(config);
      },
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      () => {
        console.log('âŒ å…¬é–‹ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      },
      // è‡ªå‹•åœæ­¢è¨­å®š
      autoStopSettings
    );
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ç›´æ¥å®Ÿè¡Œ
    console.warn('âš ï¸ å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ç›´æ¥å®Ÿè¡Œã—ã¾ã™ã€‚');
    proceedWithSaveAndPublish(config);
  }
}

// Proceed with the actual save and publish operation
function proceedWithSaveAndPublish(config) {

  // Set save protection flags to prevent interference
  isSaveInProgress = true;
  freshSaveTimestamp = Date.now();
  window.freshSaveTimestamp = freshSaveTimestamp;
  
  runGasWithUserId('saveAndPublish', 'è¨­å®šã‚’ä¿å­˜ã—ã€ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™...', selectedSheet, config)
    .then(function(result) {
      isSaveInProgress = false;
      
      // Check if result has data (from integrated API) or legacy success status
      if (result && (result.userInfo || result.status === 'success')) {
        showMessage('âœ… è¨­å®šãŒä¿å­˜ã•ã‚Œã€ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
        
        // å±¥æ­´ã«ä¿å­˜
        // å…¬é–‹æ™‚ã¯å±¥æ­´ä¿å­˜ã‚’è¡Œã‚ãªã„ï¼ˆå…¬é–‹åœæ­¢æ™‚ã«ä¿å­˜ã™ã‚‹ãŸã‚ï¼‰
        logDebug('Board published successfully - history will be saved on unpublish');
        
        // ãƒœãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã«å³åº§æ›´æ–°ã‚’é€šçŸ¥
        try {
          // ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆã‚ã‚Œã°ï¼‰
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'BOARD_PUBLISHED',
              sheetName: selectedSheet,
              timestamp: Date.now()
            }, '*');
            logInfo('ãƒœãƒ¼ãƒ‰å…¬é–‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€ä¿¡');
          }
          
          // åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä»–ã®ã‚¿ãƒ–ã«ã‚‚é€šçŸ¥
          if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('board-updates');
            channel.postMessage({
              type: 'BOARD_PUBLISHED',
              sheetName: selectedSheet,
              timestamp: Date.now()
            });
            channel.close();
            logInfo('ãƒœãƒ¼ãƒ‰å…¬é–‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’BroadcastChannelã§é€ä¿¡');
          }
        } catch (broadcastError) {
          console.warn('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°é€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼:', broadcastError);
        }
        
        // 6æ™‚é–“è‡ªå‹•åœæ­¢ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        setTimeout(() => {
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ç¢ºå®Ÿã«éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
          if (window.unifiedLoadingManager) {
            window.unifiedLoadingManager.setLoading(false);
            console.log('ğŸ”„ é€šå¸¸å…¬é–‹å¾Œã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
          }
          
          // å…¬é–‹å®Œäº†ç¢ºèªã¨URLç”Ÿæˆå¾Œã«è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          setTimeout(() => {
            // å…¬é–‹çŠ¶æ…‹ã¨URLç”Ÿæˆã®ç¢ºèª
            if (result && (result.publishedAt || result.userInfo)) {
              const publishResult = {
                publishedAt: result.publishedAt || new Date().toISOString(),
                autoStopMinutes: result.autoStopMinutes || 360,
                boardUrl: result.boardUrl || result.viewUrl || '',
                status: 'success',
                ...result
              };
              
              console.log('ğŸ“Š é€šå¸¸å…¬é–‹å®Œäº†ãƒ‡ãƒ¼ã‚¿ç¢ºèª:', {
                hasPublishedAt: !!publishResult.publishedAt,
                hasAutoStopMinutes: !!publishResult.autoStopMinutes,
                hasBoardUrl: !!publishResult.boardUrl,
                publishResult
              });
              
              if (window.sharedModals && typeof window.sharedModals.showAutoStopConfirmation === 'function') {
                window.sharedModals.showAutoStopConfirmation(publishResult);
                console.log('âœ… é€šå¸¸å…¬é–‹å¾Œã«è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
              } else {
                console.warn('âš ï¸ è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              }
            } else {
              console.warn('âš ï¸ é€šå¸¸å…¬é–‹çµæœãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã®ãŸã‚ã€è‡ªå‹•åœæ­¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™:', result);
            }
          }, 800); // URLç”Ÿæˆå¾…ã¡ã®ãŸã‚å°‘ã—é•·ã‚ã«è¨­å®š
        }, 2000); // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¾Œã«è¡¨ç¤º
        
        // Use fresh data from save response if available
        if (result.userInfo && result._meta) {
          logInfo('Using fresh data from save response');
          updateUIWithNewStatus(result);
        } else {
          // Only force refresh if no fresh data available
          logInfo('No fresh data in response, forcing refresh');
          loadStatus(true).then(() => {
            // ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œã‚’æ›´æ–°
            const currentStep = currentStatus && currentStatus.setupStep ? currentStatus.setupStep : 1;
            updateStepIndicators(currentStep);
            manageSectionStates(currentStep);
          });
        }
      } else {
        logError('Save failed:', result);
        showMessage(result.message || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        isSaveInProgress = false;
      }
    })
    .catch(function(error) {
      logError('saveAndPublish error:', error);
      isSaveInProgress = false;
      
      // Clear caches after error and reload
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      
      loadStatus(true).then(() => {
        // ã‚¨ãƒ©ãƒ¼å¾Œã‚‚ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œã‚’æ›´æ–°
        const currentStep = currentStatus && currentStatus.setupStep ? currentStatus.setupStep : 1;
        updateStepIndicators(currentStep);
        manageSectionStates(currentStep);
      });
      handleError(error, 'saveAndPublish', 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸã€‚');
    });
}

/**
 * å…¬é–‹åœæ­¢æ™‚ã®å¼·åŒ–ã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥é–¢é€£ã®ã‚¢ã‚¯ã‚»ã‚¹å•é¡Œã‚’é˜²ããŸã‚ã€ã‚ã‚‰ã‚†ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
 */
function clearAllCachesForUnpublish() {
  console.log('ğŸ§¹ å…¬é–‹åœæ­¢æ™‚ã®åŒ…æ‹¬çš„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†ã‚’é–‹å§‹');
  
  try {
    // 1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
      console.log('ğŸ—‘ï¸ Unified cache cleared');
      window.unifiedCache.clear();
    }
    
    if (window.gasOptimizer && typeof window.gasOptimizer.clearCache === 'function') {
      console.log('ğŸ—‘ï¸ GAS optimizer cache cleared');
      window.gasOptimizer.clearCache();
    }
    
    // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆStudyQuesté–¢é€£ã®ã¿ï¼‰
    try {
      const localStorageKeys = Object.keys(localStorage);
      const studyQuestKeys = localStorageKeys.filter(key => 
        key.includes('studyquest') || 
        key.includes('board') || 
        key.includes('sheet') ||
        key.includes('admin') ||
        key.includes('publication') ||
        key.includes('answer')
      );
      
      studyQuestKeys.forEach(key => {
        console.log('ğŸ—‘ï¸ Removing localStorage key:', key);
        localStorage.removeItem(key);
      });
      
      console.log(`ğŸ—‘ï¸ Cleared ${studyQuestKeys.length} localStorage keys`);
    } catch (e) {
      console.warn('âš ï¸ localStorage clear warning:', e);
    }
    
    // 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚¯ãƒªã‚¢
    try {
      if (window.sessionStorage) {
        const sessionKeys = Object.keys(sessionStorage);
        const studyQuestSessionKeys = sessionKeys.filter(key => 
          key.includes('studyquest') || 
          key.includes('board') || 
          key.includes('admin')
        );
        
        studyQuestSessionKeys.forEach(key => {
          console.log('ğŸ—‘ï¸ Removing sessionStorage key:', key);
          sessionStorage.removeItem(key);
        });
        
        console.log(`ğŸ—‘ï¸ Cleared ${studyQuestSessionKeys.length} sessionStorage keys`);
      }
    } catch (e) {
      console.warn('âš ï¸ sessionStorage clear warning:', e);
    }
    
    // 4. BroadcastChannelé€šçŸ¥ï¼ˆä»–ã®ã‚¿ãƒ–ã«å…¬é–‹åœæ­¢ã‚’é€šçŸ¥ï¼‰
    try {
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('board-updates');
        channel.postMessage({
          type: 'BOARD_UNPUBLISHED',
          timestamp: Date.now(),
          userId: window.userId || 'unknown'
        });
        console.log('ğŸ“¢ BroadcastChannel: å…¬é–‹åœæ­¢ã‚’ä»–ã®ã‚¿ãƒ–ã«é€šçŸ¥');
        channel.close();
      }
    } catch (e) {
      console.warn('âš ï¸ BroadcastChannel notification warning:', e);
    }
    
    // 5. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã®ãŸã‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
    try {
      localStorage.setItem('lastUnpublishTime', Date.now().toString());
      localStorage.setItem('cacheInvalidationToken', Math.random().toString(36));
      console.log('ğŸ”„ Cache invalidation tokens updated');
    } catch (e) {
      console.warn('âš ï¸ Cache invalidation token update warning:', e);
    }
    
    console.log('âœ… å…¬é–‹åœæ­¢æ™‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
    
  } catch (error) {
    console.error('âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã¯ç¶™ç¶š
  }
}

// Unpublish board
function unpublishBoard() {
  return runGasWithUserId('unpublishBoard', 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ä¸­...')
    .then(function(response) {
      logDebug('å…¬é–‹åœæ­¢ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
      showMessage(response.message || 'âœ… å›ç­”ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚', 'success');
      
      // å…¬é–‹åœæ­¢æ™‚ã«å±¥æ­´ã‚’ä¿å­˜
      saveHistoryOnUnpublish(response);
      
      // å¼·åŒ–ã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°å¯¾å¿œï¼‰
      clearAllCachesForUnpublish();
      
      // Reset column selection dropdowns to default "--åˆ—ã‚’é¸æŠ--" state
      resetColumnSelections();
      
      loadStatus(true); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¼·åˆ¶æ›´æ–°
      
      // å…¬é–‹åœæ­¢å‡¦ç†ãŒæˆåŠŸã—ãŸã“ã¨ã‚’è¿”ã™
      return Promise.resolve(response);
    })
    .catch(function(error) {
      handleError(error, 'unpublishBoard', 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼ã—ã¦å‘¼ã³å‡ºã—å…ƒã§ã‚­ãƒ£ãƒƒãƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      return Promise.reject(error);
    });
}

// å…¬é–‹åœæ­¢æ™‚ã«å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
function saveHistoryOnUnpublish(unpublishResponse) {
  try {
    // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ï¼‰
    const currentStatus = window.lastStatusCache;
    if (!currentStatus || !currentStatus.config) {
      logWarn('å±¥æ­´ä¿å­˜: ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
      return;
    }
    
    const config = currentStatus.config;
    const userInfo = currentStatus.userInfo || {};
    
    // å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
    const historyItem = {
      questionText: config.opinionHeader || config.opinionColumn || userInfo.customFormInfo?.mainQuestion || 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰',
      sheetName: config.publishedSheetName || '',
      publishedAt: config.publishedAt || config.lastPublishedAt || new Date().toISOString(),
      endTime: new Date().toISOString(), // å®Ÿéš›ã®çµ‚äº†æ—¥æ™‚
      scheduledEndTime: config.scheduledEndTime || null, // äºˆå®šçµ‚äº†æ—¥æ™‚
      answerCount: unpublishResponse.answerCount || currentStatus.answerCount || 0,
      reactionCount: unpublishResponse.reactionCount || currentStatus.reactionCount || 0,
      config: config,
      formUrl: userInfo.formUrl || '',
      spreadsheetUrl: userInfo.spreadsheetUrl || '',
      setupType: determineSetupType(config, userInfo),
      isActive: false // çµ‚äº†ã—ãŸã®ã§false
    };
    
    // LocalStorageå±¥æ­´ä¿å­˜ã‚’å®Ÿè¡Œ
    saveToHistory(historyItem);
    
    // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å±¥æ­´ä¿å­˜ã‚‚å®Ÿè¡Œ
    try {
      runGasWithUserId('saveHistoryToSheetAPI', 'å±¥æ­´ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ä¸­...', historyItem)
        .then(response => {
          if (response && response.status === 'success') {
            logDebug('âœ… ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å±¥æ­´ä¿å­˜å®Œäº†:', response);
          } else {
            logWarn('âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å±¥æ­´ä¿å­˜ã§è­¦å‘Š:', response);
          }
        })
        .catch(error => {
          logWarn('âŒ ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        });
    } catch (serverError) {
      logWarn('âŒ ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å±¥æ­´ä¿å­˜ã®å‘¼ã³å‡ºã—ã«å¤±æ•—:', serverError);
    }
    
    logDebug('å±¥æ­´ä¿å­˜å®Œäº†ï¼ˆå…¬é–‹åœæ­¢æ™‚ï¼‰:', historyItem);
    
  } catch (error) {
    logWarn('å…¬é–‹åœæ­¢æ™‚ã®å±¥æ­´ä¿å­˜ã«å¤±æ•—:', error);
  }
}

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®šã™ã‚‹è£œåŠ©é–¢æ•°
function determineSetupType(config, userInfo) {
  if (userInfo.customFormInfo) {
    return 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—';
  } else if (config.isQuickStart || config.setupType === 'quickstart') {
    return 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ';
  } else if (config.isExternalResource) {
    return 'å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹';
  } else {
    return 'unknown';
  }
}

// Reset column selection dropdowns to default state
function resetColumnSelections() {
  console.log('ğŸ”„ Resetting column selections to default state');
  
  const columnSelects = [
    'opinion-column-select',
    'name-column-select', 
    'reason-column-select',
    'class-column-select',
    'timestamp-column-select'
  ];
  
  columnSelects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.value = ''; // Reset to empty value
      console.log(`âœ… Reset ${selectId} to default`);
    }
  });
  
  // Also reset any display checkboxes
  const checkboxes = ['show-names', 'show-counts'];
  checkboxes.forEach(checkboxId => {
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) {
      checkbox.checked = false;
      console.log(`âœ… Reset ${checkboxId} to unchecked`);
    }
  });
}

// =============================================================================
// FORM MANAGEMENT
// =============================================================================

// Load saved class choices
function loadSavedClassChoices() {
    runGasWithUserId('getSavedClassChoices', 'ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’èª­ã¿è¾¼ã¿ä¸­...')
        .then(function(result) {
            if (result.status === 'success' && result.classChoices) {
                const classChoicesTextarea = document.getElementById('class-choices');
                if (classChoicesTextarea) {
                    classChoicesTextarea.value = result.classChoices.join('\n');
                }
            }
        })
        .catch(function(error) {
            console.warn('ä¿å­˜ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error.message);
            showMessage('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        });
}

// Create form with custom configuration
function createFormWithConfig() {
  const questionTextarea = document.getElementById('custom-main-question');
  const questionTypeSelect = document.getElementById('main-question-type');
  const questionChoicesTextarea = document.getElementById('main-question-choices');
  const classChoicesTextarea = document.getElementById('class-choices');
  const includeOthersOption = document.getElementById('include-others-option').checked;
  const enableClassSelection = document.getElementById('enable-class-selection').checked;
  
  if (!questionTextarea || !questionTypeSelect) {
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  const question = questionTextarea.value.trim();
  const questionType = questionTypeSelect.value; // å›ç­”æ–¹æ³•ã‚’å–å¾—
  const questionChoicesText = questionChoicesTextarea ? questionChoicesTextarea.value.trim() : '';
  const classChoicesText = enableClassSelection && classChoicesTextarea ? classChoicesTextarea.value.trim() : '';
  
  if (!question) {
    showMessage('å•é¡Œæ–‡ã¯å¿…é ˆã§ã™ã€‚', 'warning');
    return;
  }
  
  // é¸æŠè‚¢ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯é¸æŠè‚¢ãŒå¿…è¦
  if ((questionType === 'choice' || questionType === 'multiple') && !questionChoicesText) {
    showMessage('é¸æŠè‚¢ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯é¸æŠè‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  // é¸æŠè‚¢ã‚’é…åˆ—ã«å¤‰æ›
  const questionChoices = questionChoicesText ? 
    questionChoicesText.split('\n').map(choice => choice.trim()).filter(choice => choice.length > 0) : [];
  
  // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’é…åˆ—ã«å¤‰æ›  
  const classChoices = classChoicesText ? 
    classChoicesText.split('\n').map(choice => choice.trim()).filter(choice => choice.length > 0) : [];
  
  const config = {
    mainQuestion: question,
    responseType: questionType, // å›ç­”æ–¹æ³•ã‚’è¿½åŠ 
    questionChoices: questionChoices, // ãƒ¡ã‚¤ãƒ³è³ªå•ã®é¸æŠè‚¢
    classChoices: classChoices,
    includeOthers: includeOthersOption,
    enableClass: enableClassSelection && classChoices.length > 0,
  };
  
  console.log('ğŸ“‹ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®š:', config);
  
  hideFormConfigModal();
  
  // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨é€²æ—è¡¨ç¤ºã‚’é–‹å§‹
  // Use the new unified custom setup system
  console.log('ğŸ¨ çµ±åˆã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹:', config);
  
  // userEmailã¯ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‹ã‚‰å–å¾—
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.adminEmail) {
    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }
  
  // Call the new unified custom setup handler - this replaces the old createCustomFormUI flow
  handleCustomSetup(config);
  
  // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
  saveClassChoicesToDatabase(classChoices);
}


// Save class choices to database
function saveClassChoicesToDatabase(classChoices) {
    runGasWithUserId('saveClassChoices', classChoices)
        .catch(function(error) {
            console.warn('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®ä¿å­˜ã«å¤±æ•—:', error.message);
        });
}

// =============================================================================
// RESOURCE MANAGEMENT
// =============================================================================

// Add spreadsheet resource
function addResource() {
  const urlInput = document.getElementById('resource-url-input');
  if (!urlInput) {
    showMessage('URLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  const url = urlInput.value.trim();
  if (!url) {
    showMessage('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }

  // URLã®ç¨®é¡ã‚’åˆ¤å®šï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã¿å¯¾å¿œï¼‰
  let resourceType = 'spreadsheet';
  let backendFunction = 'addSpreadsheetUrl';
  
  if (!url.includes('docs.google.com/spreadsheets/')) {
    showMessage('Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  const resourceTypeText = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ';

  runGasWithUserId(backendFunction, `${resourceTypeText}ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™...`, url)
    .then(function(result) {
      if (result.status === 'success') {
        showMessage(result.message, 'success');
        urlInput.value = ''; // Clear input
        loadStatus(true); // Refresh status
      } else {
        showMessage(result.message || `${resourceTypeText}ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`, 'error');
      }
    })
    .catch(function(error) {
      handleError(error, 'addResource', `${resourceTypeText}ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
    });
}

// =============================================================================
// EXTERNAL LINKS AND NAVIGATION
// =============================================================================

// Copy board URL to clipboard
function copyBoardUrl(buttonElement) {
  const urlInput = document.getElementById('board-url');
  if (!urlInput) {
    console.error('board-url input element not found.');
    return;
  }

  const urlToCopy = urlInput.value;

  if (!urlToCopy) {
    showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
    return;
  }

  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(urlToCopy).then(() => {
        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>ã‚³ãƒ”ãƒ¼å®Œäº†!';
        buttonElement.disabled = true;
        setTimeout(() => {
          buttonElement.innerHTML = originalText;
          buttonElement.disabled = false;
        }, 2000);
      }).catch((error) => {
        console.error('Clipboard API failed:', error);
        // Fallback to manual copy message
        const messageElement = document.createElement('span');
        messageElement.textContent = ' (æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)';
        messageElement.style.color = 'orange';
        buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
        setTimeout(() => messageElement.remove(), 5000);
      });
    } else {
      // Fallback for browsers that don't support Clipboard API
      urlInput.select();
      urlInput.setSelectionRange(0, 99999); // For mobile devices
      document.execCommand('copy');
      showMessage('URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success'); // Fallback uses showMessage
    }
  } catch (err) {
    console.error('copyBoardUrl error:', err);
    showMessage('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'warning'); // Fallback uses showMessage
  }
}

// Copy form URL to clipboard
function copyFormUrl() {
  const urlInput = document.getElementById('form-url-input');
  if (urlInput && urlInput.value) {
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      // Try modern clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(urlInput.value).then(() => {
          showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
        }).catch(() => {
          // Fallback to execCommand
          document.execCommand('copy');
          showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
        });
      } else {
        document.execCommand('copy');
        showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
      }
    } catch (err) {
      showMessage('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'warning');
    }
  } else {
    showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
  }
}

// Open database spreadsheet
function openDatabaseSpreadsheet() {
  if (currentSpreadsheetUrl) {
    window.open(currentSpreadsheetUrl, '_blank');
  } else {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'warning');
  }
}

// Open form
function openForm() {
  console.log('ğŸ”— openForm function called');
  
  // ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡è¦–
  const formBtn = document.getElementById('open-form-btn');
  if (formBtn && formBtn.disabled) {
    console.log('âš ï¸ Form button is disabled, ignoring click');
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ã‹ã‚‰ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ URLã‚’å–å¾—ã™ã‚‹å„ªå…ˆé †ä½ã‚’è¨­å®š
  let formUrl = null;
  
  // 1. configJsonã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰
  if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
    try {
      const configJson = await runGasWithUserId('getConfigJSON', false, currentStatus.userInfo);
      
      if (configJson && configJson.formUrl) {
        formUrl = configJson.formUrl;
        logDebug('âœ… FormURLå–å¾—: configJsonã‹ã‚‰ç›´æ¥å–å¾—æˆåŠŸ');
      }
    } catch (error) {
      logWarn('âš ï¸ configJsonã®è§£æã§ã‚¨ãƒ©ãƒ¼:', error);
    }
  }
  
  // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®formUrlã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  if (!formUrl && currentStatus && currentStatus.userInfo && currentStatus.userInfo.formUrl) {
    formUrl = currentStatus.userInfo.formUrl;
    logDebug('ğŸ“‹ FormURLå–å¾—: userInfo.formUrlã‹ã‚‰å–å¾—');
  }
  
  // 3. ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‹ã‚‰å–å¾—ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
  if (!formUrl && currentStatus && currentStatus.customFormInfo && currentStatus.customFormInfo.formUrl) {
    formUrl = currentStatus.customFormInfo.formUrl;
    logDebug('ğŸ“„ FormURLå–å¾—: customFormInfo.formUrlã‹ã‚‰å–å¾—');
  }
  
  if (formUrl) {
    window.open(formUrl, '_blank');
  } else {
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'warning');
  }
}

// Open app setup page
function openAppSetupPage() {
  const loadingMessage = 'ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã‚’æº–å‚™ä¸­...';
  const errorMessage = 'ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
  const timeoutMessage = 'ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚';
  const fallbackMessage = 'ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚';

  runGasWithUserId('getWebAppUrl', loadingMessage)
    .then(function(webAppUrl) {
      const setupUrl = webAppUrl + '?setup=true&mode=appsetup&userId=' + encodeURIComponent(userId);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹
      showMessage('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ç§»å‹•ä¸­...', 'info');
      window.unifiedLoading.showSimple('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ç§»å‹•ä¸­...');

      const redirectTimeout = setTimeout(() => {
        console.warn('Redirect to app setup page timed out. Attempting fallback.');
        window.unifiedLoading.hide();
        showMessage(timeoutMessage, 'warning');
        window.open(setupUrl, '_blank'); // Fallback: open in new tab
      }, 10000); // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

      // ç›´æ¥ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è©¦ã¿ã‚‹
      try {
        clearTimeout(redirectTimeout);
        window.unifiedLoading.hide();
        window.open(setupUrl, '_top'); // _top ã‚’ä½¿ç”¨ã—ã¦ç¾åœ¨ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
      } catch (e) {
        console.error('Error opening app setup page:', e);
        window.unifiedLoading.hide();
        showMessage(errorMessage + ' ' + (e.message || ''), 'error');
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        showMessage(fallbackMessage, 'info');
        window.open(setupUrl, '_blank');
      }
    })
    .catch(function(error) {
      console.error('Failed to get web app URL for app setup page:', error);
      window.unifiedLoading.hide();
      showMessage('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã®URLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚' + (error.message || ''), 'error');
    });
}

// =============================================================================
// POLLING AND REAL-TIME UPDATES
// =============================================================================

// System status polling variables
let lastUserActivity = Date.now();
let currentPollInterval = 5 * 60 * 1000; // é–‹å§‹ã¯5åˆ†é–“éš”
let statusPollTimer = null;

// Fresh save management to prevent interference
let freshSaveTimestamp = 0;
let isSaveInProgress = false;
const FRESH_SAVE_PROTECTION_DURATION = 30000; // 30 seconds

// Make freshSaveTimestamp globally accessible
window.freshSaveTimestamp = freshSaveTimestamp;

// =============================================================================
// CONFIG VERIFICATION MECHANISM
// =============================================================================

/**
 * è¨­å®šä¿å­˜å¾Œã®æ¤œè¨¼æ©Ÿèƒ½
 * ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§è¨­å®šã—ãŸå†…å®¹ãŒæ­£ã—ãä¿å­˜ãƒ»åæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
 */
async function verifyConfigAfterSave(expectedSheetName, expectedConfig) {
  try {
    console.log('ğŸ” è¨­å®šåæ˜ ç¢ºèªé–‹å§‹:', expectedSheetName);
    
    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å†å–å¾—
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const verificationStatus = await runGasWithUserId('getAppConfig', 'è¨­å®šåæ˜ ã‚’ç¢ºèªä¸­...');
    
    if (verificationStatus && verificationStatus.userInfo) {
      const configJson = getConfigJSON(verificationStatus.userInfo);
      const sheetKey = 'sheet_' + expectedSheetName;
      const savedConfig = configJson[sheetKey];
      
      console.log('ğŸ” ä¿å­˜ã•ã‚ŒãŸè¨­å®š:', savedConfig);
      console.log('ğŸ” æœŸå¾…ã™ã‚‹è¨­å®š:', expectedConfig);
      
      // åŸºæœ¬çš„ãªæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      const isConsistent = (
        savedConfig &&
        savedConfig.guessedConfig &&
        expectedConfig.opinionHeader &&
        savedConfig.guessedConfig.opinionHeader === expectedConfig.opinionHeader
      );
      
      if (isConsistent) {
        console.log('âœ… è¨­å®šåæ˜ ç¢ºèª: æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™');
        return { success: true, message: 'è¨­å®šãŒæ­£å¸¸ã«åæ˜ ã•ã‚Œã¾ã—ãŸ' };
      } else {
        console.warn('âš ï¸ è¨­å®šåæ˜ ç¢ºèª: è¨­å®šã«ä¸æ•´åˆãŒã‚ã‚Šã¾ã™');
        
        // è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œ
        console.log('ğŸ”§ è¨­å®šä¸æ•´åˆã‚’æ¤œå‡º - è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œä¸­...');
        await runGasWithUserId('saveSheetConfig', 'è¨­å®šã‚’ä¿®å¾©ä¸­...',
          currentStatus.userInfo.spreadsheetId, expectedSheetName, expectedConfig, { batchMode: true });
        
        return { success: false, message: 'è¨­å®šä¸æ•´åˆã‚’æ¤œå‡ºã—ã€ä¿®å¾©ã‚’è©¦è¡Œã—ã¾ã—ãŸ', repaired: true };
      }
    }
    
    return { success: false, message: 'è¨­å®šç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' };
    
  } catch (error) {
    console.error('âŒ è¨­å®šåæ˜ ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
    return { success: false, message: 'è¨­å®šç¢ºèªå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message };
  }
}

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªï¼ˆQuickStartãƒ»Custom Setupå…±é€šï¼‰
 * @param {string} flowType - 'quickstart' ã¾ãŸã¯ 'custom'
 * @param {string} sheetName - å¯¾è±¡ã‚·ãƒ¼ãƒˆå
 * @returns {Object} å®Œäº†ç¢ºèªçµæœ
 */
async function verifySetupFlowCompletion(flowType, sheetName) {
  try {
    console.log(`ğŸ¯ ${flowType}ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªé–‹å§‹:`, sheetName);
    
    // è¨­å®šãŒå®‰å®šã™ã‚‹ã¾ã§å°‘ã—å¾…ã¤
    await new Promise(resolve => setTimeout(resolve, 3000));
    
    const completionStatus = await runGasWithUserId('getAppConfig', 'ãƒ•ãƒ­ãƒ¼å®Œäº†çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');
    
    if (!completionStatus || !completionStatus.userInfo) {
      console.error('âŒ ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèª: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—å¤±æ•—');
      return { success: false, message: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' };
    }
    
    const configJson = await runGasWithUserId('getConfigJSON', false, completionStatus.userInfo);
    const issues = [];
    
    // å¿…é ˆå®Œäº†çŠ¶æ…‹ã®ç¢ºèª
    console.log('ğŸ” å®Œäº†çŠ¶æ…‹ç¢ºèª - configJson:', {
      setupStatus: configJson.setupStatus,
      appPublished: configJson.appPublished,
      formCreated: configJson.formCreated,
      publishedSheetName: configJson.publishedSheetName,
      publishedSpreadsheetId: configJson.publishedSpreadsheetId
    });
    
    // 1. setupStatus='completed' ç¢ºèª
    if (configJson.setupStatus !== 'completed') {
      issues.push(`âŒ setupStatus: "${configJson.setupStatus}" â†’ "completed"ãŒå¿…è¦`);
    }
    
    // 2. appPublished=true ç¢ºèª  
    if (configJson.appPublished !== true) {
      issues.push(`âŒ appPublished: ${configJson.appPublished} â†’ trueãŒå¿…è¦`);
    }
    
    // 3. formCreated=true ç¢ºèª
    if (configJson.formCreated !== true) {
      issues.push(`âŒ formCreated: ${configJson.formCreated} â†’ trueãŒå¿…è¦`);
    }
    
    // 4. å…¬é–‹æƒ…å ±ã®ç¢ºèª
    if (!configJson.publishedSheetName) {
      issues.push(`âŒ publishedSheetNameæœªè¨­å®š â†’ "${sheetName}"ãŒå¿…è¦`);
    } else if (configJson.publishedSheetName !== sheetName) {
      issues.push(`âŒ publishedSheetNameä¸ä¸€è‡´: "${configJson.publishedSheetName}" â†’ "${sheetName}"`);
    }
    
    if (!configJson.publishedSpreadsheetId) {
      issues.push('âŒ publishedSpreadsheetIdæœªè¨­å®š');
    }
    
    // 5. ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šã®ç¢ºèª
    const sheetKey = 'sheet_' + sheetName;
    const sheetConfig = configJson[sheetKey];
    if (!sheetConfig || !sheetConfig.guessedConfig) {
      issues.push(`âŒ ã‚·ãƒ¼ãƒˆè¨­å®šæœªä¿å­˜: ${sheetKey}`);
    }
    
    if (issues.length === 0) {
      console.log(`âœ… ${flowType}ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèª: ã™ã¹ã¦ã®è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™`);
      return {
        success: true,
        message: `${flowType}ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ`,
        details: {
          setupStatus: configJson.setupStatus,
          appPublished: configJson.appPublished,
          formCreated: configJson.formCreated,
          publishedSheetName: configJson.publishedSheetName,
          hasSheetConfig: !!sheetConfig?.guessedConfig
        }
      };
    } else {
      console.warn(`âš ï¸ ${flowType}ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèª: æœªå®Œäº†é …ç›®ãŒã‚ã‚Šã¾ã™`, issues);
      return {
        success: false,
        message: `${flowType}ãƒ•ãƒ­ãƒ¼ã«æœªå®Œäº†é …ç›®ãŒã‚ã‚Šã¾ã™`,
        issues: issues,
        details: {
          setupStatus: configJson.setupStatus,
          appPublished: configJson.appPublished,
          formCreated: configJson.formCreated,
          publishedSheetName: configJson.publishedSheetName,
          hasSheetConfig: !!sheetConfig?.guessedConfig
        }
      };
    }
    
  } catch (error) {
    console.error(`âŒ ${flowType}ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªã‚¨ãƒ©ãƒ¼:`, error);
    return { 
      success: false, 
      message: `ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}` 
    };
  }
}

/**
 * è¨­å®šåŒæœŸãƒ¡ã‚«ãƒ‹ã‚ºãƒ å¼·åŒ– - ãƒ•ãƒ­ãƒ¼å®Œäº†çŠ¶æ…‹ã¨ã®æ•´åˆæ€§ã‚’ä¿ã¤
 * @param {string} flowType - 'quickstart' ã¾ãŸã¯ 'custom'
 * @param {Object} expectedState - æœŸå¾…ã•ã‚Œã‚‹è¨­å®šçŠ¶æ…‹
 * @returns {Promise<Object>} åŒæœŸçµæœ
 */
async function enhanceConfigSynchronization(flowType, expectedState) {
  try {
    console.log(`ğŸ”„ ${flowType}ãƒ•ãƒ­ãƒ¼: è¨­å®šåŒæœŸãƒ¡ã‚«ãƒ‹ã‚ºãƒ é–‹å§‹`, expectedState);
    
    // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
    const currentStatus = await runGasWithUserId('getAppConfig', 'è¨­å®šåŒæœŸã®ãŸã‚æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ä¸­...');
    
    if (!currentStatus || !currentStatus.userInfo) {
      throw new Error('è¨­å®šåŒæœŸ: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—å¤±æ•—');
    }
    
    const configJson = await runGasWithUserId('getConfigJSON', false, currentStatus.userInfo);
    const synchronizationIssues = [];
    const appliedFixes = [];
    
    // 1. å¿…é ˆè¨­å®šçŠ¶æ…‹ã®ç¢ºèªã¨ä¿®æ­£
    const requiredStates = {
      setupStatus: 'completed',
      appPublished: true,
      formCreated: true,
      publishedSheetName: expectedState.sheetName,
      publishedSpreadsheetId: expectedState.spreadsheetId || currentStatus.userInfo.spreadsheetId
    };
    
    let needsSync = false;
    const updatedConfig = { ...configJson };
    
    for (const [key, expectedValue] of Object.entries(requiredStates)) {
      if (configJson[key] !== expectedValue) {
        synchronizationIssues.push(`${key}: "${configJson[key]}" â†’ "${expectedValue}"`);
        updatedConfig[key] = expectedValue;
        needsSync = true;
      }
    }
    
    // 2. ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šã®åŒæœŸç¢ºèª
    if (expectedState.sheetName && expectedState.config) {
      const sheetKey = 'sheet_' + expectedState.sheetName;
      const currentSheetConfig = configJson[sheetKey];
      
      if (!currentSheetConfig || !currentSheetConfig.guessedConfig) {
        synchronizationIssues.push(`ã‚·ãƒ¼ãƒˆè¨­å®šæœªä¿å­˜: ${sheetKey}`);
        updatedConfig[sheetKey] = {
          guessedConfig: expectedState.config,
          lastUpdated: new Date().toISOString(),
          flowType: flowType
        };
        needsSync = true;
      }
    }
    
    // 3. è¨­å®šã®åŒæœŸé©ç”¨ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰
    if (needsSync) {
      console.log(`ğŸ”§ ${flowType}ãƒ•ãƒ­ãƒ¼: è¨­å®šä¸æ•´åˆã‚’æ¤œå‡º - åŒæœŸä¿®æ­£ã‚’å®Ÿè¡Œ`, synchronizationIssues);
      
      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«åŒæœŸä¿®æ­£ã‚’ä¾é ¼
      const syncResult = await runGasWithUserId('syncConfigurationState', 'è¨­å®šåŒæœŸã‚’å®Ÿè¡Œä¸­...', 
        userId, updatedConfig, flowType);
      
      if (syncResult && syncResult.success) {
        appliedFixes.push(...synchronizationIssues);
        console.log(`âœ… ${flowType}ãƒ•ãƒ­ãƒ¼: è¨­å®šåŒæœŸä¿®æ­£å®Œäº†`, appliedFixes);
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦æœ€æ–°çŠ¶æ…‹ã‚’åæ˜ 
        if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
          window.unifiedCache.clear();
        }
        
        return {
          success: true,
          synchronized: true,
          appliedFixes: appliedFixes,
          message: `${flowType}ãƒ•ãƒ­ãƒ¼ã®è¨­å®šåŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ`
        };
      } else {
        console.warn(`âš ï¸ ${flowType}ãƒ•ãƒ­ãƒ¼: è¨­å®šåŒæœŸä¿®æ­£ã«å¤±æ•—`, syncResult);
        return {
          success: false,
          synchronized: false,
          issues: synchronizationIssues,
          message: 'è¨­å®šåŒæœŸä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ'
        };
      }
    } else {
      console.log(`âœ… ${flowType}ãƒ•ãƒ­ãƒ¼: è¨­å®šã¯æ—¢ã«åŒæœŸã•ã‚Œã¦ã„ã¾ã™`);
      return {
        success: true,
        synchronized: false,
        message: `${flowType}ãƒ•ãƒ­ãƒ¼ã®è¨­å®šã¯æ—¢ã«æ­£ã—ãåŒæœŸã•ã‚Œã¦ã„ã¾ã™`
      };
    }
    
  } catch (error) {
    console.error(`âŒ ${flowType}ãƒ•ãƒ­ãƒ¼è¨­å®šåŒæœŸã‚¨ãƒ©ãƒ¼:`, error);
    return {
      success: false,
      synchronized: false,
      error: error.message,
      message: `è¨­å®šåŒæœŸå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`
    };
  }
}

/**
 * çµ±åˆçš„ãªè¨­å®šæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ - è¤‡æ•°ãƒ•ãƒ­ãƒ¼ã«å¯¾å¿œ
 * @param {Object} status - ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
 * @returns {Object} æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯çµæœ
 */
function performIntegratedConfigConsistencyCheck(status) {
  if (!status || !status.userInfo) {
    return { consistent: false, issues: ['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™'] };
  }
  
  try {
    const configJson = getConfigJSON(status.userInfo);
    const issues = [];
    const recommendations = [];
    
    // 1. åŸºæœ¬çš„ãªè¨­å®šæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    const basicChecks = [
      {
        condition: configJson.setupStatus === 'completed',
        issue: 'setupStatusãŒcompletedã§ã¯ã‚ã‚Šã¾ã›ã‚“',
        recommendation: 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼ã‚’å®Œäº†ã—ã¦ãã ã•ã„'
      },
      {
        condition: configJson.formCreated === true,
        issue: 'formCreatedãŒtrueã§ã¯ã‚ã‚Šã¾ã›ã‚“',
        recommendation: 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'
      },
      {
        condition: !!configJson.publishedSheetName,
        issue: 'publishedSheetNameãŒæœªè¨­å®šã§ã™',
        recommendation: 'ã‚·ãƒ¼ãƒˆé¸æŠã‚’ç¢ºèªã—ã¦ãã ã•ã„'
      },
      {
        condition: !!configJson.publishedSpreadsheetId,
        issue: 'publishedSpreadsheetIdãŒæœªè¨­å®šã§ã™',
        recommendation: 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„'
      }
    ];
    
    basicChecks.forEach(check => {
      if (!check.condition) {
        issues.push(check.issue);
        recommendations.push(check.recommendation);
      }
    });
    
    // 2. å…¬é–‹çŠ¶æ…‹ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    if (configJson.appPublished === true) {
      if (configJson.setupStatus !== 'completed') {
        issues.push('å…¬é–‹çŠ¶æ…‹ãªã®ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæœªå®Œäº†ã§ã™');
        recommendations.push('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã™ã‚‹ã‹ã€å…¬é–‹ã‚’åœæ­¢ã—ã¦ãã ã•ã„');
      }
      if (!configJson.formCreated) {
        issues.push('å…¬é–‹çŠ¶æ…‹ãªã®ã«ãƒ•ã‚©ãƒ¼ãƒ ãŒæœªä½œæˆã§ã™');
        recommendations.push('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã‹ã€å…¬é–‹ã‚’åœæ­¢ã—ã¦ãã ã•ã„');
      }
    }
    
    // 3. ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    if (configJson.publishedSheetName) {
      const sheetKey = 'sheet_' + configJson.publishedSheetName;
      const sheetConfig = configJson[sheetKey];
      
      if (!sheetConfig || !sheetConfig.guessedConfig) {
        issues.push(`ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šãŒæœªä¿å­˜ã§ã™: ${configJson.publishedSheetName}`);
        recommendations.push('åˆ—è¨­å®šã‚’ç¢ºèªãƒ»ä¿å­˜ã—ã¦ãã ã•ã„');
      }
    }
    
    const isConsistent = issues.length === 0;
    
    return {
      consistent: isConsistent,
      issues: issues,
      recommendations: recommendations,
      severity: issues.length > 3 ? 'high' : issues.length > 1 ? 'medium' : 'low',
      summary: isConsistent ? 'è¨­å®šã¯æ•´åˆæ€§ãŒä¿ãŸã‚Œã¦ã„ã¾ã™' : `${issues.length}ä»¶ã®æ•´åˆæ€§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`
    };
    
  } catch (error) {
    console.error('è¨­å®šæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
    return {
      consistent: false,
      issues: ['è¨­å®šè§£æã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'],
      recommendations: ['è¨­å®šã‚’å†ç¢ºèªã—ã¦ãã ã•ã„'],
      error: error.message
    };
  }
}

// Get optimal polling interval based on user activity
function getOptimalPollInterval() {
  const timeSinceActivity = Date.now() - lastUserActivity;
  
  if (timeSinceActivity < 2 * 60 * 1000) { // 2åˆ†ä»¥å†…
    return 30 * 1000; // 30ç§’é–“éš”
  } else if (timeSinceActivity < 10 * 60 * 1000) { // 10åˆ†ä»¥å†…
    return 2 * 60 * 1000; // 2åˆ†é–“éš”
  } else {
    return 10 * 60 * 1000; // 10åˆ†é–“éš”
  }
}

// Restart status polling with new interval
function restartStatusPolling() {
  if (statusPollTimer) {
    clearInterval(statusPollTimer);
  }
  currentPollInterval = getOptimalPollInterval();
  startSystemStatusUpdate();
}

// Start system status update polling
function startSystemStatusUpdate() {
  statusPollTimer = setInterval(function() {
    // UIãŒéè¡¨ç¤ºã®æ™‚ã¯æ›´æ–°ã—ãªã„
    if (document.hidden) return;
    
    // Skip background updates if save operation is in progress or recently completed
    if (isSaveInProgress) {
      logDebug('Skipping background update: save in progress');
      return;
    }
    
    const timeSinceFreshSave = Date.now() - freshSaveTimestamp;
    if (timeSinceFreshSave < FRESH_SAVE_PROTECTION_DURATION) {
      logDebug('Skipping background update: fresh save protection active');
      return;
    }
    
    // ç¾åœ¨ã®ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´
    const optimalInterval = getOptimalPollInterval();
    if (Math.abs(currentPollInterval - optimalInterval) > 30000) { // 30ç§’ä»¥ä¸Šã®å·®
      restartStatusPolling();
      return;
    }
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã—ã¦é™ã‹ã«æ›´æ–°
    runGasWithUserId('getStatus', false)
      .then(function(status) {
        // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿UIã‚’æ›´æ–°
        if (JSON.stringify(status) !== JSON.stringify(currentStatus)) {
          updateUIWithNewStatus(status);
        }
      })
      .catch(function(error) {
        logWarn('Background status update failed:', error);
      });
  }, currentPollInterval);
}

// =============================================================================
// CONFIG MANAGEMENT
// =============================================================================

// Reset configJson to initial values
function resetConfigJson() {
  // å±é™ºæ“ä½œã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  const confirmMessage = `âš ï¸ è¨­å®šãƒªã‚»ãƒƒãƒˆã®ç¢ºèª

ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®è¨­å®šãŒåˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼š
â€¢ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šï¼ˆè³ªå•æ–‡ã€å›ç­”æ–¹æ³•ãªã©ï¼‰
â€¢ è¡¨ç¤ºè¨­å®šï¼ˆåŒ¿åè¡¨ç¤ºã€é›†è¨ˆè¡¨ç¤ºãªã©ï¼‰
â€¢ ã‚·ãƒ¼ãƒˆè¨­å®šï¼ˆå›ç­”é€£æºãªã©ï¼‰

â€» ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚„ãƒ•ã‚©ãƒ¼ãƒ è‡ªä½“ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ãŒã€
ã€€ è¨­å®šã®å†æ§‹ç¯‰ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

æœ¬å½“ã«è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`;

  if (!confirm(confirmMessage)) {
    return;
  }
  
  const button = document.getElementById('reset-config-btn');
  const originalHTML = button ? button.innerHTML : '';
  
  try {
    if (button) {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
      button.disabled = true;
      button.innerHTML = `
        <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        ãƒªã‚»ãƒƒãƒˆä¸­...
      `;
    }
    
    logInfo('ğŸ”„ ConfigJsonãƒªã‚»ãƒƒãƒˆé–‹å§‹');
    
    runGasWithUserId('resetConfigJson', 'è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆä¸­...')
      .then(function(result) {
        if (result.success) {
          showMessage('âœ… è¨­å®šã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å¤‰æ›´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'success');
          logInfo('âœ… ConfigJsonãƒªã‚»ãƒƒãƒˆå®Œäº†');
          
          // UIã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          setTimeout(() => {
            runGasWithUserId('getInitialData', 'ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...')
              .then(function(updatedStatus) {
                updateUIWithNewStatus(updatedStatus);
                logInfo('ğŸ”„ ãƒªã‚»ãƒƒãƒˆå¾Œã®UIæ›´æ–°å®Œäº†');
              })
              .catch(function(error) {
                logWarn('âš ï¸ ãƒªã‚»ãƒƒãƒˆå¾Œã®UIæ›´æ–°ã§ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('è¨­å®šã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸãŒã€è¡¨ç¤ºã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'warning');
              });
          }, 1000);
        } else {
          throw new Error(result.message || 'è¨­å®šãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(function(error) {
        logError('âŒ ConfigJsonãƒªã‚»ãƒƒãƒˆã§ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('è¨­å®šãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error), 'error');
      })
      .finally(() => {
        if (button) {
          // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
          button.disabled = false;
          button.innerHTML = originalHTML;
        }
      });
      
  } catch (error) {
    logError('âŒ ConfigJsonãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
    showMessage('è¨­å®šãƒªã‚»ãƒƒãƒˆã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    if (button) {
      button.disabled = false;
      button.innerHTML = originalHTML;
    }
  }
}

// =============================================================================
// QUICKSTART FUNCTIONALITY
// =============================================================================

// QuickStart progress management
const quickStartSteps = [
  { id: 1, text: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', detail: 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’æº–å‚™ä¸­...' },
  { id: 2, text: 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', detail: 'ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...' },
  { id: 3, text: 'ã‚·ãƒ¼ãƒˆè¨­å®šã¨åˆ—æ§‹é€ ã®æœ€é©åŒ–', detail: 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’è¨­å®šä¸­...' },
  { id: 4, text: 'é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã®å®Ÿè¡Œ', detail: 'AIã«ã‚ˆã‚‹åˆ—ã®è‡ªå‹•åˆ¤å®šã‚’å®Ÿè¡Œä¸­...' },
  { id: 5, text: 'å…¬é–‹è¨­å®šã¨æ™‚é–“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º', detail: 'Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¬é–‹ä¸­...' },
  { id: 6, text: 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', detail: 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼' }
];

// Custom setup progress management
const customSetupSteps = [
  { id: 1, text: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®è§£æ', detail: 'ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’æ¤œè¨¼ä¸­...' },
  { id: 2, text: 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', detail: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ§‹ç¯‰ä¸­...' },
  { id: 3, text: 'é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã®è‡ªå‹•å®Ÿè¡Œ', detail: 'AIã«ã‚ˆã‚‹åˆ—ã®è‡ªå‹•åˆ¤å®šã‚’å®Ÿè¡Œä¸­...' },
  { id: 4, text: 'è¨­å®šã®è‡ªå‹•ä¿å­˜ã¨é©ç”¨', detail: 'AIåˆ¤å®šçµæœã‚’è¨­å®šã«é©ç”¨ä¸­...' },
  { id: 5, text: 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è‡ªå‹•å…¬é–‹', detail: 'Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¬é–‹ä¸­...' },
  { id: 6, text: 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', detail: 'ã™ã¹ã¦ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼' }
];

// Show QuickStart progress bar
function showQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.remove('hidden');
    resetProgressSteps();
  }
}

// Hide QuickStart progress bar
function hideQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.add('hidden');
  }
}

// Reset all progress steps to initial state
function resetProgressSteps() {
  quickStartSteps.forEach(step => {
    updateProgressStep(step.id, 'waiting', step.text, 'å¾…æ©Ÿä¸­...');
  });
  updateOverallProgress(0, 'åˆæœŸåŒ–ä¸­...');
}

// Update individual progress step
function updateProgressStep(stepId, status, text, detail) {
  const stepElement = document.getElementById(`progress-step-${stepId}`);
  const dotElement = document.getElementById(`progress-step-${stepId}-dot`);
  const textElement = document.getElementById(`progress-step-${stepId}-text`);
  const detailElement = document.getElementById(`progress-step-${stepId}-detail`);
  
  if (!stepElement || !dotElement || !textElement || !detailElement) return;
  
  // Update text and detail
  textElement.textContent = text;
  detailElement.textContent = detail;
  
  // Update visual state based on status
  switch (status) {
    case 'waiting':
      dotElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      textElement.className = 'text-sm text-gray-300';
      detailElement.className = 'text-xs text-gray-500';
      break;
    case 'active':
      dotElement.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse';
      textElement.className = 'text-sm text-emerald-300 font-medium';
      detailElement.className = 'text-xs text-emerald-400';
      break;
    case 'completed':
      dotElement.className = 'w-2 h-2 rounded-full bg-green-400';
      textElement.className = 'text-sm text-green-300 font-medium';
      detailElement.className = 'text-xs text-green-400';
      break;
    case 'error':
      dotElement.className = 'w-2 h-2 rounded-full bg-red-400';
      textElement.className = 'text-sm text-red-300 font-medium';
      detailElement.className = 'text-xs text-red-400';
      break;
  }
}

// Update overall progress bar
function updateOverallProgress(percentage, statusMessage) {
  const progressBar = document.getElementById('progress-bar');
  const progressPercentage = document.getElementById('progress-percentage');
  const progressStatus = document.getElementById('progress-status');
  
  if (progressBar) {
    progressBar.style.width = `${percentage}%`;
  }
  
  if (progressPercentage) {
    progressPercentage.textContent = `${percentage}%`;
  }
  
  if (progressStatus) {
    progressStatus.textContent = statusMessage;
  }
}

// Simulate QuickStart progress with enhanced backend synchronization
function simulateQuickStartProgress() {
  console.log('ğŸš€ Starting enhanced QuickStart progress simulation');
  
  // Step 1: Initialize
  updateProgressStep(1, 'active', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’æº–å‚™ä¸­...');
  updateOverallProgress(5, 'ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
  
  // Continue with timed simulation to ensure progress doesn't stop
  setTimeout(() => {
    updateProgressStep(1, 'completed', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
    updateProgressStep(2, 'active', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...');
    updateOverallProgress(20, 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
    
    setTimeout(() => {
      updateProgressStep(2, 'completed', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
      updateProgressStep(3, 'active', 'ã‚·ãƒ¼ãƒˆè¨­å®šã¨åˆ—æ§‹é€ ã®æœ€é©åŒ–', 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’è¨­å®šä¸­...');
      updateOverallProgress(40, 'ã‚·ãƒ¼ãƒˆè¨­å®šã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™...');
      
      setTimeout(() => {
        updateProgressStep(3, 'completed', 'ã‚·ãƒ¼ãƒˆè¨­å®šã¨åˆ—æ§‹é€ ã®æœ€é©åŒ–', 'âœ… ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ');
        updateProgressStep(4, 'active', 'é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã®å®Ÿè¡Œ', 'AIã«ã‚ˆã‚‹åˆ—ã®è‡ªå‹•åˆ¤å®šã‚’å®Ÿè¡Œä¸­...');
        updateOverallProgress(60, 'AIåˆ—åˆ¤å®šã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
        
        setTimeout(() => {
          updateProgressStep(4, 'completed', 'é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã®å®Ÿè¡Œ', 'âœ… AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸ');
          updateProgressStep(5, 'active', 'å…¬é–‹è¨­å®šã®é©ç”¨', 'Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¬é–‹ä¸­...');
          updateOverallProgress(80, 'å…¬é–‹è¨­å®šã‚’é©ç”¨ã—ã¦ã„ã¾ã™...');
          
          setTimeout(() => {
            updateProgressStep(5, 'completed', 'å…¬é–‹è¨­å®šã®é©ç”¨', 'âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸ');
            updateProgressStep(6, 'active', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ç¢ºèª', 'æœ€çµ‚ç¢ºèªã‚’å®Ÿè¡Œä¸­...');
            updateOverallProgress(95, 'æœ€çµ‚ç¢ºèªã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
            
            setTimeout(() => {
              console.log('âœ… QuickStart progress simulation completed - backend should be ready');
              // ã“ã“ã§æœ€çµ‚å®Œäº†çŠ¶æ…‹ã¯ executeQuickStartProcess ã®æˆåŠŸãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§è¨­å®šã•ã‚Œã‚‹
            }, 800);
          }, 1800);
        }, 3500);
      }, 1200);
    }, 1800);
  }, 1000);
  
  // Optional folder creation check (non-blocking - doesn't affect main progress)
  runGasWithUserId('createUserFolder', false)
    .then(function(folderResult) {
      console.log('âœ… QuickStart folder creation check successful:', folderResult);
    })
    .catch(function(error) {
      console.warn('âš ï¸ QuickStart folder creation check failed, but continuing:', error);
    });
}

// Simulate Custom Form progress (for custom form creation)
function simulateCustomFormProgressWithFolderCheck() {
  // Step 1: Real folder creation/check
  updateProgressStep(1, 'active', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’æº–å‚™ä¸­...');
  updateOverallProgress(5, 'ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
  
  // Actually call the folder creation API to sync with real backend progress
  runGasWithUserId('createUserFolder', 'ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªãƒ»ä½œæˆä¸­...')
    .then(function(folderResult) {
      console.log('âœ… Custom form folder creation successful:', folderResult);
      updateProgressStep(1, 'completed', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
      updateProgressStep(2, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã§ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...');
      updateOverallProgress(25, 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
      
      // Step 2: Custom form/spreadsheet creation
      setTimeout(() => {
        updateProgressStep(2, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
        updateProgressStep(3, 'active', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨ä¸­...');
        updateOverallProgress(50, 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’é©ç”¨ã—ã¦ã„ã¾ã™...');
        
        // Step 3: Custom configuration
        setTimeout(() => {
          updateProgressStep(3, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'âœ… ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ');
          updateProgressStep(4, 'active', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æœ€é©åŒ–ä¸­...');
          updateOverallProgress(75, 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™...');
          
          // Step 4: Sheet optimization
          setTimeout(() => {
            updateProgressStep(4, 'completed', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'âœ… ã‚·ãƒ¼ãƒˆæ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ');
            updateProgressStep(5, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'ãƒ•ã‚©ãƒ¼ãƒ æº–å‚™ã‚’å®Œäº†ä¸­...');
            updateOverallProgress(90, 'æœ€çµ‚æº–å‚™ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
            
            // Step 5: Final preparation
            setTimeout(() => {
              updateProgressStep(5, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ');
              updateProgressStep(6, 'active', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
              updateOverallProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
              
              setTimeout(() => {
                updateProgressStep(6, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
              }, 500);
            }, 1000);
          }, 1500);
        }, 1000);
      }, 2000);
    })
    .catch(function(error) {
      console.warn('âš ï¸ Custom form folder creation failed, continuing with fallback:', error);
      updateProgressStep(1, 'error', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'âš ï¸ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒå‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™');
      showMessage('ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆã«è­¦å‘ŠãŒã‚ã‚Šã¾ã—ãŸãŒã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚’ç¶šè¡Œã—ã¾ã™ã€‚', 'warning');
      
      // Continue with fallback timing even if folder creation fails
      setTimeout(() => {
        updateProgressStep(2, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã§ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...');
        updateOverallProgress(25, 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
        
        setTimeout(() => {
          updateProgressStep(2, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
          updateProgressStep(3, 'active', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨ä¸­...');
          updateOverallProgress(50, 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’é©ç”¨ã—ã¦ã„ã¾ã™...');
          
          setTimeout(() => {
            updateProgressStep(3, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'âœ… ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ');
            updateProgressStep(4, 'active', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æœ€é©åŒ–ä¸­...');
            updateOverallProgress(75, 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™...');
            
            setTimeout(() => {
              updateProgressStep(4, 'completed', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'âœ… ã‚·ãƒ¼ãƒˆæ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ');
              updateProgressStep(5, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'ãƒ•ã‚©ãƒ¼ãƒ æº–å‚™ã‚’å®Œäº†ä¸­...');
              updateOverallProgress(90, 'æœ€çµ‚æº–å‚™ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
              
              setTimeout(() => {
                updateProgressStep(5, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ');
                updateProgressStep(6, 'active', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
                updateOverallProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                
                setTimeout(() => {
                  updateProgressStep(6, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
                }, 500);
              }, 1000);
            }, 1500);
          }, 1000);
        }, 2000);
      }, 1000);
    });
}

// =============================================================================
// CUSTOM SETUP COMPLETION MANAGEMENT
// =============================================================================

/**
 * ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®è‡ªå‹•å®Œäº†å‡¦ç†ã‚’ãƒˆãƒªã‚¬ãƒ¼
 * @param {string} sheetName - å®Œäº†å¯¾è±¡ã®ã‚·ãƒ¼ãƒˆå
 */
function triggerCustomSetupCompletion(sheetName) {
  console.log('ğŸ¯ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è‡ªå‹•å®Œäº†å‡¦ç†é–‹å§‹:', sheetName);
  
  try {
    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    showCustomSetupOptionsSection();
    
    // å®Œäº†çŠ¶æ…‹ã‚’è¡¨ç¤º
    showCustomSetupCompletionMessage(sheetName);
    
    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ—ã‚’è‡ªå‹•æ›´æ–°
    updateSetupStepIndicator(3); // ã‚¹ãƒ†ãƒƒãƒ—3ï¼ˆå®Œäº†ï¼‰ã«æ›´æ–°
    
    console.log('âœ… ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è‡ªå‹•å®Œäº†å‡¦ç†å®Œäº†');
    
  } catch (error) {
    console.error('âŒ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è‡ªå‹•å®Œäº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
  }
}

/**
 * ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
 */
function showCustomSetupOptionsSection() {
  const optionsSection = document.getElementById('custom-options-section');
  const setupSection = document.getElementById('setup-section');
  
  if (optionsSection) {
    optionsSection.classList.remove('hidden');
    console.log('âœ… ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
  }
  
  if (setupSection) {
    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯éè¡¨ç¤ºã«ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ï¼‰
    console.log('â„¹ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯è¡¨ç¤ºã®ã¾ã¾ç¶­æŒ');
  }
}

/**
 * ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
 * @param {string} sheetName - å®Œäº†ã—ãŸã‚·ãƒ¼ãƒˆå
 */
function showCustomSetupCompletionMessage(sheetName) {
  showMessage(
    `ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼ã‚·ãƒ¼ãƒˆã€Œ${sheetName}ã€ã§AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã€è¨­å®šå¯èƒ½ãªè©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚ãŠå¥½ã¿ã«å¿œã˜ã¦è¨­å®šã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚`,
    'success',
    8000 // 8ç§’é–“è¡¨ç¤º
  );
  
  // è©³ç´°ãªå®Œäº†æƒ…å ±ã‚‚ãƒ­ã‚°å‡ºåŠ›
  console.log('ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†è©³ç´°:', {
    sheetName: sheetName,
    completedAt: new Date().toISOString(),
    nextSteps: ['ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šã®èª¿æ•´ï¼ˆä»»æ„ï¼‰', 'å…¬é–‹è¨­å®šã®ç¢ºèª']
  });
}

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
 * @param {number} step - æ›´æ–°ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·
 */
function updateSetupStepIndicator(step) {
  try {
    // æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç„¡åŠ¹åŒ–
    const activeSteps = document.querySelectorAll('.step-indicator.active');
    activeSteps.forEach(el => el.classList.remove('active'));
    
    // æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
    const targetStep = document.getElementById(`step-${step}-indicator`);
    if (targetStep) {
      targetStep.classList.add('active');
      console.log(`âœ… ã‚¹ãƒ†ãƒƒãƒ—${step}ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«æ›´æ–°`);
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    for (let i = 1; i < step; i++) {
      const completedStep = document.getElementById(`step-${i}-indicator`);
      if (completedStep) {
        completedStep.classList.add('completed');
      }
    }
    
  } catch (error) {
    console.warn('âš ï¸ ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// =============================================================================
// CUSTOM SETUP FUNCTIONALITY - Unified Automation
// =============================================================================

// Show Custom Setup progress bar
function showCustomSetupProgress() {
  const progressContainer = document.getElementById('quickstart-progress'); // Reuse same container
  if (progressContainer) {
    progressContainer.classList.remove('hidden');
    resetCustomSetupProgressSteps();
  }
}

// Hide Custom Setup progress bar
function hideCustomSetupProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.add('hidden');
  }
}

// Reset Custom Setup progress steps
function resetCustomSetupProgressSteps() {
  customSetupSteps.forEach(step => {
    updateProgressStep(step.id, 'waiting', step.text, 'å¾…æ©Ÿä¸­...');
  });
  updateOverallProgress(0, 'åˆæœŸåŒ–ä¸­...');
}

// Simulate Custom Setup progress with real backend synchronization
function simulateCustomSetupProgress() {
  console.log('ğŸ¨ Starting enhanced Custom Setup progress simulation');
  
  // Step 1: Custom form configuration analysis
  updateProgressStep(1, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®è§£æ', 'ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’æ¤œè¨¼ä¸­...');
  updateOverallProgress(10, 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’è§£æã—ã¦ã„ã¾ã™...');
  
  setTimeout(() => {
    updateProgressStep(1, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®è§£æ', 'âœ… è¨­å®šè§£æãŒå®Œäº†ã—ã¾ã—ãŸ');
    updateProgressStep(2, 'active', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ§‹ç¯‰ä¸­...');
    updateOverallProgress(25, 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
    
    setTimeout(() => {
      updateProgressStep(2, 'completed', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
      updateProgressStep(3, 'active', 'é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã®è‡ªå‹•å®Ÿè¡Œ', 'AIã«ã‚ˆã‚‹åˆ—ã®è‡ªå‹•åˆ¤å®šã‚’å®Ÿè¡Œä¸­...');
      updateOverallProgress(50, 'AIåˆ—åˆ¤å®šã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
      
      setTimeout(() => {
        updateProgressStep(3, 'completed', 'é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã®è‡ªå‹•å®Ÿè¡Œ', 'âœ… AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸ');
        updateProgressStep(4, 'active', 'è¨­å®šã®è‡ªå‹•ä¿å­˜ã¨é©ç”¨', 'AIåˆ¤å®šçµæœã‚’è¨­å®šã«é©ç”¨ä¸­...');
        updateOverallProgress(70, 'AIåˆ¤å®šçµæœã‚’è¨­å®šã«é©ç”¨ã—ã¦ã„ã¾ã™...');
        
        setTimeout(() => {
          updateProgressStep(4, 'completed', 'è¨­å®šã®è‡ªå‹•ä¿å­˜ã¨é©ç”¨', 'âœ… è¨­å®šãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ');
          updateProgressStep(5, 'active', 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è‡ªå‹•å…¬é–‹', 'Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¬é–‹ä¸­...');
          updateOverallProgress(85, 'å›ç­”ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™...');
          
          setTimeout(() => {
            updateProgressStep(5, 'completed', 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è‡ªå‹•å…¬é–‹', 'âœ… å›ç­”ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸ');
            updateProgressStep(6, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ç¢ºèª', 'æœ€çµ‚ç¢ºèªã‚’å®Ÿè¡Œä¸­...');
            updateOverallProgress(95, 'æœ€çµ‚ç¢ºèªã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
            
            setTimeout(() => {
              updateProgressStep(6, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
              updateOverallProgress(100, 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
            }, 800);
          }, 1200);
        }, 1500);
      }, 2000);
    }, 1800);
  }, 1000);
}

// Handle unified custom setup
function handleCustomSetup(config) {
  console.log('ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹:', config);
  
  // Show progress and start simulation
  showCustomSetupProgress();
  simulateCustomSetupProgress();
  
  // Call the unified backend custom setup function
  runGasWithUserId('customSetup', false, config)
    .then(function(result) {
      if (result && result.status === 'success') {
        console.log('ğŸ‰ CustomSetupãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†å®Œäº†:', result);
        
        // Enhanced completion notification with detailed backend response
        const setupStatus = result.autoPublished ? 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼' : 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼';
        updateOverallProgress(100, setupStatus);
        updateProgressStep(6, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã™ã¹ã¦ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        
        // Enhanced message display based on actual backend results
        let detailMessage = '';
        if (result.aiDetected && result.autoConfigured && result.autoPublished) {
          detailMessage = 'AIåˆ—åˆ¤å®šã€è¨­å®šä¿å­˜ã€è‡ªå‹•å…¬é–‹ãŒã™ã¹ã¦æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚ã™ãã«åˆ©ç”¨ã§ãã¾ã™ï¼';
        } else if (result.aiDetected && result.autoConfigured) {
          detailMessage = 'AIåˆ—åˆ¤å®šã¨è¨­å®šä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ç®¡ç†ãƒ‘ãƒãƒ«ã‹ã‚‰æ‰‹å‹•ã§å…¬é–‹ã—ã¦ãã ã•ã„ã€‚';
        } else {
          // Check for specific error reasons
          const aiError = result.aiDetectionResult?.error;
          const configError = result.saveResult?.error;
          const publishError = result.publishResult?.error;
          
          detailMessage = 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚';
          if (aiError) detailMessage += `AIåˆ¤å®š: ${aiError}ã€‚`;
          if (configError) detailMessage += `è¨­å®šä¿å­˜: ${configError}ã€‚`;
          if (publishError) detailMessage += `è‡ªå‹•å…¬é–‹: ${publishError}ã€‚`;
          detailMessage += 'ç®¡ç†ãƒ‘ãƒãƒ«ã§è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        }
        
        showMessage(`âœ… ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼${detailMessage}`, 'success');
        
        // Update progress step with specific status
        if (result.autoPublished) {
          updateProgressStep(5, 'completed', 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è‡ªå‹•å…¬é–‹', 'ğŸŒ ãƒœãƒ¼ãƒ‰ãŒè‡ªå‹•çš„ã«å…¬é–‹ã•ã‚Œã¾ã—ãŸ');
        } else {
          updateProgressStep(5, 'completed', 'å›ç­”ãƒœãƒ¼ãƒ‰ä½œæˆå®Œäº†', 'ğŸ“ æ‰‹å‹•å…¬é–‹ã®æº–å‚™ãŒã§ãã¾ã—ãŸ');
        }
        
        // Log detailed completion status
        console.log('ğŸ“Š CustomSetupå®Œäº†è©³ç´°:', {
          setupComplete: result.setupComplete,
          aiDetected: result.aiDetected,
          autoConfigured: result.autoConfigured,
          autoPublished: result.autoPublished,
          completedSteps: result.completedSteps,
          completedAt: result.completedAt
        });
        
        // Log custom setup specific information
        if (result.aiDetectionResult) {
          console.log('ğŸ¤– AIåˆ—åˆ¤å®šçµæœè©³ç´°:', {
            success: result.aiDetectionResult.success,
            aiDetected: result.aiDetectionResult.aiDetected,
            guessedConfig: result.aiDetectionResult.guessedConfig
          });
        }
        
        if (result.saveResult) {
          console.log('ğŸ’¾ è¨­å®šä¿å­˜çµæœè©³ç´°:', {
            success: result.saveResult.success,
            configured: result.saveResult.configured,
            savedConfig: result.saveResult.savedConfig
          });
        }
        
        if (result.publishResult) {
          console.log('ğŸŒ è‡ªå‹•å…¬é–‹çµæœè©³ç´°:', {
            success: result.publishResult.success,
            published: result.publishResult.published,
            publishedAt: result.publishResult.publishedAt
          });
        }
        
        // Update status after custom setup
        if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
          window.unifiedCache.clear();
        }
        loadStatus(true);
        
        // CustomSetupãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªï¼ˆåŒ…æ‹¬çš„ãªå®Œäº†çŠ¶æ…‹æ¤œè¨¼ï¼‰
        setTimeout(async () => {
          try {
            const sheetName = result.sheetName || 'unknown_sheet';
            const completionResult = await verifySetupFlowCompletion('custom', sheetName);
            
            if (completionResult.success) {
              console.log('ğŸ‰ CustomSetupãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèª: å…¨è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™', completionResult.details);
              
              // CustomSetupæˆåŠŸæ™‚ã‚‚è¨­å®šåŒæœŸã‚’å®Ÿè¡Œï¼ˆå …ç‰¢æ€§ã®å‘ä¸Šï¼‰
              try {
                const syncResult = await enhanceConfigSynchronization('custom', {
                  sheetName: sheetName,
                  spreadsheetId: result.spreadsheetId,
                  config: result.aiDetectionResult?.guessedConfig || {}
                });
                
                if (syncResult.synchronized) {
                  console.log('ğŸ”§ CustomSetup: è¨­å®šåŒæœŸã§è¿½åŠ æœ€é©åŒ–ã‚’å®Ÿè¡Œ', syncResult.appliedFixes);
                }
              } catch (syncError) {
                console.warn('âš ï¸ CustomSetup: è¨­å®šåŒæœŸå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ•ãƒ­ãƒ¼å®Œäº†ã«ã¯å½±éŸ¿ãªã—ï¼‰', syncError);
              }
            } else {
              console.warn('âš ï¸ CustomSetupãƒ•ãƒ­ãƒ¼: æœªå®Œäº†é …ç›®ãŒã‚ã‚Šã¾ã™', completionResult);
              
              // CustomSetupã§æœªå®Œäº†é …ç›®ãŒã‚ã‚‹å ´åˆã¯ç©æ¥µçš„ã«åŒæœŸä¿®æ­£ã‚’è©¦è¡Œ
              try {
                const syncResult = await enhanceConfigSynchronization('custom', {
                  sheetName: sheetName,
                  spreadsheetId: result.spreadsheetId,
                  config: result.aiDetectionResult?.guessedConfig || {}
                });
                
                if (syncResult.synchronized) {
                  console.log('ğŸ”§ CustomSetup: æœªå®Œäº†é …ç›®ã‚’åŒæœŸä¿®æ­£ã§è‡ªå‹•è§£æ±º', syncResult.appliedFixes);
                }
              } catch (syncError) {
                console.error('âŒ CustomSetup: åŒæœŸä¿®æ­£å‡¦ç†ã‚¨ãƒ©ãƒ¼', syncError);
              }
            }
          } catch (verificationError) {
            console.error('âŒ CustomSetupãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªã‚¨ãƒ©ãƒ¼:', verificationError);
          }
        }, 2000);
        
        // Hide progress after completion
        setTimeout(() => {
          hideCustomSetupProgress();
        }, 5000);
        
      } else {
        console.error('âŒ CustomSetup backend error:', result);
        updateProgressStep(6, 'error', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¤±æ•—', 'âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        showMessage('âŒ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result?.message || 'unknown error'), 'error');
        hideCustomSetupProgress();
      }
    })
    .catch(function(error) {
      console.error('âŒ CustomSetup backend call failed:', error);
      updateProgressStep(6, 'error', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¤±æ•—', 'âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      showMessage('âŒ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
      hideCustomSetupProgress();
    });
}

// Handle quick start setup
function handleQuickStart() {
  const quickstartBtn = document.getElementById('quickstart-btn');
  const quickstartText = document.getElementById('quickstart-text');
  
  if (!quickstartBtn || !quickstartText) {
    console.error('QuickStart elements not found');
    return;
  }

  // å…¬é–‹çŠ¶æ…‹ã«å¿œã˜ãŸã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†ã‚’å®Ÿè¡Œ
  executeQuickStart(quickstartBtn, quickstartText);
}

// å…¬é–‹çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function checkPublicationStatusAndProceed(onProceed, onCancel) {
  // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰å…¬é–‹çŠ¶æ…‹ã‚’ç¢ºèª
  if (currentStatus && currentStatus._normalized && currentStatus._normalized.isPublished) {
    // å…¬é–‹ä¸­ã®å ´åˆã€ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.sharedModals.showQuickStartStopConfirmation(
      () => {
        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåœæ­¢ã—ã¦æ–°è¦ä½œæˆã‚’é¸æŠ');
        if (onProceed) onProceed();
      },
      () => {
        console.log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’é¸æŠ');
        if (onCancel) onCancel();
      }
    );
  } else {
    // å…¬é–‹ã—ã¦ã„ãªã„å ´åˆã€ç›´æ¥é€²è¡Œ
    console.log('ğŸ“ å…¬é–‹ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ç›´æ¥ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹');
    if (onProceed) onProceed();
  }
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®å®Ÿéš›ã®å®Ÿè¡Œ
function executeQuickStart(quickstartBtn, quickstartText) {
  // ç¾åœ¨ã®å…¬é–‹çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆç°¡ç´ åŒ–ãƒ»å®‰å®šåŒ–ï¼‰
  const isCurrentlyPublished = currentStatus && (
    currentStatus.isPublished || 
    currentStatus.appPublished ||
    (currentStatus.config && currentStatus.config.isPublished) ||
    (currentStatus._normalized && currentStatus._normalized.isPublished)
  );
  
  console.log('ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œ: å…¬é–‹çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¿®æ­£ç‰ˆï¼‰', {
    isCurrentlyPublished: isCurrentlyPublished,
    hasCurrentStatus: !!currentStatus,
    isPublished: currentStatus?.isPublished,
    appPublished: currentStatus?.appPublished
  });
  
  if (isCurrentlyPublished) {
    // å…¬é–‹ä¸­ã®å ´åˆ: ã‚·ãƒ³ãƒ—ãƒ«ãªæ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆåœæ­¢ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    console.log('ğŸ“¢ å…¬é–‹ä¸­ã®ãŸã‚ã€ã‚·ãƒ³ãƒ—ãƒ«ãªæ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™');
    showSimpleQuickStartModal(quickstartBtn, quickstartText);
  } else {
    // éå…¬é–‹ã®å ´åˆ: ç›´æ¥ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œï¼ˆè‡ªå‹•å…¬é–‹ãƒ•ãƒ©ã‚°ä»˜ãï¼‰
    console.log('ğŸ“ ç¾åœ¨éå…¬é–‹ã®ãŸã‚ã€ç›´æ¥ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆè‡ªå‹•å…¬é–‹ï¼‰');
    executeQuickStartProcess(quickstartBtn, quickstartText, true); // autoPublish = true
  }
}

// å…¬é–‹ä¸­ãƒœãƒ¼ãƒ‰åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showQuickStartStopConfirmation(quickstartBtn, quickstartText) {
  if (window.sharedModals && typeof window.sharedModals.showQuickStartStopConfirmation === 'function') {
    window.sharedModals.showQuickStartStopConfirmation(
      // ç¢ºèªæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      () => {
        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåœæ­¢ã—ã¦æ–°è¦ä½œæˆã‚’ç¢ºèªã—ã¾ã—ãŸ');
        executeQuickStartProcess(quickstartBtn, quickstartText, true); // autoPublish = true
      },
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      () => {
        console.log('âŒ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
      }
    );
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    if (confirm('ç¾åœ¨å…¬é–‹ä¸­ã®ãƒœãƒ¼ãƒ‰ã‚’åœæ­¢ã—ã¦ã€æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
      executeQuickStartProcess(quickstartBtn, quickstartText, true);
    } else {
      quickstartBtn.disabled = false;
      quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
    }
  }
}

// å…¬é–‹ä¸­ãƒœãƒ¼ãƒ‰ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showSimpleQuickStartModal(quickstartBtn, quickstartText) {
  console.log('ğŸ“± ã‚·ãƒ³ãƒ—ãƒ«ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™');
  
  // sharedModalsãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯å°‚ç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½¿ç”¨
  if (window.sharedModals && typeof window.sharedModals.showConfirmation === 'function') {
    const modalTitle = 'æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ';
    const modalContent = `
      <div class="text-gray-700 mb-4">
        <p class="mb-3">ç¾åœ¨å…¬é–‹ä¸­ã®å›ç­”ãƒœãƒ¼ãƒ‰ã‚’ä¸€æ™‚åœæ­¢ã—ã¦ã€æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
        
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <h4 class="font-semibold text-blue-800 mb-2 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            ğŸ“‹ å®Ÿè¡Œå†…å®¹
          </h4>
          <ul class="text-sm text-blue-700 space-y-1">
            <li>â€¢ æ—¢å­˜ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™</li>
            <li>â€¢ æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ</li>
            <li>â€¢ é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã‚’å®Ÿè¡Œ</li>
            <li>â€¢ ä½œæˆå®Œäº†å¾Œã«è‡ªå‹•ã§å†å…¬é–‹</li>
          </ul>
        </div>
      </div>
    `;
    
    window.sharedModals.showConfirmation(
      modalTitle,
      modalContent,
      function() {
        // åœæ­¢ã—ã¦æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œåœæ­¢ã—ã¦æ–°è¦ä½œæˆã€ã‚’é¸æŠã—ã¾ã—ãŸ');
        
        // å…¬é–‹åœæ­¢å‡¦ç†ã¨ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’çµ±åˆå®Ÿè¡Œ
        executeStopAndQuickStart(quickstartBtn, quickstartText);
      },
      function() {
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®å‡¦ç†
        console.log('âŒ ã‚·ãƒ³ãƒ—ãƒ«ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        resetQuickStartButton(quickstartBtn, quickstartText);
      },
      'åœæ­¢ã—ã¦æ–°è¦ä½œæˆ', // ç¢ºèªãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆ
      'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆ
    );
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ¨™æº–confirm
    const confirmMessage = 'ç¾åœ¨å…¬é–‹ä¸­ã®å›ç­”ãƒœãƒ¼ãƒ‰ã‚’åœæ­¢ã—ã¦ã€æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nâ€¢ æ—¢å­˜ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™\nâ€¢ æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ\nâ€¢ é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã‚’å®Ÿè¡Œ\nâ€¢ ä½œæˆå®Œäº†å¾Œã«è‡ªå‹•ã§å†å…¬é–‹';
    
    if (confirm(confirmMessage)) {
      executeStopAndQuickStart(quickstartBtn, quickstartText);
    } else {
      resetQuickStartButton(quickstartBtn, quickstartText);
    }
  }
}

// å…¬é–‹åœæ­¢ã¨ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®çµ±åˆå‡¦ç†
function executeStopAndQuickStart(quickstartBtn, quickstartText) {
  console.log('ğŸ›‘ğŸ“‹ å…¬é–‹åœæ­¢â†’ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®çµ±åˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™');
  
  // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
  quickstartBtn.disabled = true;
  quickstartText.textContent = 'å…¬é–‹åœæ­¢ä¸­...';
  
  // 1. ã¾ãšå…¬é–‹åœæ­¢å‡¦ç†ã‚’å®Ÿè¡Œ
  if (typeof unpublishBoard === 'function') {
    showMessage('ç¾åœ¨ã®å›ç­”ãƒœãƒ¼ãƒ‰ã‚’åœæ­¢ã—ã¦ã„ã¾ã™...', 'info');
    
    unpublishBoard()
      .then(function(stopResult) {
        console.log('âœ… å…¬é–‹åœæ­¢ãŒå®Œäº†ã—ã¾ã—ãŸ:', stopResult);
        showMessage('âœ… å…¬é–‹åœæ­¢ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™...', 'success');
        
        // å…¬é–‹åœæ­¢ãŒå®Œäº†ã—ãŸã‚‰ã€å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’å®Ÿè¡Œ
        setTimeout(() => {
          quickstartText.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...';
          console.log('ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆè‡ªå‹•å…¬é–‹ãƒ¢ãƒ¼ãƒ‰ï¼‰');
          
          // 2. ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œï¼ˆè‡ªå‹•å…¬é–‹ãƒ•ãƒ©ã‚°ä»˜ãï¼‰
          executeQuickStartProcess(quickstartBtn, quickstartText, true);
        }, 1000);
      })
      .catch(function(stopError) {
        console.error('âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ:', stopError);
        showMessage('âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
        resetQuickStartButton(quickstartBtn, quickstartText);
      });
  } else {
    console.error('âŒ unpublishBoard function not found');
    showMessage('âŒ å…¬é–‹åœæ­¢æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    resetQuickStartButton(quickstartBtn, quickstartText);
  }
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
function resetQuickStartButton(quickstartBtn, quickstartText) {
  if (quickstartBtn && quickstartText) {
    quickstartBtn.disabled = false;
    quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
  }
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œ
function executeQuickStartProcess(quickstartBtn, quickstartText, autoPublish = false) {
  // Update button state
  quickstartBtn.disabled = true;
  quickstartText.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...';
  
  // Show progress bar and start simulation
  showQuickStartProgress();
  simulateQuickStartProgress();
  
  // Show loading message optimized for QuickStart
  // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆä¸­ã¯å°‚ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€æ±ç”¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è¡¨ç¤ºã—ãªã„
  
  runGasWithUserId('quickStartSetup', false)
    .then(function(result) {
      if (result && result.status === 'success') {
        console.log('ğŸ‰ QuickStartãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†å®Œäº†:', result);
        
        // Enhanced completion notification with detailed backend response
        updateOverallProgress(100, result.autoPublished ? 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼' : 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼');
        updateProgressStep(6, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã™ã¹ã¦ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
        
        // Enhanced message display based on actual backend results
        const publishStatus = result.autoPublished ? 'å…¬é–‹ã•ã‚Œã¾ã—ãŸ' : 'ä½œæˆã•ã‚Œã¾ã—ãŸ';
        let detailMessage;
        
        if (result.autoPublished) {
          detailMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ãŒè‡ªå‹•ä½œæˆã•ã‚Œã€å…¬é–‹ã•ã‚Œã¾ã—ãŸã€‚ã™ãã«åˆ©ç”¨ã§ãã¾ã™ï¼';
        } else {
          // Check if there's a specific reason for auto-publish failure
          const publishError = result.publishResult?.error;
          const manualInstructions = result.publishResult?.manualPublishInstructions;
          
          detailMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚';
          if (publishError) {
            detailMessage += `è‡ªå‹•å…¬é–‹ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆ${publishError}ï¼‰ã€‚`;
          }
          if (manualInstructions) {
            detailMessage += manualInstructions;
          } else {
            detailMessage += 'ç®¡ç†ãƒ‘ãƒãƒ«ã‹ã‚‰æ‰‹å‹•ã§å…¬é–‹ã—ã¦ãã ã•ã„ã€‚';
          }
        }
        
        showMessage(`âœ… ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼${detailMessage}`, 'success');
        
        // Update progress step with auto-publish status
        if (result.autoPublished) {
          updateProgressStep(5, 'completed', 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è‡ªå‹•å…¬é–‹', 'ğŸŒ ãƒœãƒ¼ãƒ‰ãŒè‡ªå‹•çš„ã«å…¬é–‹ã•ã‚Œã¾ã—ãŸ');
        } else {
          updateProgressStep(5, 'completed', 'å›ç­”ãƒœãƒ¼ãƒ‰ä½œæˆå®Œäº†', 'ğŸ“ æ‰‹å‹•å…¬é–‹ã®æº–å‚™ãŒã§ãã¾ã—ãŸ');
        }
        
        // Log detailed completion status
        console.log('ğŸ“Š QuickStartå®Œäº†è©³ç´°:', {
          setupComplete: result.setupComplete,
          autoPublished: result.autoPublished,
          publishResult: result.publishResult,
          completedSteps: result.completedSteps,
          completedAt: result.completedAt
        });
        
        // Log auto-publish specific information if available
        if (result.publishResult) {
          console.log('ğŸŒ è‡ªå‹•å…¬é–‹çµæœè©³ç´°:', {
            success: result.publishResult.success,
            published: result.publishResult.published,
            publishedAt: result.publishResult.publishedAt,
            error: result.publishResult.error,
            manualInstructions: result.publishResult.manualPublishInstructions
          });
        }
        
        // Update status after quick start
        if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
          window.unifiedCache.clear();
        }
        loadStatus(true);
        
        // QuickStartãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªï¼ˆåŒ…æ‹¬çš„ãªå®Œäº†çŠ¶æ…‹æ¤œè¨¼ï¼‰
        setTimeout(async () => {
          try {
            const sheetName = result.sheetName || result.publishedSheetName || 'unknown_sheet';
            const completionResult = await verifySetupFlowCompletion('quickstart', sheetName);
            
            if (completionResult.success) {
              console.log('ğŸ‰ QuickStartãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèª: å…¨è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™', completionResult.details);
              
              // QuickStartæˆåŠŸæ™‚ã‚‚è¨­å®šåŒæœŸã‚’å®Ÿè¡Œï¼ˆå …ç‰¢æ€§ã®å‘ä¸Šï¼‰
              try {
                const syncResult = await enhanceConfigSynchronization('quickstart', {
                  sheetName: sheetName,
                  spreadsheetId: result.spreadsheetId,
                  config: result.config || {}
                });
                
                if (syncResult.synchronized) {
                  console.log('ğŸ”§ QuickStart: è¨­å®šåŒæœŸã§è¿½åŠ æœ€é©åŒ–ã‚’å®Ÿè¡Œ', syncResult.appliedFixes);
                }
              } catch (syncError) {
                console.warn('âš ï¸ QuickStart: è¨­å®šåŒæœŸå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ•ãƒ­ãƒ¼å®Œäº†ã«ã¯å½±éŸ¿ãªã—ï¼‰', syncError);
              }
            } else {
              console.warn('âš ï¸ QuickStartãƒ•ãƒ­ãƒ¼: æœªå®Œäº†é …ç›®ãŒã‚ã‚Šã¾ã™', completionResult);
              
              // QuickStartã§æœªå®Œäº†é …ç›®ãŒã‚ã‚‹å ´åˆã¯ç©æ¥µçš„ã«åŒæœŸä¿®æ­£ã‚’è©¦è¡Œ
              try {
                const syncResult = await enhanceConfigSynchronization('quickstart', {
                  sheetName: sheetName,
                  spreadsheetId: result.spreadsheetId,
                  config: result.config || {}
                });
                
                if (syncResult.synchronized) {
                  console.log('ğŸ”§ QuickStart: æœªå®Œäº†é …ç›®ã‚’åŒæœŸä¿®æ­£ã§è‡ªå‹•è§£æ±º', syncResult.appliedFixes);
                  
                  // å†åº¦å®Œäº†ç¢ºèªã‚’å®Ÿè¡Œ
                  const reVerificationResult = await verifySetupFlowCompletion('quickstart', sheetName);
                  if (reVerificationResult.success) {
                    console.log('âœ… QuickStart: åŒæœŸä¿®æ­£å¾Œã®å†ç¢ºèªã§å®Œäº†ã‚’ç¢ºèª');
                  } else {
                    console.warn('âš ï¸ QuickStart: åŒæœŸä¿®æ­£å¾Œã‚‚æœªå®Œäº†é …ç›®ãŒæ®‹å­˜', reVerificationResult.issues);
                  }
                } else {
                  // åŒæœŸä¿®æ­£ã§ããªã„å ´åˆã®è­¦å‘Šï¼ˆQuickStartã§ã¯æ§ãˆã‚ã«ï¼‰
                  let notificationMessage = `ğŸ” QuickStartå®Œäº†ç¢ºèª:\n`;
                  if (completionResult.issues && completionResult.issues.length > 0) {
                    notificationMessage += `æœªå®Œäº†é …ç›®: ${completionResult.issues.length}ä»¶\n`;
                    console.log('ğŸ“‹ QuickStartæœªå®Œäº†è©³ç´°:', completionResult.issues);
                  }
                  notificationMessage += 'è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
                  console.info(notificationMessage);
                }
              } catch (syncError) {
                console.error('âŒ QuickStart: åŒæœŸä¿®æ­£å‡¦ç†ã‚¨ãƒ©ãƒ¼', syncError);
              }
            }
          } catch (verificationError) {
            console.error('âŒ QuickStartãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªã‚¨ãƒ©ãƒ¼:', verificationError);
          }
        }, 2000);
        
        // å…¬é–‹æ™‚ã¯å±¥æ­´ä¿å­˜ã‚’è¡Œã‚ãªã„ï¼ˆå…¬é–‹åœæ­¢æ™‚ã«ä¿å­˜ã™ã‚‹ãŸã‚ï¼‰
        logDebug('QuickStart completed - history will be saved on unpublish');
        
        // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        sessionStorage.setItem('form_just_created', 'true');
        
        // ãƒ•ã‚©ãƒ¼ãƒ URLè¡¨ç¤ºã®å¼·åˆ¶æ›´æ–°ï¼ˆç®¡ç†ãƒ‘ãƒãƒ«ã®ãƒªã‚½ãƒ¼ã‚¹æ¬„ç”¨ï¼‰
        setTimeout(() => {
          updateFormUrlDisplay();
          
          // äºˆå®šçµ‚äº†æ™‚é–“ã®è¡¨ç¤ºã‚’æ›´æ–°
          const scheduledEndTimeElement = document.getElementById('scheduled-end-time');
          if (scheduledEndTimeElement && window.lastStatusCache?.config) {
            updateScheduledEndTime(window.lastStatusCache.config, scheduledEndTimeElement);
          }
          
          // å…¬é–‹åœæ­¢ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
          if (typeof updateUnpublishButton === 'function' && window.lastStatusCache) {
            updateUnpublishButton(window.lastStatusCache);
          }
        }, 1000);
        
        // å›ç­”ãƒœãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ã‚’é€šçŸ¥ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯æ›´æ–°ç”¨ï¼‰
        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'FORM_CREATED',
              formUrl: result.formUrl,
              timestamp: Date.now()
            }, '*');
          }
          
          if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('board-updates');
            channel.postMessage({
              type: 'FORM_CREATED',
              formUrl: result.formUrl,
              timestamp: Date.now()
            });
            channel.close();
          }
        } catch (notifyError) {
          console.warn('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆé€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼:', notifyError);
        }
        
        // Reset button state
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†';
        
        // è‡ªå‹•å…¬é–‹ã®å ´åˆã®ã¿è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        if (autoPublish) {
          console.log('ğŸš€ è‡ªå‹•å…¬é–‹ãŒæœ‰åŠ¹ãªãŸã‚ã€è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™');
          
          setTimeout(() => {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            if (window.unifiedLoadingManager) {
              window.unifiedLoadingManager.setLoading(false);
            }
            
            // URLç”Ÿæˆç¢ºèªã¨ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’å®Ÿè¡Œ
            const enhancedResult = {
              ...result,
              url: result?.url || '',
              autoStopMinutes: result?.autoStopMinutes || 360,
              autoStopTime: result?.autoStopTime || '',
              publicationData: {
                isPublished: result?.success || false,
                hasValidUrl: !!(result?.url && result.url.length > 0),
                timestamp: new Date().toISOString()
              }
            };
            
            console.log('ğŸ“Š QuickStartå…¬é–‹ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼:', {
              autoPublish: autoPublish,
              hasResult: !!result,
              hasUrl: !!(result?.url && result.url.length > 0),
              enhancedResult: enhancedResult
            });
            
            // è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆæ¤œè¨¼æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã§ï¼‰
            setTimeout(() => {
              if (window.sharedModals && typeof window.sharedModals.showAutoStopConfirmation === 'function') {
                window.sharedModals.showAutoStopConfirmation(enhancedResult);
                console.log('âœ… QuickStartè‡ªå‹•å…¬é–‹å¾Œã«è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
              } else {
                console.warn('âš ï¸ è‡ªå‹•åœæ­¢ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              }
            }, 800);
          }, 2000);
        } else {
          console.log('â„¹ï¸ è‡ªå‹•å…¬é–‹ãŒç„¡åŠ¹ã®ãŸã‚ã€è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
        }
        
        // Hide progress bar after delay and reset button
        setTimeout(() => {
          hideQuickStartProgress();
          quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
          quickstartBtn.disabled = false;
        }, 5000);
      } else {
        logWarn('QuickStart returned error result:', result);
        
        // Show error in progress
        updateProgressStep(6, 'error', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', result?.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        updateOverallProgress(0, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        let errorMessage = result?.message || 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        if (errorMessage.includes('permission') || errorMessage.includes('æ¨©é™') || 
            errorMessage.includes('Drive') || errorMessage.includes('Sheets')) {
          errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Google Drive ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ãªã„å ´åˆã€æ¨©é™ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
        }
        
        showMessage(errorMessage, 'error');
        
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
        
        // Hide progress bar after delay
        setTimeout(() => {
          hideQuickStartProgress();
        }, 3000);
      }
    })
    .catch(function(error) {
      logError('QuickStart error:', error);
      
      // Show error in progress
      updateProgressStep(6, 'error', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      updateOverallProgress(0, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      
      // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      if (error.toString().includes('permission') || error.toString().includes('æ¨©é™') || 
          error.toString().includes('Drive') || error.toString().includes('Sheets')) {
        errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Google Drive ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ãªã„å ´åˆã€æ¨©é™ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
      }
      
      if (typeof handleError === 'function') {
        handleError(error, 'handleQuickStart', errorMessage);
      } else {
        showMessage(errorMessage, 'error');
      }
      
      quickstartBtn.disabled = false;
      quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
      
      // Hide progress bar after delay
      setTimeout(() => {
        hideQuickStartProgress();
      }, 3000);
    });
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize API communications
function initializeAPI() {
  logDebug('ğŸ”§ APIåˆæœŸåŒ–é–‹å§‹');
  
  // Start background status updates
  startSystemStatusUpdate();
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);

  // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒ­ãƒ¼ãƒ‰
  logDebug('ğŸš€ loadStatus()ã‚’å‘¼ã³å‡ºã—ã¾ã™');
  loadStatus();
  
  logDebug('âœ… APIåˆæœŸåŒ–å®Œäº†');
}

// =============================================================================
// MISSING FUNCTIONS RESTORATION
// =============================================================================

// Wrapper for loadStatus to maintain compatibility
function loadSystemStatus(bypassCache = false) {
  loadStatus(bypassCache);
}

// Basic loadUserInfo implementation
function loadUserInfo() {
  logDebug('ğŸ“‹ loadUserInfo called - delegating to loadStatus');
  loadStatus();
}

// Update answer count function
function updateAnswerCount() {
  if (!currentStatus || !currentStatus._normalized || !currentStatus._normalized.isPublished) {
    return;
  }
  
  const answerCountElement = document.getElementById('answer-count');
  if (answerCountElement && currentStatus.answerCount !== undefined) {
    answerCountElement.textContent = currentStatus.answerCount || '0';
  }
}

// Setup real-time updates
function setupRealtimeUpdates() {
  // Update system status every 30 seconds
  setInterval(loadSystemStatus, 30000);
  
  // Update answer count every 10 seconds when published
  setInterval(() => {
    const publishText = document.getElementById('info-publish-text');
    if (publishText && publishText.textContent === 'å…¬é–‹ä¸­') {
      updateAnswerCount();
    }
  }, 10000);
}

// Initialize when DOM is ready
// åˆæœŸåŒ–ã¯ adminPanel-core.js ã®çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ã§ç®¡ç†ã•ã‚Œã¾ã™


</script>
