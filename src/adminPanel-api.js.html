<script>
// =============================================================================
// ADMIN PANEL API COMMUNICATIONS & BACKEND CALLS
// =============================================================================

// =============================================================================
// BACKEND FUNCTION WRAPPERS
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: æ–°ã—ã„runGasWithUserIdé–¢æ•°
function runGasWithUserId(functionName, ...args) {
  let userIdToSend = userId; // Use a local variable for clarity

  // If userId is not set (null/undefined), wait for initialization
  if (!userIdToSend) {
    return userIdPromise.then(resolvedUserId => {
      userIdToSend = resolvedUserId; // Update local variable with resolved ID
      // Perform validation after resolution
      validateUserId(userIdToSend, functionName);
      return gasOptimizer.call(functionName, userIdToSend, ...args);
    }).catch(error => {
      console.error('âŒ runGasWithUserId: userIdã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    });
  }

  // If userId is already set, validate its type
  if (typeof userIdToSend !== 'string' || userIdToSend.trim() === '') {
    // This is the problematic case: userId is set but not a valid string
    const errorMsg = `runGasWithUserId: ç„¡åŠ¹ãªuserIdãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™: "${userIdToSend}" (type: ${typeof userIdToSend})`;
    console.error('âŒ ' + errorMsg);
    // Throw an error immediately to prevent sending invalid data to backend
    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
  }

  // If userId is a valid string, proceed
  validateUserId(userIdToSend, functionName); // This validation should now catch it if it's not a string
  return gasOptimizer.call(functionName, userIdToSend, ...args);
}

// callWithCache é–¢æ•° - èª­ã¿å–ã‚Šå°‚ç”¨æ“ä½œç”¨
function callWithCache(functionName, cacheKey, ttl, ...args) {
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, ...args);
  }, ttl);
}

// runGasWithUserId with cache support
function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
      return unifiedCache.getOrSet(cacheKey, function() {
        return gasOptimizer.call(functionName, userId, ...args);
      }, ttl);
    });
  }
  
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, userId, ...args);
  }, ttl);
}

// =============================================================================
// STATUS AND DATA LOADING
// =============================================================================

// Load system status - OPTIMIZED with integrated API
function loadStatus(bypassCache = false) {
  console.group('ğŸ”„ loadStatus - Integrated API');
  console.log('ğŸš€ Loading system status with integrated API, bypassCache:', bypassCache);

  // Single API call to get all initial data
  logDebug('Calling setLoading(true) from loadStatus');
  setLoading(true, 'ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...', 1, 10); // Step 1: Initializing

  sharedUtilities.gas.callWithLoading('getInitialData', 'ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...')
    .then(response => {
      console.log('âœ… Integrated data loaded:', response);

      // Extract userId for compatibility
      if (response.userInfo && response.userInfo.userId) {
        userId = response.userInfo.userId;
        console.log('âœ… userId extracted from integrated response:', userId);
      }

      // Update UI with integrated response
      updateUIWithNewStatus(response);

      // If sheet details are included, apply them immediately
      if (response.sheetDetails && response.activeSheetName) {
        console.log('âœ… Sheet details included in integrated response, applying configuration');
        try {
          populateHeaderOptions(response.sheetDetails.allHeaders);
          console.log('âœ… Header options populated from integrated data');
          populateConfig(response.sheetDetails.guessedConfig);
          console.log('âœ… AI configuration applied from integrated data');
        } catch (configError) {
          console.error('Error applying sheet configuration from integrated data:', configError);
        }
      }
      console.log('âš¡ Performance: Single API call replaced 3-4 separate calls');
    })
    .catch(error => {
      console.error('âŒ Integrated API failed:', error);
      showMessage('ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    })
    .finally(() => {
      console.groupEnd();
    });
}

// Load sheet configuration for selected sheet
function loadConfigForSelected() {
  if (!selectedSheet) {
    logWarn('No sheet selected for config loading');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    logError('Missing required data for loadConfigForSelected');
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  sharedUtilities.gas.callWithLoading('getSheetDetails', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
    .then(handleSheetDetailsSuccess)
    .catch(handleSheetDetailsError);
}

// Handle successful sheet details loading
function handleSheetDetailsSuccess(details) {
  if (details && details.allHeaders) {
    populateHeaderOptions(details.allHeaders);
    
    // Show config area and hide placeholder
    const configArea = document.getElementById('config-area');
    const configPlaceholder = document.getElementById('config-placeholder');
    
    if (configArea) {
      configArea.classList.remove('hidden');
    }
    
    if (configPlaceholder) {
      configPlaceholder.classList.add('hidden');
    }
    
    if (details.guessedConfig) {
      // DOMã®æ›´æ–°ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰populateConfigã‚’å‘¼ã³å‡ºã™
      setTimeout(() => {
        populateConfig(details.guessedConfig);
        showMessage('AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'success');
      }, 0);
    }
  } else {
    logWarn('No headers in sheet details:', details);
    showMessage('ã‚·ãƒ¼ãƒˆã®è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'warning');
  }
}

// Handle sheet details loading error
function handleSheetDetailsError(error) {
  logError('Sheet details failed:', error);
  handleError(error, 'loadConfigForSelected', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
}

// =============================================================================
// AI COLUMN DETECTION
// =============================================================================

// Run AI-powered header guessing
function runHeaderGuessing() {
  if (!selectedSheet) {
    showMessage('ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  sharedUtilities.gas.callWithLoading('getSheetDetails', 'AIæ­è¼‰é«˜ç²¾åº¦åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãŒåˆ†æä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
    .then(function(details) {
      const configToUse = {
        ...details.guessedConfig,
        sheetName: selectedSheet
      };
      
      setTimeout(() => {
        populateConfig(configToUse);
        showMessage('AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼è¨­å®šã‚’ç¢ºèªã—ã¦ã€Œä¿å­˜ãƒ»å…¬é–‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'success');
      }, 0);
    })
    .catch(function(error) {
      handleError(error, 'runHeaderGuessing', 'AIåˆ—åˆ¤å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    });
}

// =============================================================================
// SAVE AND PUBLISH OPERATIONS
// =============================================================================

// Save configuration and publish board
function saveAndPublish() {
  if (!validateConfig()) {
    showMessage('å¿…é ˆé …ç›®ï¼ˆå›ç­”ãƒ‡ãƒ¼ã‚¿åˆ—ï¼‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  // Set save protection flags to prevent interference
  isSaveInProgress = true;
  freshSaveTimestamp = Date.now();
  window.freshSaveTimestamp = freshSaveTimestamp;
  
  sharedUtilities.gas.callWithLoading('saveAndPublish', 'è¨­å®šã‚’ä¿å­˜ã—ã€ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™...', selectedSheet, config)
    .then(function(result) {
      isSaveInProgress = false;
      
      // Check if result has data (from integrated API) or legacy success status
      if (result && (result.userInfo || result.status === 'success')) {
        showMessage('âœ… è¨­å®šãŒä¿å­˜ã•ã‚Œã€ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
        
        // Use fresh data from save response if available
        if (result.userInfo && result._meta) {
          logInfo('Using fresh data from save response');
          updateUIWithNewStatus(result);
        } else {
          // Only force refresh if no fresh data available
          logInfo('No fresh data in response, forcing refresh');
          loadStatus(true);
        }
      } else {
        logError('Save failed:', result);
        showMessage(result.message || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        isSaveInProgress = false;
      }
    })
    .catch(function(error) {
      logError('saveAndPublish error:', error);
      isSaveInProgress = false;
      
      // Clear caches after error and reload
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      
      loadStatus(true);
      handleError(error, 'saveAndPublish', 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸã€‚');
    });
}

// Unpublish board
function unpublishBoard() {
  sharedUtilities.gas.callWithLoading('unpublishBoard', 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ä¸­...')
    .then(function(response) {
      console.log('å…¬é–‹åœæ­¢ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
      showMessage(response.message || 'âœ… å›ç­”ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚', 'success');
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      loadStatus(true); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¼·åˆ¶æ›´æ–°
    })
    .catch(function(error) {
      handleError(error, 'unpublishBoard', 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    });
}

// =============================================================================
// FORM MANAGEMENT
// =============================================================================

// Load saved class choices
function loadSavedClassChoices() {
    sharedUtilities.gas.callWithLoading('getSavedClassChoices', 'ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’èª­ã¿è¾¼ã¿ä¸­...')
        .then(function(result) {
            if (result.status === 'success' && result.classChoices) {
                const enableClassSelectionCheckbox = document.getElementById('enable-class-selection');
                const classCountSelect = document.getElementById('class-count-select');
                const classChoicesContainer = document.getElementById('class-choices-container');

                if (result.classChoices.length > 0) {
                    // ã‚¯ãƒ©ã‚¹é¸æŠã‚’æœ‰åŠ¹ã«ã™ã‚‹
                    if (enableClassSelectionCheckbox) enableClassSelectionCheckbox.checked = true;
                    // ã‚¯ãƒ©ã‚¹æ•°ã‚’è¨­å®š
                    if (classCountSelect) {
                        const savedCount = result.classChoices.length;
                        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«savedCountãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°æœ€ã‚‚è¿‘ã„å¤§ãã„å€¤ã‚’é¸æŠ
                        let bestMatch = 1;
                        for (let i = 1; i <= 10; i++) { // Assuming max 10 classes from HTML
                            if (i <= savedCount) {
                                bestMatch = i;
                            }
                        }
                        classCountSelect.value = bestMatch.toString();
                    }
                    // ã‚¯ãƒ©ã‚¹é¸æŠã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
                    if (classChoicesContainer) classChoicesContainer.classList.remove('hidden');
                } else {
                    // ã‚¯ãƒ©ã‚¹é¸æŠã‚’ç„¡åŠ¹ã«ã™ã‚‹
                    if (enableClassSelectionCheckbox) enableClassSelectionCheckbox.checked = false;
                    // ã‚¯ãƒ©ã‚¹é¸æŠã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤º
                    if (classChoicesContainer) classChoicesContainer.classList.add('hidden');
                }
            }
        })
        .catch(function(error) {
            console.warn('ä¿å­˜ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error.message);
            showMessage('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        });
}

// Create form with custom configuration
function createFormWithConfig() {
  const question = questionTextarea.value.trim();
  const enableClassSelection = document.getElementById('enable-class-selection').checked;
  const classCountSelect = document.getElementById('class-count-select');
  let classChoices = [];

  if (enableClassSelection) {
    if (!classCountSelect) {
      showMessage('ã‚¯ãƒ©ã‚¹æ•°é¸æŠã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
      return;
    }
    const classCount = parseInt(classCountSelect.value, 10);
    for (let i = 1; i <= classCount; i++) {
      classChoices.push(`ã‚¯ãƒ©ã‚¹${i}`);
    }
  }

  if (!question) {
    showMessage('å•é¡Œæ–‡ã¯å¿…é ˆã§ã™ã€‚', 'warning');
    return;
  }

  // ã‚¯ãƒ©ã‚¹é¸æŠãŒæœ‰åŠ¹ã§ã€ã‹ã¤ã‚¯ãƒ©ã‚¹ãŒä¸€ã¤ã‚‚ç”Ÿæˆã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
  if (enableClassSelection && classChoices.length === 0) {
    showMessage('ã‚¯ãƒ©ã‚¹é¸æŠãŒæœ‰åŠ¹ã§ã™ãŒã€ã‚¯ãƒ©ã‚¹ãŒä¸€ã¤ã‚‚ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¯ãƒ©ã‚¹æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }

  const config = {
    mainQuestion: question, // mainQuestionã¯æ–‡å­—åˆ—ã¨ã—ã¦é€ä¿¡ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒæœŸå¾…ã™ã‚‹å½¢å¼ï¼‰
    classChoices: classChoices,
    includeOthers: includeOthersOption,
    enableClass: classChoices && classChoices.length > 0, // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ãŒã‚ã‚‹ã‹ã‚’åˆ¤å®š
  };
  
  hideFormConfigModal();
  
  // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨é€²æ—è¡¨ç¤ºã‚’é–‹å§‹
  showQuickStartProgress();
  simulateCustomFormProgress();
  
  // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆä¸­ã¯å°‚ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€æ±ç”¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è¡¨ç¤ºã—ãªã„

  // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æ­£ã—ã„é–¢æ•°ã‚’ä½¿ç”¨: createCustomForm(userEmail, userId, config)
  // userEmailã¯ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‹ã‚‰å–å¾—
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.adminEmail) {
    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    setLoading(false);
    return;
  }
  
  sharedUtilities.gas.callWithLoading('createCustomFormUI', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆä¸­...', currentStatus.userInfo.userId, config)
    .then(function(result) {
      console.log('ğŸ“¥ Received response from createCustomFormUI:', result);
      if (result && result.status === 'success') {
        // Use the new structured message format
        var successMessage = result.message || 'âœ… æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼';
        if (result.detailedMessage) {
          showMessage(successMessage, 'success', result.detailedMessage);
        } else {
          showMessage(successMessage, 'success');
        }
        
        // Show next steps if available
        if (result.nextSteps && result.nextSteps.length > 0) {
          showNextStepsModal(result.nextSteps, result);
        }
        
        // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        saveClassChoicesToDatabase(classChoices);
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        loadStatus(true);
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        hideFormConfigModal();
        
        // é€²æ—ãƒãƒ¼ã‚’3ç§’å¾Œã«éè¡¨ç¤º
        setTimeout(() => {
          hideQuickStartProgress();
        }, 3000);
      } else {
        console.error('âŒ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãŒå¤±æ•—:', result);
        
        // Use the new structured error message format
        var errorMessage = result?.message || 'ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
        if (result?.detailedMessage) {
          showMessage(errorMessage, 'error', result.detailedMessage);
        } else {
          showMessage(errorMessage, 'error');
        }
        
        // Show retry option if available
        if (result?.canRetry) {
          showRetryOption('ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ', function() {
            createCustomFormWithConfig();
          });
        }
        
        // Show suggestions if available
        if (result?.suggestions && result.suggestions.length > 0) {
          showSuggestions(result.suggestions);
        }
        // å¤±æ•—æ™‚ã‚‚é€²æ—ãƒãƒ¼ã‚’éè¡¨ç¤º
        setTimeout(() => {
          hideQuickStartProgress();
        }, 2000);
      }
    })
    .catch(function(error) {
      console.error('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
      
      // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let errorMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      if (error.toString().includes('permission') || error.toString().includes('æ¨©é™')) {
        errorMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Google Drive ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      }
      
      showMessage(errorMessage, 'error');
      
      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚é€²æ—ãƒãƒ¼ã‚’éè¡¨ç¤º
      setTimeout(() => {
        hideQuickStartProgress();
      }, 2000);
    });
}

// Save class choices to database
function saveClassChoicesToDatabase(classChoices) {
    runGasWithUserId('saveClassChoices', classChoices)
        .catch(function(error) {
            console.warn('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®ä¿å­˜ã«å¤±æ•—:', error.message);
        });
}

// =============================================================================
// RESOURCE MANAGEMENT
// =============================================================================

// Add spreadsheet resource
function addResource() {
  const urlInput = document.getElementById('resource-url-input');
  if (!urlInput) {
    showMessage('URLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  const url = urlInput.value.trim();
  if (!url) {
    showMessage('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }

  sharedUtilities.gas.callWithLoading('addSpreadsheetUrl', 'ãƒªã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™...', url)
    .then(function(result) {
      if (result.status === 'success') {
        showMessage(result.message, 'success');
        urlInput.value = ''; // Clear input
        loadStatus(true); // Refresh status
      } else {
        showMessage(result.message || 'ãƒªã‚½ãƒ¼ã‚¹ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
      }
    })
    .catch(function(error) {
      handleError(error, 'addResource', 'ãƒªã‚½ãƒ¼ã‚¹ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    });
}

// =============================================================================
// EXTERNAL LINKS AND NAVIGATION
// =============================================================================

// Copy board URL to clipboard
function copyBoardUrl() {
  const urlInput = document.getElementById('board-url');
  if (urlInput) {
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      document.execCommand('copy');
      showMessage('URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
    } catch (err) {
      showMessage('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'warning');
    }
  }
}

// Copy form URL to clipboard
function copyFormUrl() {
  const urlInput = document.getElementById('form-url-input');
  if (urlInput && urlInput.value) {
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      // Try modern clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(urlInput.value).then(() => {
          showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
        }).catch(() => {
          // Fallback to execCommand
          document.execCommand('copy');
          showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
        });
      } else {
        document.execCommand('copy');
        showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
      }
    } catch (err) {
      showMessage('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'warning');
    }
  } else {
    showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
  }
}

// Open database spreadsheet
function openDatabaseSpreadsheet() {
  if (currentSpreadsheetUrl) {
    window.open(currentSpreadsheetUrl, '_blank');
  } else {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'warning');
  }
}

// Open form
function openForm() {
  if (currentStatus && currentStatus.customFormInfo && currentStatus.customFormInfo.formUrl) {
    window.open(currentStatus.customFormInfo.formUrl, '_blank');
  } else {
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'warning');
  }
}

// Open app setup page
function openAppSetupPage() {
  sharedUtilities.gas.callWithLoading('getWebAppUrl', 'ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã‚’æº–å‚™ä¸­...')
    .then(function(webAppUrl) {
      const setupUrl =
        webAppUrl + '?setup=true&mode=appsetup&userId=' + encodeURIComponent(userId);
      // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆé–¢æ•°ã‚’å‘¼ã³å‡ºã™
      google.script.run
        .withSuccessHandler(function() { /* ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„ */ })
        .withFailureHandler(function(error) {
          console.error('Failed to redirect to app setup page:', error);
          showMessage('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        })
        .redirectToUrl(setupUrl);
    })
    .catch(function(error) {
      console.error('Failed to get web app URL for app setup page:', error);
      showMessage('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã®URLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
    });
}

// =============================================================================
// POLLING AND REAL-TIME UPDATES
// =============================================================================

// System status polling variables
let lastUserActivity = Date.now();
let currentPollInterval = 5 * 60 * 1000; // é–‹å§‹ã¯5åˆ†é–“éš”
let statusPollTimer = null;

// Fresh save management to prevent interference
let freshSaveTimestamp = 0;
let isSaveInProgress = false;
const FRESH_SAVE_PROTECTION_DURATION = 30000; // 30 seconds

// Make freshSaveTimestamp globally accessible
window.freshSaveTimestamp = freshSaveTimestamp;

// Get optimal polling interval based on user activity
function getOptimalPollInterval() {
  const timeSinceActivity = Date.now() - lastUserActivity;
  
  if (timeSinceActivity < 2 * 60 * 1000) { // 2åˆ†ä»¥å†…
    return 30 * 1000; // 30ç§’é–“éš”
  } else if (timeSinceActivity < 10 * 60 * 1000) { // 10åˆ†ä»¥å†…
    return 2 * 60 * 1000; // 2åˆ†é–“éš”
  } else {
    return 10 * 60 * 1000; // 10åˆ†é–“éš”
  }
}

// Restart status polling with new interval
function restartStatusPolling() {
  if (statusPollTimer) {
    clearInterval(statusPollTimer);
  }
  currentPollInterval = getOptimalPollInterval();
  startSystemStatusUpdate();
}

// Start system status update polling
function startSystemStatusUpdate() {
  statusPollTimer = setInterval(function() {
    // UIãŒéè¡¨ç¤ºã®æ™‚ã¯æ›´æ–°ã—ãªã„
    if (document.hidden) return;
    
    // Skip background updates if save operation is in progress or recently completed
    if (isSaveInProgress) {
      logDebug('Skipping background update: save in progress');
      return;
    }
    
    const timeSinceFreshSave = Date.now() - freshSaveTimestamp;
    if (timeSinceFreshSave < FRESH_SAVE_PROTECTION_DURATION) {
      logDebug('Skipping background update: fresh save protection active');
      return;
    }
    
    // ç¾åœ¨ã®ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´
    const optimalInterval = getOptimalPollInterval();
    if (Math.abs(currentPollInterval - optimalInterval) > 30000) { // 30ç§’ä»¥ä¸Šã®å·®
      restartStatusPolling();
      return;
    }
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã—ã¦é™ã‹ã«æ›´æ–°
    runGasWithUserId('getStatus', false)
      .then(function(status) {
        // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿UIã‚’æ›´æ–°
        if (JSON.stringify(status) !== JSON.stringify(currentStatus)) {
          updateUIWithNewStatus(status);
        }
      })
      .catch(function(error) {
        logWarn('Background status update failed:', error);
      });
  }, currentPollInterval);
}

// =============================================================================
// QUICKSTART FUNCTIONALITY
// =============================================================================

// QuickStart progress management
const quickStartSteps = [
  { id: 1, text: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', detail: 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’æº–å‚™ä¸­...' },
  { id: 2, text: 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', detail: 'ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...' },
  { id: 3, text: 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è¨­å®šã¨å…¬é–‹', detail: 'Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šä¸­...' },
  { id: 4, text: 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', detail: 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼' }
];

// Show QuickStart progress bar
function showQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.remove('hidden');
    resetProgressSteps();
  }
}

// Hide QuickStart progress bar
function hideQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.add('hidden');
  }
}

// Reset all progress steps to initial state
function resetProgressSteps() {
  quickStartSteps.forEach(step => {
    updateProgressStep(step.id, 'waiting', step.text, 'å¾…æ©Ÿä¸­...');
  });
  updateOverallProgress(0, 'åˆæœŸåŒ–ä¸­...');
}

// Update individual progress step
function updateProgressStep(stepId, status, text, detail) {
  const stepElement = document.getElementById(`progress-step-${stepId}`);
  const dotElement = document.getElementById(`progress-step-${stepId}-dot`);
  const textElement = document.getElementById(`progress-step-${stepId}-text`);
  const detailElement = document.getElementById(`progress-step-${stepId}-detail`);
  
  if (!stepElement || !dotElement || !textElement || !detailElement) return;
  
  // Update text and detail
  textElement.textContent = text;
  detailElement.textContent = detail;
  
  // Update visual state based on status
  switch (status) {
    case 'waiting':
      dotElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      textElement.className = 'text-sm text-gray-300';
      detailElement.className = 'text-xs text-gray-500';
      break;
    case 'active':
      dotElement.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse';
      textElement.className = 'text-sm text-emerald-300 font-medium';
      detailElement.className = 'text-xs text-emerald-400';
      break;
    case 'completed':
      dotElement.className = 'w-2 h-2 rounded-full bg-green-400';
      textElement.className = 'text-sm text-green-300 font-medium';
      detailElement.className = 'text-xs text-green-400';
      break;
    case 'error':
      dotElement.className = 'w-2 h-2 rounded-full bg-red-400';
      textElement.className = 'text-sm text-red-300 font-medium';
      detailElement.className = 'text-xs text-red-400';
      break;
  }
}

// Update overall progress bar
function updateOverallProgress(percentage, statusMessage) {
  const progressBar = document.getElementById('progress-bar');
  const progressPercentage = document.getElementById('progress-percentage');
  const progressStatus = document.getElementById('progress-status');
  
  if (progressBar) {
    progressBar.style.width = `${percentage}%`;
  }
  
  if (progressPercentage) {
    progressPercentage.textContent = `${percentage}%`;
  }
  
  if (progressStatus) {
    progressStatus.textContent = statusMessage;
  }
}

// Simulate QuickStart progress (for demonstration)
function simulateQuickStartProgress() {
  // Step 1: Folder creation
  updateProgressStep(1, 'active', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’æº–å‚™ä¸­...');
  updateOverallProgress(10, 'ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
  
  setTimeout(() => {
    updateProgressStep(1, 'completed', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
    updateProgressStep(2, 'active', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...');
    updateOverallProgress(35, 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
  }, 1500);
  
  setTimeout(() => {
    updateProgressStep(2, 'completed', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
    updateProgressStep(3, 'active', 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è¨­å®šã¨å…¬é–‹', 'Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šä¸­...');
    updateOverallProgress(70, 'å›ç­”ãƒœãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ã„ã¾ã™...');
  }, 3000);
  
  setTimeout(() => {
    updateProgressStep(3, 'completed', 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è¨­å®šã¨å…¬é–‹', 'âœ… å›ç­”ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸ');
    updateProgressStep(4, 'active', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
    updateOverallProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
  }, 4500);
  
  setTimeout(() => {
    updateProgressStep(4, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã™ã¹ã¦ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
  }, 5000);
}

// Simulate Custom Form creation progress
function simulateCustomFormProgress() {
  // Step 1: Form creation
  updateProgressStep(1, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆ', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆä¸­...');
  updateOverallProgress(15, 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
  
  setTimeout(() => {
    updateProgressStep(1, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
    updateProgressStep(2, 'active', 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº', 'ãƒ‡ãƒ¼ã‚¿åé›†ã®è¨­å®šä¸­...');
    updateOverallProgress(50, 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨é€£æºã—ã¦ã„ã¾ã™...');
  }, 2000);
  
  setTimeout(() => {
    updateProgressStep(2, 'completed', 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº', 'âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒé€£æºã•ã‚Œã¾ã—ãŸ');
    updateProgressStep(3, 'active', 'åˆ—åã®è‡ªå‹•è¨­å®š', 'AI ã«ã‚ˆã‚‹åˆ—åè¨­å®šä¸­...');
    updateOverallProgress(80, 'åˆ—åã‚’è‡ªå‹•è¨­å®šã—ã¦ã„ã¾ã™...');
  }, 4000);
  
  setTimeout(() => {
    updateProgressStep(3, 'completed', 'åˆ—åã®è‡ªå‹•è¨­å®š', 'âœ… åˆ—åãŒè‡ªå‹•è¨­å®šã•ã‚Œã¾ã—ãŸ');
    updateProgressStep(4, 'active', 'è¨­å®šå®Œäº†', 'ç¢ºèªæº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
    updateOverallProgress(100, 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ï¼');
  }, 6000);
  
  setTimeout(() => {
    updateProgressStep(4, 'completed', 'è¨­å®šå®Œäº†', 'ğŸ‰ è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ï¼');
  }, 6500);
}

// Handle quick start setup
function handleQuickStart() {
  const quickstartBtn = document.getElementById('quickstart-btn');
  const quickstartText = document.getElementById('quickstart-text');
  
  if (!quickstartBtn || !quickstartText) {
    console.error('QuickStart elements not found');
    return;
  }
  
  // Update button state
  quickstartBtn.disabled = true;
  quickstartText.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...';
  
  // Show progress bar and start simulation
  showQuickStartProgress();
  simulateQuickStartProgress();
  
  // Show loading message optimized for QuickStart
  // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆä¸­ã¯å°‚ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€æ±ç”¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è¡¨ç¤ºã—ãªã„
  
  sharedUtilities.gas.callWithLoading('quickStartSetup', 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...')
    .then(function(result) {
      if (result && result.status === 'success') {
        // Final progress update
        updateOverallProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        updateProgressStep(4, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã™ã¹ã¦ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
        
        // Use the new structured message format
        var successMessage = result.message || 'âœ… ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼';
        if (result.detailedMessage) {
          showMessage(successMessage, 'success', result.detailedMessage);
        } else {
          showMessage(successMessage, 'success');
        }
        
        // Show next steps if available
        if (result.nextSteps && result.nextSteps.length > 0) {
          showNextStepsModal(result.nextSteps, result);
        }
        
        // Update status after quick start
        if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
          window.unifiedCache.clear();
        }
        loadStatus(true);
        
        // Reset button state
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†';
        
        // Hide progress bar after delay and reset button
        setTimeout(() => {
          hideQuickStartProgress();
          quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
          quickstartBtn.disabled = false;
        }, 5000);
      } else {
        logWarn('QuickStart returned error result:', result);
        
        // Show error in progress using improved error messages
        var errorMessage = result?.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        updateProgressStep(4, 'error', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', errorMessage);
        updateOverallProgress(0, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        // Use the new structured error message format
        var displayMessage = errorMessage;
        var detailedMessage = result?.detailedMessage || '';
        
        if (result?.detailedMessage) {
          showMessage(displayMessage, 'error', detailedMessage);
        } else {
          showMessage(displayMessage, 'error');
        }
        
        // Show retry option if available
        if (result?.canRetry) {
          showRetryOption('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ', startQuickStart);
        }
        
        // Show suggestions if available
        if (result?.suggestions && result.suggestions.length > 0) {
          showSuggestions(result.suggestions);
        }
        
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
        
        // Hide progress bar after delay
        setTimeout(() => {
          hideQuickStartProgress();
        }, 3000);
      }
    })
    .catch(function(error) {
      logError('QuickStart error:', error);
      
      // Show error in progress
      updateProgressStep(4, 'error', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      updateOverallProgress(0, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      
      // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      if (error.toString().includes('permission') || error.toString().includes('æ¨©é™') || 
          error.toString().includes('Drive') || error.toString().includes('Sheets')) {
        errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Google Drive ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ãªã„å ´åˆã€æ¨©é™ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
      }
      
      if (typeof handleError === 'function') {
        handleError(error, 'handleQuickStart', errorMessage);
      } else {
        showMessage(errorMessage, 'error');
      }
      
      quickstartBtn.disabled = false;
      quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
      
      // Hide progress bar after delay
      setTimeout(() => {
        hideQuickStartProgress();
      }, 3000);
    });
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize API communications
function initializeAPI() {
  // Start background status updates
  startSystemStatusUpdate();
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);
}

// Setup real-time updates
function setupRealtimeUpdates() {
  // Update system status every 30 seconds
  setInterval(loadSystemStatus, 30000);
  
  // Update answer count every 10 seconds when published
  setInterval(() => {
    const publishText = document.getElementById('info-publish-text');
    if (publishText && publishText.textContent === 'å…¬é–‹ä¸­') {
      updateAnswerCount();
    }
  }, 10000);
}

// Initialize when DOM is ready
if (document.readyState !== 'loading') {
  initializeAPI();
} else {
  document.addEventListener('DOMContentLoaded', function() {
    initializeAPI();
  });
}

// Initialize API communications
function initializeAPI() {
  // Start background status updates
  startSystemStatusUpdate();
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);

  // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒ­ãƒ¼ãƒ‰
  loadStatus();
}

// Load user information
function loadUserInfo() {
  if (typeof sharedUtilities.gas.callWithLoading === 'function') {
    sharedUtilities.gas.callWithLoading('getUserInfo', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...')
      .then(userInfo => {
        if (userInfo) {
          document.getElementById('info-admin-email').textContent = userInfo.email || '-';
          document.getElementById('info-user-id').textContent = userInfo.userId || '-';
        }
      })
      .catch(error => {
        console.error('Failed to load user info:', error);
        showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
      });
  }
}

// Load system status
function loadSystemStatus() {
  if (typeof sharedUtilities.gas.callWithLoading === 'function') {
    sharedUtilities.gas.callWithLoading('getAppConfig', 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...')
      .then(status => {
        updateSystemStatusDisplay(status);
      })
      .catch(error => {
        console.error('Failed to load system status:', error);
        showMessage('ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
      });
  }
}

// Update answer count
function updateAnswerCount() {
  if (currentStatus && typeof currentStatus.answerCount !== 'undefined') {
    document.getElementById('info-answer-count').textContent = currentStatus.answerCount || '0';
  }
}
</script>
