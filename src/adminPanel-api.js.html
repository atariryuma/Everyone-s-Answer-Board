<script>
// =============================================================================
// ADMIN PANEL API COMMUNICATIONS & BACKEND CALLS
// =============================================================================

// =============================================================================
// BACKEND FUNCTION WRAPPERS
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: æ–°ã—ã„runGasWithUserIdé–¢æ•°
function runGasWithUserId(functionName, ...args) {
  // userIdãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–ã‚’å¾…ã¤
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        console.error('âŒ  - No userId available for:', functionName);
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }
      
      console.log('âœ…  - runGasWithUserId (after init):', functionName, 'userId:', userId);
      // userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ 
      return gasOptimizer.call(functionName, userId, ...args);
    });
  }
  
  console.log('âœ…  - runGasWithUserId:', functionName, 'userId:', userId);
  // userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ 
  return gasOptimizer.call(functionName, userId, ...args);
}

// callWithCache é–¢æ•° - èª­ã¿å–ã‚Šå°‚ç”¨æ“ä½œç”¨
function callWithCache(functionName, cacheKey, ttl, ...args) {
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, ...args);
  }, ttl);
}

// runGasWithUserId with cache support
function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
      return unifiedCache.getOrSet(cacheKey, function() {
        return gasOptimizer.call(functionName, userId, ...args);
      }, ttl);
    });
  }
  
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, userId, ...args);
  }, ttl);
}

// =============================================================================
// STATUS AND DATA LOADING
// =============================================================================

// Load current status from backend
function loadStatus(forceRefresh = false) {
  updateUserActivity();
  setLoading(true, 'æœ€æ–°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
  
  const cacheKey = 'status_' + (userId || 'guest');
  const cacheTime = 60000; // 1åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  
  if (forceRefresh) {
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å–å¾—
    if (unifiedCache && unifiedCache.delete) {
      unifiedCache.delete(cacheKey);
    }
    // ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: æ–°ã—ã„é–¢æ•°ã‚’ä½¿ç”¨
    runGasWithUserId('getStatus')
      .then(function(status) {
        console.log('âœ… Status loaded ( forced refresh)', status);
        updateUIWithNewStatus(status);
        setLoading(false);
      })
      .catch(function(error) {
        console.error('âŒ  getStatus failed, falling back to legacy:', error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®æ–¹æ³•
        runGasWithUserId('getStatus', forceRefresh)
          .then(function(status) {
            console.log('âœ… Status loaded (legacy fallback)', status);
            updateUIWithNewStatus(status);
            setLoading(false);
          })
          .catch(function(error) {
            handleError(error, 'loadStatus', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          });
      });
  } else {
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨
    callWithCacheWithUserId('getStatus', cacheKey, cacheTime)
      .then(function(status) {
        console.log('âœ… Status loaded (cached)', status);
        updateUIWithNewStatus(status);
        setLoading(false);
      })
      .catch(function(error) {
        handleError(error, 'loadStatus', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      });
  }
}

// Load sheet configuration for selected sheet
function loadConfigForSelected() {
  if (!selectedSheet) {
    console.warn('No sheet selected for config loading');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  setLoading(true, 'åˆ—æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
  
  runGasWithUserId('getSheetDetails', currentStatus.userInfo.spreadsheetId, selectedSheet)
    .then(handleSheetDetailsSuccess)
    .catch(handleSheetDetailsError);
}

// Handle successful sheet details loading
function handleSheetDetailsSuccess(details) {
  console.log('âœ… Sheet details loaded:', details);
  
  if (details && details.headers) {
    populateHeaderOptions(details.headers);
    
    if (details.guessedConfig) {
      populateConfig(details.guessedConfig);
      showMessage('AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'success');
    }
  } else {
    showMessage('ã‚·ãƒ¼ãƒˆã®è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'warning');
  }
  
  setLoading(false);
}

// Handle sheet details loading error
function handleSheetDetailsError(error) {
  console.error('âŒ Sheet details failed:', error);
  handleError(error, 'loadConfigForSelected', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
}

// =============================================================================
// AI COLUMN DETECTION
// =============================================================================

// Run AI-powered header guessing
function runHeaderGuessing() {
  if (!selectedSheet) {
    showMessage('ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  setLoading(true, 'AIæ­è¼‰é«˜ç²¾åº¦åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãŒåˆ†æä¸­...');
  
  runGasWithUserId('getSheetDetails', currentStatus.userInfo.spreadsheetId, selectedSheet)
    .then(function(details) {
      const configToUse = {
        ...details.guessedConfig,
        sheetName: selectedSheet
      };
      
      populateConfig(configToUse);
      showMessage('AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼è¨­å®šã‚’ç¢ºèªã—ã¦ã€Œä¿å­˜ãƒ»å…¬é–‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'success');
      setLoading(false);
    })
    .catch(function(error) {
      handleError(error, 'runHeaderGuessing', 'AIåˆ—åˆ¤å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    });
}

// =============================================================================
// SAVE AND PUBLISH OPERATIONS
// =============================================================================

// Save configuration and publish board
function saveAndPublish() {
  if (!validateConfig()) {
    showMessage('å¿…é ˆé …ç›®ï¼ˆå›ç­”ãƒ‡ãƒ¼ã‚¿åˆ—ï¼‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  setLoading(true, 'è¨­å®šã‚’ä¿å­˜ã—ã€ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™...');
  
  const config = buildConfigObject();
  const settingsData = {
    sheetName: selectedSheet,
    opinionColumn: config.opinionColumn,
    nameColumn: config.nameColumn,
    classColumn: config.classColumn,
    timestampColumn: config.timestampColumn,
    showNames: config.showNames,
    showCounts: config.showCounts,
    classChoices: config.classChoices
  };
  
  runGasWithUserId('saveAndPublish', settingsData)
    .then(function(result) {
      setLoading(false);
      if (result && result.status === 'success') {
        showMessage('âœ… è¨­å®šãŒä¿å­˜ã•ã‚Œã€ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
        loadStatus(true); // å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã§UIã‚’æ›´æ–°
      } else {
        showMessage(result.message || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
      }
    })
    .catch(function(error) {
      setLoading(false);
      console.error('âŒ  saveAndPublish failed, falling back to legacy:', error);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®æ–¹æ³•
      runGasWithUserId('saveAndPublish', selectedSheet, config)
        .then(function(status) {
          setLoading(false);
          showMessage('è¨­å®šãŒä¿å­˜ã•ã‚Œã€ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
          updateUIWithNewStatus(status);
        })
        .catch(function(fallbackError) {
          handleError(fallbackError, 'saveAndPublish', 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        });
    });
}

// Unpublish board
function unpublishBoard() {
  setLoading(true, 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ä¸­...');
  runGasWithUserId('clearActiveSheet')
    .then(function(response) {
      console.log('å…¬é–‹åœæ­¢ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
      showMessage(response.message || 'âœ… å›ç­”ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚', 'success');
      setLoading(false);
      loadStatus(true); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¼·åˆ¶æ›´æ–°
    })
    .catch(function(error) {
      handleError(error, 'unpublishBoard', 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    });
}

// =============================================================================
// FORM MANAGEMENT
// =============================================================================

// Load saved class choices
function loadSavedClassChoices() {
    runGasWithUserId('getSavedClassChoices')
        .then(function(result) {
            if (result.status === 'success' && result.classChoices) {
                const classChoicesTextarea = document.getElementById('class-choices');
                if (classChoicesTextarea) {
                    classChoicesTextarea.value = result.classChoices.join('\n');
                }
            }
        })
        .catch(function(error) {
            console.warn('ä¿å­˜ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error.message);
        });
}

// Create form with custom configuration
function createFormWithConfig() {
  const titleInput = document.getElementById('custom-form-title');
  const questionTextarea = document.getElementById('custom-main-question');
  const classChoicesTextarea = document.getElementById('class-choices');
  const includeOthersOption = document.getElementById('include-others-option').checked;
  
  if (!titleInput || !questionTextarea || !classChoicesTextarea) {
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  const title = titleInput.value.trim();
  const question = questionTextarea.value.trim();
  const classChoicesText = classChoicesTextarea.value.trim();
  
  if (!title || !question) {
    showMessage('ã‚¿ã‚¤ãƒˆãƒ«ã¨å•é¡Œæ–‡ã¯å¿…é ˆã§ã™ã€‚', 'warning');
    return;
  }
  
  if (!classChoicesText) {
    showMessage('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  const classChoices = classChoicesText.split('\n')
    .map(choice => choice.trim())
    .filter(choice => choice.length > 0);
  
  if (classChoices.length === 0) {
    showMessage('æœ‰åŠ¹ãªã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  const config = {
    title: title,
    mainQuestion: question,
    classChoices: classChoices,
    includeOthers: includeOthersOption,
  };
  
  hideFormConfigModal();
  setLoading(true, 'æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ã„ã¾ã™...');

  runGasWithUserId('createCustomFormUI', config)
      .then(function(result) {
          if (result.status === 'success') {
              showMessage('âœ… æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã€é€£æºã•ã‚Œã¾ã—ãŸï¼', 'success');
              
              // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
              saveClassChoicesToDatabase(classChoices);
              
              // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
              loadStatus(true);
          } else {
              showMessage(result.message || 'ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
          }
          setLoading(false);
      })
      .catch(function(error) {
          handleError(error, 'createFormWithConfig', 'ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      });
}

// Save class choices to database
function saveClassChoicesToDatabase(classChoices) {
    runGasWithUserId('saveClassChoices', classChoices)
        .catch(function(error) {
            console.warn('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®ä¿å­˜ã«å¤±æ•—:', error.message);
        });
}

// =============================================================================
// RESOURCE MANAGEMENT
// =============================================================================

// Add spreadsheet resource
function addResource() {
  const urlInput = document.getElementById('resource-url-input');
  if (!urlInput) {
    showMessage('URLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  const url = urlInput.value.trim();
  if (!url) {
    showMessage('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }

  setLoading(true, 'ãƒªã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™...');
  runGasWithUserId('addSpreadsheetUrl', url)
    .then(function(result) {
      if (result.status === 'success') {
        showMessage(result.message, 'success');
        urlInput.value = ''; // Clear input
        loadStatus(true); // Refresh status
      } else {
        showMessage(result.message || 'ãƒªã‚½ãƒ¼ã‚¹ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
      }
      setLoading(false);
    })
    .catch(function(error) {
      handleError(error, 'addResource', 'ãƒªã‚½ãƒ¼ã‚¹ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    });
}

// =============================================================================
// EXTERNAL LINKS AND NAVIGATION
// =============================================================================

// Copy board URL to clipboard
function copyBoardUrl() {
  const urlInput = document.getElementById('board-url');
  if (urlInput) {
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      document.execCommand('copy');
      showMessage('URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
    } catch (err) {
      showMessage('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'warning');
    }
  }
}

// Open database spreadsheet
function openDatabaseSpreadsheet() {
  if (currentSpreadsheetUrl) {
    window.open(currentSpreadsheetUrl, '_blank');
  } else {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'warning');
  }
}

// Open form
function openForm() {
  if (currentStatus && currentStatus.customFormInfo && currentStatus.customFormInfo.formUrl) {
    window.open(currentStatus.customFormInfo.formUrl, '_blank');
  } else {
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'warning');
  }
}

// Open app setup page
function openAppSetupPage() {
  runGasWithUserId('getWebAppUrlCached')
    .then(function(webAppUrl) {
      const setupUrl = webAppUrl + '?setup=true&mode=appsetup';
      window.open(setupUrl, '_blank');
    })
    .catch(function(error) {
      console.error('Failed to get web app URL:', error);
      showMessage('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã®URLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
    });
}

// =============================================================================
// POLLING AND REAL-TIME UPDATES
// =============================================================================

// System status polling variables
let lastUserActivity = Date.now();
let currentPollInterval = 5 * 60 * 1000; // é–‹å§‹ã¯5åˆ†é–“éš”
let statusPollTimer = null;

// Get optimal polling interval based on user activity
function getOptimalPollInterval() {
  const timeSinceActivity = Date.now() - lastUserActivity;
  
  if (timeSinceActivity < 2 * 60 * 1000) { // 2åˆ†ä»¥å†…
    return 30 * 1000; // 30ç§’é–“éš”
  } else if (timeSinceActivity < 10 * 60 * 1000) { // 10åˆ†ä»¥å†…
    return 2 * 60 * 1000; // 2åˆ†é–“éš”
  } else {
    return 10 * 60 * 1000; // 10åˆ†é–“éš”
  }
}

// Restart status polling with new interval
function restartStatusPolling() {
  if (statusPollTimer) {
    clearInterval(statusPollTimer);
  }
  currentPollInterval = getOptimalPollInterval();
  startSystemStatusUpdate();
}

// Start system status update polling
function startSystemStatusUpdate() {
  statusPollTimer = setInterval(function() {
    // UIãŒéè¡¨ç¤ºã®æ™‚ã¯æ›´æ–°ã—ãªã„
    if (document.hidden) return;
    
    // ç¾åœ¨ã®ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´
    const optimalInterval = getOptimalPollInterval();
    if (Math.abs(currentPollInterval - optimalInterval) > 30000) { // 30ç§’ä»¥ä¸Šã®å·®
      restartStatusPolling();
      return;
    }
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã—ã¦é™ã‹ã«æ›´æ–°
    runGasWithUserId('getStatus', false)
      .then(function(status) {
        // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿UIã‚’æ›´æ–°
        if (JSON.stringify(status) !== JSON.stringify(currentStatus)) {
          updateUIWithNewStatus(status);
        }
      })
      .catch(function(error) {
        console.warn('Background status update failed:', error);
      });
  }, currentPollInterval);
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize API communications
function initializeAPI() {
  console.log('ğŸ”— Initializing API communications...');
  
  // Start background status updates
  startSystemStatusUpdate();
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);
  
  console.log('âœ… API communications initialized');
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(initializeAPI, 200);
});
</script>