<script>
// =============================================================================
// ADMIN PANEL API COMMUNICATIONS & BACKEND CALLS
// =============================================================================

// =============================================================================
// UNIFIED FLOW EXECUTION MANAGER - çµ±ä¸€å®Ÿè¡Œåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ 
// =============================================================================

/**
 * ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œåˆ¶å¾¡ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ - é‡è¤‡å®Ÿè¡Œãƒ»ç«¶åˆçŠ¶æ…‹ã‚’é˜²æ­¢
 */
class FlowExecutionManager {
  constructor() {
    this.activeFlows = new Set();
    this.pendingOperations = new Map();
    this.executionQueue = new Map();
    this.debugMode = window.DEBUG_MODE || false;
  }

  /**
   * æ’ä»–å®Ÿè¡Œåˆ¶å¾¡ä»˜ãã§ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ
   * @param {string} flowId - ãƒ•ãƒ­ãƒ¼è­˜åˆ¥å­
   * @param {Function} operation - å®Ÿè¡Œã™ã‚‹æ“ä½œ
   * @param {Object} options - å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³
   * @returns {Promise} å®Ÿè¡Œçµæœ
   */
  async executeWithLock(flowId, operation, options = {}) {
    const { timeout = SYSTEM_CONSTANTS.TIMEOUTS.DEFAULT_FLOW_TIMEOUT, allowQueue = false } = options;

    // æ—¢ã«å®Ÿè¡Œä¸­ã®å ´åˆã®å‡¦ç†
    if (this.activeFlows.has(flowId)) {
      if (this.pendingOperations.has(flowId)) {
        if (this.debugMode) {
          console.log('ğŸ”’ Flow ' + flowId + ' already in progress, returning existing promise');
        }
        return this.pendingOperations.get(flowId);
      }
      
      if (!allowQueue) {
        throw new Error('Flow ' + flowId + ' is already in progress and queueing is disabled');
      }
      
      // ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
      if (this.debugMode) {
        console.log('â³ Flow ' + flowId + ' queued for execution');
      }
      return this.queueOperation(flowId, operation, timeout);
    }

    // æ–°è¦å®Ÿè¡Œ
    return this.executeOperation(flowId, operation, timeout);
  }

  /**
   * æ“ä½œã‚’å®Ÿè¡Œï¼ˆæ”¹è‰¯ç‰ˆ - AbortControllerå¯¾å¿œï¼‰
   */
  async executeOperation(flowId, operation, timeout) {
    this.activeFlows.add(flowId);
    
    if (this.debugMode) {
      console.log('ğŸš€ Starting flow execution: ' + flowId);
    }

    // AbortControllerã‚’ä½¿ç”¨ã—ãŸé©åˆ‡ãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡
    const abortController = new AbortController();
    let timeoutId = null;
    
    try {
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
      timeoutId = setTimeout(() => {
        console.warn('â° Flow ' + flowId + ' timeout after ' + timeout + 'ms - aborting operation');
        abortController.abort();
      }, timeout);

      // æ“ä½œå®Ÿè¡Œï¼ˆAbortSignalã‚’æ¸¡ã™ï¼‰
      const operationPromise = Promise.resolve(operation(abortController.signal));
      this.pendingOperations.set(flowId, operationPromise);

      const result = await operationPromise;
      
      // æ­£å¸¸å®Œäº†æ™‚ã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
      if (timeoutId) {
        clearTimeout(timeoutId);
        timeoutId = null;
      }
      
      
      return result;
    } catch (error) {
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
      if (timeoutId) {
        clearTimeout(timeoutId);
        timeoutId = null;
      }

      // AbortErrorã®å ´åˆã¯ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (error.name === 'AbortError' || abortController.signal.aborted) {
        const timeoutError = new Error(`Flow ${flowId} was aborted due to timeout (${timeout}ms)`);
        timeoutError.name = 'TimeoutError';
        timeoutError.flowId = flowId;
        timeoutError.timeout = timeout;
        console.error(`âŒ Flow ${flowId} aborted due to timeout`);
        throw timeoutError;
      }

      console.error(`âŒ Flow ${flowId} failed:`, error);
      throw error;
    } finally {
      // ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
      
      this.activeFlows.delete(flowId);
      this.pendingOperations.delete(flowId);
      
      // ã‚­ãƒ¥ãƒ¼ã•ã‚ŒãŸæ“ä½œã‚’å®Ÿè¡Œ
      this.processQueue(flowId);
    }
  }

  /**
   * æ“ä½œã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
   */
  async queueOperation(flowId, operation, timeout) {
    return new Promise((resolve, reject) => {
      if (!this.executionQueue.has(flowId)) {
        this.executionQueue.set(flowId, []);
      }
      
      this.executionQueue.get(flowId).push({
        operation,
        timeout,
        resolve,
        reject
      });
    });
  }

  /**
   * ã‚­ãƒ¥ãƒ¼ã•ã‚ŒãŸæ“ä½œã‚’å‡¦ç†
   */
  async processQueue(flowId) {
    const queue = this.executionQueue.get(flowId);
    if (!queue || queue.length === 0) return;

    const next = queue.shift();
    if (queue.length === 0) {
      this.executionQueue.delete(flowId);
    }

    try {
      const result = await this.executeOperation(flowId, next.operation, next.timeout);
      next.resolve(result);
    } catch (error) {
      next.reject(error);
    }
  }

  /**
   * æŒ‡å®šãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡ŒçŠ¶æ…‹ã‚’ç¢ºèª
   */
  isFlowActive(flowId) {
    return this.activeFlows.has(flowId);
  }

  /**
   * å…¨ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ­ãƒ¼ã‚’å–å¾—
   */
  getActiveFlows() {
    return Array.from(this.activeFlows);
  }

  /**
   * ç·Šæ€¥åœæ­¢: å…¨ãƒ•ãƒ­ãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
   */
  cancelAllFlows() {
    console.warn('ğŸš¨ Emergency stop: Cancelling all active flows');
    this.activeFlows.clear();
    this.pendingOperations.clear();
    this.executionQueue.clear();
  }

  /**
   * å®Ÿè¡ŒçŠ¶æ…‹ã®è¨ºæ–­
   * @returns {Object} è¨ºæ–­çµæœ
   */
  diagnoseExecution() {
    return {
      activeFlows: Array.from(this.activeFlows),
      pendingOperations: this.pendingOperations.size,
      queuedOperations: Array.from(this.executionQueue.keys()).map(flowId => ({
        flowId,
        queueLength: this.executionQueue.get(flowId).length
      })),
      totalActiveFlows: this.activeFlows.size,
      timestamp: Date.now()
    };
  }

  /**
   * LoadingManagerã¨ã®é€£æº - çµ±ä¸€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¶å¾¡
   * @param {string} flowId - ãƒ•ãƒ­ãƒ¼ID
   * @param {string} message - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   * @param {boolean} isActive - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
   */
  updateLoadingState(flowId, message, isActive) {
    try {
      // UnifiedLoadingManagerãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
      if (typeof window !== 'undefined' && window.unifiedLoading) {
        if (isActive) {
          window.unifiedLoading.showSimple(message || `å®Ÿè¡Œä¸­: ${flowId}`);
        } else {
          window.unifiedLoading.hide();
        }
      }
      
      // SharedUtilitiesã®LoadingManagerãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
      if (typeof window !== 'undefined' && window.sharedUtilities && window.sharedUtilities.loading) {
        window.sharedUtilities.loading.setLoading(flowId, isActive, message);
      }

    } catch (error) {
      console.warn('âš ï¸ Failed to update loading state:', error);
    }
  }

  /**
   * å¼·åŒ–ã•ã‚ŒãŸexecuteWithLock - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é€£æºç‰ˆ
   * @param {string} flowId - ãƒ•ãƒ­ãƒ¼ID
   * @param {Function} operation - å®Ÿè¡Œã™ã‚‹æ“ä½œ
   * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
   * @returns {Promise} å®Ÿè¡Œçµæœ
   */
  async executeWithLoadingSync(flowId, operation, options = {}) {
    const { 
      timeout = 30000,
      loadingMessage = null,
      showLoading = true,
      onProgress = null,
      priority = 0,
      retries = 0
    } = options;

    try {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹
      if (showLoading) {
        this.updateLoadingState(flowId, loadingMessage || `å‡¦ç†ä¸­: ${flowId}`, true);
      }

      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ä»˜ãã§å®Ÿè¡Œ
      const result = await this.executeWithLock(flowId, async () => {
        if (onProgress) {
          onProgress(0, 'starting', 'å®Ÿè¡Œé–‹å§‹');
        }
        
        const operationResult = await operation();
        
        if (onProgress) {
          onProgress(100, 'completed', 'å®Ÿè¡Œå®Œäº†');
        }
        
        return operationResult;
      }, { timeout, priority, retries });

      return result;

    } catch (error) {
      if (onProgress) {
        onProgress(-1, 'error', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
      throw error;
    } finally {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†
      if (showLoading) {
        setTimeout(() => {
          this.updateLoadingState(flowId, null, false);
        }, 500); // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éš ã™
      }
    }
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
const flowExecutionManager = new FlowExecutionManager();

// =============================================================================
// TIMING MANAGER - éåŒæœŸå‡¦ç†çµ±ä¸€åŒ–ã‚·ã‚¹ãƒ†ãƒ 
// =============================================================================

/**
 * ã‚¿ã‚¤ãƒŸãƒ³ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - setTimeout/setIntervalã®ä»£æ›¿
 */
class TimingManager {
  constructor() {
    this.activeTimers = new Map();
    this.debugMode = window.DEBUG_MODE || false;
  }

  /**
   * é…å»¶å®Ÿè¡Œï¼ˆsetTimeoutã®ä»£æ›¿ï¼‰
   * @param {number} ms - é…å»¶ãƒŸãƒªç§’
   * @param {string} id - ã‚¿ã‚¤ãƒãƒ¼IDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   * @returns {Promise} å®Œäº†Promise
   */
  static async delay(ms, id = null) {
    if (id && timingManager.activeTimers.has(id)) {
      timingManager.activeTimers.get(id).cancel();
    }

    return new Promise((resolve, reject) => {
      const timer = setTimeout(() => {
        if (id) timingManager.activeTimers.delete(id);
        resolve();
      }, ms);

      if (id) {
        timingManager.activeTimers.set(id, {
          timer,
          cancel: () => {
            clearTimeout(timer);
            timingManager.activeTimers.delete(id);
            reject(new Error('Timer ' + id + ' was cancelled'));
          }
        });
      }
    });
  }

  /**
   * é †æ¬¡å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ ï¼ˆè¤‡æ•°ã®setTimeoutã®ä»£æ›¿ï¼‰
   * @param {Array} operations - å®Ÿè¡Œã™ã‚‹æ“ä½œã®é…åˆ—
   * @param {number} intervalMs - å„æ“ä½œé–“ã®é–“éš”
   * @param {string} sequenceId - ã‚·ãƒ¼ã‚±ãƒ³ã‚¹IDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   * @returns {Promise} å®Œäº†Promise
   */
  static async sequence(operations, intervalMs = 100, sequenceId = null) {
    const results = [];
    
    for (let i = 0; i < operations.length; i++) {
      const operation = operations[i];
      
      try {
        if (typeof operation === 'function') {
          const result = await operation();
          results.push(result);
        } else {
          results.push(operation);
        }
        
        // æœ€å¾Œã®æ“ä½œã§ãªã„å ´åˆã¯é–“éš”ã‚’è¨­ã‘ã‚‹
        if (i < operations.length - 1) {
          const delayId = sequenceId ? sequenceId + '_delay_' + i : null;
          await TimingManager.delay(intervalMs, delayId);
        }
      } catch (error) {
        console.error('Sequence operation ' + i + ' failed:', error);
        throw error;
      }
    }
    
    return results;
  }

  /**
   * ä¸¦åˆ—å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ ï¼ˆåˆ¶å¾¡ã•ã‚ŒãŸä¸¦åˆ—æ€§ï¼‰
   * @param {Array} operations - å®Ÿè¡Œã™ã‚‹æ“ä½œã®é…åˆ—
   * @param {number} concurrency - åŒæ™‚å®Ÿè¡Œæ•°
   * @returns {Promise} å®Œäº†Promise
   */
  static async parallel(operations, concurrency = 3) {
    const results = [];
    const executing = [];
    
    for (const operation of operations) {
      const promise = Promise.resolve(operation()).then(result => {
        executing.splice(executing.indexOf(promise), 1);
        return result;
      });
      
      results.push(promise);
      executing.push(promise);
      
      if (executing.length >= concurrency) {
        await Promise.race(executing);
      }
    }
    
    return await Promise.all(results);
  }

  /**
   * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ç”¨ï¼‰
   * @param {Array} steps - ã‚¹ãƒ†ãƒƒãƒ—ã®é…åˆ—
   * @param {Function} onProgress - ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
   * @param {number} stepDelay - ã‚¹ãƒ†ãƒƒãƒ—é–“é…å»¶
   * @returns {Promise} å®Œäº†Promise
   */
  static async progressSequence(steps, onProgress, stepDelay = 1000) {
    const results = [];
    
    for (let i = 0; i < steps.length; i++) {
      const step = steps[i];
      
      try {
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹é–‹å§‹é€šçŸ¥
        if (onProgress) {
          onProgress(i, 'active', step.text || 'Step ' + (i + 1), step.detail || 'å®Ÿè¡Œä¸­...');
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ
        let result;
        if (typeof step.operation === 'function') {
          result = await step.operation();
        }
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹å®Œäº†é€šçŸ¥
        if (onProgress) {
          onProgress(i, 'completed', step.text || `Step ${i + 1}`, step.completedText || 'âœ… å®Œäº†');
        }
        
        results.push(result);
        
        // æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§ãªã„å ´åˆã¯é…å»¶
        if (i < steps.length - 1) {
          await TimingManager.delay(stepDelay);
        }
        
      } catch (error) {
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¨ãƒ©ãƒ¼é€šçŸ¥
        if (onProgress) {
          onProgress(i, 'error', step.text || `Step ${i + 1}`, `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
        throw error;
      }
    }
    
    return results;
  }

  /**
   * ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
   * @param {string} id - ã‚¿ã‚¤ãƒãƒ¼ID
   */
  static cancelTimer(id) {
    if (timingManager.activeTimers.has(id)) {
      timingManager.activeTimers.get(id).cancel();
    }
  }

  /**
   * å…¨ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
   */
  static cancelAllTimers() {
    for (const [id, timer] of timingManager.activeTimers.entries()) {
      timer.cancel();
    }
    timingManager.activeTimers.clear();
  }

  // =============================================================================
  // DEBOUNCE & THROTTLE INTEGRATION - SharedUtilitiesçµ±åˆ
  // =============================================================================

  /**
   * Debounceé–¢æ•° - é€£ç¶šå®Ÿè¡Œã‚’é˜²æ­¢
   * @param {Function} func - å®Ÿè¡Œã™ã‚‹é–¢æ•°
   * @param {string} key - ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã‚­ãƒ¼
   * @param {number} delay - é…å»¶æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
   * @returns {Function} ãƒ‡ãƒã‚¦ãƒ³ã‚¹åŒ–ã•ã‚ŒãŸé–¢æ•°
   */
  static debounce(func, key, delay = 1000) {
    if (!timingManager.debounceTimers) {
      timingManager.debounceTimers = new Map();
    }

    return function(...args) {
      if (timingManager.debounceTimers.has(key)) {
        clearTimeout(timingManager.debounceTimers.get(key));
      }

      const timeoutId = setTimeout(() => {
        func.apply(this, args);
        timingManager.debounceTimers.delete(key);
      }, delay);

      timingManager.debounceTimers.set(key, timeoutId);
    };
  }

  /**
   * Throttleé–¢æ•° - å®Ÿè¡Œé »åº¦ã‚’åˆ¶é™
   * @param {Function} func - å®Ÿè¡Œã™ã‚‹é–¢æ•°
   * @param {string} key - ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã‚­ãƒ¼
   * @param {number} delay - å®Ÿè¡Œé–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰
   * @returns {Function} ã‚¹ãƒ­ãƒƒãƒˆãƒ«åŒ–ã•ã‚ŒãŸé–¢æ•°
   */
  static throttle(func, key, delay = 100) {
    if (!timingManager.throttleTimers) {
      timingManager.throttleTimers = new Map();
    }
    if (!timingManager.lastExecution) {
      timingManager.lastExecution = new Map();
    }

    return function(...args) {
      const now = Date.now();
      const lastRun = timingManager.lastExecution.get(key) || 0;

      if (now - lastRun >= delay) {
        func.apply(this, args);
        timingManager.lastExecution.set(key, now);
      } else if (!timingManager.throttleTimers.has(key)) {
        const timeoutId = setTimeout(() => {
          func.apply(this, args);
          timingManager.lastExecution.set(key, Date.now());
          timingManager.throttleTimers.delete(key);
        }, delay - (now - lastRun));
        timingManager.throttleTimers.set(key, timeoutId);
      }
    };
  }

  /**
   * ç‰¹å®šã‚­ãƒ¼ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹/ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã‚’ã‚¯ãƒªã‚¢
   * @param {string} key - ã‚¯ãƒªã‚¢ã™ã‚‹ã‚­ãƒ¼
   */
  static clearTiming(key) {
    if (timingManager.debounceTimers && timingManager.debounceTimers.has(key)) {
      clearTimeout(timingManager.debounceTimers.get(key));
      timingManager.debounceTimers.delete(key);
    }
    if (timingManager.throttleTimers && timingManager.throttleTimers.has(key)) {
      clearTimeout(timingManager.throttleTimers.get(key));
      timingManager.throttleTimers.delete(key);
    }
    if (timingManager.lastExecution) {
      timingManager.lastExecution.delete(key);
    }
  }

  /**
   * å…¨ãƒ‡ãƒã‚¦ãƒ³ã‚¹/ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã‚’ã‚¯ãƒªã‚¢
   */
  static clearAllTiming() {
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (timingManager.debounceTimers) {
      timingManager.debounceTimers.forEach(timer => clearTimeout(timer));
      timingManager.debounceTimers.clear();
    }
    // ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (timingManager.throttleTimers) {
      timingManager.throttleTimers.forEach(timer => clearTimeout(timer));
      timingManager.throttleTimers.clear();
    }
    // å®Ÿè¡Œå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
    if (timingManager.lastExecution) {
      timingManager.lastExecution.clear();
    }
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
const timingManager = new TimingManager();

// TimingManagerã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
window.TimingManager = TimingManager;

// ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›æ€§ã®ãŸã‚ã®é–¢æ•°
window.debounce = TimingManager.debounce;
window.throttle = TimingManager.throttle;

// =============================================================================
// UNIFIED CACHE CONTROLLER - çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
// =============================================================================

/**
 * çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç«¶åˆã‚’é˜²æ­¢
 */
// UnifiedCacheControlleræ©Ÿèƒ½ã¯CacheManagerã«çµ±åˆã•ã‚Œã¾ã—ãŸ
// cache.gsã®cacheManager.clearAllFrontendCaches()ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„

// çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¶å¾¡ã¯cache.gsã®cacheManagerã§ç®¡ç†ã•ã‚Œã¾ã™

// =============================================================================
// UI UPDATE BATCHER - çµ±ä¸€UIæ›´æ–°ã‚·ã‚¹ãƒ†ãƒ 
// =============================================================================

/**
 * UIæ›´æ–°ãƒãƒƒãƒãƒ£ãƒ¼ - UIæ›´æ–°ã®é‡è¤‡ã‚’é˜²ãåŠ¹ç‡åŒ–
 */
class UIUpdateBatcher {
  constructor() {
    this.pendingUpdates = [];
    this.batchTimeout = null;
    this.isProcessing = false;
    this.batchDelay = 100; // ãƒãƒƒãƒå‡¦ç†ã®é…å»¶ï¼ˆmsï¼‰
    this.debugMode = window.DEBUG_MODE || false;
  }

  /**
   * UIæ›´æ–°ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
   * @param {Function} updateFn - æ›´æ–°é–¢æ•°
   * @param {string} updateId - æ›´æ–°IDï¼ˆé‡è¤‡æ’é™¤ç”¨ï¼‰
   * @param {number} priority - å„ªå…ˆåº¦ï¼ˆé«˜ã„ã»ã©å…ˆã«å®Ÿè¡Œï¼‰
   */
  queueUpdate(updateFn, updateId = null, priority = 0) {
    // é‡è¤‡æ’é™¤: åŒã˜IDã®æ›´æ–°ãŒã‚ã‚Œã°ç½®ãæ›ãˆ
    if (updateId) {
      const existingIndex = this.pendingUpdates.findIndex(update => update.id === updateId);
      if (existingIndex !== -1) {
        this.pendingUpdates[existingIndex] = { fn: updateFn, id: updateId, priority, timestamp: Date.now() };
        return;
      }
    }

    // æ–°è¦è¿½åŠ 
    this.pendingUpdates.push({
      fn: updateFn,
      id: updateId || `update_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      priority,
      timestamp: Date.now()
    });

    if (this.debugMode) {
      console.log(`â• UI update queued: ${updateId || 'anonymous'}, queue size: ${this.pendingUpdates.length}`);
    }

    this.scheduleBatch();
  }

  /**
   * ãƒãƒƒãƒå‡¦ç†ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
   */
  scheduleBatch() {
    if (this.batchTimeout || this.isProcessing) return;

    this.batchTimeout = setTimeout(async () => {
      await this.processBatch();
    }, this.batchDelay);
  }

  /**
   * ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè¡Œ
   */
  async processBatch() {
    if (this.isProcessing || this.pendingUpdates.length === 0) return;

    this.isProcessing = true;
    this.batchTimeout = null;

    try {
      // å„ªå…ˆåº¦é †ã§ã‚½ãƒ¼ãƒˆï¼ˆé«˜ã„é †ï¼‰
      const sortedUpdates = [...this.pendingUpdates].sort((a, b) => {
        if (b.priority !== a.priority) return b.priority - a.priority;
        return a.timestamp - b.timestamp; // åŒã˜å„ªå…ˆåº¦ãªã‚‰å¤ã„é †
      });

      this.pendingUpdates = [];

      if (this.debugMode) {
        console.log(`ğŸ¯ Processing UI update batch: ${sortedUpdates.length} updates`);
      }

      // é †æ¬¡å®Ÿè¡Œï¼ˆä¸¦åˆ—å®Ÿè¡Œã ã¨ç«¶åˆã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
      for (const update of sortedUpdates) {
        try {
          await Promise.resolve(update.fn());
        } catch (error) {
          console.error(`âŒ UI update failed: ${update.id}`, error);
        }
        
        // å„æ›´æ–°é–“ã«çŸ­ã„é–“éš”ã‚’è¨­ã‘ã‚‹
        await TimingManager.delay(10);
      }

      if (this.debugMode) {
        console.log(`ğŸ‰ UI update batch completed: ${sortedUpdates.length} updates processed`);
      }

    } catch (error) {
      console.error('âŒ UI update batch processing failed:', error);
    } finally {
      this.isProcessing = false;
      
      // å‡¦ç†ä¸­ã«æ–°ã—ã„æ›´æ–°ãŒè¿½åŠ ã•ã‚Œã¦ã„ãŸã‚‰å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      if (this.pendingUpdates.length > 0) {
        this.scheduleBatch();
      }
    }
  }

  /**
   * å³åº§ã«ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè¡Œ
   */
  async flushUpdates() {
    if (this.batchTimeout) {
      clearTimeout(this.batchTimeout);
      this.batchTimeout = null;
    }
    
    await this.processBatch();
  }

  /**
   * å¾…æ©Ÿä¸­ã®æ›´æ–°ã‚’ã‚¯ãƒªã‚¢
   */
  clearPendingUpdates() {
    this.pendingUpdates = [];
    if (this.batchTimeout) {
      clearTimeout(this.batchTimeout);
      this.batchTimeout = null;
    }
    
    if (this.debugMode) {
      console.log('ğŸ§¹ Pending UI updates cleared');
    }
  }

  /**
   * ãƒãƒƒãƒãƒ£ãƒ¼ã®çŠ¶æ…‹ã‚’å–å¾—
   */
  getStatus() {
    return {
      pendingUpdates: this.pendingUpdates.length,
      isProcessing: this.isProcessing,
      batchScheduled: !!this.batchTimeout
    };
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«UIæ›´æ–°ãƒãƒƒãƒãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
const uiUpdateBatcher = new UIUpdateBatcher();

// =============================================================================
// BACKEND FUNCTION WRAPPERS
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: æ–°ã—ã„runGasWithUserIdé–¢æ•° - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ã
function runGasWithUserId(functionName, loadingMessage = 'å‡¦ç†ä¸­...', ...args) {
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãŒå¿…è¦ãªå ´åˆã¯ callWithLoading ã‚’ä½¿ç”¨
  if (loadingMessage && loadingMessage !== false) {
    // userIdãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–ã‚’å¾…ã¤
    if (!userId) {
      return userIdPromise.then(() => {
        if (!userId) {
          logError('No userId available for:', functionName);
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ãã§userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ  - Admin Panel uses overlay loading
        return sharedUtilities.gas.callWithLoading(functionName, loadingMessage, 'overlay', userId, ...args);
      }).catch((error) => {
        logError('Error in runGasWithUserId (after userIdPromise):', error);
        throw error;
      });
    }
    
    // userIdãŒæ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ã - Admin Panel uses overlay loading
    return sharedUtilities.gas.callWithLoading(functionName, loadingMessage, 'overlay', userId, ...args).catch((error) => {
      logError('Error in runGasWithUserId (direct call with loading):', error);
      throw error;
    });
  }
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸è¦ã®å ´åˆï¼ˆloadingMessage = falseï¼‰ã¯å¾“æ¥é€šã‚Š
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        logError('No userId available for:', functionName);
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }
      
      // userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ 
      return gasOptimizer.call(functionName, userId, ...args);
    }).catch((error) => {
      logError('userIdPromise rejected:', error);
      throw error;
    });
  }
  
  // userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ 
  return gasOptimizer.call(functionName, userId, ...args);
}

// callWithCache é–¢æ•° - èª­ã¿å–ã‚Šå°‚ç”¨æ“ä½œç”¨
function callWithCache(functionName, cacheKey, ttl, ...args) {
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, ...args);
  }, ttl);
}

// runGasWithUserId with cache support
function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
      return unifiedCache.getOrSet(cacheKey, function() {
        return gasOptimizer.call(functionName, userId, ...args);
      }, ttl);
    });
  }
  
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, userId, ...args);
  }, ttl);
}

// =============================================================================
// STATUS AND DATA LOADING
// =============================================================================

// Load system status - OPTIMIZED with integrated API
// AIåˆ—åˆ¤å®šçµæœã¨configJsonã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
const processCache = {
  aiColumnMapping: {
    data: null,
    headersHash: null,
    timestamp: null,
    ttl: 300000 // 5åˆ†é–“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  },
  configNormalization: {
    data: null,
    dataHash: null,
    timestamp: null,
    ttl: 60000 // 1åˆ†é–“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  }
};

// ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆé–¢æ•°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function generateSimpleHash(data) {
  return JSON.stringify(data).split('').reduce((a, b) => {
    a = ((a << 5) - a) + b.charCodeAt(0);
    return a & a;
  }, 0);
}

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯
function isCacheValid(cacheEntry) {
  if (!cacheEntry.data || !cacheEntry.timestamp) return false;
  return (Date.now() - cacheEntry.timestamp) < cacheEntry.ttl;
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«é–¢æ•°ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å…¬é–‹ï¼ˆä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ï¼‰
window.processCache = processCache;
window.generateSimpleHash = generateSimpleHash;
window.isCacheValid = isCacheValid;

// loadStatuså®Ÿè¡Œç®¡ç†
let loadStatusInProgress = null;
let loadStatusQueue = [];

function loadStatus(bypassCache = false) {
  const operationId = 'loadStatus';
  
  // Check operation mutex to prevent concurrent calls
  if (!bypassCache && window.AdminPanel && window.AdminPanel.operationMutex) {
    if (window.AdminPanel.operationMutex.isRunning(operationId)) {
      logDebug('ğŸš« loadStatus already running, returning existing promise');
      return loadStatusInProgress || Promise.resolve(currentStatus);
    }
  }
  
  // æ—¢ã«å®Ÿè¡Œä¸­ã®å ´åˆã¯åŒã˜Promiseã‚’è¿”ã™ï¼ˆå¼·åŒ–ç‰ˆï¼‰
  if (loadStatusInProgress && !bypassCache) {
    logDebug('ğŸ”„ Reusing existing loadStatus promise');
    return loadStatusInProgress;
  }

  // Start operation mutex tracking
  if (window.AdminPanel && window.AdminPanel.operationMutex) {
    window.AdminPanel.operationMutex.start(operationId);
  }

  console.group('ğŸ”„ loadStatus - ä¸€å…ƒç®¡ç†ç‰ˆ');
  console.log('ğŸš€ Loading system status, bypassCache:', bypassCache);

  // æ–°ã—ã„å®Ÿè¡Œã‚’é–‹å§‹
  loadStatusInProgress = userIdPromise.then(() => {
    if (!userId) {
      console.error('âŒ userId is not available after userIdPromise resolution in loadStatus!');
      showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
      console.groupEnd();
      throw new Error('userId is not available');
    }

    console.log('ğŸŒ Calling getInitialData with userId:', userId);

    // runGasWithUserId ã‚’ä½¿ç”¨ã—ã¦ getInitialData ã‚’å‘¼ã³å‡ºã™
    return runGasWithUserId('getInitialData', 'ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...')
      .then(response => {
        logDebug('âœ… Integrated data loaded:', response);
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
        if (!response || response.status === 'error') {
          const errorMsg = response ? response.message : 'ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç„¡åŠ¹ãªå¿œç­”ã‚’å—ä¿¡ã—ã¾ã—ãŸ';
          logError('getInitialData returned error:', errorMsg);
          throw new Error(errorMsg);
        }
        
        // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
        if (!response.userInfo) {
          logError('userInfo missing in response:', response);
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }

        // Update UI with integrated response
        updateUIWithNewStatus(response);

        // If sheet details are included, apply them immediately
        if (response.sheetDetails && response.activeSheetName) {
          logDebug('âœ… Sheet details included in integrated response, applying configuration');
          try {
            populateHeaderOptions(response.sheetDetails.allHeaders);
            logDebug('âœ… Header options populated from integrated data');
            populateConfig(response.sheetDetails.guessedConfig);
            logDebug('âœ… AI configuration applied from integrated data');
          } catch (configError) {
            console.error('Error applying sheet configuration from integrated data:', configError);
          }
        }

        logInfo('âš¡ Performance: Single API call replaced 3-4 separate calls');
        return response; // Promiseãƒã‚§ãƒ¼ãƒ³ã‚’ç¶­æŒã™ã‚‹ãŸã‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
      })
      .catch(error => {
        console.error('âŒ Integrated API failed:', error);
        showMessage('ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        throw error; // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
      })
      .finally(() => {
        console.groupEnd();
        // å®Ÿè¡ŒçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        loadStatusInProgress = null;
        
        // End operation mutex tracking
        if (window.AdminPanel && window.AdminPanel.operationMutex) {
          window.AdminPanel.operationMutex.end(operationId);
        }
      });
  }).catch(error => {
    console.error('âŒ Error resolving userIdPromise in loadStatus:', error);
    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    console.groupEnd();
    // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å®Ÿè¡ŒçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    loadStatusInProgress = null;
    
    // End operation mutex tracking on error
    if (window.AdminPanel && window.AdminPanel.operationMutex) {
      window.AdminPanel.operationMutex.end(operationId);
    }
    
    throw error;
  });

  return loadStatusInProgress;
}

// Load sheet configuration for selected sheet
function loadConfigForSelected() {
  if (!selectedSheet) {
    logWarn('No sheet selected for config loading');
    return Promise.reject(new Error('No sheet selected for config loading'));
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    logError('Missing required data for loadConfigForSelected');
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return Promise.reject(new Error('Missing required data for loadConfigForSelected'));
  }
  
  return runGasWithUserId('getSheetDetails', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
    .then(handleSheetDetailsSuccess)
    .catch(handleSheetDetailsError);
}

// Handle successful sheet details loading
function handleSheetDetailsSuccess(details) {
  if (details && details.allHeaders) {
    populateHeaderOptions(details.allHeaders);
    
    // Show config area and hide placeholder
    const configArea = document.getElementById('config-area');
    const configPlaceholder = document.getElementById('config-placeholder');
    
    if (configArea) {
      configArea.classList.remove('hidden');
    }
    
    if (configPlaceholder) {
      configPlaceholder.classList.add('hidden');
    }
    
    if (details.guessedConfig) {
      // DOMã®æ›´æ–°ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰populateConfigã‚’å‘¼ã³å‡ºã™
      setTimeout(() => {
        populateConfig(details.guessedConfig);
        
        // Enhanced auto-detection success message with specifics
        const detectedColumns = [];
        if (details.guessedConfig.opinionColumn) detectedColumns.push(`å›ç­”åˆ—: ${details.guessedConfig.opinionColumn}`);
        if (details.guessedConfig.nameColumn) detectedColumns.push(`åå‰åˆ—: ${details.guessedConfig.nameColumn}`);
        if (details.guessedConfig.classColumn) detectedColumns.push(`ã‚¯ãƒ©ã‚¹åˆ—: ${details.guessedConfig.classColumn}`);
        
        const message = detectedColumns.length > 0 
          ? `ğŸ¤– AIåˆ—åˆ¤å®šãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼æ¤œå‡ºã•ã‚ŒãŸåˆ—: ${detectedColumns.join(', ')}ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
          : 'ğŸ¤– AIåˆ—åˆ¤å®šãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        
        showMessage(message, 'success');
      }, 0);
    }
  } else {
    logWarn('No headers in sheet details:', details);
    showMessage('ã‚·ãƒ¼ãƒˆã®è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'warning');
  }
}

// Handle sheet details loading error
function handleSheetDetailsError(error) {
  logError('Sheet details failed:', error);
  handleError(error, 'loadConfigForSelected', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
}

// =============================================================================
// AI COLUMN DETECTION
// =============================================================================

// Run AI-powered header guessing
function runHeaderGuessing() {
  if (!selectedSheet) {
    showMessage('ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  // Update button state to show AI is working
  const reguessBtn = document.getElementById('reguess-headers-btn');
  if (reguessBtn) {
    const originalContent = reguessBtn.innerHTML;
    reguessBtn.disabled = true;
    reguessBtn.innerHTML = `
      <span class="relative z-10 flex items-center gap-1">
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <span class="text-xs font-bold">AIåˆ†æä¸­</span>
      </span>
    `;
    
    // Restore button after completion
    const restoreButton = () => {
      reguessBtn.disabled = false;
      reguessBtn.innerHTML = originalContent;
    };
    
    // Show start notification
    showMessage('ğŸ¤– é«˜ç²¾åº¦AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...', 'info');
    
    runGasWithUserId('getSheetDetails', 'AIæ­è¼‰é«˜ç²¾åº¦åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãŒåˆ†æä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
      .then(function(details) {
        if (!details || !details.guessedConfig) {
          restoreButton();
          showMessage('âŒ AIåˆ—åˆ¤å®šãŒå¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'warning');
          return;
        }
        
        const configToUse = {
          ...details.guessedConfig,
          sheetName: selectedSheet
        };
        
        setTimeout(() => {
          populateConfig(configToUse);
          restoreButton();
          
          // Enhanced completion notification with analysis details
          const detectedColumns = [];
          if (configToUse.opinionColumn) detectedColumns.push(`ğŸ’¬ å›ç­”åˆ—: ${configToUse.opinionColumn}`);
          if (configToUse.nameColumn) detectedColumns.push(`ğŸ‘¤ åå‰åˆ—: ${configToUse.nameColumn}`);
          if (configToUse.classColumn) detectedColumns.push(`ğŸ« ã‚¯ãƒ©ã‚¹åˆ—: ${configToUse.classColumn}`);
          if (configToUse.reasonColumn) detectedColumns.push(`ğŸ’­ ç†ç”±åˆ—: ${configToUse.reasonColumn}`);
          
          const message = detectedColumns.length > 0 
            ? `ğŸ‰ é«˜ç²¾åº¦AIåˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\næ¤œå‡ºã•ã‚ŒãŸåˆ—:\n${detectedColumns.join('\n')}\n\nè¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹ã—ã¦ãã ã•ã„ã€‚`
            : 'ğŸ‰ é«˜ç²¾åº¦AIåˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹ã—ã¦ãã ã•ã„ã€‚';
          
          showMessage(message, 'success');
          
          // âœ¨ é‡è¦: AIåˆ¤å®šå®Œäº†å¾Œã®å‡¦ç†
          setTimeout(() => {
            console.log('ğŸš€ AIåˆ¤å®šå®Œäº† - å¾Œå‡¦ç†ã‚’é–‹å§‹');
            
            // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦å¿…è¦ãªå ´åˆã®ã¿å®Ÿè¡Œ
            if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
              const config = typeof currentStatus.userInfo.configJson === 'string' 
                ? JSON.parse(currentStatus.userInfo.configJson) 
                : currentStatus.userInfo.configJson;
              
              if (config.setupStatus === 'pending' || !config.formCreated) {
                console.log('ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†çŠ¶æ…‹ã‚’æ¤œå‡º - å‡¦ç†ã‚’å®Ÿè¡Œ');
                completeAIDetectionProcess();
              } else {
              }
            } else {
              console.log('ğŸ”§ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ãŒä¸æ˜ - å¿µã®ãŸã‚å‡¦ç†ã‚’å®Ÿè¡Œ');
              completeAIDetectionProcess();
            }
          }, 1000);
        }, 100);
      })
      .catch(function(error) {
        restoreButton();
        console.error('AI column detection error:', error);
        
        // Enhanced error message with specific guidance
        let errorMessage = 'âŒ é«˜ç²¾åº¦AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n';
        if ((error && error.message && error.message.includes('permission')) || (error && error.message && error.message.includes('æ¨©é™'))) {
          errorMessage += 'ğŸ“‹ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        } else if ((error && error.message && error.message.includes('network')) || (error && error.message && error.message.includes('timeout'))) {
          errorMessage += 'ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
        } else {
          errorMessage += 'âš™ï¸ æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã™ã‚‹ã‹ã€å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        }
        
        errorMessage += '\n\nğŸ’¡ å•é¡ŒãŒç¶šãå ´åˆã¯ã€ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
        
        showMessage(errorMessage, 'error');
      });
  }
}

// âœ¨ AIåˆ¤å®šå®Œäº†å¾Œã®è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å‡¦ç†
function completeAIDetectionProcess() {
  try {
    console.log('ğŸ”§ AIåˆ¤å®šå®Œäº† - è¨­å®šä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œä¸­...');
    
    // 1. è¨­å®šæ¤œè¨¼
    if (!validateConfig()) {
      console.warn('âš ï¸ AIåˆ¤å®šçµæœã®è¨­å®šãŒä¸å®Œå…¨ - æ‰‹å‹•è¨­å®šãŒå¿…è¦');
      showMessage('AIåˆ¤å®šçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚è¨­å®šã«ä¸å‚™ãŒã‚ã‚Šã¾ã™ã€‚', 'warning');
      return;
    }
    
    // 2. ãƒ•ã‚©ãƒ¼ãƒ URLæ¤œå‡ºãƒ»ä½œæˆã®å®Ÿè¡Œ
    
    runGasWithUserId('detectFormUrlFromSpreadsheet', 'ãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
      .then(result => {
        console.log('ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºçµæœå—ä¿¡');
        
        if (result && result.success && result.formUrl) {
          
          // 3. è¨­å®šã®è‡ªå‹•ä¿å­˜ã¨å®Œäº†çŠ¶æ…‹ã¸ã®æ›´æ–°
          const config = buildConfigObject();
          config.formUrl = result.formUrl;
          config.formCreated = true;
          config.setupStatus = 'completed';
          
          console.log('ğŸ’¾ AIåˆ¤å®šå®Œäº†å¾Œã®è¨­å®šã‚’è‡ªå‹•ä¿å­˜ä¸­...', config);
          
          // Save draft to session storage when AI prediction is completed
          const draftData = {
            questionText: config.opinionHeader || config.opinionColumn || 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰',
            sheetName: selectedSheet,
            config: config,
            displayMode: (function() { const el = document.getElementById('anonymous-mode'); return el && el.checked ? 'anonymous' : 'named'; })(),
            countDisplay: 'show' // Default, could be configured based on UI settings
          };
          
          saveDraftToSession(draftData);
          console.log('ğŸ“ ä¸‹æ›¸ãã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¾ã—ãŸ:', draftData.questionText);
          
          return runGasWithUserId('saveSheetConfig', 'è¨­å®šä¿å­˜ä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet, config);
        } else {
          throw new Error('ãƒ•ã‚©ãƒ¼ãƒ URLã®æ¤œå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .then(saveResult => {
        if (saveResult && saveResult.success) {
          showMessage('ğŸ‰ AIåˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹ã—ã¦ãã ã•ã„ã€‚', 'success');
          
          // 4. UIçŠ¶æ…‹ã®æ›´æ–°
          if (typeof loadSystemStatus === 'function') {
            loadSystemStatus();
          }
          
          // 5. ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºã®æ›´æ–°
          if (typeof navigateToStep === 'function') {
            navigateToStep(2); // ã‚¹ãƒ†ãƒƒãƒ—2ï¼ˆAIåˆ—åˆ†æå®Œäº†ï¼‰ã«é€²ã‚€
          }

          // 6. æ‰‹å‹•å…¬é–‹ã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆè‡ªå‹•å…¬é–‹ã¯å‰Šé™¤ï¼‰

        } else {
          throw new Error((saveResult && saveResult.message) || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ AIåˆ¤å®šå®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
        showMessage(`âš ï¸ AIåˆ¤å®šå¾Œã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\næ‰‹å‹•ã§ã€Œä¿å­˜ãƒ»å…¬é–‹ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚`, 'warning');
      });
      
  } catch (error) {
    console.error('âŒ completeAIDetectionProcess è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:', error);
    showMessage('AIåˆ¤å®šå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
  }
}

// âœ¨ è¨­å®šåˆæœŸåŒ–çµ±ä¸€æ©Ÿèƒ½
// å®Ÿè¡ŒçŠ¶æ…‹ã®ç®¡ç†
let initializationInProgress = false;
let lastInitializationTime = 0;
const INITIALIZATION_COOLDOWN = 30000; // 30ç§’ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³

/**
 * çµ±ä¸€è¨­å®šåˆæœŸåŒ–æ©Ÿèƒ½
 * è‡ªå‹•è¨ºæ–­â†’è»½å¾®ä¿®å¾©â†’å¿…è¦ã«å¿œã˜ã¦å®Œå…¨ãƒªã‚»ãƒƒãƒˆã®æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
 */
function initializeUserSettings() {
  return new Promise((resolve, reject) => {
    try {
      // é‡è¤‡å®Ÿè¡Œé˜²æ­¢ãƒã‚§ãƒƒã‚¯
      const now = Date.now();
      if (initializationInProgress) {
        resolve({ 
          success: false, 
          message: 'è¨­å®šåˆæœŸåŒ–ãŒæ—¢ã«å®Ÿè¡Œä¸­ã§ã™', 
          skipped: true, 
          reason: 'already_running' 
        });
        return;
      }
      
      // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒã‚§ãƒƒã‚¯
      if (now - lastInitializationTime < INITIALIZATION_COOLDOWN) {
        const remainingTime = Math.ceil((INITIALIZATION_COOLDOWN - (now - lastInitializationTime)) / 1000);
        resolve({ 
          success: false, 
          message: `ã‚ã¨${remainingTime}ç§’å¾Œã«å®Ÿè¡Œå¯èƒ½ã§ã™`, 
          skipped: true, 
          reason: 'cooldown', 
          remainingTime 
        });
        return;
      }
      
      initializationInProgress = true;
      lastInitializationTime = now;
      
      console.log('ğŸ”„ è¨­å®šåˆæœŸåŒ–ã‚’é–‹å§‹...');
      
      // ãƒ•ã‚§ãƒ¼ã‚º1: è‡ªå‹•è¨ºæ–­
      performSystemDiagnostic()
        .then(diagnosticResult => {
          if (diagnosticResult.severity === 'none') {
            // å•é¡Œãªã—
            initializationInProgress = false;
            resolve({
              success: true,
              phase: 'diagnostic',
              message: 'âœ… è¨­å®šã«å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ',
              issues: [],
              fixes: []
            });
          } else if (diagnosticResult.severity === 'minor') {
            // è»½å¾®ãªå•é¡Œ - è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ
            return performAutoRepair();
          } else {
            // é‡å¤§ãªå•é¡Œ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸æŠã‚’å§”ã­ã‚‹
            initializationInProgress = false;
            resolve({
              success: false,
              phase: 'needs_confirmation',
              message: 'é‡å¤§ãªè¨­å®šå•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚å®Œå…¨ãªåˆæœŸåŒ–ãŒå¿…è¦ã§ã™ã€‚',
              severity: diagnosticResult.severity,
              issues: diagnosticResult.issues,
              requiresFullReset: true
            });
          }
        })
        .then(repairResult => {
          if (repairResult) {
            initializationInProgress = false;
            resolve({
              success: true,
              phase: 'auto_repair',
              message: `ğŸ”§ ${repairResult.fixes?.length || 0}ä»¶ã®å•é¡Œã‚’è‡ªå‹•ä¿®å¾©ã—ã¾ã—ãŸ`,
              issues: repairResult.issues || [],
              fixes: repairResult.fixes || []
            });
          }
        })
        .catch(error => {
          initializationInProgress = false;
          reject(new Error(`è¨­å®šåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`));
        });
        
    } catch (error) {
      initializationInProgress = false;
      reject(error);
    }
  });
}

/**
 * UIä»˜ãè¨­å®šåˆæœŸåŒ–å®Ÿè¡Œé–¢æ•°
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºã‚’å«ã‚€
 */
function initializeUserSettingsWithUI() {
  const button = document.getElementById('initialize-settings-btn');
  const originalHTML = button ? button.innerHTML : '';
  
  // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ã€Œå‡¦ç†ä¸­ã€ã«å¤‰æ›´
  if (button) {
    button.disabled = true;
    button.innerHTML = `
      <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      è¨ºæ–­ä¸­...
    `;
  }
  
  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
  showMessage('ğŸ” ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...', 'info');
  
  initializeUserSettings()
    .then(result => {
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
      if (button) {
        button.disabled = false;
        button.innerHTML = originalHTML;
      }
      
      if (result.success) {
        // æˆåŠŸæ™‚ã®å‡¦ç†
        if (result.phase === 'diagnostic') {
          showMessage(result.message, 'success');
        } else if (result.phase === 'auto_repair') {
          showMessage(result.message, 'success');
          if (result.fixes.length > 0) {
            console.log('ğŸ”§ ä¿®å¾©ã•ã‚ŒãŸå•é¡Œ:', result.fixes);
          }
        }
      } else {
        // ç¢ºèªãŒå¿…è¦ãªå ´åˆ
        if (result.requiresFullReset) {
          const issuesList = result.issues.map(issue => `â€¢ ${issue}`).join('\n');
          
          showConfirmationModal(
            'è¨­å®šã®å®Œå…¨åˆæœŸåŒ–ãŒå¿…è¦ã§ã™',
            `ä»¥ä¸‹ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:\n\n${issuesList}\n\nè¨­å®šã‚’å®Œå…¨ã«åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ï¼‰`,
            () => {
              // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºèªã—ãŸå ´åˆã€å®Œå…¨ãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œ
              performFullReset()
                .then(resetResult => {
                  if (resetResult.success) {
                    showMessage('âœ… è¨­å®šãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ', 'success');
                    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°çŠ¶æ…‹ã‚’åæ˜ 
                    setTimeout(() => location.reload(), 1500);
                  } else {
                    showMessage('âŒ è¨­å®šåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                  }
                })
                .catch(error => {
                  console.error('Full reset failed:', error);
                  showMessage('âŒ è¨­å®šåˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                });
            }
          );
        } else {
          showMessage(result.message, 'warning');
        }
      }
    })
    .catch(error => {
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
      if (button) {
        button.disabled = false;
        button.innerHTML = originalHTML;
      }
      
      console.error('Settings initialization failed:', error);
      showMessage('âŒ è¨­å®šåˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    });
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ï¼ˆå•é¡Œã®é‡è¦åº¦ã‚’åˆ¤å®šï¼‰
 */
function performSystemDiagnostic() {
  return new Promise((resolve) => {
    try {
      if (!currentStatus || !currentStatus.userInfo) {
        resolve({ severity: 'critical', issues: ['ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'] });
        return;
      }
      
      const config = typeof currentStatus.userInfo.configJson === 'string' 
        ? JSON.parse(currentStatus.userInfo.configJson) 
        : currentStatus.userInfo.configJson;
        
      const issues = [];
      let maxSeverity = 'none';
      
      // è»½å¾®ãªå•é¡Œã®æ¤œå‡º
      const minorIssues = detectMinorIssues(config);
      if (minorIssues.length > 0) {
        issues.push(...minorIssues);
        maxSeverity = 'minor';
      }
      
      // é‡å¤§ãªå•é¡Œã®æ¤œå‡º
      const criticalIssues = detectCriticalIssues(config);
      if (criticalIssues.length > 0) {
        issues.push(...criticalIssues);
        maxSeverity = 'critical';
      }
      
      resolve({
        severity: maxSeverity,
        issues: issues
      });
      
    } catch (error) {
      resolve({ 
        severity: 'critical', 
        issues: [`è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}`] 
      });
    }
  });
}

/**
 * è»½å¾®ãªå•é¡Œã®æ¤œå‡º
 */
function detectMinorIssues(config) {
  const issues = [];
  
  // æ—¢å­˜ã®ä¿®å¾©ãƒ«ãƒ¼ãƒ«ã‹ã‚‰è»½å¾®ãªã‚‚ã®ã‚’æŠ½å‡º
  if (config.formUrl && config.formUrl.trim() && !config.formCreated) {
    issues.push('ãƒ•ã‚©ãƒ¼ãƒ URLãŒå­˜åœ¨ã™ã‚‹ãŒä½œæˆãƒ•ãƒ©ã‚°ãŒfalse');
  }
  
  if (config.formCreated && config.setupStatus !== 'completed') {
    issues.push('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ¸ˆã¿ã ãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ãŒæœªå®Œäº†');
  }
  
  if (config.appPublished && config.setupStatus === 'pending') {
    issues.push('å…¬é–‹æ¸ˆã¿ã ãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ãŒpending');
  }
  
  if (currentStatus.sheetDetails?.guessedConfig?.opinionHeader && config.setupStatus === 'pending') {
    issues.push('AIåˆ—åˆ¤å®šå®Œäº†æ¸ˆã¿ã ãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ãŒpending');
  }
  
  return issues;
}

/**
 * é‡å¤§ãªå•é¡Œã®æ¤œå‡º
 */
function detectCriticalIssues(config) {
  const issues = [];
  
  // è¨­å®šãŒå®Œå…¨ã«ç ´æã—ã¦ã„ã‚‹å ´åˆ
  if (!config || typeof config !== 'object') {
    issues.push('è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã¾ã™');
  }
  
  // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ¬ è½ã—ã¦ã„ã‚‹å ´åˆ
  if (config && !config.hasOwnProperty('setupStatus')) {
    issues.push('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹æƒ…å ±ãŒæ¬ è½ã—ã¦ã„ã¾ã™');
  }
  
  return issues;
}

/**
 * è‡ªå‹•ä¿®å¾©ã®å®Ÿè¡Œ
 */
function performAutoRepair() {
  return new Promise((resolve, reject) => {
    // æ—¢å­˜ã®repairSetupStateInconsistencies()ã®æ ¸å¿ƒéƒ¨åˆ†ã‚’ä½¿ç”¨
    repairSetupStateInconsistencies()
      .then(result => resolve(result))
      .catch(error => reject(error));
  });
}

/**
 * å®Œå…¨ãƒªã‚»ãƒƒãƒˆã®å®Ÿè¡Œï¼ˆç¢ºèªæ¸ˆã¿ï¼‰
 */
function performFullReset() {
  return new Promise((resolve, reject) => {
    runGasWithUserId('resetConfigJson', 'è¨­å®šã‚’å®Œå…¨åˆæœŸåŒ–ä¸­...')
      .then(result => {
        if (result.success) {
          resolve({
            success: true,
            phase: 'full_reset',
            message: 'âœ… è¨­å®šã‚’å®Œå…¨ã«åˆæœŸåŒ–ã—ã¾ã—ãŸ',
            resetAt: result.resetAt
          });
        } else {
          reject(new Error(result.message || 'å®Œå…¨åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        }
      })
      .catch(error => reject(error));
  });
}

// âœ¨ ãƒ¬ã‚¬ã‚·ãƒ¼è¨ºæ–­ãƒ»ä¿®å¾©æ©Ÿèƒ½ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹å­˜ï¼‰
// è¨ºæ–­å®Ÿè¡ŒçŠ¶æ…‹ã®ç®¡ç†
let diagnosticInProgress = false;
let lastDiagnosticTime = 0;
const DIAGNOSTIC_COOLDOWN = 30000; // 30ç§’ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³

function repairSetupStateInconsistencies() {
  return new Promise((resolve, reject) => {
    try {
      // é‡è¤‡å®Ÿè¡Œé˜²æ­¢ãƒã‚§ãƒƒã‚¯
      const now = Date.now();
      if (diagnosticInProgress) {
        resolve({ issues: [], fixes: [], skipped: true, reason: 'already_running' });
        return;
      }
      
      // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒã‚§ãƒƒã‚¯
      if (now - lastDiagnosticTime < DIAGNOSTIC_COOLDOWN) {
        const remainingTime = Math.ceil((DIAGNOSTIC_COOLDOWN - (now - lastDiagnosticTime)) / 1000);
        console.log(`â³ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã§ã™ã€‚ã‚ã¨${remainingTime}ç§’å¾Œã«å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚`);
        resolve({ issues: [], fixes: [], skipped: true, reason: 'cooldown', remainingTime });
        return;
      }
      
      diagnosticInProgress = true;
      lastDiagnosticTime = now;
      console.log('ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã®è¨ºæ–­ãƒ»ä¿®å¾©ã‚’é–‹å§‹...');
      
      if (!currentStatus || !currentStatus.userInfo) {
        diagnosticInProgress = false;
        reject(new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'));
        return;
      }
      
      const config = typeof currentStatus.userInfo.configJson === 'string' 
        ? JSON.parse(currentStatus.userInfo.configJson) 
        : currentStatus.userInfo.configJson;
        
      const issues = [];
      const fixes = [];
      
      // 1. ãƒ•ã‚©ãƒ¼ãƒ URL vs formCreated ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (config.formUrl && config.formUrl.trim() && !config.formCreated) {
        issues.push('ãƒ•ã‚©ãƒ¼ãƒ URLãŒå­˜åœ¨ã™ã‚‹ãŒ formCreated=false');
        config.formCreated = true;
        fixes.push('formCreated ã‚’ true ã«ä¿®æ­£');
      }
      
      // 2. formCreated vs setupStatus ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (config.formCreated && config.setupStatus !== 'completed') {
        issues.push('ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆæ¸ˆã¿ã ãŒ setupStatus != completed');
        config.setupStatus = 'completed';
        fixes.push('setupStatus ã‚’ completed ã«ä¿®æ­£');
      }
      
      // 3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¨activeSheetNameã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (currentStatus.userInfo.spreadsheetId && !currentStatus.activeSheetName && selectedSheet) {
        issues.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹ãŒ activeSheetName ãŒæœªè¨­å®š');
        // ã“ã‚Œã¯configã§ã¯ãªãstatusã®å•é¡Œãªã®ã§ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ä¿®æ­£ãŒå¿…è¦
        fixes.push('activeSheetName ã®æ›´æ–°ãŒå¿…è¦ï¼ˆè¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ï¼‰');
      }
      
      // 4. å…¬é–‹çŠ¶æ…‹ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆpublishedSheetName vs appPublishedï¼‰
      if (config.publishedSheetName && !config.appPublished) {
        issues.push('å…¬é–‹ã‚·ãƒ¼ãƒˆåãŒå­˜åœ¨ã™ã‚‹ãŒ appPublished=false');
        // ã“ã‚Œã¯æ…é‡ã«åˆ¤æ–­ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€è­¦å‘Šã®ã¿
        fixes.push('æ³¨æ„: å…¬é–‹çŠ¶æ…‹ã®ç¢ºèªãŒå¿…è¦');
      }
      
      // 5. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: appPublished=true ã ãŒ setupStatus='pending' ã®å ´åˆï¼ˆå…¬é–‹æ¸ˆã¿ä¸æ•´åˆï¼‰
      if (config.appPublished && config.setupStatus === 'pending') {
        issues.push('å…¬é–‹æ¸ˆã¿ã ãŒ setupStatus=pending');
        config.setupStatus = 'completed';
        fixes.push('setupStatus ã‚’ completed ã«ä¿®æ­£ï¼ˆæ—¢ã«å…¬é–‹æ¸ˆã¿ã®ãŸã‚ï¼‰');
      }
      
      // 6. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: å…¬é–‹URLãŒå­˜åœ¨ã™ã‚‹ãŒ formCreated=false ã®å ´åˆ
      if (currentStatus.viewUrl && currentStatus.viewUrl.trim() && !config.formCreated) {
        issues.push('å…¬é–‹URLãŒå­˜åœ¨ã™ã‚‹ãŒ formCreated=false');
        config.formCreated = true;
        fixes.push('formCreated ã‚’ true ã«ä¿®æ­£ï¼ˆå…¬é–‹URLå­˜åœ¨ã®ãŸã‚ï¼‰');
      }
      
      // 7. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: isPublished=true ã ãŒ setupStatus='pending' ã®å ´åˆï¼ˆã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ä¸æ•´åˆï¼‰
      if (currentStatus.isPublished && config.setupStatus === 'pending') {
        issues.push('ã‚·ã‚¹ãƒ†ãƒ ã§å…¬é–‹æ¸ˆã¿åˆ¤å®šã ãŒ setupStatus=pending');
        config.setupStatus = 'completed';
        fixes.push('setupStatus ã‚’ completed ã«ä¿®æ­£ï¼ˆå…¬é–‹çŠ¶æ…‹ç¢ºèªæ¸ˆã¿ï¼‰');
      }
      
      // 8. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: AIåˆ¤å®šçµæœãŒå­˜åœ¨ã™ã‚‹ãŒsetupStatus='pending'ã®å ´åˆï¼ˆAIå®Œäº†å¾Œã®çŠ¶æ…‹æ›´æ–°æ¼ã‚Œï¼‰
      if (currentStatus.sheetDetails && currentStatus.sheetDetails.guessedConfig && 
          currentStatus.sheetDetails.guessedConfig.opinionHeader && 
          config.setupStatus === 'pending') {
        issues.push('AIåˆ—åˆ¤å®šå®Œäº†æ¸ˆã¿ã ãŒ setupStatus=pending');
        config.setupStatus = 'completed';
        config.formCreated = true; // AIåˆ¤å®šå®Œäº†æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚‚æº–å‚™å®Œäº†ã¨ã¿ãªã™
        fixes.push('AIåˆ¤å®šå®Œäº†ã«åŸºã¥ã„ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã‚’å®Œäº†ã«æ›´æ–°');
      }
      
      
      if (fixes.length === 0) {
        diagnosticInProgress = false;
        resolve({
          success: true,
          message: 'âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã«å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ',
          issues: [],
          fixes: []
        });
        return;
      }
      
      // ä¿®æ­£ã•ã‚ŒãŸè¨­å®šã‚’ä¿å­˜
      console.log('ğŸ’¾ ä¿®æ­£ã•ã‚ŒãŸè¨­å®šã‚’ä¿å­˜ä¸­...', config);

        runGasWithUserId('syncConfigurationState', 'è¨­å®šä¿®å¾©ä¸­...', config, 'repair')
        .then(saveResult => {
          if (saveResult && saveResult.success) {
            
            // UIçŠ¶æ…‹ã®æ›´æ–°
            if (typeof loadSystemStatus === 'function') {
              loadSystemStatus();
            }
            
            diagnosticInProgress = false;
            resolve({
              success: true,
              message: `ğŸ”§ ${fixes.length}ä»¶ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å•é¡Œã‚’ä¿®å¾©ã—ã¾ã—ãŸ`,
              issues,
              fixes
            });
          } else {
            diagnosticInProgress = false;
            reject(new Error((saveResult && saveResult.message) || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'));
          }
        })
        .catch(saveError => {
          diagnosticInProgress = false;
          reject(new Error(`è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ${saveError.message}`));
        });
        
    } catch (error) {
      console.error('âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ä¿®å¾©ã§ã‚¨ãƒ©ãƒ¼:', error);
      diagnosticInProgress = false;
      reject(error);
    }
  });
}

// Note: runSetupRepair function has been replaced by initializeUserSettingsWithUI

// =============================================================================
// SAVE AND PUBLISH OPERATIONS
// =============================================================================

// Save configuration and publish board - ä¿®æ­£ç‰ˆï¼ˆå…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«çµŒç”±ï¼‰
function saveAndPublish() {
  if (!validateConfig()) {
    showMessage('å¿…é ˆé …ç›®ï¼ˆå›ç­”ãƒ‡ãƒ¼ã‚¿åˆ—ï¼‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  // UIã‹ã‚‰configã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
  const config = buildConfigObject();
  
  // è‡ªå‹•åœæ­¢è¨­å®šã‚’æº–å‚™
  const autoStopSettings = {
    enabled: true,
    minutes: 360 // 6æ™‚é–“ = 360åˆ†ï¼ˆconfig.gsã¨çµ±ä¸€ï¼‰
  };
  
  // Check for privacy-sensitive settings and show warning if enabled
  const showNamesEl = document.getElementById('show-names');
  const showNames = (showNamesEl && showNamesEl.checked) || false;
  const showCountsEl = document.getElementById('show-counts');
  const showCounts = (showCountsEl && showCountsEl.checked) || false;
  
  if (showNames || showCounts) {
    // Show privacy warning modal first
    if (window.sharedModals) {
      const privacySettings = [];
      if (showNames) privacySettings.push('åå‰è¡¨ç¤º');
      if (showCounts) privacySettings.push('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°è¡¨ç¤º');
      
      console.log(`âš ï¸ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è­¦å‘Š: ${privacySettings.join('ãƒ»')}ãŒæœ‰åŠ¹ã§ã™`);
      
      window.sharedModals.showPrivacyWarning(
        // onConfirm - show publish modal after privacy confirmation
        () => {
          showPublishModalAfterChecks(config, autoStopSettings);
        },
        // onCancel - user wants to review settings
        () => {
          console.log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šã®è¦‹ç›´ã—ã‚’é¸æŠ');
          showMessage('è¨­å®šã‚’è¦‹ç›´ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'info');
        }
      );
      return;
    }
  }
  
  // If no privacy concerns, show publish modal directly
  showPublishModalAfterChecks(config, autoStopSettings);
}

// å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒã‚§ãƒƒã‚¯å¾Œï¼‰
function showPublishModalAfterChecks(config, autoStopSettings) {
  if (window.sharedModals && typeof window.sharedModals.showPublish === 'function') {
    window.sharedModals.showPublish(
      // å…¬é–‹å®Ÿè¡Œæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      () => {
        console.log('ğŸ“¤ å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å…¬é–‹ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        proceedWithSaveAndPublish(config);
      },
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      () => {
        console.log('âŒ å…¬é–‹ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      },
      // è‡ªå‹•åœæ­¢è¨­å®š
      autoStopSettings
    );
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ç›´æ¥å®Ÿè¡Œ
    console.warn('âš ï¸ å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ç›´æ¥å®Ÿè¡Œã—ã¾ã™ã€‚');
    proceedWithSaveAndPublish(config);
  }
}

// Proceed with the actual save and publish operation
function proceedWithSaveAndPublish(config) {

  // Set save protection flags to prevent interference
  isSaveInProgress = true;
  freshSaveTimestamp = Date.now();
  window.freshSaveTimestamp = freshSaveTimestamp;
  
  runGasWithUserId('saveAndPublish', 'è¨­å®šã‚’ä¿å­˜ã—ã€ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™...', selectedSheet, config)
    .then(function(result) {
      isSaveInProgress = false;
      
      // Check if result has data (from integrated API) or legacy success status
      if (result && (result.userInfo || result.status === 'success')) {
        showMessage('âœ… è¨­å®šãŒä¿å­˜ã•ã‚Œã€ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
        
        // å±¥æ­´ã«ä¿å­˜ï¼ˆå…¬é–‹æ™‚ï¼‰
        saveHistoryOnPublish(result, config);
        
        // ãƒœãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã«å³åº§æ›´æ–°ã‚’é€šçŸ¥
        try {
          // ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆã‚ã‚Œã°ï¼‰
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'BOARD_PUBLISHED',
              sheetName: selectedSheet,
              timestamp: Date.now()
            }, '*');
            logInfo('ãƒœãƒ¼ãƒ‰å…¬é–‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€ä¿¡');
          }
          
          // åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä»–ã®ã‚¿ãƒ–ã«ã‚‚é€šçŸ¥
          if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('board-updates');
            channel.postMessage({
              type: 'BOARD_PUBLISHED',
              sheetName: selectedSheet,
              timestamp: Date.now()
            });
            channel.close();
            logInfo('ãƒœãƒ¼ãƒ‰å…¬é–‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’BroadcastChannelã§é€ä¿¡');
          }
        } catch (broadcastError) {
          console.warn('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°é€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼:', broadcastError);
        }
        
        // 6æ™‚é–“è‡ªå‹•åœæ­¢ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        setTimeout(() => {
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ç¢ºå®Ÿã«éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
          if (window.unifiedLoadingManager) {
            window.unifiedLoadingManager.setLoading(false);
          }
          
          // å…¬é–‹å®Œäº†ç¢ºèªã¨URLç”Ÿæˆå¾Œã«è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          setTimeout(() => {
            // å…¬é–‹çŠ¶æ…‹ã¨URLç”Ÿæˆã®ç¢ºèª
            if (result && (result.publishedAt || result.userInfo)) {
              const publishResult = {
                publishedAt: result.publishedAt || new Date().toISOString(),
                autoStopMinutes: result.autoStopMinutes || 360,
                boardUrl: result.boardUrl || result.viewUrl || '',
                status: 'success',
                ...result
              };
              
              console.log('ğŸ“Š é€šå¸¸å…¬é–‹å®Œäº†ãƒ‡ãƒ¼ã‚¿ç¢ºèªå®Œäº†');
              
              if (window.sharedModals && typeof window.sharedModals.showAutoStopConfirmation === 'function') {
                window.sharedModals.showAutoStopConfirmation(publishResult);
              } else {
                console.warn('âš ï¸ è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              }
            } else {
              console.warn('âš ï¸ é€šå¸¸å…¬é–‹çµæœãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã®ãŸã‚ã€è‡ªå‹•åœæ­¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™:', result);
            }
          }, 800); // URLç”Ÿæˆå¾…ã¡ã®ãŸã‚å°‘ã—é•·ã‚ã«è¨­å®š
        }, 2000); // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¾Œã«è¡¨ç¤º
        
        // Use fresh data from save response if available
        if (result.userInfo && result._meta) {
          logInfo('Using fresh data from save response');
          updateUIWithNewStatus(result);
        } else {
          // Only force refresh if no fresh data available
          logInfo('No fresh data in response, forcing refresh');
          loadStatus(true).then(() => {
            // ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œã‚’æ›´æ–°
            const currentStep = currentStatus && currentStatus.setupStep ? currentStatus.setupStep : 1;
            updateStepIndicators(currentStep);
            manageSectionStates(currentStep);
          });
        }
      } else {
        logError('Save failed:', result);
        showMessage(result.message || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        isSaveInProgress = false;
      }
    })
    .catch(function(error) {
      logError('saveAndPublish error:', error);
      isSaveInProgress = false;
      
      // çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆã‚¨ãƒ©ãƒ¼å¾Œï¼‰
      cacheManager.clearAllFrontendCaches().catch(clearError => {
        console.warn('Cache clear after error failed:', clearError);
      });
      
      loadStatus(true).then(() => {
        // ã‚¨ãƒ©ãƒ¼å¾Œã‚‚ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œã‚’æ›´æ–°
        const currentStep = currentStatus && currentStatus.setupStep ? currentStatus.setupStep : 1;
        updateStepIndicators(currentStep);
        manageSectionStates(currentStep);
      });
      handleError(error, 'saveAndPublish', 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸã€‚');
    });
}

/**
 * å…¬é–‹åœæ­¢æ™‚ã®å¼·åŒ–ã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥é–¢é€£ã®ã‚¢ã‚¯ã‚»ã‚¹å•é¡Œã‚’é˜²ããŸã‚ã€ã‚ã‚‰ã‚†ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
 */
async function clearAllCachesForUnpublish() {
  console.log('ğŸ§¹ å…¬é–‹åœæ­¢æ™‚ã®åŒ…æ‹¬çš„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†ã‚’é–‹å§‹');
  
  try {
    // 1. æ—¢å­˜ã®å®‰å®šã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ–¹å¼
    // çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
      window.unifiedCache.clear();
    }
    
    // GASæœ€é©åŒ–ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    if (window.gasOptimizer && typeof window.gasOptimizer.clearCache === 'function') {
      window.gasOptimizer.clearCache();
    }
    
    // SharedUtilitiesã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    if (window.sharedUtilities && window.sharedUtilities.cache && typeof window.sharedUtilities.cache.clear === 'function') {
      window.sharedUtilities.cache.clear();
    }
    
    // DOMè¦ç´ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    if (window.sharedUtilities && window.sharedUtilities.dom && typeof window.sharedUtilities.dom.clearElementCache === 'function') {
      window.sharedUtilities.dom.clearElementCache();
    }
    
    // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆStudyQuesté–¢é€£ã®ã¿ï¼‰
    try {
      const localStorageKeys = Object.keys(localStorage);
      const studyQuestKeys = localStorageKeys.filter(key => 
        key.includes('studyquest') || 
        key.includes('board') || 
        key.includes('sheet') ||
        key.includes('admin') ||
        key.includes('publication') ||
        key.includes('answer')
      );
      
      studyQuestKeys.forEach(key => {
        localStorage.removeItem(key);
      });
      
    } catch (e) {
      console.warn('âš ï¸ localStorage clear warning:', e);
    }
    
    // 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚¯ãƒªã‚¢
    try {
      if (window.sessionStorage) {
        const sessionKeys = Object.keys(sessionStorage);
        const studyQuestSessionKeys = sessionKeys.filter(key => 
          key.includes('studyquest') || 
          key.includes('board') || 
          key.includes('admin')
        );
        
        studyQuestSessionKeys.forEach(key => {
          sessionStorage.removeItem(key);
        });
        
      }
    } catch (e) {
      console.warn('âš ï¸ sessionStorage clear warning:', e);
    }
    
    // 4. BroadcastChannelé€šçŸ¥ï¼ˆä»–ã®ã‚¿ãƒ–ã«å…¬é–‹åœæ­¢ã‚’é€šçŸ¥ï¼‰
    try {
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('board-updates');
        channel.postMessage({
          type: 'BOARD_UNPUBLISHED',
          timestamp: Date.now(),
          userId: window.userId || 'unknown'
        });
        channel.close();
      }
    } catch (e) {
      console.warn('âš ï¸ BroadcastChannel notification warning:', e);
    }
    
    // 5. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã®ãŸã‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
    try {
      localStorage.setItem('lastUnpublishTime', Date.now().toString());
      localStorage.setItem('cacheInvalidationToken', Math.random().toString(36));
    } catch (e) {
      console.warn('âš ï¸ Cache invalidation token update warning:', e);
    }
    
    
  } catch (error) {
    console.error('âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã¯ç¶™ç¶š
  }
}

// Unpublish board
function unpublishBoard() {
    return runGasWithUserId('unpublishBoard', 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ä¸­...')
      .then(function(response) {
        logDebug('å…¬é–‹åœæ­¢ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);

        // å¼·åŒ–ã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°å¯¾å¿œï¼‰
        clearAllCachesForUnpublish();

        // Reset column selection dropdowns to default "--åˆ—ã‚’é¸æŠ--" state
        resetColumnSelections();

        // å…¬é–‹åœæ­¢å‡¦ç†ãŒæˆåŠŸã—ãŸã“ã¨ã‚’è¿”ã™
        return Promise.resolve(response);
      })
      .catch(function(error) {
        handleError(error, 'unpublishBoard', 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼ã—ã¦å‘¼ã³å‡ºã—å…ƒã§ã‚­ãƒ£ãƒƒãƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        return Promise.reject(error);
      });
  }

  // ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ä¿å­˜é–¢æ•°ï¼ˆå…¬é–‹æ™‚ï¼‰
  async function saveHistoryOnPublish(publishResponse, config) {
    try {
      const userInfo = publishResponse.userInfo || {};
      
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆæ—¥ã‚’å–å¾—
      let createdDate = null;
      if (userInfo.spreadsheetId) {
        try {
          const createdDateResponse = await runGasWithUserId('getSpreadsheetCreatedDateAPI', false);
          if (createdDateResponse && createdDateResponse.status === 'success') {
            createdDate = createdDateResponse.createdDate;
          }
        } catch (error) {
          console.warn('âš ï¸ ä½œæˆæ—¥å–å¾—å¤±æ•—:', error);
        }
      }
      
      // ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªä½œæˆ
      await createSimpleHistoryEntry(publishResponse, config, userInfo, createdDate);
      
      logDebug('âœ… ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ä¿å­˜å®Œäº†ï¼ˆå…¬é–‹æ™‚ï¼‰');
    } catch (error) {
      logWarn('âš ï¸ å…¬é–‹æ™‚ã®å±¥æ­´ä¿å­˜ã«å¤±æ•—:', error);
    }
  }
  
  /**
   * ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªä½œæˆ
   * @param {Object} publishResponse - å…¬é–‹APIå¿œç­”
   * @param {Object} config - ãƒ•ã‚©ãƒ¼ãƒ è¨­å®š
   * @param {Object} userInfo - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
   * @param {string} createdDate - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆæ—¥
   */
  async function createSimpleHistoryEntry(publishResponse, config, userInfo, createdDate) {
    try {
      // ç¾åœ¨ã®UIçŠ¶æ…‹ã‹ã‚‰è¨­å®šå–å¾—ï¼ˆshowNamesãƒ™ãƒ¼ã‚¹ï¼‰
      const getShowNames = () => {
        const showNamesCheckbox = document.getElementById('show-names');
        return (showNamesCheckbox && showNamesCheckbox.checked) || false;
      };
      
      const getShowCounts = () => {
        const showCountsCheckbox = document.getElementById('show-counts');
        return (showCountsCheckbox && showCountsCheckbox.checked) || false;
      };
      
      // å•é¡Œæ–‡ã‚’è¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
      const questionText = config.opinionHeader ||
                          config.opinionColumn ||
                          userInfo.customFormInfo?.mainQuestion ||
                          'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå•é¡Œæ–‡';
      
      // ã‚·ãƒ³ãƒ—ãƒ«ãªå±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ æ§‹é€ 
      const historyItem = {
        id: generateHistoryId(),
        createdDate: createdDate,
        publishedAt: publishResponse.publishedAt || new Date().toISOString(),
        questionText: questionText,
        setupType: getSetupType(),
        
        // å¾©å…ƒç”¨ã®æœ€å°ãƒ‡ãƒ¼ã‚¿ï¼ˆshowNames/showCountsãƒ™ãƒ¼ã‚¹ï¼‰
        opinionHeader: config.opinionHeader || '',
        nameHeader: config.nameHeader || 'åå‰',
        showNames: getShowNames(),      // UIçŠ¶æ…‹ã‚’ç›´æ¥ä¿å­˜
        showCounts: getShowCounts(),    // UIçŠ¶æ…‹ã‚’ç›´æ¥ä¿å­˜
        
        // å¾©å…ƒç”¨ã®ã‚·ãƒ¼ãƒˆæƒ…å ±
        sheetName: publishResponse.activeSheetName || selectedSheet || '',
        spreadsheetId: userInfo.spreadsheetId || ''
      };
      
      // å±¥æ­´ã«è¿½åŠ ï¼ˆ5ä»¶åˆ¶é™ï¼‰
      addToSimpleHistory(historyItem);
      
      console.log('âœ… Simple history entry created:', historyItem.questionText);
      
    } catch (error) {
      console.error('âŒ Simple history entry creation failed:', error);
    }
  }
  
  /**
   * ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ã«è¿½åŠ ï¼ˆ5ä»¶åˆ¶é™ï¼‰
   * @param {Object} newItem - æ–°ã—ã„å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ 
   */
  function addToSimpleHistory(newItem) {
    try {
      if (window.HistoryManager) {
        // Use new unified HistoryManager
        const success = window.HistoryManager.add(newItem);
        if (success) {
          console.log('âœ… History saved using HistoryManager');
          // Update UI table
          window.HistoryManager.renderTable();
        } else {
          console.warn('âš ï¸ Failed to save history using HistoryManager');
        }
      } else {
        // Fallback to legacy method
        console.warn('âš ï¸ HistoryManager not available, using legacy method');
        const history = getHistoryFromStorage();
        
        // å…ˆé ­ã«è¿½åŠ 
        history.unshift(newItem);
        
        // 5ä»¶ã«åˆ¶é™
        const limitedHistory = history.slice(0, 5);
        
        // ä¿å­˜
        saveHistoryToStorage(limitedHistory);
        
        console.log(`âœ… History saved with ${limitedHistory.length} items (max 5)`);
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        if (typeof loadSimpleHistoryTable === 'function') {
          loadSimpleHistoryTable();
        }
      }
      
    } catch (error) {
      console.error('âŒ Failed to add to simple history:', error);
    }
  }
  
  /**
   * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã®å–å¾—
   * @returns {string} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—
   */
  function getSetupType() {
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‹ã‚‰åˆ¤å®š
    if (sessionStorage.getItem('quickStartActive')) {
      return 'quickstart';
    }
    return 'custom';
  }
  
  /**
   * å±¥æ­´IDç”Ÿæˆ
   * @returns {string} ä¸€æ„ã®ID
   */
  function generateHistoryId() {
    return 'history_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }
  
  // å¤ã„è¤‡é›‘ãªcreateConsolidatedHistoryEntryé–¢æ•°ã¯å‰Šé™¤æ¸ˆã¿
  
  /**
   * Create history entry for QuickStart completion
   * @param {Object} quickStartResult - QuickStart completion result
   */
  function createQuickStartHistoryEntry(quickStartResult) {
    try {
      logDebug('Creating QuickStart history entry:', quickStartResult);
      
      // Extract question text from QuickStart config with better fallback
      const questionText = (quickStartResult.config && quickStartResult.config.opinionHeader) ||
                          (quickStartResult.config && quickStartResult.config.opinionColumn) ||
                          (quickStartResult.config && quickStartResult.config.reasonHeader) ||
                          (quickStartResult.config && quickStartResult.config.nameHeader) ||
                          'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå•é¡Œæ–‡';
      
      console.log('ğŸ“ QuickStart question text extracted:', questionText);
      
      // Use completion time as both creation and publication time for QuickStart
      const completedAt = quickStartResult.completedAt || new Date().toISOString();
      const publishedAt = (quickStartResult.publishResult && quickStartResult.publishResult.publishedAt) || completedAt;
      
      // Create simplified QuickStart history entry
      const historyItem = {
        id: generateHistoryId(),
        createdDate: completedAt, // QuickStart creates and publishes simultaneously
        publishedAt: publishedAt,
        questionText: questionText,
        setupType: 'quickstart',
        opinionHeader: (quickStartResult.config && quickStartResult.config.opinionHeader) || '',
        nameHeader: (quickStartResult.config && quickStartResult.config.nameHeader) || 'åå‰',
        showNames: false,   // QuickStartãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: åå‰è¡¨ç¤ºOFFï¼ˆåŒ¿åï¼‰
        showCounts: false,  // QuickStartãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°è¡¨ç¤ºOFF
        sheetName: quickStartResult.sheetName || quickStartResult.publishedSheetName || '',
        spreadsheetId: quickStartResult.spreadsheetId || ''
      };
      
      addToSimpleHistory(historyItem);
      
      // Update UI - handled by addToSimpleHistory function
      // No need for additional UI update call here
      
      logDebug('QuickStart simple history entry created successfully:', {
        id: historyItem.id,
        questionText: historyItem.questionText,
        createdDate: historyItem.createdDate,
        publishedAt: historyItem.publishedAt,
        setupType: historyItem.setupType
      });
      
    } catch (error) {
      logError('Failed to create QuickStart history entry:', error);
    }
  }

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®šã™ã‚‹è£œåŠ©é–¢æ•°
function determineSetupType(config, userInfo) {
  if (userInfo.customFormInfo) {
    return 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—';
  } else if (config.isQuickStart || config.setupType === 'quickstart') {
    return 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ';
  } else if (config.isExternalResource) {
    return 'å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹';
  } else {
    return 'unknown';
  }
}

// Reset column selection dropdowns to default state
function resetColumnSelections() {
  
  const columnSelects = [
    'opinion-column-select',
    'name-column-select', 
    'reason-column-select',
    'class-column-select',
    'timestamp-column-select'
  ];
  
  columnSelects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.value = ''; // Reset to empty value
    }
  });
  
  // Also reset any display checkboxes
  const checkboxes = ['show-names', 'show-counts'];
  checkboxes.forEach(checkboxId => {
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) {
      checkbox.checked = false;
    }
  });
}

// =============================================================================
// FORM MANAGEMENT
// =============================================================================

// Load saved class choices
function loadSavedClassChoices() {
    runGasWithUserId('getSavedClassChoices', 'ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’èª­ã¿è¾¼ã¿ä¸­...')
        .then(function(result) {
            if (result.status === 'success' && result.classChoices) {
                const classChoicesTextarea = document.getElementById('class-choices');
                if (classChoicesTextarea) {
                    classChoicesTextarea.value = result.classChoices.join('\n');
                }
            }
        })
        .catch(function(error) {
            console.warn('ä¿å­˜ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error.message);
            showMessage('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        });
}

// Create form with custom configuration
/**
 * QuickStartã¨åŒã˜å½¢å¼ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã€‚
 * @returns {string} ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã€‚
 */
function generateQuickstartFormTitle() {
  const now = new Date();
  const formatter = new Intl.DateTimeFormat('ja-JP', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
    timeZone: 'Asia/Tokyo'
  });
  const formatted = formatter.format(now);
  const [datePart, timePart] = formatted.split(' ');
  const [year, month, day] = datePart.split('/');
  return `ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰ ${year}å¹´${month}æœˆ${day}æ—¥ ${timePart}`;
}

function createFormWithConfig() {
  const questionTextarea = document.getElementById('custom-main-question');
  const questionTypeSelect = document.getElementById('main-question-type');
  const questionChoicesTextarea = document.getElementById('main-question-choices');
  const classChoicesTextarea = document.getElementById('class-choices');
  const includeOthersOption = document.getElementById('include-others-option').checked;
  const enableClassSelection = document.getElementById('enable-class-selection').checked;
  
  if (!questionTextarea || !questionTypeSelect) {
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  const question = questionTextarea.value.trim();
  const questionType = questionTypeSelect.value; // å›ç­”æ–¹æ³•ã‚’å–å¾—
  const questionChoicesText = questionChoicesTextarea ? questionChoicesTextarea.value.trim() : '';
  const classChoicesText = enableClassSelection && classChoicesTextarea ? classChoicesTextarea.value.trim() : '';
  
  if (!question) {
    showMessage('å•é¡Œæ–‡ã¯å¿…é ˆã§ã™ã€‚', 'warning');
    return;
  }
  
  // é¸æŠè‚¢ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯é¸æŠè‚¢ãŒå¿…è¦
  if ((questionType === 'choice' || questionType === 'multiple') && !questionChoicesText) {
    showMessage('é¸æŠè‚¢ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯é¸æŠè‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  // é¸æŠè‚¢ã‚’é…åˆ—ã«å¤‰æ›
  const questionChoices = questionChoicesText ? 
    questionChoicesText.split('\n').map(choice => choice.trim()).filter(choice => choice.length > 0) : [];
  
  // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’é…åˆ—ã«å¤‰æ›  
  const classChoices = classChoicesText ? 
    classChoicesText.split('\n').map(choice => choice.trim()).filter(choice => choice.length > 0) : [];
  
  const config = {
    mainQuestion: question,
    responseType: questionType, // å›ç­”æ–¹æ³•ã‚’è¿½åŠ 
    questionChoices: questionChoices, // ãƒ¡ã‚¤ãƒ³è³ªå•ã®é¸æŠè‚¢
    classChoices: classChoices,
    includeOthers: includeOthersOption,
    enableClass: enableClassSelection && classChoices.length > 0,
    formTitle: generateQuickstartFormTitle(),
  };
  
  console.log('ğŸ“‹ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šæº–å‚™å®Œäº†');
  
  hideFormConfigModal();
  
  // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨é€²æ—è¡¨ç¤ºã‚’é–‹å§‹
  // Use the new unified custom setup system
  console.log('ğŸ¨ çµ±åˆã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹');
  
  // userEmailã¯ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‹ã‚‰å–å¾—
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.adminEmail) {
    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }
  
  // Call the new unified custom setup handler - this replaces the old createCustomFormUI flow
  handleCustomSetup(config);
  
  // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
  saveClassChoicesToDatabase(classChoices);
}


// Save class choices to database
function saveClassChoicesToDatabase(classChoices) {
    runGasWithUserId('saveClassChoices', classChoices)
        .catch(function(error) {
            console.warn('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®ä¿å­˜ã«å¤±æ•—:', error.message);
        });
}

// =============================================================================
// RESOURCE MANAGEMENT
// =============================================================================

// Add spreadsheet resource
function addResource() {
  const urlInput = document.getElementById('resource-url-input');
  if (!urlInput) {
    showMessage('URLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  const url = urlInput.value.trim();
  if (!url) {
    showMessage('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }

  // URLã®ç¨®é¡ã‚’åˆ¤å®šï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã¿å¯¾å¿œï¼‰
  let resourceType = 'spreadsheet';
  let backendFunction = 'addSpreadsheetUrl';
  
  if (!url.includes('docs.google.com/spreadsheets/')) {
    showMessage('Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  const resourceTypeText = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ';

  runGasWithUserId(backendFunction, `${resourceTypeText}ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™...`, url)
    .then(function(result) {
      if (result.status === 'success') {
        showMessage(result.message, 'success');
        urlInput.value = ''; // Clear input
        loadStatus(true); // Refresh status
      } else {
        showMessage(result.message || `${resourceTypeText}ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`, 'error');
      }
    })
    .catch(function(error) {
      handleError(error, 'addResource', `${resourceTypeText}ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
    });
}

// =============================================================================
// EXTERNAL LINKS AND NAVIGATION
// =============================================================================

// Copy board URL to clipboard
function copyBoardUrl(buttonElement) {
  const urlInput = document.getElementById('board-url');
  if (!urlInput) {
    console.error('board-url input element not found.');
    return;
  }

  const urlToCopy = urlInput.value;

  if (!urlToCopy) {
    showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
    return;
  }

  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(urlToCopy).then(() => {
        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>ã‚³ãƒ”ãƒ¼å®Œäº†!';
        buttonElement.disabled = true;
        setTimeout(() => {
          buttonElement.innerHTML = originalText;
          buttonElement.disabled = false;
        }, 2000);
      }).catch((error) => {
        console.error('Clipboard API failed:', error);
        // Fallback to manual copy message
        const messageElement = document.createElement('span');
        messageElement.textContent = ' (æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)';
        messageElement.style.color = 'orange';
        buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
        setTimeout(() => messageElement.remove(), SYSTEM_CONSTANTS.TIMEOUTS.ERROR_DISPLAY_DURATION);
      });
    } else {
      // Fallback for browsers that don't support Clipboard API
      urlInput.select();
      urlInput.setSelectionRange(0, 99999); // For mobile devices
      document.execCommand('copy');
      showMessage('URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success'); // Fallback uses showMessage
    }
  } catch (err) {
    console.error('copyBoardUrl error:', err);
    showMessage('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'warning'); // Fallback uses showMessage
  }
}

// Copy form URL to clipboard
function copyFormUrl() {
  const urlInput = document.getElementById('form-url-input');
  if (urlInput && urlInput.value) {
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      // Try modern clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(urlInput.value).then(() => {
          showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
        }).catch(() => {
          // Fallback to execCommand
          document.execCommand('copy');
          showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
        });
      } else {
        document.execCommand('copy');
        showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
      }
    } catch (err) {
      showMessage('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'warning');
    }
  } else {
    showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
  }
}

// Open database spreadsheet
function openDatabaseSpreadsheet() {
  if (currentSpreadsheetUrl) {
    window.open(currentSpreadsheetUrl, '_blank');
  } else {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'warning');
  }
}

// Open form
function openForm() {
  console.log('ğŸ”— openForm function called');
  
  // ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡è¦–
  const formBtn = document.getElementById('open-form-btn');
  if (formBtn && formBtn.disabled) {
    console.log('âš ï¸ Form button is disabled, ignoring click');
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ã‹ã‚‰ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ URLã‚’å–å¾—ã™ã‚‹å„ªå…ˆé †ä½ã‚’è¨­å®š
  let formUrl = null;
  
  // 1. configJsonã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰
  if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
    try {
      const configJson = typeof currentStatus.userInfo.configJson === 'string' 
        ? JSON.parse(currentStatus.userInfo.configJson) 
        : currentStatus.userInfo.configJson;
      
      if (configJson && configJson.formUrl) {
        formUrl = configJson.formUrl;
        logDebug('âœ… FormURLå–å¾—: configJsonã‹ã‚‰ç›´æ¥å–å¾—æˆåŠŸ');
      }
    } catch (error) {
      logWarn('âš ï¸ configJsonã®è§£æã§ã‚¨ãƒ©ãƒ¼:', error);
    }
  }
  
  // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®formUrlã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  if (!formUrl && currentStatus && currentStatus.userInfo && currentStatus.userInfo.formUrl) {
    formUrl = currentStatus.userInfo.formUrl;
    logDebug('ğŸ“‹ FormURLå–å¾—: userInfo.formUrlã‹ã‚‰å–å¾—');
  }
  
  // 3. ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‹ã‚‰å–å¾—ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
  if (!formUrl && currentStatus && currentStatus.customFormInfo && currentStatus.customFormInfo.formUrl) {
    formUrl = currentStatus.customFormInfo.formUrl;
    logDebug('ğŸ“„ FormURLå–å¾—: customFormInfo.formUrlã‹ã‚‰å–å¾—');
  }
  
  if (formUrl) {
    window.open(formUrl, '_blank');
  } else {
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'warning');
  }
}

// Open app setup page
function openAppSetupPage() {
  // ãƒœã‚¿ãƒ³ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯: ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç„¡åŠ¹åŒ–
  const setupButton = document.querySelector('[onclick="openAppSetupPage()"]');
  const originalText = setupButton ? setupButton.textContent : '';
  
  if (setupButton) {
    setupButton.disabled = true;
    setupButton.style.opacity = '0.6';
    setupButton.style.pointerEvents = 'none';
    const span = setupButton.querySelector('span');
    if (span) {
      span.textContent = 'æº–å‚™ä¸­...';
    }
  }
  
  // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  const restoreButton = () => {
    if (setupButton) {
      setupButton.disabled = false;
      setupButton.style.opacity = '';
      setupButton.style.pointerEvents = '';
      const span = setupButton.querySelector('span');
      if (span && originalText.includes('ã‚¢ãƒ—ãƒªè¨­å®šç®¡ç†')) {
        span.textContent = 'ã‚¢ãƒ—ãƒªè¨­å®šç®¡ç†';
      }
    }
  };

  const loadingMessage = 'ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã‚’æº–å‚™ä¸­...';
  const errorMessage = 'ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
  const timeoutMessage = 'ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚';
  const fallbackMessage = 'ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚';

  runGasWithUserId('getWebAppUrl', loadingMessage)
    .then(function(webAppUrl) {
      const setupUrl = webAppUrl + '?setup=true&mode=appsetup&userId=' + encodeURIComponent(userId);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹
      showMessage('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ç§»å‹•ä¸­...', 'info');
      window.unifiedLoading.showSimple('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ç§»å‹•ä¸­...');

      const redirectTimeout = setTimeout(() => {
        console.warn('Redirect to app setup page timed out. Attempting fallback.');
        window.unifiedLoading.hide();
        restoreButton();
        showMessage(timeoutMessage, 'warning');
        window.open(setupUrl, '_blank'); // Fallback: open in new tab
      }, 10000); // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

      // ç›´æ¥ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è©¦ã¿ã‚‹
      try {
        clearTimeout(redirectTimeout);
        window.unifiedLoading.hide();
        // æˆåŠŸæ™‚ã¯ãƒšãƒ¼ã‚¸ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ã®ã§restoreButton()ã¯å‘¼ã°ãªã„
        window.open(setupUrl, '_top'); // _top ã‚’ä½¿ç”¨ã—ã¦ç¾åœ¨ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
      } catch (e) {
        console.error('Error opening app setup page:', e);
        window.unifiedLoading.hide();
        restoreButton();
        showMessage(errorMessage + ' ' + (e.message || ''), 'error');
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        showMessage(fallbackMessage, 'info');
        window.open(setupUrl, '_blank');
      }
    })
    .catch(function(error) {
      console.error('Failed to get web app URL for app setup page:', error);
      window.unifiedLoading.hide();
      restoreButton();
      showMessage('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã®URLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚' + (error.message || ''), 'error');
    });
}

// =============================================================================
// POLLING AND REAL-TIME UPDATES
// =============================================================================

// System status polling variables
let lastUserActivity = Date.now();
let currentPollInterval = 5 * 60 * 1000; // é–‹å§‹ã¯5åˆ†é–“éš”
let statusPollTimer = null;

// Fresh save management to prevent interference
let freshSaveTimestamp = 0;
let isSaveInProgress = false;
const FRESH_SAVE_PROTECTION_DURATION = 30000; // 30 seconds

// Make freshSaveTimestamp globally accessible
window.freshSaveTimestamp = freshSaveTimestamp;

// =============================================================================
// CONFIG VERIFICATION MECHANISM
// =============================================================================

/**
 * è¨­å®šä¿å­˜å¾Œã®æ¤œè¨¼æ©Ÿèƒ½
 * ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§è¨­å®šã—ãŸå†…å®¹ãŒæ­£ã—ãä¿å­˜ãƒ»åæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
 */
async function verifyConfigAfterSave(expectedSheetName, expectedConfig) {
  try {
    
    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å†å–å¾—
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const verificationStatus = await runGasWithUserId('getAppConfig', 'è¨­å®šåæ˜ ã‚’ç¢ºèªä¸­...');
    
    if (verificationStatus && verificationStatus.userInfo) {
      const configJson = JSON.parse(verificationStatus.userInfo.configJson || '{}');
      const sheetKey = 'sheet_' + (expectedSheetName || '');
      const savedConfig = configJson[sheetKey];
      
      
      // åŸºæœ¬çš„ãªæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      const isConsistent = (
        savedConfig &&
        savedConfig.guessedConfig &&
        expectedConfig.opinionHeader &&
        savedConfig.guessedConfig.opinionHeader === expectedConfig.opinionHeader
      );
      
      if (isConsistent) {
        return { success: true, message: 'è¨­å®šãŒæ­£å¸¸ã«åæ˜ ã•ã‚Œã¾ã—ãŸ' };
      } else {
        console.warn('âš ï¸ è¨­å®šåæ˜ ç¢ºèª: è¨­å®šã«ä¸æ•´åˆãŒã‚ã‚Šã¾ã™');
        
        // è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œ
        console.log('ğŸ”§ è¨­å®šä¸æ•´åˆã‚’æ¤œå‡º - è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œä¸­...');
        await runGasWithUserId('saveSheetConfig', 'è¨­å®šã‚’ä¿®å¾©ä¸­...',
          currentStatus.userInfo.spreadsheetId, expectedSheetName, expectedConfig, { batchMode: true });
        
        return { success: false, message: 'è¨­å®šä¸æ•´åˆã‚’æ¤œå‡ºã—ã€ä¿®å¾©ã‚’è©¦è¡Œã—ã¾ã—ãŸ', repaired: true };
      }
    }
    
    return { success: false, message: 'è¨­å®šç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' };
    
  } catch (error) {
    console.error('âŒ è¨­å®šåæ˜ ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
    return { success: false, message: 'è¨­å®šç¢ºèªå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message };
  }
}

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªï¼ˆQuickStartãƒ»Custom Setupå…±é€šï¼‰
 * @param {string} flowType - 'quickstart' ã¾ãŸã¯ 'custom'
 * @param {string} sheetName - å¯¾è±¡ã‚·ãƒ¼ãƒˆå
 * @returns {Object} å®Œäº†ç¢ºèªçµæœ
 */
async function verifySetupFlowCompletion(flowType, sheetName) {
  try {
    console.log(`ğŸ¯ ${flowType}ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªé–‹å§‹:`, sheetName);
    
    // è¨­å®šãŒå®‰å®šã™ã‚‹ã¾ã§å°‘ã—å¾…ã¤
    await new Promise(resolve => setTimeout(resolve, 3000));
    
    const completionStatus = await runGasWithUserId('getAppConfig', 'ãƒ•ãƒ­ãƒ¼å®Œäº†çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');
    
    if (!completionStatus || !completionStatus.userInfo) {
      console.error('âŒ ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèª: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—å¤±æ•—');
      return { success: false, message: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' };
    }
    
    const configJson = JSON.parse(completionStatus.userInfo.configJson || '{}');
    const issues = [];
    
    // å¿…é ˆå®Œäº†çŠ¶æ…‹ã®ç¢ºèª
    
    // 1. setupStatus='completed' ç¢ºèª
    if (configJson.setupStatus !== 'completed') {
      issues.push(`âŒ setupStatus: "${configJson.setupStatus}" â†’ "completed"ãŒå¿…è¦`);
    }
    
    // 2. appPublished=true ç¢ºèª  
    if (configJson.appPublished !== true) {
      issues.push(`âŒ appPublished: ${configJson.appPublished} â†’ trueãŒå¿…è¦`);
    }
    
    // 3. formCreated=true ç¢ºèª
    if (configJson.formCreated !== true) {
      issues.push(`âŒ formCreated: ${configJson.formCreated} â†’ trueãŒå¿…è¦`);
    }
    
    // 4. å…¬é–‹æƒ…å ±ã®ç¢ºèª
    if (!configJson.publishedSheetName) {
      issues.push(`âŒ publishedSheetNameæœªè¨­å®š â†’ "${sheetName}"ãŒå¿…è¦`);
    } else if (configJson.publishedSheetName !== sheetName) {
      issues.push(`âŒ publishedSheetNameä¸ä¸€è‡´: "${configJson.publishedSheetName}" â†’ "${sheetName}"`);
    }
    
    // 4. publishedSpreadsheetIdã®ç¢ºèªï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œï¼‰
    if (!configJson.publishedSpreadsheetId) {
      // completionStatusã‹ã‚‰spreadsheetIdã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      if (completionStatus.userInfo && completionStatus.userInfo.spreadsheetId) {
        console.log(`ğŸ”§ publishedSpreadsheetIdã‚’userInfo.spreadsheetIdã§è£œå®Œ: ${completionStatus.userInfo.spreadsheetId}`);
        // ã“ã®å€¤ã¯å¾Œã§åŒæœŸä¿®æ­£ã§è¨­å®šã•ã‚Œã‚‹
      } else {
        issues.push('âŒ publishedSpreadsheetIdæœªè¨­å®š');
      }
    }
    
    // 5. ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šã®ç¢ºèªï¼ˆã‚ˆã‚ŠæŸ”è»Ÿãªåˆ¤å®šï¼‰
    const sheetKey = 'sheet_' + (sheetName || '');
    const sheetConfig = configJson[sheetKey];
    const hasSheetConfig = !!(sheetConfig && (sheetConfig.guessedConfig || sheetConfig.opinionHeader));
    
    if (!hasSheetConfig) {
      // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ­ãƒ¼ã§è¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯è­¦å‘Šã«æ ¼ä¸‹ã’
      if (flowType === 'custom' && configJson.setupStatus === 'completed') {
        console.warn(`âš ï¸ ã‚·ãƒ¼ãƒˆè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ãŒã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ­ãƒ¼å®Œäº†ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—: ${sheetKey}`);
      } else {
        issues.push(`âŒ ã‚·ãƒ¼ãƒˆè¨­å®šæœªä¿å­˜: ${sheetKey}`);
      }
    }
    
    if (issues.length === 0) {
      return {
        success: true,
        message: `${flowType}ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ`,
        details: {
          setupStatus: configJson.setupStatus,
          appPublished: configJson.appPublished,
          formCreated: configJson.formCreated,
          publishedSheetName: configJson.publishedSheetName,
          hasSheetConfig: !!(sheetConfig && sheetConfig.guessedConfig)
        }
      };
    } else {
      console.warn(`âš ï¸ ${flowType}ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèª: æœªå®Œäº†é …ç›®ãŒã‚ã‚Šã¾ã™`, issues);
      return {
        success: false,
        message: `${flowType}ãƒ•ãƒ­ãƒ¼ã«æœªå®Œäº†é …ç›®ãŒã‚ã‚Šã¾ã™`,
        issues: issues,
        details: {
          setupStatus: configJson.setupStatus,
          appPublished: configJson.appPublished,
          formCreated: configJson.formCreated,
          publishedSheetName: configJson.publishedSheetName,
          hasSheetConfig: !!(sheetConfig && sheetConfig.guessedConfig)
        }
      };
    }
    
  } catch (error) {
    console.error(`âŒ ${flowType}ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªã‚¨ãƒ©ãƒ¼:`, error);
    return { 
      success: false, 
      message: `ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}` 
    };
  }
}

/**
 * è¨­å®šåŒæœŸãƒ¡ã‚«ãƒ‹ã‚ºãƒ å¼·åŒ– - ãƒ•ãƒ­ãƒ¼å®Œäº†çŠ¶æ…‹ã¨ã®æ•´åˆæ€§ã‚’ä¿ã¤
 * @param {string} flowType - 'quickstart' ã¾ãŸã¯ 'custom'
 * @param {Object} expectedState - æœŸå¾…ã•ã‚Œã‚‹è¨­å®šçŠ¶æ…‹
 * @returns {Promise<Object>} åŒæœŸçµæœ
 */
async function enhanceConfigSynchronization(flowType, expectedState) {
  try {
    
    // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
    const currentStatus = await runGasWithUserId('getAppConfig', 'è¨­å®šåŒæœŸã®ãŸã‚æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ä¸­...');
    
    if (!currentStatus || !currentStatus.userInfo) {
      throw new Error('è¨­å®šåŒæœŸ: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—å¤±æ•—');
    }
    
    const configJson = JSON.parse(currentStatus.userInfo.configJson || '{}');
    const synchronizationIssues = [];
    const appliedFixes = [];
    
    // 1. å¿…é ˆè¨­å®šçŠ¶æ…‹ã®ç¢ºèªã¨ä¿®æ­£
    const requiredStates = {
      setupStatus: 'completed',
      appPublished: true,
      formCreated: true,
      publishedSheetName: expectedState.sheetName,
      publishedSpreadsheetId: expectedState.spreadsheetId || currentStatus.userInfo.spreadsheetId
    };
    
    let needsSync = false;
    const updatedConfig = { ...configJson };
    
    for (const [key, expectedValue] of Object.entries(requiredStates)) {
      if (configJson[key] !== expectedValue) {
        synchronizationIssues.push(`${key}: "${configJson[key]}" â†’ "${expectedValue}"`);
        updatedConfig[key] = expectedValue;
        needsSync = true;
      }
    }
    
    // 2. ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šã®åŒæœŸç¢ºèª
    if (expectedState.sheetName && expectedState.config) {
      const sheetKey = 'sheet_' + (expectedState.sheetName || '');
      const currentSheetConfig = configJson[sheetKey];
      
      
      if (!currentSheetConfig || !currentSheetConfig.guessedConfig) {
        synchronizationIssues.push(`ã‚·ãƒ¼ãƒˆè¨­å®šæœªä¿å­˜: ${sheetKey}`);
        updatedConfig[sheetKey] = {
          guessedConfig: expectedState.config,
          lastUpdated: new Date().toISOString(),
          flowType: flowType
        };
        needsSync = true;
        console.log(`ğŸ“ ${flowType}ãƒ•ãƒ­ãƒ¼: ã‚·ãƒ¼ãƒˆè¨­å®šã‚’ä½œæˆ ${sheetKey}`);
      }
    }
    
    // 3. è¨­å®šã®åŒæœŸé©ç”¨ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰
    if (needsSync) {
      console.log(`ğŸ”§ ${flowType}ãƒ•ãƒ­ãƒ¼: è¨­å®šä¸æ•´åˆã‚’æ¤œå‡º - åŒæœŸä¿®æ­£ã‚’å®Ÿè¡Œ`, synchronizationIssues);
      
      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«åŒæœŸä¿®æ­£ã‚’ä¾é ¼ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é †åºä¿®æ­£ï¼‰
      const syncResult = await runGasWithUserId('syncConfigurationState', 'è¨­å®šåŒæœŸã‚’å®Ÿè¡Œä¸­...', 
        updatedConfig, 'repair');
      
      if (syncResult && syncResult.success) {
        appliedFixes.push(...synchronizationIssues);
        
        // çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã§æœ€æ–°çŠ¶æ…‹ã‚’åæ˜ 
        try {
          await cacheManager.clearAllFrontendCaches();
        } catch (clearError) {
          console.warn('Cache clear failed during sync:', clearError);
        }
        
        return {
          success: true,
          synchronized: true,
          appliedFixes: appliedFixes,
          message: `${flowType}ãƒ•ãƒ­ãƒ¼ã®è¨­å®šåŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ`
        };
      } else {
        console.warn(`âš ï¸ ${flowType}ãƒ•ãƒ­ãƒ¼: è¨­å®šåŒæœŸä¿®æ­£ã«å¤±æ•—`, syncResult);
        return {
          success: false,
          synchronized: false,
          issues: synchronizationIssues,
          syncResult: syncResult,
          message: 'è¨­å®šåŒæœŸä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ',
          details: {
            errors: (syncResult && syncResult.errors) || [],
            systemError: syncResult && syncResult.systemError,
            context: syncResult && syncResult.context
          }
        };
      }
    } else {
      return {
        success: true,
        synchronized: false,
        message: `${flowType}ãƒ•ãƒ­ãƒ¼ã®è¨­å®šã¯æ—¢ã«æ­£ã—ãåŒæœŸã•ã‚Œã¦ã„ã¾ã™`
      };
    }
    
  } catch (error) {
    console.error(`âŒ ${flowType}ãƒ•ãƒ­ãƒ¼è¨­å®šåŒæœŸã‚¨ãƒ©ãƒ¼:`, error);
    return {
      success: false,
      synchronized: false,
      error: error.message,
      message: `è¨­å®šåŒæœŸå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`
    };
  }
}

/**
 * çµ±åˆçš„ãªè¨­å®šæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ - è¤‡æ•°ãƒ•ãƒ­ãƒ¼ã«å¯¾å¿œ
 * @param {Object} status - ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
 * @returns {Object} æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯çµæœ
 */
function performIntegratedConfigConsistencyCheck(status) {
  if (!status || !status.userInfo) {
    return { consistent: false, issues: ['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™'] };
  }
  
  try {
    const configJson = JSON.parse(status.userInfo.configJson || '{}');
    const issues = [];
    const recommendations = [];
    
    // 1. åŸºæœ¬çš„ãªè¨­å®šæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    const basicChecks = [
      {
        condition: configJson.setupStatus === 'completed',
        issue: 'setupStatusãŒcompletedã§ã¯ã‚ã‚Šã¾ã›ã‚“',
        recommendation: 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼ã‚’å®Œäº†ã—ã¦ãã ã•ã„'
      },
      {
        condition: configJson.formCreated === true,
        issue: 'formCreatedãŒtrueã§ã¯ã‚ã‚Šã¾ã›ã‚“',
        recommendation: 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'
      },
      {
        condition: !!configJson.publishedSheetName,
        issue: 'publishedSheetNameãŒæœªè¨­å®šã§ã™',
        recommendation: 'ã‚·ãƒ¼ãƒˆé¸æŠã‚’ç¢ºèªã—ã¦ãã ã•ã„'
      },
      {
        condition: !!configJson.publishedSpreadsheetId,
        issue: 'publishedSpreadsheetIdãŒæœªè¨­å®šã§ã™',
        recommendation: 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„'
      }
    ];
    
    basicChecks.forEach(check => {
      if (!check.condition) {
        issues.push(check.issue);
        recommendations.push(check.recommendation);
      }
    });
    
    // 2. å…¬é–‹çŠ¶æ…‹ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    if (configJson.appPublished === true) {
      if (configJson.setupStatus !== 'completed') {
        issues.push('å…¬é–‹çŠ¶æ…‹ãªã®ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæœªå®Œäº†ã§ã™');
        recommendations.push('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã™ã‚‹ã‹ã€å…¬é–‹ã‚’åœæ­¢ã—ã¦ãã ã•ã„');
      }
      if (!configJson.formCreated) {
        issues.push('å…¬é–‹çŠ¶æ…‹ãªã®ã«ãƒ•ã‚©ãƒ¼ãƒ ãŒæœªä½œæˆã§ã™');
        recommendations.push('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã‹ã€å…¬é–‹ã‚’åœæ­¢ã—ã¦ãã ã•ã„');
      }
    }
    
    // 3. ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    if (configJson.publishedSheetName) {
      const sheetKey = 'sheet_' + (configJson.publishedSheetName || '');
      const sheetConfig = configJson[sheetKey];
      
      if (!sheetConfig || !sheetConfig.guessedConfig) {
        issues.push(`ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šãŒæœªä¿å­˜ã§ã™: ${configJson.publishedSheetName}`);
        recommendations.push('åˆ—è¨­å®šã‚’ç¢ºèªãƒ»ä¿å­˜ã—ã¦ãã ã•ã„');
      }
    }
    
    const isConsistent = issues.length === 0;
    
    return {
      consistent: isConsistent,
      issues: issues,
      recommendations: recommendations,
      severity: issues.length > 3 ? 'high' : issues.length > 1 ? 'medium' : 'low',
      summary: isConsistent ? 'è¨­å®šã¯æ•´åˆæ€§ãŒä¿ãŸã‚Œã¦ã„ã¾ã™' : `${issues.length}ä»¶ã®æ•´åˆæ€§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`
    };
    
  } catch (error) {
    console.error('è¨­å®šæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
    return {
      consistent: false,
      issues: ['è¨­å®šè§£æã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'],
      recommendations: ['è¨­å®šã‚’å†ç¢ºèªã—ã¦ãã ã•ã„'],
      error: error.message
    };
  }
}

// Get optimal polling interval based on user activity
function getOptimalPollInterval() {
  const timeSinceActivity = Date.now() - lastUserActivity;
  
  if (timeSinceActivity < 2 * 60 * 1000) { // 2åˆ†ä»¥å†…
    return 30 * 1000; // 30ç§’é–“éš”
  } else if (timeSinceActivity < 10 * 60 * 1000) { // 10åˆ†ä»¥å†…
    return 2 * 60 * 1000; // 2åˆ†é–“éš”
  } else {
    return 10 * 60 * 1000; // 10åˆ†é–“éš”
  }
}

// Restart status polling with new interval
function restartStatusPolling() {
  if (statusPollTimer) {
    clearInterval(statusPollTimer);
  }
  currentPollInterval = getOptimalPollInterval();
  startSystemStatusUpdate();
}

// Start system status update polling
function startSystemStatusUpdate() {
  statusPollTimer = setInterval(function() {
    // UIãŒéè¡¨ç¤ºã®æ™‚ã¯æ›´æ–°ã—ãªã„
    if (document.hidden) return;
    
    // Skip background updates if save operation is in progress or recently completed
    if (isSaveInProgress) {
      logDebug('Skipping background update: save in progress');
      return;
    }
    
    const timeSinceFreshSave = Date.now() - freshSaveTimestamp;
    if (timeSinceFreshSave < FRESH_SAVE_PROTECTION_DURATION) {
      logDebug('Skipping background update: fresh save protection active');
      return;
    }
    
    // ç¾åœ¨ã®ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´
    const optimalInterval = getOptimalPollInterval();
    if (Math.abs(currentPollInterval - optimalInterval) > 30000) { // 30ç§’ä»¥ä¸Šã®å·®
      restartStatusPolling();
      return;
    }
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã—ã¦é™ã‹ã«æ›´æ–°
    runGasWithUserId('getStatus', false)
      .then(function(status) {
        // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿UIã‚’æ›´æ–°
        if (JSON.stringify(status) !== JSON.stringify(currentStatus)) {
          updateUIWithNewStatus(status);
        }
      })
      .catch(function(error) {
        logWarn('Background status update failed:', error);
      });
  }, currentPollInterval);
}

// =============================================================================
// CONFIG MANAGEMENT
// =============================================================================

// Reset configJson to initial values
function resetConfigJson() {
  // å±é™ºæ“ä½œã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  const confirmMessage = `âš ï¸ è¨­å®šãƒªã‚»ãƒƒãƒˆã®ç¢ºèª

ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®è¨­å®šãŒåˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼š
â€¢ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šï¼ˆè³ªå•æ–‡ã€å›ç­”æ–¹æ³•ãªã©ï¼‰
â€¢ è¡¨ç¤ºè¨­å®šï¼ˆåŒ¿åè¡¨ç¤ºã€é›†è¨ˆè¡¨ç¤ºãªã©ï¼‰
â€¢ ã‚·ãƒ¼ãƒˆè¨­å®šï¼ˆå›ç­”é€£æºãªã©ï¼‰

â€» ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚„ãƒ•ã‚©ãƒ¼ãƒ è‡ªä½“ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ãŒã€
ã€€ è¨­å®šã®å†æ§‹ç¯‰ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

æœ¬å½“ã«è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`;

  if (!confirm(confirmMessage)) {
    return;
  }
  
  const button = document.getElementById('reset-config-btn');
  const originalHTML = button ? button.innerHTML : '';
  
  try {
    if (button) {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
      button.disabled = true;
      button.innerHTML = `
        <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        ãƒªã‚»ãƒƒãƒˆä¸­...
      `;
    }
    
    logInfo('ğŸ”„ ConfigJsonãƒªã‚»ãƒƒãƒˆé–‹å§‹');
    
    runGasWithUserId('resetConfigJson', 'è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆä¸­...')
      .then(function(result) {
        if (result.success) {
          showMessage('âœ… è¨­å®šã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å¤‰æ›´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'success');
          logInfo('âœ… ConfigJsonãƒªã‚»ãƒƒãƒˆå®Œäº†');
          
          // UIã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          setTimeout(() => {
            runGasWithUserId('getInitialData', 'ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...')
              .then(function(updatedStatus) {
                updateUIWithNewStatus(updatedStatus);
                logInfo('ğŸ”„ ãƒªã‚»ãƒƒãƒˆå¾Œã®UIæ›´æ–°å®Œäº†');
              })
              .catch(function(error) {
                logWarn('âš ï¸ ãƒªã‚»ãƒƒãƒˆå¾Œã®UIæ›´æ–°ã§ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('è¨­å®šã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸãŒã€è¡¨ç¤ºã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'warning');
              });
          }, 1000);
        } else {
          throw new Error(result.message || 'è¨­å®šãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(function(error) {
        logError('âŒ ConfigJsonãƒªã‚»ãƒƒãƒˆã§ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('è¨­å®šãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error), 'error');
      })
      .finally(() => {
        if (button) {
          // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
          button.disabled = false;
          button.innerHTML = originalHTML;
        }
      });
      
  } catch (error) {
    logError('âŒ ConfigJsonãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
    showMessage('è¨­å®šãƒªã‚»ãƒƒãƒˆã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    if (button) {
      button.disabled = false;
      button.innerHTML = originalHTML;
    }
  }
}

// =============================================================================
// QUICKSTART FUNCTIONALITY
// =============================================================================

// QuickStart progress management (Simplified 2-step)
const quickStartSteps = [
  { id: 1, text: 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ', detail: 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è‡ªå‹•ä½œæˆä¸­...' },
  { id: 2, text: 'ãƒœãƒ¼ãƒ‰è¨­å®šã¨è‡ªå‹•å…¬é–‹', detail: 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è¨­å®šã¨è‡ªå‹•å…¬é–‹ã‚’å®Ÿè¡Œä¸­...' }
];

// Custom setup progress management
// Custom Setup step definitions (7 steps for comprehensive setup) - ç‹¬ç«‹ç‰ˆ
const customSetupSteps = [
  { id: 1, text: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®æ¤œè¨¼', detail: 'å…¥åŠ›å†…å®¹ã‚’æ¤œè¨¼ä¸­...', maxTime: 12 },
  { id: 2, text: 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', detail: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ§‹ç¯‰ä¸­...', maxTime: 20 },
  { id: 3, text: 'AIåˆ—åˆ¤å®šã®å®Ÿè¡Œ', detail: 'AIãŒåˆ—ã‚’åˆ†æä¸­...', maxTime: 25 },
  { id: 4, text: 'è¨­å®šã®ä¿å­˜', detail: 'åˆ¤å®šçµæœã‚’ä¿å­˜ä¸­...', maxTime: 8 },
  { id: 5, text: 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢', detail: 'ã‚·ã‚¹ãƒ†ãƒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°ä¸­...', maxTime: 8 },
  { id: 6, text: 'å®Œäº†å‡¦ç†', detail: 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†æº–å‚™ä¸­...', maxTime: 5 }
];

// Show QuickStart progress bar
function showQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.remove('hidden');
    resetProgressSteps();
  }
}

// Hide QuickStart progress bar
function hideQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.add('hidden');
  }
}

// Reset all progress steps to initial state
function resetProgressSteps() {
  quickStartSteps.forEach(step => {
    updateProgressStep(step.id, 'waiting', step.text, 'å¾…æ©Ÿä¸­...');
  });
  updateOverallProgress(0, 'åˆæœŸåŒ–ä¸­...');
}

// Update individual progress step
function updateProgressStep(stepId, status, text, detail) {
  const stepElement = document.getElementById(`progress-step-${stepId}`);
  const dotElement = document.getElementById(`progress-step-${stepId}-dot`);
  const textElement = document.getElementById(`progress-step-${stepId}-text`);
  const detailElement = document.getElementById(`progress-step-${stepId}-detail`);
  
  if (!stepElement || !dotElement || !textElement || !detailElement) return;
  
  // Update text and detail
  textElement.textContent = text;
  detailElement.textContent = detail;
  
  // Update visual state based on status
  switch (status) {
    case 'waiting':
      dotElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      textElement.className = 'text-sm text-gray-300';
      detailElement.className = 'text-xs text-gray-500';
      break;
    case 'active':
      dotElement.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse';
      textElement.className = 'text-sm text-emerald-300 font-medium';
      detailElement.className = 'text-xs text-emerald-400';
      break;
    case 'completed':
      dotElement.className = 'w-2 h-2 rounded-full bg-green-400';
      textElement.className = 'text-sm text-green-300 font-medium';
      detailElement.className = 'text-xs text-green-400';
      break;
    case 'error':
      dotElement.className = 'w-2 h-2 rounded-full bg-red-400';
      textElement.className = 'text-sm text-red-300 font-medium';
      detailElement.className = 'text-xs text-red-400';
      break;
  }
}

// Update overall progress bar
function updateOverallProgress(percentage, statusMessage) {
  const progressBar = document.getElementById('progress-bar');
  const progressPercentage = document.getElementById('progress-percentage');
  const progressStatus = document.getElementById('progress-status');
  
  if (progressBar) {
    progressBar.style.width = `${percentage}%`;
  }
  
  if (progressPercentage) {
    progressPercentage.textContent = `${percentage}%`;
  }
  
  if (progressStatus) {
    progressStatus.textContent = statusMessage;
  }
}

// Simulate QuickStart progress with enhanced backend synchronization
function simulateQuickStartProgress() {
  console.log('ğŸš€ Starting simplified QuickStart progress simulation (2 steps)');
  
  // 2-Step Simplified QuickStart Progress
  updateProgressStep(1, 'active', 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ', 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è‡ªå‹•ä½œæˆä¸­...');
  updateOverallProgress(10, 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...', 2.5);
  
  // æ®µéšçš„ã«é€²æ—ã‚’æ›´æ–°ï¼ˆ2ã‚¹ãƒ†ãƒƒãƒ—æ§‹æˆï¼‰
  setTimeout(() => {
    updateOverallProgress(30, 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆä¸­...', 2);
    
    setTimeout(() => {
      updateOverallProgress(60, 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆå®Œäº†', 1.5);
      updateProgressStep(1, 'completed', 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
      updateProgressStep(2, 'active', 'ãƒœãƒ¼ãƒ‰è¨­å®šã¨è‡ªå‹•å…¬é–‹', 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è¨­å®šã¨è‡ªå‹•å…¬é–‹ã‚’å®Ÿè¡Œä¸­...');
      
      setTimeout(() => {
        updateOverallProgress(80, 'ãƒœãƒ¼ãƒ‰è¨­å®šé©ç”¨ä¸­...', 1);
        
        setTimeout(() => {
          updateOverallProgress(95, 'è‡ªå‹•å…¬é–‹æº–å‚™ä¸­...', 0.5);
          
          setTimeout(() => {
            // æœ€çµ‚å®Œäº†çŠ¶æ…‹ã¯ executeQuickStartProcess ã®æˆåŠŸãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§è¨­å®šã•ã‚Œã‚‹
          }, 500);
        }, 800);
      }, 1000);
    }, 1500);
  }, 1000);
  
  // Optional folder creation check (non-blocking - doesn't affect main progress)
  runGasWithUserId('createUserFolder', false)
    .then(function(folderResult) {
    })
    .catch(function(error) {
      console.warn('âš ï¸ QuickStart folder creation check failed, but continuing:', error);
    });
}

// Simulate Custom Form progress (for custom form creation)
function simulateCustomFormProgressWithFolderCheck() {
  // Step 1: Real folder creation/check
  updateProgressStep(1, 'active', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’æº–å‚™ä¸­...');
  updateOverallProgress(5, 'ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
  
  // Actually call the folder creation API to sync with real backend progress
  runGasWithUserId('createUserFolder', 'ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªãƒ»ä½œæˆä¸­...')
    .then(function(folderResult) {
      updateProgressStep(1, 'completed', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
      updateProgressStep(2, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã§ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...');
      updateOverallProgress(25, 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
      
      // Step 2: Custom form/spreadsheet creation
      setTimeout(() => {
        updateProgressStep(2, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
        updateProgressStep(3, 'active', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨ä¸­...');
        updateOverallProgress(50, 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’é©ç”¨ã—ã¦ã„ã¾ã™...');
        
        // Step 3: Custom configuration
        setTimeout(() => {
          updateProgressStep(3, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'âœ… ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ');
          updateProgressStep(4, 'active', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æœ€é©åŒ–ä¸­...');
          updateOverallProgress(75, 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™...');
          
          // Step 4: Sheet optimization
          setTimeout(() => {
            updateProgressStep(4, 'completed', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'âœ… ã‚·ãƒ¼ãƒˆæ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ');
            updateProgressStep(5, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'ãƒ•ã‚©ãƒ¼ãƒ æº–å‚™ã‚’å®Œäº†ä¸­...');
            updateOverallProgress(90, 'æœ€çµ‚æº–å‚™ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
            
            // Step 5: Final preparation
            setTimeout(() => {
              updateProgressStep(5, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ');
              updateProgressStep(6, 'active', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
              updateOverallProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
              
              setTimeout(() => {
                updateProgressStep(6, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
              }, 500);
            }, 1000);
          }, 1500);
        }, 1000);
      }, 2000);
    })
    .catch(function(error) {
      console.warn('âš ï¸ Custom form folder creation failed, continuing with fallback:', error);
      updateProgressStep(1, 'error', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'âš ï¸ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒå‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™');
      showMessage('ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆã«è­¦å‘ŠãŒã‚ã‚Šã¾ã—ãŸãŒã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚’ç¶šè¡Œã—ã¾ã™ã€‚', 'warning');
      
      // Continue with fallback timing even if folder creation fails
      setTimeout(() => {
        updateProgressStep(2, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã§ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...');
        updateOverallProgress(25, 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
        
        setTimeout(() => {
          updateProgressStep(2, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
          updateProgressStep(3, 'active', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨ä¸­...');
          updateOverallProgress(50, 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’é©ç”¨ã—ã¦ã„ã¾ã™...');
          
          setTimeout(() => {
            updateProgressStep(3, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'âœ… ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ');
            updateProgressStep(4, 'active', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æœ€é©åŒ–ä¸­...');
            updateOverallProgress(75, 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™...');
            
            setTimeout(() => {
              updateProgressStep(4, 'completed', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'âœ… ã‚·ãƒ¼ãƒˆæ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ');
              updateProgressStep(5, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'ãƒ•ã‚©ãƒ¼ãƒ æº–å‚™ã‚’å®Œäº†ä¸­...');
              updateOverallProgress(90, 'æœ€çµ‚æº–å‚™ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
              
              setTimeout(() => {
                updateProgressStep(5, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ');
                updateProgressStep(6, 'active', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
                updateOverallProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                
                setTimeout(() => {
                  updateProgressStep(6, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
                }, 500);
              }, 1000);
            }, 1500);
          }, 1000);
        }, 2000);
      }, 1000);
    });
}

// =============================================================================
// CUSTOM SETUP FUNCTIONALITY - Unified Automation
// =============================================================================

// Show Custom Setup progress bar (ç‹¬ç«‹ç‰ˆ)
function showCustomSetupProgress() {
  const progressContainer = document.getElementById('customsetup-progress'); // ç‹¬ç«‹ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨
  if (progressContainer) {
    progressContainer.classList.remove('hidden');
    resetCustomSetupProgressSteps();
  }
}

// Hide Custom Setup progress bar (ç‹¬ç«‹ç‰ˆ)
function hideCustomSetupProgress() {
  const progressContainer = document.getElementById('customsetup-progress'); // ç‹¬ç«‹ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨
  if (progressContainer) {
    progressContainer.classList.add('hidden');
  }
}

// Reset Custom Setup progress steps (ç‹¬ç«‹ç‰ˆ)
function resetCustomSetupProgressSteps() {
  customSetupSteps.forEach(step => {
    updateCustomProgressStep(step.id, 'waiting', step.text, 'å¾…æ©Ÿä¸­...');
  });
  updateCustomOverallProgress(0, 'åˆæœŸåŒ–ä¸­...', calculateTotalEstimatedTime());
}

// CustomSetupå°‚ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°é–¢æ•°
function updateCustomProgressStep(stepId, status, text, detail) {
  const stepElement = document.getElementById(`custom-progress-step-${stepId}`);
  const dotElement = document.getElementById(`custom-progress-step-${stepId}-dot`);
  const textElement = document.getElementById(`custom-progress-step-${stepId}-text`);
  const detailElement = document.getElementById(`custom-progress-step-${stepId}-detail`);
  const timeElement = document.getElementById(`custom-progress-step-${stepId}-time`);
  
  if (!stepElement || !dotElement || !textElement || !detailElement) return;
  
  // Update text and detail
  textElement.textContent = text;
  detailElement.textContent = detail;
  
  // Update visual state based on status
  switch (status) {
    case 'waiting':
      dotElement.className = 'w-3 h-3 rounded-full bg-gray-500 transition-all duration-300';
      textElement.className = 'text-sm font-medium text-gray-300';
      detailElement.className = 'text-xs text-gray-500 mt-1';
      if (timeElement) timeElement.classList.add('opacity-0');
      break;
    case 'active':
      dotElement.className = 'w-3 h-3 rounded-full bg-purple-400 animate-pulse transition-all duration-300';
      textElement.className = 'text-sm font-medium text-purple-300';
      detailElement.className = 'text-xs text-purple-400 mt-1';
      if (timeElement) timeElement.classList.remove('opacity-0');
      break;
    case 'completed':
      dotElement.className = 'w-3 h-3 rounded-full bg-green-400 transition-all duration-300';
      textElement.className = 'text-sm font-medium text-green-300';
      detailElement.className = 'text-xs text-green-400 mt-1';
      if (timeElement) timeElement.classList.add('opacity-0');
      break;
    case 'error':
      dotElement.className = 'w-3 h-3 rounded-full bg-red-400 transition-all duration-300';
      textElement.className = 'text-sm font-medium text-red-300';
      detailElement.className = 'text-xs text-red-400 mt-1';
      if (timeElement) timeElement.classList.add('opacity-0');
      break;
  }
}

// CustomSetupå°‚ç”¨ã®å…¨ä½“ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°é–¢æ•°
function updateCustomOverallProgress(percentage, statusMessage, estimatedTimeRemaining = null) {
  const progressBar = document.getElementById('custom-progress-bar');
  const progressPercentage = document.getElementById('custom-progress-percentage');
  const progressStatus = document.getElementById('custom-progress-status');
  const progressEta = document.getElementById('custom-progress-eta');
  
  if (progressBar) {
    progressBar.style.width = `${Math.min(percentage, 100)}%`;
  }
  
  if (progressPercentage) {
    progressPercentage.textContent = `${Math.round(percentage)}%`;
  }
  
  if (progressStatus) {
    progressStatus.textContent = statusMessage;
  }
  
  if (progressEta && estimatedTimeRemaining !== null) {
    const minutes = Math.ceil(estimatedTimeRemaining / 60);
    progressEta.textContent = `æ¨å®šæ®‹ã‚Šæ™‚é–“: ${minutes}åˆ†`;
  }
}

// æ¨å®šæ®‹ã‚Šæ™‚é–“ã‚’è¨ˆç®—
function calculateTotalEstimatedTime() {
  return customSetupSteps.reduce((total, step) => total + (step.maxTime || SYSTEM_CONSTANTS.CUSTOM_SETUP.STEP_TIMES.CONFIG_SAVE), 0);
}

// CustomSetupå°‚ç”¨ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
function setupCustomSetupCancelHandler() {
  const cancelBtn = document.getElementById('customsetup-cancel-btn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function() {
      if (confirm(SYSTEM_CONSTANTS.CUSTOM_SETUP.CANCEL_CONFIRMATION_MESSAGE)) {
        hideCustomSetupProgress();
        showMessage('âš ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸ', 'warning');
        // TODO: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ã®ä¸­æ–­ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
      }
    });
  }
}

// Simulate Custom Setup progress with real backend synchronization (ç‹¬ç«‹ç‰ˆ)
async function simulateCustomSetupProgress() {
  console.log('ğŸ¨ Starting enhanced Custom Setup progress simulation (ç‹¬ç«‹ç‰ˆ TimingManager)');
  
  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setupCustomSetupCancelHandler();
  
  let currentStep = 0;
  let startTime = Date.now();
  
  for (const step of customSetupSteps) {
    currentStep++;
    
    // ã‚¹ãƒ†ãƒƒãƒ—é–‹å§‹
    updateCustomProgressStep(step.id, 'active', step.text, step.detail);
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¨ˆç®—ï¼ˆå„ã‚¹ãƒ†ãƒƒãƒ—ã¯å…¨ä½“ã®1/7ï¼‰
    const baseProgress = ((currentStep - 1) / customSetupSteps.length) * 100;
    const nextProgress = (currentStep / customSetupSteps.length) * 100;
    
    // æ®µéšçš„ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°ï¼ˆæ”¹å–„ç‰ˆï¼‰
    const stepDuration = (step.maxTime || SYSTEM_CONSTANTS.CUSTOM_SETUP.STEP_TIMES.CONFIG_SAVE) * 1000; // ç§’ã‚’ãƒŸãƒªç§’ã«å¤‰æ›
    const updateInterval = Math.min(stepDuration / 15, SYSTEM_CONSTANTS.CUSTOM_SETUP.PROGRESS_UPDATE_INTERVAL); // ã‚ˆã‚Šé »ç¹ãªæ›´æ–°ï¼ˆ15åˆ†å‰²ï¼‰
    
    let elapsed = 0;
    let lastProgressUpdate = 0;
    
    while (elapsed < stepDuration) {
      await TimingManager.delay(updateInterval);
      elapsed += updateInterval;
      
      // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—å†…ã§ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ï¼ˆã‚¹ãƒ ãƒ¼ã‚ºãªã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
      const rawStepProgress = elapsed / stepDuration;
      const stepProgress = Math.min(rawStepProgress * rawStepProgress * (3 - 2 * rawStepProgress), 1); // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ãƒ†ãƒƒãƒ—é–¢æ•°
      const currentProgress = baseProgress + (nextProgress - baseProgress) * stepProgress;
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãŒå®Ÿéš›ã«å¤‰åŒ–ã—ãŸæ™‚ã®ã¿æ›´æ–°ï¼ˆç„¡é§„ãªæ›´æ–°ã‚’é˜²ãï¼‰
      if (Math.abs(currentProgress - lastProgressUpdate) >= 0.5) {
        // æ®‹ã‚Šæ™‚é–“è¨ˆç®—ï¼ˆæ”¹å–„ç‰ˆï¼‰
        const totalElapsed = (Date.now() - startTime) / 1000;
        const totalEstimated = calculateTotalEstimatedTime();
        const progressRatio = currentProgress / 100;
        const estimatedTotalTime = progressRatio > 0.1 ? totalElapsed / progressRatio : totalEstimated;
        const remainingTime = Math.max(estimatedTotalTime - totalElapsed, 0);
        
        // è©³ç´°ãªã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã‚’è¿½åŠ 
        const detailWithProgress = `${step.detail} (${Math.round(stepProgress * 100)}%)`;
        updateCustomOverallProgress(currentProgress, detailWithProgress, remainingTime);
        lastProgressUpdate = currentProgress;
      }
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†
    updateCustomProgressStep(step.id, 'completed', step.text, `âœ… ${step.text}å®Œäº†`);
    updateCustomOverallProgress(nextProgress, `${step.text}å®Œäº†`);
    
    // çŸ­ã„å®Œäº†è¡¨ç¤ºå¾…æ©Ÿ
    await TimingManager.delay(SYSTEM_CONSTANTS.UI.ANIMATION_DURATION);
  }
  
}

/**
 * ç°¡ç´ åŒ–ã•ã‚ŒãŸçŠ¶æ…‹æ›´æ–°é–¢æ•°
 * è¤‡é›‘ãªçµ±åˆå‡¦ç†ã‚’é¿ã‘ã€æœ€å°é™ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã¨ç›´æ¥çš„ãªloadStatuså‘¼ã³å‡ºã—
 */
async function simpleStatusRefresh() {
  
  try {
    // æœ€å°é™ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆã‚¨ãƒ©ãƒ¼è€æ€§ï¼‰
    if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
      window.unifiedCache.clear();
    }
    
    // ç›´æ¥çš„ãªloadStatuså‘¼ã³å‡ºã—
    const status = await loadStatus(true);
    return status;
    
  } catch (error) {
    console.warn('âš ï¸ ç°¡ç´ åŒ–çŠ¶æ…‹åŒæœŸã§ã‚¨ãƒ©ãƒ¼:', error);
    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚loadStatusã‚’è©¦è¡Œ
    try {
      return await loadStatus(true);
    } catch (fallbackError) {
      console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯loadStatusã‚‚å¤±æ•—:', fallbackError);
      throw fallbackError;
    }
  }
}

/**
 * ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ãƒãƒ¼ãƒªãƒ³ã‚°é–¢æ•°
 * ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿæ™‚ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ã®å®Œäº†ã‚’ç¢ºèª
 */
async function startBackendCompletionPolling() {
  const maxAttempts = 20; // æœ€å¤§2åˆ†é–“ï¼ˆ6ç§’Ã—20å›ï¼‰
  
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      
      // 6ç§’å¾…æ©Ÿ
      await new Promise(resolve => setTimeout(resolve, 6000));
      
      // çŠ¶æ…‹ç¢ºèª
      const status = await simpleStatusRefresh();
      
      // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ã®ç¢ºèª
      if (status && (status.setupStep >= 3 || (status.systemStatus && status.systemStatus.setupStatus === 'completed'))) {
        
        // æˆåŠŸå‡¦ç†
        updateProgressStep(6, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        showMessage('âœ… ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸï¼AIåˆ—åˆ¤å®šã‚’é–‹å§‹ã—ã¾ã™ã€‚', 'success');
        
        // UIæ›´æ–°
        updateUIAfterCustomSetup(status);
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹éè¡¨ç¤º
        setTimeout(() => {
          hideCustomSetupProgress();
        }, 3000);
        
        return;
      }
      
      // é€²è¡ŒçŠ¶æ³è¡¨ç¤ºæ›´æ–°
      updateProgressStep(6, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¶™ç¶šä¸­', `â³ å‡¦ç†ç¢ºèªä¸­... (${attempt}/${maxAttempts})`);
      
    } catch (error) {
      console.warn(`âš ï¸ ãƒãƒ¼ãƒªãƒ³ã‚°è©¦è¡Œ ${attempt} ã§ã‚¨ãƒ©ãƒ¼:`, error);
    }
  }
  
  // æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ãŸå ´åˆ
  console.warn('âš ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ãƒãƒ¼ãƒªãƒ³ã‚°æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸ');
  updateProgressStep(6, 'error', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ä¸æ˜', 'âš ï¸ å‡¦ç†çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ');
  showMessage('âš ï¸ å‡¦ç†çŠ¶æ…‹ã®ç¢ºèªãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'warning');
  
  setTimeout(() => {
    hideCustomSetupProgress();
  }, 5000);
}

/**
 * ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æˆåŠŸå¾Œã®UIæ›´æ–°
 */
function updateUIAfterCustomSetup(status) {
  console.log('ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æˆåŠŸå¾Œã®UIæ›´æ–°');
  
  try {
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆè¨­å®š
    if (status.activeSheetName) {
      const select = document.getElementById('sheet-select');
      if (select) {
        select.value = status.activeSheetName;
        selectedSheet = status.activeSheetName;
        lastSelectedSheetName = status.activeSheetName;
      }
    }
    
    // ãã®ä»–ã®UIæ›´æ–°é–¢æ•°ãŒã‚ã‚Œã°å‘¼ã³å‡ºã—
    if (typeof updateSheetSelectActiveIndicator === 'function' && status.activeSheetName) {
      updateSheetSelectActiveIndicator(status.activeSheetName);
    }
    
    if (typeof updateUIForSelectedSheet === 'function') {
      updateUIForSelectedSheet();
    }
    
  } catch (error) {
    console.warn('âš ï¸ UIæ›´æ–°ã§ã‚¨ãƒ©ãƒ¼:', error);
  }
}

/**
 * QuickStartç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ãƒãƒ¼ãƒªãƒ³ã‚°é–¢æ•°
 * ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿæ™‚ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ã®å®Œäº†ã‚’ç¢ºèª
 */
async function startQuickStartPolling(quickstartBtn, quickstartText) {
  const maxAttempts = 20; // æœ€å¤§2åˆ†é–“ï¼ˆ6ç§’Ã—20å›ï¼‰
  
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      
      // 6ç§’å¾…æ©Ÿ
      await new Promise(resolve => setTimeout(resolve, 6000));
      
      // çŠ¶æ…‹ç¢ºèª
      const status = await simpleStatusRefresh();
      
      // QuickStartå®Œäº†ã®ç¢ºèªï¼ˆãƒ•ã‚©ãƒ¼ãƒ ä½œæˆçŠ¶æ…‹ã‚„ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ã‚’ç¢ºèªï¼‰
      if (status && (status.setupStep >= 3 || (status.systemStatus && status.systemStatus.setupStatus === 'completed') || status.formUrl)) {
        
        // æˆåŠŸå‡¦ç†
        updateProgressStep(6, 'completed', 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†', 'ğŸ‰ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        showMessage('âœ… ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†å®Œäº†ï¼‰', 'success');
        
        // UIæ›´æ–°
        updateUIAfterQuickStart(status, quickstartBtn, quickstartText);
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹éè¡¨ç¤º
        setTimeout(() => {
          hideQuickStartProgress();
        }, 3000);
        
        return true; // æˆåŠŸã§çµ‚äº†
      }
      
    } catch (error) {
      console.warn(`âš ï¸ QuickStartãƒãƒ¼ãƒªãƒ³ã‚°è©¦è¡Œ ${attempt} ã§ã‚¨ãƒ©ãƒ¼:`, error);
    }
  }
  
  // æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ãŸå ´åˆ
  console.warn('âš ï¸ QuickStartãƒãƒ¼ãƒªãƒ³ã‚°: æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸ');
  updateProgressStep(6, 'error', 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆç¢ºèªå¤±æ•—', 'å‡¦ç†ã®å®Œäº†ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ');
  showMessage('âš ï¸ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®å®Œäº†ç¢ºèªã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚å¾Œã§ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'warning');
  
  // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ
  if (quickstartBtn && quickstartText) {
    quickstartBtn.disabled = false;
    quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
  }
  
  setTimeout(() => {
    hideQuickStartProgress();
  }, 5000);
  
  return false;
}

/**
 * QuickStartæˆåŠŸå¾Œã®UIæ›´æ–°
 */
function updateUIAfterQuickStart(status, quickstartBtn, quickstartText) {
  console.log('ğŸš€ QuickStartæˆåŠŸå¾Œã®UIæ›´æ–°');
  
  try {
    // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
    if (quickstartBtn && quickstartText) {
      quickstartBtn.disabled = false;
      quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†';
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    sessionStorage.setItem('form_just_created', 'true');
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆè¨­å®šï¼ˆã‚ã‚Œã°ï¼‰
    if (status.activeSheetName) {
      const select = document.getElementById('sheet-select');
      if (select) {
        select.value = status.activeSheetName;
        selectedSheet = status.activeSheetName;
        lastSelectedSheetName = status.activeSheetName;
      }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ URLè¡¨ç¤ºã®æ›´æ–°
    if (typeof updateFormUrlDisplay === 'function') {
      updateFormUrlDisplay();
    }
    
    // ãã®ä»–ã®UIæ›´æ–°é–¢æ•°ãŒã‚ã‚Œã°å‘¼ã³å‡ºã—
    if (typeof updateSheetSelectActiveIndicator === 'function' && status.activeSheetName) {
      updateSheetSelectActiveIndicator(status.activeSheetName);
    }
    
    if (typeof updateUIForSelectedSheet === 'function') {
      updateUIForSelectedSheet();
    }
    
    // å…¬é–‹åœæ­¢ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    if (typeof updateUnpublishButton === 'function') {
      updateUnpublishButton(status);
    }
    
  } catch (error) {
    console.warn('âš ï¸ QuickStart UIæ›´æ–°ã§ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// Handle unified custom setup
async function handleCustomSetup(config) {
  const flowId = 'customSetup';
  
  return await flowExecutionManager.executeWithLock(flowId, async () => {
    console.log('ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹ï¼ˆçµ±ä¸€ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ç‰ˆï¼‰');
  
  try {
    // Phase 1: ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºé–‹å§‹
    showCustomSetupProgress();
    
    // 2ã‚¹ãƒ†ãƒƒãƒ—ã®ç°¡ç´ åŒ–ã•ã‚ŒãŸé€²æ—è¡¨ç¤º
    updateCustomOverallProgress(10, 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...', 4);
    updateCustomProgressStep(1, 'active', 'ãƒ‡ãƒ¼ã‚¿æº–å‚™ã¨ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ§‹ç¯‰ä¸­...');
    
    await TimingManager.delay(500); // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    updateCustomOverallProgress(20, 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆä¸­...', 3);
    
    // Phase 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†å®Ÿè¡Œ  
    const result = await runGasWithUserId('customSetup', false, config);
    
    if (!result || result.status !== 'success') {
      throw new Error((result && result.message) || 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ãŒå¤±æ•—ã—ã¾ã—ãŸ');
    }
    
    
    // 2ã‚¹ãƒ†ãƒƒãƒ—é€²æ—ã‚’æ®µéšçš„ã«æ›´æ–°
    updateCustomOverallProgress(60, 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆå®Œäº†', 2);
    updateCustomProgressStep(1, 'completed', 'ãƒ‡ãƒ¼ã‚¿æº–å‚™ã¨ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
    updateCustomProgressStep(2, 'active', 'AIã«ã‚ˆã‚‹åˆ—åˆ†æ', 'AIãŒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—ã‚’åˆ†æã—ã€æœ€é©ãªè¨­å®šã‚’ææ¡ˆä¸­...');
    
    await TimingManager.delay(1000);
    updateCustomOverallProgress(90, 'AIåˆ—åˆ†æå®Œäº†', 1);
    updateCustomProgressStep(2, 'completed', 'AIã«ã‚ˆã‚‹åˆ—åˆ†æ', 'âœ… AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸ');
    
    await TimingManager.delay(500);
    updateCustomOverallProgress(100, 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†');
    console.log('ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆæ‰‹å‹•å…¬é–‹å¾…æ©Ÿï¼‰');
    
    // Phase 3: ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯æ‰‹å‹•å…¬é–‹å‰æã®ãŸã‚ã€è‡ªå‹•å…¬é–‹çŠ¶æ…‹ä¿®æ­£ã¯å®Ÿè¡Œã—ãªã„
    console.log('â„¹ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº† - æ‰‹å‹•å…¬é–‹å¾…æ©Ÿä¸­ï¼ˆè‡ªå‹•å…¬é–‹çŠ¶æ…‹ä¿®æ­£ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰');
    
    // Phase 4: å˜ä¸€ã®æœ€çµ‚åŒæœŸï¼ˆã™ã¹ã¦ã®ä¸¦è¡Œå‡¦ç†ã‚’çµ±åˆï¼‰
    
    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†çµæœã®è©³ç´°ãƒ­ã‚°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    console.log('ğŸ“Š ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çµæœè©³ç´°:', {
      status: result.status,
      formId: result.formId,
      formUrl: result.formUrl,
      editFormUrl: result.editFormUrl,
      spreadsheetId: result.spreadsheetId,
      spreadsheetUrl: result.spreadsheetUrl,
      sheetName: result.sheetName,
      folderId: result.folderId,
      folderUrl: result.folderUrl,
      autoPublished: result.autoPublished,
      success: result.success
    });
    
    // æ—¢å­˜ã®å®‰å®šã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ–¹å¼
    try {
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      
      if (window.sharedUtilities && window.sharedUtilities.cache && typeof window.sharedUtilities.cache.clear === 'function') {
        window.sharedUtilities.cache.clear();
      }
    } catch (cacheError) {
      console.warn('âš ï¸ Cache clear warning during final sync:', cacheError);
    }
    
    // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆç°¡ç´ åŒ–ç‰ˆï¼‰
    const freshStatus = await simpleStatusRefresh();
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¾Œã¯æ‰‹å‹•å…¬é–‹å‰æã®ãŸã‚ã€å…¬é–‹çŠ¶æ…‹ã‚’å¼·åˆ¶çš„ã«éå…¬é–‹ã«è¨­å®š
    if (freshStatus && freshStatus.userInfo && freshStatus.userInfo.configJson) {
      try {
        const config = JSON.parse(freshStatus.userInfo.configJson);
        if (config.appPublished === true) {
          console.log('âš ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¾Œã«è‡ªå‹•å…¬é–‹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ - æ‰‹å‹•å…¬é–‹å‰æã«ä¿®æ­£');
          config.appPublished = false;
          freshStatus.userInfo.configJson = JSON.stringify(config);
          freshStatus.appPublished = false;
          freshStatus.isPublished = false;
          if (freshStatus._normalized) {
            freshStatus._normalized.isPublished = false;
          }
        }
      } catch (configError) {
        console.warn('âš ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¾Œã®è¨­å®šè§£æã‚¨ãƒ©ãƒ¼:', configError);
      }
    }
    
    // Phase 5: UIå®Œå…¨æ›´æ–°ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆè¨­å®šã‚’å«ã‚€ï¼‰
    if (freshStatus && freshStatus.activeSheetName) {
      
      // ã‚·ãƒ¼ãƒˆé¸æŠUIã®ç›´æ¥æ›´æ–°
      const select = document.getElementById('sheet-select');
      if (select) {
        select.value = freshStatus.activeSheetName;
        selectedSheet = freshStatus.activeSheetName;
        lastSelectedSheetName = freshStatus.activeSheetName;
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤ºæ›´æ–°
        if (typeof updateSheetSelectActiveIndicator === 'function') {
          updateSheetSelectActiveIndicator(freshStatus.activeSheetName);
        }
        
        // UIçŠ¶æ…‹åŒæœŸ
        if (typeof updateUIForSelectedSheet === 'function') {
          updateUIForSelectedSheet();
        }
        
      }
    } else {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚·ãƒ¼ãƒˆåã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
      const defaultSheetName = 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1';
      console.log('â„¹ï¸ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒä¸å®Œå…¨ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒ¼ãƒˆåã‚’ä½¿ç”¨:', defaultSheetName);
      
      const select = document.getElementById('sheet-select');
      if (select && select.options.length > 0) {
        // æœ‰åŠ¹ãªå€¤ã‚’æŒã¤æœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¢ã™
        let selectedOption = null;
        for (let i = 0; i < select.options.length; i++) {
          const option = select.options[i];
          if (option.value && option.value.trim() !== '' && option.value !== 'undefined') {
            selectedOption = option;
            break;
          }
        }
        
        // æœ‰åŠ¹ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
        if (!selectedOption) {
          selectedOption = { value: defaultSheetName, text: defaultSheetName };
          console.log('â„¹ï¸ æœ‰åŠ¹ãªã‚·ãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨:', defaultSheetName);
        }
        
        select.value = selectedOption.value;
        selectedSheet = selectedOption.value;
        lastSelectedSheetName = selectedOption.value;
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤ºæ›´æ–°
        if (typeof updateSheetSelectActiveIndicator === 'function') {
          updateSheetSelectActiveIndicator(selectedOption.value);
        }
        
        // UIçŠ¶æ…‹åŒæœŸ
        if (typeof updateUIForSelectedSheet === 'function') {
          updateUIForSelectedSheet();
        }
        
      } else {
        // ã‚·ãƒ¼ãƒˆé¸æŠUIãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
        selectedSheet = defaultSheetName;
        lastSelectedSheetName = defaultSheetName;
        console.log('â„¹ï¸ ã‚·ãƒ¼ãƒˆé¸æŠUIãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š:', defaultSheetName);
      }
    }
    
    // Phase 6: ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã®ç¢ºå®Ÿãªè¡¨ç¤º
    console.log('ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’UIã«åæ˜ ä¸­...');
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æˆåŠŸã‚’ç®¡ç†ãƒ‘ãƒãƒ«ã«åæ˜ 
    if (result.formUrl) {
      console.log('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ URLç¢ºèª:', result.formUrl);
      
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯ã®è¡¨ç¤ºæ›´æ–°ï¼ˆè¤‡æ•°ã®æ–¹æ³•ã§æ›´æ–°ï¼‰
      const formLinkElements = document.querySelectorAll('[data-form-url], .form-url-link, #form-link');
      formLinkElements.forEach(element => {
        element.href = result.formUrl;
        element.textContent = 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
        element.style.display = 'inline-block';
      });
      
      // ãƒ•ã‚©ãƒ¼ãƒ URLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ›´æ–°
      const formUrlInput = document.getElementById('form-url-input');
      if (formUrlInput) {
        formUrlInput.value = result.formUrl;
      }
    }
    
    if (result.spreadsheetUrl) {
      console.log('ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLç¢ºèª:', result.spreadsheetUrl);
      
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒªãƒ³ã‚¯ã®è¡¨ç¤ºæ›´æ–°
      const spreadsheetLinkElements = document.querySelectorAll('[data-spreadsheet-url], .spreadsheet-url-link, #spreadsheet-link');
      spreadsheetLinkElements.forEach(element => {
        element.href = result.spreadsheetUrl;
        element.textContent = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã';
        element.style.display = 'inline-block';
      });
      
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ›´æ–°
      const spreadsheetUrlInput = document.getElementById('spreadsheet-url-input');
      if (spreadsheetUrlInput) {
        spreadsheetUrlInput.value = result.spreadsheetUrl;
      }
    }
    
    if (result.folderUrl) {
      console.log('ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€URLç¢ºèª:', result.folderUrl);
      
      // ãƒ•ã‚©ãƒ«ãƒ€ãƒªãƒ³ã‚¯æ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ
    }
    
    // ç®¡ç†ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹è¡¨ç¤ºã‚’æ›´æ–°
    const statusDisplay = document.querySelector('.status-display, #setup-status');
    if (statusDisplay) {
      statusDisplay.textContent = 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†';
      statusDisplay.className = 'status-display setup-completed';
    }
    
    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒãƒƒã‚¸ã®è¡¨ç¤º
    const setupBadge = document.querySelector('.setup-badge, #setup-completion-badge');
    if (setupBadge) {
      setupBadge.textContent = 'âœ… ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†';
      setupBadge.style.display = 'inline-block';
      setupBadge.className = 'setup-badge completed';
    }
    
    // Phase 7: ç®¡ç†ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹æ›´æ–°ã¨URLè¡¨ç¤º
    console.log('ğŸ›ï¸ ç®¡ç†ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°ä¸­...');
    
    // å›ç­”ãƒœãƒ¼ãƒ‰URLç”Ÿæˆã¨è¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
    if (result.autoPublished) {
      let boardUrl = null;
      
      // 1. freshStatusã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
      if (freshStatus && (freshStatus.viewUrl || (freshStatus.webAppUrl && freshStatus.userId))) {
        boardUrl = freshStatus.viewUrl || `${freshStatus.webAppUrl}?mode=view&userId=${freshStatus.userId}`;
        console.log('ğŸ”— å›ç­”ãƒœãƒ¼ãƒ‰URLç”Ÿæˆ (freshStatus):', boardUrl);
      }
      
      // 2. freshStatusãŒä¸å®Œå…¨ãªå ´åˆã€currentStatusã‹ã‚‰æ§‹ç¯‰
      if (!boardUrl && typeof currentStatus !== 'undefined' && currentStatus) {
        const webAppUrl = currentStatus.webAppUrl || (currentStatus.appUrls && currentStatus.appUrls.webAppUrl);
        const userId = currentStatus.userId || (currentStatus.userInfo && currentStatus.userInfo.userId);
        if (webAppUrl && userId) {
          boardUrl = `${webAppUrl}?mode=view&userId=${userId}`;
          console.log('ğŸ”— å›ç­”ãƒœãƒ¼ãƒ‰URLç”Ÿæˆ (currentStatus):', boardUrl);
        }
      }
      
      // 3. æœ€çµ‚çš„ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå›ºå®šURLãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      if (!boardUrl) {
        // Apps Scriptã®Webã‚¢ãƒ—ãƒªURLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
        const fallbackUrl = 'https://script.google.com/a/naha-okinawa.ed.jp/macros/s/AKfycbyq0CohJCpwb8KYJQrba4pWhvtss5HD2nKDPMuzPBX2EOftIAI2UbtjjyEn4N52TCzX/exec';
        const userId = 'b3b2fba8-6565-4cd3-96e9-c47ea6660a80'; // ãƒ­ã‚°ã‹ã‚‰å–å¾—ã—ãŸuserId
        boardUrl = `${fallbackUrl}?mode=view&userId=${userId}`;
        console.log('ğŸ”— å›ç­”ãƒœãƒ¼ãƒ‰URLç”Ÿæˆ (fallback):', boardUrl);
      }
      
      if (boardUrl) {
        // Board URLè¡¨ç¤ºã®æ›´æ–°
        const boardUrlInput = document.getElementById('board-url');
        if (boardUrlInput) {
          boardUrlInput.value = boardUrl;
        }
        
        // View board linkã®æ›´æ–°
        const viewLink = document.getElementById('view-board-link');
        if (viewLink) {
          viewLink.href = boardUrl;
          viewLink.style.display = 'inline-block';
        }
        
        // Footer guidanceæ›´æ–°
        if (typeof updateFooterAndGuidance === 'function') {
          updateFooterAndGuidance();
        }
      } else {
        console.warn('âš ï¸ å›ç­”ãƒœãƒ¼ãƒ‰URLã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    // Form sectionçŠ¶æ…‹ã®æ›´æ–°
    console.log('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹æ›´æ–°ä¸­...');
    const formSection = document.querySelector('.form-section');
    if (formSection) {
      formSection.classList.add('setup-completed');
    }
    
    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è©³ç´°æƒ…å ±ã‚’å«ã‚ã‚‹
    const successDetails = [
      'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ',
      'âœ… AIåˆ—åˆ¤å®šã‚’è‡ªå‹•å®Ÿè¡Œ',
      'âœ… è¨­å®šã‚’è‡ªå‹•ä¿å­˜ãƒ»é©ç”¨'
    ];
    
    if (result.autoPublished) {
      successDetails.push('âœ… å›ç­”ãƒœãƒ¼ãƒ‰ã‚’è‡ªå‹•å…¬é–‹');
    }
    
    const successMessage = 'ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹ã—ã¦ãã ã•ã„ã€‚';
    showMessage(successMessage, 'success');
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹éè¡¨ç¤º
    setTimeout(() => {
      hideCustomSetupProgress();
      // è¿½åŠ ã®çŠ¶æ…‹åæ˜ ç¢ºèª
    }, 2000);
    
  } catch (error) {
      console.error('âŒ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
      
      // é€²æ—è¡¨ç¤ºã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      updateCustomOverallProgress(0, 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      updateCustomProgressStep(7, 'error', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¤±æ•—', 'âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      
      // è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
      console.error('âŒ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è©³ç´°ã‚¨ãƒ©ãƒ¼:', {
        message: error.message,
        stack: error.stack,
        timestamp: new Date().toISOString()
      });
      
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†
      if (error.message && error.message.includes('timed out')) {
        console.log('â³ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ¤œå‡º - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹');
        updateCustomProgressStep(7, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¶™ç¶šä¸­', 'â³ å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™...');
        
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ã‚’å¾…ã¤ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ï¼ˆå®Ÿè£…ãŒã‚ã‚Œã°ï¼‰
        if (typeof startBackendCompletionPolling === 'function') {
          startBackendCompletionPolling();
        }
        return; // ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ãšã«çµ‚äº†
      }
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
      let userFriendlyMessage;
      if (error.message.includes('Permission denied') || error.message.includes('æ¨©é™')) {
        userFriendlyMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: Googleãƒ‰ãƒ©ã‚¤ãƒ–ã¾ãŸã¯ãƒ•ã‚©ãƒ¼ãƒ ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
      } else if (error.message.includes('Network') || error.message.includes('network')) {
        userFriendlyMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
      } else if (error.message.includes('AppsScript is not defined') || error.message.includes('getWebAppUrl')) {
        userFriendlyMessage = 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„';
      } else if (error.message.includes('ã‚·ãƒ¼ãƒˆåãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“')) {
        userFriendlyMessage = 'ã‚·ãƒ¼ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒ¼ãƒˆåã§ç¶™ç¶šå‡¦ç†ã—ã¾ã™';
        console.log('â„¹ï¸ ã‚·ãƒ¼ãƒˆåã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã—ã¦ç¶™ç¶šå‡¦ç†');
      } else {
        userFriendlyMessage = `ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
      }
      
      // è»½å¾®ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è­¦å‘Šãƒ¬ãƒ™ãƒ«ã§è¡¨ç¤º
      const isMinorError = error.message.includes('AppsScript is not defined') || 
                          error.message.includes('ã‚·ãƒ¼ãƒˆåãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      
      if (isMinorError) {
        showMessage(userFriendlyMessage, 'warning');
        console.log('â„¹ï¸ è»½å¾®ãªã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å‡¦ç†:', error.message);
      } else {
        showMessage(userFriendlyMessage, 'error');
      }
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹éè¡¨ç¤º
      setTimeout(() => {
        hideCustomSetupProgress();
      }, 3000);
      
      throw error;
    }
  });
}

// Handle quick start setup
async function handleQuickStart() {
  const flowId = 'quickStart';
  
  return await flowExecutionManager.executeWithLock(flowId, async () => {
    const quickstartBtn = document.getElementById('quickstart-btn');
    const quickstartText = document.getElementById('quickstart-text');
    
    if (!quickstartBtn || !quickstartText) {
      throw new Error('QuickStart elements not found');
    }

    console.log('ğŸš€ QuickStartå®Ÿè¡Œé–‹å§‹ï¼ˆçµ±ä¸€ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ç‰ˆï¼‰');

  // ç¾åœ¨ã®å…¬é–‹çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦é©åˆ‡ãªå‡¦ç†ã‚’å®Ÿè¡Œ
  const isCurrentlyPublished = currentStatus && 
                               currentStatus._normalized && 
                               currentStatus._normalized.isPublished;
  
  console.log('ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œ: å…¬é–‹çŠ¶æ…‹=' + isCurrentlyPublished);

  if (isCurrentlyPublished) {
    // å…¬é–‹ä¸­ã®å ´åˆ: ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    if (window.sharedModals && typeof window.sharedModals.showQuickStartStopConfirmation === 'function') {
      window.sharedModals.showQuickStartStopConfirmation(
        () => {
          // åœæ­¢ã—ã¦æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
          executeStopAndQuickStart(quickstartBtn, quickstartText);
        },
        () => {
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®å‡¦ç†
          console.log('âŒ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
          resetQuickStartButton(quickstartBtn, quickstartText);
        }
      );
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ¨™æº–confirm
      const confirmMessage = 'ç¾åœ¨å…¬é–‹ä¸­ã®å›ç­”ãƒœãƒ¼ãƒ‰ã‚’åœæ­¢ã—ã¦ã€æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nâ€¢ æ—¢å­˜ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™\nâ€¢ æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ\nâ€¢ é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã‚’å®Ÿè¡Œ\nâ€¢ ä½œæˆå®Œäº†å¾Œã«è‡ªå‹•ã§å†å…¬é–‹';
      
      if (confirm(confirmMessage)) {
        executeStopAndQuickStart(quickstartBtn, quickstartText);
      } else {
        resetQuickStartButton(quickstartBtn, quickstartText);
      }
    }
    } else {
      // éå…¬é–‹ã®å ´åˆ: ç›´æ¥ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œï¼ˆè‡ªå‹•å…¬é–‹ãƒ•ãƒ©ã‚°ä»˜ãï¼‰
      console.log('ğŸ“ ç¾åœ¨éå…¬é–‹ã®ãŸã‚ã€ç›´æ¥ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆè‡ªå‹•å…¬é–‹ï¼‰');
      return await executeQuickStartProcess(quickstartBtn, quickstartText, true); // autoPublish = true
    }
  });
}


// å…¬é–‹åœæ­¢ã¨ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®çµ±åˆå‡¦ç†
function executeStopAndQuickStart(quickstartBtn, quickstartText) {
  console.log('ğŸ›‘ğŸ“‹ å…¬é–‹åœæ­¢â†’ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®çµ±åˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™');
  
  // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
  quickstartBtn.disabled = true;
  quickstartText.textContent = 'å…¬é–‹åœæ­¢ä¸­...';
  
  // 1. ã¾ãšå…¬é–‹åœæ­¢å‡¦ç†ã‚’å®Ÿè¡Œ
  if (typeof unpublishBoard === 'function') {
    showMessage('ç¾åœ¨ã®å›ç­”ãƒœãƒ¼ãƒ‰ã‚’åœæ­¢ã—ã¦ã„ã¾ã™...', 'info');
    
    unpublishBoard()
      .then(function(stopResult) {
        showMessage('âœ… å…¬é–‹åœæ­¢ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™...', 'success');

        // Immediately update footer to reflect unpublished state
        if (typeof updateFooterAndGuidance === 'function') {
          updateFooterAndGuidance(stopResult);
        }
        window.lastStatusCache = stopResult;

        // å…¬é–‹åœæ­¢ãŒå®Œäº†ã—ãŸã‚‰ã€å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’å®Ÿè¡Œ
        setTimeout(() => {
          quickstartText.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...';
          console.log('ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆè‡ªå‹•å…¬é–‹ãƒ¢ãƒ¼ãƒ‰ï¼‰');
          
          // 2. ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œï¼ˆè‡ªå‹•å…¬é–‹ãƒ•ãƒ©ã‚°ä»˜ãï¼‰
          executeQuickStartProcess(quickstartBtn, quickstartText, true);
        }, 1000);
      })
      .catch(function(stopError) {
        console.error('âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ:', stopError);
        showMessage('âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
        resetQuickStartButton(quickstartBtn, quickstartText);
      });
  } else {
    console.error('âŒ unpublishBoard function not found');
    showMessage('âŒ å…¬é–‹åœæ­¢æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    resetQuickStartButton(quickstartBtn, quickstartText);
  }
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
function resetQuickStartButton(quickstartBtn, quickstartText) {
  if (quickstartBtn && quickstartText) {
    quickstartBtn.disabled = false;
    quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
  }
  
  // å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚‚ã‚¯ãƒªã‚¢
  isQuickStartInProgress = false;
  console.log('ğŸ”“ QuickStartãƒªã‚»ãƒƒãƒˆ - å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢');
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œ
function executeQuickStartProcess(quickstartBtn, quickstartText, autoPublish = false) {
  // Update button state
  quickstartBtn.disabled = true;
  quickstartText.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...';
  
  // Show progress bar and start simulation
  showQuickStartProgress();
  simulateQuickStartProgress();
  
  // Show loading message optimized for QuickStart
  // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆä¸­ã¯å°‚ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€æ±ç”¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è¡¨ç¤ºã—ãªã„
  
  runGasWithUserId('quickStartSetup', false)
    .then(function(result) {
      if (result && result.status === 'success') {
        console.log('ğŸ‰ QuickStartãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†å®Œäº†:', result);
        
        // Save QuickStart history entry
        if (result.setupComplete) {
          try {
            createQuickStartHistoryEntry(result);
            console.log('ğŸ“ QuickStartå±¥æ­´ä¿å­˜å®Œäº†');
          } catch (error) {
            console.error('âŒ QuickStartå±¥æ­´ä¿å­˜ã«å¤±æ•—:', error);
          }
        }
        
        // Enhanced completion notification with detailed backend response
        updateOverallProgress(100, result.autoPublished ? 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†ï¼ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼' : 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†ï¼');
        updateProgressStep(2, 'completed', 'ãƒœãƒ¼ãƒ‰è¨­å®šã¨è‡ªå‹•å…¬é–‹', 'ğŸ‰ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        
        // Enhanced message display based on actual backend results
        const publishStatus = result.autoPublished ? 'å…¬é–‹ã•ã‚Œã¾ã—ãŸ' : 'ä½œæˆã•ã‚Œã¾ã—ãŸ';
        let detailMessage;
        
        if (result.autoPublished) {
          detailMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ãŒè‡ªå‹•ä½œæˆãƒ»å…¬é–‹ã•ã‚Œã¾ã—ãŸï¼ã™ãã«åˆ©ç”¨ã§ãã¾ã™ã€‚';
        } else {
          // Check if there's a specific reason for auto-publish failure
          const publishError = result.publishResult && result.publishResult.error;
          const manualInstructions = result.publishResult && result.publishResult.manualPublishInstructions;
          
          detailMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚';
          if (publishError) {
            detailMessage += `è‡ªå‹•å…¬é–‹ã«å¤±æ•—ã—ãŸãŸã‚ï¼ˆ${publishError}ï¼‰ã€`;
          }
          if (manualInstructions) {
            detailMessage += manualInstructions;
          } else {
            detailMessage += 'ç®¡ç†ãƒ‘ãƒãƒ«ã‹ã‚‰æ‰‹å‹•ã§å…¬é–‹ã—ã¦ãã ã•ã„ã€‚';
          }
        }
        
        showMessage(`ğŸ‰ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼${detailMessage}`, 'success');
        
        // Update progress step with auto-publish status
        updateProgressStep(5, 'completed', 'å›ç­”ãƒœãƒ¼ãƒ‰ä½œæˆå®Œäº†', 'ğŸ“ è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹ã—ã¦ãã ã•ã„');
        
        // QuickStartæˆåŠŸå®Œäº† - å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
        isQuickStartInProgress = false;
        console.log('ğŸ”“ QuickStartæˆåŠŸå®Œäº† - å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢');
        
        // Log detailed completion status
        console.log('ğŸ“Š QuickStartå®Œäº†è©³ç´°:', {
          setupComplete: result.setupComplete,
          autoPublished: result.autoPublished,
          publishResult: result.publishResult,
          completedSteps: result.completedSteps,
          completedAt: result.completedAt
        });
        
        // Log auto-publish specific information if available
        if (result.publishResult) {
          console.log('ğŸŒ è‡ªå‹•å…¬é–‹çµæœè©³ç´°:', {
            success: result.publishResult.success,
            published: result.publishResult.published,
            publishedAt: result.publishResult.publishedAt,
            error: result.publishResult.error,
            manualInstructions: result.publishResult.manualPublishInstructions
          });
        }
        
        // Update status after quick start
        if (result.updatedConfig) {
          const newStatus = { ...currentStatus, ...result.updatedConfig, userInfo: { ...currentStatus.userInfo, configJson: JSON.stringify(result.updatedConfig) } };
          updateUIWithNewStatus(newStatus);
        } else {
          // å®‰å®šã—ãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å†èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‰Šé™¤ï¼‰
          simpleStatusRefresh();
        }
        
        // QuickStartãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªï¼ˆåŒ…æ‹¬çš„ãªå®Œäº†çŠ¶æ…‹æ¤œè¨¼ï¼‰
        setTimeout(async () => {
          try {
            const sheetName = result.sheetName || result.publishedSheetName || 'unknown_sheet';
            const completionResult = await verifySetupFlowCompletion('quickstart', sheetName);
            
            if (completionResult.success) {
              console.log('ğŸ‰ QuickStartãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèª: å…¨è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™', completionResult.details);
              
              // æˆåŠŸæ™‚ã¯è¿½åŠ å‡¦ç†ä¸è¦ï¼ˆç°¡ç´ åŒ–ï¼‰
            } else {
              console.warn('âš ï¸ QuickStartãƒ•ãƒ­ãƒ¼: æœªå®Œäº†é …ç›®ãŒã‚ã‚Šã¾ã™', completionResult.issues);
              // ç°¡ç´ åŒ–: è¿½åŠ ã®åŒæœŸå‡¦ç†ã¯å®Ÿè¡Œã—ãªã„
            }
          } catch (verificationError) {
            console.error('âŒ QuickStartãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªã‚¨ãƒ©ãƒ¼:', verificationError);
          }
        }, 2000);
        
        // å…¬é–‹æ™‚ã¯å±¥æ­´ä¿å­˜ã‚’è¡Œã‚ãªã„ï¼ˆå…¬é–‹åœæ­¢æ™‚ã«ä¿å­˜ã™ã‚‹ãŸã‚ï¼‰
        logDebug('QuickStart completed - history will be saved on unpublish');
        
        // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        sessionStorage.setItem('form_just_created', 'true');
        
        // QuickStartå®Œäº†æ™‚ã®çµ±åˆUIæ›´æ–°å‡¦ç†ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        setTimeout(() => {
          console.log('ğŸ”„ QuickStartå®Œäº†: çµ±åˆUIæ›´æ–°ã‚’é–‹å§‹');
          
          // ã™ã¹ã¦ã®UIæ›´æ–°ã‚’1å›ã®å‡¦ç†ã§ã¾ã¨ã‚ã¦å®Ÿè¡Œ
          updateFormUrlDisplay();
          
          // äºˆå®šçµ‚äº†æ™‚é–“ã®è¡¨ç¤ºã‚’æ›´æ–°
          const scheduledEndTimeElement = document.getElementById('scheduled-end-time');
          if (scheduledEndTimeElement && window.lastStatusCache && window.lastStatusCache.config) {
            updateScheduledEndTime(window.lastStatusCache.config, scheduledEndTimeElement);
          }
          
          // å…¬é–‹åœæ­¢ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
          if (typeof updateUnpublishButton === 'function' && window.lastStatusCache) {
            updateUnpublishButton(window.lastStatusCache);
          }
          
          // ãƒ•ãƒƒã‚¿ãƒ¼è¡¨ç¤ºã®æœ€çµ‚æ›´æ–°ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹æ©Ÿèƒ½ã«ã‚ˆã‚Šæœ€é©åŒ–æ¸ˆã¿ï¼‰
          if (window.updateFooterAndGuidance && typeof window.updateFooterAndGuidance === 'function') {
            window.updateFooterAndGuidance(window.lastStatusCache || result);
          }
          
        }, 1200); // å°‘ã—é…å»¶ã‚’å¢—ã‚„ã—ã¦ä»–ã®å‡¦ç†ã®å®Œäº†ã‚’å¾…ã¤
        
        // å›ç­”ãƒœãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ã‚’é€šçŸ¥ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯æ›´æ–°ç”¨ï¼‰
        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'FORM_CREATED',
              formUrl: result.formUrl,
              timestamp: Date.now()
            }, '*');
          }
          
          if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('board-updates');
            channel.postMessage({
              type: 'FORM_CREATED',
              formUrl: result.formUrl,
              timestamp: Date.now()
            });
            channel.close();
          }
        } catch (notifyError) {
          console.warn('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆé€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼:', notifyError);
        }
        
        // Reset button state
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†';
        
        // è‡ªå‹•å…¬é–‹ã®å ´åˆã®ã¿è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        if (autoPublish) {
          console.log('ğŸš€ è‡ªå‹•å…¬é–‹ãŒæœ‰åŠ¹ãªãŸã‚ã€è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™');
          
          setTimeout(() => {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            if (window.unifiedLoadingManager) {
              window.unifiedLoadingManager.setLoading(false);
            }
            
            // URLç”Ÿæˆç¢ºèªã¨ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’å®Ÿè¡Œ
            const enhancedResult = {
              ...result,
              url: (result && result.url) || '',
              autoStopMinutes: (result && result.autoStopMinutes) || 360,
              autoStopTime: (result && result.autoStopTime) || '',
              publicationData: {
                isPublished: (result && result.success) || false,
                hasValidUrl: !!(result && result.url && result.url.length > 0),
                timestamp: new Date().toISOString()
              }
            };
            
            console.log('ğŸ“Š QuickStartå…¬é–‹ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼:', {
              autoPublish: autoPublish,
              hasResult: !!result,
              hasUrl: !!(result && result.url && result.url.length > 0),
              enhancedResult: enhancedResult
            });
            
            // è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆæ¤œè¨¼æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã§ï¼‰
            setTimeout(() => {
              if (window.sharedModals && typeof window.sharedModals.showAutoStopConfirmation === 'function') {
                window.sharedModals.showAutoStopConfirmation(enhancedResult);
              } else {
                console.warn('âš ï¸ è‡ªå‹•åœæ­¢ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              }
            }, 800);
          }, 2000);
        } else {
          console.log('â„¹ï¸ è‡ªå‹•å…¬é–‹ãŒç„¡åŠ¹ã®ãŸã‚ã€è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
        }
        
        // Hide progress bar after delay and reset button
        setTimeout(() => {
          hideQuickStartProgress();
          quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
          quickstartBtn.disabled = false;
        }, 5000);
      } else {
        logWarn('QuickStart returned error result:', result);
        
        // Show error in progress
        updateProgressStep(6, 'error', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', (result && result.message) || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        updateOverallProgress(0, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        let errorMessage = (result && result.message) || 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        if (errorMessage.includes('permission') || errorMessage.includes('æ¨©é™') || 
            errorMessage.includes('Drive') || errorMessage.includes('Sheets')) {
          errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Google Drive ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ãªã„å ´åˆã€æ¨©é™ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
        }
        
        showMessage(errorMessage, 'error');
        
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
        
        // Hide progress bar after delay
        setTimeout(() => {
          hideQuickStartProgress();
        }, 3000);
      }
    })
    .catch(function(error) {
      logError('QuickStart error:', error);
      
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã®ç‰¹åˆ¥å‡¦ç†ï¼ˆCustomSetupãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨ï¼‰
      if (error.toString().includes('timeout') || error.toString().includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
        console.log('â³ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ¤œå‡º - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹');
        updateProgressStep(6, 'active', 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆç¶™ç¶šä¸­', 'â³ å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™...');
        showMessage('â³ å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å‡¦ç†ã‚’ç¶™ç¶šä¸­ã§ã™...', 'info');
        
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ã‚’å¾…ã¤ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        startQuickStartPolling(quickstartBtn, quickstartText);
        return; // ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ãšã«çµ‚äº†
      }
      
      // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯å¾“æ¥é€šã‚Š
      updateProgressStep(6, 'error', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      updateOverallProgress(0, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      
      // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      if (error.toString().includes('permission') || error.toString().includes('æ¨©é™') || 
          error.toString().includes('Drive') || error.toString().includes('Sheets')) {
        errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Google Drive ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ãªã„å ´åˆã€æ¨©é™ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
      }
      
      if (typeof handleError === 'function') {
        handleError(error, 'handleQuickStart', errorMessage);
      } else {
        showMessage(errorMessage, 'error');
      }
      
      quickstartBtn.disabled = false;
      quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
      
      // QuickStartã‚¨ãƒ©ãƒ¼å®Œäº† - å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
      isQuickStartInProgress = false;
      console.log('ğŸ”“ QuickStartã‚¨ãƒ©ãƒ¼å®Œäº† - å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢');
      
      // Hide progress bar after delay
      setTimeout(() => {
        hideQuickStartProgress();
      }, 3000);
    });
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// API initialization is now handled in adminPanel-framework.js.html

// =============================================================================
// MISSING FUNCTIONS RESTORATION
// =============================================================================

// Debounced wrapper for loadStatus to prevent rapid successive calls
function debouncedLoadStatus(bypassCache = false) {
  if (window.AdminPanel && window.AdminPanel.debounce) {
    window.AdminPanel.debounce.loadStatus(() => {
      loadStatus(bypassCache);
    });
  } else {
    // Fallback without debouncing
    loadStatus(bypassCache);
  }
}

// Wrapper for loadStatus to maintain compatibility
function loadSystemStatus(bypassCache = false) {
  // Use debounced version unless bypassCache is true (urgent calls)
  if (bypassCache) {
    loadStatus(bypassCache);
  } else {
    debouncedLoadStatus(bypassCache);
  }
}

// Basic loadUserInfo implementation
function loadUserInfo() {
  logDebug('ğŸ“‹ loadUserInfo called - delegating to debounced loadStatus');
  debouncedLoadStatus();
}

// Update answer count function
function updateAnswerCount() {
  if (!currentStatus || !currentStatus._normalized || !currentStatus._normalized.isPublished) {
    return;
  }
  
  const answerCountElement = document.getElementById('answer-count');
  if (answerCountElement && currentStatus.answerCount !== undefined) {
    answerCountElement.textContent = currentStatus.answerCount || '0';
  }
}

// Setup real-time updates
function setupRealtimeUpdates() {
  // Update system status every 30 seconds
  setInterval(loadSystemStatus, 30000);
  
  // Update answer count every 10 seconds when published
  setInterval(() => {
    const publishText = document.getElementById('info-publish-text');
    if (publishText && publishText.textContent === 'å…¬é–‹ä¸­') {
      updateAnswerCount();
    }
  }, 10000);
}

// Initialize when DOM is ready
// åˆæœŸåŒ–ã¯ adminPanel-core.js ã®çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ã§ç®¡ç†ã•ã‚Œã¾ã™

//# sourceURL=adminPanel-api.js.html
</script>
