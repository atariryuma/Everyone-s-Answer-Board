<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; color: #c0caf5; }
    .glass-panel { background: rgba(26,27,38,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    :focus-visible { outline: 3px solid #8be9fd; outline-offset: 2px; border-radius: 4px; }
  </style>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans px-4 pb-4 pt-4">
  <div id="app" class="glass-panel max-w-2xl mx-auto rounded-xl p-6 shadow-lg">
    <h2 class="text-2xl font-bold mb-6 text-yellow-300 text-center">StudyQuest 管理画面</h2>

    <!-- Current Status -->
    <div class="mb-6 glass-panel p-4 rounded-lg">
      <h3 class="font-semibold mb-2">回答ボードの利用状況</h3>
      <p id="status-text" class="text-gray-300 flex justify-center">
        <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
        </svg>
      </p>
      <div id="board-url-section" class="mt-3 hidden">
        <p class="text-sm text-gray-400 mb-2">生徒用URL:</p>
        <div class="flex gap-2">
          <input type="text" id="board-url" readonly 
                 class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded text-sm cursor-pointer hover:bg-gray-600"
                 onclick="this.select()">
          <button onclick="copyBoardUrl()" 
                  class="px-3 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-sm transition-colors">
            コピー
          </button>
          <a id="view-board-link" href="#" target="_blank"
             class="px-3 py-2 bg-green-600 hover:bg-green-700 rounded text-sm transition-colors">
            表示
          </a>
        </div>
        <p class="text-xs text-gray-400 mt-1">このURLは固定です。一度生徒に共有すれば、ずっと使い続けられます。</p>
      </div>
    </div>

    <!-- No Active Sheet Message -->
    <div id="no-sheet-message" class="mb-6 p-4 bg-yellow-900/30 border border-yellow-600/50 rounded-lg hidden">
      <div class="flex items-center gap-2 mb-2">
        <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
        <h3 class="font-semibold text-yellow-400">回答ボードが設定されていません</h3>
      </div>
      <p class="text-sm text-yellow-200">
        スプレッドシートを追加してシートを選択すると、生徒がアクセスできる回答ボードが開始されます。
      </p>
    </div>

    <!-- Spreadsheet URL Input -->
    <div class="mb-6">
      <h3 class="font-semibold mb-3">1. スプレッドシートを追加</h3>
      <div class="space-y-3">
        <div class="flex gap-2">
          <input type="url" id="spreadsheet-url-input" 
                 placeholder="https://docs.google.com/spreadsheets/d/..."
                 class="flex-1 p-2 rounded-lg glass-panel text-white border border-gray-600 focus:ring-2 focus:ring-cyan-400">
          <button type="button" id="add-spreadsheet-btn" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
            追加
          </button>
        </div>
        <p class="text-xs text-gray-400">GoogleスプレッドシートのURLを入力して追加してください</p>
      </div>
    </div>

    <!-- Sheet Selection -->
    <div class="mb-6">
      <h3 class="font-semibold mb-3">2. 表示するシートを選択</h3>
      <select id="sheet-select" class="w-full p-2 rounded-lg glass-panel text-white">
        <option>読み込み中...</option>
      </select>
    </div>

    <!-- Config Setup -->
    <div class="mb-6">
      <h3 class="font-semibold mb-3">3. Config設定</h3>
      <p class="text-sm text-gray-300 mb-2">ボードで使用する列を指定します。シートを選ぶと候補が表示されます。</p>
        <div class="flex flex-col gap-2 rounded-lg glass-panel p-2 hidden" id="config-area">
          <label class="flex flex-col gap-1">
            <span>問題文ヘッダー</span>
            <select id="qHeader" class="w-full p-1 rounded text-gray-900"></select>
          </label>
          <label class="flex flex-col gap-1">
            <span>回答ヘッダー</span>
            <select id="aHeader" class="w-full p-1 rounded text-gray-900"></select>
          </label>
          <label class="flex flex-col gap-1">
            <span>理由ヘッダー</span>
            <select id="rHeader" class="w-full p-1 rounded text-gray-900"></select>
          </label>
          <label class="flex flex-col gap-1">
            <span>名前列ヘッダー</span>
            <select id="nameHeader" class="w-full p-1 rounded text-gray-900"></select>
          </label>
          <label class="flex flex-col gap-1">
            <span>クラス列ヘッダー</span>
            <select id="classHeader" class="w-full p-1 rounded text-gray-900"></select>
          </label>
        <button type="button" id="save-config-btn" class="bg-green-600 hover:bg-green-700 text-white rounded py-1">保存</button>
      </div>
    </div>

    <!-- Display Options -->
    <div class="mb-6">
      <h3 class="font-semibold mb-3">4. 表示オプション</h3>
      <div id="detail-options" class="flex flex-col gap-2 rounded-lg glass-panel p-2">
        <label class="flex items-center p-2 rounded-md cursor-pointer">
          <input type="radio" name="showDetails" value="true" class="mr-2" />
          <div>
            <div class="font-medium">名前・リアクション数を表示</div>
            <div class="text-xs text-gray-400">生徒の名前とリアクション数が表示されます</div>
          </div>
        </label>
        <label class="flex items-center p-2 rounded-md cursor-pointer">
          <input type="radio" name="showDetails" value="false" class="mr-2" />
          <div>
            <div class="font-medium">表示しない</div>
            <div class="text-xs text-gray-400">匿名表示でリアクション数も非表示</div>
          </div>
        </label>
      </div>
    </div>

    <!-- Actions -->
    <div class="mb-6">
      <h3 class="font-semibold mb-3">5. 操作を選択</h3>
      <div class="flex flex-col gap-2">
        <button type="button" id="switch-sheet-btn" disabled
                class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-600 text-white rounded-lg">
          このシートをアクティブにする
        </button>
        <button type="button" id="clear-selection-btn" disabled
                class="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 text-white rounded-lg">
          アクティブシートをクリア
        </button>
      </div>
    </div>

    <!-- Message Area -->
    <div id="message-area" class="mt-4 text-center text-sm h-5"></div>
  </div>

  <script>
    const userId = '<?= userId ?>';
    
    const elements = {
      statusText: document.getElementById('status-text'),
      sheetSelect: document.getElementById('sheet-select'),
      switchSheetBtn: document.getElementById('switch-sheet-btn'),
      clearSelectionBtn: document.getElementById('clear-selection-btn'),
      configArea: document.getElementById('config-area'),
      qHeader: document.getElementById('qHeader'),
      aHeader: document.getElementById('aHeader'),
      rHeader: document.getElementById('rHeader'),
      nameHeader: document.getElementById('nameHeader'),
      classHeader: document.getElementById('classHeader'),
      saveConfigBtn: document.getElementById('save-config-btn'),
      detailOptions: document.getElementById('detail-options'),
      messageArea: document.getElementById('message-area'),
      boardUrlSection: document.getElementById('board-url-section'),
      boardUrl: document.getElementById('board-url'),
      viewBoardLink: document.getElementById('view-board-link'),
      noSheetMessage: document.getElementById('no-sheet-message')
    };

    let selectedSheet = null;
    let currentActiveSheet = null;

    document.addEventListener('DOMContentLoaded', () => {
      loadInitialState();
      elements.switchSheetBtn.addEventListener('click', switchToSelectedSheet);
      elements.clearSelectionBtn.addEventListener('click', clearSheetSelection);
      elements.saveConfigBtn.addEventListener('click', saveConfig);
      document.getElementById('add-spreadsheet-btn').addEventListener('click', addSpreadsheet);
      elements.qHeader.addEventListener('change', () => {
        if (!elements.aHeader.value) elements.aHeader.value = elements.qHeader.value;
      });
      elements.aHeader.addEventListener('change', () => {
        if (!elements.qHeader.value) elements.qHeader.value = elements.aHeader.value;
      });
    });

    function loadInitialState() {
      setLoading(true, "状態を更新中...");
      google.script.run
        .withSuccessHandler(updateUI)
        .withFailureHandler(showError)
        .withUserObject({ userId: userId })
        .getAdminSettings();
    }

    function updateUI(status) {
      currentActiveSheet = status.activeSheetName;
      selectedSheet = status.activeSheetName;
      elements.configArea.classList.toggle('hidden', !selectedSheet);

      if (elements.detailOptions) {
        const radios = elements.detailOptions.querySelectorAll('input[name="showDetails"]');
        radios.forEach(r => { r.checked = r.value === String(status.showDetails); r.onchange = () => updateShowDetails(r.value); });
      }
      
      // 回答ボードの状態表示
      if (status.activeSheetName) {
        const answerCount = status.answerCount || 0;
        const totalReactions = status.totalReactions || 0;
        elements.statusText.innerHTML = `<span class="font-bold text-green-400">利用可能</span> - アクティブシート: <span class="font-bold text-blue-400">${escapeHtml(status.activeSheetName)}</span><br>
        <span class="text-sm text-gray-300">回答数: ${answerCount}件 | 総リアクション数: ${totalReactions}件</span>`;
        // 生徒用URLを表示
        const baseUrl = status.webAppUrl || (window.location.origin + window.location.pathname);
        const boardUrl = `${baseUrl}?userId=${userId}`;
        elements.boardUrl.value = boardUrl;
        elements.viewBoardLink.href = boardUrl;
        elements.boardUrlSection.classList.remove('hidden');
        elements.noSheetMessage.classList.add('hidden');
      } else {
        elements.statusText.innerHTML = '<span class="font-bold text-yellow-400">未設定</span> - シートを選択して利用を開始してください';
        elements.boardUrlSection.classList.add('hidden');
        elements.noSheetMessage.classList.remove('hidden');
      }
      
      elements.sheetSelect.innerHTML = '';
      if (status.allSheets && status.allSheets.length > 0) {
        elements.sheetSelect.innerHTML = '<option value="">-- シートを選択してください --</option>';
        status.allSheets.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          elements.sheetSelect.appendChild(opt);
        });
        elements.sheetSelect.disabled = false;
        if (status.activeSheetName) {
          elements.sheetSelect.value = status.activeSheetName;
        }
      } else {
        elements.sheetSelect.innerHTML = '<option value="">表示できるシートがありません</option>';
        elements.sheetSelect.disabled = true;
      }

      elements.sheetSelect.onchange = () => {
        selectedSheet = elements.sheetSelect.value;
        elements.switchSheetBtn.disabled = !selectedSheet;
        elements.configArea.classList.toggle('hidden', !selectedSheet);
        
        // シート切り替えボタンのテキストを動的に変更
        if (selectedSheet && selectedSheet === currentActiveSheet) {
          elements.switchSheetBtn.textContent = '現在のアクティブシート';
          elements.switchSheetBtn.disabled = true;
        } else if (selectedSheet) {
          elements.switchSheetBtn.textContent = `「${selectedSheet}」をアクティブにする`;
          elements.switchSheetBtn.disabled = false;
        } else {
          elements.switchSheetBtn.textContent = 'このシートをアクティブにする';
          elements.switchSheetBtn.disabled = true;
        }
        
        loadConfigForSelected();
      };

      // 初期状態のボタン設定
      elements.switchSheetBtn.disabled = !selectedSheet || selectedSheet === currentActiveSheet;
      elements.clearSelectionBtn.disabled = !currentActiveSheet;
      
      loadConfigForSelected();
      setLoading(false);
    }

    function addSpreadsheet() {
      const urlInput = document.getElementById('spreadsheet-url-input');
      const url = urlInput.value.trim();
      
      if (!url) {
        showMessage('スプレッドシートURLを入力してください。', 'red');
        return;
      }
      
      if (!url.includes('docs.google.com/spreadsheets')) {
        showMessage('有効なGoogleスプレッドシートのURLを入力してください。', 'red');
        return;
      }
      
      setLoading(true, 'スプレッドシートを追加中...');
      google.script.run
        .withSuccessHandler((result) => {
          showMessage(result.message, 'green');
          urlInput.value = '';
          // スプレッドシート追加後、状態を再読み込み
          loadInitialState();
        })
        .withFailureHandler(showError)
        .addSpreadsheetUrl(url);
    }

    function switchToSelectedSheet() {
      if (!selectedSheet) return;
      setLoading(true, 'シートを切り替え中...');
      google.script.run
        .withSuccessHandler((msg) => {
          showMessage(msg, 'green');
          loadInitialState();
        })
        .withFailureHandler(showError)
        .switchActiveSheet(selectedSheet);
    }

    function clearSheetSelection() {
      if (!confirm('アクティブシートをクリアしますか？生徒は回答ボードにアクセスできなくなります。')) return;
      setLoading(true, 'シート選択をクリア中...');
      google.script.run
        .withSuccessHandler((msg) => {
          showMessage(msg, 'green');
          loadInitialState();
        })
        .withFailureHandler(showError)
        .clearActiveSheet();
    }

    function updateShowDetails(val) {
      setLoading(true, '表示設定を更新中...');
      google.script.run
        .withSuccessHandler((msg) => { showMessage(msg, 'green'); setLoading(false); })
        .withFailureHandler(showError)
        .setShowDetails(val === 'true');
    }

    function loadConfigForSelected() {
      if (!selectedSheet) {
        elements.configArea.classList.add('hidden');
        clearConfigFields();
        return;
      }
      elements.configArea.classList.remove('hidden');
      google.script.run
        .withSuccessHandler((headers) => {
          populateHeaderOptions(headers);
          const guesses = guessHeaders(headers);
          populateConfig(guesses);
          google.script.run
            .withSuccessHandler(cfg => populateConfig(Object.assign({}, guesses, cfg)))
            .withFailureHandler(() => {})
            .getConfig(selectedSheet);
        })
        .withFailureHandler(clearConfigFields)
        .getSheetHeaders(selectedSheet);
    }

    function populateHeaderOptions(headers) {
      const selects = [elements.qHeader, elements.aHeader, elements.rHeader, elements.nameHeader, elements.classHeader];
      selects.forEach(sel => {
        sel.innerHTML = '<option value=""></option>';
        headers.forEach(h => {
          const opt = document.createElement('option');
          opt.value = h;
          opt.textContent = h;
          sel.appendChild(opt);
        });
      });
    }

    function guessHeaders(headers) {
      const find = (keys) => headers.find(h => keys.some(k => h.includes(k))) || '';
      const question = find(['質問', '問題']);
      const answer = find(['回答', '答え']);
      return {
        questionHeader: question,
        answerHeader: answer,
        reasonHeader: find(['理由']),
        nameHeader: find(['名前', '氏名']),
        classHeader: find(['クラス'])
      };
    }

    function populateConfig(cfg) {
      const q = cfg.questionHeader || cfg.answerHeader || '';
      elements.qHeader.value = q;
      elements.aHeader.value = cfg.answerHeader || cfg.questionHeader || '';
      elements.rHeader.value = cfg.reasonHeader || '';
      elements.nameHeader.value = cfg.nameHeader || '';
      elements.classHeader.value = cfg.classHeader || '';
    }

    function clearConfigFields() {
      [elements.qHeader, elements.aHeader, elements.rHeader, elements.nameHeader, elements.classHeader].forEach(sel => {
        sel.innerHTML = '<option value=""></option>';
        sel.value = '';
      });
    }

    function saveConfig() {
      if (!selectedSheet) {
        showMessage('シートを選択してください。', 'red');
        return;
      }
      const qVal = elements.qHeader.value;
      const aVal = elements.aHeader.value || qVal;
      const cfg = {
        questionHeader: qVal || aVal,
        answerHeader: aVal || qVal,
        reasonHeader: elements.rHeader.value,
        nameHeader: elements.nameHeader.value,
        classHeader: elements.classHeader.value
      };
      setLoading(true, '設定を保存中...');
      google.script.run
        .withSuccessHandler((msg) => { showMessage(msg, 'green'); setLoading(false); })
        .withFailureHandler(showError)
        .saveSheetConfig(selectedSheet, cfg);
    }

    function setLoading(isLoading, msg = "") {
      elements.switchSheetBtn.disabled = isLoading;
      elements.clearSelectionBtn.disabled = isLoading;
      if (isLoading) {
          showMessage(msg, 'blue');
      }
    }
    
    function copyBoardUrl() {
      const url = elements.boardUrl.value;
      if (url) {
        navigator.clipboard.writeText(url).then(() => {
          showMessage('URLをコピーしました', 'green');
        }).catch(() => {
          // フォールバック：従来の方法
          elements.boardUrl.select();
          document.execCommand('copy');
          showMessage('URLをコピーしました', 'green');
        });
      }
    }

    function showMessage(msg, color = 'red') {
      const colorClasses = { red: 'text-red-600', green: 'text-green-600', blue: 'text-blue-600' };
      elements.messageArea.className = `mt-4 text-center text-sm h-5 ${colorClasses[color]}`;
      elements.messageArea.textContent = msg;
    }
    
    function showError(error) {
      showMessage(error.message, 'red');
      setLoading(false);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>