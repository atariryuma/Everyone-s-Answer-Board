<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <title>StudyQuest ç®¡ç†ãƒ‘ãƒãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Shared Utilities Include -->
  <?!= include('SharedUtilities') ?>
  <style>
    /* ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹æº–æ‹ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    body { 
      margin: 0; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .admin-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1rem;
      min-height: 100vh;
      padding: 1rem;
    }

    .main-editor {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .info-panel {
      background: #f1f5f9;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    .card h2 {
      margin: 0 0 1rem 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-card {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    .info-card h3 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
      font-weight: 600;
      color: #1e293b;
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .status-header {
      background: white;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
    }

    .system-monitor {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
      color: #64748b;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
    }

    .status-indicator.active {
      background-color: #10b981;
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
    }

    .status-indicator.warning {
      background-color: #f59e0b;
    }

    .status-indicator.error {
      background-color: #ef4444;
    }

    /* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é€²æ— */
    .setup-progress {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 1rem;
      background: #e0e7ff;
      border-radius: 8px;
    }

    .step {
      flex: 1;
      text-align: center;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 500;
      color: #64748b;
      background: #f1f5f9;
    }

    .step.completed {
      background: #dcfce7;
      color: #166534;
    }

    .step.current {
      background: #dbeafe;
      color: #1d4ed8;
      border: 2px solid #3b82f6;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #374151;
    }

    .modern-select, input[type="text"] {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .modern-select:focus, input[type="text"]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
    .toggle-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
    }

    .toggle-switch input {
      display: none;
    }

    .slider {
      width: 44px;
      height: 24px;
      background: #cbd5e0;
      border-radius: 12px;
      position: relative;
      transition: all 0.3s;
    }

    .slider:before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: all 0.3s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .toggle-switch input:checked + .slider {
      background: #3b82f6;
    }

    .toggle-switch input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* ãƒœã‚¿ãƒ³ */
    .btn-primary, .btn-secondary {
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #64748b;
      border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .action-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    /* å³ãƒ‘ãƒãƒ«ã®æƒ…å ±è¡¨ç¤º */
    .config-summary {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .config-item:last-child {
      border-bottom: none;
    }

    .label {
      font-weight: 500;
      color: #374151;
      font-size: 0.875rem;
    }

    .link-btn {
      background: #eff6ff;
      color: #2563eb;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      text-decoration: none;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .link-btn:hover {
      background: #dbeafe;
    }

    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-badge.unpublished {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.published {
      background: #dcfce7;
      color: #166534;
    }

    .status-badge.error {
      background: #fee2e2;
      color: #dc2626;
    }

    /* ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ¡ãƒˆãƒªã‚¯ã‚¹ */
    .metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .metric {
      text-align: center;
      padding: 0.75rem;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    .metric .value {
      display: block;
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
    }

    .metric .unit {
      font-size: 0.75rem;
      color: #64748b;
    }

    /* JSONè¡¨ç¤º */
    .json-viewer {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      padding: 0.75rem;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.75rem;
      color: #374151;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }

    .expandable-section {
      margin-top: 0.5rem;
    }

    .expandable-section summary {
      cursor: pointer;
      font-weight: 500;
      color: #3b82f6;
      padding: 0.5rem 0;
    }

    /* åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤º */
    .auto-detected-columns {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .column-match {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 6px;
    }

    .column-type {
      font-weight: 500;
      color: #166534;
    }

    .detected-column {
      background: #dcfce7;
      color: #166534;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .confidence {
      font-size: 0.75rem;
      color: #16a34a;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @media (max-width: 768px) {
      .admin-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
      }
      
      .status-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .setup-progress {
        flex-direction: column;
      }
      
      .metrics {
        grid-template-columns: 1fr;
      }
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ */
    .loading {
      opacity: 0.6;
      pointer-events: none;
      position: relative;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      transform: translate(-50%, -50%);
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .success-pulse {
      animation: successPulse 0.6s ease-out;
    }

    .error-shake {
      animation: errorShake 0.5s ease-out;
    }

    @keyframes successPulse {
      0% { background-color: #dcfce7; }
      50% { background-color: #bbf7d0; }
      100% { background-color: #dcfce7; }
    }

    @keyframes errorShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- å·¦ãƒ‘ãƒãƒ«: ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ -->
    <div class="main-editor">
      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <header class="status-header">
        <h1>StudyQuest ç®¡ç†ãƒ‘ãƒãƒ«</h1>
        <div class="system-monitor">
          <span><span class="status-indicator active"></span>æ¥ç¶šæ­£å¸¸</span>
          <span id="last-update">æœ€çµ‚åŒæœŸ: --:--</span>
          <span id="health-check">DBæ­£å¸¸</span>
        </div>
      </header>

      <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é€²æ— -->
      <div class="setup-progress">
        <div class="step completed">1. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</div>
        <div class="step current">2. åˆ—è¨­å®š</div>
        <div class="step">3. å…¬é–‹</div>
      </div>

      <!-- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠã‚«ãƒ¼ãƒ‰ -->
      <section class="card">
        <h2>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ</h2>
        <div class="form-group">
          <label for="spreadsheet-select">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ:</label>
          <select id="spreadsheet-select" class="modern-select">
            <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="sheet-select">ã‚·ãƒ¼ãƒˆ:</label>
          <select id="sheet-select" class="modern-select">
            <option value="">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <div class="action-buttons">
          <button id="refresh-data" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
          <button id="connect-source" class="btn-primary">æ¥ç¶š</button>
        </div>
      </section>

      <!-- åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ -->
      <section class="card">
        <h2>ğŸ“‹ åˆ—è¨­å®š</h2>
        <div class="auto-detected-columns">
          <div class="column-match">
            <span class="column-type">è³ªå•</span>
            <span class="detected-column">Aåˆ—</span>
            <span class="confidence">95%ç¢ºä¿¡åº¦</span>
          </div>
          <div class="column-match">
            <span class="column-type">å›ç­”è€…</span>
            <span class="detected-column">Båˆ—</span>
            <span class="confidence">88%ç¢ºä¿¡åº¦</span>
          </div>
          <div class="column-match">
            <span class="column-type">ç†ç”±</span>
            <span class="detected-column">Cåˆ—</span>
            <span class="confidence">92%ç¢ºä¿¡åº¦</span>
          </div>
        </div>
        <div class="action-buttons">
          <button id="verify-mapping" class="btn-primary">è¨­å®šã‚’ç¢ºèª</button>
        </div>
      </section>

      <!-- è¡¨ç¤ºè¨­å®šã‚«ãƒ¼ãƒ‰ -->
      <section class="card">
        <h2>âš™ï¸ è¡¨ç¤ºè¨­å®š</h2>
        <div class="toggle-group">
          <label class="toggle-switch">
            <input type="checkbox" id="show-names" checked>
            <span class="slider"></span>
            å›ç­”è€…åã‚’è¡¨ç¤º
          </label>
          <label class="toggle-switch">
            <input type="checkbox" id="show-reactions" checked>
            <span class="slider"></span>
            ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’è¡¨ç¤º
          </label>
        </div>
      </section>

      <!-- å…¬é–‹ã‚«ãƒ¼ãƒ‰ -->
      <section class="card">
        <h2>ğŸš€ å…¬é–‹è¨­å®š</h2>
        <div class="form-group">
          <div class="config-item">
            <span class="label">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
            <span class="status-badge unpublished">æœªå…¬é–‹</span>
          </div>
        </div>
        <div class="form-group">
          <label for="app-name">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å:</label>
          <input type="text" id="app-name" placeholder="ä¾‹: ã‚¯ãƒ©ã‚¹è³ªå•ãƒœãƒ¼ãƒ‰">
        </div>
        <div class="action-buttons">
          <button id="save-draft" class="btn-secondary">ä¸‹æ›¸ãä¿å­˜</button>
          <button id="publish-now" class="btn-primary">ä»Šã™ãå…¬é–‹</button>
        </div>
      </section>
    </div>

    <!-- å³ãƒ‘ãƒãƒ«: æƒ…å ±è¡¨ç¤º -->
    <div class="info-panel">
      <!-- ç¾åœ¨ã®è¨­å®šã‚µãƒãƒªãƒ¼ -->
      <section class="info-card">
        <h3>ğŸ“‹ ç¾åœ¨ã®è¨­å®š</h3>
        <div class="config-summary">
          <div class="config-item">
            <span class="label">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</span>
            <a href="#" class="link-btn" id="open-sheet">ã‚·ãƒ¼ãƒˆã‚’é–‹ã</a>
          </div>
          <div class="config-item">
            <span class="label">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:</span>
            <span class="status-badge unpublished">è¨­å®šä¸­</span>
          </div>
          <div class="config-item">
            <span class="label">æœ€çµ‚æ›´æ–°:</span>
            <span style="font-size: 0.75rem; color: #64748b;">--:--</span>
          </div>
        </div>
      </section>

      <!-- ã‚·ã‚¹ãƒ†ãƒ ç›£è¦– -->
      <section class="info-card">
        <h3>ğŸ” ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
        <div class="metrics">
          <div class="metric">
            <span class="value" id="active-users">--</span>
            <span class="unit">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
          </div>
          <div class="metric">
            <span class="value" id="active-boards">--</span>
            <span class="unit">å…¬é–‹ä¸­ãƒœãƒ¼ãƒ‰</span>
          </div>
        </div>
      </section>

      <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´° -->
      <section class="info-card">
        <h3>ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°</h3>
        <div class="db-details">
          <div class="config-item">
            <span class="label">DBæ¥ç¶š:</span>
            <span class="status-badge published">æ­£å¸¸</span>
          </div>
          <details class="expandable-section">
            <summary>è¨­å®šè©³ç´° (JSON)</summary>
            <div class="json-viewer" id="config-json">
{
  "setupStatus": "pending",
  "spreadsheetId": null,
  "sheetName": null,
  "formCreated": false,
  "appPublished": false,
  "lastUpdated": null
}
            </div>
          </details>
        </div>
      </section>

      <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="info-card">
        <h3>âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button class="link-btn" style="width: 100%; text-align: center;" onclick="refreshSystemStatus()">
            ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹æ›´æ–°
          </button>
          <button class="link-btn" style="width: 100%; text-align: center;" onclick="exportConfig()">
            è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          </button>
          <button id="app-setup-btn" class="link-btn" style="width: 100%; text-align: center; display: none;" onclick="goToAppSetup()">
            âš™ï¸ ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢
          </button>
        </div>
      </section>
    </div>
  </div>

  <!-- SharedUtilities.html ã¯ä¸Šéƒ¨ã§æ—¢ã«ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰æ¸ˆã¿ -->

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç†
    let systemState = {
      connected: false,
      lastUpdate: null,
      config: null,
      loading: false
    };

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('AdminPanelåˆæœŸåŒ–é–‹å§‹');
      initializePanel();
      checkSystemAdminAccess();
      
      // å®šæœŸçš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      setInterval(updateSystemStatus, 30000); // 30ç§’é–“éš”
    });

    // ãƒ‘ãƒãƒ«åˆæœŸåŒ–
    function initializePanel() {
      try {
        setLoading(true);
        loadSpreadsheetList();
        loadSystemMetrics();
        updateLastUpdateTime();
        setLoading(false);
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showError('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        setLoading(false);
      }
    }

    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
    function loadSpreadsheetList() {
      const select = document.getElementById('spreadsheet-select');
      select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';
      
      google.script.run
        .withSuccessHandler(function(spreadsheets) {
          select.innerHTML = '<option value="">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';
          spreadsheets.forEach(sheet => {
            const option = document.createElement('option');
            option.value = sheet.id;
            option.textContent = sheet.name;
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
          showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .getSpreadsheetList();
    }

    // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹èª­ã¿è¾¼ã¿
    function loadSystemMetrics() {
      google.script.run
        .withSuccessHandler(function(metrics) {
          document.getElementById('active-users').textContent = metrics.activeUsers || '--';
          document.getElementById('active-boards').textContent = metrics.activeBoards || '--';
        })
        .withFailureHandler(function(error) {
          console.error('ãƒ¡ãƒˆãƒªã‚¯ã‚¹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getSystemMetrics();
    }

    // æœ€çµ‚æ›´æ–°æ™‚åˆ»æ›´æ–°
    function updateLastUpdateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('ja-JP', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      document.getElementById('last-update').textContent = `æœ€çµ‚åŒæœŸ: ${timeString}`;
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è¨­å®š
    function setLoading(loading) {
      systemState.loading = loading;
      const container = document.querySelector('.admin-container');
      if (loading) {
        container.classList.add('loading');
      } else {
        container.classList.remove('loading');
      }
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º (SharedUtilitiesã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨)
    function showError(message) {
      if (window.notifications && window.notifications.error) {
        window.notifications.error(message);
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        alert('ã‚¨ãƒ©ãƒ¼: ' + message);
      }
    }

    // æˆåŠŸè¡¨ç¤º (SharedUtilitiesã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨)
    function showSuccess(message) {
      if (window.notifications && window.notifications.success) {
        window.notifications.success(message);
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        alert('æˆåŠŸ: ' + message);
      }
    }

    // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹æ›´æ–°
    function updateSystemStatus() {
      updateLastUpdateTime();
      loadSystemMetrics();
    }

    // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹æ›´æ–°ï¼ˆãƒœã‚¿ãƒ³ç”¨ï¼‰
    function refreshSystemStatus() {
      setLoading(true);
      updateSystemStatus();
      setTimeout(() => {
        setLoading(false);
        showSuccess('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      }, 1000);
    }

    // è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportConfig() {
      google.script.run
        .withSuccessHandler(function(config) {
          const dataStr = JSON.stringify(config, null, 2);
          const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
          const exportFileDefaultName = 'studyquest-config.json';
          
          const linkElement = document.createElement('a');
          linkElement.setAttribute('href', dataUri);
          linkElement.setAttribute('download', exportFileDefaultName);
          linkElement.click();
          
          showSuccess('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        })
        .withFailureHandler(function(error) {
          console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
          showError('è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .getCurrentConfig();
    }

    // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
    function checkSystemAdminAccess() {
      google.script.run
        .withSuccessHandler(function(isAdmin) {
          if (isAdmin) {
            console.log('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã—ãŸ');
            document.getElementById('app-setup-btn').style.display = 'block';
          } else {
            console.log('ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã—ãŸ');
            document.getElementById('app-setup-btn').style.display = 'none';
          }
        })
        .withFailureHandler(function(error) {
          console.warn('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
          document.getElementById('app-setup-btn').style.display = 'none';
        })
        .checkIsSystemAdmin();
    }

    // ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    function goToAppSetup() {
      setLoading(true);
      google.script.run
        .withSuccessHandler(function(webAppUrl) {
          const setupUrl = webAppUrl + '?mode=appSetup';
          window.open(setupUrl, '_top');
        })
        .withFailureHandler(function(error) {
          console.error('ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®é·ç§»ã‚¨ãƒ©ãƒ¼:', error);
          showError('ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
          setLoading(false);
        })
        .getWebAppUrlCached();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    document.addEventListener('DOMContentLoaded', function() {
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé¸æŠæ™‚
      document.getElementById('spreadsheet-select').addEventListener('change', function() {
        const spreadsheetId = this.value;
        if (spreadsheetId) {
          loadSheetList(spreadsheetId);
        }
      });

      // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒœã‚¿ãƒ³
      document.getElementById('refresh-data').addEventListener('click', function() {
        loadSpreadsheetList();
      });

      // æ¥ç¶šãƒœã‚¿ãƒ³
      document.getElementById('connect-source').addEventListener('click', function() {
        connectToSource();
      });

      // è¨­å®šç¢ºèªãƒœã‚¿ãƒ³
      document.getElementById('verify-mapping').addEventListener('click', function() {
        verifyColumnMapping();
      });

      // ä¸‹æ›¸ãä¿å­˜ãƒœã‚¿ãƒ³
      document.getElementById('save-draft').addEventListener('click', function() {
        saveDraft();
      });

      // å…¬é–‹ãƒœã‚¿ãƒ³
      document.getElementById('publish-now').addEventListener('click', function() {
        publishApp();
      });
    });

    // ã‚·ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
    function loadSheetList(spreadsheetId) {
      const select = document.getElementById('sheet-select');
      select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';
      
      google.script.run
        .withSuccessHandler(function(sheets) {
          select.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';
          sheets.forEach(sheet => {
            const option = document.createElement('option');
            option.value = sheet.name;
            option.textContent = sheet.name;
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          console.error('ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
        })
        .getSheetList(spreadsheetId);
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶š
    function connectToSource() {
      const spreadsheetId = document.getElementById('spreadsheet-select').value;
      const sheetName = document.getElementById('sheet-select').value;
      
      if (!spreadsheetId || !sheetName) {
        showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      setLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«æ¥ç¶šã—ã¾ã—ãŸ');
            // é€²æ—æ›´æ–°
            updateProgress(2);
            // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ›´æ–°
            updateColumnMapping(result.columnMapping);
          } else {
            showError(result.error);
          }
          setLoading(false);
        })
        .withFailureHandler(function(error) {
          console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
          showError('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
          setLoading(false);
        })
        .connectToDataSource(spreadsheetId, sheetName);
    }

    // é€²æ—æ›´æ–°
    function updateProgress(step) {
      const steps = document.querySelectorAll('.step');
      steps.forEach((stepEl, index) => {
        stepEl.classList.remove('completed', 'current');
        if (index < step - 1) {
          stepEl.classList.add('completed');
        } else if (index === step - 1) {
          stepEl.classList.add('current');
        }
      });
    }

    // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æ›´æ–°
    function updateColumnMapping(mapping) {
      // å®Ÿè£…äºˆå®š: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å—ã‘å–ã£ãŸåˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã§ç”»é¢ã‚’æ›´æ–°
      console.log('Column mapping:', mapping);
    }

    // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª
    function verifyColumnMapping() {
      showSuccess('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ç¢ºèªã—ã¾ã—ãŸ');
      updateProgress(3);
    }

    // ä¸‹æ›¸ãä¿å­˜
    function saveDraft() {
      const config = gatherConfiguration();
      
      setLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            updateConfigDisplay(result.config);
          } else {
            showError(result.error);
          }
          setLoading(false);
        })
        .withFailureHandler(function(error) {
          console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          showError('ä¸‹æ›¸ãã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          setLoading(false);
        })
        .saveDraftConfiguration(config);
    }

    // ã‚¢ãƒ—ãƒªå…¬é–‹
    function publishApp() {
      const appName = document.getElementById('app-name').value;
      if (!appName.trim()) {
        showError('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const config = gatherConfiguration();
      config.appName = appName;

      setLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('ã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã—ã¾ã—ãŸï¼');
            updatePublishStatus('published');
            updateConfigDisplay(result.config);
          } else {
            showError(result.error);
          }
          setLoading(false);
        })
        .withFailureHandler(function(error) {
          console.error('å…¬é–‹ã‚¨ãƒ©ãƒ¼:', error);
          showError('ã‚¢ãƒ—ãƒªã®å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
          setLoading(false);
        })
        .publishApplication(config);
    }

    // è¨­å®šåé›†
    function gatherConfiguration() {
      return {
        spreadsheetId: document.getElementById('spreadsheet-select').value,
        sheetName: document.getElementById('sheet-select').value,
        showNames: document.getElementById('show-names').checked,
        showReactions: document.getElementById('show-reactions').checked,
        timestamp: new Date().toISOString()
      };
    }

    // è¨­å®šè¡¨ç¤ºæ›´æ–°
    function updateConfigDisplay(config) {
      document.getElementById('config-json').textContent = JSON.stringify(config, null, 2);
    }

    // å…¬é–‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updatePublishStatus(status) {
      const badge = document.querySelector('.status-badge.unpublished') || 
                   document.querySelector('.status-badge.published');
      if (badge) {
        badge.className = `status-badge ${status}`;
        badge.textContent = status === 'published' ? 'å…¬é–‹ä¸­' : 'æœªå…¬é–‹';
      }
    }

    console.log('AdminPanel ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
  </script>
</body>
</html>