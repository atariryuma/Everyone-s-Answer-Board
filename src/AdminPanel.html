<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <title>ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰ ç®¡ç†ãƒ‘ãƒãƒ« - StudyQuest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#1a1b26" />
  <meta name="description" content="StudyQuestã®å›ç­”ãƒœãƒ¼ãƒ‰ç®¡ç†ãƒ‘ãƒãƒ« - ç›´æ„Ÿçš„ã§ä½¿ã„ã‚„ã™ã„æ•™è‚²ãƒ„ãƒ¼ãƒ«" />
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=()" />
  <!-- User ID from server template -->
  <meta name="user-id" content="<?= typeof userId !== 'undefined' ? userId : '' ?>" id="user-id-meta">

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Unified Styles and Shared Components -->
  <?!= include('UnifiedStyles'); ?>
  <?!= include('SharedUtilities'); ?>
  <?!= include('SharedJavaScript'); ?>
  <?!= include('AdminPanelLogic'); ?>
  
  <!-- ClientOptimizer ã®çµ±åˆ -->
  <?!= include('ClientOptimizer'); ?>
  <?!= include('UnifiedCache.js'); ?>
  
  <script>
  if (typeof GASOptimizer !== 'undefined') {
    if (typeof setTimeout === 'undefined') {
      function setTimeout(fn){ fn(); return 0; }
    }
    if (typeof clearTimeout === 'undefined') {
      function clearTimeout(){ }
    }
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('error', function(event) {
      console.error('Global error caught:', event.error);
      if (event.error && event.error.message && event.error.message.includes('document.write')) {
        console.warn('document.write ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚å®‰å…¨ãªDOMæ“ä½œã«åˆ‡ã‚Šæ›¿ãˆã¦ã„ã¾ã™ã€‚');
        event.preventDefault();
      }
    });
    
    // Promise rejection ã®ã‚­ãƒ£ãƒƒãƒ
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Unhandled promise rejection:', event.reason);
      event.preventDefault();
    });

    // GASOptimizer ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®åˆæœŸåŒ–
    var gasOptimizer = new GASOptimizer();
    
    // UnifiedCache ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®åˆæœŸåŒ–
    var unifiedCache = (typeof UnifiedCache !== 'undefined')
      ? new UnifiedCache()
      : { getOrSet: function(_, fn) { return fn(); } };
    
    // runGas ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•° - ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾å¿œ
    function runGas(functionName, ...args) {
      return gasOptimizer.call(functionName, ...args);
    }
    
    // ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: æ–°ã—ã„runGasWithUserIdé–¢æ•°
    function runGasWithUserId(functionName, ...args) {
      console.log('ğŸ“ runGasWithUserId called:', functionName, 'args:', args);
      console.log('ğŸ“ appState:', appState);
      
      if (!appState || !appState.userId) {
        const errorMsg = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
        console.error('âŒ  - No userId available for:', functionName, 'appState:', appState);
        showMessage(errorMsg, 'error');
        return Promise.reject(new Error(errorMsg));
      }

      console.log('âœ…  - runGasWithUserId:', functionName, 'userId:', appState.userId);
      
      if (!gasOptimizer || typeof gasOptimizer.call !== 'function') {
        const errorMsg = 'gasOptimizerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
        console.error('âŒ  - gasOptimizer not available');
        showMessage(errorMsg, 'error');
        return Promise.reject(new Error(errorMsg));
      }
      
      // userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ 
      return gasOptimizer.call(functionName, appState.userId, ...args);
    }
    
    // callWithCache é–¢æ•° - èª­ã¿å–ã‚Šå°‚ç”¨æ“ä½œç”¨
    function callWithCache(functionName, cacheKey, ttl, ...args) {
      return unifiedCache.getOrSet(cacheKey, function() {
        return gasOptimizer.call(functionName, ...args);
      }, ttl);
    }
    
    // ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: callWithCacheWithUserIdé–¢æ•°
    function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
      if (!appState.userId) {
        console.error('âŒ  - No userId available for cached call:', functionName);
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }

      return unifiedCache.getOrSet(cacheKey, function() {
        console.log('âœ…  - callWithCacheWithUserId:', functionName, 'userId:', appState.userId);
        return gasOptimizer.call(functionName, appState.userId, ...args);
      }, ttl);
    }
  }
  </script>
  <script>
  const __IS_SYSTEM_ADMIN_RAW__ = '<?= typeof isDeployUser !== "undefined" ? isDeployUser : false ?>';
  const __IS_SYSTEM_ADMIN__ = __IS_SYSTEM_ADMIN_RAW__ === 'true' || __IS_SYSTEM_ADMIN_RAW__ === true;
  window.isSystemAdmin = __IS_SYSTEM_ADMIN__;
  console.log('Template Debug:');
  console.log('- Raw template value:', __IS_SYSTEM_ADMIN_RAW__);
  console.log('- Raw template type:', typeof __IS_SYSTEM_ADMIN_RAW__);
  console.log('- Processed value:', __IS_SYSTEM_ADMIN__);
  console.log('- window.isSystemAdmin final:', window.isSystemAdmin);
  
  // URLæ›´æ–°å‡¦ç†
  const shouldUpdateUrl = '<?= typeof shouldUpdateUrl !== "undefined" ? shouldUpdateUrl : false ?>';
  const correctUrl = '<?= typeof correctUrl !== "undefined" ? correctUrl : "" ?>';
  
  if (shouldUpdateUrl === 'true' && correctUrl && correctUrl !== '') {
    console.log('Updating URL to:', correctUrl);
    try {
      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã®ãŸã‚ã€åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã§ã®ã¿URLæ›´æ–°ã‚’å®Ÿè¡Œ
      const currentOrigin = window.location.origin;
      const targetUrl = new URL(correctUrl);
      
      if (currentOrigin === targetUrl.origin || window.top === window) {
        if (window.history && window.history.replaceState) {
          window.history.replaceState({}, '', correctUrl);
          console.log('URL updated successfully to:', correctUrl);
        }
      } else {
        console.log('URL update skipped due to cross-origin restrictions');
      }
    } catch (e) {
      console.warn('Failed to update URL:', e);
    }
  }
  </script>
  
  <!-- CSS already included above, removing duplicate -->
  
  <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£ç”¨ã®è¿½åŠ CSS -->
  <style>
  * {
    box-sizing: border-box;
  }
  
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    overflow-x: hidden;
  }
  
  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  
  main {
    flex: 1;
    width: 100%;
  }
  
  /* Admin Panel Layout Fixes */
  .responsive-grid {
    display: grid;
    gap: 1rem; /* ãƒ¢ãƒã‚¤ãƒ«ã®ã‚®ãƒ£ãƒƒãƒ— */
    grid-template-columns: 1fr; /* ãƒ¢ãƒã‚¤ãƒ«: å˜ä¸€ã‚«ãƒ©ãƒ  */
  }
  
  @media (min-width: 768px) { /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆ */
    .responsive-grid {
      grid-template-columns: 2fr 1fr; /* å·¦: 2/3ã€å³: 1/3 */
      gap: 1rem; /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã®ã‚®ãƒ£ãƒƒãƒ— */
    }
    .right-panel {
      min-width: 200px; /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã®å³ãƒ‘ãƒãƒ«ã®æœ€å°å¹… */
    }
  }

  @media (min-width: 1024px) { /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—å‘ã‘ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆ */
    .responsive-grid {
      grid-template-columns: minmax(400px, 1fr) 350px; /* å·¦: æœ€å°400pxã€æŸ”è»Ÿã€‚å³: å›ºå®š350px */
      gap: 1.5rem; /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®ã‚®ãƒ£ãƒƒãƒ— */
    }
    .right-panel {
      min-width: 300px; /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã®å³ãƒ‘ãƒãƒ«ã®æœ€å°å¹…ï¼ˆå®‰å…¨ã®ãŸã‚ï¼‰ */
    }
  }
  
  /* Ensure proper main content layout */
  main.flex-1 {
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
  
  .left-panel {
    flex: 1;
    min-height: 0;
  }
  </style>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans">
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="text-center">
      <div class="spinner"></div>
      <p id="loading-message" class="mt-4 text-gray-300">å‡¦ç†ä¸­...</p>
    </div>
  </div>
  <header class="glass-panel border-b border-gray-700 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 sm:py-4">
      <div class="flex items-center justify-between">
        <!-- ãƒ­ã‚´ã¨ã‚¿ã‚¤ãƒˆãƒ« -->
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-gradient-to-r from-cyan-400 to-purple-400 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <div class="hidden sm:block">
            <h1 class="text-xl sm:text-2xl font-bold text-white leading-tight">ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰ ç®¡ç†ãƒ‘ãƒãƒ«</h1>
            <p class="text-sm text-gray-400">StudyQuest</p>
          </div>
          <div class="sm:hidden">
            <h1 class="text-xl font-bold text-white">ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰</h1>
          </div>
        </div>
        
        <!-- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ± -->
        <div class="flex items-center gap-2 sm:gap-3">
          <!-- ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ï¼ˆRegistration.htmlã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
          <div id="header-domain-info">
            <!-- ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è‡´è¡¨ç¤ºï¼ˆç·‘è‰²ãƒ‘ãƒãƒ«ï¼‰ -->
            <!-- ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è‡´è¡¨ç¤ºï¼ˆRegistration.htmlã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
            <div id="header-domain-match" class="glass-panel bg-gradient-to-r from-green-500/10 to-emerald-500/10 rounded-lg p-3 border border-green-400/30 hidden">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-green-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <div class="text-green-400 font-semibold text-sm" id="header-domain-match-text">G Suite ãƒ‰ãƒ¡ã‚¤ãƒ³</div>
                  <div class="text-green-200 text-xs">ã‚»ã‚­ãƒ¥ã‚¢ã‚¢ã‚¯ã‚»ã‚¹æœ‰åŠ¹</div>
                </div>
              </div>
            </div>
            
            <!-- ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸ä¸€è‡´è¡¨ç¤ºï¼ˆRegistration.htmlã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
            <div id="header-domain-mismatch" class="glass-panel bg-gradient-to-r from-yellow-500/10 to-orange-500/10 rounded-lg p-3 border border-yellow-400/30 hidden">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <div>
                  <div class="text-yellow-400 font-semibold text-sm" id="header-domain-mismatch-text">ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸ä¸€è‡´</div>
                  <div class="text-yellow-200 text-xs">ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚ã‚Š</div>
                </div>
              </div>
            </div>
            
            <!-- åˆæœŸçŠ¶æ…‹è¡¨ç¤º -->
            <div id="header-domain-initial" class="glass-panel bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-lg p-3 border border-blue-400/30">
              <div class="flex items-center gap-2">
                <div id="header-status-dot" class="w-3 h-3 bg-blue-400 rounded-full animate-pulse flex-shrink-0"></div>
                <div>
                  <div class="text-blue-400 font-semibold text-sm" id="header-domain-name-initial">ãƒ‰ãƒ¡ã‚¤ãƒ³ç¢ºèªä¸­</div>
                  <div class="text-blue-200 text-xs" id="header-status-text-initial">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­</div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
  </header>
  <main class="flex-1 max-w-6xl mx-auto px-4 sm:px-6 py-4 sm:py-8 pb-24">
    <!-- ã‚·ãƒ³ãƒ—ãƒ«çµ±åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
    <section class="mb-4">
      <div class="glass-panel p-6 rounded-lg">
        <div class="flex items-center justify-between">
          <!-- å·¦å´: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
              <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <div class="flex-1">
              <span class="text-base font-medium text-white" id="guidance-text">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</span>
              <div class="text-sm text-gray-400 mt-1" id="step-description">3ã‚¹ãƒ†ãƒƒãƒ—ã§ç°¡å˜ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</div>
            </div>
            <!-- æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div id="next-action-container" class="hidden">
              <button type="button" id="next-action-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                <span id="next-action-text">æ¬¡ã¸</span>
              </button>
            </div>
          </div>
          
          <!-- å³å´: ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚¹ãƒ†ãƒƒãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
          <div class="flex items-center gap-2">
            <div class="flex items-center gap-1" id="step-1-indicator">
              <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all">1</div>
              <span class="text-sm text-gray-300 hidden sm:inline">ãƒ‡ãƒ¼ã‚¿æº–å‚™</span>
            </div>
            <div class="w-4 h-px bg-gray-600"></div>
            <div class="flex items-center gap-1" id="step-2-indicator">
              <div class="w-6 h-6 bg-gray-600 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all">2</div>
              <span class="text-sm text-gray-300 hidden sm:inline">ã‚·ãƒ¼ãƒˆé¸æŠ</span>
            </div>
            <div class="w-4 h-px bg-gray-600"></div>
            <div class="flex items-center gap-1" id="step-3-indicator">
              <div class="w-6 h-6 bg-gray-600 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all">3</div>
              <span class="text-sm text-gray-300 hidden sm:inline">è¨­å®šãƒ»å…¬é–‹</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="responsive-grid">
      <!-- å·¦å´ï¼šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ï¼‰ -->
      <div class="left-panel space-y-6">
        
        <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿æº–å‚™ -->
        <div class="glass-panel p-6" id="data-setup-section">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl flex items-center justify-center font-bold text-xs shadow-lg">
                1
              </div>
              <div>
                <h2 class="text-xl font-semibold text-white">ãƒ‡ãƒ¼ã‚¿æº–å‚™</h2>
                <p class="text-sm text-gray-400">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¾ãŸã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’æº–å‚™</p>
              </div>
            </div>
            <button type="button" class="toggle-section" onclick="toggleSection('step1-content')" aria-expanded="true" aria-label="ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿">
              <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>
          
          <div id="step1-content" class="progressive-section expanded">
            <!-- åˆå¿ƒè€…å‘ã‘ï¼šç°¡å˜ä½œæˆ -->
            <div class="mb-6">
              <div class="google-integration p-4 rounded-xl text-white">
                <div class="flex items-center gap-3 mb-3">
                  <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                  <h3 class="text-lg font-semibold">æ¨å¥¨ï¼šè‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h3>
                </div>
                <p class="text-base mb-4 opacity-90">Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’Workspaceä¸Šã§è‡ªå‹•ä½œæˆã—ã¾ã™</p>
                <div class="space-y-2">
                  <button type="button" id="create-board-btn" class="btn btn-google w-full">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span id="create-board-text">æ–°ã—ã„ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆ</span>
                  </button>
                  
                  <!-- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ -->
                  <div id="existing-user-section" class="hidden">
                    <button type="button" id="create-additional-form-btn" class="btn btn-secondary w-full text-sm">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      <span id="create-additional-form-text" class="text-gray-200">æ–°è¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ</span>
                    </button>
                    <p class="text-xs text-gray-400 mt-1">ç¾åœ¨ã®ãƒœãƒ¼ãƒ‰ã«é€£æºã™ã‚‹æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ</p>
                    
                    <!-- ä½œæˆã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º -->
                    <div class="space-y-3 hidden mt-4" id="form-url-section">
                      <div class="success-state">
                        <div class="flex items-center gap-2 mb-2">
                          <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                          </svg>
                          <span class="font-medium text-green-200">ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ</span>
                        </div>
                        <div class="flex gap-2">
                          <input type="url" id="form-url-input" class="form-control flex-1" readonly placeholder="ãƒ•ã‚©ãƒ¼ãƒ URLãŒç”Ÿæˆã•ã‚Œã¾ã™">
                          <button type="button" id="copy-form-url-btn" class="btn btn-secondary px-3" title="URLã‚’ã‚³ãƒ”ãƒ¼">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                          </button>
                          <a id="edit-form-url-link" href="#" target="_blank" class="btn btn-primary px-3" title="ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç·¨é›†">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã®é€£æº (ä¸Šç´šè€…å‘ã‘) -->
            <details class="bg-gray-800/30 border border-gray-600/30 rounded-xl">
              <summary class="p-4 cursor-pointer text-base font-medium text-gray-300 hover:text-white flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                </svg>
                å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã®é€£æº (ä¸Šç´šè€…å‘ã‘)
              </summary>
              <div class="p-4 pt-0 space-y-4">
                <div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4">
                  <label class="block text-base font-medium text-purple-200 mb-2">
                    Googleãƒ•ã‚©ãƒ¼ãƒ ã¾ãŸã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URL
                  </label>
                  <div class="space-y-3">
                    <input type="url" 
                           id="resource-url-input" 
                           placeholder="Googleãƒ•ã‚©ãƒ¼ãƒ ã¾ãŸã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›"
                           class="form-control"
                           aria-describedby="resource-url-help">
                    <p id="resource-url-help" class="text-sm text-purple-300 mt-1">
                      æ—¢å­˜ã®Googleãƒ•ã‚©ãƒ¼ãƒ ã¾ãŸã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
                    </p>
                    <div class="flex gap-2">
                      <button type="button" id="add-resource-btn" class="btn btn-primary flex-1">
                        <span id="add-resource-text">ãƒªã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ </span>
                      </button>
                      <button type="button" id="open-resource-btn" class="btn btn-secondary px-3" disabled title="ãƒ•ã‚©ãƒ¼ãƒ ã¾ãŸã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        <span id="open-resource-text" class="ml-1 text-xs hidden sm:inline">é–‹ã</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </details>
            
            <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="custom-form-info-section" class="hidden mt-4">
              <!-- updateCustomFormInfo()ã§å‹•çš„ã«å†…å®¹ãŒè¨­å®šã•ã‚Œã‚‹ -->
            </div>
          </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ã‚·ãƒ¼ãƒˆé¸æŠ -->
        <div class="glass-panel p-6" id="sheet-selection-section">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl flex items-center justify-center font-bold text-xs shadow-lg">
                2
              </div>
              <div>
                <h2 class="text-xl font-semibold text-white">ã‚·ãƒ¼ãƒˆé¸æŠ</h2>
                <p class="text-sm text-gray-400">è¡¨ç¤ºã—ãŸã„ã‚·ãƒ¼ãƒˆã‚’é¸æŠ</p>
              </div>
            </div>
            <button type="button" class="toggle-section" onclick="toggleSection('step2-content')" aria-expanded="true" aria-label="ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿">
              <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>
          
          <div id="step2-content" class="progressive-section expanded">
            <div class="space-y-4">
              <div class="space-y-3">
                <!-- ã‚·ãƒ¼ãƒˆé¸æŠã®èª¬æ˜ -->
                <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                  <div class="flex items-center gap-2 mb-2">
                    <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <span class="text-base font-medium text-green-200">ã‚·ãƒ¼ãƒˆé¸æŠ</span>
                  </div>
                  <p class="text-sm text-green-300">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚·ãƒ¼ãƒˆã‚’å›ç­”ãƒœãƒ¼ãƒ‰ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ã‚·ãƒ¼ãƒˆã«æŒ‡å®šã—ã¾ã™</p>
                </div>
                
                <!-- ã‚·ãƒ³ãƒ—ãƒ«ã‚·ãƒ¼ãƒˆé¸æŠ -->
                <label for="sheet-select" class="block text-base font-medium text-white">
                  è¡¨ç¤ºã—ãŸã„ã‚·ãƒ¼ãƒˆã‚’é¸æŠ
                </label>
                <div class="flex gap-2">
                    <select id="sheet-select" class="form-control flex-1" aria-describedby="sheet-help">
                      <option>èª­ã¿è¾¼ã¿ä¸­...</option>
                    </select>
                    <button type="button" id="open-spreadsheet-btn-step2" class="btn btn-secondary px-3" title="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—3: è¨­å®šãƒ»å…¬é–‹ -->
        <div class="glass-panel p-6" id="config-section">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl flex items-center justify-center font-bold text-xs shadow-lg">
                3
              </div>
              <div>
                <h2 class="text-xl font-semibold text-white">è¨­å®šãƒ»å…¬é–‹</h2>
                <p class="text-sm text-gray-400">åˆ—è¨­å®šã‚’è¡Œã„å…¬é–‹</p>
              </div>
            </div>
            <button type="button" class="toggle-section" onclick="toggleSection('step3-content')" aria-expanded="true" aria-label="ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿">
              <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>
          
          <div id="step3-content" class="progressive-section expanded">
            <div id="config-area" class="space-y-4 hidden">
              <div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  <span class="text-base font-medium text-purple-200">åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®š</span>
                </div>
                <p class="text-sm text-purple-300">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—ã‚’å›ç­”ãƒœãƒ¼ãƒ‰ã®é …ç›®ã«å‰²ã‚Šå½“ã¦ã¾ã™</p>
              </div>
              
              <!-- å¿…é ˆè¨­å®š -->
              <div class="space-y-4">
                <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4">
                  <label class="block">
                    <div class="flex items-center gap-2 mb-2">
                      <span class="text-base font-medium text-white">å›ç­”ãƒ‡ãƒ¼ã‚¿åˆ—</span>
                      <span class="px-2 py-1 bg-red-500 text-white text-xs rounded-full">å¿…é ˆ</span>
                    </div>
                    <div class="flex gap-2">
                      <select id="opinionHeader" class="form-control flex-1" aria-describedby="main-help"></select>
                      <button type="button" id="reguess-headers-btn" class="btn bg-gradient-to-r from-cyan-600/80 to-purple-600/80 hover:from-cyan-600 hover:to-purple-600 text-white px-3 py-2 relative overflow-hidden group" title="AIæ­è¼‰ é«˜ç²¾åº¦åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ">
                        <span class="relative z-10 flex items-center gap-1">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                          </svg>
                          <span class="text-xs font-bold">AIåˆ¤å®š</span>
                        </span>
                        <div class="absolute inset-0 bg-gradient-to-r from-cyan-400/20 to-purple-400/20 transform translate-x-full group-hover:translate-x-0 transition-transform duration-300"></div>
                      </button>
                    </div>
                    <p id="main-help" class="text-sm text-red-300 mt-1">
                      å›ç­”å†…å®¹ãŒå«ã¾ã‚Œã‚‹åˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„
                    </p>
                  </label>
                </div>
                
                <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š -->
                <details class="bg-gray-800/30 border border-gray-600/30 rounded-xl">
                  <summary class="p-4 cursor-pointer text-base font-medium text-gray-300 hover:text-white flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                    </svg>
                    ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆä»»æ„ï¼‰
                  </summary>
                  <div class="p-4 pt-0 space-y-4" id="detail-options">
                    <label class="block">
                      <span class="text-base text-gray-300 mb-2 block">ç†ç”±ãƒ»è©³ç´°åˆ—</span>
                      <select id="reasonHeader" class="form-control"></select>
                    </label>
                    <label class="block">
                      <span class="text-base text-gray-300 mb-2 block">åå‰åˆ—</span>
                      <select id="nameHeader" class="form-control"></select>
                    </label>
                    <label class="block">
                      <span class="text-base text-gray-300 mb-2 block">ã‚¯ãƒ©ã‚¹åˆ—</span>
                      <select id="classHeader" class="form-control"></select>
                    </label>
                    <div class="flex items-center mt-4">
                      <input type="checkbox" id="showNames" name="showNames" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                      <label for="showNames" class="ml-2 block text-base text-gray-300">åå‰ã‚’è¡¨ç¤ºã™ã‚‹</label>
                    </div>
                    <div class="flex items-center mt-2">
                      <input type="checkbox" id="showCounts" name="showCounts" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                      <label for="showCounts" class="ml-2 block text-base text-gray-300">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’è¡¨ç¤ºã™ã‚‹</label>
                    </div>
                  </div>
                </details>
              </div>
              
              <!-- çµ±åˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
              <div class="space-y-3 pt-4">
                <button type="button" id="save-publish-btn" class="btn btn-primary w-full btn-lg">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span id="save-publish-text">è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹</span>
                </button>

                <button type="button" id="unpublish-board-btn" class="btn btn-warning w-full">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path>
                  </svg>
                  <span id="unpublish-board-text">å…¬é–‹ã‚’åœæ­¢</span>
                </button>
              </div>
            </div>
            
            <div id="config-placeholder" class="text-center py-8">
              <div class="w-8 h-8 bg-gray-700 rounded-xl flex items-center justify-center mx-auto mb-3">
                <div class="loading-skeleton w-full h-full rounded-full hidden" id="config-loading"></div>
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                </svg>
              </div>
              <p class="text-gray-400 text-base">ã‚·ãƒ¼ãƒˆã‚’é¸æŠã™ã‚‹ã¨åˆ—è¨­å®šãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å³å´ï¼šæƒ…å ±ãƒ»ãƒ˜ãƒ«ãƒ—ãƒ‘ãƒãƒ« -->
      <div class="space-y-6">
        
        

        <!-- ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ -->
        <div class="glass-panel p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl flex items-center justify-center">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-amber-400">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h3>
          </div>
          
          <div class="space-y-4">
            <!-- ç°¡æ½”ãªç®¡ç†ãƒ•ãƒ­ãƒ¼ -->
            <div class="bg-amber-900/20 border border-amber-500/30 rounded-lg p-4">
              <h4 class="text-base font-medium text-amber-200 mb-3 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                ç®¡ç†ã®æµã‚Œï¼ˆ3ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
              </h4>
              <div class="space-y-2 text-sm text-amber-100">
                <div class="flex items-center gap-2">
                  <span class="bg-amber-600 text-white text-xs px-2 py-1 rounded font-bold">1</span>
                  <span>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é€£æºãƒ»AIåˆ—åˆ¤å®š</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="bg-amber-600 text-white text-xs px-2 py-1 rounded font-bold">2</span>
                  <span>è¡¨ç¤ºè¨­å®šãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼èª¿æ•´</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="bg-amber-600 text-white text-xs px-2 py-1 rounded font-bold">3</span>
                  <span>å…¬é–‹ã—ã¦å­¦ç¿’è€…ã«å…±æœ‰</span>
                </div>
              </div>
              <button type="button" id="show-usage-guide" class="btn btn-secondary w-full text-base py-2 mt-3">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                è©³ç´°ã‚¬ã‚¤ãƒ‰ã‚’é–‹ã
              </button>
            </div>
            
            <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»æ©Ÿèƒ½ -->
            <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
              <h4 class="text-base font-medium text-blue-200 mb-3 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»æ©Ÿèƒ½æ¦‚è¦
              </h4>
              <div class="space-y-2 text-sm text-blue-100">
                <div class="flex items-center gap-2">
                  <span class="text-green-400">âœ“</span>
                  <span>Google Workspaceè‡ªå‹•é€£æº</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-green-400">âœ“</span>
                  <span>AIæ©Ÿèƒ½ã§ã®åŠ¹ç‡åŒ–</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-green-400">âœ“</span>
                  <span>å®Œå…¨éå…¬é–‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-green-400">âœ“</span>
                  <span>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°</span>
                </div>
              </div>
              <div class="mt-3 text-sm text-blue-200 bg-blue-800/30 rounded p-2">
                ğŸ’¡ è©³ç´°ã‚¬ã‚¤ãƒ‰ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä»•æ§˜ã‚’ã”ç¢ºèªãã ã•ã„
              </div>
            </div>
            
            <!-- ãƒ‡ã‚¸ã‚¿ãƒ«ã‚·ãƒ†ã‚£ã‚ºãƒ³ã‚·ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ -->
            <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
              <h4 class="text-base font-medium text-blue-200 mb-3 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚·ãƒ†ã‚£ã‚ºãƒ³ã‚·ãƒƒãƒ—æŒ‡å°
              </h4>
              <p class="text-sm text-blue-100 mb-3">ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚·ãƒ†ã‚£ã‚ºãƒ³ã‚·ãƒƒãƒ—ã«åŸºã¥ãå›ç­”ãƒœãƒ¼ãƒ‰æŒ‡å°ã®ãƒã‚¤ãƒ³ãƒˆã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†</p>
              <button type="button" id="show-digital-citizenship-guide" class="btn btn-secondary w-full text-base py-2">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                æŒ‡å°ã‚¬ã‚¤ãƒ‰ã‚’é–‹ã
              </button>
            </div>
            
          </div>
        </div>
        <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ -->
        <div id="system-info-panel" class="glass-panel p-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 bg-gradient-to-br from-gray-500 to-gray-600 rounded-xl flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-300">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h3>
    </div>

    <div class="space-y-4">
      <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ± -->
      <div class="bg-gray-800/30 border border-gray-600/30 rounded-lg p-4">
        <h4 class="text-base font-medium text-gray-200 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
        </h4>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-400">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</span>
            <span class="text-white font-medium" id="info-admin-email">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</span>
            <span class="text-white font-mono text-sm bg-gray-700 px-1.5 py-0.5 rounded" id="info-user-id">-</span>
          </div>
          <div class="text-right pt-2">
            <a href="#" onclick="switchToAnotherAccount(); return false;" class="text-cyan-400 hover:text-cyan-300 hover:underline text-sm">
              åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
            </a>
          </div>
        </div>
      </div>

      <!-- å…¬é–‹è¨­å®š -->
      <div class="bg-gray-800/30 border border-gray-600/30 rounded-lg p-4">
        <h4 class="text-base font-medium text-gray-200 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
          å…¬é–‹è¨­å®š
        </h4>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-400">å…¬é–‹çŠ¶æ…‹:</span>
            <span class="px-2 py-1 rounded text-sm font-medium" id="info-publish-status">
              <span class="inline-flex items-center gap-1">
                <div class="w-2 h-2 rounded-full" id="info-publish-indicator"></div>
                <span id="info-publish-text">ç¢ºèªä¸­</span>
              </span>
            </span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">å…¬é–‹ã‚·ãƒ¼ãƒˆ:</span>
            <span class="text-white font-semibold" id="info-published-sheet">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:</span>
            <span class="text-white" id="info-display-mode">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º:</span>
            <span class="text-white" id="info-show-counts">-</span>
          </div>
        </div>
      </div>

      <!-- ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ -->
      <div class="bg-gray-800/30 border border-gray-600/30 rounded-lg p-4">
        <h4 class="text-base font-medium text-gray-200 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          ãƒ‡ãƒ¼ã‚¿çŠ¶æ³
        </h4>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-400">ç·å›ç­”æ•°:</span>
            <span class="text-white font-bold text-lg" id="info-answer-count">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">ç·ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°:</span>
            <span class="text-white font-bold text-lg" id="info-reaction-count">-</span>
          </div>
        </div>
      </div>

      <!-- ãƒªã‚½ãƒ¼ã‚¹ -->
      <div class="bg-gray-800/30 border border-gray-600/30 rounded-lg p-4">
        <h4 class="text-base font-medium text-gray-200 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
          </svg>
          ãƒªã‚½ãƒ¼ã‚¹
        </h4>
        <div class="space-y-3 text-sm">
          <div class="flex gap-2">
            <button type="button" id="open-spreadsheet-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded flex items-center justify-center gap-2 transition-all" disabled>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ
            </button>
            <button type="button" id="open-form-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded flex items-center justify-center gap-2 transition-all" disabled>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              ãƒ•ã‚©ãƒ¼ãƒ 
            </button>
          </div>
          
          <!-- ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="border-t border-gray-600/50 pt-3 mt-3">
            <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-3">
              <div class="flex items-center gap-2 mb-2">
                <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <span class="text-red-200 font-medium text-sm">å±é™ºãªæ“ä½œ</span>
              </div>
              <button type="button" id="delete-all-resources-btn" class="w-full bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded flex items-center justify-center gap-2 transition-all text-sm font-medium">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤
              </button>
              <p class="text-red-300 text-xs mt-2">
                âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®å…¨ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™
              </p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ã‚¢ãƒ—ãƒªè¨­å®šãƒªãƒ³ã‚¯ -->
      <div id="app-setup-link" class="bg-blue-900/10 border border-blue-500/30 rounded-lg p-3 transition-all hover:border-blue-500/50">
        <button type="button" onclick="openAppSetupPage()" class="w-full flex items-center justify-between text-sm font-medium text-blue-300 hover:text-blue-200 transition-colors">
          <div class="flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span>ã‚¢ãƒ—ãƒªè¨­å®šç®¡ç†</span>
          </div>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
        </button>
        <p class="text-xs text-blue-200/70 mt-2 ml-6">
          ã‚¢ãƒ—ãƒªã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã‚’ç®¡ç†ã§ãã¾ã™
        </p>
      </div>
      
      <details id="account-deletion-section" class="bg-red-900/10 border border-red-500/30 rounded-lg transition-all hover:border-red-500/50">
        <summary class="p-3 cursor-pointer text-sm font-medium text-red-300 hover:text-red-200 flex items-center justify-between">
          <span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç®¡ç†</span>
          <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </summary>
        <div class="p-3 pt-0">
          <p class="text-xs text-red-200/80 mb-3">
            ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ä½œæˆã—ãŸã™ã¹ã¦ã®ãƒœãƒ¼ãƒ‰ã¨è¨­å®šãŒå®Œå…¨ã«æ¶ˆå»ã•ã‚Œã¾ã™ã€‚
          </p>
          <button type="button" id="delete-account-btn" class="btn btn-danger w-full text-sm py-2">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            <span>è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹</span>
          </button>
        </div>
      </details>
      </div>
    </div>
  </main>
  
  <!-- çµ±åˆãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer id="admin-footer" class="fixed bottom-0 left-0 right-0 glass-panel border-t border-gray-700 hidden">
    <div class="max-w-6xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <!-- å·¦å´: å…¬é–‹ä¸­ã®å•é¡Œæ–‡ -->
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-green-400 font-semibold text-sm">å…¬é–‹ä¸­:</span>
          </div>
          <p class="text-blue-300 font-medium text-lg" id="current-topic-text">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
        
        <!-- å³å´: ãƒœãƒ¼ãƒ‰URLæ“ä½œ -->
        <div class="flex items-center gap-3">
          <input type="text" id="board-url" readonly
                 class="px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-sm cursor-pointer hover:bg-gray-700 focus:ring-2 focus:ring-green-400 min-w-[300px]"
                 onclick="this.select()" placeholder="URLãŒç”Ÿæˆã•ã‚Œã¾ã™">
          <button type="button" onclick="copyBoardUrl()" class="btn btn-secondary px-4 py-2 flex items-center" title="URLã‚’ã‚³ãƒ”ãƒ¼" aria-label="ç”Ÿå¾’ç”¨URLã‚’ã‚³ãƒ”ãƒ¼">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
          </button>
          <a id="view-board-link" href="#" target="_blank" rel="noopener noreferrer" class="btn btn-primary px-4 py-2 flex items-center" title="å›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹ã" aria-label="æ–°ã—ã„ã‚¿ãƒ–ã§å›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹ã">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </footer>
  <div id="message-area" class="message-area fixed top-20 right-6 z-50" aria-live="polite" role="status"></div>
  
  <!-- å…±é€šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
  <?!= include('SharedModals'); ?>
  <script>
    /* =============================================================================
       AdminPanel.html - Minimal JavaScript 
       Main logic moved to AdminPanelLogic.html and SharedJavaScript.html
       ============================================================================= */
    
    // Detect test environment
    var IS_TEST_ENV = typeof navigator !== 'undefined' &&
      navigator.userAgent && navigator.userAgent.indexOf('jsdom') !== -1;

    // Backward compatibility functions using SharedUtilities
    var debounce = window.sharedUtilities?.utils?.debounce || function(func, delay) {
      return func; // Fallback
    };

    // Essential compatibility functions
    var dom = window.sharedUtilities?.dom || {};
    var createSafeElement = dom.createSafeElement || document.createElement.bind(document);
    var getCachedElement = dom.getCachedElement || document.getElementById.bind(document);
    var safeGetElement = getCachedElement;
    
    // =============================================================================
    // MINIMAL ADMIN PANEL JAVASCRIPT
    // Main logic moved to AdminPanelLogic.html
    // =============================================================================
    
    // Essential elements object for backward compatibility
    var elements = {};
    
    // Essential functions using shared utilities
    var showMessage = window.sharedUtilities?.message?.show || function(msg, type) {
      console.log(`[${type}] ${msg}`);
    };
    
    var handleError = window.adminUtilities?.error?.handle || function(error, context) {
      console.error(`[${context}]`, error);
    };
    
    var setLoading = window.adminUtilities?.loading?.set || function(loading, message) {
      console.log(`Loading: ${loading} - ${message}`);
    };
    
    var updateDatabaseInfo = window.adminUtilities?.ui?.updateDatabaseInfo || function(status) {
      console.log('Update database info:', status);
    };
    
    var toggleSection = window.adminUtilities?.ui?.toggleSection || function(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.toggle('expanded');
        section.classList.toggle('collapsed');
      }
    };
    
    // Simple character counter setup
    function setupCharacterCounters() {
      const questionInput = document.getElementById('main-question-text');
      const questionCounter = document.getElementById('question-char-counter');
      
      if (questionInput && questionCounter) {
        questionInput.addEventListener('input', function() {
          const count = this.value.length;
          questionCounter.textContent = `${count}/500`;
          questionCounter.className = count > 450 ? 'text-xs text-red-400' : 'text-xs text-gray-500';
        });
      }
    }
    
    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
      if (!IS_TEST_ENV) {
        console.log('ğŸ”§ AdminPanel: Using unified utilities and logic files');
        setupCharacterCounters();
        
        // Initialize admin utilities if available
        if (window.adminUtilities) {
          console.log('âœ… AdminPanel: Admin utilities loaded');
        }
        
        if (window.sharedUtilities) {
          console.log('âœ… AdminPanel: Shared utilities loaded');
        }
      }
    });
  </script>

  <!-- ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <script>
    
    // Utility for setting up click handlers with privacy modal
    function setupPrivacyHandler(elementId, callback) {
      var element = elements[elementId] || getCachedElement(elementId);
      if (element) {
        addSafeEventListener(element, 'click', function() {
          showPrivacyModal(callback);
        });
      }
    }
    
    // Utility for delegated event handling
    function setupDelegatedHandler(parentElement, selector, event, callback) {
      if (typeof parentElement === 'string') {
        parentElement = getCachedElement(parentElement);
      }
      
      if (parentElement) {
        addSafeEventListener(parentElement, event, function(e) {
          var target = e.target.closest(selector);
          if (target) {
            callback.call(target, e);
          }
        });
      }
    }
    
    // =============================================================================
    // ERROR HANDLING SYSTEM - Centralized error management
    // =============================================================================
    
    // Centralized error handling with consistent formatting
    function handleError(error, context, userMessage) {
      // Log error for debugging
      var errorMsg = error && error.message ? error.message : String(error);
      console.error('[' + (context || 'Unknown') + '] Error:', errorMsg);
      
      // Convert technical errors to user-friendly messages
      var displayMessage = userMessage || translateErrorMessage(errorMsg, context);
      showMessage(displayMessage, 'error');
      
      // Additional error reporting could be added here
      return false;
    }

    /**
     * æŠ€è¡“çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›
     * @param {string} errorMsg - å…ƒã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @param {string} context - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string} ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    function translateErrorMessage(errorMsg, context) {
      if (!errorMsg || typeof errorMsg !== 'string') {
        return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
      }

      var lowerMsg = errorMsg.toLowerCase();
      
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé–¢é€£ã®ã‚¨ãƒ©ãƒ¼
      if (lowerMsg.includes('ç¯„å›²ã®åˆ—æ•°ã«ã¯') || lowerMsg.includes('range')) {
        return `ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ã¦ã€1è¡Œç›®ã«ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆåˆ—åï¼‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
      }
      
      if (lowerMsg.includes('ã‚·ãƒ¼ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—') || lowerMsg.includes('sheet')) {
        return `ğŸ“‹ ã‚·ãƒ¼ãƒˆã®æƒ…å ±ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒæ­£ã—ãå…±æœ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
â€¢ ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
â€¢ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ`;
      }
      
      // æ¨©é™é–¢é€£ã®ã‚¨ãƒ©ãƒ¼
      if (lowerMsg.includes('permission') || lowerMsg.includes('æ¨©é™') || lowerMsg.includes('access denied')) {
        return `ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’ç¢ºèª
â€¢ ç·¨é›†æ¨©é™ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
â€¢ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ã¿ã‚‹`;
      }
      
      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–¢é€£ã®ã‚¨ãƒ©ãƒ¼
      if (lowerMsg.includes('network') || lowerMsg.includes('timeout') || lowerMsg.includes('fetch')) {
        return `ğŸŒ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã®å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèª
â€¢ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
â€¢ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿`;
      }
      
      // ãƒ•ã‚©ãƒ¼ãƒ é–¢é€£ã®ã‚¨ãƒ©ãƒ¼
      if (lowerMsg.includes('form') && lowerMsg.includes('not found')) {
        return `ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
â€¢ ãƒ•ã‚©ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
â€¢ æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ`;
      }
      
      // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼é–¢é€£ã®ã‚¨ãƒ©ãƒ¼
      if (lowerMsg.includes('validation') || lowerMsg.includes('invalid')) {
        return `âš ï¸ å…¥åŠ›å†…å®¹ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ å¿…é ˆé …ç›®ãŒã™ã¹ã¦å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
â€¢ å…¥åŠ›å½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèª
â€¢ ç‰¹æ®Šæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèª`;
      }
      
      // èªè¨¼é–¢é€£ã®ã‚¨ãƒ©ãƒ¼
      if (lowerMsg.includes('authentication') || lowerMsg.includes('login') || lowerMsg.includes('unauthorized')) {
        return `ğŸ” èªè¨¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
â€¢ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
â€¢ å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã‚‹`;
      }
      
      // ã‚µãƒ¼ãƒãƒ¼é–¢é€£ã®ã‚¨ãƒ©ãƒ¼
      if (lowerMsg.includes('server error') || lowerMsg.includes('500') || lowerMsg.includes('503')) {
        return `âš¡ ã‚·ã‚¹ãƒ†ãƒ ãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ æ•°åˆ†å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
â€¢ å•é¡ŒãŒç¶šãå ´åˆã¯ç®¡ç†è€…ã«é€£çµ¡`;
      }
      
      // è¨­å®šé–¢é€£ã®ã‚¨ãƒ©ãƒ¼
      if (context && context.includes('config') || lowerMsg.includes('configuration')) {
        return `âš™ï¸ è¨­å®šã®ä¿å­˜ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ã™ã¹ã¦ã®å¿…é ˆé …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
â€¢ è¨­å®šå†…å®¹ã«å•é¡ŒãŒãªã„ã‹ç¢ºèª
â€¢ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ`;
      }
      
      // ãã®ä»–ã®ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼
      if (lowerMsg.includes('failed') || lowerMsg.includes('error')) {
        return `âŒ æ“ä½œãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
â€¢ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
â€¢ å•é¡ŒãŒç¶šãå ´åˆã¯åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’è©¦ã™`;
      }
      
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      return `âš ï¸ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
â€¢ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
â€¢ å•é¡ŒãŒç¶šãå ´åˆã¯ã‚µãƒãƒ¼ãƒˆã«ãŠå•ã„åˆã‚ã›ãã ã•ã„`;
    }
    
    // Wrapper for Google Apps Script calls with consistent error handling
    function safeGASCall(methodName, successHandler, errorMessage) {
      return {
        withSuccessHandler: function(handler) {
          this._successHandler = handler;
          return this;
        },
        withFailureHandler: function(handler) {
          this._failureHandler = handler;
          return this;
        },
        execute: function() {
          var self = this;
          google.script.run
            .withSuccessHandler(function(result) {
              if (self._successHandler) {
                try {
                  self._successHandler(result);
                } catch (err) {
                  handleError(err, methodName + '.successHandler', 'ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
              }
            })
            .withFailureHandler(function(error) {
              if (self._failureHandler) {
                try {
                  self._failureHandler(error);
                }
                catch (err) {
                  handleError(err, methodName + '.failureHandler');
                }
              }
              else {
                handleError(error, methodName, errorMessage);
              }
            })[methodName].apply(google.script.run, arguments);
        }
      };
    }
    
    // Legacy showError function for backward compatibility
    function showError(error) {
      handleError(error, 'General', null);
    }

    // =============================================================================
    // MESSAGE SYSTEM - Refactored for better maintainability
    // =============================================================================
    
    // Message type configurations
    var MESSAGE_TYPES = {
      info: { bgColor: 'bg-blue-500', icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
      success: { bgColor: 'bg-green-500', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z', extraClass: 'success-pulse' },
      error: { bgColor: 'bg-red-500', icon: 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z', extraClass: 'error-shake' },
      warning: { bgColor: 'bg-yellow-500', icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z', extraClass: 'text-black' },
      green: { bgColor: 'bg-green-500', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' },
      blue: { bgColor: 'bg-blue-500', icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
      yellow: { bgColor: 'bg-yellow-500', icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z', extraClass: 'text-black' }
    };
    
    // Sanitize message content safely
    function sanitizeMessage(message) {
      if (typeof message !== 'string') {
        try {
          message = String(message);
        } catch (e) {
          return 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒ©ãƒ¼';
        }
      }
      
      // Remove control characters and limit length
      return message
        .replace(/[\u0000-\u001F\u007F]/g, '')
        .replace(/[\'"\\]/g, '')
        .substring(0, 200);
    }
    
    // Check for duplicate messages and highlight if found
    function checkDuplicateMessage(messageArea, message) {
      var existingMessages = Array.from(messageArea.children);
      for (var i = 0; i < existingMessages.length; i++) {
        var existing = existingMessages[i];
        var spanElement = existing.querySelector('span');
        var existingText = spanElement ? spanElement.textContent : null;
        if (existingText === message) {
          // Highlight existing message
          existing.style.transform = 'scale(1.05)';
          setTimeout(function() { existing.style.transform = 'scale(1)'; }, 200);
          return true;
        }
      }
      return false;
    }
    
    // Clean up old messages (keep only 5 most recent)
    function cleanupOldMessages(messageArea) {
      while (messageArea.children.length >= 5) {
        messageArea.children[0].remove();
      }
    }
    
    // Create message DOM structure
    function createMessageElement(messageId, message, type) {
      var typeConfig = MESSAGE_TYPES[type] || MESSAGE_TYPES.info;
      var messageElement = createSafeElement('div');
      messageElement.id = messageId;
      messageElement.className = 'p-4 mb-3 rounded-lg shadow-md flex items-center justify-between text-white transform transition-all duration-300 ease-out slide-up ' + typeConfig.bgColor;
      
      if (typeConfig.extraClass) {
        messageElement.classList.add(typeConfig.extraClass);
      }
      
      // Create message container with icon and text
      var messageContainer = createSafeElement('div', 'flex items-center');
      var iconContainer = createSafeElement('div');
      iconContainer.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' + typeConfig.icon + '"></path></svg>';
      
      var messageSpan = createSafeElement('span', 'ml-2 text-sm font-medium', message);
      messageContainer.appendChild(iconContainer);
      messageContainer.appendChild(messageSpan);
      
      // Create close button
      var closeButton = createSafeElement('button', 'ml-4 text-white opacity-70 hover:opacity-100 focus:outline-none');
      closeButton.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
      closeButton.onclick = function() { removeMessage(messageId); };
      
      messageElement.appendChild(messageContainer);
      messageElement.appendChild(closeButton);
      
      return messageElement;
    }
    
    // Set up auto-removal timer for message
    function setupMessageAutoRemoval(messageId, type) {
      var timeout = type === 'error' ? 5000 : 2500;
      return setTimeout(function() {
        var msgEl = safeGetElement(messageId);
        if (msgEl && msgEl.parentNode) {
          msgEl.classList.remove('slide-up');
          msgEl.classList.add('fade-out');
          
          var fallbackTimer = setTimeout(function() {
            if (msgEl && msgEl.parentNode) {
              msgEl.remove();
            }
          }, 500);
          
          msgEl.addEventListener('transitionend', function() {
            clearTimeout(fallbackTimer);
            if (msgEl && msgEl.parentNode) {
              msgEl.remove();
            }
          }, { once: true });
        }
      }, timeout);
    }
    
    // Main showMessage function - now much cleaner
    function showMessage(message, type) {
      if (IS_TEST_ENV) return;
      try {
        type = type || 'info';
        message = sanitizeMessage(message);
        
        var messageArea = safeGetElement('message-area');
        if (!messageArea) return;
        
        // Check for duplicates
        if (checkDuplicateMessage(messageArea, message)) {
          return;
        }
        
        // Clean up old messages
        cleanupOldMessages(messageArea);
        
        // Create and display new message
        var messageId = 'msg-' + Date.now();
        var messageElement = createMessageElement(messageId, message, type);
        messageArea.appendChild(messageElement);
        
        // Set up auto-removal
        messageElement.removeTimer = setupMessageAutoRemoval(messageId, type);
        
      } catch (error) {
        try {
          console.error('showMessage function error:', error);
        } catch (e) {
          // Silently fail if even logging fails
        }
      }
    }

    function removeMessage(messageId) {
      var msgEl = document.getElementById(messageId);
      if (msgEl) {
        // è‡ªå‹•ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        if (msgEl.removeTimer) {
          clearTimeout(msgEl.removeTimer);
        }
        // å³åº§ã«å‰Šé™¤
        msgEl.remove();
      }
    }

    function addVisualFeedback(element, type) {
      if (!element) return;
      element.classList.remove('success-pulse', 'error-shake');
      void element.offsetWidth; // Trigger reflow
      element.classList.add(type === 'success' ? 'success-pulse' : 'error-shake');
    }

    // Layout adjustment function for footer padding
    let baseBodyPadding;
    function adjustLayout() {
      if (IS_TEST_ENV) return;
      if (typeof baseBodyPadding === 'undefined') {
        baseBodyPadding = parseFloat(getComputedStyle(document.body).paddingBottom) || 0;
      }
      const footer = document.getElementById('admin-footer');
      if (footer) {
        const footerHeight = footer.offsetHeight;
        document.body.style.paddingBottom = footerHeight + baseBodyPadding + 'px';
      }
    }

    // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆ¶å¾¡é–¢æ•°
    function showPrivacyModal(onContinue) {
      var modal = document.getElementById('privacy-modal');
      if (!modal) {
        console.error('ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      modal.classList.remove('hidden');
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆé‡è¤‡ã‚’é˜²ããŸã‚ä¸€åº¦ã‚¯ãƒªã‚¢ï¼‰
      var continueBtn = document.getElementById('privacy-modal-continue');
      var cancelBtn = document.getElementById('privacy-modal-cancel');
      
      // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
      if (continueBtn) {
        var newContinueBtn = continueBtn.cloneNode(true);
        continueBtn.parentNode.replaceChild(newContinueBtn, continueBtn);
        newContinueBtn.addEventListener('click', function() {
          hidePrivacyModal();
          if (onContinue) onContinue();
        });
      }
      
      if (cancelBtn) {
        var newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        newCancelBtn.addEventListener('click', hidePrivacyModal);
      }
      
      // Escapeã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      var escapeHandler = function(e) {
        if (e.key === 'Escape') {
          hidePrivacyModal();
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
    }
    
    function hidePrivacyModal() {
      var modal = document.getElementById('privacy-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // ãƒ‡ã‚¸ã‚¿ãƒ«ã‚·ãƒ†ã‚£ã‚ºãƒ³ã‚·ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆ¶å¾¡é–¢æ•°
    function showDigitalCitizenshipModal() {
      var modal = document.getElementById('digital-citizenship-modal');
      if (!modal) {
        console.error('ãƒ‡ã‚¸ã‚¿ãƒ«ã‚·ãƒ†ã‚£ã‚ºãƒ³ã‚·ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      modal.classList.remove('hidden');
      
      // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      var closeBtn = document.getElementById('digital-citizenship-modal-close');
      var closeBtnBottom = document.getElementById('digital-citizenship-modal-close-btn');
      
      if (closeBtn) {
        closeBtn.onclick = hideDigitalCitizenshipModal;
      }
      
      if (closeBtnBottom) {
        closeBtnBottom.onclick = hideDigitalCitizenshipModal;
      }
      
      // Escapeã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      var escapeHandler = function(e) {
        if (e.key === 'Escape') {
          hideDigitalCitizenshipModal();
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«é–‰ã˜ã‚‹
      modal.onclick = function(e) {
        if (e.target === modal) {
          hideDigitalCitizenshipModal();
        }
      };
    }
    
    function hideDigitalCitizenshipModal() {
      var modal = document.getElementById('digital-citizenship-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    /**
     * è¨­å®šã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã—ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹
     */
    function hideConfigArea() {
        var configArea = document.getElementById('config-area');
        var configPlaceholder = document.getElementById('config-placeholder');
        if (configArea) configArea.classList.add('hidden');
        if (configPlaceholder) configPlaceholder.classList.remove('hidden');
    }

    function showConfirmationModal(title, message, onConfirm) {
      var modal = document.getElementById('confirmation-modal');
      var modalTitle = document.getElementById('modal-title');
      var modalMessage = document.getElementById('modal-message');
      
      if (modalTitle) modalTitle.textContent = title;
      if (modalMessage) modalMessage.textContent = message;
      
      if (!modal) {
        console.error('ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      var confirmBtn = document.getElementById('modal-confirm');
      var cancelBtn = document.getElementById('modal-cancel');

      if (!confirmBtn || !cancelBtn) {
        console.error('ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      var confirmHandler = function() {
        onConfirm();
        hideConfirmationModal();
        confirmBtn.removeEventListener('click', confirmHandler);
        cancelBtn.removeEventListener('click', cancelHandler);
      };

      var cancelHandler = function() {
        hideConfirmationModal();
        confirmBtn.removeEventListener('click', confirmHandler);
        cancelBtn.removeEventListener('click', cancelHandler);
      };

      confirmBtn.addEventListener('click', confirmHandler);
      cancelBtn.addEventListener('click', cancelHandler);
    }

    function hideConfirmationModal() {
      var modal = document.getElementById('confirmation-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    // å…¬é–‹ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    function showPublishConfirmDialog() {
      showConfirmationModal(
        'å›ç­”ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ',
        'ãƒ•ã‚©ãƒ¼ãƒ ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚ç”Ÿå¾’ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«å›ç­”ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ',
        function() {
          publishBoard();
        }
      );
    }
    
    // ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§å…¬é–‹ã‚’å®Ÿè¡Œ
    function publishBoard() {
      console.log('Publishing board automatically...');
      
      if (!appState.selectedSheet) {
        console.error('No sheet selected for publishing');
        return;
      }
      
      // è¡¨ç¤ºã‚’ãƒ­ãƒ¼ãƒ‰ä¸­ã«å¤‰æ›´
      showLoadingState('å…¬é–‹ä¸­...');
      
      // å…¬é–‹å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆactivateSheeté–¢æ•°ã‚’ä½¿ç”¨ï¼‰
      runGasWithUserId('activateSheetSimple', appState.selectedSheet)
        .then(function(result) {
          console.log('Board published successfully:', result);
          hideLoadingState();
          
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼‰
          cacheManager.invalidateDependents('user_data_change'); // çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
          getCachedStatus(true);
          
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          showToast('å›ç­”ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
        })
        .catch(function(error) {
          console.error('Failed to publish board:', error);
          hideLoadingState();
          showToast('å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        });
    }
    
    // è‡ªå‹•å…¬é–‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ãƒã‚§ãƒƒã‚¯ï¼ˆæ–°è¦ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ™‚ã¯è‡ªå‹•å‡¦ç†ã«ç§»è¡Œæ¸ˆã¿ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    function checkAutoPublishDialog(status) {
      // æ–°è¦ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ™‚ã¯ createAdditionalForm ã§è‡ªå‹•å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
      if (status && status.autoPublishCompleted) {
        console.log('Auto-publish already completed during form creation');
        return;
      }
      
      // æ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒ ã®æ‰‹å‹•è¨­å®šå¤‰æ›´æ™‚ã®ã¿ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      if (status && status.autoShowPublishDialog && status.readyToPublish && !status.isNewForm) {
        console.log('Showing publish dialog for existing form configuration changes');
        
        setTimeout(function() {
          showPublishConfirmDialog();
          
          // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦é‡è¤‡è¡¨ç¤ºã‚’é˜²ã
          if (appState.currentStatus) {
            appState.currentStatus.autoShowPublishDialog = false;
          }
        }, 1000);
      }
    }

    // Global appState defined in AdminPanelLogic

    // Detect jsdom test environment to disable auto-loading
    var IS_TEST_ENV = typeof navigator !== 'undefined' &&
      navigator.userAgent && navigator.userAgent.indexOf('jsdom') !== -1;

    const DEBUG_MODE = <?= typeof DEBUG_MODE !== 'undefined' ? DEBUG_MODE : false ?>;

    // AdminPanelå°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼è¡¨ç¤ºæ©Ÿèƒ½
    function showSystemFlow() {
      if (!DEBUG_MODE) return;
      
      console.group('ğŸ”„ StudyQuest ç®¡ç†ãƒ‘ãƒãƒ« ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼');
      console.log('ğŸ“‹ Phase 1: ç®¡ç†ãƒ‘ãƒãƒ«åˆæœŸåŒ–');
      console.log('  â”œâ”€ ç®¡ç†è€…æ¨©é™ç¢ºèª');
      console.log('  â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—');
      console.log('  â”œâ”€ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶š');
      console.log('  â””â”€ UIè¦ç´ åˆæœŸåŒ–');
      
      console.log('ğŸ¨ Phase 2: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹ç¯‰');
      console.log('  â”œâ”€ å·¦ãƒ‘ãƒãƒ«ï¼ˆãƒ¡ã‚¤ãƒ³æ“ä½œï¼‰');
      console.log('  â”œâ”€ å³ãƒ‘ãƒãƒ«ï¼ˆã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ï¼‰');
      console.log('  â”œâ”€ ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆå…¬é–‹URLè¡¨ç¤ºï¼‰');
      console.log('  â””â”€ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ');
      
      console.log('ğŸ“¡ Phase 3: ãƒ‡ãƒ¼ã‚¿é€£æº');
      console.log('  â”œâ”€ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—');
      console.log('  â”œâ”€ ã‚·ãƒ¼ãƒˆä¸€è¦§å–å¾—');
      console.log('  â”œâ”€ åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼è‡ªå‹•åˆ¤å®š');
      console.log('  â””â”€ å…¬é–‹çŠ¶æ…‹ç¢ºèª');
      
      console.log('ğŸ—ï¸ Phase 4: è¨­å®šUIæ§‹ç¯‰');
      console.log('  â”œâ”€ ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼');
      console.log('  â”œâ”€ ã‚·ãƒ¼ãƒˆé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³');
      console.log('  â”œâ”€ åˆ—è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ');
      console.log('  â””â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º');
      
      console.log('âš¡ Phase 5: ç®¡ç†æ©Ÿèƒ½');
      console.log('  â”œâ”€ ãƒœãƒ¼ãƒ‰ä½œæˆãƒ»å…¬é–‹');
      console.log('  â”œâ”€ è¨­å®šå¤‰æ›´');
      console.log('  â”œâ”€ URLã‚³ãƒ”ãƒ¼æ©Ÿèƒ½');
      console.log('  â””â”€ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°');
      
      console.log('ğŸ”§ Phase 6: æœ€é©åŒ–ãƒ»ç›£è¦–');
      console.log('  â”œâ”€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†');
      console.log('  â”œâ”€ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°');
      console.log('  â”œâ”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–');
      console.log('  â””â”€ ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›');
      
      console.groupEnd();
      
      // AdminPanelå›ºæœ‰ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
      console.group('ğŸ“Š ç®¡ç†ãƒ‘ãƒãƒ«ç¾åœ¨çŠ¶æ…‹');
      console.log('DOMçŠ¶æ…‹:', document.readyState);
      console.log('CSSèª­ã¿è¾¼ã¿:', document.styleSheets.length + ' stylesheets');
      console.log('GASç’°å¢ƒ:', typeof google !== 'undefined' ? 'Available' : 'Not Available');
      console.log('ç®¡ç†è€…çŠ¶æ…‹:', typeof appState.currentStatus !== 'undefined' && appState.currentStatus ? 'Authenticated' : 'Unknown');
      console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL:', typeof appState.currentSpreadsheetUrl !== 'undefined' ? (appState.currentSpreadsheetUrl ? 'Set' : 'Not Set') : 'Unknown');
      console.groupEnd();
    }

    function setLoading(isLoading, message = '') {
      const loader = document.getElementById('loading-overlay');
      const loaderMessage = document.getElementById('loading-message');
      if (!loader) return;

      if (isLoading) {
        if (loaderMessage) loaderMessage.textContent = message;
        loader.classList.remove('hidden');
      } else {
        loader.classList.add('hidden');
      }
    }

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼é–¢æ•°ç¾¤ - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã®æ®µéšçš„é€²è¡Œã‚’è¡¨ç¤º
    function showProgressStep(currentStep, totalSteps, message) {
      let progressContainer = document.getElementById('progress-container');
      
      if (!progressContainer) {
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã‚’å‹•çš„ã«ä½œæˆ
        progressContainer = document.createElement('div');
        progressContainer.id = 'progress-container';
        progressContainer.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
        progressContainer.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
            <div class="text-center mb-4">
              <h3 class="text-lg font-semibold text-gray-900">ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆé€²è¡Œä¸­</h3>
            </div>
            <div class="mb-4">
              <div class="bg-gray-200 rounded-full h-3 overflow-hidden">
                <div id="progress-bar" class="bg-blue-600 h-full transition-all duration-500 ease-out" style="width: 0%"></div>
              </div>
            </div>
            <div class="text-center">
              <p id="progress-message" class="text-sm text-gray-600"></p>
              <p class="text-xs text-gray-500 mt-2">
                ã‚¹ãƒ†ãƒƒãƒ— <span id="progress-current">1</span> / <span id="progress-total">5</span>
              </p>
            </div>
          </div>
        `;
        document.body.appendChild(progressContainer);
      }
      
      const progressBar = document.getElementById('progress-bar');
      const progressMessage = document.getElementById('progress-message');
      const progressCurrent = document.getElementById('progress-current');
      const progressTotal = document.getElementById('progress-total');
      
      if (progressBar) {
        const percentage = (currentStep / totalSteps) * 100;
        progressBar.style.width = percentage + '%';
      }
      
      if (progressMessage) progressMessage.textContent = message;
      if (progressCurrent) progressCurrent.textContent = currentStep;
      if (progressTotal) progressTotal.textContent = totalSteps;
      
      progressContainer.classList.remove('hidden');
    }

    function hideProgressBar() {
      const progressContainer = document.getElementById('progress-container');
      if (progressContainer) {
        progressContainer.classList.add('hidden');
        setTimeout(() => {
          if (progressContainer.parentNode) {
            progressContainer.parentNode.removeChild(progressContainer);
          }
        }, 500);
      }
    }

    var elements = {}; // elementsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–

    // Progressive Disclosure Functions - æ—©æœŸå®šç¾©
    function toggleSection(sectionId) {
      var section = document.getElementById(sectionId);
      var icon = document.getElementById(sectionId.replace('content', 'icon'));
      
      if (!section) return;
      
      var isExpanded = section.classList.contains('expanded');
      
      if (isExpanded) {
        section.classList.remove('expanded');
        section.classList.add('collapsed');
        if (icon) {
          if (sectionId === 'step1-content') {
            icon.style.transform = 'rotate(0deg)'; // Down arrow
          } else if (sectionId === 'step2-content' || sectionId === 'step3-content') {
            icon.style.transform = 'rotate(90deg)'; // Right arrow
          }
        }
      } else {
        section.classList.remove('collapsed');
        section.classList.add('expanded');
        if (icon) {
          if (sectionId === 'step1-content') {
            icon.style.transform = 'rotate(180deg)'; // Up arrow
          } else if (sectionId === 'step2-content' || sectionId === 'step3-content') {
            icon.style.transform = 'rotate(0deg)'; // Down arrow
          }
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      // åˆæœŸãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹ã‚’è¡¨ç¤º
      setLoading(true, 'è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...');
      
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ20ç§’ï¼‰
      var initTimeoutId = setTimeout(function() {
        setLoading(false);
        showMessage('åˆæœŸè¨­å®šã®èª­ã¿è¾¼ã¿ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'warning');
      }, 20000);
      // `elements` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å®šç¾©ã‚’ä¿®æ­£
elements = {
  // ... æ—¢å­˜ã®è¦ç´ ã¯ãã®ã¾ã¾ ...
  sheetSelect: document.getElementById('sheet-select'),
  configArea: document.getElementById('config-area'),
  configPlaceholder: document.getElementById('config-placeholder'),
  opinionHeader: document.getElementById('opinionHeader'),
  reasonHeader: document.getElementById('reasonHeader'),
  nameHeader: document.getElementById('nameHeader'),
  classHeader: document.getElementById('classHeader'),
  saveConfigBtn: document.getElementById('save-config-btn'),
  detailOptions: document.getElementById('detail-options'),
  boardUrl: document.getElementById('board-url'),
  viewBoardLink: document.getElementById('view-board-link'),
  setupProgress: document.getElementById('setup-progress'),
  setupProgressMobile: document.getElementById('setup-progress-mobile'),
  setupProgressText: document.getElementById('setup-progress-text'),
  setupProgressTextMobile: document.getElementById('setup-progress-text-mobile'),
  headerDomainName: document.getElementById('header-domain-name'),
  headerStatusDot: document.getElementById('header-status-dot'),
  headerStatusText: document.getElementById('header-status-text'),
  configStatus: document.getElementById('config-status'),
  addSpreadsheetText: document.getElementById('add-spreadsheet-text'),
  saveConfigText: document.getElementById('save-config-text'),
  createBoardBtn: document.getElementById('create-board-btn'),
  createBoardText: document.getElementById('create-board-text'),
  formUrlInput: document.getElementById('form-url-input'),
  copyFormUrlBtn: document.getElementById('copy-form-url-btn'),
  openFormUrlLink: document.getElementById('open-form-url-link'),
  editFormUrlLink: document.getElementById('edit-form-url-link'),
  openSpreadsheetBtn: document.getElementById('open-spreadsheet-btn'),
  addSpreadsheetBtn: document.getElementById('add-spreadsheet-btn'),
  guidanceText: document.getElementById('guidance-text'),
  // æ–°ã—ã„ã‚·ãƒ¼ãƒˆè©³ç´°è¦ç´ 
  sheetDetails: document.getElementById('sheet-details'),
  sheetColumns: document.getElementById('sheet-columns'),
  spreadsheetLink: document.getElementById('spreadsheet-link'),
  formLink: document.getElementById('form-link'),
  
  // â˜…â˜…â˜… ã“ã“ã‹ã‚‰è¿½åŠ  â˜…â˜…â˜…
  // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ãƒ‘ãƒãƒ«ã®è¦ç´ 
  'info-admin-email': document.getElementById('info-admin-email'),
  'info-user-id': document.getElementById('info-user-id'),
  'info-published-sheet': document.getElementById('info-published-sheet'),
  'info-answer-count': document.getElementById('info-answer-count'),
  'info-reaction-count': document.getElementById('info-reaction-count'),
  'delete-account-btn': document.getElementById('delete-account-btn'),
  
  // æ–°ã—ã„UIè¦ç´ 
  'info-publish-status': document.getElementById('info-publish-status'),
  'info-publish-indicator': document.getElementById('info-publish-indicator'),
  'info-publish-text': document.getElementById('info-publish-text'),
  'info-display-mode': document.getElementById('info-display-mode'),
  'info-show-counts': document.getElementById('info-show-counts'),
  'open-form-btn': document.getElementById('open-form-btn'),
  'open-linked-form-btn': document.getElementById('open-linked-form-btn'),
  
  // çµ±åˆãƒ•ãƒƒã‚¿ãƒ¼è¦ç´ 
  adminFooter: document.getElementById('admin-footer'),
  currentTopicText: document.getElementById('current-topic-text')
  // â˜…â˜…â˜… ã“ã“ã¾ã§è¿½åŠ  â˜…â˜…â˜…
};
      // AppSetupPageãƒªãƒ³ã‚¯ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
      var appSetupLink = document.getElementById('app-setup-link');
      var accountDeletionSection = document.getElementById('account-deletion-section');
      
      console.log('Display control - isSystemAdmin:', window.isSystemAdmin);
      console.log('Display control - appSetupLink element:', appSetupLink);
      console.log('Display control - accountDeletionSection element:', accountDeletionSection);

      if (window.isSystemAdmin) {
        // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®å ´åˆï¼šAppSetupPageãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºã€å‰Šé™¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        if (appSetupLink) {
          appSetupLink.style.display = 'block';
          console.log('âœ… AppSetupPage link shown for deploy user');
        }
        if (accountDeletionSection) {
          accountDeletionSection.style.display = 'none';
          console.log('âœ… Account deletion section hidden for deploy user');
        }
      } else {
        // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆï¼šAppSetupPageãƒªãƒ³ã‚¯ã‚’éè¡¨ç¤ºã€å‰Šé™¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        if (appSetupLink) {
          appSetupLink.style.display = 'none';
          console.log('â„¹ï¸ AppSetupPage link hidden for non-deploy user');
        }
        if (accountDeletionSection) {
          accountDeletionSection.style.display = 'block';
          console.log('â„¹ï¸ Account deletion section shown for non-deploy user');
        }
      }
      if (!IS_TEST_ENV) {
        showSystemFlow(); // ãƒ‡ãƒãƒƒã‚°ãƒ•ãƒ­ãƒ¼è¡¨ç¤º
        loadStatus();
        adjustLayout();
        loadAdminDomainInfo();
      }
      setupEventListeners();
      
      // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
      startSystemStatusUpdate();
      
      // åˆæœŸãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
      setTimeout(function() {
        clearTimeout(initTimeoutId);
        setLoading(false);
      }, 1000);
    });
    // ===== çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  =====
    class FrontendCacheManager {
      constructor() {
        this.caches = new Map();
        this.defaultTTL = 30000; // 30ç§’
        this.dependencies = new Map();
        this._initializeDependencies();
      }
      
      _initializeDependencies() {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¾å­˜é–¢ä¿‚ã®å®šç¾©
        this.dependencies.set('user_data_change', ['status', 'userInfo', 'formUrls']);
        this.dependencies.set('form_creation', ['status', 'formUrls', 'sheetDetails']);
        this.dependencies.set('config_change', ['status', 'sheetDetails']);
      }
      
      get(key, defaultValue = null) {
        const cached = this.caches.get(key);
        if (!cached) return defaultValue;
        
        const now = Date.now();
        if (now - cached.timestamp > cached.ttl) {
          this.caches.delete(key);
          console.log(`ğŸ“Š [Cache] Expired and removed: ${key}`);
          return defaultValue;
        }
        
        console.log(`ğŸ“Š [Cache] Hit: ${key}`);
        return cached.value;
      }
      
      set(key, value, ttl = null) {
        this.caches.set(key, {
          value: value,
          timestamp: Date.now(),
          ttl: ttl || this.defaultTTL
        });
        console.log(`ğŸ“Š [Cache] Set: ${key} (TTL: ${ttl || this.defaultTTL}ms)`);
      }
      
      invalidate(key) {
        this.caches.delete(key);
        console.log(`ğŸ“Š [Cache] Invalidated: ${key}`);
      }
      
      invalidatePattern(pattern) {
        let count = 0;
        for (const key of this.caches.keys()) {
          if (key.includes(pattern)) {
            this.caches.delete(key);
            count++;
          }
        }
        console.log(`ğŸ“Š [Cache] Invalidated ${count} entries matching pattern: ${pattern}`);
      }
      
      invalidateDependents(changeType) {
        const dependents = this.dependencies.get(changeType);
        if (!dependents) return;
        
        dependents.forEach(key => this.invalidate(key));
        console.log(`ğŸ”„ [Cache] Cascade invalidation: ${changeType} -> [${dependents.join(', ')}]`);
      }
      
      clear() {
        const count = this.caches.size;
        this.caches.clear();
        console.log(`ğŸ–¾ï¸ [Cache] Cleared all ${count} entries`);
      }
      
      getStats() {
        return {
          totalEntries: this.caches.size,
          dependencies: this.dependencies.size
        };
      }
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    const cacheManager = new FrontendCacheManager();

    /**
     * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
     * @param {boolean} forceRefresh - å¼·åˆ¶çš„ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã™ã‚‹ã‹ã©ã†ã‹
     * @returns {Promise} ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±
     */
    function getCachedStatus(forceRefresh = false) {
      const cacheKey = 'status';
      
      // çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ãƒã‚§ãƒƒã‚¯
      if (!forceRefresh) {
        const cached = cacheManager.get(cacheKey);
        if (cached) {
          return Promise.resolve(cached);
        }
      }
      
      console.log('ğŸ“Š Status cache miss, fetching from server');
      return runGasWithUserId('getStatus', forceRefresh)
        .then(function(status) {
          cacheManager.set(cacheKey, status);
          return status;
        })
        .catch(function(error) {
          console.error('âš ï¸ [Cache] Failed to fetch status:', error);
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã“ã¨ã‚‚è€ƒæ…®
          const staleData = cacheManager.get(cacheKey + '_stale');
          if (staleData) {
            console.log('ğŸ“Š [Cache] Returning stale data due to fetch error');
            return staleData;
          }
          throw error;
        });
    }

    // ===== å…±é€šãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±å‡¦ç†é–¢æ•° =====
    // AdminPanel.html ã¨ Registration.html ã§å…±é€šä½¿ç”¨
    
    /**
     * ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹å…±é€šé–¢æ•°
     * @param {Function} onSuccess - æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
     * @param {Function} onError - ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
     */
    function loadDomainInfo(onSuccess, onError) {
      callWithCache('getDeployUserDomainInfo', 'domain_info', 60000)
        .then(function(info) {
          displayDomainInfo(info);
          if (onSuccess) onSuccess(info);
        })
        .catch(function(error) {
          console.error('ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
          displayDomainInfo({ error: error.message || error });
          if (onError) onError(error);
        });
    }

    /**
     * ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹å…±é€šé–¢æ•°
     * @param {Object} info - ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function displayDomainInfo(info) {
      var headerDomainMatch = document.getElementById('header-domain-match');
      var headerDomainMismatch = document.getElementById('header-domain-mismatch');
      var headerDomainInitial = document.getElementById('header-domain-initial');
      var headerDomainMatchText = document.getElementById('header-domain-match-text');
      var headerDomainMismatchText = document.getElementById('header-domain-mismatch-text');

      // å…¨ã¦ã®è¡¨ç¤ºã‚’ä¸€æ—¦éè¡¨ç¤ºã«ã™ã‚‹
      if (headerDomainMatch) headerDomainMatch.classList.add('hidden');
      if (headerDomainMismatch) headerDomainMismatch.classList.add('hidden');
      if (headerDomainInitial) headerDomainInitial.classList.add('hidden');
      
      if (!info || info.error) {
        console.warn('ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚¨ãƒ©ãƒ¼:', info && info.error ? info.error : 'Unknown error');
        if (headerDomainInitial) headerDomainInitial.classList.remove('hidden');
        return;
      }

      if (info.isDomainMatch) {
        // ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒä¸€è‡´ã—ã¦ã„ã‚‹å ´åˆ
        if (headerDomainMatch && headerDomainMatchText) {
          headerDomainMatch.classList.remove('hidden');
          if (info.deployDomain) {
            headerDomainMatchText.textContent = info.deployDomain + ' ãƒ‰ãƒ¡ã‚¤ãƒ³';
          } else {
            headerDomainMatchText.textContent = 'ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹';
          }
        }
      } else {
        // ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸ä¸€è‡´ã®å ´åˆ
        if (headerDomainMismatch && headerDomainMismatchText) {
          headerDomainMismatch.classList.remove('hidden');
          headerDomainMismatchText.textContent = info.currentDomain;
        }
      }
    }

    // AdminPanelå°‚ç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
    function loadAdminDomainInfo() {
      loadDomainInfo();
    }

    function displayAdminDomainInfo(info) {
      displayDomainInfo(info);
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—ãƒ™ãƒ¼ã‚¹ã®UIåˆæœŸåŒ–
    function initializeStepBasedUI() {
      // ã‚¹ãƒ†ãƒƒãƒ—1ã®ã¿é–‹ãã€ã‚¹ãƒ†ãƒƒãƒ—2ãƒ»3ã¯é–‰ã˜ã‚‹ï¼ˆæ—¢ã«HTMLã§è¨­å®šæ¸ˆã¿ï¼‰
      // Initialization complete - UI state already set in HTML
    }

    // é‡è¤‡ã—ã¦ã„ãŸDOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
    // æ—¢ã«ä¸Šè¨˜ã§è¨­å®šæ¸ˆã¿

    // `setupEventListeners` é–¢æ•°ã®ä¸­ã«ã“ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
function setupEventListeners() {
  // ... æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã¯ãã®ã¾ã¾ ...
  window.addEventListener('resize', adjustLayout);
  // Sheet selection
      if (elements.sheetSelect) {
        elements.sheetSelect.addEventListener('change', function(e) {
          appState.selectedSheet = e.target.value;
          
          // selectedSheetãŒæ–‡å­—åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
          if (typeof appState.selectedSheet !== 'string' || appState.selectedSheet === '[object Object]') {
            console.error('selectedSheetãŒç„¡åŠ¹ã§ã™:', appState.selectedSheet);
            console.error('é¸æŠã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³:', e.target.options[e.target.selectedIndex]);
            return;
          }
          
          updateUIForSelectedSheet();
          
          // å…¬é–‹ä¸­ã®ã‚·ãƒ¼ãƒˆã®å ´åˆã¯åˆ—æƒ…å ±ã®èª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—
          if (!(appState.currentStatus && appState.currentStatus.appPublished &&
                (appState.selectedSheet === appState.currentActiveSheet || appState.selectedSheet === appState.currentStatus.publishedSheetName))) {
            loadConfigForSelected();
          }
        });
      }

      // â˜…â˜…â˜… ã“ã“ã‹ã‚‰è¿½åŠ  â˜…â˜…â˜…
      var reguessBtn = document.getElementById('reguess-headers-btn');
      if (reguessBtn) {
        reguessBtn.addEventListener('click', runHeaderGuessing);
      }
      // â˜…â˜…â˜… ã“ã“ã¾ã§è¿½åŠ  â˜…â˜…â˜…

      // Actions
      
      if (elements.clearSelectionBtn) {
        elements.clearSelectionBtn.addEventListener('click', clearSheetSelection);
      }
      // æ–°ã—ã„ä¿å­˜ãƒ»å…¬é–‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      var savePublishBtn = document.getElementById('save-publish-btn');
      if (savePublishBtn) {
        savePublishBtn.addEventListener('click', function() {
          showConfirmationModal(
            'è¨­å®šã®ä¿å­˜ã¨å…¬é–‹',
            'ç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜ã—ã€å›ç­”ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
            saveAndPublish
          );
        });
      }
      
      // å…¬é–‹åœæ­¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      var unpublishBtn = document.getElementById('unpublish-board-btn');
      if (unpublishBtn) {
        unpublishBtn.addEventListener('click', function() {
          showConfirmationModal(
            'å…¬é–‹ã‚’åœæ­¢',
            'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ã—ã¾ã™ã€‚ã“ã®æ“ä½œã«ã‚ˆã‚Šã€ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚ç¶™ç¶šã—ã¾ã™ã‹ï¼Ÿ',
            unpublishBoard
          );
        });
      }
      
      // å…¨ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      var deleteAllResourcesBtn = document.getElementById('delete-all-resources-btn');
      if (deleteAllResourcesBtn) {
        deleteAllResourcesBtn.addEventListener('click', function() {
          showConfirmationModal(
            'å…¨ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤',
            'âš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ã€‚\n\nãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®ä»¥ä¸‹ã®æƒ…å ±ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ï¼š\nãƒ» ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±\nãƒ» ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±\nãƒ» è¨­å®šæƒ…å ±\nãƒ» å…¬é–‹çŠ¶æ…‹\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
            deleteAllResources
          );
        });
      }
      
      var addResourceBtn = document.getElementById('add-resource-btn');
      if (addResourceBtn) {
        addResourceBtn.addEventListener('click', addResource);
      }
      
      // Legacy spreadsheet management (keep for compatibility)
      var addSpreadsheetBtn = document.getElementById('add-spreadsheet-btn');
      if (addSpreadsheetBtn) {
        addSpreadsheetBtn.addEventListener('click', addSpreadsheet);
      }
      
      // Create board events
      if (elements.createBoardBtn) {
        elements.createBoardBtn.addEventListener('click', createAdditionalForm);
      }
      
      var quickCreateBtn = document.getElementById('quick-create-board-btn');
      if (quickCreateBtn) {
        quickCreateBtn.addEventListener('click', createBoard);
      }
      
      // è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³
      var createAdditionalFormBtn = document.getElementById('create-additional-form-btn');
      if (createAdditionalFormBtn) {
        createAdditionalFormBtn.addEventListener('click', function() {
          showFormConfigModal();
        });
      }

      // ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      var formConfigClose = document.getElementById('form-config-close');
      var formConfigCancel = document.getElementById('form-config-cancel');
      var formConfigCreate = document.getElementById('form-config-create');
      var mainQuestionType = document.getElementById('main-question-type');

      if (formConfigClose) {
        formConfigClose.addEventListener('click', hideFormConfigModal);
      }
      if (formConfigCancel) {
        formConfigCancel.addEventListener('click', hideFormConfigModal);
      }
      if (formConfigCreate) {
        formConfigCreate.addEventListener('click', createFormWithConfig);
      }

      // è³ªå•ã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®å‡¦ç†
      if (mainQuestionType) {
        mainQuestionType.addEventListener('change', function() {
          const choicesDiv = document.getElementById('main-question-choices-div');
          if (this.value === 'multiple' || this.value === 'choice') {
            choicesDiv.classList.remove('hidden');
          } else {
            choicesDiv.classList.add('hidden');
          }
        });
      }

      // ã‚¯ãƒ©ã‚¹é¸æŠã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
      var enableClassSelection = document.getElementById('enable-class-selection');
      if (enableClassSelection) {
        enableClassSelection.addEventListener('change', function() {
          const classChoicesContainer = document.getElementById('class-choices-container');
          if (this.checked) {
            classChoicesContainer.classList.remove('hidden');
          } else {
            classChoicesContainer.classList.add('hidden');
          }
        });
      }

      var refreshBoardBtn = document.getElementById('refresh-board-btn');
      if (refreshBoardBtn) {
        refreshBoardBtn.addEventListener('click', refreshBoardDataFromAdmin);
      }
      
      // Display options
      if (elements.detailOptions) {
        elements.detailOptions.addEventListener('change', function(e) {
          if (e.target.name === 'showNames' || e.target.name === 'showCounts') {
            updateConfigButtons(); // è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
          }
        });
      }
      
      // Auto-update config when headers change
      if (elements.opinionHeader) {
        elements.opinionHeader.addEventListener('change', updateConfigButtons);
      }
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š
      setupRealtimeValidation();
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š
      setupRealtimeValidation();
      
      // Digital citizenship button event
      var digitalCitizenshipBtn = document.getElementById('digital-citizenship-btn');
      if (digitalCitizenshipBtn) {
        digitalCitizenshipBtn.addEventListener('click', showDigitalCitizenshipModal);
      }
      
      // Teacher guide modal events
      var teacherGuideConfirmBtn = document.getElementById('teacherGuideConfirmBtn');
      if (teacherGuideConfirmBtn) {
        teacherGuideConfirmBtn.addEventListener('click', hideTeacherGuideModal);
      }
      
      // Digital citizenship guide button
      var showDigitalCitizenshipBtn = document.getElementById('show-digital-citizenship-guide');
      if (showDigitalCitizenshipBtn) {
        showDigitalCitizenshipBtn.addEventListener('click', function() {
          var modal = document.getElementById('digital-citizenship-modal');
          if (modal) {
            modal.classList.remove('hidden');
          }
        });
      }
      
      // Usage guide button
      var showUsageGuideBtn = document.getElementById('show-usage-guide');
      if (showUsageGuideBtn) {
        showUsageGuideBtn.addEventListener('click', function() {
          var modal = document.getElementById('usage-guide-modal');
          if (modal) {
            modal.classList.remove('hidden');
          }
        });
      }
      
      // Digital citizenship modal close events
      var digitalCitizenshipCloseBtn = document.getElementById('digital-citizenship-modal-close');
      var digitalCitizenshipCloseBtnBottom = document.getElementById('digital-citizenship-modal-close-btn');
      
      if (digitalCitizenshipCloseBtn) {
        digitalCitizenshipCloseBtn.addEventListener('click', function() {
          var modal = document.getElementById('digital-citizenship-modal');
          if (modal) {
            modal.classList.add('hidden');
          }
        });
      }
      
      if (digitalCitizenshipCloseBtnBottom) {
        digitalCitizenshipCloseBtnBottom.addEventListener('click', function() {
          var modal = document.getElementById('digital-citizenship-modal');
          if (modal) {
            modal.classList.add('hidden');
          }
        });
      }
      
      var openSpreadsheetBtn = document.getElementById('open-spreadsheet-btn');
      if (openSpreadsheetBtn) {
        openSpreadsheetBtn.addEventListener('click', openDatabaseSpreadsheet);
      }

      // Add event listener for the step2 spreadsheet button
      var openSpreadsheetBtnStep2 = document.getElementById('open-spreadsheet-btn-step2');
      if (openSpreadsheetBtnStep2) {
        openSpreadsheetBtnStep2.addEventListener('click', openDatabaseSpreadsheet);
      }

      var openFormBtn = document.getElementById('open-form-btn');
      if (openFormBtn) {
        openFormBtn.addEventListener('click', openForm);
      }

      // Open linked form button event listener
      if (elements['open-linked-form-btn']) {
        elements['open-linked-form-btn'].addEventListener('click', openLinkedForm);
      }

  // â˜…â˜…â˜… ã“ã“ã‹ã‚‰è¿½åŠ  â˜…â˜…â˜…
  if (elements['delete-account-btn']) {
    elements['delete-account-btn'].addEventListener('click', handleDeleteRequest);
  }
  
  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  var securityInfoBtn = document.getElementById('security-info-btn');
  var securityModal = document.getElementById('security-modal');
  var securityModalClose = document.getElementById('security-modal-close');
  var securityModalConfirm = document.getElementById('security-modal-confirm');
  
  if (securityInfoBtn && securityModal) {
    securityInfoBtn.addEventListener('click', function() {
      securityModal.classList.remove('hidden');
    });
  }
  
  if (securityModalClose && securityModal) {
    securityModalClose.addEventListener('click', function() {
      securityModal.classList.add('hidden');
    });
  }
  
  if (securityModalConfirm && securityModal) {
    securityModalConfirm.addEventListener('click', function() {
      securityModal.classList.add('hidden');
    });
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  if (securityModal) {
    securityModal.addEventListener('click', function(e) {
      if (e.target === securityModal) {
        securityModal.classList.add('hidden');
      }
    });
  }
  
  // â˜…â˜…â˜… ã“ã“ã¾ã§è¿½åŠ  â˜…â˜…â˜…
}

// â˜…â˜…â˜… ä»¥ä¸‹ã®2ã¤ã®é–¢æ•°ã‚’æ–°ã—ãè¿½åŠ  â˜…â˜…â˜…

/**
 * ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆ2é‡ãƒã‚§ãƒƒã‚¯ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
 */
function handleDeleteRequest() {
  // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æœ€åˆã«è¡¨ç¤º
  showPrivacyModal(function() {
    // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ç¢ºèªå¾Œã€å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    showConfirmationModal(
      'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å®Œå…¨å‰Šé™¤',
      'æœ¬å½“ã«ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ãšã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ã€‚',
      function() {
        setLoading(true, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã„ã¾ã™...');
        runGasWithUserId('deleteCurrentUserAccount')
          .then(function(response) {
            setLoading(false);
            showMessage(response, 'success');
            setTimeout(function() {
              // Use iframe-safe navigation
              if (window.sharedUtilities && window.sharedUtilities.navigation) {
                window.sharedUtilities.navigation.safeNavigate('?page=Registration', {
                  fallbackMessage: 'ç™»éŒ²ãƒšãƒ¼ã‚¸ã«ç§»å‹•ä¸­...',
                  method: 'auto'
                });
              } else {
                window.location.href = '?page=Registration';
              }
            }, 2000);
          })
          .catch(function(error) {
            setLoading(false);
            showError(error);
          });
      }
    );
  });
}

// showPrivacyModal function removed - using the one defined earlier in the file


/**
 * UIè¦ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å®‰å…¨ã«è¨­å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 * @param {string} elementId - è¦ç´ ã®ID
 * @param {string} value - è¨­å®šã™ã‚‹å€¤
 * @param {string} prefix - ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 */
function safeSetText(elementId, value, prefix = '') {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = value ? prefix + value : '-';
    console.log(`âœ… [DEBUG] Updated ${elementId}:`, element.textContent);
  } else {
    console.warn(`âŒ [DEBUG] Element not found: ${elementId}`);
  }
}

/**
 * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸstatusã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å…ƒã«ã€ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ãƒ‘ãƒãƒ«ã‚’æ›´æ–°ã—ã¾ã™ã€‚
 * @param {object} status - getStatusã‹ã‚‰è¿”ã•ã‚Œã‚‹å®Œå…¨ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function updateDatabaseInfo(status) {
  console.log('ğŸ”§ [DEBUG] updateDatabaseInfo called with status:', status);
  
  if (!status || !status.userInfo) {
    console.warn('ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’æ›´æ–°ã§ãã¾ã›ã‚“ã§ã—ãŸ: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', status);
    return;
  }

  console.log('âœ… [DEBUG] User info found, updating system panel:', status.userInfo);

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’è¨­å®š
  if (status.userInfo.spreadsheetUrl) {
    appState.currentSpreadsheetUrl = status.userInfo.spreadsheetUrl;
    console.log('âœ… [DEBUG] currentSpreadsheetUrl set to:', appState.currentSpreadsheetUrl);
  }

  // æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
  safeSetText('info-admin-email', status.userInfo.adminEmail);
  safeSetText('info-user-id', status.userInfo.userId);
  // å…¬é–‹ã‚·ãƒ¼ãƒˆåã®è¡¨ç¤ºï¼ˆè¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹ï¼‰
  let publishedSheetName = status.publishedSheetName || status.activeSheetName;
  if (!publishedSheetName && status.userInfo && status.userInfo.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      publishedSheetName = config.publishedSheetName;
    } catch (e) {
      console.warn('ConfigJSON parse error in published sheet name:', e);
    }
  }
  safeSetText('info-published-sheet', publishedSheetName || 'ãªã—');
  safeSetText('info-answer-count', status.answerCount || '0');
  safeSetText('info-reaction-count', status.totalReactions || '0');

  // æ–°ã—ã„UIè¦ç´ ã‚’æ›´æ–°
  
  // å…¬é–‹çŠ¶æ…‹ã®æ›´æ–°ï¼ˆè¤‡æ•°ã®åˆ¤å®šæ–¹æ³•ã‚’è©¦ã™ï¼‰
  const isPublished = status && (
    status.isPublished || 
    status.appPublished || 
    (status.publishedSheetName && status.publishedSheetName !== 'ãªã—')
  );
  updatePublicationStatusUI(isPublished);

  // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®æ›´æ–°
  const displayMode = status.showNames ? 'åå‰è¡¨ç¤º' : 'åŒ¿åè¡¨ç¤º';
  safeSetText('info-display-mode', displayMode);

  // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã®æ›´æ–°
  const showCounts = status.showCounts !== undefined ? (status.showCounts ? 'è¡¨ç¤º' : 'éè¡¨ç¤º') : 'è¡¨ç¤º';
  safeSetText('info-show-counts', showCounts);
  
  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åŒæœŸ
  syncCheckboxStates(status);

  // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
  const openSpreadsheetBtns = document.querySelectorAll('#open-spreadsheet-btn, #open-spreadsheet-btn-step2');
  const openFormBtn = document.getElementById('open-form-btn');
  
  openSpreadsheetBtns.forEach(btn => {
    if (btn) {
      const hasSpreadsheetUrl = status.userInfo && status.userInfo.spreadsheetUrl;
      btn.disabled = !hasSpreadsheetUrl;
      if (hasSpreadsheetUrl) {
        btn.title = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã';
      } else {
        btn.title = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
      }
    }
  });
  
  if (openFormBtn) {
    const formUrl = status.formUrl || (status.userInfo && status.userInfo.formUrl);
    const hasFormUrl = formUrl && formUrl.trim() !== "";
    openFormBtn.disabled = !hasFormUrl;
    if (hasFormUrl) {
      openFormBtn.title = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
    } else {
      openFormBtn.title = 'ãƒ•ã‚©ãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
    }
  }

  // Update open-linked-form-btn state based on formUrl availability
  const openLinkedFormBtn = elements['open-linked-form-btn'];
  if (openLinkedFormBtn) {
    const hasFormUrl = status.formUrl && status.formUrl.trim() !== '';
    openLinkedFormBtn.disabled = !hasFormUrl;
    if (hasFormUrl) {
      openLinkedFormBtn.title = 'é€£æºã—ã¦ã„ã‚‹Googleãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ãã¾ã™';
    } else {
      openLinkedFormBtn.title = 'é€£æºã—ã¦ã„ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
    }
  }
}

function updatePublicationStatusUI(isPublished) {
  const statusIndicator = document.getElementById('info-publish-indicator');
  const statusText = document.getElementById('info-publish-text');
  const unpublishBtn = document.getElementById('unpublish-board-btn');
  const savePublishBtn = document.getElementById('save-publish-btn');

  if (isPublished) {
    if (statusIndicator) {
      statusIndicator.classList.remove('bg-gray-400');
      statusIndicator.classList.add('bg-green-400');
    }
    if (statusText) statusText.textContent = 'å…¬é–‹ä¸­';
    if (unpublishBtn) unpublishBtn.classList.remove('hidden');
    if (savePublishBtn) savePublishBtn.textContent = 'è¨­å®šã‚’æ›´æ–°ã—ã¦å†å…¬é–‹';
  } else {
    if (statusIndicator) {
      statusIndicator.classList.remove('bg-green-400');
      statusIndicator.classList.add('bg-gray-400');
    }
    if (statusText) statusText.textContent = 'éå…¬é–‹';
    if (unpublishBtn) unpublishBtn.classList.add('hidden');
    if (savePublishBtn) savePublishBtn.textContent = 'è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹';
  }
}

// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åŒæœŸã™ã‚‹é–¢æ•°
function syncCheckboxStates(status) {
  // è¨­å®šãƒ‡ãƒ¼ã‚¿ã®å„ªå…ˆé †ä½: å…¬é–‹ã‚·ãƒ¼ãƒˆè¨­å®š > ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š > ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  const activeSheetName = status.activeSheetName || status.publishedSheetName;
  const sheetConfig = activeSheetName && status.systemStatus ? 
    status.systemStatus[`sheet_${activeSheetName}`] : null;
  
  // showNames ã®å€¤ã‚’æ±ºå®š
  const showNames = sheetConfig?.showNames !== undefined ? 
    sheetConfig.showNames : 
    (status.showNames !== undefined ? status.showNames : false);
    
  // showCounts ã®å€¤ã‚’æ±ºå®š
  const showCounts = sheetConfig?.showCounts !== undefined ? 
    sheetConfig.showCounts : 
    (status.showCounts !== undefined ? status.showCounts : false);
  
  const showNamesCheckbox = document.getElementById('showNames');
  const showCountsCheckbox = document.getElementById('showCounts');

  if (showNamesCheckbox) showNamesCheckbox.checked = showNames;
  if (showCountsCheckbox) showCountsCheckbox.checked = showCounts;
  
  console.log('ğŸ”‚ [DEBUG] Checkbox sync:', {
    activeSheetName,
    sheetConfig,
    showNames,
    showCounts,
    globalShowNames: status.showNames,
    globalShowCounts: status.showCounts
  });
}

    /**
     * ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã€ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ã¦UIã«åæ˜ ã™ã‚‹
     * @param {boolean} forceRefresh - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡è¦–ã—ã¦å¼·åˆ¶çš„ã«å†å–å¾—ã™ã‚‹ã‹
     */
    async function loadStatus(forceRefresh = false) {
      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: çŸ­æ™‚é–“å†…ã®é€£ç¶šå‘¼ã³å‡ºã—ã‚’é˜²ãã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
      const now = Date.now();
      const cooldownPeriod = 2000; // 2ç§’ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
      
      if (!forceRefresh && loadStatus.lastCall && (now - loadStatus.lastCall) < cooldownPeriod) {
        console.log('âœ… loadStatus: ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã®ãŸã‚å‘¼ã³å‡ºã—ã‚’ã‚¹ã‚­ãƒƒãƒ—');
        return appState.currentStatus;
      }
      
      loadStatus.lastCall = now;
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹æ‰‹å‹•æ›´æ–°ã®å ´åˆã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¨˜éŒ²
      updateUserActivity();
      
      setLoading(true, 'æœ€æ–°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
      
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’å®šç¾©
      const cacheKey = 'status_' + (appState.userId || 'guest');
      const cacheTime = 60000; // 60ç§’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      
      if (forceRefresh) {
        // å¼·åˆ¶æ›´æ–°æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
        if (typeof unifiedCache !== 'undefined') {
          unifiedCache.delete(cacheKey);
        }
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ï¼ˆå¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼‰
        try {
          const status = await getCachedStatus(true);
          console.log('âœ… Status loaded (forced refresh)', status);
          updateUIWithNewStatus(status);
          setLoading(false);
          return status;
        } catch (error) {
          console.error('âŒ getCachedStatus failed:', error);
          handleError(error, 'loadStatus');
          setLoading(false);
          throw error;
        }
      } else {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ï¼ˆé€šå¸¸èª­ã¿è¾¼ã¿ï¼‰
        try {
          const status = await getCachedStatus(false);
          console.log('âœ… Status loaded (cached)', status);
          updateUIWithNewStatus(status);
          setLoading(false);
          return status;
        } catch (error) {
          handleError(error, 'loadStatus');
          setLoading(false);
          throw error;
        }
      }
    }

    /**
     * æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§UIå…¨ä½“ã‚’æ›´æ–°ã™ã‚‹
     * @param {object} status - getStatusã‹ã‚‰è¿”ã•ã‚Œã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function updateUIWithNewStatus(status) {
      appState.currentStatus = status;
      
      // 1. é™çš„ãªUIè¦ç´ ã®æ›´æ–°
      updateStaticUI(status);
      console.log('âœ… [2/3] Static UI Updated');

      // 2. å‹•çš„ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨æœ€çµ‚çš„ãªUIèª¿æ•´
      if (status.activeSheetName) {
        updateDynamicContent(status);
      } else {
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚·ãƒ¼ãƒˆãŒãªã„å ´åˆã®å‡¦ç†
        updateUIForNoActiveSheet(status);
        console.log('âœ… [3/3] No active sheet - UI update completed');
      }
    }

    /**
     * ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚·ãƒ¼ãƒˆãŒãªã„å ´åˆã«UIã‚’æ›´æ–°ã™ã‚‹
     * @param {object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function updateUIForNoActiveSheet(status) {
      // è¨­å®šã‚¨ãƒªã‚¢ã‚’éš ã™
      hideConfigArea();
      
      // ãƒ•ãƒƒã‚¿ãƒ¼ã¨ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’æ›´æ–°
      updateFooterAndGuidance(status);
      
      // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
      updateStepIndicators(status.setupStep);
      
      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
      updateSectionVisibility(status.setupStep);
      
      setLoading(false);
    }

    /**
     * é™çš„ãªUIè¦ç´ ï¼ˆã‚·ãƒ¼ãƒˆé¸æŠã‚„ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ãªã©ï¼‰ã‚’æ›´æ–°ã™ã‚‹
     * @param {object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function updateStaticUI(status) {
      // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã‚’æ›´æ–°
      updateDatabaseInfo(status);
      
      // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
      updateExistingUserSection(status);
      
      // ã‚·ãƒ¼ãƒˆé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
      populateSheetSelect(status.allSheets, status.activeSheetName);
      
      // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’è¡¨ç¤º
      updateCustomFormInfo(status);
      
      // ãƒ•ã‚©ãƒ¼ãƒ URLè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’æ›´æ–°
      updateFormUrlSection(status);
      
      // è‡ªå‹•å…¬é–‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ãƒã‚§ãƒƒã‚¯
      checkAutoPublishDialog(status);
    }

    /**
     * ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹
     * @param {object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function updateCustomFormInfo(status) {
      const customFormInfoSection = document.getElementById('custom-form-info-section');
      
      if (!customFormInfoSection) {
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆï¼ˆå°†æ¥çš„ãªæ‹¡å¼µç”¨ï¼‰
        return;
      }
      
      // customFormInfo ã¯ opinionHeader ã«çµ±ä¸€ã—ãŸãŸã‚ã€ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å¸¸ã«éè¡¨ç¤º
      customFormInfoSection.classList.add('hidden');
    }

    /**
     * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * ãƒ•ã‚©ãƒ¼ãƒ URLè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹
     * @param {object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function updateFormUrlSection(status) {
      const formUrlSection = document.getElementById('form-url-section');
      const formUrlInput = elements.formUrlInput;
      const copyFormUrlBtn = elements.copyFormUrlBtn;
      const openFormUrlLink = elements.openFormUrlLink;
      const editFormUrlLink = elements.editFormUrlLink;
      
      if (!formUrlSection || !formUrlInput) {
        return;
      }
      
      // formURLã‚’è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹ï¼ˆæœ€æ–°ã®ã‚‚ã®ã‚’å„ªå…ˆï¼‰
      console.log('ğŸ” [DEBUG] updateFormUrlSection called with status:', {
        hasStatusFormUrl: !!status.formUrl,
        statusFormUrl: status.formUrl,
        hasUserInfo: !!status.userInfo,
        hasConfigJson: !!(status.userInfo && status.userInfo.configJson)
      });
      
      let formUrl = null;
      
      // 1. statusã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆæœ€æ–°ï¼‰
      if (status.formUrl) {
        formUrl = status.formUrl;
        console.log('âœ… [DEBUG] Using formUrl from status:', formUrl);
      }
      // 2. userInfo.configJsonã‹ã‚‰å–å¾—
      else if (status.userInfo && status.userInfo.configJson) {
        try {
          const config = JSON.parse(status.userInfo.configJson);
          formUrl = config.formUrl;
          console.log('âœ… [DEBUG] Retrieved formUrl from configJson:', formUrl);
          console.log('ğŸ” [DEBUG] Full config data:', {
            hasFormUrl: !!config.formUrl,
            hasEditFormUrl: !!config.editFormUrl,
            lastFormCreatedAt: config.lastFormCreatedAt
          });
        } catch (e) {
          console.warn('ConfigJSON parse error:', e);
        }
      }
      // 3. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      else if (status.userInfo && status.userInfo.formUrl) {
        formUrl = status.userInfo.formUrl;
        console.log('âœ… [DEBUG] Using formUrl from userInfo:', formUrl);
      }
      const hasFormUrl = formUrl && formUrl.trim() !== '';
      
      if (hasFormUrl) {
        // ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚ã‚‹å ´åˆã€è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºã—ã¦URLã‚’è¨­å®š
        formUrlInput.value = formUrl;
        formUrlSection.classList.remove('hidden');
        
        // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®è¨­å®š
        if (copyFormUrlBtn) {
          copyFormUrlBtn.onclick = function() {
            formUrlInput.select();
            formUrlInput.setSelectionRange(0, 99999); // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
            
            try {
              document.execCommand('copy');
              showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
            } catch (err) {
              console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
              showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
          };
        }
        
        // å¤–éƒ¨ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ã®è¨­å®š
        if (openFormUrlLink) {
          openFormUrlLink.href = formUrl;
        }
        
        // ç·¨é›†ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ã®è¨­å®š
        if (editFormUrlLink) {
          console.log('ğŸ” [DEBUG] Setting up edit form link:', {
            hasStatusEditFormUrl: !!status.editFormUrl,
            statusEditFormUrl: status.editFormUrl,
            formUrlForConversion: formUrl
          });
          
          let editFormUrl = null;
          
          // 1. statusã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆæœ€æ–°ï¼‰
          if (status.editFormUrl) {
            editFormUrl = status.editFormUrl;
            console.log('âœ… [DEBUG] Using editFormUrl from status:', editFormUrl);
          }
          // 2. userInfo.configJsonã‹ã‚‰å–å¾—
          else if (status.userInfo && status.userInfo.configJson) {
            try {
              const config = JSON.parse(status.userInfo.configJson);
              editFormUrl = config.editFormUrl;
              console.log('âœ… [DEBUG] Retrieved editFormUrl from configJson:', editFormUrl);
            } catch (e) {
              console.warn('Failed to get editFormUrl from config:', e);
            }
          }
          
          if (editFormUrl) {
            editFormUrlLink.href = editFormUrl;
            editFormUrlLink.classList.remove('hidden');
            console.log('âœ… [DEBUG] Edit button enabled with URL:', editFormUrl);
          } else if (formUrl && formUrl.includes('/viewform')) {
            const convertedEditUrl = formUrl.replace('/viewform', '/edit');
            editFormUrlLink.href = convertedEditUrl;
            editFormUrlLink.classList.remove('hidden');
            console.log('âœ… [DEBUG] Edit button enabled with converted URL:', convertedEditUrl);
          } else {
            editFormUrlLink.classList.add('hidden');
            console.log('âœ… [DEBUG] Edit button hidden: no valid URL');
          }
        }
        
        console.log('âœ… [DEBUG] Form URL section displayed:', formUrl);
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ URLãŒãªã„å ´åˆã€è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éš ã™
        formUrlSection.classList.add('hidden');
        formUrlInput.value = '';
        if (editFormUrlLink) {
          editFormUrlLink.classList.add('hidden');
        }
        console.log('âœ… [DEBUG] Form URL section hidden - no form URL available');
      }
    }

    /**
     * è³ªå•ã‚¿ã‚¤ãƒ—ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
     */
    function getQuestionTypeLabel(type) {
      const labels = {
        'text': 'ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›',
        'multiple': 'ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹',
        'choice': 'ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³',
        'paragraph': 'é•·æ–‡å…¥åŠ›'
      };
      return labels[type] || type;
    }

    /**
     * å‹•çš„ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆåˆ—è¨­å®šãªã©ï¼‰ã‚’æ›´æ–°ã™ã‚‹
     * @param {object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function updateDynamicContent(status) {
      // ãƒ•ãƒƒã‚¿ãƒ¼ã¨ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’æ›´æ–°
      updateFooterAndGuidance(status);
      
      // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
      updateStepIndicators(status.setupStep);
      
      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
      updateSectionVisibility(status.setupStep);
      
      // åˆ—è¨­å®šã‚’èª­ã¿è¾¼ã¿
      loadConfigForSelected();
      
      console.log('âœ… [3/3] Dynamic Content and Final UI Updated');
    }

    /**
     * æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
     */
    function updateExistingUserSection(status) {
      const existingUserSection = document.getElementById('existing-user-section');
      const createBoardBtn = document.getElementById('create-board-btn');

      if (!existingUserSection || !createBoardBtn) return;
      
      console.log('ğŸ•µï¸ [DEBUG] updateExistingUserSection called with:', status);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã®æœ‰ç„¡ã§åˆ¤æ–­
      const hasUserInfo = status && status.userInfo && Object.keys(status.userInfo).length > 0;
      const hasSpreadsheetId = hasUserInfo && status.userInfo.spreadsheetId;

      if (hasUserInfo && hasSpreadsheetId) {
        existingUserSection.classList.remove('hidden');
        createBoardBtn.classList.add('hidden');
        console.log('âœ… [DEBUG] Showing existing user section, hiding create button');
      } else {
        existingUserSection.classList.add('hidden');
        createBoardBtn.classList.remove('hidden');
        console.log('âœ… [DEBUG] Hiding existing user section, showing create button');
      }
    }

    /**
     * ãƒ•ãƒƒã‚¿ãƒ¼ã¨ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹
     * @param {object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function updateFooterAndGuidance(status) {
      console.log('ğŸ‘£ [DEBUG] updateFooterAndGuidance called with status:', status);
      const footer = document.getElementById('admin-footer');
      const guidanceText = document.getElementById('guidance-text');
      const stepDescription = document.getElementById('step-description');
      const nextActionContainer = document.getElementById('next-action-container');
      const nextActionText = document.getElementById('next-action-text');
      
      if (!footer || !guidanceText) return;

      const isPublished = status.isPublished;

      if (isPublished && status.appUrls && status.appUrls.viewUrl) {
        footer.classList.remove('hidden');
        document.getElementById('board-url').value = status.appUrls.viewUrl;
        document.getElementById('view-board-link').href = status.appUrls.viewUrl;
        
        // ãƒˆãƒ”ãƒƒã‚¯ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šï¼ˆå•é¡Œæ–‡ã‚’è¡¨ç¤ºï¼‰
        const topicTextElement = document.getElementById('current-topic-text');
        if (topicTextElement) {
          let topic = 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
          
          // opinionHeaderã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
          if (status.userInfo && status.userInfo.configJson && status.publishedSheetName) {
            try {
              const config = JSON.parse(status.userInfo.configJson);
              const sheetKey = 'sheet_' + status.publishedSheetName;
              const sheetConfig = config[sheetKey] || {};
              topic = sheetConfig.opinionHeader || status.publishedSheetName || 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
              console.log('âœ… [DEBUG] Using sheet config opinionHeader:', topic);
            } catch (e) {
              console.warn('ConfigJson parsing error:', e);
              topic = status.publishedSheetName || 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
            }
          }

          topicTextElement.textContent = topic;
          console.log(`âœ… [DEBUG] Set footer topic text to: ${topic}`);
        }
        
        guidanceText.textContent = 'å›ç­”ãƒœãƒ¼ãƒ‰ã¯ç¾åœ¨å…¬é–‹ä¸­ã§ã™ã€‚';
      } else {
        footer.classList.add('hidden');
        // ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¹ãƒ†ãƒƒãƒ—ã®èª¬æ˜ã‚’å‹•çš„ã«è¨­å®š
        if (status.nextAction) {
          guidanceText.textContent = status.nextAction;
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ã«åŸºã¥ããƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          switch(status.setupStep) {
            case 1:
              guidanceText.textContent = 'ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
              break;
            case 2:
              guidanceText.textContent = 'ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­ã§ã™ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ã„ã¾ã™...';
              break;
            case 3:
              guidanceText.textContent = 'ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†ï¼è¡¨ç¤ºã—ãŸã„ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
              break;
            case 4:
              guidanceText.textContent = 'ã‚¹ãƒ†ãƒƒãƒ—4: åˆ—ã‚’è¨­å®šã—ã¦è¡¨ç¤ºå†…å®¹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã—ã‚‡ã†ã€‚';
              break;
            case 5:
              guidanceText.textContent = 'ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã¦å…¬é–‹è¨­å®šã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚';
              break;
            case 6:
              guidanceText.textContent = 'ã‚¹ãƒ†ãƒƒãƒ—6: å›ç­”ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼';
              break;
            default:
              guidanceText.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚';
          }
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—ã®èª¬æ˜ã‚’æ›´æ–°
        if (stepDescription && status.stepDescription) {
          stepDescription.textContent = status.stepDescription;
        }
        
        // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºãƒ»æ›´æ–°
        if (nextActionContainer && nextActionText && status.nextAction && status.setupStep < 6) {
          nextActionText.textContent = getActionButtonText(status.setupStep);
          nextActionContainer.classList.remove('hidden');
          
          // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
          const nextActionBtn = document.getElementById('next-action-btn');
          if (nextActionBtn) {
            nextActionBtn.onclick = () => executeNextAction(status.setupStep);
          }
        } else if (nextActionContainer) {
          nextActionContainer.classList.add('hidden');
        }
      }
      
      // fallback for topic text if everything else fails
      if (isPublished && document.getElementById('current-topic-text').textContent === 'èª­ã¿è¾¼ã¿ä¸­...') {
         // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã‚‚å•é¡Œæ–‡ã‚’å–å¾—ã‚’è©¦ã¿ã‚‹
         let fallbackTopic = 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
         if (status.publishedSheetName && status.userInfo && status.userInfo.configJson) {
           try {
             const config = JSON.parse(status.userInfo.configJson);
             const sheetKey = 'sheet_' + status.publishedSheetName;
             const sheetConfig = config[sheetKey] || {};
             fallbackTopic = sheetConfig.opinionHeader || status.publishedSheetName || 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
           } catch (e) {
             fallbackTopic = status.publishedSheetName || 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
           }
         }
         document.getElementById('current-topic-text').textContent = fallbackTopic;
         console.log(`âœ… [DEBUG] Set footer topic text fallback to: ${fallbackTopic}`);
      }

      adjustLayout();
    }

    /**
     * ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®UIã‚’æ›´æ–°ã™ã‚‹ï¼ˆ6ã‚¹ãƒ†ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ ã‚’3ã‚¹ãƒ†ãƒƒãƒ—UIã«ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
     * @param {number} currentStep - ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ç•ªå· (1-6)
     */
    function updateStepIndicators(currentStep) {
      console.log('ğŸ“Š [DEBUG] updateStepIndicators called with currentStep:', currentStep);
      
      // 6ã‚¹ãƒ†ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ ã‚’3ã‚¹ãƒ†ãƒƒãƒ—UIã«ãƒãƒƒãƒ”ãƒ³ã‚°
      // Step 1-2 (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãƒ»ãƒ‡ãƒ¼ã‚¿æº–å‚™) â†’ UI Step 1 (ãƒ‡ãƒ¼ã‚¿æº–å‚™)
      // Step 3-4 (ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ãƒ»ã‚·ãƒ¼ãƒˆé¸æŠ) â†’ UI Step 2 (ã‚·ãƒ¼ãƒˆé¸æŠ) 
      // Step 5-6 (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å…¬é–‹) â†’ UI Step 3 (è¨­å®šãƒ»å…¬é–‹)
      let uiStep;
      if (currentStep <= 2) {
        uiStep = 1;
      } else if (currentStep <= 4) {
        uiStep = 2;
      } else {
        uiStep = 3;
      }
      
      console.log('ğŸ“Š [DEBUG] Mapping step', currentStep, 'to UI step', uiStep);
      
      const steps = [
        document.getElementById('step-1-indicator'),
        document.getElementById('step-2-indicator'),
        document.getElementById('step-3-indicator')
      ];

      steps.forEach((step, index) => {
        if (!step) return;
        const stepNumber = index + 1;
        const circle = step.querySelector('div');
        const text = step.querySelector('span');

        if (stepNumber < uiStep) {
          // å®Œäº†ã—ãŸã‚¹ãƒ†ãƒƒãƒ—
          circle.className = 'w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all';
          text.classList.remove('text-gray-500');
          text.classList.add('text-gray-300');
        } else if (stepNumber === uiStep) {
          // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—
          circle.className = 'w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all ring-2 ring-blue-400 ring-offset-2 ring-offset-gray-800';
          text.classList.remove('text-gray-500');
          text.classList.add('text-white', 'font-semibold');
        } else {
          // æœªå®Œäº†ã®ã‚¹ãƒ†ãƒƒãƒ—
          circle.className = 'w-6 h-6 bg-gray-600 text-gray-400 rounded-full flex items-center justify-center font-bold text-xs transition-all';
          text.classList.remove('text-white', 'font-semibold');
          text.classList.add('text-gray-500');
        }
      });
    }

    /**
     * ã‚¹ãƒ†ãƒƒãƒ—ã«å¿œã˜ãŸæ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
     * @param {number} setupStep - ç¾åœ¨ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ— (1-6)
     * @returns {string} ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
     */
    function getActionButtonText(setupStep) {
      switch (setupStep) {
        case 1:
          return 'ãƒ‡ãƒ¼ã‚¿æº–å‚™ã‚’é–‹å§‹';
        case 2:
          return 'ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã‚’ç¢ºèª';
        case 3:
          return 'ã‚·ãƒ¼ãƒˆã‚’é¸æŠ';
        case 4:
          return 'åˆ—è¨­å®šã«é€²ã‚€';
        case 5:
          return 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèª';
        default:
          return 'æ¬¡ã¸';
      }
    }

    /**
     * ã‚¹ãƒ†ãƒƒãƒ—ã«å¿œã˜ãŸæ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
     * @param {number} setupStep - ç¾åœ¨ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ— (1-6)
     */
    function executeNextAction(setupStep) {
      console.log('ğŸ¬ [DEBUG] executeNextAction called for step:', setupStep);
      
      switch (setupStep) {
        case 1:
          // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå®Œäº† -> ãƒ‡ãƒ¼ã‚¿æº–å‚™ã‚’é–‹å§‹
          triggerDataPreparation();
          break;
        case 2:
          // ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­ -> çŠ¶æ³ã‚’ç¢ºèªã—ã¦æ¬¡ã¸
          checkResourceCreationStatus();
          break;
        case 3:
          // ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº† -> ã‚·ãƒ¼ãƒˆé¸æŠã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          scrollToSheetSelection();
          break;
        case 4:
          // ã‚·ãƒ¼ãƒˆé¸æŠå®Œäº† -> åˆ—è¨­å®šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          scrollToColumnConfig();
          break;
        case 5:
          // åˆ—è¨­å®šå®Œäº† -> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/å…¬é–‹è¨­å®šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          scrollToPublishConfig();
          break;
        default:
          console.log('ä¸æ˜ãªã‚¹ãƒ†ãƒƒãƒ—ã§ã™:', setupStep);
      }
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿æº–å‚™ã‚’é–‹å§‹ã™ã‚‹
     */
    function triggerDataPreparation() {
      console.log('ğŸš€ Starting data preparation...');
      // ãƒœãƒ¼ãƒ‰ä½œæˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
      const createBoardBtn = document.getElementById('create-board-btn');
      if (createBoardBtn && !createBoardBtn.disabled) {
        createBoardBtn.click();
      } else {
        console.log('Create board button not available');
        // ä»£æ›¿: ç›´æ¥é–¢æ•°ã‚’å‘¼ã³å‡ºã—
        if (typeof createBoard === 'function') {
          createBoard();
        }
      }
    }

    /**
     * ãƒªã‚½ãƒ¼ã‚¹ä½œæˆçŠ¶æ³ã‚’ç¢ºèªã™ã‚‹
     */
    function checkResourceCreationStatus() {
      console.log('ğŸ” Checking resource creation status...');
      // çŠ¶æ³æ›´æ–°ã®ãŸã‚ã«loadStatusã‚’å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã§å†å®Ÿè¡Œ
      loadStatus(true);
    }

    /**
     * ã‚·ãƒ¼ãƒˆé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
     */
    function scrollToSheetSelection() {
      const sheetSection = document.getElementById('sheet-selection-section');
      if (sheetSection) {
        sheetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚·ãƒ¼ãƒˆé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        setTimeout(() => {
          const sheetSelect = document.getElementById('sheet-select');
          if (sheetSelect) {
            sheetSelect.focus();
          }
        }, 500);
      }
    }

    /**
     * åˆ—è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
     */
    function scrollToColumnConfig() {
      const configSection = document.getElementById('config-section');
      if (configSection) {
        configSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    /**
     * å…¬é–‹è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
     */
    function scrollToPublishConfig() {
      const configSection = document.getElementById('config-section');
      if (configSection) {
        configSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // å…¬é–‹ãƒœã‚¿ãƒ³ã‚’å¼·èª¿
        setTimeout(() => {
          const publishBtn = document.getElementById('publish-btn');
          if (publishBtn) {
            publishBtn.focus();
            publishBtn.classList.add('ring-2', 'ring-blue-400');
          }
        }, 500);
      }
    }

    /**
     * ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’6ã‚¹ãƒ†ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ ã«å¿œã˜ã¦åˆ¶å¾¡ã™ã‚‹
     * @param {number} currentStep - ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ç•ªå· (1-6)
     */
    function updateSectionVisibility(currentStep) {
      console.log('ğŸ“Š [DEBUG] updateSectionVisibility called with currentStep:', currentStep);
      
      const dataSetupSection = document.getElementById('data-setup-section');
      const sheetSelectionSection = document.getElementById('sheet-selection-section');
      const configSection = document.getElementById('config-section');
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      if (dataSetupSection) dataSetupSection.style.display = 'block';
      if (sheetSelectionSection) sheetSelectionSection.style.display = 'block';
      if (configSection) configSection.style.display = 'block';
      
      // ã‚¹ãƒ†ãƒƒãƒ—ã«å¿œã˜ã¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¼·èª¿è¡¨ç¤ºã¨æ“ä½œæ€§ã‚’åˆ¶å¾¡
      switch (currentStep) {
        case 1:
        case 2:
          // ãƒ‡ãƒ¼ã‚¿æº–å‚™æ®µéš - ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼·èª¿
          if (dataSetupSection) {
            dataSetupSection.style.opacity = '1';
            dataSetupSection.style.transform = 'scale(1)';
          }
          if (sheetSelectionSection) {
            sheetSelectionSection.style.opacity = '0.6';
            sheetSelectionSection.style.pointerEvents = 'none';
          }
          if (configSection) {
            configSection.style.opacity = '0.6';
            configSection.style.pointerEvents = 'none';
          }
          break;
          
        case 3:
        case 4:
          // ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ãƒ»ã‚·ãƒ¼ãƒˆé¸æŠæ®µéš - ã‚·ãƒ¼ãƒˆé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼·èª¿
          if (dataSetupSection) {
            dataSetupSection.style.opacity = '0.8';
          }
          if (sheetSelectionSection) {
            sheetSelectionSection.style.opacity = '1';
            sheetSelectionSection.style.pointerEvents = 'auto';
            sheetSelectionSection.style.transform = 'scale(1)';
          }
          if (configSection) {
            configSection.style.opacity = '0.6';
            configSection.style.pointerEvents = 'none';
          }
          break;
          
        case 5:
        case 6:
          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å…¬é–‹æ®µéš - è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼·èª¿
          if (dataSetupSection) {
            dataSetupSection.style.opacity = '0.8';
          }
          if (sheetSelectionSection) {
            sheetSelectionSection.style.opacity = '0.8';
          }
          if (configSection) {
            configSection.style.opacity = '1';
            configSection.style.pointerEvents = 'auto';
            configSection.style.transform = 'scale(1)';
          }
          break;
          
        default:
          // å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³æœ‰åŠ¹
          [dataSetupSection, sheetSelectionSection, configSection].forEach(section => {
            if (section) {
              section.style.opacity = '1';
              section.style.pointerEvents = 'auto';
              section.style.transform = 'scale(1)';
            }
          });
      }
    }

    /**
     * ã‚·ãƒ¼ãƒˆé¸æŠã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆãƒ»æ›´æ–°ã™ã‚‹
     * @param {Array<string>} sheetNames - ã‚·ãƒ¼ãƒˆåã®é…åˆ—
     * @param {string} activeSheetName - ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚·ãƒ¼ãƒˆå
     */
    function populateSheetSelect(sheetNames, activeSheetName) {
      const select = document.getElementById('sheet-select');
      if (!select) {
        console.warn('populateSheetSelect: sheet-select element not found.');
        return;
      }

      console.log('populateSheetSelect: Received sheetNames:', sheetNames);
      console.log('populateSheetSelect: Received activeSheetName:', activeSheetName);

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ã‚¯ãƒªã‚¢
      select.innerHTML = '<option value="">-- ã‚·ãƒ¼ãƒˆã‚’é¸æŠ --</option>';
      console.log('populateSheetSelect: After clearing innerHTML:', select.innerHTML);

      if (sheetNames && sheetNames.length > 0) {
        sheetNames.forEach(sheet => {
          const option = document.createElement('option');
          option.value = sheet.name; // sheetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰nameãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨
          option.textContent = sheet.name; // sheetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰nameãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨
          select.appendChild(option);
        });
        select.disabled = false;
        console.log('populateSheetSelect: After adding options, innerHTML:', select.innerHTML);
      } else if (activeSheetName) {
        // sheetNamesãŒãªã„å ´åˆã§ã‚‚ã€activeSheetNameãŒã‚ã‚Œã°è¿½åŠ 
        console.log('populateSheetSelect: No sheetNames but activeSheetName exists, adding it:', activeSheetName);
        const option = document.createElement('option');
        option.value = activeSheetName;
        option.textContent = activeSheetName;
        select.appendChild(option);
        select.disabled = false;
        console.log('populateSheetSelect: Added activeSheetName as option:', activeSheetName);
      } else {
        select.innerHTML = '<option value="">åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
        select.disabled = true;
        console.log('populateSheetSelect: No sheets available, innerHTML:', select.innerHTML);
      }
      
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚·ãƒ¼ãƒˆåãŒæ¸¡ã•ã‚ŒãŸå ´åˆã¯ãã‚Œã‚’å„ªå…ˆ
      if (activeSheetName) {
        select.value = activeSheetName;
        appState.selectedSheet = activeSheetName;
        console.log('populateSheetSelect: Set select.value to activeSheetName:', activeSheetName);
      } else if (appState.selectedSheet) {
        // æœªå…¬é–‹çŠ¶æ…‹ãªã©ã§activeSheetNameãŒç„¡ã„å ´åˆã¯ç¾åœ¨ã®é¸æŠã‚’ç¶­æŒ
        select.value = appState.selectedSheet;
        console.log('populateSheetSelect: Keep existing selectedSheet:', appState.selectedSheet);
      } else {
        select.value = '';
        console.log('populateSheetSelect: Reset select.value to empty');
      }
      
      // é¸æŠçŠ¶æ…‹ã«å¿œã˜ã¦UIã‚’æ›´æ–°
      appState.selectedSheet = select.value;
      console.log('populateSheetSelect: Final selectedSheet:', appState.selectedSheet);
      updateUIForSelectedSheet();
    }

    /**
     * ã‚·ãƒ¼ãƒˆãŒé¸æŠã•ã‚ŒãŸã¨ãã®UIæ›´æ–°
     */
    function updateUIForSelectedSheet() {
      const configArea = document.getElementById('config-area');
      const placeholder = document.getElementById('config-placeholder');
      
      if (appState.selectedSheet) {
        configArea.classList.remove('hidden');
        placeholder.classList.add('hidden');
        // AIåˆ¤å®šãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        const reguessBtn = document.getElementById('reguess-headers-btn');
        if (reguessBtn) reguessBtn.disabled = false;
      } else {
        configArea.classList.add('hidden');
        placeholder.classList.remove('hidden');
        const reguessBtn = document.getElementById('reguess-headers-btn');
        if (reguessBtn) reguessBtn.disabled = true;
      }
    }

    /**
     * é¸æŠã•ã‚ŒãŸã‚·ãƒ¼ãƒˆã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
     */
    function loadConfigForSelected() {
      if (!appState.selectedSheet) return;
      
      console.log('ğŸ” [DEBUG] Load config check:', {
        selectedSheet: appState.selectedSheet,
        currentActiveSheet: appState.currentStatus.activeSheetName,
        appPublished: appState.currentStatus.isPublished,
        publishedSheetName: appState.currentStatus.publishedSheetName
      });

      // å…¬é–‹ä¸­ã‹ã¤é¸æŠä¸­ã®ã‚·ãƒ¼ãƒˆãŒå…¬é–‹ã‚·ãƒ¼ãƒˆã¨åŒã˜å ´åˆã¯ã€UIã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹
      if (appState.currentStatus.isPublished && appState.selectedSheet === appState.currentStatus.publishedSheetName) {
        setLoading(true, 'å…¬é–‹ä¸­ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
      } else {
        setLoading(true, 'åˆ—æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
      }

      runGasWithUserId('getSheetDetails', appState.currentStatus.userInfo.spreadsheetId, appState.selectedSheet)
        .then(handleSheetDetailsSuccess)
        .catch(handleSheetDetailsError);
    }

    /**
     * getSheetDetailsæˆåŠŸæ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
     */
    function handleSheetDetailsSuccess(details) {
      populateHeaderOptions(details.allHeaders);
      
      // æ—¢å­˜è¨­å®šã¨æ¨æ¸¬è¨­å®šã‚’ãƒãƒ¼ã‚¸
      const configToUse = { 
        ...details.guessedConfig, 
        ...details.existingConfig,
        showNames: details.existingConfig?.showNames || false,
        showCounts: details.existingConfig?.showCounts !== undefined ? details.existingConfig.showCounts : false
      };
      
      populateConfig(configToUse);
      updateStepIndicators(3);
      setLoading(false);
    }

    /**
     * getSheetDetailså¤±æ•—æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
     */
    function handleSheetDetailsError(error) {
      handleError(error, 'loadConfig');
      clearConfigFields();
      setLoading(false);
    }

    // ======= Utility functions for column configuration =======
    /**
     * åˆ—é¸æŠç”¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ãƒ˜ãƒƒãƒ€ãƒ¼ä¸€è¦§ã‚’è¨­å®šã™ã‚‹
     * @param {Array<string>} headers - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼
     */
    function populateHeaderOptions(headers) {
      var selects = [elements.opinionHeader, elements.reasonHeader, elements.nameHeader, elements.classHeader];
      selects.forEach(function(sel) {
        sel.replaceChildren();
        var opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '-- é¸æŠã—ã¦ãã ã•ã„ --';
        sel.appendChild(opt);
        headers.forEach(function(h) {
          var option = document.createElement('option');
          option.value = h;
          option.textContent = h;
          sel.appendChild(option);
        });
      });
    }

    /**
     * è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’UIã«åæ˜ ã™ã‚‹
     * @param {object} cfg - åˆ—è¨­å®šã¨è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³
     */
    function populateConfig(cfg) {
      if (!elements.opinionHeader || !elements.reasonHeader || !elements.nameHeader || !elements.classHeader) {
        console.error('è¨­å®šç”¨ã®UIè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }

      elements.opinionHeader.value = cfg.opinionHeader || '';
      elements.reasonHeader.value  = cfg.reasonHeader || '';
      elements.nameHeader.value    = cfg.nameHeader || '';
      elements.classHeader.value   = cfg.classHeader || '';

      var showNamesCb = document.getElementById('showNames');
      var showCountsCb = document.getElementById('showCounts');
      if (showNamesCb) showNamesCb.checked = !!cfg.showNames;
      if (showCountsCb) showCountsCb.checked = cfg.showCounts !== undefined ? cfg.showCounts : false;

      updateConfigButtons();
    }

    /**
     * åˆ—è¨­å®šUIã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
     */
    function clearConfigFields() {
      [elements.opinionHeader, elements.reasonHeader, elements.nameHeader, elements.classHeader].forEach(function(sel) {
        sel.replaceChildren();
        var opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '-- é¸æŠã—ã¦ãã ã•ã„ --';
        sel.appendChild(opt);
        sel.value = '';
      });
      updateConfigButtons();
    }

    /**
     * AIã«ã‚ˆã‚‹åˆ—åˆ¤å®šã‚’å®Ÿè¡Œ
     */
    function runHeaderGuessing() {
      if (!appState.selectedSheet) {
        showMessage('ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
        return;
      }
      setLoading(true, 'AIæ­è¼‰é«˜ç²¾åº¦åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãŒåˆ†æä¸­...');
      
      runGasWithUserId('getSheetDetails', appState.currentStatus.userInfo.spreadsheetId, appState.selectedSheet)
        .then(function(details) {
          const configToUse = {
            ...details.guessedConfig,
            ...details.existingConfig,
            showNames: details.existingConfig?.showNames || false,
            showCounts: details.existingConfig?.showCounts !== undefined ? details.existingConfig.showCounts : false
          };
          populateHeaderOptions(details.allHeaders);
          populateConfig(configToUse);
          showMessage('ğŸ¤– AIã«ã‚ˆã‚‹åˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'info');
          setLoading(false);
        })
        .catch(function(error) {
          handleError(error, 'runHeaderGuessing');
          setLoading(false);
        });
    }

    /**
     * è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç¾åœ¨ã®UIã‹ã‚‰æ§‹ç¯‰ã™ã‚‹
     */
    function buildConfigObject() {
      const showNamesCheckbox = document.getElementById('showNames');
      const showCountsCheckbox = document.getElementById('showCounts');
      
      return {
        opinionHeader: document.getElementById('opinionHeader').value,
        reasonHeader: document.getElementById('reasonHeader').value,
        nameHeader: document.getElementById('nameHeader').value,
        classHeader: document.getElementById('classHeader').value,
        showNames: showNamesCheckbox ? showNamesCheckbox.checked : false,
        showCounts: showCountsCheckbox ? showCountsCheckbox.checked : false,
      };
    }

    /**
     * è¨­å®šãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã™ã‚‹
     */
    function validateConfig() {
      const opinionHeader = document.getElementById('opinionHeader');
      if (!opinionHeader) {
        console.warn('opinionHeader element not found');
        return false;
      }
      const isValid = !!opinionHeader.value;
      console.log('validateConfig:', opinionHeader.value, 'isValid:', isValid);
      return isValid;
    }

    /**
     * è¨­å®šãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
     */
    function updateConfigButtons() {
      const saveBtn = document.getElementById('save-publish-btn');
      if (saveBtn) {
        const isValid = validateConfig();
        saveBtn.disabled = !isValid;
        console.log('updateConfigButtons: saveBtn.disabled =', saveBtn.disabled);
      } else {
        console.warn('save-publish-btn element not found');
      }
    }

    /**
     * å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´æ™‚ã«å³åº§ã«ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
     */
    function setupRealtimeValidation() {
      const fields = ['opinionHeader', 'reasonHeader', 'nameHeader', 'classHeader'];
      fields.forEach(function(id) {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', updateConfigButtons);
        }
      });
    }

    /**
     *ã€æ–°ã—ã„æ¨å¥¨ã€‘è¨­å®šã‚’ä¿å­˜ã—ã€ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã™ã‚‹
     */
    function saveAndPublish() {
      console.log('ğŸ’¾ saveAndPublish called');
      
      if (!validateConfig()) {
        console.warn('âš ï¸ Validation failed');
        showMessage('å¿…é ˆé …ç›®ï¼ˆå›ç­”ãƒ‡ãƒ¼ã‚¿åˆ—ï¼‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
        return;
      }

      console.log('âœ… Validation passed, starting save and publish...');
      setLoading(true, 'è¨­å®šã‚’ä¿å­˜ã—ã€ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™...');
      const config = buildConfigObject();
      console.log('ğŸ“œ Config object:', config);

      // ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦é€ä¿¡
      const settingsData = {
        selectedSheet: appState.selectedSheet,
        opinionHeader: config.opinionHeader,
        reasonHeader: config.reasonHeader,
        nameHeader: config.nameHeader,
        classHeader: config.classHeader,
        showNames: config.showNames,
        showCounts: config.showCounts,
        classChoices: config.classChoices
      };
      
      runGasWithUserId('saveAndPublish', settingsData)
        .then(function(result) {
          setLoading(false);
          if (result && result.status === 'success') {
            showMessage('è¨­å®šãŒä¿å­˜ã•ã‚Œã€ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
            // ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç‰ˆã¯ latestStatus ã‚’å«ã‚€ã®ã§ã€ãã‚Œã§UIã‚’æ›´æ–°
            if (result.latestStatus) {
              updateUIWithNewStatus(result.latestStatus);
              console.log('âœ… saveAndPublish success - UI updated with latest status');
            } else {
              loadStatus(true);
            }
          } else {
            showMessage(result.message || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        })
        .catch(function(error) {
          setLoading(false);
          console.error('âŒ  saveAndPublish failed, falling back to legacy:', error);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®æ–¹æ³•
          runGasWithUserId('saveAndPublish', appState.selectedSheet, config)
            .then(function(status) {
              setLoading(false);
              showMessage('è¨­å®šãŒä¿å­˜ã•ã‚Œã€ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
              if (status && typeof status === 'object') {
                updateUIWithNewStatus(status);
                console.log('âœ… saveAndPublish legacy fallback success');
              } else {
                loadStatus(true);
              }
            })
            .catch(function(legacyError) {
              setLoading(false);
              handleError(legacyError, 'saveAndPublish');
            });
        });
    }

    function saveConfig() {
      // ã“ã®é–¢æ•°ã¯å¤ã„ã®ã§ã€æ–°ã—ã„ saveAndPublish ã«å‡¦ç†ã‚’å§”ä»»ã™ã‚‹ã‹ã€
      // ã‚‚ã—ä¸‹æ›¸ãä¿å­˜æ©Ÿèƒ½ãŒå¿…è¦ãªå ´åˆã¯ saveDraftConfig ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¾ã™ã€‚
      // ä»Šå›ã¯UIã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã•ã‚Œãªã„ãŸã‚ã€å¿µã®ç‚ºæ®‹ã—ã¾ã™ãŒã€åŸºæœ¬çš„ã«ã¯ä½¿ã„ã¾ã›ã‚“ã€‚
      console.warn('å¤ã„saveConfigé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸã€‚æ–°ã—ã„saveAndPublishã®ä½¿ç”¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚');
      saveAndPublish(); 
    }


    /**
     * ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ã™ã‚‹
     */
    function unpublishBoard() {
      console.log('ğŸš« unpublishBoard called');
      setLoading(true, 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ä¸­...');
      console.log('ğŸ“¤ Calling runGasWithUserId(clearActiveSheet)');
      runGasWithUserId('clearActiveSheet')
        .then(function(response) {
          console.log('å…¬é–‹åœæ­¢ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
          showMessage(response.message || 'âœ… å›ç­”ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚', 'success');
          setLoading(false);
          // ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æœ€æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§UIã‚’ç›´æ¥æ›´æ–°ï¼ˆè¿½åŠ ã®APIå‘¼ã³å‡ºã—ä¸è¦ï¼‰
          if (response && typeof response === 'object' && response.success) {
            updateUIWithNewStatus(response);
            console.log('âœ… unpublishBoard success - UI updated with response status');
          } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœŸå¾…ã•ã‚ŒãŸå½¢å¼ã§ãªã„å ´åˆã®ã¿loadStatuså‘¼ã³å‡ºã—
            loadStatus(true);
          }
        })
        .catch(function(error) {
          handleError(error, 'unpublishBoard');
          setLoading(false);
        });
    }

    /**
     * æ–°ã—ã„ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹
     */
      function createBoard() {
        // ã“ã®é–¢æ•°ã¯ç¾åœ¨ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
        showMessage('æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œæ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚', 'info');
      }
    
    /**
     * æ–°è¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹
     */
    function createAdditionalForm() {
        showFormConfigModal();
    }

    /**
     * ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
     */
    function showFormConfigModal() {
        const modal = document.getElementById('form-config-modal');
        if (modal) {
            modal.classList.remove('hidden');

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è³ªå•ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
            initQuestionConfig();
        }
    }

    /**
     * ç®¡ç†ãƒ‘ãƒãƒ«ç”¨ã®è¨­å®šåˆæœŸåŒ–ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ã¿ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯è¨­å®šã—ãªã„ï¼‰
     */
    async function initQuestionConfig() {
        try {
            // ç®¡ç†ãƒ‘ãƒãƒ«ã§ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ã¿è¡¨ç¤ºã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯è¨­å®šã—ãªã„
            // ä¿å­˜ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®ã¿èª­ã¿è¾¼ã‚€
            loadSavedClassChoices();
            
        } catch (error) {
            console.error('Failed to initialize question config:', error);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
            loadSavedClassChoices();
        }
    }

    /**
     * ä¿å­˜ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’èª­ã¿è¾¼ã¿
     */
    function loadSavedClassChoices() {
        runGasWithUserId('getSavedClassChoices')
            .then(function(result) {
                if (result.status === 'success' && result.classChoices) {
                    const classChoicesTextarea = document.getElementById('class-choices');
                    if (classChoicesTextarea) {
                        classChoicesTextarea.value = result.classChoices.join('\n');
                    }
                }
            })
            .catch(function(error) {
                console.warn('ä¿å­˜ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error.message);
            });
    }

    /**
     * ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
     */
    function hideFormConfigModal() {
        const modal = document.getElementById('form-config-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    /**
     * ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã«åŸºã¥ã„ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ
     * Promiseãƒ™ãƒ¼ã‚¹ã®éåŒæœŸå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ”¹å–„
     */
    async function createFormWithConfig() {
        const customMainQuestion = document.getElementById('custom-main-question').value.trim();
        const mainQuestionType = document.getElementById('main-question-type').value;
        const mainQuestionChoices = document.getElementById('main-question-choices').value.split('\n').filter(choice => choice.trim());
        const includeOthersOption = document.getElementById('include-others-option').checked;
        const enableClassSelection = document.getElementById('enable-class-selection').checked;
        const classChoices = enableClassSelection ? document.getElementById('class-choices').value.split('\n').filter(choice => choice.trim()) : [];

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¯è‡ªå‹•ç”Ÿæˆã®ãŸã‚å‰Šé™¤ï¼‰

        if (!customMainQuestion) {
            showMessage('è³ªå•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
            document.getElementById('custom-main-question').focus();
            return;
        }

        if ((mainQuestionType === 'multiple' || mainQuestionType === 'choice') && mainQuestionChoices.length === 0) {
            showMessage('é¸æŠè‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
            document.getElementById('main-question-choices').focus();
            return;
        }

        const config = {
            // formTitle is now auto-generated in backend
            opinionHeader: customMainQuestion,  // mainQuestion ã‚’ opinionHeader ã«çµ±ä¸€
            questionType: mainQuestionType,
            choices: mainQuestionChoices,
            includeOthers: includeOthersOption,
            enableClass: enableClassSelection,
            classChoices: classChoices
        };

        hideFormConfigModal();
        
        try {
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã§æ®µéšçš„ãªé€²è¡ŒçŠ¶æ³ã‚’è¡¨ç¤º
            showProgressStep(1, 5, 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆä¸­...');

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚’å®Ÿè¡Œ
            const result = await withTimeout(
                runGasWithUserId('createCustomFormUI', config),
                300000,  // 5åˆ†ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚'
            );

            if (result.status !== 'success') {
                throw new Error(result.message || 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }

            showProgressStep(2, 5, 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ï¼è¨­å®šã‚’ä¿å­˜ä¸­...');
            
            // è‡ªå‹•è¨­å®šä¿å­˜ã¨å…¬é–‹å‡¦ç†
            if (result.autoPublishReady && result.sheetName) {
                try {
                    const autoResult = await withTimeout(
                        runGasWithUserId('autoSaveAndPublishAfterFormCreation', result.sheetName, result),
                        180000,  // 3åˆ†ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                        'è¨­å®šä¿å­˜ãƒ»å…¬é–‹å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚'
                    );
                    
                    showProgressStep(3, 5, 'è¨­å®šä¿å­˜å®Œäº†ï¼å…¬é–‹ä¸­...');
                    
                    if (autoResult.status === 'success') {
                        showProgressStep(4, 5, 'å…¬é–‹å®Œäº†ï¼UIã‚’æ›´æ–°ä¸­...');
                        showProgressStep(5, 5, 'å…¨ã¦å®Œäº†ï¼');
                        
                        await completeFormCreationProcess(result, 'âœ… ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã€è¨­å®šä¿å­˜ã€å…¬é–‹ãŒè‡ªå‹•ã§å®Œäº†ã—ã¾ã—ãŸï¼');
                    } else {
                        throw new Error(autoResult.message || 'è‡ªå‹•å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (autoError) {
                    console.warn('âš ï¸ è‡ªå‹•å…¬é–‹å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', autoError.message);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•è¨­å®šãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ
                    await handleManualFormSetup(result);
                }
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•è¨­å®š
                await handleManualFormSetup(result);
            }
            
            // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆæœ‰åŠ¹ãªå ´åˆï¼‰
            if (enableClassSelection && classChoices.length > 0) {
                // éåŒæœŸã§ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’ä¿å­˜ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
                saveClassChoicesToDatabase(classChoices).catch(error => {
                    console.warn('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®ä¿å­˜ã«å¤±æ•—:', error.message);
                });
            }

        } catch (error) {
            hideProgressBar();
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°å¤±æ•—ã®å ´åˆã¯ç‰¹åˆ¥ãªå‡¦ç†
            if (error.message && error.message.includes('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ')) {
                console.warn('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', error.message);
                showMessage('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã¯å®Œäº†ã—ã¾ã—ãŸãŒã€ä¸€éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¾ã™ã€‚', 'warning');
                
                // UIã‚’æ›´æ–°ã—ã¦ç¶šè¡Œ
                try {
                    await loadStatus();
                } catch (statusError) {
                    console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¤±æ•—:', statusError);
                }
                return;
            }
            
            handleError(error, 'createFormWithConfig', 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        }
    }

    /**
     * ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†å‡¦ç†ã‚’å®Ÿè¡Œ
     * @param {Object} result - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆçµæœ
     * @param {string} successMessage - æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    async function completeFormCreationProcess(result, successMessage) {
        return new Promise((resolve) => {
            setTimeout(async () => {
                try {
                    hideProgressBar();
                    showMessage(successMessage, 'success');
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ç·¨é›†ãƒšãƒ¼ã‚¸ã‚’é–‹ã
                    if (result.editFormUrl) {
                        window.open(result.editFormUrl, '_blank');
                    } else if (result.formUrl) {
                        const editUrl = result.formUrl.replace('/viewform', '/edit');
                        window.open(editUrl, '_blank');
                    }
                    
                    // UI ã‚’éåŒæœŸã§æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
                    await updateUIAfterFormCreation(result);
                    resolve();
                } catch (error) {
                    console.warn('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
                    resolve(); // ã‚¨ãƒ©ãƒ¼ã§ã‚‚å‡¦ç†ã¯å®Œäº†ã¨ã¿ãªã™
                }
            }, 1000);
        });
    }

    /**
     * æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
     * @param {Object} result - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆçµæœ
     */
    async function handleManualFormSetup(result) {
        showProgressStep(5, 5, 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†');
        return completeFormCreationProcess(result, 'âœ… ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼è¨­å®šã‚¿ãƒ–ã§è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚');
    }

    /**
     * ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå¾Œã®UIæ›´æ–°å‡¦ç†
     * @param {Object} result - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆçµæœ
     */
    async function updateUIAfterFormCreation(result) {
        try {
            console.log('ğŸš€ [DEBUG] ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå¾ŒUIæ›´æ–°é–‹å§‹:', { 
                hasFormUrl: !!result.formUrl, 
                hasEditFormUrl: !!result.editFormUrl 
            });
            
            // ğŸ”¥ å¼·åŠ›ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢: è¤‡æ•°ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¯ãƒªã‚¢
            cacheManager.invalidateDependents('form_creation');
            cacheManager.invalidateDependents('user_data_change');
            cacheManager.invalidateDependents('config_change');
            
            // ğŸ”¥ è¿½åŠ : å€‹åˆ¥ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚å¼·åˆ¶ã‚¯ãƒªã‚¢
            cacheManager.invalidate('status');
            cacheManager.invalidate('formUrls');
            cacheManager.invalidate('sheetDetails');
            
            console.log('ğŸ—‘ï¸ [DEBUG] å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†');
            
            // ğŸ”„ æ®µéšçš„UIæ›´æ–°: ã¾ãšçµæœãƒ‡ãƒ¼ã‚¿ã§å³åº§ã«UIæ›´æ–°
            if (result.formUrl) {
                console.log('âš¡ [DEBUG] å³åº§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯UIæ›´æ–°å®Ÿè¡Œ');
                updateFormUrlSection({
                    formUrl: result.formUrl, 
                    editFormUrl: result.editFormUrl,
                    customFormInfo: result.customFormInfo || null
                });
            }
            
            // ğŸ”„ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§ç¢ºå®Ÿã«UIæ›´æ–°
            try {
                console.log('ğŸ“¡ [DEBUG] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å†å–å¾—é–‹å§‹');
                
                // ğŸ• å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆDBã®åæ˜ ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ï¼‰
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const newStatus = await withTimeout(loadStatus(true), 30000, 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                
                console.log('âœ… [DEBUG] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å†å–å¾—æˆåŠŸ:', {
                    hasFormUrl: !!newStatus.formUrl,
                    hasEditFormUrl: !!newStatus.editFormUrl,
                    hasUserInfo: !!newStatus.userInfo,
                    hasConfigJson: !!(newStatus.userInfo && newStatus.userInfo.configJson),
                    formUrl: newStatus.formUrl
                });
                
                // ğŸ”„ æœ€çµ‚UIæ›´æ–°: æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§UIå…¨ä½“ã‚’æ›´æ–°
                if (newStatus.formUrl || (newStatus.userInfo && newStatus.userInfo.configJson)) {
                    console.log('âœ… [DEBUG] æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§UIæœ€çµ‚æ›´æ–°å®Ÿè¡Œ');
                    updateFormUrlSection(newStatus);
                } else {
                    console.warn('âš ï¸ [DEBUG] æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã«ãƒ•ã‚©ãƒ¼ãƒ URLãªã—ã€çµæœãƒ‡ãƒ¼ã‚¿ã‚’ç¶­æŒ');
                }
                
            } catch (statusError) {
                console.warn('âš ï¸ [DEBUG] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—å¤±æ•—:', statusError);
                console.log('ğŸ”„ [DEBUG] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦çµæœãƒ‡ãƒ¼ã‚¿ã®ã¿ã§UIæ›´æ–°');
            }
            
        } catch (error) {
            console.error('âŒ [DEBUG] UIæ›´æ–°å‡¦ç†ã§è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:', error);
            // æœ€å¾Œã®æ‰‹æ®µ: çµæœãƒ‡ãƒ¼ã‚¿ã§å¼·åˆ¶æ›´æ–°
            if (result.formUrl) {
                console.log('ğŸ†˜ [DEBUG] ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: çµæœãƒ‡ãƒ¼ã‚¿ã§å¼·åˆ¶UIæ›´æ–°');
                updateFormUrlSection({formUrl: result.formUrl, editFormUrl: result.editFormUrl});
            }
        }
    }

    /**
     * ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã®Promiseå®Ÿè¡Œ
     * @param {Promise} promise - å®Ÿè¡Œã™ã‚‹Promise
     * @param {number} timeoutMs - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
     * @param {string} timeoutMessage - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @returns {Promise} ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã®Promise
     */
    function withTimeout(promise, timeoutMs, timeoutMessage) {
        const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => {
                reject(new Error(timeoutMessage || 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
            }, timeoutMs);
        });

        return Promise.race([promise, timeoutPromise]);
    }

    /**
     * ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
     * @param {Array} classChoices - ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®é…åˆ—
     * @returns {Promise} ä¿å­˜å‡¦ç†ã®Promise
     */
    async function saveClassChoicesToDatabase(classChoices) {
        try {
            const result = await withTimeout(
                runGasWithUserId('saveClassChoices', classChoices),
                30000,  // 30ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                'ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®ä¿å­˜ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'
            );
            console.log('âœ… ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸ');
            return result;
        } catch (error) {
            console.warn('âš ï¸ ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®ä¿å­˜ã«å¤±æ•—:', error.message);
            throw error;
        }
    }

    /**
     * å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ or ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ã‚’è¿½åŠ ã™ã‚‹
     */
    async function addResource() {
      const url = document.getElementById('resource-url-input').value;
      if (!url) {
        showMessage('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
        return;
      }

      setLoading(true, 'ãƒªã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™...');
      
      try {
        const result = await withTimeout(
          runGasWithUserId('addSpreadsheetUrl', url),
          120000,  // 2åˆ†ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
          'ãƒªã‚½ãƒ¼ã‚¹è¿½åŠ å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚'
        );
        
        if (result.status === 'success') {
          showMessage(result.message, 'success');
          await loadStatus(true);
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        handleError(error, 'addResource', 'ãƒªã‚½ãƒ¼ã‚¹ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      } finally {
        setLoading(false);
      }
    }
    
    /**
     * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
     */
    function openDatabaseSpreadsheet() {
        if (appState.currentSpreadsheetUrl) {
            window.open(appState.currentSpreadsheetUrl, '_blank');
        } else {
            showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'warning');
        }
    }

    /**
     * é€£æºã—ã¦ã„ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
     */
    function openForm() {
        if (appState.currentStatus && appState.currentStatus.formUrl) {
            window.open(appState.currentStatus.formUrl, '_blank');
        } else {
            showMessage('é€£æºã—ã¦ã„ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'warning');
        }
    }

    /**
     * ãƒœãƒ¼ãƒ‰ã®URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
     */
    function copyBoardUrl() {
        const urlInput = document.getElementById('board-url');
        if (urlInput) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(urlInput.value);
                } else {
                    urlInput.select();
                    document.execCommand('copy');
                }
                showMessage('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
    }
    
    /**
     * ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã‚’å®šæœŸçš„ã«æ›´æ–°
     */
    // ã‚¹ãƒãƒ¼ãƒˆãƒãƒ¼ãƒªãƒ³ã‚°å®Ÿè£…
    let lastUserActivity = Date.now();
    let currentPollInterval = 5 * 60 * 1000; // é–‹å§‹ã¯5åˆ†é–“éš”
    let statusPollTimer = null;
    
    function updateUserActivity() {
      lastUserActivity = Date.now();
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒã‚ã£ãŸå ´åˆã€ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’ãƒªã‚»ãƒƒãƒˆ
      if (currentPollInterval > 2 * 60 * 1000) {
        currentPollInterval = 2 * 60 * 1000; // 2åˆ†ã«çŸ­ç¸®
        restartStatusPolling();
      }
    }
    
    function getOptimalPollInterval() {
      const timeSinceActivity = Date.now() - lastUserActivity;
      if (timeSinceActivity < 5 * 60 * 1000) {
        return 2 * 60 * 1000; // 5åˆ†ä»¥å†…ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£: 2åˆ†é–“éš”
      } else if (timeSinceActivity < 15 * 60 * 1000) {
        return 5 * 60 * 1000; // 15åˆ†ä»¥å†…: 5åˆ†é–“éš”
      } else {
        return 10 * 60 * 1000; // 15åˆ†ä»¥ä¸Š: 10åˆ†é–“éš”
      }
    }
    
    function restartStatusPolling() {
      if (statusPollTimer) {
        clearInterval(statusPollTimer);
      }
      currentPollInterval = getOptimalPollInterval();
      startSystemStatusUpdate();
    }
    
    function startSystemStatusUpdate() {
      statusPollTimer = setInterval(function() {
        // UIãŒéè¡¨ç¤ºã®æ™‚ã¯æ›´æ–°ã—ãªã„
        if (document.hidden) return;
        
        // ç¾åœ¨ã®ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´
        const optimalInterval = getOptimalPollInterval();
        if (optimalInterval !== currentPollInterval) {
          restartStatusPolling();
          return;
        }
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
        getCachedStatus(false)
          .then(function(status) {
            // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿UIã‚’æ›´æ–°
            if (JSON.stringify(status) !== JSON.stringify(appState.currentStatus)) {
              updateUIWithNewStatus(status);
              console.log('ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
            }
          })
          .catch(function(error) {
            // ã‚¨ãƒ©ãƒ¼ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã®ã¿å‡ºåŠ›
            console.warn('Silent status update failed:', error.message);
          });
      }, currentPollInterval);
      
      console.log(`â° ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹: ${currentPollInterval / 1000}ç§’é–“éš”`);
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ç›£è¦–
    document.addEventListener('click', updateUserActivity);
    document.addEventListener('keypress', updateUserActivity);
    document.addEventListener('scroll', updateUserActivity);

    function openAppSetupPage() {
      // ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
      runGasWithUserId('getWebAppUrlCached')
        .then(function(webAppUrl) {
          const setupUrl = webAppUrl + '?setup=true&mode=appsetup';
          window.open(setupUrl, '_blank');
        })
        .catch(function(error) {
          console.error('WebApp URLå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç¾åœ¨ã®URLã‚’ä½¿ç”¨
          const currentUrl = window.location.href.split('?')[0];
          const setupUrl = currentUrl + '?setup=true&mode=appsetup';
          window.open(setupUrl, '_blank');
        });
    }
    
    function switchToAnotherAccount() {
      // åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ãŸã‚ã«ç®¡ç†ãƒ‘ãƒãƒ«ã‚’å†èª­ã¿è¾¼ã¿
      if (window.sharedUtilities && window.sharedUtilities.navigation) {
        window.sharedUtilities.navigation.safeNavigate('?page=AdminPanel&forceAuth=true', {
          fallbackMessage: 'åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­...',
          method: 'auto'
        });
      } else {
        window.location.href = '?page=AdminPanel&forceAuth=true';
      }
    }
    
    function deleteAllResources() {
      // å…¨ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ã®å®Ÿè¡Œ
      setLoading(true, 'å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­...');
      runGasWithUserId('deleteAllResources')
        .then(function(response) {
          console.log('ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
          showMessage(response.message || 'âœ… å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
          setLoading(false);
          // UIã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
          loadStatus(true);
        })
        .catch(function(error) {
          handleError(error, 'deleteAllResources');
          setLoading(false);
        });
    }

  </script>

  <!-- ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="form-config-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="glass-panel rounded-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-8">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-cyan-400">æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ</h3>
          <button type="button" id="form-config-close" class="text-gray-400 hover:text-white transition-colors" title="é–‰ã˜ã‚‹">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <div class="space-y-6">
          <!-- ã‚¹ãƒ†ãƒƒãƒ—0: ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã®è¨­å®š -->
          <!-- ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ -->

          <!-- ã‚¹ãƒ†ãƒƒãƒ—1: å•é¡Œæ–‡ã®å…¥åŠ› -->
          <div class="glass-panel bg-blue-500/5 border border-blue-400/20 rounded-lg p-4">
            <div class="flex items-center gap-2 mb-3">
              <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">1</div>
              <h4 class="text-lg font-semibold text-blue-400">è³ªå•å†…å®¹ã‚’å…¥åŠ›</h4>
              <span class="text-xs text-gray-400 bg-gray-700/50 px-2 py-1 rounded">å¿…é ˆ</span>
            </div>
            <textarea 
              id="custom-main-question" 
              rows="3" 
              class="w-full p-3 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white text-sm placeholder-gray-400 focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition-colors" 
              placeholder="ä¾‹ï¼šä»Šæ—¥ã®æˆæ¥­ã§å­¦ã‚“ã ã“ã¨ã®ä¸­ã§ã€æœ€ã‚‚å°è±¡ã«æ®‹ã£ãŸã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ"
              maxlength="500"
            ></textarea>
            <div class="flex justify-between items-center mt-2">
              <p class="text-xs text-gray-400">ğŸ’¡ å­¦ç¿’è€…ã«è¡¨ç¤ºã•ã‚Œã‚‹è³ªå•æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
              <span class="text-xs text-gray-500" id="question-counter">0/500</span>
            </div>
          </div>

          <!-- ã‚¹ãƒ†ãƒƒãƒ—2: å›ç­”æ–¹æ³•ã®é¸æŠ -->
          <div class="glass-panel bg-green-500/5 border border-green-400/20 rounded-lg p-4">
            <div class="flex items-center gap-2 mb-3">
              <div class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold">2</div>
              <h4 class="text-lg font-semibold text-green-400">å›ç­”æ–¹æ³•ã‚’é¸æŠ</h4>
            </div>
            <select id="main-question-type" class="w-full p-3 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white text-sm focus:border-green-400 focus:ring-1 focus:ring-green-400 transition-colors" title="å›ç­”æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„">
              <option value="choice" selected>é¸æŠè‚¢ï¼ˆå˜ä¸€é¸æŠï¼‰</option>
              <option value="multiple">é¸æŠè‚¢ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</option>
              <option value="text">çŸ­æ–‡ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ1è¡Œå›ç­”ï¼‰</option>
            </select>
            <p class="text-xs text-gray-400 mt-2">ğŸ’¡ ã™ã¹ã¦ã®å›ç­”æ–¹æ³•ã§ã€å›ç­”ã®ç†ç”±ã‚’å…¥åŠ›ã™ã‚‹æ¬„ãŒè‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™</p>
          </div>

          <!-- é¸æŠè‚¢è¨­å®šï¼ˆé¸æŠè‚¢ã‚¿ã‚¤ãƒ—ã®å ´åˆï¼‰ -->
          <div id="main-question-choices-div" class="glass-panel bg-yellow-500/5 border border-yellow-400/20 rounded-lg p-4">
            <div class="flex items-center gap-2 mb-3">
              <div class="w-6 h-6 bg-yellow-500 text-white rounded-full flex items-center justify-center text-sm font-bold">3</div>
              <h4 class="text-lg font-semibold text-yellow-400">é¸æŠè‚¢ã‚’è¨­å®š</h4>
            </div>
            <textarea id="main-question-choices" rows="4" class="w-full p-3 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white text-sm placeholder-gray-400 focus:border-yellow-400 focus:ring-1 focus:ring-yellow-400 transition-colors" placeholder="ä¾‹ï¼š&#10;æ°—ã¥ã„ãŸã“ã¨ãŒã‚ã‚‹ã€‚&#10;ç–‘å•ã«æ€ã†ã“ã¨ãŒã‚ã‚‹ã€‚&#10;ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ã“ã¨ãŒã‚ã‚‹ã€‚"></textarea>
            <p class="text-xs text-gray-400 mt-2">ğŸ’¡ å­¦ç¿’è€…ãŒé¸æŠã§ãã‚‹é¸æŠè‚¢ã‚’1è¡Œã«1ã¤ãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹ã®ã‚ˆã†ãªè©•ä¾¡è»¸ã‚„ã€å…·ä½“çš„ãªé¸æŠè‚¢ã‚’è¨­å®šã§ãã¾ã™ã€‚</p>
            
            <div class="mt-4">
              <label class="flex items-center">
                <input type="checkbox" id="include-others-option" class="mr-2 rounded bg-gray-700 border-gray-600 text-yellow-500 focus:ring-yellow-400" checked>
                <span class="text-sm text-gray-300">ã€Œãã®ä»–...ã€é¸æŠè‚¢ã‚’è¿½åŠ ã™ã‚‹</span>
              </label>
              <p class="text-xs text-gray-400 mt-1 ml-6">ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã€å­¦ç¿’è€…ãŒè‡ªç”±ã«å›ç­”ã‚’å…¥åŠ›ã§ãã‚‹ã€Œãã®ä»–...ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™</p>
            </div>
          </div>

          <!-- ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¯ãƒ©ã‚¹è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ -->
          <div class="glass-panel bg-purple-500/5 border border-purple-400/20 rounded-lg p-4">
            <div class="flex items-center gap-2 mb-3">
              <div class="w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm font-bold">4</div>
              <h4 class="text-lg font-semibold text-purple-400">ã‚¯ãƒ©ã‚¹è¨­å®š</h4>
              <span class="text-xs text-gray-400 bg-gray-700/50 px-2 py-1 rounded">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</span>
            </div>
            <div class="mb-3">
              <label class="flex items-center">
                <input type="checkbox" id="enable-class-selection" class="mr-2 rounded bg-gray-700 border-gray-600 text-purple-500 focus:ring-purple-400" checked>
                <span class="text-sm text-gray-300">ã‚¯ãƒ©ã‚¹é¸æŠã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
              </label>
            </div>
            <div id="class-choices-container">
              <textarea id="class-choices" rows="3" class="w-full p-3 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white text-sm placeholder-gray-400 focus:border-purple-400 focus:ring-1 focus:ring-purple-400 transition-colors" placeholder="ä¾‹ï¼š&#10;ã‚¯ãƒ©ã‚¹1&#10;ã‚¯ãƒ©ã‚¹2&#10;ã‚¯ãƒ©ã‚¹3&#10;ã‚¯ãƒ©ã‚¹4"></textarea>
              <p class="text-xs text-gray-400 mt-2">1è¡Œã«1ã¤ãšã¤ã‚¯ãƒ©ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            </div>
          </div>
        </div>

        <div class="flex gap-3 mt-8">
          <button type="button" id="form-config-cancel" class="flex-1 px-6 py-3 bg-gray-600/80 text-gray-200 rounded-lg hover:bg-gray-600 transition-colors font-medium">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button type="button" id="form-config-create" class="flex-1 px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-colors font-medium shadow-lg">
            ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="privacy-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
    <div class="glass-panel rounded-xl max-w-md w-full mx-4">
      <div class="p-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-white">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã®ç¢ºèª</h3>
        </div>
        
        <div class="mb-6">
          <p class="text-gray-300 leading-relaxed">ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
        </div>
        
        <div class="flex gap-3">
          <button type="button" id="privacy-modal-cancel" class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button type="button" id="privacy-modal-continue" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium">
            ç¶šè¡Œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ‡ã‚¸ã‚¿ãƒ«ã‚·ãƒ†ã‚£ã‚ºãƒ³ã‚·ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="digital-citizenship-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
    <div class="glass-panel rounded-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-white">ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚·ãƒ†ã‚£ã‚ºãƒ³ã‚·ãƒƒãƒ—æŒ‡å°</h3>
          <button type="button" id="digital-citizenship-modal-close" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
        </div>
        
        <div class="mb-6">
          <p class="text-gray-300 leading-relaxed mb-4">ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚·ãƒ†ã‚£ã‚ºãƒ³ã‚·ãƒƒãƒ—ã«åŸºã¥ãå›ç­”ãƒœãƒ¼ãƒ‰æŒ‡å°ã®ãƒã‚¤ãƒ³ãƒˆï¼š</p>
          <ul class="list-disc pl-5 space-y-2 text-gray-300">
            <li>å»ºè¨­çš„ãªæ„è¦‹äº¤æ›ã‚’ä¿ƒé€²ã™ã‚‹</li>
            <li>ä»–è€…ã®æ„è¦‹ã‚’å°Šé‡ã™ã‚‹æ…‹åº¦ã‚’è‚²ã‚€</li>
            <li>æƒ…å ±ã®ä¿¡é ¼æ€§ã‚’æ¤œè¨¼ã™ã‚‹ç¿’æ…£ã‚’èº«ã«ã¤ã‘ã‚‹</li>
            <li>ãƒ‡ã‚¸ã‚¿ãƒ«ç’°å¢ƒã§ã®é©åˆ‡ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å­¦ã¶</li>
          </ul>
        </div>
        
        <div class="text-right">
          <button type="button" id="digital-citizenship-modal-close-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
            é–‰ã˜ã‚‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ä½¿ç”¨ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="usage-guide-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
    <div class="glass-panel rounded-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-white">ä½¿ç”¨ã‚¬ã‚¤ãƒ‰</h3>
          <button type="button" id="usage-guide-modal-close" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
        </div>
        
        <div class="mb-6">
          <p class="text-gray-300 leading-relaxed mb-4">å›ç­”ãƒœãƒ¼ãƒ‰ã®ä½¿ç”¨æ–¹æ³•ï¼š</p>
          <div class="space-y-3 text-gray-300">
            <div class="p-3 bg-gray-700/30 rounded-lg">
              <h4 class="font-medium text-white mb-2">ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿æº–å‚™</h4>
              <p class="text-sm">Googleãƒ•ã‚©ãƒ¼ãƒ ã¾ãŸã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’Workspaceä¸Šã§è‡ªå‹•ä½œæˆã—ã¾ã™ã€‚</p>
            </div>
            <div class="p-3 bg-gray-700/30 rounded-lg">
              <h4 class="font-medium text-white mb-2">ã‚¹ãƒ†ãƒƒãƒ—2: ã‚·ãƒ¼ãƒˆé¸æŠ</h4>
              <p class="text-sm">è¡¨ç¤ºã—ãŸã„ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¾ã™ã€‚</p>
            </div>
            <div class="p-3 bg-gray-700/30 rounded-lg">
              <h4 class="font-medium text-white mb-2">ã‚¹ãƒ†ãƒƒãƒ—3: è¨­å®šãƒ»å…¬é–‹</h4>
              <p class="text-sm">åˆ—è¨­å®šã‚’è¡Œã„ã€å›ç­”ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¾ã™ã€‚</p>
            </div>
          </div>
        </div>
        
        <div class="text-right">
          <button type="button" id="usage-guide-modal-close-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
            é–‰ã˜ã‚‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="confirmation-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
    <div class="glass-panel rounded-xl max-w-md w-full mx-4">
      <div class="p-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 bg-yellow-500/20 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          <h3 id="modal-title" class="text-xl font-semibold text-white">ç¢ºèª</h3>
        </div>
        
        <div class="mb-6">
          <p id="modal-message" class="text-gray-300 leading-relaxed whitespace-pre-line">æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</p>
        </div>
        
        <div class="flex gap-3">
          <button type="button" id="modal-cancel" class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button type="button" id="modal-confirm" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium">
            å®Ÿè¡Œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨JavaScript -->
  <script>
  // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ©Ÿèƒ½ï¼ˆã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ã¯å‰Šé™¤æ¸ˆã¿ï¼‰
  function setupCharacterCounters() {
    const questionTextarea = document.getElementById('custom-main-question');
    const questionCounter = document.getElementById('question-counter');

    if (questionTextarea && questionCounter) {
      questionTextarea.addEventListener('input', function() {
        const count = this.value.length;
        questionCounter.textContent = `${count}/500`;
        questionCounter.className = count > 450 ? 'text-xs text-red-400' : 'text-xs text-gray-500';
      });
    }
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    setupCharacterCounters();
  });

  // ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã‹ã‚ŒãŸã¨ãã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
  const originalShowFormConfigModal = window.showFormConfigModal;
  if (typeof originalShowFormConfigModal === 'function') {
    window.showFormConfigModal = function() {
      originalShowFormConfigModal();
      setTimeout(setupCharacterCounters, 100); // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    };
  }
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã®éœ²å‡ºï¼ˆãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆç”¨ï¼‰
  window.saveAndPublish = saveAndPublish;
  window.unpublishBoard = unpublishBoard;
  window.copyBoardUrl = copyBoardUrl;
  window.openDatabaseSpreadsheet = openDatabaseSpreadsheet;
  window.openForm = openForm;
  window.switchToAnotherAccount = switchToAnotherAccount;
  window.openAppSetupPage = openAppSetupPage;
  window.deleteAllResources = deleteAllResources;
  </script>

</body>
</html>
