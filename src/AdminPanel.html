<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <title>みんなの回答ボード 管理パネル - StudyQuest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#1a1b26" />
  <meta name="description" content="StudyQuestの回答ボード管理パネル - 直感的で使いやすい教育ツール" />
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=()" />
  <!-- User ID from server template -->
  <meta name="user-id" content="<?= typeof userId !== 'undefined' ? userId : '' ?>" id="user-id-meta">

  <!-- TailwindCSS CDN -->
  <script>
    // TailwindCSS 本番警告を抑制
    window.tailwind = {
      config: {
        corePlugins: {
          preflight: false,
        },
        prefix: '',
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com" defer onerror="console.warn('TailwindCSS failed to load')"></script>

  <!-- Consolidated Unified Styles -->
  <style>
/* =============================================================================
   StudyQuest - Unified CSS Styles
   Based on AdminPanel.html with additional styles from all HTML files
   ============================================================================= */

/* CSS Variables - Glassmorphism Design System */
:root {
  /* Glassmorphism Color Palette - Based on Registration.html */
  --color-primary: #06b6d4;
  --color-primary-end: #a855f7;
  --color-background: linear-gradient(135deg, #1a1b26 0%, #0f172a 50%, #1e1b4b 100%);
  --color-surface: rgba(255, 255, 255, 0.08);
  --color-surface-hover: rgba(255, 255, 255, 0.12);
  --color-text: #ffffff;
  --color-text-secondary: rgba(255, 255, 255, 0.8);
  --color-text-muted: rgba(255, 255, 255, 0.7);
  --color-border: rgba(255, 255, 255, 0.2);
  --color-border-hover: rgba(255, 255, 255, 0.3);
  --color-accent: #facc15;
  
  /* Status Colors - Glassmorphism Compatible */
  --color-success: #10b981;
  --color-success-bg: rgba(16, 185, 129, 0.1);
  --color-success-border: rgba(16, 185, 129, 0.3);
  --color-error: #ef4444;
  --color-error-bg: rgba(239, 68, 68, 0.1);
  --color-error-border: rgba(239, 68, 68, 0.3);
  --color-warning: #f59e0b;
  --color-warning-bg: rgba(245, 158, 11, 0.1);
  --color-warning-border: rgba(245, 158, 11, 0.3);
  --color-info: #3b82f6;
  --color-info-bg: rgba(59, 130, 246, 0.1);
  --color-info-border: rgba(59, 130, 246, 0.3);
  
  /* Google Workspace Colors */
  --color-google-blue: #4285f4;
  --color-google-green: #34a853;
  --color-google-yellow: #fbbc05;
  --color-google-red: #ea4335;
  
  /* Glassmorphism Shadow System */
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.15);
  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.1);
  --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
  
  /* Animation and Transition System */
  --transition-duration: 0.3s;
  --transition-easing: ease;
  --animation-duration: 0.6s;
  --backdrop-blur: 20px;
  
  /* Gradient System */
  --gradient-primary: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-end) 100%);
  --gradient-background: linear-gradient(135deg, #1a1b26 0%, #0f172a 50%, #1e1b4b 100%);
  --gradient-radial-accent: radial-gradient(ellipse at top left, rgba(6, 182, 212, 0.1) 0%, transparent 70%), radial-gradient(ellipse at bottom right, rgba(168, 85, 247, 0.08) 0%, transparent 70%);
  
  /* Additional Consolidated Variables from removed duplicate sections */
  --bg-primary: #1a1b26;
  --bg-secondary: #24283b;
  --bg-tertiary: #414868;
  --bg-accent: rgba(255, 255, 255, 0.08);
  --glass-bg: rgba(255, 255, 255, 0.08);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  --glass-inset: inset 0 1px 0 rgba(255, 255, 255, 0.2);
  --accent-cyan: #06b6d4;
  --accent-purple: #a855f7;
  --accent-green: #10b981;
  --accent-amber: #f59e0b;
  --accent-red: #ef4444;
  --text-primary: #ffffff;
  --text-secondary: #e2e8f0;
  --text-tertiary: #94a3b8;
  --text-muted: #64748b;
}

/* Base Styles - Glassmorphism Foundation with Proper Specificity */
.unified-theme html, 
.unified-theme html[lang="ja"],
html.unified-theme, 
html[lang="ja"].unified-theme {
  background: var(--gradient-background);
  min-height: 100vh;
  width: 100%;
  margin: 0;
  padding: 0;
}

.unified-theme body,
body.unified-theme { 
  background: var(--gradient-background);
  min-height: 100vh;
  margin: 0;
  padding: 20px;
  color: var(--color-text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  line-height: 1.6;
  overflow-x: hidden;
  width: 100%;
}

/* Global radial gradient overlay for glassmorphism effect */
.unified-theme body::before,
body.unified-theme::before {
  content: '';
  position: fixed;
  top: 0; 
  left: 0;
  width: 100%; 
  height: 100%;
  background: var(--gradient-radial-accent);
  z-index: -1;
}

/* Global box-sizing reset for glassmorphism compatibility */
.unified-theme html, .unified-theme body, .unified-theme div, .unified-theme span, 
.unified-theme h1, .unified-theme h2, .unified-theme h3, .unified-theme h4, .unified-theme h5, .unified-theme h6, 
.unified-theme p, .unified-theme button, .unified-theme a {
  box-sizing: border-box;
}

/* Glass Panel Effects - Glassmorphism System */
.unified-theme .glass-panel { 
  background: var(--color-surface);
  -webkit-backdrop-filter: blur(var(--backdrop-blur));
  backdrop-filter: blur(var(--backdrop-blur));
  border: 1px solid var(--color-border);
  box-shadow: var(--shadow-glass);
  border-radius: 24px;
  transition: all var(--transition-duration) var(--transition-easing);
  position: relative;
  /* Prevent creating new stacking context that blocks modals */
  isolation: auto;
}

.unified-theme .glass-panel:hover { 
  border-color: var(--color-border-hover);
  will-change: border-color; 
}

/* Glass Container - Main container for pages */
.unified-theme .glass-container {
  background: var(--color-surface);
  -webkit-backdrop-filter: blur(var(--backdrop-blur));
  backdrop-filter: blur(var(--backdrop-blur));
  border-radius: 24px;
  border: 1px solid var(--color-border);
  box-shadow: var(--shadow-glass);
  width: 100%;
  max-width: 420px;
  padding: 40px 32px;
  position: relative;
  z-index: 1;
  text-align: center;
  animation: fadeIn var(--animation-duration) ease-out;
  isolation: auto;
}

/* Centered glass containers for main content */
.unified-theme .centered-glass-layout {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
}

/* Google Workspace Integration Styles */
.google-integration {
  background: linear-gradient(135deg, var(--color-google-blue), var(--color-google-green));
  border: 1px solid rgba(66, 133, 244, 0.3);
}

.google-integration:hover {
  border-color: rgba(66, 133, 244, 0.5);
  box-shadow: 0 4px 20px rgba(66, 133, 244, 0.2);
}

/* Glassmorphism Button System */
.unified-theme .btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 16px 24px;
  border-radius: 12px;
  font-weight: 600;
  transition: all var(--transition-duration) var(--transition-easing);
  cursor: pointer;
  border: none;
  text-decoration: none;
  min-height: 44px;
  min-width: 44px;
  position: relative;
  overflow: hidden;
  font-size: 16px;
  color: white;
}

.unified-theme .btn:disabled { 
  opacity: 0.6; 
  cursor: not-allowed; 
  transform: none;
}

.unified-theme .btn:not(:disabled):hover { 
  transform: translateY(-1px); 
  will-change: transform; 
}

.unified-theme .btn:not(:disabled):active { 
  transform: translateY(0); 
}

/* Glassmorphism Button Variants */
.unified-theme .btn-primary, .unified-theme .register-btn, .unified-theme .cta-button { 
  width: 100%;
  background: var(--gradient-primary);
  border: none;
  border-radius: 12px;
  padding: 16px 24px;
  font-size: 16px;
  font-weight: 600;
  color: white;
  cursor: pointer;
  transition: all var(--transition-duration) var(--transition-easing);
  margin-bottom: 24px;
}

.unified-theme .btn-primary:hover:not(:disabled), .unified-theme .register-btn:hover:not(:disabled) { 
  transform: translateY(-1px); 
  box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4); 
}

.unified-theme .btn-secondary, .unified-theme .action-btn.secondary { 
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid var(--color-border);
  color: var(--color-text);
}

.unified-theme .btn-danger { 
  background: var(--color-error);
  color: white;
}

.unified-theme .btn-google {
  background: linear-gradient(135deg, var(--color-google-blue), var(--color-google-green));
  color: white;
  font-weight: 700;
}

.unified-theme .btn-success {
  background: var(--color-success);
  color: white;
}

.unified-theme .btn-warning {
  background: var(--color-warning);
  color: white;
}

/* Action Buttons */
.unified-theme .action-btn { 
  display: block; 
  padding: 14px 24px; 
  border-radius: 10px; 
  border: none; 
  font-size: 15px; 
  font-weight: 600; 
  text-decoration: none; 
  color: white; 
  margin-top: 12px; 
  cursor: pointer; 
}

.unified-theme .action-btn.primary { 
  background: var(--gradient-primary); 
}

/* Game-Style Buttons (from Page.html) */
.game-btn {
  background: linear-gradient(135deg, var(--color-primary), #50fa7b);
  color: #000;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  box-shadow: 0 4px 0 rgba(0,0,0,0.2);
  transition: all 0.1s ease;
  border: 2px solid transparent;
}

.game-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 5px 0 rgba(0,0,0,0.2);
}

.game-btn:active {
  transform: translateY(2px);
  box-shadow: 0 2px 0 rgba(0,0,0,0.2);
}

/* CTA Button with Shimmer Effect */
.cta-button {
  position: relative;
  overflow: hidden;
  background: linear-gradient(135deg, var(--color-primary), #50fa7b);
  color: #000;
  font-weight: 700;
}

.cta-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.5s ease;
}

.cta-button:hover::before {
  left: 100%;
}

/* Glassmorphism Header System */
.unified-theme .header { 
  margin-bottom: 40px; 
}

.unified-theme .logo {
  width: 56px; 
  height: 56px;
  background: var(--gradient-primary);
  border-radius: 16px;
  margin: 0 auto 16px;
  display: flex; 
  align-items: center; 
  justify-content: center;
  font-size: 24px; 
  color: white; 
  font-weight: 600;
}

.unified-theme .title { 
  font-size: 28px; 
  font-weight: 700; 
  color: white; 
  margin-bottom: 8px; 
}

.unified-theme .subtitle { 
  font-size: 16px; 
  color: var(--color-text-muted); 
  margin-bottom: 0; 
}

/* Status Card System */
.unified-theme .status-card {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 16px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  padding: 20px;
  margin-bottom: 32px;
}

.unified-theme .status-text { 
  font-size: 14px; 
  color: var(--color-text-secondary); 
  margin-bottom: 8px; 
}

.unified-theme .user-email { 
  font-size: 16px; 
  font-weight: 600; 
  color: white; 
  word-break: break-all; 
}

/* Success Container */
.success-container { 
  display: none; 
}

.unified-theme .success-icon { 
  width: 64px; 
  height: 64px; 
  background: var(--color-success); 
  border-radius: 50%; 
  margin: 0 auto 24px; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  font-size: 28px; 
  color: white; 
}

/* Form Controls - Glassmorphism Style */
.form-control {
  width: 100%;
  padding: 1rem 1.25rem;
  background: rgba(255,255,255,0.08);
  border: 1px solid var(--color-border);
  border-radius: 0.75rem;
  color: var(--color-text);
  transition: all var(--transition-duration) var(--transition-easing);
  font-size: 16px;
  min-height: 52px;
  line-height: 1.5;
}

.form-control:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(139, 233, 253, 0.1);
  background: rgba(255,255,255,0.08);
}

.form-control:hover {
  border-color: rgba(255,255,255,0.3);
}

.form-control::placeholder {
  color: rgba(192, 202, 245, 0.5);
}

/* Status Indicators */
.status-indicator { 
  width: 8px; 
  height: 8px; 
  border-radius: 50%; 
  display: inline-block; 
  margin-right: 8px;
}

.status-active { 
  background-color: var(--color-success); 
  box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); 
}

.status-inactive { 
  background-color: var(--color-warning); 
}

.status-error { 
  background-color: var(--color-error); 
}

/* Answer Card System (from Page.html) */
.answer-card {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 1rem;
  padding: 1.5rem;
  transition: all var(--transition-duration) var(--transition-easing);
  position: relative;
  overflow: hidden;
}

.answer-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
  border-color: rgba(255,255,255,0.2);
}

.answer-card.highlighted {
  border-color: var(--color-accent);
  box-shadow: 0 0 20px rgba(250, 204, 21, 0.3);
  background: rgba(250, 204, 21, 0.05);
}

.answer-card.loading {
  opacity: 0.7;
  pointer-events: none;
}

/* Reaction System */
.reaction-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border: 1px solid var(--color-border);
  border-radius: 0.75rem;
  background: rgba(255,255,255,0.05);
  color: var(--color-text);
  transition: all var(--transition-duration) var(--transition-easing);
  cursor: pointer;
  font-size: 0.875rem;
  min-height: 36px;
}

.reaction-btn:hover {
  background: rgba(255,255,255,0.1);
  transform: translateY(-1px);
}

.reaction-btn.reacted {
  background: rgba(139, 233, 253, 0.2);
  border-color: var(--color-primary);
  color: var(--color-primary);
}

/* Reaction Button Variants */
.reaction-bg-like { background: rgba(16, 185, 129, 0.1); }
.reaction-bg-understand { background: rgba(59, 130, 246, 0.1); }
.reaction-bg-curious { background: rgba(245, 158, 11, 0.1); }

.reaction-border-1 { border-color: var(--color-success); }
.reaction-border-2 { border-color: var(--color-info); }
.reaction-border-3 { border-color: var(--color-warning); }

/* Highlight Button */
.highlight-btn {
  background: rgba(250, 204, 21, 0.1);
  border: 1px solid rgba(250, 204, 21, 0.3);
  color: var(--color-accent);
}

.highlight-btn:hover {
  background: rgba(250, 204, 21, 0.2);
  border-color: var(--color-accent);
}

/* Admin Toggle - Subtle button for administrators only */
.admin-toggle {
  font-size: 0.75rem;
  transition: all 0.2s ease;
}

.admin-toggle:hover {
  transform: translateY(-1px);
}

/* Step Indicator System (from Registration.html) */
.step-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  border: 2px solid var(--color-border);
  color: var(--color-text);
  font-weight: 600;
  position: relative;
  transition: all var(--transition-duration) var(--transition-easing);
}

.step-indicator.completed {
  background: var(--color-success);
  border-color: var(--color-success);
  color: white;
}

.step-indicator.active {
  background: var(--color-primary);
  border-color: var(--color-primary);
  color: #000;
  animation: pulse 2s infinite;
}

/* Feature Cards */
.feature-card {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 1rem;
  padding: 1.5rem;
  transition: all var(--transition-duration) var(--transition-easing);
}

.feature-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
  border-color: rgba(255,255,255,0.2);
}

/* Loading States */
.loading-skeleton {
  background: linear-gradient(90deg, 
    rgba(255,255,255,0.1) 25%, 
    rgba(255,255,255,0.2) 50%, 
    rgba(255,255,255,0.1) 75%);
  background-size: 200% 100%;
  animation: loading-skeleton 1.5s infinite;
  border-radius: 0.5rem;
  height: 20px;
}

.skeleton {
  background: linear-gradient(90deg, 
    rgba(255,255,255,0.1) 25%, 
    rgba(255,255,255,0.2) 50%, 
    rgba(255,255,255,0.1) 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s infinite;
  border-radius: 0.5rem;
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* Glassmorphism Spinner System */
.unified-theme .spinner {
  width: 20px; 
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top: 2px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  display: inline-block; 
  vertical-align: middle; 
  margin-right: 8px;
}

.spinner-small {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top: 2px solid var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.loading-spinner {
  width: 32px;
  height: 32px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

/* Domain Info System from Registration.html */
.unified-theme .domain-info {
  width: 100%;
  text-align: center;
}

.unified-theme .hidden {
  display: none;
}

.flex {
  display: flex;
}

.items-center {
  align-items: center;
}

.gap-2 {
  gap: 8px;
}

/* Gradient backgrounds */
.bg-gradient-to-r {
  background: linear-gradient(90deg, var(--tw-gradient-from), var(--tw-gradient-to));
}

.from-green-500\/10 {
  --tw-gradient-from: rgba(34, 197, 94, 0.1);
}

.to-emerald-500\/10 {
  --tw-gradient-to: rgba(16, 185, 129, 0.1);
}

.from-yellow-500\/10 {
  --tw-gradient-from: rgba(234, 179, 8, 0.1);
}

.to-orange-500\/10 {
  --tw-gradient-to: rgba(249, 115, 22, 0.1);
}

.from-blue-500\/10 {
  --tw-gradient-from: rgba(59, 130, 246, 0.1);
}

.to-purple-500\/10 {
  --tw-gradient-to: rgba(168, 85, 247, 0.1);
}

/* Border colors */
.border-green-400\/30 {
  border-color: rgba(74, 222, 128, 0.3);
}

.border-yellow-400\/30 {
  border-color: rgba(251, 191, 36, 0.3);
}

.border-blue-400\/30 {
  border-color: rgba(96, 165, 250, 0.3);
}

/* Text colors */
.text-green-400 {
  color: rgba(74, 222, 128, 1);
}

.text-yellow-400 {
  color: rgba(251, 191, 36, 1);
}

.text-blue-400 {
  color: rgba(96, 165, 250, 1);
}

.text-sm {
  font-size: 14px;
}

.font-semibold {
  font-weight: 600;
}

.w-4 {
  width: 16px;
}

.h-4 {
  height: 16px;
}

.p-3 {
  padding: 12px;
}

/* Progress Bar System */
.progress-bar {
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 16px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--color-primary), #50fa7b);
  transition: width 0.5s ease;
  border-radius: 2px;
}

/* Tooltip System */
.tooltip { 
  position: relative; 
}

.tooltip::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 12px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity var(--transition-duration);
  z-index: 1000;
  margin-bottom: 5px;
}

.tooltip:hover::after { 
  opacity: 1; 
}

/* Card Hover Effects */
.card-hover {
  transition: all var(--animation-duration) var(--transition-easing);
}

.card-hover:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(139, 233, 253, 0.15);
}

/* State Classes */
.error-state {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 0.75rem;
  padding: 1rem;
  color: #f87171;
}

.success-state {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: 0.75rem;
  padding: 1rem;
  color: #34d399;
}

/* Message System - Glassmorphism Style */
.unified-theme .message-area { 
  min-height: 24px; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  margin-bottom: 24px; 
  font-size: 14px; 
  color: var(--color-text-secondary); 
}

.unified-theme .message-area.error { 
  color: var(--color-error); 
}

.unified-theme .message-area.success { 
  color: var(--color-success); 
}

.unified-theme .message-area.warning { 
  color: var(--color-warning); 
}

.message {
  padding: 1rem;
  border-radius: 0.75rem;
  margin-bottom: 1rem;
  transform: translateY(20px);
  opacity: 0;
  transition: all var(--animation-duration) var(--transition-easing);
}

.message.show {
  transform: translateY(0);
  opacity: 1;
}

/* Glassmorphism Footer */
.unified-theme .footer { 
  text-align: center; 
  font-size: 12px; 
  color: rgba(255, 255, 255, 0.5); 
  margin-top: 8px; 
}

.unified-theme .footer a { 
  color: var(--color-text-muted); 
  text-decoration: none; 
  border-bottom: 1px solid rgba(255, 255, 255, 0.3); 
  transition: color 0.2s ease; 
  cursor: pointer; 
}

.unified-theme .footer a:hover { 
  color: white; 
}

/* Modal System */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(15, 23, 42, 0.8);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50;
  padding: 20px;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0s 0.3s;
}

.modal-overlay.is-visible {
  opacity: 1;
  visibility: visible;
  transition: opacity 0.3s ease, visibility 0s;
}

.modal-overlay .glass-panel {
  background: rgba(30, 41, 59, 0.9);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 16px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
  width: 100%;
  max-width: 640px;
  max-height: 90vh;
  transform: scale(0.95) translateY(10px);
  transition: transform 0.3s ease-out;
}

.modal-overlay.is-visible .glass-panel {
  transform: scale(1) translateY(0);
}

.modal-close-btn {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: rgba(255,255,255,0.1);
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--transition-duration) var(--transition-easing);
  color: var(--color-text);
}

.modal-close-btn:hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.1);
}

/* Progressive Disclosure */
.progressive-section {
  transition: all var(--animation-duration) var(--transition-easing);
}

.progressive-section.collapsed {
  max-height: 0;
  opacity: 0;
  overflow: hidden;
}

.progressive-section.expanded {
  max-height: 1000px;
  opacity: 1;
}

.toggle-section {
  cursor: pointer;
  -webkit-user-select: none;
  user-select: none;
}

.toggle-section:hover {
  background: rgba(255,255,255,0.05);
}

/* Responsive Grid System */
.responsive-grid {
  display: grid;
  gap: 1rem;
  grid-template-columns: 1fr;
  padding: 1rem;
}

/* Performance Optimizations */
.render-optimized {
  will-change: transform, opacity;
  transform: translateZ(0);
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
}

/* Accessibility */
:focus-visible { 
  outline: 3px solid var(--color-primary); 
  outline-offset: 2px; 
  border-radius: 4px; 
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* Animation Classes */
.success-pulse { animation: successPulse 0.6s ease-out; }
.error-shake { animation: errorShake 0.5s ease-out; }
.fade-in { animation: fadeIn var(--animation-duration) ease-out; }
.slide-up { animation: slideUp var(--animation-duration) ease-out; }
.fade-out { animation: fadeOut var(--animation-duration) ease-out; }

/* Keyframe Animations */
@keyframes successPulse {
  0% { transform: scale3d(1, 1, 1); will-change: transform; }
  50% { transform: scale3d(1.05, 1.05, 1); }
  100% { transform: scale3d(1, 1, 1); will-change: auto; }
}

@keyframes errorShake {
  0% { transform: translate3d(0, 0, 0); will-change: transform; }
  25% { transform: translate3d(-5px, 0, 0); }
  75% { transform: translate3d(5px, 0, 0); }
  100% { transform: translate3d(0, 0, 0); will-change: auto; }
}

@keyframes fadeIn {
  0% { opacity: 0; transform: translateY(10px); will-change: opacity, transform; }
  100% { opacity: 1; transform: translateY(0); will-change: auto; }
}

@keyframes slideUp {
  0% { opacity: 0; transform: translateY(20px); will-change: opacity, transform; }
  100% { opacity: 1; transform: translateY(0); will-change: auto; }
}

@keyframes fadeOut {
  0% { opacity: 1; will-change: opacity; }
  100% { opacity: 0; will-change: auto; }
}

@keyframes loading-skeleton {
  0% { background-position: 200% 0; will-change: background-position; }
  100% { background-position: -200% 0; will-change: auto; }
}

@keyframes skeleton-loading {
  0% { background-position: 200% 0; will-change: background-position; }
  100% { background-position: -200% 0; will-change: auto; }
}

@keyframes spin {
  0% { transform: rotate(0deg); will-change: transform; }
  100% { transform: rotate(360deg); will-change: auto; }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); will-change: transform; }
  50% { transform: scale(1.05); }
}

@keyframes shake {
  0%, 100% { transform: translate3d(0, 0, 0); will-change: transform; }
  25% { transform: translate3d(-5px, 0, 0); }
  75% { transform: translate3d(5px, 0, 0); }
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); will-change: transform; }
  50% { transform: translateY(-10px); }
}

@keyframes modalFade {
  0% { opacity: 0; will-change: opacity; }
  100% { opacity: 1; will-change: auto; }
}

@keyframes modalScale {
  0% { transform: scale(0.9); will-change: transform; }
  100% { transform: scale(1); will-change: auto; }
}

@keyframes slideIn {
  0% { opacity: 0; transform: translateX(-20px); will-change: opacity, transform; }
  100% { opacity: 1; transform: translateX(0); will-change: auto; }
}

/* Font Styles */
.game-font {
  font-family: 'Press Start 2P', cursive;
  font-size: 0.75rem;
  letter-spacing: 0.05em;
}

/* Text Utilities */
.answer-preview {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.5;
}

/* Tailwind CSS Fallback */
.tailwind-fallback {
  /* Fallback styles when TailwindCSS fails to load */
}

/* Media Queries */

/* Performance optimizations for low-end devices */
@media (max-width: 768px) and (max-resolution: 150dpi) {
  .glass-panel {
    -webkit-backdrop-filter: none;
    backdrop-filter: none;
    background: rgba(26, 27, 38, 0.95);
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  :root {
    --color-border: rgba(255,255,255,0.3);
    --color-text: #ffffff;
  }
}

/* Mobile-first responsive design */
@media (max-width: 768px) {
  .btn {
    min-height: 48px;
    padding: 1rem 1.5rem;
    font-size: 16px;
  }
  
  .form-control {
    padding: 1rem;
    font-size: 16px;
  }
  
  .glass-panel {
    margin: 0.5rem;
    padding: 1rem;
  }
  
  .responsive-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .answer-card {
    padding: 1rem;
  }
  
  .reaction-btn {
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
  }
}

@media (min-width: 640px) {
  .responsive-grid {
    gap: 1.5rem;
    padding: 1.5rem;
  }
}

@media (min-width: 768px) {
  .responsive-grid {
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
  }
}

@media (min-width: 1024px) {
  .responsive-grid {
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    padding: 2rem;
  }
}

/* High refresh rate display optimizations */
@media (min-resolution: 120dpi) {
  .btn, .form-control, .answer-card {
    will-change: transform;
  }
}

/* Large screen optimizations */
@media (min-width: 1200px) {
  .responsive-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* =============================================================================
   TAILWIND REPLACEMENT UTILITIES
   ============================================================================= */

/* Layout Utilities */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

.max-w-2xl { max-width: 42rem; margin: 0 auto; }
.max-w-4xl { max-width: 56rem; margin: 0 auto; }
.max-w-6xl { max-width: 72rem; margin: 0 auto; }

/* Flexbox Utilities */
.flex { display: flex; }
.flex-col { flex-direction: column; }
.flex-row { flex-direction: row; }
.flex-wrap { flex-wrap: wrap; }
.items-center { align-items: center; }
.items-start { align-items: flex-start; }
.items-end { align-items: flex-end; }
.justify-center { justify-content: center; }
.justify-between { justify-content: space-between; }
.justify-start { justify-content: flex-start; }
.justify-end { justify-content: flex-end; }
.flex-1 { flex: 1 1 0%; }
.flex-none { flex: none; }

/* Grid Utilities */
.grid { display: grid; }
.grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
.grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
.grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
.grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
.gap-2 { gap: 0.5rem; }
.gap-4 { gap: 1rem; }
.gap-6 { gap: 1.5rem; }
.gap-8 { gap: 2rem; }

/* Spacing Utilities */
.p-2 { padding: 0.5rem; }
.p-4 { padding: 1rem; }
.p-6 { padding: 1.5rem; }
.p-8 { padding: 2rem; }
.px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
.px-4 { padding-left: 1rem; padding-right: 1rem; }
.px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
.py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
.py-4 { padding-top: 1rem; padding-bottom: 1rem; }
.py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
.m-2 { margin: 0.5rem; }
.m-4 { margin: 1rem; }
.m-6 { margin: 1.5rem; }
.mx-auto { margin-left: auto; margin-right: auto; }
.mb-2 { margin-bottom: 0.5rem; }
.mb-4 { margin-bottom: 1rem; }
.mb-6 { margin-bottom: 1.5rem; }
.mb-8 { margin-bottom: 2rem; }
.mt-2 { margin-top: 0.5rem; }
.mt-4 { margin-top: 1rem; }
.mt-6 { margin-top: 1.5rem; }
.mr-2 { margin-right: 0.5rem; }
.ml-2 { margin-left: 0.5rem; }

/* Typography */
.text-xs { font-size: 0.75rem; line-height: 1rem; }
.text-sm { font-size: 0.875rem; line-height: 1.25rem; }
.text-base { font-size: 1rem; line-height: 1.5rem; }
.text-lg { font-size: 1.125rem; line-height: 1.75rem; }
.text-xl { font-size: 1.25rem; line-height: 1.75rem; }
.text-2xl { font-size: 1.5rem; line-height: 2rem; }
.text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
.text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
.font-normal { font-weight: 400; }
.font-medium { font-weight: 500; }
.font-semibold { font-weight: 600; }
.font-bold { font-weight: 700; }
.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }

/* Colors */
.text-white { color: var(--color-text); }
.text-gray-200 { color: rgba(255, 255, 255, 0.9); }
.text-gray-300 { color: var(--color-text-secondary); }
.text-gray-400 { color: var(--color-text-muted); }
.text-cyan-400 { color: var(--color-primary); }
.text-purple-400 { color: var(--color-primary-end); }
.text-yellow-400 { color: var(--color-accent); }
.text-green-400 { color: var(--color-success); }
.text-red-400 { color: var(--color-error); }

/* Background Colors */
.bg-transparent { background-color: transparent; }

/* Borders */
.border { border-width: 1px; border-color: var(--color-border); }
.border-2 { border-width: 2px; }
.border-gray-600 { border-color: rgba(255, 255, 255, 0.2); }
.border-gray-700 { border-color: rgba(255, 255, 255, 0.1); }
.rounded { border-radius: 0.25rem; }
.rounded-md { border-radius: 0.375rem; }
.rounded-lg { border-radius: 0.5rem; }
.rounded-xl { border-radius: 0.75rem; }
.rounded-2xl { border-radius: 1rem; }
.rounded-full { border-radius: 9999px; }

/* Position */
.relative { position: relative; }
.absolute { position: absolute; }
.fixed { position: fixed; }
.top-0 { top: 0; }
.top-4 { top: 1rem; }
.top-20 { top: 5rem; }
.right-0 { right: 0; }
.right-4 { right: 1rem; }
.right-6 { right: 1.5rem; }
.bottom-0 { bottom: 0; }
.left-0 { left: 0; }

/* Z-index */
.z-10 { z-index: 10; }
.z-20 { z-index: 20; }
.z-30 { z-index: 30; }
.z-40 { z-index: 40; }
.z-50 { z-index: 50; }

/* Display */
.block { display: block; }
.inline-block { display: inline-block; }
.inline { display: inline; }
.hidden { display: none; }

/* Width and Height */
.w-full { width: 100%; }
.w-auto { width: auto; }
.w-4 { width: 1rem; }
.w-5 { width: 1.25rem; }
.w-6 { width: 1.5rem; }
.h-full { height: 100%; }
.h-auto { height: auto; }
.h-4 { height: 1rem; }
.h-5 { height: 1.25rem; }
.h-6 { height: 1.5rem; }
.h-screen { height: 100vh; }
.min-h-screen { min-height: 100vh; }

/* Font Family */
.font-sans { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }

/* Opacity */
.opacity-0 { opacity: 0; }
.opacity-50 { opacity: 0.5; }
.opacity-75 { opacity: 0.75; }
.opacity-100 { opacity: 1; }

/* Overflow */
.overflow-hidden { overflow: hidden; }
.overflow-auto { overflow: auto; }
.overflow-y-auto { overflow-y: auto; }

/* Cursor */
.cursor-pointer { cursor: pointer; }
.cursor-not-allowed { cursor: not-allowed; }

/* Transition */
.transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-duration: var(--transition-duration); transition-timing-function: var(--transition-easing); }
.duration-200 { transition-duration: 200ms; }
.duration-300 { transition-duration: 300ms; }
.ease-in-out { transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }

/* Transform */
.transform { transform: translateZ(0); }
.scale-105 { transform: scale(1.05); }
.hover\:scale-105:hover { transform: scale(1.05); }

/* Shadow */
.shadow { box-shadow: var(--shadow-sm); }
.shadow-md { box-shadow: var(--shadow-md); }
.shadow-lg { box-shadow: var(--shadow-lg); }

/* Responsive Utilities */
@media (min-width: 640px) {
  .sm\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .sm\:text-lg { font-size: 1.125rem; line-height: 1.75rem; }
}

@media (min-width: 768px) {
  .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
  .md\:p-8 { padding: 2rem; }
  .md\:text-xl { font-size: 1.25rem; line-height: 1.75rem; }
}

@media (min-width: 1024px) {
  .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
  .lg\:p-12 { padding: 3rem; }
  .lg\:text-2xl { font-size: 1.5rem; line-height: 2rem; }
}

/* Dark Theme Body */
.dark-body {
  background: var(--color-background);
  color: var(--color-text);
  font-family: var(--font-sans);
  min-height: 100vh;
  margin: 0;
  padding: 0;
}

/* Gradient Backgrounds */
.bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
.bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }

/* Common Gradient Combinations */
.from-blue-600 { --tw-gradient-from: #2563eb; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(37, 99, 235, 0)); }
.to-purple-600 { --tw-gradient-to: #9333ea; }
.from-purple-600 { --tw-gradient-from: #9333ea; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(147, 51, 234, 0)); }
.to-pink-600 { --tw-gradient-to: #db2777; }
.from-gray-600 { --tw-gradient-from: #4b5563; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(75, 85, 99, 0)); }
.to-gray-700 { --tw-gradient-to: #374151; }
.from-cyan-400 { --tw-gradient-from: var(--color-primary); --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(6, 182, 212, 0)); }
.to-purple-400 { --tw-gradient-to: var(--color-primary-end); }

/* Hover states for gradients */
.hover\:from-blue-700:hover { --tw-gradient-from: #1d4ed8; }
.hover\:to-purple-700:hover { --tw-gradient-to: #7c3aed; }
.hover\:from-purple-700:hover { --tw-gradient-from: #7c3aed; }
.hover\:to-pink-700:hover { --tw-gradient-to: #be185d; }
.hover\:from-gray-700:hover { --tw-gradient-from: #374151; }
.hover\:to-gray-800:hover { --tw-gradient-to: #1f2937; }

/* Ring utilities */
.focus\:ring-4:focus { 
  --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
  --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(4px + var(--tw-ring-offset-width)) var(--tw-ring-color);
  box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
}
.ring-blue-300 { --tw-ring-color: rgba(147, 197, 253, 0.5); }
.dark\:ring-blue-800 { --tw-ring-color: rgba(30, 64, 175, 0.5); }

/* Toggle/Switch styles */
.peer:checked ~ .peer-checked\:bg-blue-600 { background-color: #2563eb; }
.peer:checked ~ .peer-checked\:after\:translate-x-full::after { transform: translateX(100%); }
.peer-focus\:ring-4:focus ~ * { box-shadow: 0 0 0 4px var(--tw-ring-color); }
.peer-focus\:ring-blue-300:focus ~ * { --tw-ring-color: rgba(147, 197, 253, 0.5); }

/* Additional width/height utilities */
.w-11 { width: 2.75rem; }
.h-6 { height: 1.5rem; }
.w-8 { width: 2rem; }
.h-8 { height: 2rem; }

/* Flex utilities */
.flex-shrink-0 { flex-shrink: 0; }

/* Disabled states */
.disabled\:opacity-50:disabled { opacity: 0.5; }
.disabled\:cursor-not-allowed:disabled { cursor: not-allowed; }

/* Outline utilities */
.focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }

/* Peer utilities for toggle switches */
.peer { position: relative; }

/* Pseudo-element utilities */
.after\:content-\[\'\'\]::after { content: ''; }
.after\:absolute::after { position: absolute; }
.after\:top-\[2px\]::after { top: 2px; }
.after\:left-\[2px\]::after { left: 2px; }
.after\:bg-white::after { background-color: white; }
.after\:border::after { border-width: 1px; }
.after\:border-gray-300::after { border-color: #d1d5db; }
.after\:rounded-full::after { border-radius: 9999px; }
.after\:h-5::after { height: 1.25rem; }
.after\:w-5::after { width: 1.25rem; }
.after\:transition-all::after { transition: all var(--transition-duration) var(--transition-easing); }

/* Additional background colors */
.bg-gray-200 { background-color: #e5e7eb; }
.bg-gray-700 { background-color: #374151; }
.dark\:bg-gray-700 { background-color: #374151; }

/* Additional border colors */
.border-gray-300 { border-color: #d1d5db; }
.dark\:border-gray-600 { border-color: #4b5563; }
.peer-checked\:after\:border-white:checked::after { border-color: white; }
</style>

  <!-- Consolidated Admin Panel Logic -->
  <script>
/* =============================================================================
   StudyQuest - Admin Panel Logic
   Extracted from AdminPanel.html for better maintainability
   Handles all admin-specific functionality and business logic
   ============================================================================= */

// =============================================================================
// APPLICATION STATE MANAGEMENT
// =============================================================================

// Application state object
const appState = {
  userId: '',
  selectedSheet: '',
  currentActiveSheet: '',
  webAppUrl: '',
  currentSpreadsheetUrl: '',
  currentStatus: null,
  isLoading: false
};

// Get user ID safely from template or meta tag
(function() {
  try {
    const templateUserId = '<?= typeof userId !== "undefined" ? userId : "" ?>';
    if (templateUserId && templateUserId.trim() !== '') {
      appState.userId = templateUserId;
      console.log('✅ appState.userId from template:', appState.userId);
    } else {
      const userIdMeta = document.querySelector('meta[name="user-id"]');
      if (userIdMeta && userIdMeta.content) {
        appState.userId = userIdMeta.content;
        console.log('✅ appState.userId from meta:', appState.userId);
      }
    }

    if (!appState.userId) {
      console.error('❌ appState.userId not found in template or meta');
    }
  } catch (e) {
    console.error('❌ appState.userId initialization error:', e);
    appState.userId = '';
  }
})();

// =============================================================================
// ADMIN ERROR HANDLING SYSTEM
// =============================================================================

/**
 * Translate technical error messages to user-friendly Japanese messages
 * @param {string} errorMsg - Original error message
 * @param {string} context - Error context
 * @returns {string} User-friendly error message
 */
function translateErrorMessage(errorMsg, context) {
  if (!errorMsg || typeof errorMsg !== 'string') {
    return 'エラーが発生しました。しばらく待ってから再試行してください。';
  }

  const lowerMsg = errorMsg.toLowerCase();
  
  // Spreadsheet related errors
  if (lowerMsg.includes('範囲の列数には') || lowerMsg.includes('range')) {
    return `📊 スプレッドシートにデータが正しく入力されていません。
💡 解決方法：スプレッドシートを開いて、1行目にヘッダー（列名）が入力されているか確認してください。`;
  }
  
  if (lowerMsg.includes('シート情報の取得に失敗') || lowerMsg.includes('sheet')) {
    return `📋 シートの情報を読み込めませんでした。
💡 解決方法：
• スプレッドシートが正しく共有されているか確認
• シートにデータが入力されているか確認
• しばらく待ってから再試行`;
  }
  
  // Permission related errors
  if (lowerMsg.includes('permission') || lowerMsg.includes('権限') || lowerMsg.includes('access denied')) {
    return `🔒 アクセス権限がありません。
💡 解決方法：
• スプレッドシートの共有設定を確認
• 編集権限があることを確認
• アカウントでログインし直してみる`;
  }
  
  // Network related errors
  if (lowerMsg.includes('network') || lowerMsg.includes('timeout') || lowerMsg.includes('fetch')) {
    return `🌐 インターネット接続の問題が発生しました。
💡 解決方法：
• インターネット接続を確認
• しばらく待ってから再試行
• ページを再読み込み`;
  }
  
  // Form related errors
  if (lowerMsg.includes('form') && lowerMsg.includes('not found')) {
    return `📝 フォームが見つかりません。
💡 解決方法：
• フォームが作成されているか確認
• フォームが削除されていないか確認
• 新しいフォームを作成`;
  }
  
  // Validation related errors
  if (lowerMsg.includes('validation') || lowerMsg.includes('invalid')) {
    return `⚠️ 入力内容に問題があります。
💡 解決方法：
• 必須項目がすべて入力されているか確認
• 入力形式が正しいか確認
• 特殊文字が含まれていないか確認`;
  }
  
  // Authentication related errors
  if (lowerMsg.includes('authentication') || lowerMsg.includes('login') || lowerMsg.includes('unauthorized')) {
    return `🔐 認証に問題があります。
💡 解決方法：
• ログイン状態を確認
• ページを再読み込み
• 再度ログインしてみる`;
  }
  
  // Server related errors
  if (lowerMsg.includes('server error') || lowerMsg.includes('500') || lowerMsg.includes('503')) {
    return `⚡ システムが一時的に利用できません。
💡 解決方法：
• 数分待ってから再試行
• 問題が続く場合は管理者に連絡`;
  }
  
  // Configuration related errors
  if (context && context.includes('config') || lowerMsg.includes('configuration')) {
    return `⚙️ 設定の保存に問題があります。
💡 解決方法：
• すべての必須項目が入力されているか確認
• 設定内容に問題がないか確認
• しばらく待ってから再試行`;
  }
  
  // Other common errors
  if (lowerMsg.includes('failed') || lowerMsg.includes('error')) {
    return `❌ 操作が正常に完了しませんでした。
💡 解決方法：
• しばらく待ってから再試行
• ページを再読み込み
• 問題が続く場合は別のブラウザを試す`;
  }
  
  // Fallback
  return `⚠️ 予期しないエラーが発生しました。
💡 解決方法：
• ページを再読み込み
• しばらく待ってから再試行
• 問題が続く場合はサポートにお問い合わせください`;
}

/**
 * Centralized error handling for admin panel
 * @param {Error} error - Error object
 * @param {string} context - Context description
 * @param {string} userMessage - Custom user message
 */
function handleAdminError(error, context, userMessage) {
  const errorMsg = error && error.message ? error.message : String(error);
  console.error('[' + (context || 'Admin') + '] Error:', errorMsg);
  
  const displayMessage = userMessage || translateErrorMessage(errorMsg, context);
  
  // Use shared utilities for message display
  if (window.sharedUtilities && window.sharedUtilities.message) {
    window.sharedUtilities.message.show(displayMessage, 'error');
  } else {
    showMessage(displayMessage, 'error');
  }
  
  return false;
}

// =============================================================================
// LOADING STATE MANAGEMENT
// =============================================================================

/**
 * Set loading state with message
 * @param {boolean} isLoading - Loading state
 * @param {string} message - Loading message
 */
function setAdminLoading(isLoading, message = '') {
  const loader = document.getElementById('loading-overlay');
  const loaderMessage = document.getElementById('loading-message');
  
  if (!loader) return;

  if (isLoading) {
    if (loaderMessage) loaderMessage.textContent = message;
    loader.classList.remove('hidden');
  } else {
    loader.classList.add('hidden');
  }
}

/**
 * Progress bar system for multi-step operations
 * @param {number} currentStep - Current step number
 * @param {number} totalSteps - Total number of steps
 * @param {string} message - Progress message
 */
function showProgressStep(currentStep, totalSteps, message) {
  let progressContainer = document.getElementById('progress-container');
  
  if (!progressContainer) {
    progressContainer = document.createElement('div');
    progressContainer.id = 'progress-container';
    progressContainer.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    progressContainer.innerHTML = `
      <div class="glass-panel p-6 max-w-md w-full mx-4">
        <div class="text-center mb-4">
          <h3 class="text-lg font-semibold text-white">フォーム作成進行中</h3>
        </div>
        <div class="mb-4">
          <div class="bg-gray-700 rounded-full h-3 overflow-hidden">
            <div id="progress-bar" class="bg-gradient-to-r from-cyan-500 to-purple-500 h-full transition-all duration-500 ease-out" style="width: 0%"></div>
          </div>
        </div>
        <div class="text-center">
          <p id="progress-message" class="text-sm text-gray-300"></p>
          <p class="text-xs text-gray-400 mt-2">
            ステップ <span id="progress-current">1</span> / <span id="progress-total">5</span>
          </p>
        </div>
      </div>
    `;
    document.body.appendChild(progressContainer);
  }
  
  const progressBar = document.getElementById('progress-bar');
  const progressMessage = document.getElementById('progress-message');
  const progressCurrent = document.getElementById('progress-current');
  const progressTotal = document.getElementById('progress-total');
  
  if (progressBar) {
    const percentage = (currentStep / totalSteps) * 100;
    progressBar.style.width = percentage + '%';
  }
  
  if (progressMessage) progressMessage.textContent = message;
  if (progressCurrent) progressCurrent.textContent = currentStep;
  if (progressTotal) progressTotal.textContent = totalSteps;
  
  progressContainer.classList.remove('hidden');
}

/**
 * Hide progress bar
 */
function hideProgressBar() {
  const progressContainer = document.getElementById('progress-container');
  if (progressContainer) {
    progressContainer.classList.add('hidden');
    setTimeout(() => {
      if (progressContainer.parentNode) {
        progressContainer.parentNode.removeChild(progressContainer);
      }
    }, 500);
  }
}

// =============================================================================
// MODAL MANAGEMENT SYSTEM
// =============================================================================

/**
 * Show confirmation modal with custom title and message
 * @param {string} title - Modal title
 * @param {string} message - Modal message
 * @param {Function} onConfirm - Callback on confirmation
 */
function showConfirmationModal(title, message, onConfirm) {
  const modal = document.getElementById('confirmation-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalMessage = document.getElementById('modal-message');
  
  if (modalTitle) modalTitle.textContent = title;
  if (modalMessage) modalMessage.textContent = message;
  
  if (!modal) {
    console.error('確認モーダルが見つかりません');
    return;
  }
  
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  const confirmBtn = document.getElementById('modal-confirm-btn');
  const cancelBtn = document.getElementById('modal-cancel-btn');

  const confirmHandler = function() {
    onConfirm();
    hideConfirmationModal();
    confirmBtn.removeEventListener('click', confirmHandler);
    cancelBtn.removeEventListener('click', cancelHandler);
  };

  const cancelHandler = function() {
    hideConfirmationModal();
    confirmBtn.removeEventListener('click', confirmHandler);
    cancelBtn.removeEventListener('click', cancelHandler);
  };

  confirmBtn.addEventListener('click', confirmHandler);
  cancelBtn.addEventListener('click', cancelHandler);
}

/**
 * Hide confirmation modal
 */
function hideConfirmationModal() {
  const modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
}

/**
 * Show privacy modal before sensitive operations
 * @param {Function} onContinue - Callback on continue
 */
function showPrivacyModal(onContinue) {
  const modal = document.getElementById('privacy-modal');
  if (!modal) {
    console.error('プライバシーモーダルが見つかりません');
    return;
  }
  
  modal.classList.remove('hidden');
  
  const continueBtn = document.getElementById('privacy-modal-continue');
  const cancelBtn = document.getElementById('privacy-modal-cancel');
  
  if (continueBtn) {
    const newContinueBtn = continueBtn.cloneNode(true);
    continueBtn.parentNode.replaceChild(newContinueBtn, continueBtn);
    newContinueBtn.addEventListener('click', function() {
      hidePrivacyModal();
      if (onContinue) onContinue();
    });
  }
  
  if (cancelBtn) {
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', hidePrivacyModal);
  }
  
  const escapeHandler = function(e) {
    if (e.key === 'Escape') {
      hidePrivacyModal();
      document.removeEventListener('keydown', escapeHandler);
    }
  };
  document.addEventListener('keydown', escapeHandler);
}

/**
 * Hide privacy modal
 */
function hidePrivacyModal() {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

// =============================================================================
// ADMIN UTILITY FUNCTIONS
// =============================================================================

/**
 * Safely set text content of an element
 * @param {string} elementId - Element ID
 * @param {string} value - Value to set
 * @param {string} prefix - Optional prefix
 */
function safeSetAdminText(elementId, value, prefix = '') {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = value ? prefix + value : '-';
    console.log(`✅ Updated ${elementId}:`, element.textContent);
  } else {
    console.warn(`❌ Element not found: ${elementId}`);
  }
}

/**
 * Update publication status UI
 * @param {boolean} isPublished - Publication status
 */
function updatePublicationStatusUI(isPublished) {
  const statusIndicator = document.getElementById('info-publish-indicator');
  const statusText = document.getElementById('info-publish-text');
  const unpublishBtn = document.getElementById('unpublish-board-btn');
  const savePublishBtn = document.getElementById('save-publish-btn');
  
  if (statusIndicator && statusText) {
    if (isPublished) {
      statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
      statusText.textContent = '公開中';
      statusText.className = 'text-green-400';
    } else {
      statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
      statusText.textContent = '非公開';
      statusText.className = 'text-red-400';
    }
  }
  
  if (unpublishBtn) {
    unpublishBtn.style.display = isPublished ? 'inline-flex' : 'none';
  }
  
  if (savePublishBtn) {
    const text = isPublished ? '設定を更新' : '設定保存・公開';
    savePublishBtn.textContent = text;
  }
}

/**
 * Toggle progressive disclosure sections
 * @param {string} sectionId - Section ID to toggle
 */
function toggleAdminSection(sectionId) {
  const section = document.getElementById(sectionId);
  const icon = document.getElementById(sectionId.replace('content', 'icon'));
  
  if (!section) return;
  
  const isExpanded = section.classList.contains('expanded');
  
  if (isExpanded) {
    section.classList.remove('expanded');
    section.classList.add('collapsed');
    if (icon) {
      if (sectionId === 'step1-content') {
        icon.style.transform = 'rotate(0deg)';
      } else if (sectionId === 'step2-content' || sectionId === 'step3-content') {
        icon.style.transform = 'rotate(90deg)';
      }
    }
  } else {
    section.classList.remove('collapsed');
    section.classList.add('expanded');
    if (icon) {
      if (sectionId === 'step1-content') {
        icon.style.transform = 'rotate(180deg)';
      } else if (sectionId === 'step2-content' || sectionId === 'step3-content') {
        icon.style.transform = 'rotate(0deg)';
      }
    }
  }
}

// =============================================================================
// ADMIN PANEL SPECIFIC FUNCTIONS
// =============================================================================

/**
 * Update database info panel with status data
 * @param {Object} status - Status object from server
 */
function updateDatabaseInfo(status) {
  console.log('🔧 updateDatabaseInfo called with status:', status);
  
  if (!status || !status.userInfo) {
    console.warn('システム情報を更新できませんでした: ユーザー情報がありません。', status);
    return;
  }

  console.log('✅ User info found, updating system panel:', status.userInfo);

  // Set spreadsheet URL
  if (status.userInfo.spreadsheetUrl) {
    appState.currentSpreadsheetUrl = status.userInfo.spreadsheetUrl;
    console.log('✅ currentSpreadsheetUrl set to:', appState.currentSpreadsheetUrl);
  }

  // Update existing fields
  safeSetAdminText('info-admin-email', status.userInfo.adminEmail);
  safeSetAdminText('info-user-id', status.userInfo.userId);
  
  // Published sheet name
  let publishedSheetName = status.publishedSheetName || status.activeSheetName;
  if (!publishedSheetName && status.userInfo && status.userInfo.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      publishedSheetName = config.publishedSheetName;
    } catch (e) {
      console.warn('ConfigJSON parse error in published sheet name:', e);
    }
  }
  safeSetAdminText('info-published-sheet', publishedSheetName || 'なし');
  safeSetAdminText('info-answer-count', status.answerCount || '0');
  safeSetAdminText('info-reaction-count', status.totalReactions || '0');

  // Update publication status
  const isPublished = status && (
    status.isPublished || 
    status.appPublished || 
    (status.publishedSheetName && status.publishedSheetName !== 'なし')
  );
  updatePublicationStatusUI(isPublished);

  // Display mode
  const displayMode = status.showNames ? '名前表示' : '匿名表示';
  safeSetAdminText('info-display-mode', displayMode);

  // Count display
  const showCounts = status.showCounts !== undefined ? (status.showCounts ? '表示' : '非表示') : '表示';
  safeSetAdminText('info-show-counts', showCounts);
  
  // Update button states
  updateAdminButtonStates(status);
}

/**
 * Update admin button states based on status
 * @param {Object} status - Status object
 */
function updateAdminButtonStates(status) {
  const openSpreadsheetBtns = document.querySelectorAll('#open-spreadsheet-btn, #open-spreadsheet-btn-step2');
  const openFormBtn = document.getElementById('open-form-btn');
  const openLinkedFormBtn = document.getElementById('open-linked-form-btn');
  
  openSpreadsheetBtns.forEach(btn => {
    if (btn) {
      const hasSpreadsheetUrl = status.userInfo && status.userInfo.spreadsheetUrl;
      btn.disabled = !hasSpreadsheetUrl;
      btn.title = hasSpreadsheetUrl ? 'スプレッドシートを開く' : 'スプレッドシートが設定されていません';
    }
  });
  
  if (openFormBtn) {
    const formUrl = status.formUrl || (status.userInfo && status.userInfo.formUrl);
    const hasFormUrl = formUrl && formUrl.trim() !== "";
    openFormBtn.disabled = !hasFormUrl;
    openFormBtn.title = hasFormUrl ? 'フォームを開く' : 'フォームが設定されていません';
  }

  if (openLinkedFormBtn) {
    const hasFormUrl = status.formUrl && status.formUrl.trim() !== '';
    openLinkedFormBtn.disabled = !hasFormUrl;
    openLinkedFormBtn.title = hasFormUrl ? '連携しているGoogleフォームを開きます' : '連携しているフォームが設定されていません';
  }
}

/**
 * Handle account deletion request with double confirmation
 */
function handleDeleteRequest() {
  showPrivacyModal(function() {
    showConfirmationModal(
      'アカウントの完全削除',
      '本当にこのアカウントを削除しますか？この操作は元に戻せず、すべてのデータが失われます。',
      function() {
        setAdminLoading(true, 'アカウントを完全に削除しています...');
        
        if (window.sharedUtilities && window.sharedUtilities.gas) {
          window.sharedUtilities.gas.call(
            'deleteCurrentUserAccount',
            function(response) {
              setAdminLoading(false);
              if (window.sharedUtilities.message) {
                window.sharedUtilities.message.show(response, 'success');
              }
              setTimeout(function() {
                if (window.sharedUtilities.navigation) {
                  window.sharedUtilities.navigation.safeNavigate('?page=LoginPage', {
                    fallbackMessage: '登録ページに移動中...',
                    method: 'auto'
                  });
                } else {
                  window.location.href = '?page=LoginPage';
                }
              }, 2000);
            },
            function(error) {
              setAdminLoading(false);
              handleAdminError(error, 'アカウント削除');
            },
            [appState.userId],
            'アカウント削除'
          );
        }
      }
    );
  });
}

/**
 * Admin system flow display for debugging
 */
function showAdminSystemFlow() {
  const DEBUG_MODE = <?= typeof DEBUG_MODE !== 'undefined' ? DEBUG_MODE : false ?>;
  if (!DEBUG_MODE) return;
  
  console.group('🔄 StudyQuest 管理パネル システムフロー');
  console.log('📋 Phase 1: 管理パネル初期化');
  console.log('  ├─ 管理者権限確認');
  console.log('  ├─ ユーザー情報取得');
  console.log('  ├─ スプレッドシート接続');
  console.log('  └─ UI要素初期化');
  
  console.log('🎨 Phase 2: レイアウト構築');
  console.log('  ├─ 左パネル（メイン操作）');
  console.log('  ├─ 右パネル（システム情報）');
  console.log('  ├─ フッター（公開URL表示）');
  console.log('  └─ レスポンシブ対応');
  
  console.log('📡 Phase 3: データ連携');
  console.log('  ├─ スプレッドシートデータ取得');
  console.log('  ├─ シート一覧取得');
  console.log('  ├─ 列ヘッダー自動判定');
  console.log('  └─ 公開状態確認');
  
  console.log('🏗️ Phase 4: 設定UI構築');
  console.log('  ├─ ステップインジケーター');
  console.log('  ├─ シート選択ドロップダウン');
  console.log('  ├─ 列設定フォーム');
  console.log('  └─ プレビュー表示');
  
  console.log('⚡ Phase 5: 管理機能');
  console.log('  ├─ ボード作成・公開');
  console.log('  ├─ 設定変更');
  console.log('  ├─ URLコピー機能');
  console.log('  └─ リアルタイム更新');
  
  console.log('🔧 Phase 6: 最適化・監視');
  console.log('  ├─ キャッシュ管理');
  console.log('  ├─ エラーハンドリング');
  console.log('  ├─ パフォーマンス監視');
  console.log('  └─ デバッグ情報出力');
  
  console.groupEnd();
  
  console.group('📊 管理パネル現在状態');
  console.log('DOM状態:', document.readyState);
  console.log('CSS読み込み:', document.styleSheets.length + ' stylesheets');
  console.log('GAS環境:', typeof google !== 'undefined' ? 'Available' : 'Not Available');
  console.log('管理者状態:', typeof appState.currentStatus !== 'undefined' && appState.currentStatus ? 'Authenticated' : 'Unknown');
  console.log('スプレッドシートURL:', typeof appState.currentSpreadsheetUrl !== 'undefined' ? (appState.currentSpreadsheetUrl ? 'Set' : 'Not Set') : 'Unknown');
  console.groupEnd();
}

// =============================================================================
// CACHE MANAGEMENT SYSTEM
// =============================================================================

/**
 * Frontend cache manager for admin panel
 */
class AdminCacheManager {
  constructor() {
    this.caches = new Map();
    this.defaultTTL = 30000; // 30 seconds
    this.dependencies = new Map();
    this._initializeDependencies();
  }
  
  _initializeDependencies() {
    this.dependencies.set('user_data_change', ['status', 'userInfo', 'formUrls']);
    this.dependencies.set('form_creation', ['status', 'formUrls', 'sheetDetails']);
    this.dependencies.set('config_change', ['status', 'sheetDetails']);
  }
  
  get(key, defaultValue = null) {
    const cached = this.caches.get(key);
    if (!cached) return defaultValue;
    
    const now = Date.now();
    if (now - cached.timestamp > cached.ttl) {
      this.caches.delete(key);
      console.log(`📊 [Cache] Expired and removed: ${key}`);
      return defaultValue;
    }
    
    console.log(`📊 [Cache] Hit: ${key}`);
    return cached.value;
  }
  
  set(key, value, ttl = this.defaultTTL) {
    this.caches.set(key, {
      value: value,
      timestamp: Date.now(),
      ttl: ttl
    });
    console.log(`📊 [Cache] Set: ${key} (TTL: ${ttl}ms)`);
  }
  
  invalidate(key) {
    this.caches.delete(key);
    console.log(`📊 [Cache] Invalidated: ${key}`);
  }
  
  invalidateDependents(changeType) {
    const dependents = this.dependencies.get(changeType) || [];
    dependents.forEach(key => this.invalidate(key));
    console.log(`📊 [Cache] Invalidated dependents of ${changeType}:`, dependents);
  }
  
  clear() {
    this.caches.clear();
    console.log('📊 [Cache] Cleared all caches');
  }
}

// Global cache manager instance
window.adminCacheManager = new AdminCacheManager();

// =============================================================================
// INITIALIZATION
// =============================================================================

/**
 * Initialize admin panel specific functionality
 */
function initializeAdminPanel() {
  console.log('🔧 Initializing Admin Panel Logic...');
  
  // Show system flow for debugging
  showAdminSystemFlow();
  
  // Set up global error handler for admin panel
  window.addEventListener('error', (event) => {
    console.error('Admin Panel Global Error:', event.error);
    if (window.sharedUtilities && window.sharedUtilities.message) {
      window.sharedUtilities.message.show('管理パネルでエラーが発生しました', 'error');
    }
  });
  
  console.log('✅ Admin Panel Logic initialized');
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeAdminPanel);
} else {
  initializeAdminPanel();
}

// =============================================================================
// EXPORT TO GLOBAL SCOPE
// =============================================================================

// Export admin utilities to global scope for easy access
window.adminUtilities = {
  state: appState,
  error: {
    handle: handleAdminError,
    translate: translateErrorMessage
  },
  loading: {
    set: setAdminLoading,
    showProgress: showProgressStep,
    hideProgress: hideProgressBar
  },
  modal: {
    showConfirmation: showConfirmationModal,
    hideConfirmation: hideConfirmationModal,
    showPrivacy: showPrivacyModal,
    hidePrivacy: hidePrivacyModal
  },
  ui: {
    setText: safeSetAdminText,
    updatePublicationStatus: updatePublicationStatusUI,
    updateDatabaseInfo: updateDatabaseInfo,
    toggleSection: toggleAdminSection
  },
  cache: window.adminCacheManager,
  actions: {
    handleDeleteRequest: handleDeleteRequest
  }
};

</script>

  <!-- Unified Styles and Shared Components -->
  <?!= include('SharedUtilities'); ?>
  <?!= include('SharedJavaScript'); ?>
  
  <!-- ClientOptimizer の統合 - Consolidated -->
  <script>
/**
 * @fileoverview クライアントサイド最適化ユーティリティ
 * GAS HTML Service用の最適化されたクライアント関数群
 */

class GASOptimizer {
  constructor() {
    this.cache = new Map();
    this.loadingStates = new Map();
    this.concurrentLimit = 10;
    this.activeCalls = 0;
    this.callQueue = [];
  }

  /**
   * Promise化されたgoogle.script.run呼び出し
   * @param {string} functionName - 呼び出す関数名
   * @param {...any} args - 関数の引数
   * @returns {Promise} 結果のPromise
   */
  async call(functionName, ...args) {
    return new Promise((resolve, reject) => {
      // 同時実行制限の確認
      if (this.activeCalls >= this.concurrentLimit) {
        this.callQueue.push(() => this.executeCall(functionName, args, resolve, reject));
        return;
      }

      this.executeCall(functionName, args, resolve, reject);
    });
  }

  /**
   * 実際の関数呼び出し実行
   */
  executeCall(functionName, args, resolve, reject) {
    this.activeCalls++;
    
    // ローディング状態の管理
    this.setLoadingState(functionName, true);

    google.script.run
      .withSuccessHandler((result) => {
        this.activeCalls--;
        this.setLoadingState(functionName, false);
        resolve(result);
        this.processQueue();
      })
      .withFailureHandler((error) => {
        this.activeCalls--;
        this.setLoadingState(functionName, false);
        console.error(`GAS Function Error [${functionName}]:`, error);
        reject(this.enhanceError(error, functionName));
        this.processQueue();
      })[functionName](...args);
  }

  /**
   * キューの処理
   */
  processQueue() {
    if (this.callQueue.length > 0 && this.activeCalls < this.concurrentLimit) {
      const nextCall = this.callQueue.shift();
      nextCall();
    }
  }

  /**
   * エラー情報の拡張
   */
  enhanceError(error, functionName) {
    return {
      ...error,
      function: functionName,
      timestamp: new Date().toISOString(),
      userMessage: this.getUserFriendlyErrorMessage(error.message)
    };
  }

  /**
   * ユーザーフレンドリーなエラーメッセージ
   */
  getUserFriendlyErrorMessage(originalMessage) {
    const errorMap = {
      'Exception: 認証エラー': 'ログインセッションが期限切れです。ページを更新してから再度お試しください。',
      'Exception: 無効なユーザーID': 'アクセス権限に問題があります。管理者にお問い合わせください。',
      'Exception: データベース': 'データの保存に失敗しました。しばらく待ってから再度お試しください。',
      'ScriptError': 'システムエラーが発生しました。管理者にお問い合わせください。'
    };

    for (const [key, message] of Object.entries(errorMap)) {
      if (originalMessage && originalMessage.includes(key)) {
        return message;
      }
    }
    
    return '予期しないエラーが発生しました。しばらく待ってから再度お試しください。';
  }

  /**
   * ローディング状態の管理
   */
  setLoadingState(functionName, isLoading) {
    this.loadingStates.set(functionName, isLoading);
    this.updateGlobalLoadingIndicator();
  }

  /**
   * グローバルローディングインジケーターの更新
   */
  updateGlobalLoadingIndicator() {
    const hasActiveLoading = Array.from(this.loadingStates.values()).some(state => state);
    document.body.classList.toggle('gas-loading', hasActiveLoading);
  }

  /**
   * キャッシュ付きの関数呼び出し
   */
  async callWithCache(functionName, args, ttl = 5 * 60 * 1000) {
    const cacheKey = `${functionName}_${JSON.stringify(args)}`;
    const cached = this.cache.get(cacheKey);
    
    if (cached && (Date.now() - cached.timestamp) < ttl) {
      return cached.data;
    }

    const result = await this.call(functionName, ...args);
    this.cache.set(cacheKey, {
      data: result,
      timestamp: Date.now()
    });

    return result;
  }

  /**
   * バッチ処理対応の関数呼び出し
   */
  async batchCall(calls) {
    const promises = calls.map(({ functionName, args }) => 
      this.call(functionName, ...args).catch(error => ({ error, functionName }))
    );

    return Promise.all(promises);
  }

  /**
   * キャッシュのクリア
   */
  clearCache() {
    this.cache.clear();
  }

  /**
   * 統計情報の取得
   */
  getStats() {
    return {
      activeCalls: this.activeCalls,
      queueLength: this.callQueue.length,
      cacheSize: this.cache.size,
      loadingStates: Object.fromEntries(this.loadingStates)
    };
  }
}

// グローバルインスタンスの作成
window.gasOptimizer = new GASOptimizer();

/**
 * 便利な関数のエイリアス
 */
window.gasCall = (functionName, ...args) => window.gasOptimizer.call(functionName, ...args);
window.gasCacheCall = (functionName, args, ttl) => window.gasOptimizer.callWithCache(functionName, args, ttl);

/**
 * メッセージ表示の最適化
 */
class MessageManager {
  constructor() {
    this.messageContainer = null;
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => this.init());
    } else {
      this.init();
    }
  }

  init() {
    // メッセージコンテナの作成
    if (!document.getElementById('gas-message-container')) {
      const container = document.createElement('div');
      container.id = 'gas-message-container';
      container.className = 'fixed top-4 right-4 z-50 space-y-2';
      document.body.appendChild(container);
      this.messageContainer = container;
    }
  }

  show(message, type = 'info', duration = 5000) {
    const messageEl = document.createElement('div');
    messageEl.className = `
      p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full
      ${this.getTypeClasses(type)}
    `;
    messageEl.innerHTML = `
      <div class="flex items-center space-x-2">
        <div class="flex-shrink-0">
          ${this.getIcon(type)}
        </div>
        <div class="flex-1 text-sm font-medium">${message}</div>
        <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
          </svg>
        </button>
      </div>
    `;

    this.messageContainer.appendChild(messageEl);

    // アニメーション
    setTimeout(() => {
      messageEl.classList.remove('translate-x-full');
    }, 10);

    // 自動削除
    if (duration > 0) {
      setTimeout(() => {
        if (messageEl.parentElement) {
          messageEl.classList.add('translate-x-full', 'opacity-0');
          setTimeout(() => messageEl.remove(), 300);
        }
      }, duration);
    }

    return messageEl;
  }

  getTypeClasses(type) {
    const classes = {
      info: 'bg-blue-500 text-white',
      success: 'bg-green-500 text-white',
      warning: 'bg-yellow-500 text-black',
      error: 'bg-red-500 text-white'
    };
    return classes[type] || classes.info;
  }

  getIcon(type) {
    const icons = {
      info: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/></svg>',
      success: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>',
      warning: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"/></svg>',
      error: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zM12 8a1 1 0 112 0v4a1 1 0 11-2 0V8z"/></svg>'
    };
    return icons[type] || icons.info;
  }
}

// グローバルメッセージマネージャー
window.messageManager = new MessageManager();
window.showMessage = (message, type, duration) => window.messageManager.show(message, type, duration);

// Loading CSS already defined in main <style> section - duplicate removed

// デバッグ用（開発時のみ）
if (window.location.hostname === 'localhost' || window.location.hostname.includes('script.google.com')) {
  window.gasDebug = () => console.log('GAS Optimizer Stats:', window.gasOptimizer.getStats());
}
</script>
  <!-- UnifiedCache.js - Consolidated -->
  <script>
class UnifiedCache {
  constructor() {
    this.cache = new Map();
  }

  set(key, value, ttl = 300000) {
    this.cache.set(key, { value, expiry: Date.now() + ttl });
  }

  get(key) {
    const entry = this.cache.get(key);
    if (!entry) return undefined;
    if (entry.expiry && Date.now() > entry.expiry) {
      this.cache.delete(key);
      return undefined;
    }
    return entry.value;
  }

  delete(key) {
    this.cache.delete(key);
  }

  clear() {
    this.cache.clear();
  }

  getOrSet(key, fn, ttl = 300000) {
    const existing = this.get(key);
    if (existing !== undefined) {
      return Promise.resolve(existing);
    }
    const result = fn();
    if (result && typeof result.then === 'function') {
      return result.then(value => {
        this.set(key, value, ttl);
        return value;
      });
    } else {
      this.set(key, result, ttl);
      return Promise.resolve(result);
    }
  }
}
</script>
  
  <script>
  if (typeof GASOptimizer !== 'undefined') {
    if (typeof setTimeout === 'undefined') {
      function setTimeout(fn){ fn(); return 0; }
    }
    if (typeof clearTimeout === 'undefined') {
      function clearTimeout(){ }
    }
    // 統合グローバルエラーハンドリング（重複防止）
    let lastErrorTime = 0;
    let lastErrorMessage = '';
    
    window.addEventListener('error', function(event) {
      const now = Date.now();
      const currentMessage = event.error?.message || 'Unknown error';
      
      // 重複エラーのログを防ぐ（1秒以内の同じエラー）
      if (now - lastErrorTime < 1000 && currentMessage === lastErrorMessage) {
        return;
      }
      
      lastErrorTime = now;
      lastErrorMessage = currentMessage;
      
      console.error('Global error caught:', event.error);
      
      if (event.error && event.error.message && event.error.message.includes('document.write')) {
        console.warn('document.write エラーが検出されました。安全なDOM操作に切り替えています。');
        event.preventDefault();
      }
    });
    
    // Promise rejection のキャッチ
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Unhandled promise rejection:', event.reason);
      event.preventDefault();
    });

    // GASOptimizer インスタンスの初期化
    var gasOptimizer = new GASOptimizer();
    
    // UnifiedCache インスタンスの初期化
    var unifiedCache = (typeof UnifiedCache !== 'undefined')
      ? new UnifiedCache()
      : { getOrSet: function(_, fn) { return fn(); } };
    
    // runGas ラッパー関数 - キャッシュ対応
    function runGas(functionName, ...args) {
      return gasOptimizer.call(functionName, ...args);
    }
    
    // マルチテナント対応: 新しいrunGasWithUserId関数
    function runGasWithUserId(functionName, ...args) {
      console.log('📞 runGasWithUserId called:', functionName, 'args:', args);
      console.log('📝 appState:', appState);
      
      if (!appState || !appState.userId) {
        const errorMsg = 'ユーザーIDが設定されていません。ページを再読み込みしてください。';
        console.error('❌  - No userId available for:', functionName, 'appState:', appState);
        showMessage(errorMsg, 'error');
        return Promise.reject(new Error(errorMsg));
      }

      console.log('✅  - runGasWithUserId:', functionName, 'userId:', appState.userId);
      
      if (!gasOptimizer || typeof gasOptimizer.call !== 'function') {
        const errorMsg = 'gasOptimizerが初期化されていません。';
        console.error('❌  - gasOptimizer not available');
        showMessage(errorMsg, 'error');
        return Promise.reject(new Error(errorMsg));
      }
      
      // userIdを第一引数として追加
      return gasOptimizer.call(functionName, appState.userId, ...args)
        .catch(function(error) {
          console.error('GAS呼び出しエラー:', error);
          
          // 特定のエラーに対してフォールバック処理
          if (error.message && error.message.includes('is not a function')) {
            console.warn('GAS関数が見つかりません。直接呼び出しを試行します。');
            
            // google.script.run による直接呼び出し
            return new Promise(function(resolve, reject) {
              if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  [functionName](appState.userId, ...args);
              } else {
                reject(new Error('google.script.run が利用できません。'));
              }
            });
          }
          
          throw error;
        });
    }
    
    // callWithCache 関数 - 読み取り専用操作用
    function callWithCache(functionName, cacheKey, ttl, ...args) {
      return unifiedCache.getOrSet(cacheKey, function() {
        return gasOptimizer.call(functionName, ...args);
      }, ttl);
    }
    
    // マルチテナント対応: callWithCacheWithUserId関数
    function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
      if (!appState.userId) {
        console.error('❌  - No userId available for cached call:', functionName);
        throw new Error('ユーザーIDが設定されていません。ページを再読み込みしてください。');
      }

      return unifiedCache.getOrSet(cacheKey, function() {
        console.log('✅  - callWithCacheWithUserId:', functionName, 'userId:', appState.userId);
        return gasOptimizer.call(functionName, appState.userId, ...args);
      }, ttl);
    }
  }
  </script>
  <script>
  const __IS_SYSTEM_ADMIN_RAW__ = '<?= typeof isDeployUser !== "undefined" ? isDeployUser : false ?>';
  const __IS_SYSTEM_ADMIN__ = __IS_SYSTEM_ADMIN_RAW__ === 'true' || __IS_SYSTEM_ADMIN_RAW__ === true;
  window.isSystemAdmin = __IS_SYSTEM_ADMIN__;
  console.log('Template Debug:');
  console.log('- Raw template value:', __IS_SYSTEM_ADMIN_RAW__);
  console.log('- Raw template type:', typeof __IS_SYSTEM_ADMIN_RAW__);
  console.log('- Processed value:', __IS_SYSTEM_ADMIN__);
  console.log('- window.isSystemAdmin final:', window.isSystemAdmin);
  
  // URL更新処理
  const shouldUpdateUrl = '<?= typeof shouldUpdateUrl !== "undefined" ? shouldUpdateUrl : false ?>';
  const correctUrl = '<?= typeof correctUrl !== "undefined" ? correctUrl : "" ?>';
  
  if (shouldUpdateUrl === 'true' && correctUrl && correctUrl !== '') {
    console.log('Updating URL to:', correctUrl);
    try {
      // セキュリティ制限のため、同一オリジンでのみURL更新を実行
      const currentOrigin = window.location.origin;
      const targetUrl = new URL(correctUrl);
      
      if (currentOrigin === targetUrl.origin || window.top === window) {
        if (window.history && window.history.replaceState) {
          window.history.replaceState({}, '', correctUrl);
          console.log('URL updated successfully to:', correctUrl);
        }
      } else {
        console.log('URL update skipped due to cross-origin restrictions');
      }
    } catch (e) {
      console.warn('Failed to update URL:', e);
    }
  }
  </script>
  
  <!-- Duplicate CSS blocks removed - all styles consolidated in main <style> section above -->
</head>
<body class="unified-theme bg-[#1a1b26] text-gray-200 font-sans min-h-screen flex flex-col">
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="text-center">
      <div class="spinner"></div>
      <p id="loading-message" class="mt-4 text-gray-300">処理中...</p>
    </div>
  </div>
  <header class="glass-panel border-b border-gray-700 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 sm:py-4">
      <div class="flex items-center justify-between">
        <!-- ロゴとタイトル -->
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-gradient-to-r from-cyan-400 to-purple-400 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <div class="hidden sm:block">
            <h1 class="text-xl sm:text-2xl font-bold text-white leading-tight">みんなの回答ボード 管理パネル</h1>
            <p class="text-sm text-gray-400">StudyQuest</p>
          </div>
          <div class="sm:hidden">
            <h1 class="text-xl font-bold text-white">みんなの回答ボード</h1>
          </div>
        </div>
        
        <!-- システム状況表示 -->
        <div class="flex items-center gap-3">
          <div id="system-status-indicator" class="flex items-center gap-2 glass-panel bg-gray-800/50 rounded-lg px-3 py-2 border border-gray-700">
            <div id="header-status-dot" class="w-3 h-3 bg-blue-400 rounded-full animate-pulse flex-shrink-0"></div>
            <span id="header-status-text" class="text-sm text-gray-300">初期化中...</span>
          </div>
        </div>
    </div>
  </header>
  <main class="flex-1 max-w-6xl mx-auto px-4 sm:px-6 py-4 sm:py-8 min-h-0">
    

    <!-- メインコンテンツエリア -->
    <div class="responsive-grid">
      <!-- 左側：セットアップフロー（メインパネル） -->
      <div class="left-panel space-y-6">
        
        <!-- ステップ1: データ準備 -->
        <div class="glass-panel p-6" id="data-setup-section">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl flex items-center justify-center font-bold text-xs shadow-lg">
                1
              </div>
              <div>
                <h2 class="text-xl font-semibold text-white">データ準備</h2>
                <p class="text-sm text-gray-400">スプレッドシートまたはフォームを準備</p>
              </div>
            </div>
            <button type="button" class="toggle-section" onclick="toggleSection('step1-content')" aria-expanded="true" aria-label="セクションを展開/折りたたみ">
              <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>
          
          <div id="step1-content" class="progressive-section expanded">
            <!-- フォーム作成・自動設定 -->
            <div class="mb-4">
              <div class="google-integration p-4 rounded-lg text-white">
                <h3 class="text-lg font-semibold mb-3">フォーム作成・自動設定</h3>
                <div class="space-y-2">
                  <button type="button" id="create-board-btn" class="btn btn-google w-full">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span id="create-board-text">新しいボードを作成</span>
                  </button>
                  
                  <!-- 既存ユーザー向けの新しいフォーム作成 -->
                  <div id="existing-user-section" class="hidden">
                    <button type="button" id="create-additional-form-btn" class="btn btn-secondary w-full text-sm">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      <span id="create-additional-form-text" class="text-gray-200">新規のフォームを作成</span>
                    </button>
                    <p class="text-xs text-gray-400 mt-1">現在のボードに連携する新しいフォームを作成</p>
                    
                    <!-- 作成されたフォーム表示 -->
                    <div class="space-y-3 hidden mt-4" id="form-url-section">
                      <div class="success-state bg-green-500/10 border border-green-400/30 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                          <div class="w-6 h-6 bg-green-500/20 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                          </div>
                          <span class="font-medium text-green-200">フォームが作成されました</span>
                        </div>
                        <a id="edit-form-url-link" href="#" target="_blank" class="btn btn-primary w-full justify-center" title="フォームを編集">
                          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                          </svg>
                          フォームを編集
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 外部リソースインポート -->
            <div class="bg-gray-800/30 border border-gray-600/30 rounded-lg p-4">
              <h4 class="text-base font-medium text-gray-200 mb-3">外部リソースインポート</h4>
              <div class="space-y-3">
                <input type="url" 
                       id="resource-url-input" 
                       placeholder="GoogleフォームまたはスプレッドシートのURL"
                       class="form-control">
                <button type="button" id="add-resource-btn" class="btn btn-primary w-full">
                  <span id="add-resource-text">リソースを追加</span>
                </button>
              </div>
            </div>
            
            <!-- カスタムフォーム情報表示エリア -->
            <div id="custom-form-info-section" class="hidden mt-4">
              <!-- updateCustomFormInfo()で動的に内容が設定される -->
            </div>
          </div>
        </div>

        <!-- ステップ2: シート・列設定 -->
        <div class="glass-panel p-6" id="sheet-selection-section">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl flex items-center justify-center font-bold text-xs shadow-lg">
                2
              </div>
              <div>
                <h2 class="text-xl font-semibold text-white">シート・列設定</h2>
                <p class="text-sm text-gray-400">シート選択と列マッピング</p>
              </div>
            </div>
            <button type="button" class="toggle-section" onclick="toggleSection('step2-content')" aria-expanded="true" aria-label="セクションを展開/折りたたみ">
              <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>
          
          <div id="step2-content" class="progressive-section expanded">
            <div class="space-y-4">
              <div class="space-y-3">
                <!-- シート選択の説明 -->
                <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                  <div class="flex items-center gap-2 mb-2">
                    <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <span class="text-base font-medium text-green-200">シート選択</span>
                  </div>
                  <p class="text-sm text-green-300">スプレッドシートのシートを回答ボードとして表示するシートに指定します</p>
                </div>
                
                <!-- シンプルシート選択 -->
                <label for="sheet-select" class="block text-base font-medium text-white">
                  表示したいシートを選択
                </label>
                <div class="flex gap-2">
                    <select id="sheet-select" class="form-control flex-1" aria-describedby="sheet-help">
                      <option>読み込み中...</option>
                    </select>
                    <button type="button" id="open-spreadsheet-btn-step2" class="btn btn-secondary px-4" title="スプレッドシートを開く">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ステップ3: 公開設定 -->
        <div class="glass-panel p-6" id="config-section">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl flex items-center justify-center font-bold text-xs shadow-lg">
                3
              </div>
              <div>
                <h2 class="text-xl font-semibold text-white">公開設定</h2>
                <p class="text-sm text-gray-400">表示設定と公開</p>
              </div>
            </div>
            <button type="button" class="toggle-section" onclick="toggleSection('step3-content')" aria-expanded="true" aria-label="セクションを展開/折りたたみ">
              <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>
          
          <div id="step3-content" class="progressive-section expanded">
            <div id="config-area" class="space-y-4 hidden">
              <div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  <span class="text-base font-medium text-purple-200">列マッピング設定</span>
                </div>
                <p class="text-sm text-purple-300">スプレッドシートの列を回答ボードの項目に割り当てます</p>
              </div>
              
              <!-- 必須設定 -->
              <div class="space-y-4">
                <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4">
                  <label class="block">
                    <div class="flex items-center gap-2 mb-2">
                      <span class="text-base font-medium text-white">回答データ列</span>
                      <span class="px-2 py-1 bg-red-500 text-white text-xs rounded-full">必須</span>
                    </div>
                    <div class="flex gap-2">
                      <select id="opinionHeader" class="form-control flex-1" aria-describedby="main-help"></select>
                      <button type="button" id="reguess-headers-btn" class="btn bg-gradient-to-r from-cyan-600/80 to-purple-600/80 hover:from-cyan-600 hover:to-purple-600 text-white px-4 py-2 relative overflow-hidden group" title="AI搭載 高精度列判定システム">
                        <span class="relative z-10 flex items-center gap-1">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                          </svg>
                          <span class="text-xs font-bold">AI判定</span>
                        </span>
                        <div class="absolute inset-0 bg-gradient-to-r from-cyan-400/20 to-purple-400/20 transform translate-x-full group-hover:translate-x-0 transition-transform duration-300"></div>
                      </button>
                    </div>
                    <p id="main-help" class="text-sm text-red-300 mt-1">
                      回答内容が含まれる列を選択してください
                    </p>
                  </label>
                </div>
                
                <!-- オプション設定 -->
                <div class="space-y-4" id="detail-options">
                  <label class="block">
                    <span class="text-base text-gray-300 mb-2 block">理由・詳細列</span>
                    <select id="reasonHeader" class="form-control"></select>
                  </label>
                  <label class="block">
                    <span class="text-base text-gray-300 mb-2 block">名前列</span>
                    <select id="nameHeader" class="form-control"></select>
                  </label>
                  <label class="block">
                    <span class="text-base text-gray-300 mb-2 block">クラス列</span>
                    <select id="classHeader" class="form-control"></select>
                  </label>
                  <div class="flex items-center mt-4">
                    <input type="checkbox" id="showNames" name="showNames" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="showNames" class="ml-2 block text-base text-gray-300">名前を表示する</label>
                  </div>
                  <div class="flex items-center mt-2">
                    <input type="checkbox" id="showCounts" name="showCounts" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="showCounts" class="ml-2 block text-base text-gray-300">リアクション数を表示する</label>
                  </div>
                </div>
              </div>
              
            <!-- 統合アクションボタン -->
            <div class="space-y-3 pt-4" id="publish-actions">
              <button type="button" id="save-publish-btn" class="btn btn-primary w-full">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span id="save-publish-text">設定を保存して公開</span>
              </button>

              <button type="button" id="unpublish-board-btn" class="btn btn-warning w-full">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path>
                </svg>
                <span id="unpublish-board-text">公開を停止</span>
              </button>
            </div>
            
            <div id="config-placeholder" class="text-center py-8">
              <div class="w-8 h-8 bg-gray-700 rounded-xl flex items-center justify-center mx-auto mb-3">
                <div class="loading-skeleton w-full h-full rounded-full hidden" id="config-loading"></div>
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                </svg>
              </div>
              <p class="text-gray-400 text-base">シートを選択すると列設定が表示されます</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 右パネル：システム情報 -->
      <div class="right-panel space-y-6">
        
        <!-- ドメイン情報 -->
        <div class="glass-panel p-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h10a2 2 0 002-2v-1a2 2 0 012-2h1.945C21.43 7.125 17.642 4 12.5 4S3.57 7.125 3.055 11z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 14a7 7 0 0014 0H5z"></path></svg>
            ドメイン情報
          </h3>
          <div id="domain-info-content">
            <!-- ドメイン一致 -->
            <div id="domain-match-badge" class="hidden items-center gap-3 bg-green-900/50 border border-green-500/30 rounded-lg p-3">
              <svg class="w-6 h-6 text-green-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              <div>
                <div id="domain-match-text" class="font-semibold text-green-300">G Suite ドメイン</div>
                <div class="text-xs text-green-400">セキュアアクセス有効</div>
              </div>
            </div>
            <!-- ドメイン不一致 -->
            <div id="domain-mismatch-badge" class="hidden items-center gap-3 bg-yellow-900/50 border border-yellow-500/30 rounded-lg p-3">
              <svg class="w-6 h-6 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>
              <div>
                <div id="domain-mismatch-text" class="font-semibold text-yellow-300">ドメイン不一致</div>
                <div class="text-xs text-yellow-400">アクセス制限あり</div>
              </div>
            </div>
            <!-- 初期状態 -->
            <div id="domain-initial-badge" class="flex items-center gap-3 bg-gray-800/50 border border-gray-700 rounded-lg p-3">
              <div class="w-4 h-4 bg-blue-500 rounded-full animate-pulse"></div>
              <div>
                <div class="font-semibold text-gray-300">ドメイン確認中...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- システム状況 -->
        <div class="glass-panel p-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a4 4 0 00-4-4H3V9a4 4 0 014-4h1.586a1 1 0 01.707.293l2.828 2.828a1 1 0 001.414 0l2.828-2.828A1 1 0 0115.414 5H17a4 4 0 014 4v2h-2a4 4 0 00-4 4v2M9 17h6"></path></svg>
            システム状況
          </h3>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between items-center">
              <span class="text-gray-400">公開状態:</span>
              <span class="px-2 py-1 rounded text-xs font-medium" id="info-publish-status">
                <span class="inline-flex items-center gap-1.5">
                  <div class="w-2 h-2 rounded-full" id="info-publish-indicator"></div>
                  <span id="info-publish-text">確認中</span>
                </span>
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400">公開シート:</span>
              <span class="text-white font-semibold" id="info-published-sheet">-</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400">総回答数:</span>
              <span class="text-white font-bold text-base" id="info-answer-count">-</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400">総リアクション数:</span>
              <span class="text-white font-bold text-base" id="info-reaction-count">-</span>
            </div>
          </div>
        </div>

        <!-- リソース管理 -->
        <div class="glass-panel p-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
            リソース管理
          </h3>
          <div class="space-y-3">
            <button type="button" id="open-spreadsheet-btn" class="btn btn-secondary w-full" disabled>スプレッドシートを開く</button>
            <button type="button" id="open-form-btn" class="btn btn-secondary w-full" disabled>フォームを開く</button>
            <div class="border-t border-gray-700 pt-3 mt-3">
              <button type="button" id="delete-all-resources-btn" class="btn btn-warning w-full">リソース連携を解除</button>
            </div>
          </div>
        </div>
        
        <!-- アカウント管理 -->
        <div id="account-management-section" class="glass-panel p-6 fade-in">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 icon-gradient" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="text-gradient">アカウント管理</span>
          </h3>
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-tertiary">メール:</span>
              <span class="text-primary font-medium truncate" id="info-admin-email">-</span>
            </div>
            <div class="space-y-2">
              <a href="#" onclick="switchToAnotherAccount(); return false;" class="block text-center text-cyan-400 hover:text-cyan-300 hover:underline text-sm py-2">
                別のアカウントでログイン
              </a>
              <button type="button" id="delete-account-btn" class="btn btn-danger w-full text-sm">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                アカウントを削除
              </button>
            </div>
          </div>
          <div id="account-deletion-wrapper" class="hidden">
            <!-- アカウント削除ボタンは isDeployUser フラグに基づいて JS で表示制御 -->
          </div>
        </div>

      </div>
    </div>
  </main>
  
  <footer id="admin-footer" class="sticky bottom-0 z-40">
    <div class="glass-panel rounded-none border-t border-gray-700/50 backdrop-blur-md">
      <div class="max-w-6xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <!-- 左側: 公開中のボード情報 -->
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <div class="status-indicator status-active">
                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-green-400 font-semibold text-sm">公開中</span>
              </div>
            </div>
            <p class="text-cyan-300 font-medium text-base truncate" id="current-topic-text">読み込み中...</p>
          </div>
          
          <!-- 右側: ボードURL操作 -->
          <div class="flex items-center gap-3">
            <input type="text" id="board-url" readonly
                   class="form-control text-sm min-w-[280px]"
                   onclick="this.select()" placeholder="URLが生成されます">
            <button type="button" onclick="copyBoardUrl()" class="btn btn-secondary px-3 py-2" title="URLをコピー" aria-label="生徒用URLをコピー">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
            <a id="view-board-link" href="#" target="_blank" rel="noopener noreferrer" class="btn btn-primary px-3 py-2" title="回答ボードを開く" aria-label="新しいタブで回答ボードを開く">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
          </a>
  <div id="message-area" class="message-area fixed top-20 right-6 z-50" aria-live="polite" role="status"></div>
  
  <!-- 共通モーダルコンポーネント（直接埋め込み済み） -->
  <script>
    /* =============================================================================
       AdminPanel.html - Minimal JavaScript 
       Main logic moved to AdminPanelLogic.html and SharedJavaScript.html
       ============================================================================= */
    
    // Detect test environment
    var IS_TEST_ENV = typeof navigator !== 'undefined' &&
      navigator.userAgent && navigator.userAgent.indexOf('jsdom') !== -1;

    // Backward compatibility functions using SharedUtilities
    var debounce = window.sharedUtilities?.utils?.debounce || function(func, delay) {
      return func; // Fallback
    };

    // Essential compatibility functions
    var dom = window.sharedUtilities?.dom || {};
    var createSafeElement = dom.createSafeElement || document.createElement.bind(document);
    var getCachedElement = dom.getCachedElement || document.getElementById.bind(document);
    var safeGetElement = getCachedElement;
    
    // =============================================================================
    // MINIMAL ADMIN PANEL JAVASCRIPT
    // Main logic moved to AdminPanelLogic.html
    // =============================================================================
    
    // Essential elements object for backward compatibility
    var elements = {};
    
    // Essential functions using shared utilities
    var showMessage = window.sharedUtilities?.message?.show || function(msg, type) {
      console.log(`[${type}] ${msg}`);
      
      // Fallback message display implementation
      const messageArea = document.getElementById('message-area');
      if (!messageArea) {
        console.warn('Message area not found, creating fallback');
        return;
      }
      
      // Create message element
      const messageElement = document.createElement('div');
      messageElement.className = `message glass-panel px-4 py-3 rounded-lg shadow-lg mb-3 transition-all duration-300 transform translate-x-0`;
      
      // Set message styling based on type
      switch (type) {
        case 'success':
          messageElement.className += ' bg-green-500/20 border border-green-500/50 text-green-200';
          break;
        case 'error':
          messageElement.className += ' bg-red-500/20 border border-red-500/50 text-red-200';
          break;
        case 'warning':
          messageElement.className += ' bg-yellow-500/20 border border-yellow-500/50 text-yellow-200';
          break;
        case 'info':
        default:
          messageElement.className += ' bg-blue-500/20 border border-blue-500/50 text-blue-200';
          break;
      }
      
      // Set message content
      messageElement.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="text-sm font-medium">${msg}</span>
          <button type="button" class="text-current opacity-70 hover:opacity-100 ml-3 text-lg" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
      `;
      
      // Add to message area
      messageArea.appendChild(messageElement);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (messageElement.parentElement) {
          messageElement.style.opacity = '0';
          messageElement.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (messageElement.parentElement) {
              messageElement.remove();
            }
          }, 300);
        }
      }, 5000);
    };
    
    var handleError = window.adminUtilities?.error?.handle || function(error, context) {
      console.error(`[${context}]`, error);
    };
    
    var setLoading = window.adminUtilities?.loading?.set || function(loading, message) {
      console.log(`Loading: ${loading} - ${message}`);
    };
    
    var updateDatabaseInfo = window.adminUtilities?.ui?.updateDatabaseInfo || function(status) {
      console.log('Update database info:', status);
    };
    
    var toggleSection = window.adminUtilities?.ui?.toggleSection || function(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.toggle('expanded');
        section.classList.toggle('collapsed');
      }
    };
    
    // Simple character counter setup
    function setupCharacterCounters() {
      const questionInput = document.getElementById('main-question-text');
      const questionCounter = document.getElementById('question-char-counter');
      
      if (questionInput && questionCounter) {
        questionInput.addEventListener('input', function() {
          const count = this.value.length;
          questionCounter.textContent = `${count}/500`;
          questionCounter.className = count > 450 ? 'text-xs text-red-400' : 'text-xs text-gray-500';
        });
      }
    }
    
    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
      if (!IS_TEST_ENV) {
        console.log('🔧 AdminPanel: Using unified utilities and logic files');
        setupCharacterCounters();
        
        // Initialize admin utilities if available
        if (window.adminUtilities) {
          console.log('✅ AdminPanel: Admin utilities loaded');
        }
        
        if (window.sharedUtilities) {
          console.log('✅ AdminPanel: Shared utilities loaded');
        }
        
        // リソース連携解除機能のテスト（デバッグモードのみ）
        if (DEBUG_MODE) {
          window.testDisconnectResources = function() {
            console.log('🧪 Testing disconnectResources function...');
            return runGasWithUserId('disconnectResources')
              .then(function(response) {
                console.log('✅ disconnectResources test successful:', response);
                return response;
              })
              .catch(function(error) {
                console.error('❌ disconnectResources test failed:', error);
                throw error;
              });
          };
        }
      }
    });
  </script>

  <!-- フォーム設定モーダル -->
  <script>
    
    // Utility for setting up click handlers with privacy modal
    function setupPrivacyHandler(elementId, callback) {
      var element = elements[elementId] || getCachedElement(elementId);
      if (element) {
        addSafeEventListener(element, 'click', function() {
          showPrivacyModal(callback);
        });
      }
    }
    
    // Utility for delegated event handling
    function setupDelegatedHandler(parentElement, selector, event, callback) {
      if (typeof parentElement === 'string') {
        parentElement = getCachedElement(parentElement);
      }
      
      if (parentElement) {
        addSafeEventListener(parentElement, event, function(e) {
          var target = e.target.closest(selector);
          if (target) {
            callback.call(target, e);
          }
        });
      }
    }
    
    // =============================================================================
    // ERROR HANDLING SYSTEM - Centralized error management
    // =============================================================================
    
    // Centralized error handling with consistent formatting
    function handleError(error, context, userMessage) {
      // Log error for debugging
      var errorMsg = error && error.message ? error.message : String(error);
      console.error('[' + (context || 'Unknown') + '] Error:', errorMsg);
      
      // Convert technical errors to user-friendly messages
      var displayMessage = userMessage || translateErrorMessage(errorMsg, context);
      showMessage(displayMessage, 'error');
      
      // Additional error reporting could be added here
      return false;
    }

    /**
     * 技術的なエラーメッセージをユーザーフレンドリーなメッセージに変換
     * @param {string} errorMsg - 元のエラーメッセージ
     * @param {string} context - エラーが発生したコンテキスト
     * @returns {string} ユーザーフレンドリーなエラーメッセージ
     */
    function translateErrorMessage(errorMsg, context) {
      if (!errorMsg || typeof errorMsg !== 'string') {
        return 'エラーが発生しました。しばらく待ってから再試行してください。';
      }

      var lowerMsg = errorMsg.toLowerCase();
      
      // スプレッドシート関連のエラー
      if (lowerMsg.includes('範囲の列数には') || lowerMsg.includes('range')) {
        return `📊 スプレッドシートにデータが正しく入力されていません。
💡 解決方法：スプレッドシートを開いて、1行目にヘッダー（列名）が入力されているか確認してください。`;
      }
      
      if (lowerMsg.includes('シート情報の取得に失敗') || lowerMsg.includes('sheet')) {
        return `📋 シートの情報を読み込めませんでした。
💡 解決方法：
• スプレッドシートが正しく共有されているか確認
• シートにデータが入力されているか確認
• しばらく待ってから再試行`;
      }
      
      // 権限関連のエラー
      if (lowerMsg.includes('permission') || lowerMsg.includes('権限') || lowerMsg.includes('access denied')) {
        return `🔒 アクセス権限がありません。
💡 解決方法：
• スプレッドシートの共有設定を確認
• 編集権限があることを確認
• アカウントでログインし直してみる`;
      }
      
      // ネットワーク関連のエラー
      if (lowerMsg.includes('network') || lowerMsg.includes('timeout') || lowerMsg.includes('fetch')) {
        return `🌐 インターネット接続の問題が発生しました。
💡 解決方法：
• インターネット接続を確認
• しばらく待ってから再試行
• ページを再読み込み`;
      }
      
      // フォーム関連のエラー
      if (lowerMsg.includes('form') && lowerMsg.includes('not found')) {
        return `📝 フォームが見つかりません。
💡 解決方法：
• フォームが作成されているか確認
• フォームが削除されていないか確認
• 新しいフォームを作成`;
      }
      
      // データ検証関連のエラー
      if (lowerMsg.includes('validation') || lowerMsg.includes('invalid')) {
        return `⚠️ 入力内容に問題があります。
💡 解決方法：
• 必須項目がすべて入力されているか確認
• 入力形式が正しいか確認
• 特殊文字が含まれていないか確認`;
      }
      
      // 認証関連のエラー
      if (lowerMsg.includes('authentication') || lowerMsg.includes('login') || lowerMsg.includes('unauthorized')) {
        return `🔐 認証に問題があります。
💡 解決方法：
• ログイン状態を確認
• ページを再読み込み
• 再度ログインしてみる`;
      }
      
      // サーバー関連のエラー
      if (lowerMsg.includes('server error') || lowerMsg.includes('500') || lowerMsg.includes('503')) {
        return `⚡ システムが一時的に利用できません。
💡 解決方法：
• 数分待ってから再試行
• 問題が続く場合は管理者に連絡`;
      }
      
      // 設定関連のエラー
      if (context && context.includes('config') || lowerMsg.includes('configuration')) {
        return `⚙️ 設定の保存に問題があります。
💡 解決方法：
• すべての必須項目が入力されているか確認
• 設定内容に問題がないか確認
• しばらく待ってから再試行`;
      }
      
      // その他の一般的なエラー
      if (lowerMsg.includes('failed') || lowerMsg.includes('error')) {
        return `❌ 操作が正常に完了しませんでした。
💡 解決方法：
• しばらく待ってから再試行
• ページを再読み込み
• 問題が続く場合は別のブラウザを試す`;
      }
      
      // フォールバック
      return `⚠️ 予期しないエラーが発生しました。
💡 解決方法：
• ページを再読み込み
• しばらく待ってから再試行
• 問題が続く場合はサポートにお問い合わせください`;
    }
    
    // Wrapper for Google Apps Script calls with consistent error handling
    function safeGASCall(methodName, successHandler, errorMessage) {
      return {
        withSuccessHandler: function(handler) {
          this._successHandler = handler;
          return this;
        },
        withFailureHandler: function(handler) {
          this._failureHandler = handler;
          return this;
        },
        execute: function() {
          var self = this;
          google.script.run
            .withSuccessHandler(function(result) {
              if (self._successHandler) {
                try {
                  self._successHandler(result);
                } catch (err) {
                  handleError(err, methodName + '.successHandler', 'データの処理中にエラーが発生しました。');
                }
              }
            })
            .withFailureHandler(function(error) {
              if (self._failureHandler) {
                try {
                  self._failureHandler(error);
                }
                catch (err) {
                  handleError(err, methodName + '.failureHandler');
                }
              }
              else {
                handleError(error, methodName, errorMessage);
              }
            })[methodName].apply(google.script.run, arguments);
        }
      };
    }
    
    // Legacy showError function for backward compatibility
    function showError(error) {
      handleError(error, 'General', null);
    }

    // =============================================================================
    // MESSAGE SYSTEM - Refactored for better maintainability
    // =============================================================================
    
    // Message type configurations
    var MESSAGE_TYPES = {
      info: { bgColor: 'bg-blue-500', icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
      success: { bgColor: 'bg-green-500', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z', extraClass: 'success-pulse' },
      error: { bgColor: 'bg-red-500', icon: 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z', extraClass: 'error-shake' },
      warning: { bgColor: 'bg-yellow-500', icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z', extraClass: 'text-black' },
      green: { bgColor: 'bg-green-500', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' },
      blue: { bgColor: 'bg-blue-500', icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
      yellow: { bgColor: 'bg-yellow-500', icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z', extraClass: 'text-black' }
    };
    
    // Sanitize message content safely
    function sanitizeMessage(message) {
      if (typeof message !== 'string') {
        try {
          message = String(message);
        } catch (e) {
          return 'メッセージ表示エラー';
        }
      }
      
      // Remove control characters and limit length
      return message
        .replace(/[\u0000-\u001F\u007F]/g, '')
        .replace(/[\'"\\]/g, '')
        .substring(0, 200);
    }
    
    // Check for duplicate messages and highlight if found
    function checkDuplicateMessage(messageArea, message) {
      var existingMessages = Array.from(messageArea.children);
      for (var i = 0; i < existingMessages.length; i++) {
        var existing = existingMessages[i];
        var spanElement = existing.querySelector('span');
        var existingText = spanElement ? spanElement.textContent : null;
        if (existingText === message) {
          // Highlight existing message
          existing.style.transform = 'scale(1.05)';
          setTimeout(function() { existing.style.transform = 'scale(1)'; }, 200);
          return true;
        }
      }
      return false;
    }
    
    // Clean up old messages (keep only 5 most recent)
    function cleanupOldMessages(messageArea) {
      while (messageArea.children.length >= 5) {
        messageArea.children[0].remove();
      }
    }
    
    // Create message DOM structure
    function createMessageElement(messageId, message, type) {
      var typeConfig = MESSAGE_TYPES[type] || MESSAGE_TYPES.info;
      var messageElement = createSafeElement('div');
      messageElement.id = messageId;
      messageElement.className = 'p-4 mb-3 rounded-lg shadow-md flex items-center justify-between text-white transform transition-all duration-300 ease-out slide-up ' + typeConfig.bgColor;
      
      if (typeConfig.extraClass) {
        messageElement.classList.add(typeConfig.extraClass);
      }
      
      // Create message container with icon and text
      var messageContainer = createSafeElement('div', 'flex items-center');
      var iconContainer = createSafeElement('div');
      iconContainer.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' + typeConfig.icon + '"></path></svg>';
      
      var messageSpan = createSafeElement('span', 'ml-2 text-sm font-medium', message);
      messageContainer.appendChild(iconContainer);
      messageContainer.appendChild(messageSpan);
      
      // Create close button
      var closeButton = createSafeElement('button', 'ml-4 text-white opacity-70 hover:opacity-100 focus:outline-none');
      closeButton.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
      closeButton.onclick = function() { removeMessage(messageId); };
      
      messageElement.appendChild(messageContainer);
      messageElement.appendChild(closeButton);
      
      return messageElement;
    }
    
    // Set up auto-removal timer for message
    function setupMessageAutoRemoval(messageId, type) {
      var timeout = type === 'error' ? 5000 : 2500;
      return setTimeout(function() {
        var msgEl = safeGetElement(messageId);
        if (msgEl && msgEl.parentNode) {
          msgEl.classList.remove('slide-up');
          msgEl.classList.add('fade-out');
          
          var fallbackTimer = setTimeout(function() {
            if (msgEl && msgEl.parentNode) {
              msgEl.remove();
            }
          }, 500);
          
          msgEl.addEventListener('transitionend', function() {
            clearTimeout(fallbackTimer);
            if (msgEl && msgEl.parentNode) {
              msgEl.remove();
            }
          }, { once: true });
        }
      }, timeout);
    }
    
    // Main showMessage function - now much cleaner
    function showMessage(message, type) {
      if (IS_TEST_ENV) return;
      try {
        type = type || 'info';
        message = sanitizeMessage(message);
        
        var messageArea = safeGetElement('message-area');
        if (!messageArea) return;
        
        // Check for duplicates
        if (checkDuplicateMessage(messageArea, message)) {
          return;
        }
        
        // Clean up old messages
        cleanupOldMessages(messageArea);
        
        // Create and display new message
        var messageId = 'msg-' + Date.now();
        var messageElement = createMessageElement(messageId, message, type);
        messageArea.appendChild(messageElement);
        
        // Set up auto-removal
        messageElement.removeTimer = setupMessageAutoRemoval(messageId, type);
        
      } catch (error) {
        try {
          console.error('showMessage function error:', error);
        } catch (e) {
          // Silently fail if even logging fails
        }
      }
    }

    function removeMessage(messageId) {
      var msgEl = document.getElementById(messageId);
      if (msgEl) {
        // 自動タイマーをクリア
        if (msgEl.removeTimer) {
          clearTimeout(msgEl.removeTimer);
        }
        // 即座に削除
        msgEl.remove();
      }
    }

    function addVisualFeedback(element, type) {
      if (!element) return;
      element.classList.remove('success-pulse', 'error-shake');
      void element.offsetWidth; // Trigger reflow
      element.classList.add(type === 'success' ? 'success-pulse' : 'error-shake');
    }

    // Layout adjustment function - removed since footer is now in flex layout

    

    /**
     * 設定エリアを非表示にし、プレースホルダーを表示する
     */
    function hideConfigArea() {
        var configArea = document.getElementById('config-area');
        var configPlaceholder = document.getElementById('config-placeholder');
        if (configArea) configArea.classList.add('hidden');
        if (configPlaceholder) configPlaceholder.classList.remove('hidden');
    }

    function showConfirmationModal(title, message, onConfirm) {
      var modal = document.getElementById('confirmation-modal');
      var modalTitle = document.getElementById('modal-title');
      var modalMessage = document.getElementById('modal-message');
      
      if (modalTitle) modalTitle.textContent = title;
      if (modalMessage) modalMessage.textContent = message;
      
      if (!modal) {
        console.error('確認モーダルが見つかりません');
        return;
      }
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      var confirmBtn = document.getElementById('modal-confirm');
      var cancelBtn = document.getElementById('modal-cancel');

      if (!confirmBtn || !cancelBtn) {
        console.error('モーダルボタンが見つかりません');
        return;
      }

      var confirmHandler = function() {
        onConfirm();
        hideConfirmationModal();
        confirmBtn.removeEventListener('click', confirmHandler);
        cancelBtn.removeEventListener('click', cancelHandler);
      };

      var cancelHandler = function() {
        hideConfirmationModal();
        confirmBtn.removeEventListener('click', confirmHandler);
        cancelBtn.removeEventListener('click', cancelHandler);
      };

      confirmBtn.addEventListener('click', confirmHandler);
      cancelBtn.addEventListener('click', cancelHandler);
    }

    function hideConfirmationModal() {
      var modal = document.getElementById('confirmation-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    // 公開確認ダイアログを表示
    function showPublishConfirmDialog() {
      showConfirmationModal(
        '回答ボードを公開しますか？',
        'フォームの設定が完了しました。生徒がアクセスできるように回答ボードを公開しますか？',
        function() {
          publishBoard();
        }
      );
    }
    
    // ワンクリックで公開を実行
    function publishBoard() {
      console.log('Publishing board automatically...');
      
      if (!appState.selectedSheet) {
        console.error('No sheet selected for publishing');
        return;
      }
      
      // 表示をロード中に変更
      showLoadingState('公開中...');
      
      // 公開処理を実行（activateSheet関数を使用）
      runGasWithUserId('activateSheetSimple', appState.selectedSheet)
        .then(function(result) {
          console.log('Board published successfully:', result);
          hideLoadingState();
          
          // ステータスを更新（キャッシュを強制リフレッシュ）
          cacheManager.invalidateDependents('user_data_change'); // 統一キャッシュ管理
          getCachedStatus(true);
          
          // 成功メッセージを表示
          showToast('回答ボードが公開されました！', 'success');
        })
        .catch(function(error) {
          console.error('Failed to publish board:', error);
          hideLoadingState();
          showToast('公開に失敗しました: ' + error.message, 'error');
        });
    }
    
    // 自動公開ダイアログのチェック（新規フォーム作成時は自動処理に移行済みのためスキップ）
    function checkAutoPublishDialog(status) {
      // 新規フォーム作成時は createAdditionalForm で自動処理されるため、ここでは何もしない
      if (status && status.autoPublishCompleted) {
        console.log('Auto-publish already completed during form creation');
        return;
      }
      
      // 既存フォームの手動設定変更時のみダイアログを表示
      if (status && status.autoShowPublishDialog && status.readyToPublish && !status.isNewForm) {
        console.log('Showing publish dialog for existing form configuration changes');
        
        setTimeout(function() {
          showPublishConfirmDialog();
          
          // フラグをリセットして重複表示を防ぐ
          if (appState.currentStatus) {
            appState.currentStatus.autoShowPublishDialog = false;
          }
        }, 1000);
      }
    }

    // Global appState defined in AdminPanelLogic

    // Detect jsdom test environment to disable auto-loading
    var IS_TEST_ENV = typeof navigator !== 'undefined' &&
      navigator.userAgent && navigator.userAgent.indexOf('jsdom') !== -1;

    const DEBUG_MODE = false;
    
    // プロダクション環境でのログ制御
    const originalConsoleLog = console.log;
    const originalConsoleDebug = console.debug;
    
    if (!DEBUG_MODE) {
      // プロダクションでは詳細ログを抑制
      console.log = function(...args) {
        // エラーや重要な情報のみログ出力
        if (args[0] && (typeof args[0] === 'string')) {
          if (args[0].includes('✅') || args[0].includes('❌') || args[0].includes('⚠️') || args[0].includes('Error:')) {
            originalConsoleLog.apply(console, args);
          }
        }
      };
      
      console.debug = function() {
        // プロダクションではdebugログを完全に無効化
      };
    }

    // AdminPanel専用システムフロー表示機能
    function showSystemFlow() {
      if (!DEBUG_MODE) return;
      
      console.group('🔄 StudyQuest 管理パネル システムフロー');
      console.log('📋 Phase 1: 管理パネル初期化');
      console.log('  ├─ 管理者権限確認');
      console.log('  ├─ ユーザー情報取得');
      console.log('  ├─ スプレッドシート接続');
      console.log('  └─ UI要素初期化');
      
      console.log('🎨 Phase 2: レイアウト構築');
      console.log('  ├─ 左パネル（メイン操作）');
      console.log('  ├─ 右パネル（システム情報）');
      console.log('  ├─ フッター（公開URL表示）');
      console.log('  └─ レスポンシブ対応');
      
      console.log('📡 Phase 3: データ連携');
      console.log('  ├─ スプレッドシートデータ取得');
      console.log('  ├─ シート一覧取得');
      console.log('  ├─ 列ヘッダー自動判定');
      console.log('  └─ 公開状態確認');
      
      console.log('🏗️ Phase 4: 設定UI構築');
      console.log('  ├─ ステップインジケーター');
      console.log('  ├─ シート選択ドロップダウン');
      console.log('  ├─ 列設定フォーム');
      console.log('  └─ プレビュー表示');
      
      console.log('⚡ Phase 5: 管理機能');
      console.log('  ├─ ボード作成・公開');
      console.log('  ├─ 設定変更');
      console.log('  ├─ URLコピー機能');
      console.log('  └─ リアルタイム更新');
      
      console.log('🔧 Phase 6: 最適化・監視');
      console.log('  ├─ キャッシュ管理');
      console.log('  ├─ エラーハンドリング');
      console.log('  ├─ パフォーマンス監視');
      console.log('  └─ デバッグ情報出力');
      
      console.groupEnd();
      
      // AdminPanel固有の状態を表示
      console.group('📊 管理パネル現在状態');
      console.log('DOM状態:', document.readyState);
      console.log('CSS読み込み:', document.styleSheets.length + ' stylesheets');
      console.log('GAS環境:', typeof google !== 'undefined' ? 'Available' : 'Not Available');
      console.log('管理者状態:', typeof appState.currentStatus !== 'undefined' && appState.currentStatus ? 'Authenticated' : 'Unknown');
      console.log('スプレッドシートURL:', typeof appState.currentSpreadsheetUrl !== 'undefined' ? (appState.currentSpreadsheetUrl ? 'Set' : 'Not Set') : 'Unknown');
      console.groupEnd();
    }

    function setLoading(isLoading, message = '') {
      const loader = document.getElementById('loading-overlay');
      const loaderMessage = document.getElementById('loading-message');
      if (!loader) return;

      if (isLoading) {
        if (loaderMessage) loaderMessage.textContent = message;
        loader.classList.remove('hidden');
      } else {
        loader.classList.add('hidden');
      }
    }

    // プログレスバー関数群 - フォーム作成の段階的進行を表示
    function showProgressStep(currentStep, totalSteps, message) {
      let progressContainer = document.getElementById('progress-container');
      
      if (!progressContainer) {
        // プログレスバーコンテナを動的に作成
        progressContainer = document.createElement('div');
        progressContainer.id = 'progress-container';
        progressContainer.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
        progressContainer.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
            <div class="text-center mb-4">
              <h3 class="text-lg font-semibold text-gray-900">フォーム作成進行中</h3>
            </div>
            <div class="mb-4">
              <div class="bg-gray-200 rounded-full h-3 overflow-hidden">
                <div id="progress-bar" class="bg-blue-600 h-full transition-all duration-500 ease-out" style="width: 0%"></div>
              </div>
            </div>
            <div class="text-center">
              <p id="progress-message" class="text-sm text-gray-600"></p>
              <p class="text-xs text-gray-500 mt-2">
                ステップ <span id="progress-current">1</span> / <span id="progress-total">5</span>
              </p>
            </div>
          </div>
        `;
        document.body.appendChild(progressContainer);
      }
      
      const progressBar = document.getElementById('progress-bar');
      const progressMessage = document.getElementById('progress-message');
      const progressCurrent = document.getElementById('progress-current');
      const progressTotal = document.getElementById('progress-total');
      
      if (progressBar) {
        const percentage = (currentStep / totalSteps) * 100;
        progressBar.style.width = percentage + '%';
      }
      
      if (progressMessage) progressMessage.textContent = message;
      if (progressCurrent) progressCurrent.textContent = currentStep;
      if (progressTotal) progressTotal.textContent = totalSteps;
      
      progressContainer.classList.remove('hidden');
    }

    function hideProgressBar() {
      const progressContainer = document.getElementById('progress-container');
      if (progressContainer) {
        progressContainer.classList.add('hidden');
        setTimeout(() => {
          if (progressContainer.parentNode) {
            progressContainer.parentNode.removeChild(progressContainer);
          }
        }, 500);
      }
    }

    var elements = {}; // elementsオブジェクトを初期化

    // Progressive Disclosure Functions - 早期定義
    function toggleSection(sectionId) {
      var section = document.getElementById(sectionId);
      var icon = document.getElementById(sectionId.replace('content', 'icon'));
      
      if (!section) return;
      
      var isExpanded = section.classList.contains('expanded');
      
      if (isExpanded) {
        section.classList.remove('expanded');
        section.classList.add('collapsed');
        if (icon) {
          if (sectionId === 'step1-content') {
            icon.style.transform = 'rotate(0deg)'; // Down arrow
          } else if (sectionId === 'step2-content' || sectionId === 'step3-content') {
            icon.style.transform = 'rotate(90deg)'; // Right arrow
          }
        }
      } else {
        section.classList.remove('collapsed');
        section.classList.add('expanded');
        if (icon) {
          if (sectionId === 'step1-content') {
            icon.style.transform = 'rotate(180deg)'; // Up arrow
          } else if (sectionId === 'step2-content' || sectionId === 'step3-content') {
            icon.style.transform = 'rotate(0deg)'; // Down arrow
          }
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      // 初期ロード状態を表示
      setLoading(true, '設定を読み込み中...');
      
      // タイムアウト設定（20秒）
      var initTimeoutId = setTimeout(function() {
        setLoading(false);
        showMessage('初期設定の読み込みに時間がかかっています。ページを再読み込みしてください。', 'warning');
      }, 20000);
      // `elements` オブジェクトの定義を修正
elements = {
  // ... 既存の要素はそのまま ...
  sheetSelect: document.getElementById('sheet-select'),
  configArea: document.getElementById('config-area'),
  configPlaceholder: document.getElementById('config-placeholder'),
  opinionHeader: document.getElementById('opinionHeader'),
  reasonHeader: document.getElementById('reasonHeader'),
  nameHeader: document.getElementById('nameHeader'),
  classHeader: document.getElementById('classHeader'),
  saveConfigBtn: document.getElementById('save-config-btn'),
  detailOptions: document.getElementById('detail-options'),
  boardUrl: document.getElementById('board-url'),
  viewBoardLink: document.getElementById('view-board-link'),
  setupProgress: document.getElementById('setup-progress'),
  setupProgressMobile: document.getElementById('setup-progress-mobile'),
  setupProgressText: document.getElementById('setup-progress-text'),
  setupProgressTextMobile: document.getElementById('setup-progress-text-mobile'),
  headerDomainName: document.getElementById('header-domain-name'),
  headerStatusDot: document.getElementById('header-status-dot'),
  headerStatusText: document.getElementById('header-status-text'),
  configStatus: document.getElementById('config-status'),
  addSpreadsheetText: document.getElementById('add-spreadsheet-text'),
  saveConfigText: document.getElementById('save-config-text'),
  createBoardBtn: document.getElementById('create-board-btn'),
  createBoardText: document.getElementById('create-board-text'),
  formUrlInput: document.getElementById('form-url-input'),
  copyFormUrlBtn: document.getElementById('copy-form-url-btn'),
  openFormUrlLink: document.getElementById('open-form-url-link'),
  editFormUrlLink: document.getElementById('edit-form-url-link'),
  openSpreadsheetBtn: document.getElementById('open-spreadsheet-btn'),
  addSpreadsheetBtn: document.getElementById('add-spreadsheet-btn'),
  guidanceText: document.getElementById('guidance-text'),
  // 新しいシート詳細要素
  sheetDetails: document.getElementById('sheet-details'),
  sheetColumns: document.getElementById('sheet-columns'),
  spreadsheetLink: document.getElementById('spreadsheet-link'),
  formLink: document.getElementById('form-link'),
  
  // ★★★ ここから追加 ★★★
  // システム情報パネルの要素
  'info-admin-email': document.getElementById('info-admin-email'),
  'info-user-id': document.getElementById('info-user-id'),
  'info-published-sheet': document.getElementById('info-published-sheet'),
  'info-answer-count': document.getElementById('info-answer-count'),
  'info-reaction-count': document.getElementById('info-reaction-count'),
  'delete-account-btn': document.getElementById('delete-account-btn'),
  
  // 新しいUI要素
  'info-publish-status': document.getElementById('info-publish-status'),
  'info-publish-indicator': document.getElementById('info-publish-indicator'),
  'info-publish-text': document.getElementById('info-publish-text'),
  'info-display-mode': document.getElementById('info-display-mode'),
  'info-show-counts': document.getElementById('info-show-counts'),
  'open-form-btn': document.getElementById('open-form-btn'),
  'open-linked-form-btn': document.getElementById('open-linked-form-btn'),
  
  // 統合フッター要素
  adminFooter: document.getElementById('admin-footer'),
  currentTopicText: document.getElementById('current-topic-text')
  // ★★★ ここまで追加 ★★★
};
      // アカウント管理セクションの表示制御
      const accountManagementSection = document.getElementById('account-management-section');
      const accountDeletionWrapper = document.getElementById('account-deletion-wrapper');

      if (window.isSystemAdmin) {
        // システム管理者の場合、アカウント管理セクション自体を非表示
        if (accountManagementSection) {
          accountManagementSection.style.display = 'none';
          console.log('✅ Account management section hidden for system admin');
        }
      } else {
        // 一般ユーザーの場合、アカウント削除ボタンを追加
        if (accountDeletionWrapper) {
          const deleteButtonHTML = `
            <div class="border-t border-red-700/50 pt-3 mt-3">
              <p class="text-xs text-red-300/80 mb-2">この操作は元に戻せません。アカウントを削除すると、作成したすべてのボードと設定が完全に消去されます。</p>
              <button type="button" id="delete-account-btn" class="btn btn-danger w-full text-sm py-2">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                <span>自分のアカウントを完全に削除する</span>
              </button>
            </div>
          `;
          accountDeletionWrapper.innerHTML = deleteButtonHTML;
          console.log('ℹ️ Account deletion button shown for non-system admin');
        }
      }
      if (!IS_TEST_ENV) {
        showSystemFlow(); // デバッグフロー表示
        loadStatus();
        // Layout adjustment removed - using flexbox layout
        loadAdminDomainInfo();
      }
      setupEventListeners();
      
      // システム状況のリアルタイム更新を開始
      startSystemStatusUpdate();
      
      // 初期ロード完了後にタイムアウトをクリア
      setTimeout(function() {
        clearTimeout(initTimeoutId);
        setLoading(false);
      }, 1000);
    });
    // ===== 統一キャッシュ管理システム =====
    class FrontendCacheManager {
      constructor() {
        this.caches = new Map();
        this.defaultTTL = 30000; // 30秒
        this.dependencies = new Map();
        this._initializeDependencies();
      }
      
      _initializeDependencies() {
        // キャッシュ依存関係の定義
        this.dependencies.set('user_data_change', ['status', 'userInfo', 'formUrls']);
        this.dependencies.set('form_creation', ['status', 'formUrls', 'sheetDetails']);
        this.dependencies.set('config_change', ['status', 'sheetDetails']);
      }
      
      get(key, defaultValue = null) {
        const cached = this.caches.get(key);
        if (!cached) return defaultValue;
        
        const now = Date.now();
        if (now - cached.timestamp > cached.ttl) {
          this.caches.delete(key);
          console.log(`📊 [Cache] Expired and removed: ${key}`);
          return defaultValue;
        }
        
        console.log(`📊 [Cache] Hit: ${key}`);
        return cached.value;
      }
      
      set(key, value, ttl = null) {
        this.caches.set(key, {
          value: value,
          timestamp: Date.now(),
          ttl: ttl || this.defaultTTL
        });
        console.log(`📊 [Cache] Set: ${key} (TTL: ${ttl || this.defaultTTL}ms)`);
      }
      
      invalidate(key) {
        this.caches.delete(key);
        console.log(`📊 [Cache] Invalidated: ${key}`);
      }
      
      invalidatePattern(pattern) {
        let count = 0;
        for (const key of this.caches.keys()) {
          if (key.includes(pattern)) {
            this.caches.delete(key);
            count++;
          }
        }
        console.log(`📊 [Cache] Invalidated ${count} entries matching pattern: ${pattern}`);
      }
      
      invalidateDependents(changeType) {
        const dependents = this.dependencies.get(changeType);
        if (!dependents) return;
        
        dependents.forEach(key => this.invalidate(key));
        console.log(`🔄 [Cache] Cascade invalidation: ${changeType} -> [${dependents.join(', ')}]`);
      }
      
      clear() {
        const count = this.caches.size;
        this.caches.clear();
        console.log(`🖾️ [Cache] Cleared all ${count} entries`);
      }
      
      getStats() {
        return {
          totalEntries: this.caches.size,
          dependencies: this.dependencies.size
        };
      }
    }
    
    // グローバルキャッシュマネージャーのインスタンス
    const cacheManager = new FrontendCacheManager();

    /**
     * キャッシュされたステータスを取得
     * @param {boolean} forceRefresh - 強制的にリフレッシュするかどうか
     * @returns {Promise} ステータス情報
     */
    function getCachedStatus(forceRefresh = false) {
      const cacheKey = 'status';
      
      // 統一キャッシュマネージャーでチェック
      if (!forceRefresh) {
        const cached = cacheManager.get(cacheKey);
        if (cached) {
          return Promise.resolve(cached);
        }
      }
      
      console.log('📊 Status cache miss, fetching from server');
      return runGasWithUserId('getStatus', forceRefresh)
        .then(function(status) {
          cacheManager.set(cacheKey, status);
          return status;
        })
        .catch(function(error) {
          console.error('⚠️ [Cache] Failed to fetch status:', error);
          // キャッシュから古いデータを返すことも考慮
          const staleData = cacheManager.get(cacheKey + '_stale');
          if (staleData) {
            console.log('📊 [Cache] Returning stale data due to fetch error');
            return staleData;
          }
          throw error;
        });
    }

    // ===== 共通ドメイン情報処理関数 =====
    // AdminPanel.html と Registration.html で共通使用
    
    /**
     * ドメイン情報を取得して表示する共通関数
     * @param {Function} onSuccess - 成功時のコールバック（オプション）
     * @param {Function} onError - エラー時のコールバック（オプション）
     */
    function loadDomainInfo(onSuccess, onError) {
      callWithCache('getDeployUserDomainInfo', 'domain_info', 60000)
        .then(function(info) {
          displayDomainInfo(info);
          if (onSuccess) onSuccess(info);
        })
        .catch(function(error) {
          console.error('ドメイン情報の取得に失敗しました:', error);
          displayDomainInfo({ error: error.message || error });
          if (onError) onError(error);
        });
    }

    /**
     * ドメイン情報を表示する共通関数
     * @param {Object} info - ドメイン情報オブジェクト
     */
    function displayDomainInfo(info) {
      var headerDomainMatch = document.getElementById('header-domain-match');
      var headerDomainMismatch = document.getElementById('header-domain-mismatch');
      var headerDomainInitial = document.getElementById('header-domain-initial');
      var headerDomainMatchText = document.getElementById('header-domain-match-text');
      var headerDomainMismatchText = document.getElementById('header-domain-mismatch-text');

      // 全ての表示を一旦非表示にする
      if (headerDomainMatch) headerDomainMatch.classList.add('hidden');
      if (headerDomainMismatch) headerDomainMismatch.classList.add('hidden');
      if (headerDomainInitial) headerDomainInitial.classList.add('hidden');
      
      if (!info || info.error) {
        console.warn('ドメイン情報エラー:', info && info.error ? info.error : 'Unknown error');
        if (headerDomainInitial) headerDomainInitial.classList.remove('hidden');
        return;
      }

      if (info.isDomainMatch) {
        // ドメインが一致している場合
        if (headerDomainMatch && headerDomainMatchText) {
          headerDomainMatch.classList.remove('hidden');
          if (info.deployDomain) {
            headerDomainMatchText.textContent = info.deployDomain + ' ドメイン';
          } else {
            headerDomainMatchText.textContent = 'グローバルアクセス';
          }
        }
      } else {
        // ドメイン不一致の場合
        if (headerDomainMismatch && headerDomainMismatchText) {
          headerDomainMismatch.classList.remove('hidden');
          headerDomainMismatchText.textContent = info.currentDomain;
        }
      }
    }

    // AdminPanel専用のラッパー関数（後方互換性のため）
    function loadAdminDomainInfo() {
      loadDomainInfo();
    }

    function displayAdminDomainInfo(info) {
      displayDomainInfo(info);
    }
    
    // ステップベースのUI初期化
    function initializeStepBasedUI() {
      // ステップ1のみ開く、ステップ2・3は閉じる（既にHTMLで設定済み）
      // Initialization complete - UI state already set in HTML
    }

    // 重複していたDOMContentLoadedイベントリスナーを削除
    // 既に上記で設定済み

    // `setupEventListeners` 関数の中にこのリスナーを追加
function setupEventListeners() {
  // ... 既存のリスナーはそのまま ...
  // Layout adjustment removed - using flexbox layout
      if (elements.sheetSelect) {
        elements.sheetSelect.addEventListener('change', function(e) {
          appState.selectedSheet = e.target.value;
          
          // selectedSheetが文字列であることを確認
          if (typeof appState.selectedSheet !== 'string' || appState.selectedSheet === '[object Object]') {
            console.error('selectedSheetが無効です:', appState.selectedSheet);
            console.error('選択されたオプション:', e.target.options[e.target.selectedIndex]);
            return;
          }
          
          updateUIForSelectedSheet();
          
          // 公開中のシートの場合は列情報の読み込みをスキップ
          if (!(appState.currentStatus && appState.currentStatus.appPublished &&
                (appState.selectedSheet === appState.currentActiveSheet || appState.selectedSheet === appState.currentStatus.publishedSheetName))) {
            loadConfigForSelected();
          }
        });
      }

      // ★★★ ここから追加 ★★★
      var reguessBtn = document.getElementById('reguess-headers-btn');
      if (reguessBtn) {
        reguessBtn.addEventListener('click', runHeaderGuessing);
      }
      // ★★★ ここまで追加 ★★★

      // Actions
      
      if (elements.clearSelectionBtn) {
        elements.clearSelectionBtn.addEventListener('click', clearSheetSelection);
      }
      // 新しい保存・公開ボタンのイベントリスナー
      var savePublishBtn = document.getElementById('save-publish-btn');
      if (savePublishBtn) {
        savePublishBtn.addEventListener('click', function() {
          showConfirmationModal(
            '設定の保存と公開',
            '現在の設定を保存し、回答ボードを公開します。よろしいですか？',
            saveAndPublish
          );
        });
      }
      
      // 公開停止ボタンのイベントハンドラー
      var unpublishBtn = document.getElementById('unpublish-board-btn');
      if (unpublishBtn) {
        unpublishBtn.addEventListener('click', function() {
          showConfirmationModal(
            '公開を停止',
            'ボードの公開を停止します。この操作により、ボードにアクセスできなくなります。継続しますか？',
            unpublishBoard
          );
        });
      }
      
      // 全リソース削除ボタンのイベントハンドラー
      var deleteAllResourcesBtn = document.getElementById('delete-all-resources-btn');
      if (deleteAllResourcesBtn) {
        deleteAllResourcesBtn.addEventListener('click', function() {
          showConfirmationModal(
            '全リソースの削除',
            '⚠️ この操作は取り消しできません。\n\nデータベース内の以下の情報が完全に削除されます：\n・ スプレッドシート情報\n・ フォーム情報\n・ 設定情報\n・ 公開状態\n\n続行しますか？',
            deleteAllResources
          );
        });
      }
      
      var addResourceBtn = document.getElementById('add-resource-btn');
      if (addResourceBtn) {
        addResourceBtn.addEventListener('click', addResource);
      }
      
      // Legacy spreadsheet management (keep for compatibility)
      var addSpreadsheetBtn = document.getElementById('add-spreadsheet-btn');
      if (addSpreadsheetBtn) {
        addSpreadsheetBtn.addEventListener('click', addSpreadsheet);
      }
      
      // Create board events
      if (elements.createBoardBtn) {
        elements.createBoardBtn.addEventListener('click', createAdditionalForm);
      }
      
      var quickCreateBtn = document.getElementById('quick-create-board-btn');
      if (quickCreateBtn) {
        quickCreateBtn.addEventListener('click', createBoard);
      }
      
      // 追加フォーム作成ボタン
      var createAdditionalFormBtn = document.getElementById('create-additional-form-btn');
      if (createAdditionalFormBtn) {
        createAdditionalFormBtn.addEventListener('click', function() {
          showFormConfigModal();
        });
      }

      // フォーム設定モーダルのイベントリスナー
      var formConfigClose = document.getElementById('form-config-close');
      var formConfigCancel = document.getElementById('form-config-cancel');
      var formConfigCreate = document.getElementById('form-config-create');
      var mainQuestionType = document.getElementById('main-question-type');

      if (formConfigClose) {
        formConfigClose.addEventListener('click', hideFormConfigModal);
      }
      if (formConfigCancel) {
        formConfigCancel.addEventListener('click', hideFormConfigModal);
      }
      if (formConfigCreate) {
        formConfigCreate.addEventListener('click', createFormWithConfig);
      }

      // 質問タイプ変更時の処理
      if (mainQuestionType) {
        mainQuestionType.addEventListener('change', function() {
          const choicesDiv = document.getElementById('main-question-choices-div');
          if (this.value === 'multiple' || this.value === 'choice') {
            choicesDiv.classList.remove('hidden');
          } else {
            choicesDiv.classList.add('hidden');
          }
        });
      }

      // クラス選択の有効/無効切り替え
      var enableClassSelection = document.getElementById('enable-class-selection');
      if (enableClassSelection) {
        enableClassSelection.addEventListener('change', function() {
          const classChoicesContainer = document.getElementById('class-choices-container');
          if (this.checked) {
            classChoicesContainer.classList.remove('hidden');
          } else {
            classChoicesContainer.classList.add('hidden');
          }
        });
      }

      var refreshBoardBtn = document.getElementById('refresh-board-btn');
      if (refreshBoardBtn) {
        refreshBoardBtn.addEventListener('click', refreshBoardDataFromAdmin);
      }
      
      // Display options
      if (elements.detailOptions) {
        elements.detailOptions.addEventListener('change', function(e) {
          if (e.target.name === 'showNames' || e.target.name === 'showCounts') {
            updateConfigButtons(); // 設定保存ボタンの状態を更新
          }
        });
      }
      
      // Auto-update config when headers change
      if (elements.opinionHeader) {
        elements.opinionHeader.addEventListener('change', updateConfigButtons);
      }
      
      // リアルタイムバリデーションの設定
      setupRealtimeValidation();
      
      // リアルタイムバリデーションの設定
      setupRealtimeValidation();
      
      // Digital citizenship button event
      var digitalCitizenshipBtn = document.getElementById('digital-citizenship-btn');
      if (digitalCitizenshipBtn) {
        digitalCitizenshipBtn.addEventListener('click', showDigitalCitizenshipModal);
      }
      
      // Teacher guide modal events
      var teacherGuideConfirmBtn = document.getElementById('teacherGuideConfirmBtn');
      if (teacherGuideConfirmBtn) {
        teacherGuideConfirmBtn.addEventListener('click', hideTeacherGuideModal);
      }
      
      // Digital citizenship guide button
      var showDigitalCitizenshipBtn = document.getElementById('show-digital-citizenship-guide');
      if (showDigitalCitizenshipBtn) {
        showDigitalCitizenshipBtn.addEventListener('click', function() {
          var modal = document.getElementById('digital-citizenship-modal');
          if (modal) {
            modal.classList.remove('hidden');
          }
        });
      }
      
      // Usage guide button
      var showUsageGuideBtn = document.getElementById('show-usage-guide');
      if (showUsageGuideBtn) {
        showUsageGuideBtn.addEventListener('click', function() {
          var modal = document.getElementById('usage-guide-modal');
          if (modal) {
            modal.classList.remove('hidden');
          }
        });
      }
      
      // Digital citizenship modal close events
      var digitalCitizenshipCloseBtn = document.getElementById('digital-citizenship-modal-close');
      var digitalCitizenshipCloseBtnBottom = document.getElementById('digital-citizenship-modal-close-btn');
      
      if (digitalCitizenshipCloseBtn) {
        digitalCitizenshipCloseBtn.addEventListener('click', function() {
          var modal = document.getElementById('digital-citizenship-modal');
          if (modal) {
            modal.classList.add('hidden');
          }
        });
      }
      
      if (digitalCitizenshipCloseBtnBottom) {
        digitalCitizenshipCloseBtnBottom.addEventListener('click', function() {
          var modal = document.getElementById('digital-citizenship-modal');
          if (modal) {
            modal.classList.add('hidden');
          }
        });
      }
      
      var openSpreadsheetBtn = document.getElementById('open-spreadsheet-btn');
      if (openSpreadsheetBtn) {
        openSpreadsheetBtn.addEventListener('click', openDatabaseSpreadsheet);
      }

      // Add event listener for the step2 spreadsheet button
      var openSpreadsheetBtnStep2 = document.getElementById('open-spreadsheet-btn-step2');
      if (openSpreadsheetBtnStep2) {
        openSpreadsheetBtnStep2.addEventListener('click', openDatabaseSpreadsheet);
      }

      var openFormBtn = document.getElementById('open-form-btn');
      if (openFormBtn) {
        openFormBtn.addEventListener('click', openForm);
      }

      // Open linked form button event listener
      if (elements['open-linked-form-btn']) {
        elements['open-linked-form-btn'].addEventListener('click', openLinkedForm);
      }

  // ★★★ ここから追加 ★★★
  if (elements['delete-account-btn']) {
    elements['delete-account-btn'].addEventListener('click', handleDeleteRequest);
  }
  
  // セキュリティモーダル関連のイベントリスナー
  var securityInfoBtn = document.getElementById('security-info-btn');
  var securityModal = document.getElementById('security-modal');
  var securityModalClose = document.getElementById('security-modal-close');
  var securityModalConfirm = document.getElementById('security-modal-confirm');
  
  if (securityInfoBtn && securityModal) {
    securityInfoBtn.addEventListener('click', function() {
      securityModal.classList.remove('hidden');
    });
  }
  
  if (securityModalClose && securityModal) {
    securityModalClose.addEventListener('click', function() {
      securityModal.classList.add('hidden');
    });
  }
  
  if (securityModalConfirm && securityModal) {
    securityModalConfirm.addEventListener('click', function() {
      securityModal.classList.add('hidden');
    });
  }
  
  // モーダル外クリックで閉じる
  if (securityModal) {
    securityModal.addEventListener('click', function(e) {
      if (e.target === securityModal) {
        securityModal.classList.add('hidden');
      }
    });
  }
  
  // ★★★ ここまで追加 ★★★
}

// ★★★ 以下の2つの関数を新しく追加 ★★★

/**
 * アカウント削除ボタンが押された時の処理（2重チェックのモーダル表示）
 */
function handleDeleteRequest() {
  // プライバシーモーダルを最初に表示
  showPrivacyModal(function() {
    // プライバシー確認後、削除確認モーダルを表示
    showConfirmationModal(
      'アカウントの完全削除',
      '本当にこのアカウントを削除しますか？この操作は元に戻せず、すべてのデータが失われます。',
      function() {
        setLoading(true, 'アカウントを完全に削除しています...');
        runGasWithUserId('deleteCurrentUserAccount')
          .then(function(response) {
            setLoading(false);
            showMessage(response, 'success');
            setTimeout(function() {
              // Use iframe-safe navigation
              if (window.sharedUtilities && window.sharedUtilities.navigation) {
                window.sharedUtilities.navigation.safeNavigate('?page=LoginPage', {
                  fallbackMessage: '登録ページに移動中...',
                  method: 'auto'
                });
              } else {
                window.location.href = '?page=LoginPage';
              }
            }, 2000);
          })
          .catch(function(error) {
            setLoading(false);
            showError(error);
          });
      }
    );
  });
}

// showPrivacyModal function removed - using the one defined earlier in the file


/**
 * UI要素のテキストを安全に設定するヘルパー関数
 * @param {string} elementId - 要素のID
 * @param {string} value - 設定する値
 * @param {string} prefix - プレフィックス（オプション）
 */
function safeSetText(elementId, value, prefix = '') {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = value ? prefix + value : '-';
    console.log(`✅ [DEBUG] Updated ${elementId}:`, element.textContent);
  } else {
    console.warn(`❌ [DEBUG] Element not found: ${elementId}`);
  }
}

/**
 * サーバーから受け取ったstatusオブジェクトを元に、システム状況パネルを更新します。
 * @param {object} status - getStatusから返される完全なステータスオブジェクト
 */
function updateDatabaseInfo(status) {
  console.log('🔧 [DEBUG] updateDatabaseInfo called with status:', status);
  
  if (!status || !status.userInfo) {
    console.warn('システム情報を更新できませんでした: ユーザー情報がありません。', status);
    return;
  }

  console.log('✅ [DEBUG] User info found, updating system panel:', status.userInfo);

  // スプレッドシートURLを設定
  if (status.userInfo.spreadsheetUrl) {
    appState.currentSpreadsheetUrl = status.userInfo.spreadsheetUrl;
    console.log('✅ [DEBUG] currentSpreadsheetUrl set to:', appState.currentSpreadsheetUrl);
  }

  // 既存のフィールドを更新
  safeSetText('info-admin-email', status.userInfo.adminEmail);
  safeSetText('info-user-id', status.userInfo.userId);
  // 公開シート名の表示（複数のソースから取得を試みる）
  let publishedSheetName = status.publishedSheetName || status.activeSheetName;
  if (!publishedSheetName && status.userInfo && status.userInfo.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      publishedSheetName = config.publishedSheetName;
    } catch (e) {
      console.warn('ConfigJSON parse error in published sheet name:', e);
    }
  }
  safeSetText('info-published-sheet', publishedSheetName || 'なし');
  safeSetText('info-answer-count', status.answerCount || '0');
  safeSetText('info-reaction-count', status.totalReactions || '0');

  // 新しいUI要素を更新
  
  // 公開状態の更新（複数の判定方法を試す）
  const isPublished = status && (
    status.isPublished || 
    status.appPublished || 
    (status.publishedSheetName && status.publishedSheetName !== 'なし')
  );
  updatePublicationStatusUI(isPublished);

  // 表示モードの更新
  const displayMode = status.showNames ? '名前表示' : '匿名表示';
  safeSetText('info-display-mode', displayMode);

  // カウント表示の更新
  const showCounts = status.showCounts !== undefined ? (status.showCounts ? '表示' : '非表示') : '表示';
  safeSetText('info-show-counts', showCounts);
  
  // チェックボックスの状態を同期
  syncCheckboxStates(status);

  // ボタンの状態を更新
  const openSpreadsheetBtns = document.querySelectorAll('#open-spreadsheet-btn, #open-spreadsheet-btn-step2');
  const openFormBtn = document.getElementById('open-form-btn');
  
  openSpreadsheetBtns.forEach(btn => {
    if (btn) {
      const hasSpreadsheetUrl = status.userInfo && status.userInfo.spreadsheetUrl;
      btn.disabled = !hasSpreadsheetUrl;
      if (hasSpreadsheetUrl) {
        btn.title = 'スプレッドシートを開く';
      } else {
        btn.title = 'スプレッドシートが設定されていません';
      }
    }
  });
  
  if (openFormBtn) {
    const formUrl = status.formUrl || (status.userInfo && status.userInfo.formUrl);
    const hasFormUrl = formUrl && formUrl.trim() !== "";
    openFormBtn.disabled = !hasFormUrl;
    if (hasFormUrl) {
      openFormBtn.title = 'フォームを開く';
    } else {
      openFormBtn.title = 'フォームが設定されていません';
    }
  }

  // Update open-linked-form-btn state based on formUrl availability
  const openLinkedFormBtn = elements['open-linked-form-btn'];
  if (openLinkedFormBtn) {
    const hasFormUrl = status.formUrl && status.formUrl.trim() !== '';
    openLinkedFormBtn.disabled = !hasFormUrl;
    if (hasFormUrl) {
      openLinkedFormBtn.title = '連携しているGoogleフォームを開きます';
    } else {
      openLinkedFormBtn.title = '連携しているフォームが設定されていません';
    }
  }
}

function updatePublicationStatusUI(isPublished) {
  const statusIndicator = document.getElementById('info-publish-indicator');
  const statusText = document.getElementById('info-publish-text');
  const unpublishBtn = document.getElementById('unpublish-board-btn');
  const savePublishBtn = document.getElementById('save-publish-btn');

  if (isPublished) {
    if (statusIndicator) {
      statusIndicator.classList.remove('bg-gray-400');
      statusIndicator.classList.add('bg-green-400');
    }
    if (statusText) statusText.textContent = '公開中';
    if (unpublishBtn) unpublishBtn.classList.remove('hidden');
    if (savePublishBtn) savePublishBtn.textContent = '設定を更新して再公開';
  } else {
    if (statusIndicator) {
      statusIndicator.classList.remove('bg-green-400');
      statusIndicator.classList.add('bg-gray-400');
    }
    if (statusText) statusText.textContent = '非公開';
    if (unpublishBtn) unpublishBtn.classList.add('hidden');
    if (savePublishBtn) savePublishBtn.textContent = '設定を保存して公開';
  }
}

// チェックボックスの状態を同期する関数
function syncCheckboxStates(status) {
  // 設定データの優先順位: 公開シート設定 > グローバル設定 > デフォルト値
  const activeSheetName = status.activeSheetName || status.publishedSheetName;
  const sheetConfig = activeSheetName && status.systemStatus ? 
    status.systemStatus[`sheet_${activeSheetName}`] : null;
  
  // showNames の値を決定
  const showNames = sheetConfig?.showNames !== undefined ? 
    sheetConfig.showNames : 
    (status.showNames !== undefined ? status.showNames : false);
    
  // showCounts の値を決定
  const showCounts = sheetConfig?.showCounts !== undefined ? 
    sheetConfig.showCounts : 
    (status.showCounts !== undefined ? status.showCounts : false);
  
  const showNamesCheckbox = document.getElementById('showNames');
  const showCountsCheckbox = document.getElementById('showCounts');

  if (showNamesCheckbox) showNamesCheckbox.checked = showNames;
  if (showCountsCheckbox) showCountsCheckbox.checked = showCounts;
  
  console.log('🔂 [DEBUG] Checkbox sync:', {
    activeSheetName,
    sheetConfig,
    showNames,
    showCounts,
    globalShowNames: status.showNames,
    globalShowCounts: status.showCounts
  });
}

    /**
     * ページ読み込み時に、現在のステータスをサーバーから取得してUIに反映する
     * @param {boolean} forceRefresh - キャッシュを無視して強制的に再取得するか
     */
    async function loadStatus(forceRefresh = false) {
      // パフォーマンス最適化: 短時間内の連続呼び出しを防ぐクールダウン
      const now = Date.now();
      const cooldownPeriod = 2000; // 2秒のクールダウン
      
      if (!forceRefresh && loadStatus.lastCall && (now - loadStatus.lastCall) < cooldownPeriod) {
        console.log('✅ loadStatus: クールダウン中のため呼び出しをスキップ');
        return appState.currentStatus;
      }
      
      loadStatus.lastCall = now;
      
      // ユーザーアクションによる手動更新の場合、アクティビティを記録
      updateUserActivity();
      
      setLoading(true, '最新のステータス情報を読み込んでいます...');
      
      // キャッシュキーを定義
      const cacheKey = 'status_' + (appState.userId || 'guest');
      const cacheTime = 60000; // 60秒キャッシュ
      
      if (forceRefresh) {
        // 強制更新時はキャッシュを削除してサーバーから取得
        if (typeof unifiedCache !== 'undefined') {
          unifiedCache.delete(cacheKey);
        }
        // キャッシュされたステータスを取得（強制リフレッシュ）
        try {
          const status = await getCachedStatus(true);
          console.log('✅ Status loaded (forced refresh)', status);
          updateUIWithNewStatus(status);
          setLoading(false);
          return status;
        } catch (error) {
          console.error('❌ getCachedStatus failed:', error);
          handleError(error, 'loadStatus');
          setLoading(false);
          throw error;
        }
      } else {
        // キャッシュされたステータスを取得（通常読み込み）
        try {
          const status = await getCachedStatus(false);
          console.log('✅ Status loaded (cached)', status);
          updateUIWithNewStatus(status);
          setLoading(false);
          return status;
        } catch (error) {
          handleError(error, 'loadStatus');
          setLoading(false);
          throw error;
        }
      }
    }

    /**
     * 新しいステータスオブジェクトでUI全体を更新する
     * @param {object} status - getStatusから返されるステータスオブジェクト
     */
    function updateUIWithNewStatus(status) {
      appState.currentStatus = status;
      
      // 1. 静的なUI要素の更新
      updateStaticUI(status);
      console.log('✅ [2/3] Static UI Updated');

      // 2. 動的なコンテンツと最終的なUI調整
      if (status.activeSheetName) {
        updateDynamicContent(status);
      } else {
        // アクティブなシートがない場合の処理
        updateUIForNoActiveSheet(status);
        console.log('✅ [3/3] No active sheet - UI update completed');
      }
    }

    /**
     * アクティブなシートがない場合にUIを更新する
     * @param {object} status - ステータスオブジェクト
     */
    function updateUIForNoActiveSheet(status) {
      // 設定エリアを隠す
      hideConfigArea();
      
      // フッターとガイダンスを更新
      updateFooterAndGuidance(status);
      
      // ステップインジケーターを更新
      updateStepIndicators(status.setupStep);
      
      // セクションの表示/非表示を更新
      updateSectionVisibility(status.setupStep);
      
      setLoading(false);
    }

    /**
     * 静的なUI要素（シート選択やボタンの状態など）を更新する
     * @param {object} status - ステータスオブジェクト
     */
    function updateStaticUI(status) {
      // データベース情報を更新
      updateDatabaseInfo(status);
      
      // 既存ユーザーセクションの表示を更新
      updateExistingUserSection(status);
      
      // シート選択ドロップダウンを更新
      populateSheetSelect(status.allSheets, status.activeSheetName);
      
      // カスタムフォーム情報を表示
      updateCustomFormInfo(status);
      
      // フォームURL表示エリアを更新
      updateFormUrlSection(status);
      
      // 自動公開ダイアログのチェック
      checkAutoPublishDialog(status);
    }

    /**
     * カスタムフォーム情報を表示する
     * @param {object} status - ステータスオブジェクト
     */
    function updateCustomFormInfo(status) {
      const customFormInfoSection = document.getElementById('custom-form-info-section');
      
      if (!customFormInfoSection) {
        // セクションが存在しない場合は作成（将来的な拡張用）
        return;
      }
      
      // customFormInfo は opinionHeader に統一したため、このセクションは常に非表示
      customFormInfoSection.classList.add('hidden');
    }

    /**
     * HTMLエスケープ関数
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * フォームURL表示セクションを更新する
     * @param {object} status - ステータスオブジェクト
     */
    function updateFormUrlSection(status) {
      const formUrlSection = document.getElementById('form-url-section');
      const formUrlInput = elements.formUrlInput;
      const copyFormUrlBtn = elements.copyFormUrlBtn;
      const openFormUrlLink = elements.openFormUrlLink;
      const editFormUrlLink = elements.editFormUrlLink;
      
      if (!formUrlSection || !formUrlInput) {
        return;
      }
      
      // formURLを複数の場所から取得を試みる（最新のものを優先）
      console.log('🔍 [DEBUG] updateFormUrlSection called with status:', {
        hasStatusFormUrl: !!status.formUrl,
        statusFormUrl: status.formUrl,
        hasUserInfo: !!status.userInfo,
        hasConfigJson: !!(status.userInfo && status.userInfo.configJson)
      });
      
      let formUrl = null;
      
      // 1. statusから直接取得（最新）
      if (status.formUrl) {
        formUrl = status.formUrl;
        console.log('✅ [DEBUG] Using formUrl from status:', formUrl);
      }
      // 2. userInfo.configJsonから取得
      else if (status.userInfo && status.userInfo.configJson) {
        try {
          const config = JSON.parse(status.userInfo.configJson);
          formUrl = config.formUrl;
          console.log('✅ [DEBUG] Retrieved formUrl from configJson:', formUrl);
          console.log('🔍 [DEBUG] Full config data:', {
            hasFormUrl: !!config.formUrl,
            hasEditFormUrl: !!config.editFormUrl,
            lastFormCreatedAt: config.lastFormCreatedAt
          });
        } catch (e) {
          console.warn('ConfigJSON parse error:', e);
        }
      }
      // 3. フォールバック
      else if (status.userInfo && status.userInfo.formUrl) {
        formUrl = status.userInfo.formUrl;
        console.log('✅ [DEBUG] Using formUrl from userInfo:', formUrl);
      }
      const hasFormUrl = formUrl && formUrl.trim() !== '';
      
      if (hasFormUrl) {
        // フォームURLがある場合、表示エリアを表示してURLを設定
        formUrlInput.value = formUrl;
        formUrlSection.classList.remove('hidden');
        
        // コピーボタンの設定
        if (copyFormUrlBtn) {
          copyFormUrlBtn.onclick = function() {
            formUrlInput.select();
            formUrlInput.setSelectionRange(0, 99999); // モバイル対応
            
            try {
              document.execCommand('copy');
              showMessage('フォームURLをコピーしました', 'success');
            } catch (err) {
              console.error('コピーに失敗しました:', err);
              showMessage('コピーに失敗しました', 'error');
            }
          };
        }
        
        // 外部リンクボタンの設定
        if (openFormUrlLink) {
          openFormUrlLink.href = formUrl;
        }
        
        // 編集リンクボタンの設定
        if (editFormUrlLink) {
          console.log('🔍 [DEBUG] Setting up edit form link:', {
            hasStatusEditFormUrl: !!status.editFormUrl,
            statusEditFormUrl: status.editFormUrl,
            formUrlForConversion: formUrl
          });
          
          let editFormUrl = null;
          
          // 1. statusから直接取得（最新）
          if (status.editFormUrl) {
            editFormUrl = status.editFormUrl;
            console.log('✅ [DEBUG] Using editFormUrl from status:', editFormUrl);
          }
          // 2. userInfo.configJsonから取得
          else if (status.userInfo && status.userInfo.configJson) {
            try {
              const config = JSON.parse(status.userInfo.configJson);
              editFormUrl = config.editFormUrl;
              console.log('✅ [DEBUG] Retrieved editFormUrl from configJson:', editFormUrl);
            } catch (e) {
              console.warn('Failed to get editFormUrl from config:', e);
            }
          }
          
          if (editFormUrl) {
            editFormUrlLink.href = editFormUrl;
            editFormUrlLink.classList.remove('hidden');
            console.log('✅ [DEBUG] Edit button enabled with URL:', editFormUrl);
          } else if (formUrl && formUrl.includes('/viewform')) {
            const convertedEditUrl = formUrl.replace('/viewform', '/edit');
            editFormUrlLink.href = convertedEditUrl;
            editFormUrlLink.classList.remove('hidden');
            console.log('✅ [DEBUG] Edit button enabled with converted URL:', convertedEditUrl);
          } else {
            editFormUrlLink.classList.add('hidden');
            console.log('✅ [DEBUG] Edit button hidden: no valid URL');
          }
        }
        
        console.log('✅ [DEBUG] Form URL section displayed:', formUrl);
      } else {
        // フォームURLがない場合、表示エリアを隠す
        formUrlSection.classList.add('hidden');
        formUrlInput.value = '';
        if (editFormUrlLink) {
          editFormUrlLink.classList.add('hidden');
        }
        console.log('✅ [DEBUG] Form URL section hidden - no form URL available');
      }
    }

    /**
     * 質問タイプのラベルを取得
     */
    function getQuestionTypeLabel(type) {
      const labels = {
        'text': 'テキスト入力',
        'multiple': 'チェックボックス',
        'choice': 'ラジオボタン',
        'paragraph': '長文入力'
      };
      return labels[type] || type;
    }

    /**
     * 動的なコンテンツ（列設定など）を更新する
     * @param {object} status - ステータスオブジェクト
     */
    function updateDynamicContent(status) {
      // フッターとガイダンスを更新
      updateFooterAndGuidance(status);
      
      // ステップインジケーターを更新
      updateStepIndicators(status.setupStep);
      
      // セクションの表示/非表示を更新
      updateSectionVisibility(status.setupStep);
      
      // 列設定を読み込み
      loadConfigForSelected();
      
      console.log('✅ [3/3] Dynamic Content and Final UI Updated');
    }

    /**
     * 既存ユーザー向けセクションの表示を更新
     */
    function updateExistingUserSection(status) {
      const existingUserSection = document.getElementById('existing-user-section');
      const createBoardBtn = document.getElementById('create-board-btn');

      if (!existingUserSection || !createBoardBtn) return;
      
      console.log('🕵️ [DEBUG] updateExistingUserSection called with:', status);

      // ユーザー情報とスプレッドシートIDの有無で判断
      const hasUserInfo = status && status.userInfo && Object.keys(status.userInfo).length > 0;
      const hasSpreadsheetId = hasUserInfo && status.userInfo.spreadsheetId;

      if (hasUserInfo && hasSpreadsheetId) {
        existingUserSection.classList.remove('hidden');
        createBoardBtn.classList.add('hidden');
        console.log('✅ [DEBUG] Showing existing user section, hiding create button');
      } else {
        existingUserSection.classList.add('hidden');
        createBoardBtn.classList.remove('hidden');
        console.log('✅ [DEBUG] Hiding existing user section, showing create button');
      }
    }

    /**
     * フッターとガイダンスメッセージを更新する
     * @param {object} status - ステータスオブジェクト
     */
    function updateFooterAndGuidance(status) {
      console.log('👣 [DEBUG] updateFooterAndGuidance called with status:', status);
      const footer = document.getElementById('admin-footer');
      const guidanceText = document.getElementById('guidance-text');
      const stepDescription = document.getElementById('step-description');
      const nextActionContainer = document.getElementById('next-action-container');
      const nextActionText = document.getElementById('next-action-text');
      
      if (!footer || !guidanceText) return;

      const isPublished = status.isPublished;

      if (isPublished && status.appUrls && status.appUrls.viewUrl) {
        footer.classList.remove('hidden');
        document.getElementById('board-url').value = status.appUrls.viewUrl;
        document.getElementById('view-board-link').href = status.appUrls.viewUrl;
        
        // トピックテキストを設定（問題文を表示）
        const topicTextElement = document.getElementById('current-topic-text');
        if (topicTextElement) {
          let topic = '（問題文未設定）';
          
          // opinionHeaderを優先的に使用
          if (status.userInfo && status.userInfo.configJson && status.publishedSheetName) {
            try {
              const config = JSON.parse(status.userInfo.configJson);
              const sheetKey = 'sheet_' + status.publishedSheetName;
              const sheetConfig = config[sheetKey] || {};
              topic = sheetConfig.opinionHeader || status.publishedSheetName || '（問題文未設定）';
              console.log('✅ [DEBUG] Using sheet config opinionHeader:', topic);
            } catch (e) {
              console.warn('ConfigJson parsing error:', e);
              topic = status.publishedSheetName || '（問題文未設定）';
            }
          }

          topicTextElement.textContent = topic;
          console.log(`✅ [DEBUG] Set footer topic text to: ${topic}`);
        }
        
        guidanceText.textContent = '回答ボードは現在公開中です。';
      } else {
        footer.classList.add('hidden');
        // ガイダンスのテキストとステップの説明を動的に設定
        if (status.nextAction) {
          guidanceText.textContent = status.nextAction;
        } else {
          // フォールバック: ステップ番号に基づくデフォルトメッセージ
          switch(status.setupStep) {
            case 1:
              guidanceText.textContent = 'ステップ1: アカウント作成が完了しました。';
              break;
            case 2:
              guidanceText.textContent = 'ステップ2: データ準備中です。スプレッドシートとフォームを作成しています...';
              break;
            case 3:
              guidanceText.textContent = 'ステップ3: データ準備完了！表示したいシートを選択してください。';
              break;
            case 4:
              guidanceText.textContent = 'ステップ4: 列を設定して表示内容をカスタマイズしましょう。';
              break;
            case 5:
              guidanceText.textContent = 'ステップ5: プレビューを確認して公開設定を行いましょう。';
              break;
            case 6:
              guidanceText.textContent = 'ステップ6: 回答ボードが公開されました！';
              break;
            default:
              guidanceText.textContent = 'セットアップを開始してください。';
          }
        }
        
        // ステップの説明を更新
        if (stepDescription && status.stepDescription) {
          stepDescription.textContent = status.stepDescription;
        }
        
        // 次のアクションボタンを表示・更新
        if (nextActionContainer && nextActionText && status.nextAction && status.setupStep < 6) {
          nextActionText.textContent = getActionButtonText(status.setupStep);
          nextActionContainer.classList.remove('hidden');
          
          // ボタンのクリックイベントを設定
          const nextActionBtn = document.getElementById('next-action-btn');
          if (nextActionBtn) {
            nextActionBtn.onclick = () => executeNextAction(status.setupStep);
          }
        } else if (nextActionContainer) {
          nextActionContainer.classList.add('hidden');
        }
      }
      
      // fallback for topic text if everything else fails
      if (isPublished && document.getElementById('current-topic-text').textContent === '読み込み中...') {
         // フォールバックでも問題文を取得を試みる
         let fallbackTopic = '（問題文未設定）';
         if (status.publishedSheetName && status.userInfo && status.userInfo.configJson) {
           try {
             const config = JSON.parse(status.userInfo.configJson);
             const sheetKey = 'sheet_' + status.publishedSheetName;
             const sheetConfig = config[sheetKey] || {};
             fallbackTopic = sheetConfig.opinionHeader || status.publishedSheetName || '（問題文未設定）';
           } catch (e) {
             fallbackTopic = status.publishedSheetName || '（問題文未設定）';
           }
         }
         document.getElementById('current-topic-text').textContent = fallbackTopic;
         console.log(`✅ [DEBUG] Set footer topic text fallback to: ${fallbackTopic}`);
      }

      // Layout adjustment removed - using flexbox layout
    }

    /**
     * ステップインジケーターのUIを更新する（6ステップシステムを3ステップUIにマッピング）
     * @param {number} currentStep - 現在のステップ番号 (1-6)
     */
    function updateStepIndicators(currentStep) {
      console.log('📊 [DEBUG] updateStepIndicators called with currentStep:', currentStep);
      
      // 6ステップシステムを3ステップUIにマッピング
      // Step 1-2 (アカウント作成・データ準備) → UI Step 1 (データ準備)
      // Step 3-4 (データ投入・シート選択) → UI Step 2 (シート選択) 
      // Step 5-6 (プレビュー・公開) → UI Step 3 (設定・公開)
      let uiStep;
      if (currentStep <= 2) {
        uiStep = 1;
      } else if (currentStep <= 4) {
        uiStep = 2;
      } else {
        uiStep = 3;
      }
      
      console.log('📊 [DEBUG] Mapping step', currentStep, 'to UI step', uiStep);
      
      const steps = [
        document.getElementById('step-1-indicator'),
        document.getElementById('step-2-indicator'),
        document.getElementById('step-3-indicator')
      ];

      steps.forEach((step, index) => {
        if (!step) return;
        const stepNumber = index + 1;
        const circle = step.querySelector('div');
        const text = step.querySelector('span');

        if (stepNumber < uiStep) {
          // 完了したステップ
          circle.className = 'w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all';
          text.classList.remove('text-gray-500');
          text.classList.add('text-gray-300');
        } else if (stepNumber === uiStep) {
          // 現在のステップ
          circle.className = 'w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all ring-2 ring-blue-400 ring-offset-2 ring-offset-gray-800';
          text.classList.remove('text-gray-500');
          text.classList.add('text-white', 'font-semibold');
        } else {
          // 未完了のステップ
          circle.className = 'w-6 h-6 bg-gray-600 text-gray-400 rounded-full flex items-center justify-center font-bold text-xs transition-all';
          text.classList.remove('text-white', 'font-semibold');
          text.classList.add('text-gray-500');
        }
      });
    }

    /**
     * ステップに応じた次のアクションボタンのテキストを取得
     * @param {number} setupStep - 現在のセットアップステップ (1-6)
     * @returns {string} ボタンテキスト
     */
    function getActionButtonText(setupStep) {
      switch (setupStep) {
        case 1:
          return 'データ準備を開始';
        case 2:
          return 'リソース作成を確認';
        case 3:
          return 'シートを選択';
        case 4:
          return '列設定に進む';
        case 5:
          return 'プレビューを確認';
        default:
          return '次へ';
      }
    }

    /**
     * ステップに応じた次のアクションを実行
     * @param {number} setupStep - 現在のセットアップステップ (1-6)
     */
    function executeNextAction(setupStep) {
      console.log('🎬 [DEBUG] executeNextAction called for step:', setupStep);
      
      switch (setupStep) {
        case 1:
          // アカウント作成完了 -> データ準備を開始
          triggerDataPreparation();
          break;
        case 2:
          // データ準備中 -> 状況を確認して次へ
          checkResourceCreationStatus();
          break;
        case 3:
          // データ準備完了 -> シート選択にスクロール
          scrollToSheetSelection();
          break;
        case 4:
          // シート選択完了 -> 列設定にスクロール
          scrollToColumnConfig();
          break;
        case 5:
          // 列設定完了 -> プレビュー/公開設定にスクロール
          scrollToPublishConfig();
          break;
        default:
          console.log('不明なステップです:', setupStep);
      }
    }

    /**
     * データ準備を開始する
     */
    function triggerDataPreparation() {
      console.log('🚀 Starting data preparation...');
      // ボード作成ボタンをクリック
      const createBoardBtn = document.getElementById('create-board-btn');
      if (createBoardBtn && !createBoardBtn.disabled) {
        createBoardBtn.click();
      } else {
        console.log('Create board button not available');
        // 代替: 直接関数を呼び出し
        if (typeof createBoard === 'function') {
          createBoard();
        }
      }
    }

    /**
     * リソース作成状況を確認する
     */
    function checkResourceCreationStatus() {
      console.log('🔍 Checking resource creation status...');
      // 状況更新のためにloadStatusを強制リフレッシュで再実行
      loadStatus(true);
    }

    /**
     * シート選択セクションにスクロール
     */
    function scrollToSheetSelection() {
      const sheetSection = document.getElementById('sheet-selection-section');
      if (sheetSection) {
        sheetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // 少し遅延してからシート選択ドロップダウンにフォーカス
        setTimeout(() => {
          const sheetSelect = document.getElementById('sheet-select');
          if (sheetSelect) {
            sheetSelect.focus();
          }
        }, 500);
      }
    }

    /**
     * 列設定セクションにスクロール
     */
    function scrollToColumnConfig() {
      const configSection = document.getElementById('config-section');
      if (configSection) {
        configSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    /**
     * 公開設定セクションにスクロール
     */
    function scrollToPublishConfig() {
      const configSection = document.getElementById('config-section');
      if (configSection) {
        configSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // 公開ボタンを強調
        setTimeout(() => {
          const publishBtn = document.getElementById('publish-btn');
          if (publishBtn) {
            publishBtn.focus();
            publishBtn.classList.add('ring-2', 'ring-blue-400');
          }
        }, 500);
      }
    }

    /**
     * セクションの表示/非表示を6ステップシステムに応じて制御する
     * @param {number} currentStep - 現在のステップ番号 (1-6)
     */
    function updateSectionVisibility(currentStep) {
      console.log('📊 [DEBUG] updateSectionVisibility called with currentStep:', currentStep);
      
      const dataSetupSection = document.getElementById('data-setup-section');
      const sheetSelectionSection = document.getElementById('sheet-selection-section');
      const configSection = document.getElementById('config-section');
      
      // デフォルトで全セクションを表示
      if (dataSetupSection) dataSetupSection.style.display = 'block';
      if (sheetSelectionSection) sheetSelectionSection.style.display = 'block';
      if (configSection) configSection.style.display = 'block';
      
      // ステップに応じてセクションの強調表示と操作性を制御
      switch (currentStep) {
        case 1:
        case 2:
          // データ準備段階 - データセットアップセクションを強調
          if (dataSetupSection) {
            dataSetupSection.style.opacity = '1';
            dataSetupSection.style.transform = 'scale(1)';
          }
          if (sheetSelectionSection) {
            sheetSelectionSection.style.opacity = '0.6';
            sheetSelectionSection.style.pointerEvents = 'none';
          }
          if (configSection) {
            configSection.style.opacity = '0.6';
            configSection.style.pointerEvents = 'none';
          }
          break;
          
        case 3:
        case 4:
          // データ投入・シート選択段階 - シート選択セクションを強調
          if (dataSetupSection) {
            dataSetupSection.style.opacity = '0.8';
          }
          if (sheetSelectionSection) {
            sheetSelectionSection.style.opacity = '1';
            sheetSelectionSection.style.pointerEvents = 'auto';
            sheetSelectionSection.style.transform = 'scale(1)';
          }
          if (configSection) {
            configSection.style.opacity = '0.6';
            configSection.style.pointerEvents = 'none';
          }
          break;
          
        case 5:
        case 6:
          // プレビュー・公開段階 - 設定セクションを強調
          if (dataSetupSection) {
            dataSetupSection.style.opacity = '0.8';
          }
          if (sheetSelectionSection) {
            sheetSelectionSection.style.opacity = '0.8';
          }
          if (configSection) {
            configSection.style.opacity = '1';
            configSection.style.pointerEvents = 'auto';
            configSection.style.transform = 'scale(1)';
          }
          break;
          
        default:
          // 全セクション有効
          [dataSetupSection, sheetSelectionSection, configSection].forEach(section => {
            if (section) {
              section.style.opacity = '1';
              section.style.pointerEvents = 'auto';
              section.style.transform = 'scale(1)';
            }
          });
      }
    }

    /**
     * シート選択のドロップダウンを生成・更新する
     * @param {Array<string>} sheetNames - シート名の配列
     * @param {string} activeSheetName - 現在アクティブなシート名
     */
    function populateSheetSelect(sheetNames, activeSheetName) {
      const select = document.getElementById('sheet-select');
      if (!select) {
        console.warn('populateSheetSelect: sheet-select element not found.');
        return;
      }

      console.log('populateSheetSelect: Received sheetNames:', sheetNames);
      console.log('populateSheetSelect: Received activeSheetName:', activeSheetName);

      // ドロップダウンをクリア
      select.innerHTML = '<option value="">-- シートを選択 --</option>';
      console.log('populateSheetSelect: After clearing innerHTML:', select.innerHTML);

      if (sheetNames && sheetNames.length > 0) {
        sheetNames.forEach(sheet => {
          const option = document.createElement('option');
          option.value = sheet.name; // sheetオブジェクトからnameプロパティを使用
          option.textContent = sheet.name; // sheetオブジェクトからnameプロパティを使用
          select.appendChild(option);
        });
        select.disabled = false;
        console.log('populateSheetSelect: After adding options, innerHTML:', select.innerHTML);
      } else if (activeSheetName) {
        // sheetNamesがない場合でも、activeSheetNameがあれば追加
        console.log('populateSheetSelect: No sheetNames but activeSheetName exists, adding it:', activeSheetName);
        const option = document.createElement('option');
        option.value = activeSheetName;
        option.textContent = activeSheetName;
        select.appendChild(option);
        select.disabled = false;
        console.log('populateSheetSelect: Added activeSheetName as option:', activeSheetName);
      } else {
        select.innerHTML = '<option value="">利用可能なシートがありません</option>';
        select.disabled = true;
        console.log('populateSheetSelect: No sheets available, innerHTML:', select.innerHTML);
      }
      
      // アクティブなシート名が渡された場合はそれを優先
      if (activeSheetName) {
        select.value = activeSheetName;
        appState.selectedSheet = activeSheetName;
        console.log('populateSheetSelect: Set select.value to activeSheetName:', activeSheetName);
      } else if (appState.selectedSheet) {
        // 未公開状態などでactiveSheetNameが無い場合は現在の選択を維持
        select.value = appState.selectedSheet;
        console.log('populateSheetSelect: Keep existing selectedSheet:', appState.selectedSheet);
      } else {
        select.value = '';
        console.log('populateSheetSelect: Reset select.value to empty');
      }
      
      // 選択状態に応じてUIを更新
      appState.selectedSheet = select.value;
      console.log('populateSheetSelect: Final selectedSheet:', appState.selectedSheet);
      updateUIForSelectedSheet();
    }

    /**
     * シートが選択されたときのUI更新
     */
    function updateUIForSelectedSheet() {
      const configArea = document.getElementById('config-area');
      const placeholder = document.getElementById('config-placeholder');
      
      if (appState.selectedSheet) {
        configArea.classList.remove('hidden');
        placeholder.classList.add('hidden');
        // AI判定ボタンを有効化
        const reguessBtn = document.getElementById('reguess-headers-btn');
        if (reguessBtn) reguessBtn.disabled = false;
      } else {
        configArea.classList.add('hidden');
        placeholder.classList.remove('hidden');
        const reguessBtn = document.getElementById('reguess-headers-btn');
        if (reguessBtn) reguessBtn.disabled = true;
      }
    }

    /**
     * 選択されたシートの設定を読み込む
     */
    function loadConfigForSelected() {
      if (!appState.selectedSheet) return;
      
      console.log('🔎 [DEBUG] Load config check:', {
        selectedSheet: appState.selectedSheet,
        currentActiveSheet: appState.currentStatus.activeSheetName,
        appPublished: appState.currentStatus.isPublished,
        publishedSheetName: appState.currentStatus.publishedSheetName
      });

      // 公開中かつ選択中のシートが公開シートと同じ場合は、UIをロックする
      if (appState.currentStatus.isPublished && appState.selectedSheet === appState.currentStatus.publishedSheetName) {
        setLoading(true, '公開中の設定を読み込んでいます...');
      } else {
        setLoading(true, '列情報を読み込んでいます...');
      }

      runGasWithUserId('getSheetDetails', appState.currentStatus.userInfo.spreadsheetId, appState.selectedSheet)
        .then(handleSheetDetailsSuccess)
        .catch(handleSheetDetailsError);
    }

    /**
     * getSheetDetails成功時のハンドラ
     */
    function handleSheetDetailsSuccess(details) {
      populateHeaderOptions(details.allHeaders);
      
      // 既存設定と推測設定をマージ
      const configToUse = { 
        ...details.guessedConfig, 
        ...details.existingConfig,
        showNames: details.existingConfig?.showNames || false,
        showCounts: details.existingConfig?.showCounts !== undefined ? details.existingConfig.showCounts : false
      };
      
      populateConfig(configToUse);
      updateStepIndicators(3);
      setLoading(false);
    }

    /**
     * getSheetDetails失敗時のハンドラ
     */
    function handleSheetDetailsError(error) {
      handleError(error, 'loadConfig');
      clearConfigFields();
      setLoading(false);
    }

    // ======= Utility functions for column configuration =======
    /**
     * 列選択用ドロップダウンにヘッダー一覧を設定する
     * @param {Array<string>} headers - スプレッドシートの列ヘッダー
     */
    function populateHeaderOptions(headers) {
      var selects = [elements.opinionHeader, elements.reasonHeader, elements.nameHeader, elements.classHeader];
      selects.forEach(function(sel) {
        sel.replaceChildren();
        var opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '-- 選択してください --';
        sel.appendChild(opt);
        headers.forEach(function(h) {
          var option = document.createElement('option');
          option.value = h;
          option.textContent = h;
          sel.appendChild(option);
        });
      });
    }

    /**
     * 設定オブジェクトをUIに反映する
     * @param {object} cfg - 列設定と表示オプション
     */
    function populateConfig(cfg) {
      if (!elements.opinionHeader || !elements.reasonHeader || !elements.nameHeader || !elements.classHeader) {
        console.error('設定用のUI要素が見つかりません。');
        return;
      }

      elements.opinionHeader.value = cfg.opinionHeader || '';
      elements.reasonHeader.value  = cfg.reasonHeader || '';
      elements.nameHeader.value    = cfg.nameHeader || '';
      elements.classHeader.value   = cfg.classHeader || '';

      var showNamesCb = document.getElementById('showNames');
      var showCountsCb = document.getElementById('showCounts');
      if (showNamesCb) showNamesCb.checked = !!cfg.showNames;
      if (showCountsCb) showCountsCb.checked = cfg.showCounts !== undefined ? cfg.showCounts : false;

      updateConfigButtons();
    }

    /**
     * 列設定UIを初期状態に戻す
     */
    function clearConfigFields() {
      [elements.opinionHeader, elements.reasonHeader, elements.nameHeader, elements.classHeader].forEach(function(sel) {
        sel.replaceChildren();
        var opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '-- 選択してください --';
        sel.appendChild(opt);
        sel.value = '';
      });
      updateConfigButtons();
    }

    /**
     * AIによる列判定を実行
     */
    function runHeaderGuessing() {
      if (!appState.selectedSheet) {
        showMessage('シートを選択してください。', 'warning');
        return;
      }
      setLoading(true, 'AI搭載高精度列判定システムが分析中...');
      
      runGasWithUserId('getSheetDetails', appState.currentStatus.userInfo.spreadsheetId, appState.selectedSheet)
        .then(function(details) {
          const configToUse = {
            ...details.guessedConfig,
            ...details.existingConfig,
            showNames: details.existingConfig?.showNames || false,
            showCounts: details.existingConfig?.showCounts !== undefined ? details.existingConfig.showCounts : false
          };
          populateHeaderOptions(details.allHeaders);
          populateConfig(configToUse);
          showMessage('🤖 AIによる列判定が完了しました。', 'info');
          setLoading(false);
        })
        .catch(function(error) {
          handleError(error, 'runHeaderGuessing');
          setLoading(false);
        });
    }

    /**
     * 設定オブジェクトを現在のUIから構築する
     */
    function buildConfigObject() {
      const showNamesCheckbox = document.getElementById('showNames');
      const showCountsCheckbox = document.getElementById('showCounts');
      
      return {
        opinionHeader: document.getElementById('opinionHeader').value,
        reasonHeader: document.getElementById('reasonHeader').value,
        nameHeader: document.getElementById('nameHeader').value,
        classHeader: document.getElementById('classHeader').value,
        showNames: showNamesCheckbox ? showNamesCheckbox.checked : false,
        showCounts: showCountsCheckbox ? showCountsCheckbox.checked : false,
      };
    }

    /**
     * 設定が有効かどうかを検証する
     */
    function validateConfig() {
      const opinionHeader = document.getElementById('opinionHeader');
      if (!opinionHeader) {
        console.warn('opinionHeader element not found');
        return false;
      }
      const isValid = !!opinionHeader.value;
      console.log('validateConfig:', opinionHeader.value, 'isValid:', isValid);
      return isValid;
    }

    /**
     * 設定ボタンの状態を更新する
     */
    function updateConfigButtons() {
      const saveBtn = document.getElementById('save-publish-btn');
      if (saveBtn) {
        const isValid = validateConfig();
        saveBtn.disabled = !isValid;
        console.log('updateConfigButtons: saveBtn.disabled =', saveBtn.disabled);
      } else {
        console.warn('save-publish-btn element not found');
      }
    }

    /**
     * 入力フィールド変更時に即座にボタン状態を更新する
     */
    function setupRealtimeValidation() {
      const fields = ['opinionHeader', 'reasonHeader', 'nameHeader', 'classHeader'];
      fields.forEach(function(id) {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', updateConfigButtons);
        }
      });
    }

    /**
     *【新しい推奨】設定を保存し、ボードを公開する
     */
    function saveAndPublish() {
      console.log('💾 saveAndPublish called');
      
      if (!validateConfig()) {
        console.warn('⚠️ Validation failed');
        showMessage('必須項目（回答データ列）が選択されていません。', 'error');
        return;
      }

      console.log('✅ Validation passed, starting save and publish...');
      setLoading(true, '設定を保存し、ボードを公開しています...');
      const config = buildConfigObject();
      console.log('📜 Config object:', config);

      // マルチテナント対応: 設定データをオブジェクトとして送信
      const settingsData = {
        selectedSheet: appState.selectedSheet,
        opinionHeader: config.opinionHeader,
        reasonHeader: config.reasonHeader,
        nameHeader: config.nameHeader,
        classHeader: config.classHeader,
        showNames: config.showNames,
        showCounts: config.showCounts,
        classChoices: config.classChoices
      };
      
      runGasWithUserId('saveAndPublish', settingsData)
        .then(function(result) {
          setLoading(false);
          if (result && result.status === 'success') {
            showMessage('設定が保存され、ボードが公開されました！', 'success');
            // マルチテナント版は latestStatus を含むので、それでUIを更新
            if (result.latestStatus) {
              updateUIWithNewStatus(result.latestStatus);
              console.log('✅ saveAndPublish success - UI updated with latest status');
            } else {
              loadStatus(true);
            }
          } else {
            showMessage(result.message || '設定の保存に失敗しました', 'error');
          }
        })
        .catch(function(error) {
          setLoading(false);
          console.error('❌  saveAndPublish failed, falling back to legacy:', error);
          // フォールバック: 従来の方法
          runGasWithUserId('saveAndPublish', appState.selectedSheet, config)
            .then(function(status) {
              setLoading(false);
              showMessage('設定が保存され、ボードが公開されました！', 'success');
              if (status && typeof status === 'object') {
                updateUIWithNewStatus(status);
                console.log('✅ saveAndPublish legacy fallback success');
              } else {
                loadStatus(true);
              }
            })
            .catch(function(legacyError) {
              setLoading(false);
              handleError(legacyError, 'saveAndPublish');
            });
        });
    }

    function saveConfig() {
      // この関数は古いので、新しい saveAndPublish に処理を委任するか、
      // もし下書き保存機能が必要な場合は saveDraftConfig を呼び出すようにします。
      // 今回はUIから直接呼び出されないため、念の為残しますが、基本的には使いません。
      console.warn('古いsaveConfig関数が呼び出されました。新しいsaveAndPublishの使用を検討してください。');
      saveAndPublish(); 
    }


    /**
     * ボードの公開を停止する
     */
    function unpublishBoard() {
      console.log('🚫 unpublishBoard called');
      setLoading(true, 'ボードの公開を停止中...');
      console.log('📤 Calling runGasWithUserId(clearActiveSheet)');
      runGasWithUserId('clearActiveSheet')
        .then(function(response) {
          console.log('公開停止レスポンス:', response);
          showMessage(response.message || '✅ 回答ボードの公開を停止しました。', 'success');
          setLoading(false);
          // サーバーレスポンスの最新ステータスでUIを直接更新（追加のAPI呼び出し不要）
          if (response && typeof response === 'object' && response.success) {
            updateUIWithNewStatus(response);
            console.log('✅ unpublishBoard success - UI updated with response status');
          } else {
            // フォールバック: レスポンスが期待された形式でない場合のみloadStatus呼び出し
            loadStatus(true);
          }
        })
        .catch(function(error) {
          handleError(error, 'unpublishBoard');
          setLoading(false);
        });
    }

    /**
     * 新しいボードを作成する
     */
      function createBoard() {
        // この関数は現在使用されていません。既存ユーザーはクイックスタートを使用してください。
        showMessage('既存ユーザーは「新しいフォームを作成」ボタンをご利用ください。', 'info');
      }
    
    /**
     * 新規フォームを作成する
     */
    function createAdditionalForm() {
        showFormConfigModal();
    }

    /**
     * フォーム設定モーダルを表示
     */
    function showFormConfigModal() {
        const modal = document.getElementById('form-config-modal');
        if (modal) {
            modal.classList.remove('hidden');

            // サーバーから質問テンプレートを読み込み
            initQuestionConfig();
        }
    }

    /**
     * 管理パネル用の設定初期化（プレースホルダーのみ、デフォルト値は設定しない）
     */
    async function initQuestionConfig() {
        try {
            // 管理パネルではプレースホルダーのみ表示し、デフォルト値は設定しない
            // 保存されたクラス選択肢のみ読み込む
            loadSavedClassChoices();
            
        } catch (error) {
            console.error('Failed to initialize question config:', error);
            // エラー時もクラス選択肢の読み込みを試行
            loadSavedClassChoices();
        }
    }

    /**
     * 保存されたクラス選択肢を読み込み
     */
    function loadSavedClassChoices() {
        runGasWithUserId('getSavedClassChoices')
            .then(function(result) {
                if (result.status === 'success' && result.classChoices) {
                    const classChoicesTextarea = document.getElementById('class-choices');
                    if (classChoicesTextarea) {
                        classChoicesTextarea.value = result.classChoices.join('\n');
                    }
                }
            })
            .catch(function(error) {
                console.warn('保存されたクラス選択肢の読み込みに失敗:', error.message);
            });
    }

    /**
     * フォーム設定モーダルを非表示
     */
    function hideFormConfigModal() {
        const modal = document.getElementById('form-config-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    /**
     * フォーム設定に基づいてフォームを作成
     * Promiseベースの非同期処理でエラーハンドリングを改善
     */
    async function createFormWithConfig() {
        const customMainQuestion = document.getElementById('custom-main-question').value.trim();
        const mainQuestionType = document.getElementById('main-question-type').value;
        const mainQuestionChoices = document.getElementById('main-question-choices').value.split('\n').filter(choice => choice.trim());
        const includeOthersOption = document.getElementById('include-others-option').checked;
        const enableClassSelection = document.getElementById('enable-class-selection').checked;
        const classChoices = enableClassSelection ? document.getElementById('class-choices').value.split('\n').filter(choice => choice.trim()) : [];

        // バリデーション（タイトルは自動生成のため削除）

        if (!customMainQuestion) {
            showMessage('質問内容を入力してください。', 'warning');
            document.getElementById('custom-main-question').focus();
            return;
        }

        if ((mainQuestionType === 'multiple' || mainQuestionType === 'choice') && mainQuestionChoices.length === 0) {
            showMessage('選択肢を入力してください。', 'warning');
            document.getElementById('main-question-choices').focus();
            return;
        }

        const config = {
            // formTitle is now auto-generated in backend
            opinionHeader: customMainQuestion,  // mainQuestion を opinionHeader に統一
            questionType: mainQuestionType,
            choices: mainQuestionChoices,
            includeOthers: includeOthersOption,
            enableClass: enableClassSelection,
            classChoices: classChoices
        };

        hideFormConfigModal();
        
        try {
            // プログレスバーで段階的な進行状況を表示
            showProgressStep(1, 5, 'フォームを作成中...');

            // タイムアウト付きでフォーム作成を実行
            const result = await withTimeout(
                runGasWithUserId('createCustomFormUI', config),
                300000,  // 5分のタイムアウト
                'フォーム作成がタイムアウトしました。しばらく待ってから再試行してください。'
            );

            if (result.status !== 'success') {
                throw new Error(result.message || 'フォーム作成に失敗しました。');
            }

            showProgressStep(2, 5, 'フォーム作成完了！設定を保存中...');
            
            // 自動設定保存と公開処理
            if (result.autoPublishReady && result.sheetName) {
                try {
                    const autoResult = await withTimeout(
                        runGasWithUserId('autoSaveAndPublishAfterFormCreation', result.sheetName, result),
                        180000,  // 3分のタイムアウト
                        '設定保存・公開処理がタイムアウトしました。'
                    );
                    
                    showProgressStep(3, 5, '設定保存完了！公開中...');
                    
                    if (autoResult.status === 'success') {
                        showProgressStep(4, 5, '公開完了！UIを更新中...');
                        showProgressStep(5, 5, '全て完了！');
                        
                        await completeFormCreationProcess(result, '✅ フォーム作成、設定保存、公開が自動で完了しました！');
                    } else {
                        throw new Error(autoResult.message || '自動公開に失敗しました');
                    }
                } catch (autoError) {
                    console.warn('⚠️ 自動公開処理でエラーが発生しました:', autoError.message);
                    // フォールバック: 手動設定モードで続行
                    await handleManualFormSetup(result);
                }
            } else {
                // フォールバック: 手動設定
                await handleManualFormSetup(result);
            }
            
            // クラス選択肢をデータベースに保存（有効な場合）
            if (enableClassSelection && classChoices.length > 0) {
                // 非同期でクラス選択肢を保存（エラーは無視）
                saveClassChoicesToDatabase(classChoices).catch(error => {
                    console.warn('クラス選択肢の保存に失敗:', error.message);
                });
            }

        } catch (error) {
            hideProgressBar();
            
            // ユーザーデータ更新失敗の場合は特別な処理
            if (error.message && error.message.includes('ユーザーデータの更新に失敗しました')) {
                console.warn('⚠️ フォーム作成は成功しましたが、ユーザーデータの更新に失敗しました:', error.message);
                showMessage('⚠️ フォーム作成は完了しましたが、一部のユーザーデータ更新に失敗しました。フォームは正常に動作します。', 'warning');
                
                // UIを更新して続行
                try {
                    await loadStatus();
                } catch (statusError) {
                    console.error('ステータス更新に失敗:', statusError);
                }
                return;
            }
            
            handleError(error, 'createFormWithConfig', 'フォーム作成処理でエラーが発生しました。');
        }
    }

    /**
     * フォーム作成完了処理を実行
     * @param {Object} result - フォーム作成結果
     * @param {string} successMessage - 成功メッセージ
     */
    async function completeFormCreationProcess(result, successMessage) {
        return new Promise((resolve) => {
            setTimeout(async () => {
                try {
                    hideProgressBar();
                    showMessage(successMessage, 'success');
                    
                    // フォーム編集ページを開く
                    if (result.editFormUrl) {
                        window.open(result.editFormUrl, '_blank');
                    } else if (result.formUrl) {
                        const editUrl = result.formUrl.replace('/viewform', '/edit');
                        window.open(editUrl, '_blank');
                    }
                    
                    // UI を非同期で更新（エラーハンドリング付き）
                    await updateUIAfterFormCreation(result);
                    resolve();
                } catch (error) {
                    console.warn('⚠️ フォーム作成完了処理でエラー:', error);
                    resolve(); // エラーでも処理は完了とみなす
                }
            }, 1000);
        });
    }

    /**
     * 手動フォーム設定モードの処理
     * @param {Object} result - フォーム作成結果
     */
    async function handleManualFormSetup(result) {
        showProgressStep(5, 5, 'フォーム作成完了');
        return completeFormCreationProcess(result, '✅ フォームが作成されました！設定タブで設定を行ってください。');
    }

    /**
     * フォーム作成後のUI更新処理
     * @param {Object} result - フォーム作成結果
     */
    async function updateUIAfterFormCreation(result) {
        try {
            console.log('🚀 [DEBUG] フォーム作成後UI更新開始:', { 
                hasFormUrl: !!result.formUrl, 
                hasEditFormUrl: !!result.editFormUrl 
            });
            
            // 🔥 強力なキャッシュクリア: 複数の依存関係をクリア
            cacheManager.invalidateDependents('form_creation');
            cacheManager.invalidateDependents('user_data_change');
            cacheManager.invalidateDependents('config_change');
            
            // 🔥 追加: 個別キャッシュも強制クリア
            cacheManager.invalidate('status');
            cacheManager.invalidate('formUrls');
            cacheManager.invalidate('sheetDetails');
            
            console.log('🗑️ [DEBUG] 全キャッシュクリア完了');
            
            // 🔄 段階的UI更新: まず結果データで即座にUI更新
            if (result.formUrl) {
                console.log('⚡ [DEBUG] 即座フォールバックUI更新実行');
                updateFormUrlSection({
                    formUrl: result.formUrl, 
                    editFormUrl: result.editFormUrl,
                    customFormInfo: result.customFormInfo || null
                });
            }
            
            // 🔄 バックエンドからの最新データで確実にUI更新
            try {
                console.log('📡 [DEBUG] バックエンドからステータス再取得開始');
                
                // 🕐 少し待ってからステータスをリロード（DBの反映を確実にするため）
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const newStatus = await withTimeout(loadStatus(true), 30000, 'ステータス更新がタイムアウトしました');
                
                console.log('✅ [DEBUG] ステータス再取得成功:', {
                    hasFormUrl: !!newStatus.formUrl,
                    hasEditFormUrl: !!newStatus.editFormUrl,
                    hasUserInfo: !!newStatus.userInfo,
                    hasConfigJson: !!(newStatus.userInfo && newStatus.userInfo.configJson),
                    formUrl: newStatus.formUrl
                });
                
                // 🔄 最終UI更新: 最新データでUI全体を更新
                if (newStatus.formUrl || (newStatus.userInfo && newStatus.userInfo.configJson)) {
                    console.log('✅ [DEBUG] 最新データでUI最終更新実行');
                    updateFormUrlSection(newStatus);
                } else {
                    console.warn('⚠️ [DEBUG] 最新データにフォームURLなし、結果データを維持');
                }
                
            } catch (statusError) {
                console.warn('⚠️ [DEBUG] バックエンドステータス取得失敗:', statusError);
                console.log('🔄 [DEBUG] フォールバックとして結果データのみでUI更新');
            }
            
        } catch (error) {
            console.error('❌ [DEBUG] UI更新処理で致命的エラー:', error);
            // 最後の手段: 結果データで強制更新
            if (result.formUrl) {
                console.log('🆘 [DEBUG] 緊急フォールバック: 結果データで強制UI更新');
                updateFormUrlSection({formUrl: result.formUrl, editFormUrl: result.editFormUrl});
            }
        }
    }

    /**
     * タイムアウト付きのPromise実行
     * @param {Promise} promise - 実行するPromise
     * @param {number} timeoutMs - タイムアウト時間（ミリ秒）
     * @param {string} timeoutMessage - タイムアウト時のエラーメッセージ
     * @returns {Promise} タイムアウト付きのPromise
     */
    function withTimeout(promise, timeoutMs, timeoutMessage) {
        const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => {
                reject(new Error(timeoutMessage || 'タイムアウトが発生しました'));
            }, timeoutMs);
        });

        return Promise.race([promise, timeoutPromise]);
    }

    /**
     * クラス選択肢をデータベースに保存
     * @param {Array} classChoices - クラス選択肢の配列
     * @returns {Promise} 保存処理のPromise
     */
    async function saveClassChoicesToDatabase(classChoices) {
        try {
            const result = await withTimeout(
                runGasWithUserId('saveClassChoices', classChoices),
                30000,  // 30秒のタイムアウト
                'クラス選択肢の保存がタイムアウトしました'
            );
            console.log('✅ クラス選択肢の保存が完了しました');
            return result;
        } catch (error) {
            console.warn('⚠️ クラス選択肢の保存に失敗:', error.message);
            throw error;
        }
    }

    /**
     * 外部リソース（スプレッドシート or フォーム）を追加する
     */
    async function addResource() {
      const url = document.getElementById('resource-url-input').value;
      if (!url) {
        showMessage('URLを入力してください。', 'warning');
        return;
      }

      setLoading(true, 'リソースを追加しています...');
      
      try {
        const result = await withTimeout(
          runGasWithUserId('addSpreadsheetUrl', url),
          120000,  // 2分のタイムアウト
          'リソース追加処理がタイムアウトしました。'
        );
        
        if (result.status === 'success') {
          showMessage(result.message, 'success');
          await loadStatus(true);
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        handleError(error, 'addResource', 'リソースの追加に失敗しました。');
      } finally {
        setLoading(false);
      }
    }
    
    /**
     * データベースのスプレッドシートを開く
     */
    function openDatabaseSpreadsheet() {
        if (appState.currentSpreadsheetUrl) {
            window.open(appState.currentSpreadsheetUrl, '_blank');
        } else {
            showMessage('スプレッドシートのURLが見つかりません。', 'warning');
        }
    }

    /**
     * 連携しているフォームを開く
     */
    function openForm() {
        if (appState.currentStatus && appState.currentStatus.formUrl) {
            window.open(appState.currentStatus.formUrl, '_blank');
        } else {
            showMessage('連携しているフォームが見つかりません。', 'warning');
        }
    }

    /**
     * ボードのURLをクリップボードにコピーする
     */
    function copyBoardUrl() {
        const urlInput = document.getElementById('board-url');
        if (urlInput) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(urlInput.value);
                } else {
                    urlInput.select();
                    document.execCommand('copy');
                }
                showMessage('URLをコピーしました', 'success');
            } catch (error) {
                showMessage('コピーに失敗しました', 'error');
            }
        }
    }
    
    /**
     * システム状況を定期的に更新
     */
    // スマートポーリング実装
    let lastUserActivity = Date.now();
    let currentPollInterval = 5 * 60 * 1000; // 開始は5分間隔
    let statusPollTimer = null;
    
    function updateUserActivity() {
      lastUserActivity = Date.now();
      // ユーザーアクティビティがあった場合、ポーリング間隔をリセット
      if (currentPollInterval > 2 * 60 * 1000) {
        currentPollInterval = 2 * 60 * 1000; // 2分に短縮
        restartStatusPolling();
      }
    }
    
    function getOptimalPollInterval() {
      const timeSinceActivity = Date.now() - lastUserActivity;
      if (timeSinceActivity < 5 * 60 * 1000) {
        return 2 * 60 * 1000; // 5分以内のアクティビティ: 2分間隔
      } else if (timeSinceActivity < 15 * 60 * 1000) {
        return 5 * 60 * 1000; // 15分以内: 5分間隔
      } else {
        return 10 * 60 * 1000; // 15分以上: 10分間隔
      }
    }
    
    function restartStatusPolling() {
      if (statusPollTimer) {
        clearInterval(statusPollTimer);
      }
      currentPollInterval = getOptimalPollInterval();
      startSystemStatusUpdate();
    }
    
    function startSystemStatusUpdate() {
      statusPollTimer = setInterval(function() {
        // UIが非表示の時は更新しない
        if (document.hidden) return;
        
        // 現在のポーリング間隔を確認し、必要に応じて調整
        const optimalInterval = getOptimalPollInterval();
        if (optimalInterval !== currentPollInterval) {
          restartStatusPolling();
          return;
        }
        
        // キャッシュされたステータスを取得
        getCachedStatus(false)
          .then(function(status) {
            // 変更があった場合のみUIを更新
            if (JSON.stringify(status) !== JSON.stringify(appState.currentStatus)) {
              updateUIWithNewStatus(status);
              console.log('📊 システム状態が更新されました');
            }
          })
          .catch(function(error) {
            // エラーはコンソールにのみ出力
            console.warn('Silent status update failed:', error.message);
          });
      }, currentPollInterval);
      
      console.log(`⏰ ステータスポーリング開始: ${currentPollInterval / 1000}秒間隔`);
    }
    
    // ユーザーアクティビティを監視
    document.addEventListener('click', updateUserActivity);
    document.addEventListener('keypress', updateUserActivity);
    document.addEventListener('scroll', updateUserActivity);

    function openAppSetupPage() {
      // アプリ設定ページを新しいタブで開く
      runGasWithUserId('getWebAppUrlCached')
        .then(function(webAppUrl) {
          const setupUrl = webAppUrl + '?setup=true&mode=appsetup';
          window.open(setupUrl, '_blank');
        })
        .catch(function(error) {
          console.error('WebApp URL取得エラー:', error);
          // フォールバック: 現在のURLを使用
          const currentUrl = window.location.href.split('?')[0];
          const setupUrl = currentUrl + '?setup=true&mode=appsetup';
          window.open(setupUrl, '_blank');
        });
    }
    
    function switchToAnotherAccount() {
      // 別のアカウントでログインするために管理パネルを再読み込み
      if (window.sharedUtilities && window.sharedUtilities.navigation) {
        window.sharedUtilities.navigation.safeNavigate('?page=AdminPanel&forceAuth=true', {
          fallbackMessage: '別のアカウントでログイン中...',
          method: 'auto'
        });
      } else {
        window.location.href = '?page=AdminPanel&forceAuth=true';
      }
    }
    
    function deleteAllResources() {
      // リソース連携解除の実行（フォーム・スプレッドシートは保持）
      setLoading(true, 'リソース連携を解除中...');
      
      // 改善されたリソース連携解除処理
      runGasWithUserId('disconnectResources')
        .then(function(response) {
          console.log('リソース連携解除レスポンス:', response);
          
          if (response && response.status === 'success') {
            showMessage(response.message, 'success');
            // UIをリフレッシュ
            loadStatus(true);
          } else {
            throw new Error(response?.message || '不明なエラーが発生しました。');
          }
        })
        .catch(function(error) {
          console.error('リソース連携解除エラー:', error);
          handleError(error, 'リソース連携解除');
        })
        .finally(function() {
          setLoading(false);
        });
    }

  </script>

  <!-- フォーム設定モーダル -->
  <div id="form-config-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="glass-panel rounded-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-8">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-cyan-400">新しいフォームを作成</h3>
          <button type="button" id="form-config-close" class="text-gray-400 hover:text-white transition-colors" title="閉じる">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <div class="space-y-6">
          <!-- ステップ0: フォームタイトルの設定 -->
          <!-- フォームタイトルは自動生成されるため、入力フィールドを削除 -->

          <!-- ステップ1: 問題文の入力 -->
          <div class="glass-panel bg-blue-500/5 border border-blue-400/20 rounded-lg p-4">
            <div class="flex items-center gap-2 mb-3">
              <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">1</div>
              <h4 class="text-lg font-semibold text-blue-400">質問内容を入力</h4>
              <span class="text-xs text-gray-400 bg-gray-700/50 px-2 py-1 rounded">必須</span>
            </div>
            <textarea 
              id="custom-main-question" 
              rows="3" 
              class="w-full p-3 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white text-sm placeholder-gray-400 focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition-colors" 
              placeholder="例：今日の授業で学んだことの中で、最も印象に残ったことは何ですか？"
              maxlength="500"
            ></textarea>
            <div class="flex justify-between items-center mt-2">
              <p class="text-xs text-gray-400">💡 学習者に表示される質問文を入力してください</p>
              <span class="text-xs text-gray-500" id="question-counter">0/500</span>
            </div>
          </div>

          <!-- ステップ2: 回答方法の選択 -->
          <div class="glass-panel bg-green-500/5 border border-green-400/20 rounded-lg p-4">
            <div class="flex items-center gap-2 mb-3">
              <div class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold">2</div>
              <h4 class="text-lg font-semibold text-green-400">回答方法を選択</h4>
            </div>
            <select id="main-question-type" class="w-full p-3 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white text-sm focus:border-green-400 focus:ring-1 focus:ring-green-400 transition-colors" title="回答方法を選択してください">
              <option value="choice" selected>選択肢（単一選択）</option>
              <option value="multiple">選択肢（複数選択可）</option>
              <option value="text">短文テキスト（1行回答）</option>
            </select>
            <p class="text-xs text-gray-400 mt-2">💡 すべての回答方法で、回答の理由を入力する欄が自動的に追加されます</p>
          </div>

          <!-- 選択肢設定（選択肢タイプの場合） -->
          <div id="main-question-choices-div" class="glass-panel bg-yellow-500/5 border border-yellow-400/20 rounded-lg p-4">
            <div class="flex items-center gap-2 mb-3">
              <div class="w-6 h-6 bg-yellow-500 text-white rounded-full flex items-center justify-center text-sm font-bold">3</div>
              <h4 class="text-lg font-semibold text-yellow-400">選択肢を設定</h4>
            </div>
            <textarea id="main-question-choices" rows="4" class="w-full p-3 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white text-sm placeholder-gray-400 focus:border-yellow-400 focus:ring-1 focus:ring-yellow-400 transition-colors" placeholder="例：&#10;気づいたことがある。&#10;疑問に思うことがある。&#10;もっと知りたいことがある。"></textarea>
            <p class="text-xs text-gray-400 mt-2">💡 学習者が選択できる選択肢を1行に1つずつ入力してください。例のような評価軸や、具体的な選択肢を設定できます。</p>
            
            <div class="mt-4">
              <label class="flex items-center">
                <input type="checkbox" id="include-others-option" class="mr-2 rounded bg-gray-700 border-gray-600 text-yellow-500 focus:ring-yellow-400" checked>
                <span class="text-sm text-gray-300">「その他...」選択肢を追加する</span>
              </label>
              <p class="text-xs text-gray-400 mt-1 ml-6">チェックすると、学習者が自由に回答を入力できる「その他...」オプションが自動的に追加されます</p>
            </div>
          </div>

          <!-- ステップ4: クラス設定（オプション） -->
          <div class="glass-panel bg-purple-500/5 border border-purple-400/20 rounded-lg p-4">
            <div class="flex items-center gap-2 mb-3">
              <div class="w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm font-bold">4</div>
              <h4 class="text-lg font-semibold text-purple-400">クラス設定</h4>
              <span class="text-xs text-gray-400 bg-gray-700/50 px-2 py-1 rounded">オプション</span>
            </div>
            <div class="mb-3">
              <label class="flex items-center">
                <input type="checkbox" id="enable-class-selection" class="mr-2 rounded bg-gray-700 border-gray-600 text-purple-500 focus:ring-purple-400" checked>
                <span class="text-sm text-gray-300">クラス選択を有効にする</span>
              </label>
            </div>
            <div id="class-choices-container">
              <textarea id="class-choices" rows="3" class="w-full p-3 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white text-sm placeholder-gray-400 focus:border-purple-400 focus:ring-1 focus:ring-purple-400 transition-colors" placeholder="例：&#10;クラス1&#10;クラス2&#10;クラス3&#10;クラス4"></textarea>
              <p class="text-xs text-gray-400 mt-2">1行に1つずつクラス名を入力してください</p>
            </div>
          </div>
        </div>

        <div class="flex gap-3 mt-8">
          <button type="button" id="form-config-cancel" class="flex-1 px-6 py-3 bg-gray-600/80 text-gray-200 rounded-lg hover:bg-gray-600 transition-colors font-medium">
            キャンセル
          </button>
          <button type="button" id="form-config-create" class="flex-1 px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-colors font-medium shadow-lg">
            フォーム作成
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- プライバシーモーダル -->
  <div id="privacy-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
    <div class="glass-panel rounded-xl max-w-md w-full mx-4">
      <div class="p-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-white">プライバシーの確認</h3>
        </div>
        
        <div class="mb-6">
          <p class="text-gray-300 leading-relaxed">この操作を実行する前に、プライバシーポリシーを確認してください。</p>
        </div>
        
        <div class="flex gap-3">
          <button type="button" id="privacy-modal-cancel" class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
            キャンセル
          </button>
          <button type="button" id="privacy-modal-continue" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium">
            続行
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- デジタルシティズンシップモーダル -->
  <div id="digital-citizenship-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
    <div class="glass-panel rounded-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-white">デジタル・シティズンシップ指導</h3>
          <button type="button" id="digital-citizenship-modal-close" class="text-gray-400 hover:text-white text-2xl">×</button>
        </div>
        
        <div class="mb-6">
          <p class="text-gray-300 leading-relaxed mb-4">デジタル・シティズンシップに基づく回答ボード指導のポイント：</p>
          <ul class="list-disc pl-5 space-y-2 text-gray-300">
            <li>建設的な意見交換を促進する</li>
            <li>他者の意見を尊重する態度を育む</li>
            <li>情報の信頼性を検証する習慣を身につける</li>
            <li>デジタル環境での適切なコミュニケーションを学ぶ</li>
          </ul>
        </div>
        
        <div class="text-right">
          <button type="button" id="digital-citizenship-modal-close-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
            閉じる
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 使用ガイドモーダル -->
  <div id="usage-guide-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
    <div class="glass-panel rounded-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-white">使用ガイド</h3>
          <button type="button" id="usage-guide-modal-close" class="text-gray-400 hover:text-white text-2xl">×</button>
        </div>
        
        <div class="mb-6">
          <p class="text-gray-300 leading-relaxed mb-4">回答ボードの使用方法：</p>
          <div class="space-y-3 text-gray-300">
            <div class="p-3 bg-gray-700/30 rounded-lg">
              <h4 class="font-medium text-white mb-2">ステップ1: データ準備</h4>
              <p class="text-sm">GoogleフォームまたはスプレッドシートをWorkspace上で自動作成します。</p>
            </div>
            <div class="p-3 bg-gray-700/30 rounded-lg">
              <h4 class="font-medium text-white mb-2">ステップ2: シート選択</h4>
              <p class="text-sm">表示したいシートを選択します。</p>
            </div>
            <div class="p-3 bg-gray-700/30 rounded-lg">
              <h4 class="font-medium text-white mb-2">ステップ3: 設定・公開</h4>
              <p class="text-sm">列設定を行い、回答ボードを公開します。</p>
            </div>
          </div>
        </div>
        
        <div class="text-right">
          <button type="button" id="usage-guide-modal-close-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
            閉じる
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 確認モーダル -->
  <div id="confirmation-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
    <div class="glass-panel rounded-xl max-w-md w-full mx-4">
      <div class="p-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 bg-yellow-500/20 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          <h3 id="modal-title" class="text-xl font-semibold text-white">確認</h3>
        </div>
        
        <div class="mb-6">
          <p id="modal-message" class="text-gray-300 leading-relaxed whitespace-pre-line">操作を実行しますか？</p>
        </div>
        
        <div class="flex gap-3">
          <button type="button" id="modal-cancel" class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
            キャンセル
          </button>
          <button type="button" id="modal-confirm" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium">
            実行
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- フォーム設定モーダル用JavaScript -->
  <script>
  // 文字数カウンター機能（タイトル入力は削除済み）
  function setupCharacterCounters() {
    const questionTextarea = document.getElementById('custom-main-question');
    const questionCounter = document.getElementById('question-counter');

    if (questionTextarea && questionCounter) {
      questionTextarea.addEventListener('input', function() {
        const count = this.value.length;
        questionCounter.textContent = `${count}/500`;
        questionCounter.className = count > 450 ? 'text-xs text-red-400' : 'text-xs text-gray-500';
      });
    }
  }

  // モーダル表示時にカウンターを初期化
  document.addEventListener('DOMContentLoaded', function() {
    setupCharacterCounters();
  });

  // フォーム設定モーダルが開かれたときにカウンターをリセット
  const originalShowFormConfigModal = window.showFormConfigModal;
  if (typeof originalShowFormConfigModal === 'function') {
    window.showFormConfigModal = function() {
      originalShowFormConfigModal();
      setTimeout(setupCharacterCounters, 100); // モーダル表示後にセットアップ
    };
  }
  
  // グローバル関数の露出（ボタンイベント用）
  window.saveAndPublish = saveAndPublish;
  window.unpublishBoard = unpublishBoard;
  window.copyBoardUrl = copyBoardUrl;
  window.openDatabaseSpreadsheet = openDatabaseSpreadsheet;
  window.openForm = openForm;
  window.switchToAnotherAccount = switchToAnotherAccount;
  window.openAppSetupPage = openAppSetupPage;
  window.deleteAllResources = deleteAllResources;
  </script>

</body>
</html>
