<!DOCTYPE html>
<!-- Layout Update v1.2 - 2025-07-19 - Fixed Header Overlap + Domain Display + Clean CSS -->
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <title>みんなの回答ボード	管理パネル - StudyQuest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#1a1b26" />
  <meta name="description" content="StudyQuestの回答ボード管理パネル - 直感的で使いやすい教育ツール" />
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=(), usb=(), serial=(), bluetooth=(), screen-wake-lock=(), accelerometer=(), gyroscope=(), magnetometer=(), ambient-light-sensor=(), speaker=(), vibrate=(), vr=()" />
  <!-- User ID will be retrieved dynamically from backend -->


  <!-- Bootstrap CSS & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script>
    // Comprehensive console warnings suppression
    (function() {
      // Store original console methods
      const originalWarn = console.warn;
      const originalInfo = console.info;
      const originalLog = console.log;
      const originalError = console.error;

      // Patterns to suppress
      const suppressPatterns = [
        '-ms-high-contrast is in the process of being deprecated',
        'Feature Policy',
        'Permissions Policy',
        'Unrecognized feature',
        'deprecated',
        'iframe.*sandbox.*allow-scripts.*allow-same-origin',
        'sandbox attribute can escape its sandboxing',
        'has both allow-scripts and allow-same-origin',
        'can escape its sandboxing',
        'Net state changed from',
        'warden_bin',
        'mae_html_user',
        'unrecognized feature',
        'ambient-light-sensor',
        'speaker',
        'vibrate',
        'vr',
        'Explain Console errors by using Copilot',
        'Learn more',
        'Don\'t show again'
      ];

      // Helper function to check if message should be suppressed
      function shouldSuppress(args) {
        const message = args[0] ? String(args[0]).toLowerCase() : '';
        return suppressPatterns.some(pattern => {
          const regex = new RegExp(pattern.toLowerCase(), 'i');
          return regex.test(message);
        });
      }

      // Override console.warn
      console.warn = function(...args) {
        if (!shouldSuppress(args)) {
          originalWarn.apply(console, args);
        }
      };

      // Override console.info
      console.info = function(...args) {
        if (!shouldSuppress(args)) {
          originalInfo.apply(console, args);
        }
      };

      // Override console.log for specific patterns
      console.log = function(...args) {
        if (!shouldSuppress(args)) {
          originalLog.apply(console, args);
        }
      };

      // Enhanced error filtering but keep important errors
      console.error = function(...args) {
        if (!shouldSuppress(args)) {
          originalError.apply(console, args);
        }
      };
    })();
  </script>

  <!-- Unified Styles and Shared Components -->
  <?!= include('UnifiedStyles'); ?>
  <?!= include('BootstrapFormComponents'); ?>
  <?!= include('SharedUtilities'); ?>

  <!-- Admin Panel Specific Styles -->
  <?!= include('adminPanel-layout.css'); ?>
  <?!= include('adminPanel.css'); ?>


  <!-- Core JavaScript Libraries (must be loaded first) -->
  <?!= include('ClientOptimizer'); ?>
  <?!= include('UnifiedCache.js'); ?>

  <script>
  // GASOptimizer and UnifiedCache are now guaranteed to be defined
  // Enhanced Global Error Handling
  window.addEventListener('error', function(event) {
    const errorMessage = event.error?.message || '';
    const errorStack = event.error?.stack || '';

    // Suppress specific Google Apps Script internal errors
    const suppressedErrors = [
      'document.write',
      'Unexpected token',
      'Failed to execute \'write\' on \'Document\'',
      'SyntaxError: Failed to execute \'write\'',
      'Identifier \'userId\' has already been declared',
      'mae_html_user_bin_i18n_mae_html_user',
      'warden_bin_i18n_warden',
      'unrecognized feature',
      'ambient-light-sensor',
      'speaker',
      'vibrate',
      'vr'
    ];

    const shouldSuppress = suppressedErrors.some(pattern =>
      errorMessage.includes(pattern) || errorStack.includes(pattern)
    );

    if (shouldSuppress) {
      // Log suppressed error for debugging (optional)
      console.debug('Suppressed Google Apps Script internal error:', errorMessage);
      event.preventDefault();
      return;
    }

    // Log important errors
    console.error('Global error caught:', event.error);
  });

  // Enhanced Promise rejection handling
  window.addEventListener('unhandledrejection', function(event) {
    const reason = event.reason?.toString() || '';

    // Suppress Google Apps Script internal promise rejections
    if (reason.includes('document.write') ||
        reason.includes('mae_html_user') ||
        reason.includes('warden_bin')) {
      console.debug('Suppressed internal promise rejection:', reason);
      event.preventDefault();
      return;
    }

    console.error('Unhandled promise rejection:', event.reason);
    event.preventDefault();
  });

  // GASOptimizer インスタンスの初期化
  var gasOptimizer = new GASOptimizer();

  // UnifiedCache インスタンスの初期化
  var unifiedCache = (typeof UnifiedCache !== 'undefined')
    ? new UnifiedCache()
    : { getOrSet: function(_, fn) { return fn(); } };

  // runGas ラッパー関数 - キャッシュ対応
  function runGas(functionName, ...args) {
    return gasOptimizer.call(functionName, ...args);
  }

  // runGasWithUserId function is defined in adminPanel-api.js.html to avoid duplication

  // callWithCache 関数 - 読み取り専用操作用
  function callWithCache(functionName, cacheKey, ttl, ...args) {
    return unifiedCache.getOrSet(cacheKey, function() {
      return gasOptimizer.call(functionName, ...args);
    }, ttl);
  }

  // マルチテナント対応: callWithCacheWithUserId関数
  function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
    if (!userId) {
      console.error('❌  - No userId available for cached call:', functionName);
      throw new Error('ユーザーIDが設定されていません。ページを再読み込みしてください。');
    }

    return unifiedCache.getOrSet(cacheKey, function() {
      console.log('✅  - callWithCacheWithUserId:', functionName, 'userId:', userId);
      return gasOptimizer.call(functionName, userId, ...args);
    }, ttl);
  }
  </script>
  <script>
  const __IS_SYSTEM_ADMIN_RAW__ = '<?= escapeJavaScript(typeof isDeployUser !== "undefined" ? isDeployUser : "false") ?>';
  const __IS_SYSTEM_ADMIN__ = __IS_SYSTEM_ADMIN_RAW__ === 'true' || __IS_SYSTEM_ADMIN_RAW__ === true;
  window.isSystemAdmin = __IS_SYSTEM_ADMIN__;
  console.log('Template Debug:');
  console.log('- Raw template value:', __IS_SYSTEM_ADMIN_RAW__);
  console.log('- Raw template type:', typeof __IS_SYSTEM_ADMIN_RAW__);
  console.log('- Processed value:', __IS_SYSTEM_ADMIN__);
  console.log('- window.isSystemAdmin final:', window.isSystemAdmin);

  </script>

  <!-- Bootstrap JavaScript will be added at the end of body -->
</head>
<body class="font-sans">
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="text-center">
      <div class="spinner"></div>
      <p id="loading-message" class="mt-4 text-light">処理中...</p>
    </div>
  </div>
  <header id="admin-header" class="glass-panel border-bottom border-secondary fixed-top rounded-3 shadow">
  <div class="container-fluid position-relative p-3 p-sm-4 d-flex align-items-center justify-content-between gap-3" style="max-width: 72rem;">
        <!-- ロゴとタイトル -->
        <div class="d-flex align-items-center gap-3 flex-shrink-0">
          <div class="d-flex align-items-center justify-content-center flex-shrink-0 rounded-2" style="width: 2rem; height: 2rem; background: linear-gradient(135deg, #22d3ee, #a855f7);">
            <svg class="icon-size-md text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <div class="min-w-0">
            <div class="d-none d-sm-block">
              <h1 class="h5 h4-sm fw-bold text-white lh-sm text-truncate">みんなの回答ボード	管理パネル</h1>
              <p class="small text-secondary">StudyQuest</p>
            </div>
            <div class="d-sm-none">
              <h1 class="h6 fw-bold text-white text-truncate">みんなの回答ボード</h1>
            </div>
          </div>
        </div>

        <!-- ドメイン・ステータス情報 -->
        <div class="d-flex align-items-center gap-2 flex-shrink-0">
          <!-- ドメイン情報（Login.htmlスタイル） -->
          <div id="header-domain-info">
            <!-- ドメイン一致表示（緑色パネル） -->
            <!-- ドメイン一致表示（Login.htmlスタイル） -->
            <div id="header-domain-match" class="glass-panel bg-gradient-green rounded-3 p-3 border border-success d-none">
              <div class="d-flex align-items-center gap-2">
                <svg class="icon-size-md text-success flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <div class="text-success fw-semibold small" id="header-domain-match-text">G Suite ドメイン</div>
                  <div class="text-success-emphasis small">セキュアアクセス有効</div>
                </div>
              </div>
            </div>

            <!-- ドメイン不一致表示（Login.htmlスタイル） -->
            <div id="header-domain-mismatch" class="glass-panel bg-warning bg-opacity-10 rounded-3 p-3 border border-warning d-none">
              <div class="d-flex align-items-center gap-2">
                <svg class="icon-size-md text-warning flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <div>
                  <div class="text-warning fw-semibold small" id="header-domain-mismatch-text">ドメイン不一致</div>
                  <div class="text-warning text-opacity-75" style="font-size: 0.75rem;">アクセス制限あり</div>
                </div>
              </div>
            </div>

            <!-- 初期状態表示 -->
            <div id="header-domain-initial" class="glass-panel bg-gradient-blue-purple rounded-3 p-3 border border-primary">
              <div class="d-flex align-items-center gap-2">
                <div id="header-status-dot" class="status-dot status-dot-pulse bg-primary flex-shrink-0"></div>
                <div>
                  <div class="text-primary fw-semibold small" id="header-domain-name-initial">ドメイン確認中</div>
                  <div class="text-info-emphasis small" id="header-status-text-initial">セットアップ中</div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
  </header>
  <main id="admin-main" class="flex-grow-1 container-fluid p-3 p-sm-4 overflow-auto">
    <!-- メインコンテンツ：ステータスバー＋左右パネル -->
    <div class="row g-4">

    <!-- シンプル統合ステータスバー -->
    <section class="col-12">
      <div class="glass-panel p-4 rounded-3">
        <div class="d-flex align-items-center justify-content-between">
          <!-- 左側: ステータス表示 -->
          <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center justify-content-center flex-shrink-0 rounded-2" style="width: 1.5rem; height: 1.5rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6);">
              <svg class="icon-size-sm text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <div>
              <span class="small fw-medium text-white" id="guidance-text">セットアップを開始してください</span>
              <div class="small text-secondary mt-1">3ステップで簡単セットアップ</div>
            </div>
          </div>

          <!-- 右側: コンパクトステップナビゲーション -->
          <div class="d-flex align-items-center gap-2">
            <div class="d-flex align-items-center gap-1" id="step-1-indicator">
              <div class="d-flex align-items-center justify-content-center fw-bold rounded-circle text-white transition-all" style="width: 1.5rem; height: 1.5rem; font-size: 0.75rem; background-color: var(--bs-primary); ">1</div>
              <span class="small text-light d-none d-sm-inline">データ準備</span>
            </div>
            <div class="vr" style="width: 4px; height: 1px; background-color: var(--bs-secondary);"></div>
            <div class="d-flex align-items-center gap-1" id="step-2-indicator">
              <div class="d-flex align-items-center justify-content-center fw-bold rounded-circle text-white transition-all" style="width: 1.5rem; height: 1.5rem; font-size: 0.75rem; background-color: var(--bs-secondary); ">2</div>
              <span class="small text-light d-none d-sm-inline">シート設定</span>
            </div>
            <div class="vr" style="width: 4px; height: 1px; background-color: var(--bs-secondary);"></div>
            <div class="d-flex align-items-center gap-1" id="step-3-indicator">
              <div class="d-flex align-items-center justify-content-center fw-bold rounded-circle text-white transition-all" style="width: 1.5rem; height: 1.5rem; font-size: 0.75rem; background-color: var(--bs-secondary); ">3</div>
              <span class="small text-light d-none d-sm-inline">表示設定</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 左右パネル -->
      <div class="left-panel col-lg-8 mb-4">

        <!-- ステップ1: データソース設定 -->
        <div class="glass-panel p-4 p-lg-5" id="data-setup-section">
          <div class="flex items-center justify-between mb-4">
            <div class="d-flex align-items-center gap-4">
              <div class="d-flex align-items-center justify-content-center rounded-3 shadow-lg" style="width: 2.5rem; height: 2.5rem; background: linear-gradient(135deg, #3b82f6, #2563eb);">
                1
              </div>
              <div>
                <h2 class="h5 fw-semibold text-white">データ準備</h2>
                <p class="small text-secondary">フォームやスプレッドシートを設定</p>
              </div>
            </div>
            <button type="button" class="btn btn-link toggle-section" onclick="toggleSection('step1-content')" aria-expanded="true" aria-label="セクションを展開/折りたたみ">
              <svg class="icon-md text-secondary transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>

          <div id="step1-content" class="progressive-section expanded">
            <!-- 統合されたデータ準備セクション -->
            <div class="google-integration p-4 rounded-3 text-white mb-4">
              <div class="d-flex align-items-center gap-3 mb-3">
                <svg class="icon-xl" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <div>
                  <h3 class="fw-semibold">データ準備</h3>
                  <p class="small opacity-90">フォームとスプレッドシートを作成</p>
                </div>
              </div>
              <p class="small mb-4 opacity-90">
                Google Workspaceと連携して、回答収集用のフォームとデータ管理用のスプレッドシートを作成します。お好みの方法を選択してください。
              </p>

              <!-- 水平配置のボタン -->
              <div class="d-flex gap-3">
                <button type="button" id="quickstart-btn" class="btn btn-google flex-fill">
                  <svg class="icon-md me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                  <span id="quickstart-text">クイックスタート</span>
                </button>
                <button type="button" id="create-board-btn" class="btn btn-google flex-fill">
                  <svg class="icon-md me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  <span id="create-board-text">カスタムセットアップ</span>
                </button>
              </div>
            </div>

            <!-- QuickStart Progress (共通プログレス表示) -->
            <div id="quickstart-progress" class="d-none bg-secondary bg-opacity-25 border border-success rounded-3 p-4 mb-4">
              <div class="d-flex align-items-center gap-2 mb-3">
                <svg class="icon-md text-success animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <h4 class="small fw-semibold text-success">セットアップ進行中</h4>
              </div>

              <!-- Progress Steps -->
              <div class="mb-3">
                <div class="d-flex align-items-center gap-3" id="progress-step-1">
                  <div class="d-flex align-items-center justify-content-center rounded-circle bg-secondary" style="width: 1.5rem; height: 1.5rem;">
                    <div class="rounded-circle bg-secondary" style="width: 0.5rem; height: 0.5rem;" id="progress-step-1-dot"></div>
                  </div>
                  <div class="flex-grow-1">
                    <div class="small text-light" id="progress-step-1-text">ユーザー専用フォルダの作成</div>
                    <div class="small text-muted" id="progress-step-1-detail">待機中...</div>
                  </div>
                </div>

                <div class="d-flex align-items-center gap-3" id="progress-step-2">
                  <div class="d-flex align-items-center justify-content-center rounded-circle bg-secondary" style="width: 1.5rem; height: 1.5rem;">
                    <div class="rounded-circle bg-secondary" style="width: 0.5rem; height: 0.5rem;" id="progress-step-2-dot"></div>
                  </div>
                  <div class="flex-grow-1">
                    <div class="small text-light" id="progress-step-2-text">Googleフォームとスプレッドシートの作成</div>
                    <div class="small text-muted" id="progress-step-2-detail">待機中...</div>
                  </div>
                </div>

                <div class="d-flex align-items-center gap-3" id="progress-step-3">
                  <div class="d-flex align-items-center justify-content-center rounded-circle bg-secondary" style="width: 1.5rem; height: 1.5rem;">
                    <div class="rounded-circle bg-secondary" style="width: 0.5rem; height: 0.5rem;" id="progress-step-3-dot"></div>
                  </div>
                  <div class="flex-grow-1">
                    <div class="small text-light" id="progress-step-3-text">回答ボードの設定と公開</div>
                    <div class="small text-muted" id="progress-step-3-detail">待機中...</div>
                  </div>
                </div>

                <div class="d-flex align-items-center gap-3" id="progress-step-4">
                  <div class="d-flex align-items-center justify-content-center rounded-circle bg-secondary" style="width: 1.5rem; height: 1.5rem;">
                    <div class="rounded-circle bg-secondary" style="width: 0.5rem; height: 0.5rem;" id="progress-step-4-dot"></div>
                  </div>
                  <div class="flex-grow-1">
                    <div class="small text-light" id="progress-step-4-text">セットアップ完了</div>
                    <div class="small text-muted" id="progress-step-4-detail">待機中...</div>
                  </div>
                </div>
              </div>

              <!-- Overall Progress Bar -->
              <div class="mt-4">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <span class="small text-secondary">全体の進捗</span>
                  <span class="small text-success" id="progress-percentage">0%</span>
                </div>
                <div class="progress" style="height: 0.5rem;">
                  <div class="progress-bar bg-gradient-success-info" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progress-bar"></div>
                </div>
              </div>

              <div class="mt-3 text-center">
                <p class="small text-success" id="progress-status">初期化中...</p>
              </div>
            </div>

            <!-- 既存ユーザー向けの追加オプション -->
            <div id="existing-user-section" class="d-none bg-secondary bg-opacity-25 border border-secondary rounded-3 p-4 mb-4">
              <h4 class="small fw-semibold text-light mb-3">追加オプション</h4>
              <button type="button" id="create-additional-form-btn" class="btn btn-secondary w-100 small">
                <svg class="icon-sm me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span id="create-additional-form-text" class="text-light">新規のフォームを作成</span>
              </button>
              <p class="small text-secondary mt-2">現在のボードに連携する新しいフォームを作成</p>
            </div>

            <!-- 外部リソースの連携 (上級者向け) -->
            <details class="bg-secondary bg-opacity-25 border border-secondary rounded-3">
              <summary class="p-4 cursor-pointer small fw-medium text-light hover:text-white d-flex align-items-center gap-2">
                <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                </svg>
                外部リソースの連携 (上級者向け)
              </summary>
              <div class="p-4 pt-0 mb-3">
                <div class="bg-purple-900 bg-opacity-25 border border-purple-500 rounded-3 p-4">
                  <label class="d-block small fw-medium text-purple-200 mb-2">
                    GoogleフォームまたはスプレッドシートのURL
                  </label>
                  <div class="mb-3">
                    <input type="url"
                           id="resource-url-input"
                           placeholder="https://docs.google.com/forms/d/... または https://docs.google.com/spreadsheets/d/..."
                           class="form-control"
                           aria-describedby="resource-url-help">
                    <p id="resource-url-help" class="small text-purple-300 mt-1">
                      既存のGoogleフォームまたはスプレッドシートのURLを貼り付けてください
                    </p>
                    <div class="d-flex gap-2">
                      <button type="button" id="add-resource-btn" class="btn btn-primary flex-fill">
                        <span id="add-resource-text">リソースを追加</span>
                      </button>
                      <button type="button" id="open-resource-btn" class="btn btn-secondary px-3" disabled title="フォームまたはスプレッドシートを開く">
                        <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        <span id="open-resource-text" class="ms-1 small d-none d-sm-inline">開く</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <!-- 作成されたリソース表示 -->
            <div class="mb-3 d-none" id="form-url-section">
              <div class="success-state">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <svg class="icon-md" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span class="font-medium">フォームが作成されました</span>
                </div>
                <div class="d-flex gap-2">
                  <input type="url" id="form-url-input" class="form-control flex-grow-1 small" readonly placeholder="フォームURLが生成されます">
                  <button type="button" id="copy-form-url-btn" class="btn btn-secondary" title="URLをコピー">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                  </button>
                  <a id="open-form-url-link" href="#" target="_blank" class="btn btn-secondary" title="フォームを開く">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                  </a>
                </div>
              </div>
            </div>

            <!-- カスタムフォーム情報表示エリア -->
            <div id="custom-form-info-section" class="d-none mt-4">
              <!-- updateCustomFormInfo()で動的に内容が設定される -->
            </div>
          </div>
        </div>

        <!-- ステップ2: データシート設定 -->
        <div class="glass-panel p-4 p-lg-5" id="sheet-selection-section">
          <div class="d-flex align-items-center justify-content-between mb-4">
            <div class="d-flex align-items-center gap-4">
              <div class="d-flex align-items-center justify-content-center rounded-3 shadow-lg" style="width: 2.5rem; height: 2.5rem; background: linear-gradient(135deg, #28a745, #1e7e34);">
                2
              </div>
              <div>
                <h2 class="h5 fw-semibold text-white">シート設定</h2>
                <p class="small text-secondary">表示するデータシートを選択</p>
              </div>
            </div>
            <button type="button" class="btn btn-link toggle-section" onclick="toggleSection('step2-content')" aria-expanded="true" aria-label="セクションを展開/折りたたみ">
              <svg class="icon-md text-secondary transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>

          <div id="step2-content" class="progressive-section expanded">
            <div class="mb-4">
              <!-- シート選択の説明 -->
              <div class="bg-success bg-opacity-25 border border-success rounded-3 p-3">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <svg class="icon-sm text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                  </svg>
                  <span class="small fw-medium text-success">データシート選択</span>
                </div>
                <p class="small text-success">スプレッドシートの中から回答ボードとして表示するシートを選択します</p>
              </div>

              <!-- シート選択コントロール -->
              <div class="mb-3">
                <label for="sheet-select" class="d-block small fw-medium text-white">
                  <span class="d-flex align-items-center gap-2">
                    <svg class="icon-sm text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    データシート
                  </span>
                </label>
                <div class="d-flex gap-2">
                  <select id="sheet-select" class="form-control flex-grow-1" aria-describedby="sheet-help">
                    <option>読み込み中...</option>
                  </select>
                  <button type="button" id="open-spreadsheet-btn-step2" class="btn btn-secondary px-3" title="スプレッドシートを開く">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                  </button>
                </div>
                <p id="sheet-help" class="small text-secondary">
                  フォームの回答や表示したいデータが含まれるシートを選択してください
                </p>
              </div>

              <!-- データプレビュー -->
              <div id="data-preview-section" class="d-none">
                <div class="bg-secondary bg-opacity-25 border border-secondary rounded-3 p-4">
                  <h4 class="small fw-medium text-white mb-3 d-flex align-items-center gap-2">
                    <svg class="icon-sm text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    データプレビュー
                  </h4>
                  <div id="data-preview-content" class="small text-light">
                    <div class="placeholder-glow">
                      <div class="placeholder col-7 mb-2"></div>
                      <div class="placeholder col-4"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ステップ3: 表示設定・公開 -->
        <div class="glass-panel p-4 lg:p-6" id="config-section">
          <div class="glass-panel p-4 p-lg-5" id="config-section">
          <div class="d-flex align-items-center justify-content-between mb-4">
            <div class="d-flex align-items-center gap-4">
              <div class="d-flex align-items-center justify-content-center rounded-3 shadow-lg" style="width: 2.5rem; height: 2.5rem; background: linear-gradient(135deg, #6f42c1, #563d7c);">
                3
              </div>
              <div>
                <h2 class="h5 fw-semibold text-white">表示設定・公開</h2>
                <p class="small text-secondary">列設定と表示オプションを設定</p>
              </div>
            </div>
            <button type="button" class="btn btn-link toggle-section" onclick="toggleSection('step3-content')" aria-expanded="true" aria-label="セクションを展開/折りたたみ">
              <svg class="icon-md text-secondary transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>

          <div id="step3-content" class="progressive-section expanded">
            <div id="config-area" class="mb-4 d-none">
              <div class="bg-purple-900 bg-opacity-25 border border-purple-500 rounded-3 p-4">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <svg class="icon-md text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  <span class="small fw-medium text-purple-200">列マッピング設定</span>
                </div>
                <p class="small text-purple-300">スプレッドシートの列を回答ボードの項目に割り当てます</p>
              </div>

              <!-- 必須設定 -->
              <div class="mb-4">
                <div class="bg-danger bg-opacity-25 border border-danger rounded-3 p-4">
                  <label class="d-block">
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="small fw-medium text-white">回答データ列</span>
                      <span class="badge bg-danger rounded-pill small">必須</span>
                    </div>
                    <div class="d-flex gap-2">
                      <select id="opinionHeader" class="form-control flex-grow-1" aria-describedby="main-help"></select>
                      <button type="button" id="reguess-headers-btn" class="btn btn-info px-3 py-2 position-relative" title="AI搭載 高精度列判定システム">
                        <span class="position-relative d-flex align-items-center gap-1" style="z-index: 10;">
                          <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                          </svg>
                          <span class="small fw-bold">AI判定</span>
                        </span>
                        <div class="position-absolute top-0 start-0 w-100 h-100 bg-gradient-cyan-purple opacity-25 transition-transform duration-300"></div>
                      </button>
                    </div>
                    <p id="main-help" class="small text-danger mt-1">
                      回答内容が含まれる列を選択してください
                    </p>
                  </label>
                </div>

                <!-- オプション設定 -->
                <details class="bg-secondary bg-opacity-25 border border-secondary rounded-3">
                  <summary class="p-4 cursor-pointer small fw-medium text-light hover:text-white d-flex align-items-center gap-2">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                    </svg>
                    オプション設定（任意）
                  </summary>
                  <div class="p-4 pt-0 mb-4" id="detail-options">
                    <label class="d-block">
                      <span class="small text-light mb-2 d-block">回答データ列（必須）</span>
                      <select id="opinion-column" class="form-control"></select>
                    </label>
                    <label class="d-block">
                      <span class="small text-light mb-2 d-block">名前列</span>
                      <select id="name-column" class="form-control"></select>
                    </label>
                    <label class="d-block">
                      <span class="small text-light mb-2 d-block">クラス列</span>
                      <select id="class-column" class="form-control"></select>
                    </label>

                    <div class="form-check mt-4">
                      <input type="checkbox" id="show-names" name="show-names" class="form-check-input">
                      <label for="show-names" class="form-check-label small text-light">名前を表示する</label>
                    </div>
                    <div class="form-check mt-2">
                      <input type="checkbox" id="show-counts" name="show-counts" class="form-check-input" checked>
                      <label for="show-counts" class="form-check-label small text-light">リアクション数を表示する</label>
                    </div>
                  </div>
                </details>
              </div>

              <!-- 統合アクションボタン -->
              <div class="mb-3 pt-4">
                <button type="button" id="save-publish-btn" disabled class="btn btn-primary w-100 btn-lg">
                  <svg class="icon-md me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span id="save-publish-text">設定を保存して公開</span>
                </button>

                <button type="button" id="unpublish-board-btn" class="btn btn-warning w-100 d-none">
                  <svg class="icon-md me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path>
                  </svg>
                  <span id="unpublish-board-text">公開を停止</span>
                </button>

                <button type="button" id="unpublish-board-btn" class="btn btn-warning w-100 d-none">
                  <svg class="icon-md me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path>
                  </svg>
                  <span id="unpublish-board-text">公開を停止</span>
                </button>
              </div>
            </div>

            <div id="config-placeholder" class="text-center py-5">
              <div class="d-flex align-items-center justify-content-center mx-auto mb-3 rounded-circle bg-secondary" style="width: 3rem; height: 3rem;">
                <div class="loading-skeleton w-100 h-100 rounded-circle d-none" id="config-loading"></div>
                <svg class="icon-lg text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                </svg>
              </div>
              <p class="text-secondary small">シートを選択すると列設定が表示されます</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 右側：情報・ヘルプパネル -->
      <div class="right-panel col-lg-4 mb-4">

        <!-- システム状況 -->
        <div id="system-info-panel" class="glass-panel p-4 p-lg-5">
    <div class="d-flex align-items-center gap-3 mb-4">
      <div class="d-flex align-items-center justify-content-center rounded-3" style="width: 2rem; height: 2rem; background: linear-gradient(135deg, #6c757d, #495057);">
        <svg class="icon-md text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
      </div>
      <h3 class="fw-semibold text-light">システム状況</h3>
    </div>

    <div class="mb-4">
      <!-- アカウント情報 -->
      <div class="bg-secondary bg-opacity-25 border border-secondary rounded-3 p-4">
        <h4 class="small fw-medium text-light mb-3 d-flex align-items-center gap-2">
          <svg class="icon-sm text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          アカウント
        </h4>
        <div class="mb-2 small">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">メールアドレス:</span>
            <span class="text-white fw-medium" id="info-admin-email">-</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">ユーザーID:</span>
            <span class="text-white font-monospace small bg-secondary px-2 py-1 rounded" id="info-user-id">-</span>
          </div>
          <div class="text-end pt-2">
          <a href="<?= getWebAppUrl(); ?>" class="text-info text-decoration-underline small">
            ログイン画面に戻る
          </a>
          </div>
        </div>
      </div>

      <!-- 公開設定 -->
      <div class="bg-secondary bg-opacity-25 border border-secondary rounded-3 p-4">
        <h4 class="small fw-medium text-light mb-3 d-flex align-items-center gap-2">
          <svg class="icon-sm text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
          公開設定
        </h4>
        <div class="mb-2 small">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">公開状態:</span>
            <span class="px-2 py-1 rounded small fw-medium" id="info-publish-status">
              <span class="d-inline-flex align-items-center gap-1">
                <div class="rounded-circle" style="width: 0.5rem; height: 0.5rem;" id="info-publish-indicator"></div>
                <span id="info-publish-text">確認中</span>
              </span>
            </span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">公開シート:</span>
            <span class="text-white fw-semibold" id="info-published-sheet">-</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">表示モード:</span>
            <span class="text-white" id="info-display-mode">-</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">カウント表示:</span>
            <span class="text-white" id="info-show-counts">-</span>
          </div>
        </div>
      </div>

      <!-- データ状況 -->
      <div class="bg-secondary bg-opacity-25 border border-secondary rounded-3 p-4">
        <h4 class="small fw-medium text-light mb-3 d-flex align-items-center gap-2">
          <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          データ状況
        </h4>
        <div class="mb-2 small">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">総回答数:</span>
            <span class="text-white fw-bold h5" id="info-answer-count">-</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">総リアクション数:</span>
            <span class="text-white fw-bold h5" id="info-reaction-count">-</span>
          </div>
        </div>
      </div>

      <!-- リソース -->
      <div class="bg-secondary bg-opacity-25 border border-secondary rounded-3 p-4">
        <h4 class="small fw-medium text-light mb-3 d-flex align-items-center gap-2">
          <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
          </svg>
          リソース
        </h4>
        <div class="mb-3 small">
          <div class="d-flex gap-2">
            <button type="button" id="open-spreadsheet-btn" class="flex-fill btn btn-success text-white px-3 py-2 rounded d-flex align-items-center justify-content-center gap-2 transition-all" disabled>
              <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              スプレッドシート
            </button>
            <button type="button" id="open-form-btn" class="flex-fill btn btn-primary text-white px-3 py-2 rounded d-flex align-items-center justify-content-center gap-2 transition-all" disabled>
              <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              フォーム
            </button>
          </div>
        </div>
      </div>

      <!-- アプリ設定リンク -->
<? if (isDeployUser) { ?>
      <div id="app-setup-link" class="bg-primary bg-opacity-10 border border-primary rounded-3 p-3 transition-all hover:border-primary">
        <button type="button" onclick="openAppSetupPage()" class="w-100 d-flex align-items-center justify-content-between small fw-medium text-primary hover:text-info transition-colors">
          <div class="d-flex align-items-center">
            <svg class="icon-sm me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span>アプリ設定管理</span>
          </div>
          <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
        </button>
        <p class="small text-info-emphasis mt-2 ms-5">
          アプリの有効/無効状態を管理できます
        </p>
      </div>
<? } ?>

      <!-- セキュリティと統合情報 -->
      <div class="bg-secondary bg-opacity-25 border border-secondary rounded-3 p-4">
        <h4 class="small fw-medium text-light mb-3 d-flex align-items-center gap-2">
          <svg class="icon-sm text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
          セキュリティと統合
        </h4>
        <div class="mb-2 small">
          <div class="d-flex align-items-center justify-content-between">
            <a href="#" onclick="showSecurityInfo(); return false;" class="text-info text-decoration-underline">
              セキュリティ仕様について
            </a>
          </div>
          <div class="d-flex align-items-center justify-content-between">
            <a href="#" onclick="showGoogleIntegrationInfo(); return false;" class="text-info text-decoration-underline">
              Google連携の利点
            </a>
          </div>
        </div>
      </div>

      <details id="account-deletion-section" class="bg-danger bg-opacity-10 border border-danger rounded-3 transition-all hover:border-danger">
        <summary class="p-3 cursor-pointer small fw-medium text-danger hover:text-danger d-flex align-items-center justify-content-between">
          <span>アカウントの管理</span>
          <svg class="icon-sm transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </summary>
        <div class="p-3 pt-0">
          <p class="small text-danger mb-3">
            この操作は元に戻せません。アカウントを削除すると、作成したすべてのボードと設定が完全に消去されます。
          </p>
          <button type="button" id="delete-account-btn" class="btn btn-danger w-100 small py-2" onclick="handleDeleteRequest()">
            <svg class="icon-sm me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            <span>自分のアカウントを完全に削除する</span>
          </button>
        </div>
      </details>
      </div>
    </div>
  </main>

  <!-- 統合フッター -->
  <footer id="admin-footer" class="fixed-bottom glass-panel border-top border-secondary d-none">
    <div class="container-fluid px-4 py-3" style="max-width: 72rem;">
      <div class="d-flex align-items-center justify-content-between">
        <!-- 左側: 公開中の問題文 -->
        <div class="flex-grow-1">
          <div class="d-flex align-items-center gap-2 mb-1">
            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-success fw-semibold small">公開中:</span>
          </div>
          <p class="text-info fw-medium h5" id="current-topic-text">読み込み中...</p>
        </div>

        <!-- 右側: ボードURL操作 -->
        <div class="d-flex align-items-center gap-3">
          <input type="text" id="board-url" readonly
                 class="form-control bg-secondary border border-secondary rounded-3 small cursor-pointer hover:bg-secondary focus:ring-2 focus:ring-success min-w-[300px]"
                 onclick="this.select()" placeholder="URLが生成されます">
          <button type="button" onclick="copyBoardUrl()" class="btn btn-secondary px-3 py-2 d-flex align-items-center" title="URLをコピー" aria-label="生徒用URLをコピー">
            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
          </button>
          <a id="view-board-link" href="#" target="_blank" rel="noopener noreferrer" class="btn btn-primary px-3 py-2 d-flex align-items-center" title="回答ボードを開く" aria-label="新しいタブで回答ボードを開く">
            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </footer>
  <div id="message-area" class="position-fixed top-0 end-0 mt-5 me-3" style="z-index: 1060;" aria-live="polite" role="status"></div>

  <!-- 共通モーダルコンポーネントを読み込み -->
  <?!= include('SharedModals'); ?>
  <!-- Admin Panel JavaScript Components -->
  <?!= include('adminPanel-core.js'); ?>
  <?!= include('adminPanel-status.js'); ?>
  <?!= include('adminPanel-api.js'); ?>
  <?!= include('adminPanel-ui.js'); ?>
  <?!= include('adminPanel-events.js'); ?>

  <!-- フォーム設定モーダル用JavaScript -->
  <!-- Form Controls and Modal Management -->
  <?!= include('adminPanel-forms.js'); ?>

  <!-- Admin Panel Specific JavaScript -->
  <?!= include('adminPanel.js'); ?>

  <script>
    // 管理者モーダルの初期化
    document.addEventListener('DOMContentLoaded', function() {
      if (window.sharedModals) {
        window.sharedModals.loadAdminModals();
      }
    });
  </script>

  <!-- Bootstrap JavaScript Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
