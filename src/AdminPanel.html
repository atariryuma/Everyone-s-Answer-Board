<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <title>StudyQuest ç®¡ç†ç”»é¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; color: #c0caf5; }
    .glass-panel { background: rgba(26,27,38,0.7); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    :focus-visible { outline: 3px solid #8be9fd; outline-offset: 2px; border-radius: 4px; }
    .wizard-step { text-align: center; position: relative; z-index: 10; }
    .wizard-content { transition: opacity 0.3s ease-in-out; }
    .help-tooltip { cursor: help; }
    .help-tooltip:hover { background-color: rgba(59, 130, 246, 0.2); border-radius: 50%; }
    #wizard-progress { transition: width 0.5s ease-in-out; }
  </style>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans px-4 pb-4 pt-4">
  <div id="app" class="glass-panel max-w-2xl mx-auto rounded-xl p-6 shadow-lg">
    <h2 class="text-2xl font-bold mb-6 text-yellow-300 text-center">StudyQuest ç®¡ç†ç”»é¢</h2>

    <!-- Dashboard Status Cards -->
    <div class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Status Card -->
      <div class="glass-panel p-6 rounded-lg text-center">
        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-blue-500/20 flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div class="text-2xl font-bold text-white mb-1" id="board-status">æº–å‚™ä¸­</div>
        <div class="text-xs text-gray-400">ãƒœãƒ¼ãƒ‰çŠ¶æ…‹</div>
      </div>
      
      <!-- Answer Count Card -->
      <div class="glass-panel p-6 rounded-lg text-center">
        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-green-500/20 flex items-center justify-center">
          <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
        </div>
        <div class="text-2xl font-bold text-white mb-1" id="answer-count">0</div>
        <div class="text-xs text-gray-400">å›ç­”æ•°</div>
      </div>
      
      <!-- Reaction Count Card -->
      <div class="glass-panel p-6 rounded-lg text-center">
        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-purple-500/20 flex items-center justify-center">
          <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
          </svg>
        </div>
        <div class="text-2xl font-bold text-white mb-1" id="reaction-count">0</div>
        <div class="text-xs text-gray-400">ç·ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
      </div>
    </div>

    <!-- Current Status Detail -->
    <div class="mb-6 glass-panel p-4 rounded-lg">
      <h3 class="font-semibold mb-3 flex items-center gap-2">
        <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        å›ç­”ãƒœãƒ¼ãƒ‰ã®åˆ©ç”¨çŠ¶æ³
      </h3>
      <p id="status-text" class="text-gray-300 flex justify-center">
        <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="currentColor"></path>
        </svg>
      </p>
      <div id="board-url-section" class="mt-3 hidden">
        <p class="text-sm text-gray-400 mb-2">ç”Ÿå¾’ç”¨URL:</p>
        <div class="flex gap-2">
          <input type="text" id="board-url" readonly 
                 class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded text-sm cursor-pointer hover:bg-gray-600"
                 onclick="this.select()">
          <button onclick="copyBoardUrl()" 
                  class="px-3 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-sm transition-colors">
            ã‚³ãƒ”ãƒ¼
          </button>
          <a id="view-board-link" href="#" target="_blank"
             class="px-3 py-2 bg-green-600 hover:bg-green-700 rounded text-sm transition-colors">
            è¡¨ç¤º
          </a>
        </div>
        <p class="text-xs text-gray-400 mt-1">ã“ã®URLã¯å›ºå®šã§ã™ã€‚ä¸€åº¦ç”Ÿå¾’ã«å…±æœ‰ã™ã‚Œã°ã€ãšã£ã¨ä½¿ã„ç¶šã‘ã‚‰ã‚Œã¾ã™ã€‚</p>
      </div>
    </div>

    <!-- No Active Sheet Message with Add Spreadsheet Option -->
    <div id="no-sheet-message" class="mb-6 p-4 bg-yellow-900/30 border border-yellow-600/50 rounded-lg hidden">
      <div class="flex items-center gap-2 mb-3">
        <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
        <h3 class="font-semibold text-yellow-400">å›ç­”ãƒœãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
      </div>
      <p class="text-sm text-yellow-200 mb-4">
        ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¦ã‚·ãƒ¼ãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€ç”Ÿå¾’ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å›ç­”ãƒœãƒ¼ãƒ‰ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚
      </p>
      
      <!-- Quick Add Spreadsheet -->
      <div class="bg-yellow-800/20 rounded-lg p-3 border border-yellow-600/30">
        <h4 class="text-sm font-semibold text-yellow-300 mb-2">æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ </h4>
        <div class="flex gap-2">
          <input type="url" id="quick-spreadsheet-url" 
                 placeholder="https://docs.google.com/spreadsheets/d/..."
                 class="flex-1 p-2 rounded bg-gray-700 border border-gray-600 text-white text-sm focus:ring-2 focus:ring-yellow-400">
          <button type="button" id="quick-add-btn" 
                  class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded font-semibold text-sm transition-all">
            è¿½åŠ 
          </button>
        </div>
      </div>
    </div>

    <!-- Setup Wizard -->
    <div class="mb-8">
      <div class="flex items-center justify-between relative mb-6">
        <div class="absolute top-4 left-0 right-0 h-0.5 bg-gray-600"></div>
        <div class="absolute top-4 left-0 h-0.5 bg-cyan-400 transition-all duration-500" id="wizard-progress" style="width: 25%"></div>
        
        <div class="wizard-step" id="wizard-step-1">
          <div class="w-8 h-8 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm relative z-10">1</div>
          <span class="text-xs mt-2 block text-cyan-400">URLè¿½åŠ </span>
        </div>
        <div class="wizard-step" id="wizard-step-2">
          <div class="w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm relative z-10">2</div>
          <span class="text-xs mt-2 block text-gray-400">ã‚·ãƒ¼ãƒˆé¸æŠ</span>
        </div>
        <div class="wizard-step" id="wizard-step-3">
          <div class="w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm relative z-10">3</div>
          <span class="text-xs mt-2 block text-gray-400">åˆ—è¨­å®š</span>
        </div>
        <div class="wizard-step" id="wizard-step-4">
          <div class="w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm relative z-10">4</div>
          <span class="text-xs mt-2 block text-gray-400">å…¬é–‹</span>
        </div>
      </div>
    </div>

    <!-- Step 1: Spreadsheet URL Input -->
    <div class="mb-6 wizard-content" id="wizard-content-1">
      <div class="glass-panel p-6 rounded-lg">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
          <div class="w-6 h-6 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm">1</div>
          ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ 
        </h3>
        <div class="space-y-4">
          <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
            <h4 class="font-semibold text-blue-300 mb-2">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</h4>
            <p class="text-sm text-blue-200">Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
          </div>
          <div class="flex gap-2">
            <input type="url" id="spreadsheet-url-input" 
                   placeholder="https://docs.google.com/spreadsheets/d/..."
                   class="flex-1 p-3 rounded-lg glass-panel text-white border border-gray-600 focus:ring-2 focus:ring-cyan-400">
            <button type="button" id="add-spreadsheet-btn" 
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all">
              è¿½åŠ 
            </button>
          </div>
          <p class="text-xs text-gray-400">URLå½¢å¼: https://docs.google.com/spreadsheets/d/[ID]/edit</p>
          
          <!-- Step 1 Navigation -->
          <div class="flex justify-between items-center pt-4 border-t border-gray-600">
            <div></div> <!-- Empty for alignment -->
            <button type="button" id="step1-next-btn" disabled
                    class="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-600 text-white rounded-lg font-semibold transition-all">
              ã‚·ãƒ¼ãƒˆé¸æŠã¸ â†’
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Sheet Selection -->
    <div class="mb-6 wizard-content hidden" id="wizard-content-2">
      <div class="glass-panel p-6 rounded-lg">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
          <div class="w-6 h-6 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm" id="step-2-icon">2</div>
          è¡¨ç¤ºã™ã‚‹ã‚·ãƒ¼ãƒˆã‚’é¸æŠ
        </h3>
        <div class="space-y-4">
          <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
            <h4 class="font-semibold text-green-300 mb-2">ğŸ“‹ ã‚·ãƒ¼ãƒˆé¸æŠ</h4>
            <p class="text-sm text-green-200">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå†…ã®ã©ã®ã‚·ãƒ¼ãƒˆã‚’å›ç­”ãƒœãƒ¼ãƒ‰ã§è¡¨ç¤ºã™ã‚‹ã‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
          </div>
          <select id="sheet-select" title="è¡¨ç¤ºã™ã‚‹ã‚·ãƒ¼ãƒˆã‚’é¸æŠ" aria-label="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚·ãƒ¼ãƒˆé¸æŠ" class="w-full p-3 rounded-lg glass-panel text-white border border-gray-600 focus:ring-2 focus:ring-cyan-400">
            <option>èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
          
          <!-- Step 2 Navigation -->
          <div class="flex justify-between items-center pt-4 border-t border-gray-600">
            <button type="button" id="step2-prev-btn"
                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-all">
              â† URLè¿½åŠ ã«æˆ»ã‚‹
            </button>
            <button type="button" id="step2-next-btn" disabled
                    class="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-600 text-white rounded-lg font-semibold transition-all">
              åˆ—è¨­å®šã¸ â†’
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Config Setup -->
    <div class="mb-6 wizard-content hidden" id="wizard-content-3">
      <div class="glass-panel p-6 rounded-lg">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
          <div class="w-6 h-6 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm" id="step-3-icon">3</div>
          åˆ—ã®è¨­å®š
        </h3>
        <div class="space-y-4">
          <div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4">
            <h4 class="font-semibold text-purple-300 mb-2">âš™ï¸ åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°</h4>
            <p class="text-sm text-purple-200">ãƒœãƒ¼ãƒ‰ã§ä½¿ç”¨ã™ã‚‹å„é …ç›®ã«å¯¾å¿œã™ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚è‡ªå‹•ã§æ¨æ¸¬ã•ã‚ŒãŸå€¤ã‚’ç¢ºèªãƒ»èª¿æ•´ã§ãã¾ã™ã€‚</p>
          </div>
          <div class="flex flex-col gap-3 rounded-lg glass-panel p-4" id="config-area">
            <label class="flex flex-col gap-1">
              <span class="text-sm font-medium text-gray-300">å•é¡Œæ–‡ãƒ˜ãƒƒãƒ€ãƒ¼ 
                <button type="button" class="help-tooltip ml-1 text-xs text-blue-400 hover:text-blue-300" title="å›ç­”ãƒœãƒ¼ãƒ‰ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹åˆ—">?</button>
              </span>
              <select id="qHeader" class="w-full p-2 rounded text-gray-900 border border-gray-300"></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm font-medium text-gray-300">å›ç­”ãƒ˜ãƒƒãƒ€ãƒ¼ 
                <button type="button" class="help-tooltip ml-1 text-xs text-blue-400 hover:text-blue-300" title="å›ç­”ã‚«ãƒ¼ãƒ‰ã®ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹åˆ—">?</button>
              </span>
              <select id="aHeader" class="w-full p-2 rounded text-gray-900 border border-gray-300"></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm font-medium text-gray-300">ç†ç”±ãƒ˜ãƒƒãƒ€ãƒ¼ 
                <button type="button" class="help-tooltip ml-1 text-xs text-blue-400 hover:text-blue-300" title="å›ç­”ã‚«ãƒ¼ãƒ‰ã®æœ¬æ–‡ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹åˆ—">?</button>
              </span>
              <select id="rHeader" class="w-full p-2 rounded text-gray-900 border border-gray-300"></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm font-medium text-gray-300">åå‰åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ 
                <button type="button" class="help-tooltip ml-1 text-xs text-blue-400 hover:text-blue-300" title="å­¦ç”Ÿåã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹åˆ—">?</button>
              </span>
              <select id="nameHeader" class="w-full p-2 rounded text-gray-900 border border-gray-300"></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm font-medium text-gray-300">ã‚¯ãƒ©ã‚¹åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ 
                <button type="button" class="help-tooltip ml-1 text-xs text-blue-400 hover:text-blue-300" title="ã‚¯ãƒ©ã‚¹åˆ†ã‘ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã§ä½¿ç”¨ã•ã‚Œã‚‹åˆ—">?</button>
              </span>
              <select id="classHeader" class="w-full p-2 rounded text-gray-900 border border-gray-300"></select>
            </label>
            <button type="button" id="save-config-btn" class="w-full bg-green-600 hover:bg-green-700 text-white rounded-lg py-2 font-semibold transition-all">è¨­å®šã‚’ä¿å­˜</button>
          </div>
          
          <!-- Step 3 Navigation -->
          <div class="flex justify-between items-center pt-4 border-t border-gray-600">
            <button type="button" id="step3-prev-btn"
                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-all">
              â† ã‚·ãƒ¼ãƒˆé¸æŠã«æˆ»ã‚‹
            </button>
            <button type="button" id="step3-next-btn" disabled
                    class="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-600 text-white rounded-lg font-semibold transition-all">
              æœ€çµ‚ç¢ºèªã¸ â†’
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 4: Final Setup and Publishing -->
    <div class="mb-6 wizard-content hidden" id="wizard-content-4">
      <div class="glass-panel p-6 rounded-lg">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
          <div class="w-6 h-6 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm" id="step-4-icon">4</div>
          æœ€çµ‚ç¢ºèªã¨å…¬é–‹
        </h3>
        <div class="space-y-6">
          <!-- Current Settings Summary -->
          <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
            <h4 class="font-semibold text-blue-300 mb-3">ğŸ“‹ ç¾åœ¨ã®è¨­å®š</h4>
            <div id="settings-summary" class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">é¸æŠã‚·ãƒ¼ãƒˆ:</span>
                <span class="text-white" id="summary-sheet">æœªé¸æŠ</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">å•é¡Œæ–‡åˆ—:</span>
                <span class="text-white" id="summary-question">æœªè¨­å®š</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">å›ç­”åˆ—:</span>
                <span class="text-white" id="summary-answer">æœªè¨­å®š</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">ç†ç”±åˆ—:</span>
                <span class="text-white" id="summary-reason">æœªè¨­å®š</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">åå‰åˆ—:</span>
                <span class="text-white" id="summary-name">æœªè¨­å®š</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">ã‚¯ãƒ©ã‚¹åˆ—:</span>
                <span class="text-white" id="summary-class">æœªè¨­å®š</span>
              </div>
            </div>
            <button type="button" id="edit-settings-btn" 
                    class="mt-3 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-all">
              âš™ï¸ è¨­å®šã‚’ä¿®æ­£ã™ã‚‹
            </button>
          </div>
          <!-- Display Options -->
          <div>
            <h4 class="font-semibold mb-3 text-orange-300">ğŸ“Š è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³</h4>
            <div id="detail-options" class="flex flex-col gap-3 rounded-lg glass-panel p-4">
              <label class="flex items-center p-3 rounded-md cursor-pointer border border-gray-600 hover:border-gray-500 transition-colors">
                <input type="radio" name="showDetails" value="true" class="mr-3" />
                <div>
                  <div class="font-medium text-white">åå‰ãƒ»ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’è¡¨ç¤º</div>
                  <div class="text-xs text-gray-400">ç”Ÿå¾’ã®åå‰ã¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                </div>
              </label>
              <label class="flex items-center p-3 rounded-md cursor-pointer border border-gray-600 hover:border-gray-500 transition-colors">
                <input type="radio" name="showDetails" value="false" class="mr-3" />
                <div>
                  <div class="font-medium text-white">åŒ¿åè¡¨ç¤º</div>
                  <div class="text-xs text-gray-400">åŒ¿åè¡¨ç¤ºã§ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚‚éè¡¨ç¤º</div>
                </div>
              </label>
            </div>
          </div>

          <!-- Preview and Actions -->
          <div class="space-y-3">
            <div class="flex gap-3">
              <button type="button" id="preview-btn" 
                      class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all">
                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
              </button>
              <button type="button" id="switch-sheet-btn" disabled
                      class="flex-1 px-4 py-3 bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-600 text-white rounded-lg font-semibold transition-all">
                ğŸš€ ã“ã®ã‚·ãƒ¼ãƒˆã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
              </button>
            </div>
            <button type="button" id="clear-selection-btn" disabled
                    class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 text-white rounded-lg transition-all">
              ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
            </button>
          </div>
          
          <!-- Step 4 Navigation -->
          <div class="flex justify-between items-center pt-4 border-t border-gray-600">
            <button type="button" id="step4-prev-btn"
                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-all">
              â† åˆ—è¨­å®šã«æˆ»ã‚‹
            </button>
            <div class="flex gap-2">
              <button type="button" id="final-preview-btn" 
                      class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all">
                ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
              </button>
              <button type="button" id="final-publish-btn" disabled
                      class="px-6 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 text-white rounded-lg font-semibold transition-all">
                ğŸš€ å…¬é–‹ã™ã‚‹
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Legacy Display Options (hidden by default, shown when not in wizard mode) -->
    <div class="mb-6 hidden" id="legacy-display-options">
      <h3 class="font-semibold mb-3">4. è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
      <div id="detail-options-legacy" class="flex flex-col gap-2 rounded-lg glass-panel p-2">
        <label class="flex items-center p-2 rounded-md cursor-pointer">
          <input type="radio" name="showDetails" value="true" class="mr-2" />
          <div>
            <div class="font-medium">åå‰ãƒ»ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’è¡¨ç¤º</div>
            <div class="text-xs text-gray-400">ç”Ÿå¾’ã®åå‰ã¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
          </div>
        </label>
        <label class="flex items-center p-2 rounded-md cursor-pointer">
          <input type="radio" name="showDetails" value="false" class="mr-2" />
          <div>
            <div class="font-medium">è¡¨ç¤ºã—ãªã„</div>
            <div class="text-xs text-gray-400">åŒ¿åè¡¨ç¤ºã§ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚‚éè¡¨ç¤º</div>
          </div>
        </label>
      </div>
    </div>

    <!-- Legacy Actions (hidden by default, shown when not in wizard mode) -->
    <div class="mb-6 hidden" id="legacy-actions">
      <h3 class="font-semibold mb-3">5. æ“ä½œã‚’é¸æŠ</h3>
      <div class="flex flex-col gap-2">
        <button type="button" id="preview-btn-legacy" 
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
          ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        </button>
        <button type="button" id="switch-sheet-btn-legacy" disabled
                class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-600 text-white rounded-lg">
          ã“ã®ã‚·ãƒ¼ãƒˆã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        </button>
        <button type="button" id="clear-selection-btn-legacy" disabled
                class="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 text-white rounded-lg">
          ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
        </button>
      </div>
    </div>

    <!-- Message Area -->
    <div id="message-area" class="mt-4 text-center text-sm h-5"></div>
  </div>

  <script>
    const userId = '<?= userId ?>';
    let currentWizardStep = 1;
    let wizardMode = true;
    let autoAdvance = false; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸»å°ã®ç¢ºèªå‹ãƒ•ãƒ­ãƒ¼
    
    // Wizard functionality
    function updateWizardStep(step, force = false) {
      // Allow explicit step navigation when force is true
      if (!force && step <= currentWizardStep && currentWizardStep < 4) {
        return;
      }
      
      currentWizardStep = step;
      
      // Update progress bar
      const progressBar = document.getElementById('wizard-progress');
      if (progressBar) {
        progressBar.style.width = `${(step / 4) * 100}%`;
      }
      
      // Update step indicators
      for (let i = 1; i <= 4; i++) {
        const stepElement = document.getElementById(`wizard-step-${i}`);
        const contentElement = document.getElementById(`wizard-content-${i}`);
        
        if (stepElement) {
          const stepCircle = stepElement.querySelector('div');
          const stepLabel = stepElement.querySelector('span');
          
          if (i <= step) {
            if (stepCircle) {
              stepCircle.className = 'w-8 h-8 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm relative z-10';
            }
            if (stepLabel) {
              stepLabel.className = 'text-xs mt-2 block text-cyan-400';
            }
          } else {
            if (stepCircle) {
              stepCircle.className = 'w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm relative z-10';
            }
            if (stepLabel) {
              stepLabel.className = 'text-xs mt-2 block text-gray-400';
            }
          }
        }
        
        // Show/hide content
        if (contentElement) {
          if (i === step) {
            contentElement.classList.remove('hidden');
          } else {
            contentElement.classList.add('hidden');
          }
        }
      }
      
      // Update step icons in content
      const stepIcons = ['step-2-icon', 'step-3-icon', 'step-4-icon'];
      stepIcons.forEach((iconId, index) => {
        const icon = document.getElementById(iconId);
        if (icon) {
          const stepNum = index + 2;
          if (stepNum <= step) {
            icon.className = 'w-6 h-6 rounded-full bg-cyan-400 text-white flex items-center justify-center font-bold text-sm';
          } else {
            icon.className = 'w-6 h-6 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold text-sm';
          }
        }
      });
    }
    
    // Preview functionality
    function openPreview() {
      if (!selectedSheet) {
        showMessage('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'red');
        return;
      }
      
      // Get current config values
      const config = {
        questionHeader: elements.qHeader.value,
        answerHeader: elements.aHeader.value,
        reasonHeader: elements.rHeader.value,
        nameHeader: elements.nameHeader.value,
        classHeader: elements.classHeader.value
      };
      
      // Get display settings
      const showDetails = document.querySelector('input[name="showDetails"]:checked')?.value === 'true';
      
      // Construct preview URL
      const baseUrl = window.location.origin + window.location.pathname.replace('AdminPanel.html', 'Page.html');
      const previewUrl = `${baseUrl}?userId=${userId}&preview=true&sheet=${encodeURIComponent(selectedSheet)}&showDetails=${showDetails}`;
      
      // Open in new tab
      window.open(previewUrl, '_blank', 'width=1200,height=800');
    }
    
    const elements = {
      statusText: document.getElementById('status-text'),
      sheetSelect: document.getElementById('sheet-select'),
      switchSheetBtn: document.getElementById('switch-sheet-btn'),
      clearSelectionBtn: document.getElementById('clear-selection-btn'),
      configArea: document.getElementById('config-area'),
      qHeader: document.getElementById('qHeader'),
      aHeader: document.getElementById('aHeader'),
      rHeader: document.getElementById('rHeader'),
      nameHeader: document.getElementById('nameHeader'),
      classHeader: document.getElementById('classHeader'),
      saveConfigBtn: document.getElementById('save-config-btn'),
      detailOptions: document.getElementById('detail-options'),
      messageArea: document.getElementById('message-area'),
      boardUrlSection: document.getElementById('board-url-section'),
      boardUrl: document.getElementById('board-url'),
      viewBoardLink: document.getElementById('view-board-link'),
      noSheetMessage: document.getElementById('no-sheet-message')
    };

    let selectedSheet = null;
    let currentActiveSheet = null;

    document.addEventListener('DOMContentLoaded', () => {
      loadInitialState();
      
      // Standard event listeners
      elements.switchSheetBtn.addEventListener('click', switchToSelectedSheet);
      elements.clearSelectionBtn.addEventListener('click', clearSheetSelection);
      elements.saveConfigBtn.addEventListener('click', saveConfig);
      
      // Wizard-specific event listeners
      document.getElementById('add-spreadsheet-btn').addEventListener('click', () => {
        addSpreadsheet();
        // è‡ªå‹•é€²è¡Œã¯ç„¡åŠ¹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¬¡ã¸ãƒœã‚¿ãƒ³ã§é€²ã‚€
      });
      
      elements.qHeader.addEventListener('change', () => {
        if (!elements.aHeader.value) elements.aHeader.value = elements.qHeader.value;
        updateNavigationButtons();
      });
      elements.aHeader.addEventListener('change', () => {
        if (!elements.qHeader.value) elements.qHeader.value = elements.aHeader.value;
        updateNavigationButtons();
      });
      
      // Preview button listeners
      const previewBtn = document.getElementById('preview-btn');
      const previewBtnLegacy = document.getElementById('preview-btn-legacy');
      if (previewBtn) previewBtn.addEventListener('click', openPreview);
      if (previewBtnLegacy) previewBtnLegacy.addEventListener('click', openPreview);
      
      // Help tooltip functionality
      document.querySelectorAll('.help-tooltip').forEach(tooltip => {
        tooltip.addEventListener('click', (e) => {
          e.preventDefault();
          const title = tooltip.getAttribute('title');
          if (title) {
            showMessage(title, 'blue');
            setTimeout(() => showMessage('', 'blue'), 3000);
          }
        });
      });
      
      // Wizard navigation event listeners
      setupWizardNavigation();
      
      // Initialize wizard
      if (wizardMode) {
        updateWizardStep(1);
      }
    });
    
    // Wizard navigation setup
    function setupWizardNavigation() {
      // Step 1 navigation
      const step1NextBtn = document.getElementById('step1-next-btn');
      if (step1NextBtn) {
        step1NextBtn.addEventListener('click', () => {
          if (validateStep1()) {
            updateWizardStep(2, true);
          }
        });
      }
      
      // Step 2 navigation
      const step2PrevBtn = document.getElementById('step2-prev-btn');
      const step2NextBtn = document.getElementById('step2-next-btn');
      if (step2PrevBtn) {
        step2PrevBtn.addEventListener('click', () => updateWizardStep(1, true));
      }
      if (step2NextBtn) {
        step2NextBtn.addEventListener('click', () => {
          if (validateStep2()) {
            updateWizardStep(3, true);
          }
        });
      }
      
      // Step 3 navigation
      const step3PrevBtn = document.getElementById('step3-prev-btn');
      const step3NextBtn = document.getElementById('step3-next-btn');
      if (step3PrevBtn) {
        step3PrevBtn.addEventListener('click', () => updateWizardStep(2, true));
      }
      if (step3NextBtn) {
        step3NextBtn.addEventListener('click', () => {
          if (validateStep3()) {
            updateSettingsSummary();
            updateWizardStep(4, true);
          }
        });
      }
      
      // Step 4 navigation
      const step4PrevBtn = document.getElementById('step4-prev-btn');
      const finalPreviewBtn = document.getElementById('final-preview-btn');
      const finalPublishBtn = document.getElementById('final-publish-btn');
      const editSettingsBtn = document.getElementById('edit-settings-btn');
      
      if (step4PrevBtn) {
        step4PrevBtn.addEventListener('click', () => updateWizardStep(3, true));
      }
      if (finalPreviewBtn) {
        finalPreviewBtn.addEventListener('click', openPreview);
      }
      if (finalPublishBtn) {
        finalPublishBtn.addEventListener('click', publishBoard);
      }
      if (editSettingsBtn) {
        editSettingsBtn.addEventListener('click', () => updateWizardStep(3, true));
      }
      
      // Quick add functionality for no-sheet state
      const quickAddBtn = document.getElementById('quick-add-btn');
      if (quickAddBtn) {
        quickAddBtn.addEventListener('click', () => {
          const urlInput = document.getElementById('quick-spreadsheet-url');
          if (urlInput && urlInput.value.trim()) {
            addSpreadsheetFromUrl(urlInput.value.trim());
            urlInput.value = '';
          }
        });
      }
    }
    
    // Validation functions
    function validateStep1() {
      // Check if at least one spreadsheet is available
      if (!elements.sheetSelect || elements.sheetSelect.options.length <= 1) {
        showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚', 'red');
        return false;
      }
      return true;
    }
    
    function validateStep2() {
      if (!selectedSheet) {
        showMessage('ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'red');
        return false;
      }
      return true;
    }
    
    function validateStep3() {
      if (!elements.qHeader.value && !elements.aHeader.value) {
        showMessage('å•é¡Œæ–‡ã¾ãŸã¯å›ç­”ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'red');
        return false;
      }
      return true;
    }
    
    // Update settings summary
    function updateSettingsSummary() {
      document.getElementById('summary-sheet').textContent = selectedSheet || 'æœªé¸æŠ';
      document.getElementById('summary-question').textContent = elements.qHeader.value || 'æœªè¨­å®š';
      document.getElementById('summary-answer').textContent = elements.aHeader.value || 'æœªè¨­å®š';
      document.getElementById('summary-reason').textContent = elements.rHeader.value || 'æœªè¨­å®š';
      document.getElementById('summary-name').textContent = elements.nameHeader.value || 'æœªè¨­å®š';
      document.getElementById('summary-class').textContent = elements.classHeader.value || 'æœªè¨­å®š';
      
      // Enable publish button if basic requirements are met
      const finalPublishBtn = document.getElementById('final-publish-btn');
      if (finalPublishBtn) {
        const canPublish = selectedSheet && (elements.qHeader.value || elements.aHeader.value);
        finalPublishBtn.disabled = !canPublish;
      }
    }
    
    // Publish board function
    function publishBoard() {
      if (!selectedSheet) {
        showMessage('å…¬é–‹ã™ã‚‹ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'red');
        return;
      }
      
      // Save config first, then activate sheet
      const config = {
        questionHeader: elements.qHeader.value || elements.aHeader.value,
        answerHeader: elements.aHeader.value || elements.qHeader.value,
        reasonHeader: elements.rHeader.value,
        nameHeader: elements.nameHeader.value,
        classHeader: elements.classHeader.value
      };
      
      setLoading(true, 'è¨­å®šã‚’ä¿å­˜ä¸­...');
      google.script.run
        .withSuccessHandler((msg) => {
          showMessage('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'green');
          // Now activate the sheet
          activateSheet();
        })
        .withFailureHandler(showError)
        .saveSheetConfig(selectedSheet, config);
    }
    
    function activateSheet() {
      setLoading(true, 'ã‚·ãƒ¼ãƒˆã‚’å…¬é–‹ä¸­...');
      google.script.run
        .withSuccessHandler((msg) => {
          showMessage('å›ç­”ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼', 'green');
          loadInitialState(); // Refresh the state
        })
        .withFailureHandler(showError)
        .switchActiveSheet(selectedSheet);
    }
    
    // Add spreadsheet from URL
    function addSpreadsheetFromUrl(url) {
      if (!url.includes('docs.google.com/spreadsheets')) {
        showMessage('æœ‰åŠ¹ãªGoogleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'red');
        return;
      }
      
      setLoading(true, 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ä¸­...');
      google.script.run
        .withSuccessHandler((result) => {
          showMessage(result.message, 'green');
          loadInitialState(); // Refresh to load new sheets
        })
        .withFailureHandler(showError)
        .addSpreadsheetUrl(url);
    }
    
    // Update navigation button states
    function updateNavigationButtons() {
      // Step 1
      const step1NextBtn = document.getElementById('step1-next-btn');
      if (step1NextBtn) {
        step1NextBtn.disabled = !validateStep1();
      }
      
      // Step 2  
      const step2NextBtn = document.getElementById('step2-next-btn');
      if (step2NextBtn) {
        step2NextBtn.disabled = !selectedSheet;
      }
      
      // Step 3
      const step3NextBtn = document.getElementById('step3-next-btn');
      if (step3NextBtn) {
        step3NextBtn.disabled = !validateStep3();
      }
    }

    function loadInitialState() {
      setLoading(true, "çŠ¶æ…‹ã‚’æ›´æ–°ä¸­...");
      google.script.run
        .withSuccessHandler(updateUI)
        .withFailureHandler(showError)
        .withUserObject({ userId: userId })
        .getAdminSettings();
    }

    function updateUI(status) {
      currentActiveSheet = status.activeSheetName;
      selectedSheet = status.activeSheetName;
      elements.configArea.classList.toggle('hidden', !selectedSheet);

      // Update dashboard cards
      const answerCount = status.answerCount || 0;
      const totalReactions = status.totalReactions || 0;
      
      document.getElementById('board-status').textContent = status.activeSheetName ? 'åˆ©ç”¨ä¸­' : 'æº–å‚™ä¸­';
      document.getElementById('answer-count').textContent = answerCount;
      document.getElementById('reaction-count').textContent = totalReactions;
      
      // Update dashboard card colors based on status
      const statusCard = document.querySelector('#board-status').closest('.glass-panel');
      if (status.activeSheetName && statusCard) {
        const statusIconDiv = statusCard.querySelector('div.w-12');
        const statusSvg = statusCard.querySelector('svg');
        if (statusIconDiv && statusIconDiv.className.includes('rounded-full')) {
          statusIconDiv.className = 'w-12 h-12 mx-auto mb-3 rounded-full bg-green-500/20 flex items-center justify-center';
        }
        if (statusSvg) {
          statusSvg.className = 'w-6 h-6 text-green-400';
        }
      }

      if (elements.detailOptions) {
        const radios = elements.detailOptions.querySelectorAll('input[name="showDetails"]');
        radios.forEach(r => { r.checked = r.value === String(status.showDetails); r.onchange = () => updateShowDetails(r.value); });
      }
      
      // å›ç­”ãƒœãƒ¼ãƒ‰ã®çŠ¶æ…‹è¡¨ç¤º
      if (status.activeSheetName) {
        elements.statusText.innerHTML = `<span class="font-bold text-green-400">åˆ©ç”¨å¯èƒ½</span> - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆ: <span class="font-bold text-blue-400">${escapeHtml(status.activeSheetName)}</span><br>
        <span class="text-sm text-gray-300">å›ç­”æ•°: ${answerCount}ä»¶ | ç·ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°: ${totalReactions}ä»¶</span>`;
        // ç”Ÿå¾’ç”¨URLã‚’è¡¨ç¤º
        const baseUrl = status.webAppUrl || (window.location.origin + window.location.pathname);
        const boardUrl = `${baseUrl}?userId=${userId}`;
        elements.boardUrl.value = boardUrl;
        elements.viewBoardLink.href = boardUrl;
        elements.boardUrlSection.classList.remove('hidden');
        elements.noSheetMessage.classList.add('hidden');
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã‚‚è‡ªå‹•é€²è¡Œã—ãªã„
      } else {
        elements.statusText.innerHTML = '<span class="font-bold text-yellow-400">æœªè¨­å®š</span> - ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦åˆ©ç”¨ã‚’é–‹å§‹ã—ã¦ãã ã•ã„';
        elements.boardUrlSection.classList.add('hidden');
        elements.noSheetMessage.classList.remove('hidden');
      }
      
      elements.sheetSelect.innerHTML = '';
      if (status.allSheets && status.allSheets.length > 0) {
        elements.sheetSelect.innerHTML = '<option value="">-- ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
        status.allSheets.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          elements.sheetSelect.appendChild(opt);
        });
        elements.sheetSelect.disabled = false;
        if (status.activeSheetName) {
          elements.sheetSelect.value = status.activeSheetName;
        }
      } else {
        elements.sheetSelect.innerHTML = '<option value="">è¡¨ç¤ºã§ãã‚‹ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
        elements.sheetSelect.disabled = true;
      }

      elements.sheetSelect.onchange = () => {
        selectedSheet = elements.sheetSelect.value;
        elements.switchSheetBtn.disabled = !selectedSheet;
        elements.configArea.classList.toggle('hidden', !selectedSheet);
        
        // ã‚·ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‹•çš„ã«å¤‰æ›´
        if (selectedSheet && selectedSheet === currentActiveSheet) {
          elements.switchSheetBtn.textContent = 'ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆ';
          elements.switchSheetBtn.disabled = true;
        } else if (selectedSheet) {
          elements.switchSheetBtn.textContent = `ğŸš€ã€Œ${selectedSheet}ã€ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹`;
          elements.switchSheetBtn.disabled = false;
        } else {
          elements.switchSheetBtn.textContent = 'ã“ã®ã‚·ãƒ¼ãƒˆã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹';
          elements.switchSheetBtn.disabled = true;
        }
        
        loadConfigForSelected();
        updateNavigationButtons(); // Update navigation button states
      };

      // åˆæœŸçŠ¶æ…‹ã®ãƒœã‚¿ãƒ³è¨­å®š
      elements.switchSheetBtn.disabled = !selectedSheet || selectedSheet === currentActiveSheet;
      elements.clearSelectionBtn.disabled = !currentActiveSheet;
      
      loadConfigForSelected();
      updateNavigationButtons(); // Update navigation button states
      setLoading(false);
    }

    function addSpreadsheet() {
      const urlInput = document.getElementById('spreadsheet-url-input');
      const url = urlInput.value.trim();
      
      if (!url) {
        showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'red');
        return;
      }
      
      if (!url.includes('docs.google.com/spreadsheets')) {
        showMessage('æœ‰åŠ¹ãªGoogleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'red');
        return;
      }
      
      setLoading(true, 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ä¸­...');
      google.script.run
        .withSuccessHandler((result) => {
          showMessage(result.message, 'green');
          urlInput.value = '';
          // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¿½åŠ å¾Œã€çŠ¶æ…‹ã‚’å†èª­ã¿è¾¼ã¿
          loadInitialState();
          updateNavigationButtons();
        })
        .withFailureHandler(showError)
        .addSpreadsheetUrl(url);
    }

    function switchToSelectedSheet() {
      if (!selectedSheet) return;
      setLoading(true, 'ã‚·ãƒ¼ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆä¸­...');
      google.script.run
        .withSuccessHandler((msg) => {
          showMessage(msg, 'green');
          loadInitialState();
        })
        .withFailureHandler(showError)
        .switchActiveSheet(selectedSheet);
    }

    function clearSheetSelection() {
      if (!confirm('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿç”Ÿå¾’ã¯å›ç­”ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚')) return;
      setLoading(true, 'ã‚·ãƒ¼ãƒˆé¸æŠã‚’ã‚¯ãƒªã‚¢ä¸­...');
      google.script.run
        .withSuccessHandler((msg) => {
          showMessage(msg, 'green');
          loadInitialState();
        })
        .withFailureHandler(showError)
        .clearActiveSheet();
    }

    function updateShowDetails(val) {
      setLoading(true, 'è¡¨ç¤ºè¨­å®šã‚’æ›´æ–°ä¸­...');
      google.script.run
        .withSuccessHandler((msg) => { showMessage(msg, 'green'); setLoading(false); })
        .withFailureHandler(showError)
        .setShowDetails(val === 'true');
    }

    function loadConfigForSelected() {
      if (!selectedSheet) {
        elements.configArea.classList.add('hidden');
        clearConfigFields();
        return;
      }
      elements.configArea.classList.remove('hidden');
      google.script.run
        .withSuccessHandler((headers) => {
          populateHeaderOptions(headers);
          const guesses = guessHeaders(headers);
          populateConfig(guesses);
          google.script.run
            .withSuccessHandler(cfg => {
              // Merge server config with guesses, prioritizing server config
              populateConfig(Object.assign({}, guesses, cfg));
            })
            .withFailureHandler((error) => {
              // Handle config not found - create default config from guesses
              console.log('Config not found for sheet, using guessed headers:', error);
              showMessage('æ–°ã—ã„ã‚·ãƒ¼ãƒˆã®è¨­å®šã‚’è‡ªå‹•æ¨æ¸¬ã—ã¾ã—ãŸã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'blue');
              // Save the guessed config automatically for new sheets
              if (guesses.questionHeader || guesses.answerHeader) {
                const defaultConfig = {
                  questionHeader: guesses.questionHeader || guesses.answerHeader || '',
                  answerHeader: guesses.answerHeader || guesses.questionHeader || '',
                  reasonHeader: guesses.reasonHeader || '',
                  nameHeader: guesses.nameHeader || '',
                  classHeader: guesses.classHeader || ''
                };
                google.script.run
                  .withSuccessHandler(() => {
                    console.log('Default config saved for new sheet');
                  })
                  .withFailureHandler((saveError) => {
                    console.error('Failed to save default config:', saveError);
                  })
                  .saveSheetConfig(selectedSheet, defaultConfig);
              }
            })
            .getConfig(selectedSheet);
        })
        .withFailureHandler((error) => {
          console.error('Failed to get sheet headers:', error);
          clearConfigFields();
          showMessage('ã‚·ãƒ¼ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'red');
        })
        .getSheetHeaders(selectedSheet);
    }

    function populateHeaderOptions(headers) {
      const selects = [elements.qHeader, elements.aHeader, elements.rHeader, elements.nameHeader, elements.classHeader];
      selects.forEach(sel => {
        sel.innerHTML = '<option value=""></option>';
        headers.forEach(h => {
          const opt = document.createElement('option');
          opt.value = h;
          opt.textContent = h;
          sel.appendChild(opt);
        });
      });
    }

    function guessHeaders(headers) {
      const find = (keys) => headers.find(h => keys.some(k => h.includes(k))) || '';
      const question = find(['è³ªå•', 'å•é¡Œ']);
      const answer = find(['å›ç­”', 'ç­”ãˆ']);
      return {
        questionHeader: question,
        answerHeader: answer,
        reasonHeader: find(['ç†ç”±']),
        nameHeader: find(['åå‰', 'æ°å']),
        classHeader: find(['ã‚¯ãƒ©ã‚¹'])
      };
    }

    function populateConfig(cfg) {
      const q = cfg.questionHeader || cfg.answerHeader || '';
      elements.qHeader.value = q;
      elements.aHeader.value = cfg.answerHeader || cfg.questionHeader || '';
      elements.rHeader.value = cfg.reasonHeader || '';
      elements.nameHeader.value = cfg.nameHeader || '';
      elements.classHeader.value = cfg.classHeader || '';
    }

    function clearConfigFields() {
      [elements.qHeader, elements.aHeader, elements.rHeader, elements.nameHeader, elements.classHeader].forEach(sel => {
        sel.innerHTML = '<option value=""></option>';
        sel.value = '';
      });
    }

    function saveConfig() {
      if (!selectedSheet) {
        showMessage('ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'red');
        return;
      }
      const qVal = elements.qHeader.value;
      const aVal = elements.aHeader.value || qVal;
      const cfg = {
        questionHeader: qVal || aVal,
        answerHeader: aVal || qVal,
        reasonHeader: elements.rHeader.value,
        nameHeader: elements.nameHeader.value,
        classHeader: elements.classHeader.value
      };
      setLoading(true, 'è¨­å®šã‚’ä¿å­˜ä¸­...');
      google.script.run
        .withSuccessHandler((msg) => { 
          showMessage(msg, 'green'); 
          setLoading(false);
          // è¨­å®šä¿å­˜å¾Œã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºèªã—ã¦ã‹ã‚‰æ¬¡ã¸é€²ã‚€
        })
        .withFailureHandler(showError)
        .saveSheetConfig(selectedSheet, cfg);
    }

    function setLoading(isLoading, msg = "") {
      elements.switchSheetBtn.disabled = isLoading;
      elements.clearSelectionBtn.disabled = isLoading;
      if (isLoading) {
          showMessage(msg, 'blue');
      }
    }
    
    function copyBoardUrl() {
      const url = elements.boardUrl.value;
      if (url) {
        navigator.clipboard.writeText(url).then(() => {
          showMessage('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'green');
        }).catch(() => {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®æ–¹æ³•
          elements.boardUrl.select();
          document.execCommand('copy');
          showMessage('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'green');
        });
      }
    }

    function showMessage(msg, color = 'red') {
      const colorClasses = { red: 'text-red-600', green: 'text-green-600', blue: 'text-blue-600' };
      elements.messageArea.className = `mt-4 text-center text-sm h-5 ${colorClasses[color]}`;
      elements.messageArea.textContent = msg;
    }
    
    function showError(error) {
      showMessage(error.message, 'red');
      setLoading(false);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>