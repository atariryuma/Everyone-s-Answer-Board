<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <title>StudyQuest - 管理画面</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --color-primary: #8be9fd;
      --color-background: #1a1b26;
      --color-surface: rgba(26, 27, 38, 0.7);
      --color-text: #c0caf5;
      --color-border: rgba(255, 255, 255, 0.1);
      --color-success: #10b981;
      --color-error: #ef4444;
      --color-warning: #f59e0b;
    }
    
    body {
      margin: 0;
      background: var(--color-background);
      color: var(--color-text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    .glass-panel {
      background: var(--color-surface);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      border: 1px solid var(--color-border);
      transition: all 0.3s ease;
    }
    
    .glass-panel:hover {
      border-color: rgba(255, 255, 255, 0.2);
      transform: translate3d(0, -2px, 0);
    }
    
    button:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    
    button:not(:disabled):hover {
      transform: translate3d(0, -2px, 0);
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
    
    button:active:not(:disabled) {
      transform: translate3d(0, 0, 0);
    }
    
    :focus-visible { 
      outline: 3px solid var(--color-primary); 
      outline-offset: 2px; 
      border-radius: 4px; 
    }
    
    .spinner {
      animation: spin 1s linear infinite;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(139, 233, 253, 0.3);
      border-top: 2px solid var(--color-primary);
      border-radius: 50%;
    }
    
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    
    .status-success { background: var(--color-success); }
    .status-warning { background: var(--color-warning); }
    .status-error { background: var(--color-error); }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      max-width: 400px;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    
    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .notification.success { background: var(--color-success); }
    .notification.error { background: var(--color-error); }
    .notification.warning { background: var(--color-warning); }
  </style>
</head>
<body>
  <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <!-- ヘッダー -->
    <header class="relative overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-r from-cyan-400/10 to-purple-400/10"></div>
      <div class="relative max-w-4xl mx-auto px-6 py-8">
        <div class="text-center">
          <h1 class="text-4xl font-bold bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent mb-2">
            StudyQuest
          </h1>
          <p class="text-lg text-slate-400">管理画面</p>
        </div>
      </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="max-w-4xl mx-auto px-6 pb-20">
      <!-- ステータス概要 -->
      <div class="glass-panel rounded-2xl p-8 mb-8 fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <span class="w-8 h-8 bg-gradient-to-r from-cyan-400 to-purple-400 rounded-lg flex items-center justify-center">
            📊
          </span>
          システム状態
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-gradient-to-r from-blue-500/10 to-cyan-500/10 rounded-xl p-6 border border-blue-400/20">
            <div class="flex items-center justify-between mb-4">
              <span class="text-blue-400 font-medium">スプレッドシート</span>
              <span id="spreadsheet-status" class="flex items-center">
                <span class="status-dot status-warning"></span>
                <span class="text-sm">未設定</span>
              </span>
            </div>
            <p id="spreadsheet-name" class="text-2xl font-bold text-white">--</p>
          </div>
          
          <div class="bg-gradient-to-r from-green-500/10 to-emerald-500/10 rounded-xl p-6 border border-green-400/20">
            <div class="flex items-center justify-between mb-4">
              <span class="text-green-400 font-medium">総回答数</span>
              <span class="text-green-400">📝</span>
            </div>
            <p id="total-answers" class="text-2xl font-bold text-white">0</p>
          </div>
          
          <div class="bg-gradient-to-r from-purple-500/10 to-pink-500/10 rounded-xl p-6 border border-purple-400/20">
            <div class="flex items-center justify-between mb-4">
              <span class="text-purple-400 font-medium">アクティブシート</span>
              <span class="text-purple-400">📋</span>
            </div>
            <p id="active-sheet" class="text-lg font-bold text-white">--</p>
          </div>
        </div>
      </div>

      <!-- スプレッドシート設定 -->
      <div class="glass-panel rounded-2xl p-8 mb-8 fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <span class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-400 rounded-lg flex items-center justify-center">
            🆕
          </span>
          スプレッドシート設定
        </h2>
        
        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-3">
              GoogleスプレッドシートURL
            </label>
            <input 
              type="url" 
              id="spreadsheet-url" 
              placeholder="https://docs.google.com/spreadsheets/d/..."
              class="w-full p-4 bg-slate-800/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition-all"
            >
          </div>
          
          <button 
            type="button" 
            id="setup-button" 
            onclick="setupSpreadsheet()"
            class="w-full md:w-auto px-8 py-4 bg-gradient-to-r from-cyan-400 to-purple-400 text-black font-bold rounded-xl hover:from-cyan-300 hover:to-purple-300 transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:transform-none"
          >
            🚀 スプレッドシートを設定
          </button>
        </div>
      </div>

      <!-- シート管理 -->
      <div class="glass-panel rounded-2xl p-8 mb-8 fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <span class="w-8 h-8 bg-gradient-to-r from-green-400 to-teal-400 rounded-lg flex items-center justify-center">
            📋
          </span>
          シート管理
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-3">
              アクティブシート選択
            </label>
            <select 
              id="sheet-select" 
              onchange="switchSheet()"
              class="w-full p-4 bg-slate-800/50 border border-slate-600 rounded-xl text-white focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition-all"
            >
              <option value="">シートを選択してください</option>
            </select>
          </div>
          
          <div class="flex flex-col justify-end">
            <button 
              type="button" 
              onclick="refreshSheets()"
              class="px-6 py-4 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all duration-300"
            >
              🔄 シート一覧を更新
            </button>
          </div>
        </div>
      </div>

      <!-- クイックアクション -->
      <div class="glass-panel rounded-2xl p-8 fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <span class="w-8 h-8 bg-gradient-to-r from-orange-400 to-red-400 rounded-lg flex items-center justify-center">
            ⚡
          </span>
          クイックアクション
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button 
            type="button" 
            onclick="openBoard()"
            class="p-6 bg-gradient-to-r from-blue-500/20 to-purple-500/20 border border-blue-400/30 rounded-xl text-left hover:border-blue-400/50 transition-all"
          >
            <div class="text-2xl mb-2">📖</div>
            <div class="text-lg font-semibold text-white">ボードを開く</div>
            <div class="text-sm text-slate-400">回答ボードを新しいタブで開きます</div>
          </button>
          
          <button 
            type="button" 
            onclick="exportData()"
            class="p-6 bg-gradient-to-r from-green-500/20 to-teal-500/20 border border-green-400/30 rounded-xl text-left hover:border-green-400/50 transition-all"
          >
            <div class="text-2xl mb-2">📊</div>
            <div class="text-lg font-semibold text-white">データ出力</div>
            <div class="text-sm text-slate-400">回答データをエクスポートします</div>
          </button>
        </div>
      </div>
    </main>

    <!-- ローディングオーバーレイ -->
    <div id="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="glass-panel rounded-2xl p-8 flex items-center space-x-4">
        <div class="spinner"></div>
        <span id="loading-message" class="text-white font-medium">処理中...</span>
      </div>
    </div>
  </div>

  <script>
    // 通知システム
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }
    
    // ローディング表示
    function setLoading(show, message = '処理中...') {
      const loading = document.getElementById('loading');
      const loadingMessage = document.getElementById('loading-message');
      
      if (show) {
        loadingMessage.textContent = message;
        loading.classList.remove('hidden');
      } else {
        loading.classList.add('hidden');
      }
    }
    
    // ステータス更新
    function updateStatus() {
      setLoading(true, 'ステータスを取得中...');
      
      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            updateStatusDisplay(result.data);
          }
          setLoading(false);
        })
        .withFailureHandler((error) => {
          console.error('Status update failed:', error);
          setLoading(false);
        })
        .getDashboardData();
    }
    
    // ステータス表示更新
    function updateStatusDisplay(data) {
      const spreadsheetStatus = document.getElementById('spreadsheet-status');
      const spreadsheetName = document.getElementById('spreadsheet-name');
      const totalAnswers = document.getElementById('total-answers');
      const activeSheet = document.getElementById('active-sheet');
      
      if (data.hasActiveSpreadsheet) {
        spreadsheetStatus.innerHTML = `
          <span class="status-dot status-success"></span>
          <span class="text-sm text-green-400">接続済み</span>
        `;
        spreadsheetName.textContent = '設定済み';
      } else {
        spreadsheetStatus.innerHTML = `
          <span class="status-dot status-warning"></span>
          <span class="text-sm text-yellow-400">未設定</span>
        `;
        spreadsheetName.textContent = '--';
      }
      
      totalAnswers.textContent = data.totalAnswers || 0;
      activeSheet.textContent = data.activeSheetName || '--';
    }
    
    // スプレッドシート設定
    function setupSpreadsheet() {
      const urlInput = document.getElementById('spreadsheet-url');
      const url = urlInput.value.trim();
      
      if (!url) {
        showNotification('スプレッドシートURLを入力してください', 'warning');
        return;
      }
      
      if (!url.includes('docs.google.com/spreadsheets')) {
        showNotification('有効なGoogleスプレッドシートURLを入力してください', 'error');
        return;
      }
      
      setLoading(true, 'スプレッドシートを設定中...');
      
      const spreadsheetId = extractSpreadsheetId(url);
      
      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            showNotification('スプレッドシートの設定が完了しました', 'success');
            urlInput.value = '';
            updateStatus();
            loadSheets();
          } else {
            showNotification(result?.message || 'スプレッドシートの設定に失敗しました', 'error');
          }
          setLoading(false);
        })
        .withFailureHandler((error) => {
          showNotification('設定中にエラーが発生しました', 'error');
          setLoading(false);
        })
        .setupSpreadsheet(spreadsheetId);
    }
    
    // スプレッドシートID抽出
    function extractSpreadsheetId(url) {
      const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return match ? match[1] : url;
    }
    
    // シート一覧読み込み
    function loadSheets() {
      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            updateSheetSelect(result.sheets);
          } else {
            console.warn('Sheet loading failed:', result?.message);
          }
        })
        .withFailureHandler((error) => {
          console.error('Sheet loading error:', error);
        })
        .getAvailableSheets();
    }
    
    // シート選択更新
    function updateSheetSelect(sheets) {
      const sheetSelect = document.getElementById('sheet-select');
      sheetSelect.innerHTML = '<option value="">シートを選択してください</option>';
      
      if (sheets && sheets.length > 0) {
        sheets.forEach(sheet => {
          const option = document.createElement('option');
          option.value = sheet.name;
          option.textContent = sheet.name;
          if (sheet.isActive) {
            option.selected = true;
          }
          sheetSelect.appendChild(option);
        });
      }
    }
    
    // シート更新
    function refreshSheets() {
      setLoading(true, 'シート一覧を更新中...');
      
      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            updateSheetSelect(result.sheets);
            showNotification('シート一覧を更新しました', 'success');
          } else {
            showNotification(result?.message || 'シート一覧の取得に失敗しました', 'error');
          }
          setLoading(false);
        })
        .withFailureHandler((error) => {
          showNotification('シート一覧の更新中にエラーが発生しました', 'error');
          setLoading(false);
        })
        .getAvailableSheets();
    }
    
    // シート切り替え
    function switchSheet() {
      const selectedSheet = document.getElementById('sheet-select').value;
      if (!selectedSheet) return;
      
      setLoading(true, 'シートを切り替え中...');
      
      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            showNotification('シートを切り替えました', 'success');
            updateStatus();
          } else {
            showNotification(result?.message || 'シートの切り替えに失敗しました', 'error');
          }
          setLoading(false);
        })
        .withFailureHandler((error) => {
          showNotification('切り替え中にエラーが発生しました', 'error');
          setLoading(false);
        })
        .switchToSheet(selectedSheet);
    }
    
    // ボードを開く
    function openBoard() {
      const baseUrl = window.location.origin + window.location.pathname;
      const boardUrl = baseUrl + '?action=view';
      window.open(boardUrl, '_blank');
    }
    
    // データ出力
    function exportData() {
      showNotification('データ出力機能は開発中です', 'warning');
    }
    
    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      updateStatus();
      loadSheets();
    });
  </script>
</body>
</html>