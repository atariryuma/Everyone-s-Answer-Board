<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <title>StudyQuest ç®¡ç†ãƒ‘ãƒãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Shared Security Headers -->
  <?!= include('SharedSecurityHeaders'); ?>
  <!-- Shared TailwindCSS Configuration -->
  <?!= include('SharedTailwindConfig'); ?>
  <?!= include('UnifiedStyles'); ?>
  <?!= include('SharedUtilities'); ?>
  <script>
    const __USER_ID__ = '<?= typeof userId !== "undefined" ? userId : "" ?>';
  </script>
  <style>
    /* AdminPanelå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« - commit 421e817 ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹é€  + ç¾åœ¨ã®ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
    body { 
      margin: 0; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh;
    }

    .admin-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1rem;
      min-height: 100vh;
      padding: 1rem;
    }

    .main-editor {
      padding: 1.5rem;
    }

    .info-panel {
      padding: 1rem;
      overflow-y: auto;
    }

    .card {
      margin-bottom: 1rem;
    }

    .info-card {
      margin-bottom: 0.75rem;
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .status-header {
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .system-monitor {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
      color: #64748b;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
    }

    .status-indicator.active {
      background-color: #10b981;
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
    }

    .status-indicator.warning {
      background-color: #f59e0b;
    }

    .status-indicator.error {
      background-color: #ef4444;
    }

    /* é€²æ—ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç°¡ç´ åŒ– */
    .setup-progress {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .step {
      flex: 1;
      text-align: center;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      background: rgba(107, 114, 128, 0.1);
      color: rgba(156, 163, 175, 1);
      transition: all 0.2s;
    }

    .step.completed {
      background: rgba(34, 197, 94, 0.2);
      color: rgba(34, 197, 94, 1);
    }

    .step.current {
      background: rgba(59, 130, 246, 0.2);
      color: rgba(59, 130, 246, 1);
      border: 2px solid rgba(59, 130, 246, 0.5);
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  - Tailwindã‚¹ã‚¿ã‚¤ãƒ«ã§ç½®ãæ›ãˆ */
    .form-group {
      margin-bottom: 1rem;
    }

    .modern-select, input[type="text"] {
      width: 100%;
      padding: 0.75rem;
      background: rgba(55, 65, 81, 0.8);
      border: 1px solid rgba(75, 85, 99, 0.5);
      border-radius: 0.5rem;
      color: white;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .modern-select:focus, input[type="text"]:focus {
      outline: none;
      border-color: rgba(59, 130, 246, 0.8);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ - ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
    .toggle-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      color: rgba(209, 213, 219, 1);
    }

    .toggle-switch input {
      display: none;
    }

    .slider {
      width: 44px;
      height: 24px;
      background: rgba(107, 114, 128, 0.5);
      border-radius: 12px;
      position: relative;
      transition: all 0.3s;
    }

    .slider:before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: all 0.3s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .toggle-switch input:checked + .slider {
      background: rgba(59, 130, 246, 0.8);
    }

    .toggle-switch input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* ãƒœã‚¿ãƒ³ - ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
    .btn-primary, .btn-secondary {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: linear-gradient(to right, rgba(59, 130, 246, 1), rgba(147, 51, 234, 1));
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(to right, rgba(37, 99, 235, 1), rgba(126, 34, 206, 1));
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(75, 85, 99, 0.5);
      color: rgba(209, 213, 219, 1);
      border: 1px solid rgba(107, 114, 128, 0.5);
    }

    .btn-secondary:hover {
      background: rgba(75, 85, 99, 0.7);
    }

    .action-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    /* å³ãƒ‘ãƒãƒ«ã®æƒ…å ±è¡¨ç¤º - ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
    .config-summary {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: rgba(55, 65, 81, 0.8);
      border-radius: 0.5rem;
      color: rgba(209, 213, 219, 1);
    }

    .label {
      font-weight: 500;
      color: rgba(156, 163, 175, 1);
      font-size: 0.875rem;
    }

    .link-btn {
      background: rgba(59, 130, 246, 0.2);
      color: rgba(96, 165, 250, 1);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .link-btn:hover {
      background: rgba(59, 130, 246, 0.3);
    }

    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-badge.unpublished {
      background: rgba(245, 158, 11, 0.2);
      color: rgba(245, 158, 11, 1);
    }

    .status-badge.published {
      background: rgba(34, 197, 94, 0.2);
      color: rgba(34, 197, 94, 1);
    }

    .status-badge.error {
      background: rgba(239, 68, 68, 0.2);
      color: rgba(239, 68, 68, 1);
    }

    /* ç°¡ç´ åŒ–ã•ã‚ŒãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º */
    .metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .metric {
      text-align: center;
      padding: 1rem;
      background: rgba(55, 65, 81, 0.8);
      border-radius: 0.75rem;
      border: 1px solid rgba(75, 85, 99, 0.5);
      flex: 1;
      min-width: 200px;
    }

    .metric .value {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      color: rgba(96, 165, 250, 1);
    }

    .metric .unit {
      font-size: 0.875rem;
      color: rgba(156, 163, 175, 1);
    }

    /* JSONè¡¨ç¤º - ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
    .json-viewer {
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(75, 85, 99, 0.5);
      border-radius: 0.5rem;
      padding: 1rem;
      font-family: 'Monaco', 'Menlo', 'SF Mono', monospace;
      font-size: 0.8rem;
      color: rgba(209, 213, 219, 1);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .expandable-section {
      margin-top: 0.75rem;
    }

    .expandable-section summary {
      cursor: pointer;
      font-weight: 500;
      color: rgba(96, 165, 250, 1);
      padding: 0.75rem 0;
    }

    /* åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤º - ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
    .auto-detected-columns {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .column-match {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 0.5rem;
    }

    .column-type {
      font-weight: 600;
      color: rgba(34, 197, 94, 1);
    }

    .detected-column {
      background: rgba(34, 197, 94, 0.2);
      color: rgba(34, 197, 94, 1);
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .confidence {
      font-size: 0.8rem;
      color: rgba(34, 197, 94, 0.8);
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @media (max-width: 768px) {
      .admin-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
        padding: 1rem;
      }
      
      .status-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .setup-progress {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .metrics {
        flex-direction: column;
      }
      
      .metric {
        min-width: unset;
      }
    }

    /* SharedUtilitiesã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ */
  </style>
</head>
<body>
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[9999] hidden">
        <div class="loading-spinner w-16 h-16 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-[10000] space-y-2"></div>
    
  <div class="admin-container">
    <!-- å·¦ãƒ‘ãƒãƒ«: ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ -->
    <div class="main-editor">
      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <header class="status-header glass-panel rounded-xl">
        <h1 class="text-cyan-400 font-bold">StudyQuest ç®¡ç†ãƒ‘ãƒãƒ«</h1>
        <div class="system-monitor">
          <span><span class="status-indicator active"></span>æ¥ç¶šæ­£å¸¸</span>
          <span id="last-update">æœ€çµ‚åŒæœŸ: --:--</span>
          <span id="health-check">DBæ­£å¸¸</span>
        </div>
      </header>

      <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é€²æ— -->
      <div class="setup-progress">
        <div class="step completed">1. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</div>
        <div class="step current">2. åˆ—è¨­å®š</div>
        <div class="step">3. å…¬é–‹</div>
      </div>

      <!-- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠã‚«ãƒ¼ãƒ‰ -->
      <section class="card glass-panel rounded-xl p-6">
        <h2 class="text-xl font-semibold text-white mb-4">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ</h2>
        <div class="space-y-4">
          <div class="form-group">
            <label for="spreadsheet-select" class="block text-sm font-medium text-gray-300 mb-2">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ:</label>
            <select id="spreadsheet-select" class="modern-select">
              <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="sheet-select" class="block text-sm font-medium text-gray-300 mb-2">ã‚·ãƒ¼ãƒˆ:</label>
            <select id="sheet-select" class="modern-select">
              <option value="">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          <div class="action-buttons">
            <button id="refresh-data" class="btn-secondary" type="button">ğŸ”„ æ›´æ–°</button>
            <button id="connect-source" class="btn-primary" type="button">æ¥ç¶š</button>
          </div>
        </div>
      </section>

      <!-- åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ -->
      <section class="card glass-panel rounded-xl p-6">
        <h2 class="text-xl font-semibold text-white mb-4">ğŸ“‹ åˆ—è¨­å®š</h2>
        <div class="auto-detected-columns mb-4">
          <div class="column-match">
            <span class="column-type">è³ªå•</span>
            <span class="detected-column">Aåˆ—</span>
            <span class="confidence">95%ç¢ºä¿¡åº¦</span>
          </div>
          <div class="column-match">
            <span class="column-type">å›ç­”è€…</span>
            <span class="detected-column">Båˆ—</span>
            <span class="confidence">88%ç¢ºä¿¡åº¦</span>
          </div>
          <div class="column-match">
            <span class="column-type">ç†ç”±</span>
            <span class="detected-column">Cåˆ—</span>
            <span class="confidence">92%ç¢ºä¿¡åº¦</span>
          </div>
        </div>
        <div class="action-buttons">
          <button id="verify-mapping" class="btn-primary" type="button">è¨­å®šã‚’ç¢ºèª</button>
        </div>
      </section>

      <!-- è¡¨ç¤ºè¨­å®šã‚«ãƒ¼ãƒ‰ -->
      <section class="card glass-panel rounded-xl p-6">
        <h2 class="text-xl font-semibold text-white mb-4">âš™ï¸ è¡¨ç¤ºè¨­å®š</h2>
        <div class="toggle-group">
          <label class="toggle-switch">
            <input type="checkbox" id="show-names" checked>
            <span class="slider"></span>
            å›ç­”è€…åã‚’è¡¨ç¤º
          </label>
          <label class="toggle-switch">
            <input type="checkbox" id="show-reactions" checked>
            <span class="slider"></span>
            ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’è¡¨ç¤º
          </label>
        </div>
      </section>

      <!-- å…¬é–‹ã‚«ãƒ¼ãƒ‰ -->
      <section class="card glass-panel rounded-xl p-6">
        <h2 class="text-xl font-semibold text-white mb-4">ğŸš€ å…¬é–‹è¨­å®š</h2>
        <div class="space-y-4">
          <div class="config-item">
            <span class="label">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
            <span class="status-badge unpublished">æœªå…¬é–‹</span>
          </div>
          <div class="form-group">
            <label for="app-name" class="block text-sm font-medium text-gray-300 mb-2">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å:</label>
            <input type="text" id="app-name" placeholder="ä¾‹: ã‚¯ãƒ©ã‚¹è³ªå•ãƒœãƒ¼ãƒ‰" class="w-full">
          </div>
          <div class="action-buttons">
            <button id="save-draft" class="btn-secondary" type="button">ä¸‹æ›¸ãä¿å­˜</button>
            <button id="publish-now" class="btn-primary" type="button">ä»Šã™ãå…¬é–‹</button>
          </div>
        </div>
      </section>
    </div>

    <!-- å³ãƒ‘ãƒãƒ«: æƒ…å ±è¡¨ç¤º -->
    <div class="info-panel">
      <!-- ç¾åœ¨ã®è¨­å®šã‚µãƒãƒªãƒ¼ -->
      <section class="info-card glass-panel rounded-xl p-4">
        <h3 class="text-lg font-semibold text-white mb-3">ğŸ“‹ ç¾åœ¨ã®è¨­å®š</h3>
        <div class="config-summary">
          <div class="config-item">
            <span class="label">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</span>
            <a href="#" class="link-btn" id="open-sheet">ã‚·ãƒ¼ãƒˆã‚’é–‹ã</a>
          </div>
          <div class="config-item">
            <span class="label">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:</span>
            <span class="status-badge unpublished">è¨­å®šä¸­</span>
          </div>
          <div class="config-item">
            <span class="label">æœ€çµ‚æ›´æ–°:</span>
            <span class="text-sm text-gray-400">--:--</span>
          </div>
        </div>
      </section>

      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
      <div class="info-card glass-panel rounded-xl p-4">
        <h3 class="text-lg font-semibold text-white mb-3">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h3>
        <div class="space-y-3">
          <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
            <span class="text-gray-300">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</span>
            <span id="current-user-email" class="text-cyan-400">èª­ã¿è¾¼ã¿ä¸­...</span>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
            <span class="text-gray-300">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</span>
            <span id="current-user-id" class="text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</span>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
            <span class="text-gray-300">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</span>
            <button onclick="window.sharedUtilities.auth.switchToAnotherAccount()" 
                    type="button"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm transition-colors">
              ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
          </div>
        </div>
      </div>

      <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´° -->
      <section class="info-card glass-panel rounded-xl p-4">
        <h3 class="text-lg font-semibold text-white mb-3">ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°</h3>
        <div class="space-y-4">
          <div class="config-item">
            <span class="label">DBæ¥ç¶š:</span>
            <span class="status-badge published">æ­£å¸¸</span>
          </div>
          <details class="expandable-section">
            <summary class="text-cyan-400 cursor-pointer hover:text-cyan-300 transition-colors">è¨­å®šè©³ç´° (JSON)</summary>
            <div class="json-viewer mt-3" id="config-json">
{
  "setupStatus": "pending",
  "spreadsheetId": null,
  "sheetName": null,
  "formCreated": false,
  "appPublished": false,
  "lastUpdated": null
}
            </div>
          </details>
        </div>
      </section>

      <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="info-card glass-panel rounded-xl p-4">
        <h3 class="text-lg font-semibold text-white mb-3">âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
        <div class="space-y-3">
          <button class="link-btn w-full text-center" type="button" onclick="exportConfig()">
            è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          </button>
          <button id="app-setup-btn" class="link-btn w-full text-center hidden" type="button" onclick="goToAppSetup()">
            âš™ï¸ ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢
          </button>
        </div>
      </section>
    </div>
  </div>

  <!-- SharedUtilities.html ã¯ä¸Šéƒ¨ã§æ—¢ã«ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰æ¸ˆã¿ -->

  <script>
    // ç°¡ç´ åŒ–ã•ã‚ŒãŸçŠ¶æ…‹ç®¡ç†
    let systemState = {
      loading: false,
      config: null
    };

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('AdminPanelåˆæœŸåŒ–é–‹å§‹');
      initializePanel();
      checkSystemAdminAccess();
      
      // å®šæœŸçš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      setInterval(updateSystemStatus, 30000); // 30ç§’é–“éš”
    });

    // ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateSystemStatus() {
      updateLastUpdateTime();
    }

    // æœ€çµ‚æ›´æ–°æ™‚åˆ»æ›´æ–°
    function updateLastUpdateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('ja-JP', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      const updateElement = document.getElementById('last-update');
      if (updateElement) {
        updateElement.textContent = `æœ€çµ‚åŒæœŸ: ${timeString}`;
      }
    }

    // ãƒ‘ãƒãƒ«åˆæœŸåŒ– - ç°¡ç´ åŒ–
    function initializePanel() {
      try {
        setLoading(true);
        loadSpreadsheetList();
        loadUserInfo();
        setLoading(false);
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showError('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        setLoading(false);
      }
    }

    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
    function loadSpreadsheetList() {
      const select = document.getElementById('spreadsheet-select');
      select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';
      
      google.script.run
        .withSuccessHandler(function(spreadsheets) {
          select.innerHTML = '<option value="">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';
          spreadsheets.forEach(sheet => {
            const option = document.createElement('option');
            option.value = sheet.id;
            option.textContent = sheet.name;
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
          showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .getSpreadsheetList();
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿
    function loadUserInfo() {
      // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—
      google.script.run
        .withSuccessHandler(function(email) {
          document.getElementById('current-user-email').textContent = email || '--';
        })
        .withFailureHandler(function(error) {
          console.error('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          document.getElementById('current-user-email').textContent = 'ã‚¨ãƒ©ãƒ¼';
        })
        .getCurrentUserEmail();
        
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¡¨ç¤ºï¼ˆ__USER_ID__ãŒã‚ã‚Œã°ä½¿ç”¨ï¼‰
      if (typeof __USER_ID__ !== 'undefined' && __USER_ID__) {
        document.getElementById('current-user-id').textContent = __USER_ID__;
      } else {
        document.getElementById('current-user-id').textContent = 'N/A';
      }
    }

    // ä¸è¦ãªã‚·ã‚¹ãƒ†ãƒ ç›£è¦–æ©Ÿèƒ½ã‚’å‰Šé™¤

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è¨­å®š - SharedUtilitiesã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
    function setLoading(loading) {
      systemState.loading = loading;
      if (window.sharedUtilities && window.sharedUtilities.ui) {
        if (loading) {
          window.sharedUtilities.ui.showLoading();
        } else {
          window.sharedUtilities.ui.hideLoading();
        }
      }
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º (SharedUtilitiesã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨)
    function showError(message) {
      if (window.sharedUtilities && window.sharedUtilities.notifications) {
        window.sharedUtilities.notifications.error(message);
      } else {
        console.error('Error:', message);
        alert('ã‚¨ãƒ©ãƒ¼: ' + message);
      }
    }

    // æˆåŠŸè¡¨ç¤º (SharedUtilitiesã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨)
    function showSuccess(message) {
      if (window.sharedUtilities && window.sharedUtilities.notifications) {
        window.sharedUtilities.notifications.success(message);
      } else {
        console.log('Success:', message);
        alert('æˆåŠŸ: ' + message);
      }
    }


    // è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportConfig() {
      google.script.run
        .withSuccessHandler(function(config) {
          const dataStr = JSON.stringify(config, null, 2);
          const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
          const exportFileDefaultName = 'studyquest-config.json';
          
          const linkElement = document.createElement('a');
          linkElement.setAttribute('href', dataUri);
          linkElement.setAttribute('download', exportFileDefaultName);
          linkElement.click();
          
          showSuccess('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        })
        .withFailureHandler(function(error) {
          console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
          showError('è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .getCurrentConfig();
    }

    // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
    function checkSystemAdminAccess() {
      google.script.run
        .withSuccessHandler(function(isAdmin) {
          if (isAdmin) {
            console.log('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã—ãŸ');
            document.getElementById('app-setup-btn').style.display = 'block';
          } else {
            console.log('ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã—ãŸ');
            document.getElementById('app-setup-btn').style.display = 'none';
          }
        })
        .withFailureHandler(function(error) {
          console.warn('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
          document.getElementById('app-setup-btn').style.display = 'none';
        })
        .checkIsSystemAdmin();
    }

    // ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    function goToAppSetup() {
      setLoading(true);
      google.script.run
        .withSuccessHandler(function(webAppUrl) {
          const setupUrl = webAppUrl + '?mode=appSetup';
          window.open(setupUrl, '_top');
        })
        .withFailureHandler(function(error) {
          console.error('ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®é·ç§»ã‚¨ãƒ©ãƒ¼:', error);
          showError('ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
          setLoading(false);
        })
        .getWebAppUrlCached();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    document.addEventListener('DOMContentLoaded', function() {
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé¸æŠæ™‚
      document.getElementById('spreadsheet-select').addEventListener('change', function() {
        const spreadsheetId = this.value;
        if (spreadsheetId) {
          loadSheetList(spreadsheetId);
        }
      });

      // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒœã‚¿ãƒ³
      document.getElementById('refresh-data').addEventListener('click', function() {
        loadSpreadsheetList();
      });

      // æ¥ç¶šãƒœã‚¿ãƒ³
      document.getElementById('connect-source').addEventListener('click', function() {
        connectToSource();
      });

      // è¨­å®šç¢ºèªãƒœã‚¿ãƒ³
      document.getElementById('verify-mapping').addEventListener('click', function() {
        verifyColumnMapping();
      });

      // ä¸‹æ›¸ãä¿å­˜ãƒœã‚¿ãƒ³
      document.getElementById('save-draft').addEventListener('click', function() {
        saveDraft();
      });

      // å…¬é–‹ãƒœã‚¿ãƒ³
      document.getElementById('publish-now').addEventListener('click', function() {
        publishApp();
      });
    });

    // ã‚·ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
    function loadSheetList(spreadsheetId) {
      const select = document.getElementById('sheet-select');
      select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';
      
      google.script.run
        .withSuccessHandler(function(sheets) {
          select.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';
          sheets.forEach(sheet => {
            const option = document.createElement('option');
            option.value = sheet.name;
            option.textContent = sheet.name;
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          console.error('ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
        })
        .getSheetList(spreadsheetId);
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶š
    function connectToSource() {
      const spreadsheetId = document.getElementById('spreadsheet-select').value;
      const sheetName = document.getElementById('sheet-select').value;
      
      if (!spreadsheetId || !sheetName) {
        showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      setLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«æ¥ç¶šã—ã¾ã—ãŸ');
            // é€²æ—æ›´æ–°
            updateProgress(2);
            // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ›´æ–°
            updateColumnMapping(result.columnMapping);
          } else {
            showError(result.error);
          }
          setLoading(false);
        })
        .withFailureHandler(function(error) {
          console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
          showError('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
          setLoading(false);
        })
        .connectToDataSource(spreadsheetId, sheetName);
    }

    // é€²æ—æ›´æ–°
    function updateProgress(step) {
      const steps = document.querySelectorAll('.step');
      steps.forEach((stepEl, index) => {
        stepEl.classList.remove('completed', 'current');
        if (index < step - 1) {
          stepEl.classList.add('completed');
        } else if (index === step - 1) {
          stepEl.classList.add('current');
        }
      });
    }

    // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æ›´æ–°
    function updateColumnMapping(mapping) {
      // å®Ÿè£…äºˆå®š: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å—ã‘å–ã£ãŸåˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã§ç”»é¢ã‚’æ›´æ–°
      console.log('Column mapping:', mapping);
    }

    // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª
    function verifyColumnMapping() {
      showSuccess('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ç¢ºèªã—ã¾ã—ãŸ');
      updateProgress(3);
    }

    // ä¸‹æ›¸ãä¿å­˜
    function saveDraft() {
      const config = gatherConfiguration();
      
      setLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            updateConfigDisplay(result.config);
          } else {
            showError(result.error);
          }
          setLoading(false);
        })
        .withFailureHandler(function(error) {
          console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          showError('ä¸‹æ›¸ãã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          setLoading(false);
        })
        .saveDraftConfiguration(config);
    }

    // ã‚¢ãƒ—ãƒªå…¬é–‹
    function publishApp() {
      const appName = document.getElementById('app-name').value;
      if (!appName.trim()) {
        showError('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const config = gatherConfiguration();
      config.appName = appName;

      setLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('ã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã—ã¾ã—ãŸï¼');
            updatePublishStatus('published');
            updateConfigDisplay(result.config);
          } else {
            showError(result.error);
          }
          setLoading(false);
        })
        .withFailureHandler(function(error) {
          console.error('å…¬é–‹ã‚¨ãƒ©ãƒ¼:', error);
          showError('ã‚¢ãƒ—ãƒªã®å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
          setLoading(false);
        })
        .publishApplication(config);
    }

    // è¨­å®šåé›†
    function gatherConfiguration() {
      return {
        spreadsheetId: document.getElementById('spreadsheet-select').value,
        sheetName: document.getElementById('sheet-select').value,
        showNames: document.getElementById('show-names').checked,
        showReactions: document.getElementById('show-reactions').checked,
        timestamp: new Date().toISOString()
      };
    }

    // è¨­å®šè¡¨ç¤ºæ›´æ–°
    function updateConfigDisplay(config) {
      document.getElementById('config-json').textContent = JSON.stringify(config, null, 2);
    }

    // å…¬é–‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updatePublishStatus(status) {
      const badge = document.querySelector('.status-badge.unpublished') || 
                   document.querySelector('.status-badge.published');
      if (badge) {
        badge.className = `status-badge ${status}`;
        badge.textContent = status === 'published' ? 'å…¬é–‹ä¸­' : 'æœªå…¬é–‹';
      }
    }

    console.log('AdminPanel ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
  </script>
</body>
</html>