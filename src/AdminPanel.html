<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <base target="_top" />
    <title>StudyQuest 管理パネル</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Optimized Permissions Policy - essential permissions only -->
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), fullscreen=*" />
    
    <!-- TailwindCSS Optimized Loading - highest priority, no warnings -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Shared Styles and Utilities -->
    <?!= include('UnifiedStyles'); ?>
    <?!= include('SharedUtilities'); ?>
    <!-- Safe template variable injection using HTML data attributes -->
    <div id="app-data" 
         data-user-id="<?= userInfo && userInfo.userId ? userInfo.userId.replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '' ?>" 
         style="display: none;"></div>
    
    <!-- AdminPanel CSS -->
    <?!= include('AdminPanel.css'); ?>
    
    <!-- AdminPanel JavaScript -->
    <?!= include('AdminPanel.js'); ?>
  </head>
  <body class="bg-gray-900 text-white">
    <!-- Top Navigation -->
    <header class="glass-panel shadow-xl">
      <div class="status-header">
        <h1>管理パネル</h1>
        <div class="system-monitor">
          <span class="status-indicator active"></span>
          システム稼働中
          <span class="ml-4 text-sm" id="last-update">最終同期: --:--</span>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="admin-container">
      <!-- Left Panel: Setup Process -->
      <main class="main-editor">
        <div class="card glass-panel">
          <!-- Progress Indicators -->
          <div class="setup-progress">
            <div class="step current">1. データソース</div>
            <div class="step">2. 列設定</div>
            <div class="step">3. 公開設定</div>
          </div>

          <!-- Step 1: Data Source Connection -->
          <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4">📊 データソース接続</h2>
            
            <!-- Connection Method Selection -->
            <div class="mb-6">
              <label class="block text-sm font-medium mb-3">接続方式を選択してください</label>
              <div class="flex gap-4">
                <label class="flex items-center">
                  <input type="radio" name="source-method" value="dropdown" checked class="mr-2">
                  <span>一覧から選択</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="source-method" value="url" class="mr-2">
                  <span>URL直接入力</span>
                </label>
              </div>
            </div>

            <!-- Dropdown Method (Default) -->
            <div id="dropdown-method">
              <div class="form-group">
                <label for="spreadsheet-select" class="block text-sm font-medium mb-2">スプレッドシート</label>
                <select id="spreadsheet-select" class="modern-select">
                  <option value="">スプレッドシートを選択...</option>
                </select>
              </div>

              <div class="form-group">
                <label for="sheet-select" class="block text-sm font-medium mb-2">シート名</label>
                <select id="sheet-select" class="modern-select">
                  <option value="">まずスプレッドシートを選択...</option>
                </select>
              </div>

              <div class="action-buttons">
                <button id="refresh-data" class="btn-secondary">🔄 更新</button>
                <button id="connect-source" class="btn-primary">接続</button>
              </div>
            </div>

            <!-- URL Input Method (Hidden by default) -->
            <div id="url-method" class="hidden">
              <div class="form-group">
                <label for="spreadsheet-url" class="block text-sm font-medium mb-2">スプレッドシートURL</label>
                <input type="text" id="spreadsheet-url" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400" placeholder="https://docs.google.com/spreadsheets/d/...">
                <button id="url-validate" class="btn-secondary mt-2">🔍 URL検証</button>
              </div>

              <div class="form-group">
                <label for="sheet-name-input" class="block text-sm font-medium mb-2">シート名</label>
                <input type="text" id="sheet-name-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="フォームの回答 1">
              </div>

              <div class="action-buttons">
                <button id="connect-url-source" class="btn-primary">接続</button>
              </div>
            </div>
          </section>

          <!-- Step 2: Column Mapping (Initially Hidden) -->
          <section class="mb-8" id="column-mapping-section" style="display: none;">
            <h2 class="text-xl font-semibold mb-4">📋 列設定</h2>
            
            <!-- Column Selection Dropdowns -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Answer Column -->
              <div class="form-group">
                <label for="answer-column-select" class="block text-sm font-medium mb-2">回答列</label>
                <select id="answer-column-select" class="modern-select">
                  <option value="">選択してください...</option>
                </select>
                <div id="answer-confidence" class="mt-2 hidden">
                  <span class="confidence-badge"></span>
                </div>
              </div>

              <!-- Reason Column -->
              <div class="form-group">
                <label for="reason-column-select" class="block text-sm font-medium mb-2">理由列</label>
                <select id="reason-column-select" class="modern-select">
                  <option value="">選択してください...</option>
                </select>
                <div id="reason-confidence" class="mt-2 hidden">
                  <span class="confidence-badge"></span>
                </div>
              </div>

              <!-- Class Column -->
              <div class="form-group">
                <label for="class-column-select" class="block text-sm font-medium mb-2">クラス列</label>
                <select id="class-column-select" class="modern-select">
                  <option value="">選択してください...</option>
                </select>
                <div id="class-confidence" class="mt-2 hidden">
                  <span class="confidence-badge"></span>
                </div>
              </div>

              <!-- Name Column -->
              <div class="form-group">
                <label for="name-column-select" class="block text-sm font-medium mb-2">名前列</label>
                <select id="name-column-select" class="modern-select">
                  <option value="">選択してください...</option>
                </select>
                <div id="name-confidence" class="mt-2 hidden">
                  <span class="confidence-badge"></span>
                </div>
              </div>
            </div>

            <!-- AI Detection Info -->
            <div id="ai-detection-info" class="mt-6 p-4 bg-blue-500/20 border border-blue-500/30 rounded-lg hidden">
              <h4 class="font-semibold mb-2">🤖 AI自動検出結果</h4>
              <div id="ai-detection-details"></div>
              <button id="reset-to-ai" class="btn-secondary mt-3 hidden">AI検出に戻す</button>
            </div>

            <!-- Manual Override Info -->
            <div id="manual-override-info" class="mt-4 p-4 bg-purple-500/20 border border-purple-500/30 rounded-lg hidden">
              <p class="text-sm">✋ 手動設定が有効です。AI検出に戻すには上のボタンを使用してください。</p>
            </div>

            <div class="action-buttons mt-6">
              <button id="verify-mapping" class="btn-secondary">✅ 設定確認</button>
            </div>
          </section>

          <!-- Step 3: Publication Settings (Initially Hidden) -->
          <section class="mb-8" id="publication-section" style="display: none;">
            <h2 class="text-xl font-semibold mb-4">🚀 公開設定</h2>
            
            <div class="form-group">
              <label for="app-name" class="block text-sm font-medium mb-2">アプリケーション名</label>
              <input type="text" id="app-name" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="クラス質問ボード">
            </div>

            <!-- Display Options -->
            <div class="mb-6">
              <h3 class="text-lg font-medium mb-3">表示オプション</h3>
              <div class="toggle-group">
                <label class="toggle-switch">
                  <input type="checkbox" id="show-names" checked>
                  <span class="slider"></span>
                  名前を表示
                </label>
                <label class="toggle-switch">
                  <input type="checkbox" id="show-reactions" checked>
                  <span class="slider"></span>
                  リアクション機能
                </label>
              </div>
            </div>

            <div class="action-buttons">
              <button id="save-draft" class="btn-secondary">💾 下書き保存</button>
              <button id="publish-now" class="btn-primary">🌐 今すぐ公開</button>
            </div>
          </section>
        </div>
      </main>

      <!-- Right Panel: Status & Info -->
      <aside class="info-panel">
        <!-- User Info -->
        <div class="info-card glass-panel">
          <h3 class="text-lg font-semibold mb-3">👤 ユーザー情報</h3>
          <div class="config-summary">
            <div class="config-item">
              <span class="label">メールアドレス</span>
              <span id="current-user-email">取得中...</span>
            </div>
            <div class="config-item">
              <span class="label">ユーザーID</span>
              <span id="current-user-id">取得中...</span>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="info-card glass-panel">
          <h3 class="text-lg font-semibold mb-3">🔗 リソース</h3>
          <div class="config-summary">
            <button id="open-spreadsheet-btn" onclick="openSpreadsheet()" class="link-btn w-full mb-2" disabled>
              📊 スプレッドシート
            </button>
            <button id="open-form-btn" onclick="openForm()" class="link-btn w-full mb-2 hidden">
              📝 フォーム
            </button>
            <button id="open-board-btn" onclick="openBoard()" class="link-btn w-full mb-2 hidden">
              🎯 公開ボード
            </button>
          </div>
          <div id="resource-status" class="text-xs text-gray-400 mt-2 text-center">
            設定が見つかりません
          </div>
        </div>

        <!-- System Actions -->
        <div class="info-card glass-panel">
          <h3 class="text-lg font-semibold mb-3">⚙️ システム</h3>
          <div class="flex flex-col gap-2">
            <button onclick="createFormInterface()" class="btn-secondary text-sm">
              ➕ フォーム作成
            </button>
            <button onclick="exportConfig()" class="btn-secondary text-sm">
              📥 設定エクスポート
            </button>
            <button id="app-setup-btn" onclick="goToAppSetup()" class="btn-secondary text-sm" style="display: none;">
              🛠️ アプリ設定
            </button>
          </div>
        </div>

        <!-- Publication Status -->
        <div class="info-card glass-panel">
          <h3 class="text-lg font-semibold mb-3">📊 ステータス</h3>
          <div class="config-item">
            <span class="label">公開状態</span>
            <span class="status-badge unpublished">未公開</span>
          </div>
        </div>
      </aside>
    </div>

    <!-- Footer: Current Board Info Display -->
    <footer id="boardInfoFooter" class="fixed bottom-0 left-0 right-0 p-4" style="display: none; z-index: 30;">
      <div class="glass-panel rounded-lg p-4">
        <div class="flex items-center justify-between">
          <!-- Current Question Text -->
          <div class="flex-1 min-w-0">
            <h4 class="text-sm font-medium text-gray-300 mb-1">現在の問題文</h4>
            <p id="currentQuestionText" class="text-white truncate">
              読み込み中...
            </p>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex items-center gap-2 flex-shrink-0">
            <button id="openBoardBtn" onclick="" class="btn-primary" style="display: none;">
              🎯 ボード表示
            </button>
            <button id="copyViewUrlBtn" onclick="" class="btn-secondary" style="display: none;">
              📋 URL コピー
            </button>
            <button id="refreshBoardInfo" onclick="loadBoardInfo()" class="btn-secondary">
              🔄
            </button>
          </div>
        </div>
        
        <!-- Status Text -->
        <div class="mt-2">
          <p id="boardStatus" class="text-xs text-gray-400">
            ステータス確認中...
          </p>
        </div>
      </div>
    </footer>
  </body>
</html>