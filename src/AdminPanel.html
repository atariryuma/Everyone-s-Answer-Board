<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <title>StudyQuest 管理パネル</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Shared Utilities Include -->
  <?!= include('SharedUtilities') ?>
  <style>
    /* ベストプラクティス準拠のスタイル */
    body { 
      margin: 0; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .admin-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1rem;
      min-height: 100vh;
      padding: 1rem;
    }

    .main-editor {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .info-panel {
      background: #f1f5f9;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    .card h2 {
      margin: 0 0 1rem 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-card {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    .info-card h3 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
      font-weight: 600;
      color: #1e293b;
    }

    /* ステータスヘッダー */
    .status-header {
      background: white;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
    }

    .system-monitor {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
      color: #64748b;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
    }

    .status-indicator.active {
      background-color: #10b981;
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
    }

    .status-indicator.warning {
      background-color: #f59e0b;
    }

    .status-indicator.error {
      background-color: #ef4444;
    }

    /* セットアップ進捗 */
    .setup-progress {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 1rem;
      background: #e0e7ff;
      border-radius: 8px;
    }

    .step {
      flex: 1;
      text-align: center;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 500;
      color: #64748b;
      background: #f1f5f9;
    }

    .step.completed {
      background: #dcfce7;
      color: #166534;
    }

    .step.current {
      background: #dbeafe;
      color: #1d4ed8;
      border: 2px solid #3b82f6;
    }

    /* フォーム要素 */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #374151;
    }

    .modern-select, input[type="text"] {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .modern-select:focus, input[type="text"]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* トグルスイッチ */
    .toggle-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
    }

    .toggle-switch input {
      display: none;
    }

    .slider {
      width: 44px;
      height: 24px;
      background: #cbd5e0;
      border-radius: 12px;
      position: relative;
      transition: all 0.3s;
    }

    .slider:before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: all 0.3s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .toggle-switch input:checked + .slider {
      background: #3b82f6;
    }

    .toggle-switch input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* ボタン */
    .btn-primary, .btn-secondary {
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #64748b;
      border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .action-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    /* 右パネルの情報表示 */
    .config-summary {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .config-item:last-child {
      border-bottom: none;
    }

    .label {
      font-weight: 500;
      color: #374151;
      font-size: 0.875rem;
    }

    .link-btn {
      background: #eff6ff;
      color: #2563eb;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      text-decoration: none;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .link-btn:hover {
      background: #dbeafe;
    }

    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-badge.unpublished {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.published {
      background: #dcfce7;
      color: #166534;
    }

    .status-badge.error {
      background: #fee2e2;
      color: #dc2626;
    }

    /* システム監視メトリクス */
    .metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .metric {
      text-align: center;
      padding: 0.75rem;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    .metric .value {
      display: block;
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
    }

    .metric .unit {
      font-size: 0.75rem;
      color: #64748b;
    }

    /* JSON表示 */
    .json-viewer {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      padding: 0.75rem;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.75rem;
      color: #374151;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }

    .expandable-section {
      margin-top: 0.5rem;
    }

    .expandable-section summary {
      cursor: pointer;
      font-weight: 500;
      color: #3b82f6;
      padding: 0.5rem 0;
    }

    /* 列マッピング表示 */
    .auto-detected-columns {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .column-match {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 6px;
    }

    .column-type {
      font-weight: 500;
      color: #166534;
    }

    .detected-column {
      background: #dcfce7;
      color: #166534;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .confidence {
      font-size: 0.75rem;
      color: #16a34a;
    }

    /* レスポンシブデザイン */
    @media (max-width: 768px) {
      .admin-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
      }
      
      .status-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .setup-progress {
        flex-direction: column;
      }
      
      .metrics {
        grid-template-columns: 1fr;
      }
    }

    /* ローディング状態 */
    .loading {
      opacity: 0.6;
      pointer-events: none;
      position: relative;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      transform: translate(-50%, -50%);
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* 成功・エラー状態のアニメーション */
    .success-pulse {
      animation: successPulse 0.6s ease-out;
    }

    .error-shake {
      animation: errorShake 0.5s ease-out;
    }

    @keyframes successPulse {
      0% { background-color: #dcfce7; }
      50% { background-color: #bbf7d0; }
      100% { background-color: #dcfce7; }
    }

    @keyframes errorShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- 左パネル: メインエディタ -->
    <div class="main-editor">
      <!-- ステータスヘッダー -->
      <header class="status-header">
        <h1>StudyQuest 管理パネル</h1>
        <div class="system-monitor">
          <span><span class="status-indicator active"></span>接続正常</span>
          <span id="last-update">最終同期: --:--</span>
          <span id="health-check">DB正常</span>
        </div>
      </header>

      <!-- セットアップ進捗 -->
      <div class="setup-progress">
        <div class="step completed">1. データソース</div>
        <div class="step current">2. 列設定</div>
        <div class="step">3. 公開</div>
      </div>

      <!-- データソース選択カード -->
      <section class="card">
        <h2>📊 データソース選択</h2>
        <div class="form-group">
          <label for="spreadsheet-select">スプレッドシート:</label>
          <select id="spreadsheet-select" class="modern-select">
            <option value="">読み込み中...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="sheet-select">シート:</label>
          <select id="sheet-select" class="modern-select">
            <option value="">スプレッドシートを選択してください</option>
          </select>
        </div>
        <div class="action-buttons">
          <button id="refresh-data" class="btn-secondary">🔄 更新</button>
          <button id="connect-source" class="btn-primary">接続</button>
        </div>
      </section>

      <!-- 列マッピングカード -->
      <section class="card">
        <h2>📋 列設定</h2>
        <div class="auto-detected-columns">
          <div class="column-match">
            <span class="column-type">質問</span>
            <span class="detected-column">A列</span>
            <span class="confidence">95%確信度</span>
          </div>
          <div class="column-match">
            <span class="column-type">回答者</span>
            <span class="detected-column">B列</span>
            <span class="confidence">88%確信度</span>
          </div>
          <div class="column-match">
            <span class="column-type">理由</span>
            <span class="detected-column">C列</span>
            <span class="confidence">92%確信度</span>
          </div>
        </div>
        <div class="action-buttons">
          <button id="verify-mapping" class="btn-primary">設定を確認</button>
        </div>
      </section>

      <!-- 表示設定カード -->
      <section class="card">
        <h2>⚙️ 表示設定</h2>
        <div class="toggle-group">
          <label class="toggle-switch">
            <input type="checkbox" id="show-names" checked>
            <span class="slider"></span>
            回答者名を表示
          </label>
          <label class="toggle-switch">
            <input type="checkbox" id="show-reactions" checked>
            <span class="slider"></span>
            リアクション数を表示
          </label>
        </div>
      </section>

      <!-- 公開カード -->
      <section class="card">
        <h2>🚀 公開設定</h2>
        <div class="form-group">
          <div class="config-item">
            <span class="label">現在のステータス:</span>
            <span class="status-badge unpublished">未公開</span>
          </div>
        </div>
        <div class="form-group">
          <label for="app-name">アプリケーション名:</label>
          <input type="text" id="app-name" placeholder="例: クラス質問ボード">
        </div>
        <div class="action-buttons">
          <button id="save-draft" class="btn-secondary">下書き保存</button>
          <button id="publish-now" class="btn-primary">今すぐ公開</button>
        </div>
      </section>
    </div>

    <!-- 右パネル: 情報表示 -->
    <div class="info-panel">
      <!-- 現在の設定サマリー -->
      <section class="info-card">
        <h3>📋 現在の設定</h3>
        <div class="config-summary">
          <div class="config-item">
            <span class="label">データソース:</span>
            <a href="#" class="link-btn" id="open-sheet">シートを開く</a>
          </div>
          <div class="config-item">
            <span class="label">セットアップ:</span>
            <span class="status-badge unpublished">設定中</span>
          </div>
          <div class="config-item">
            <span class="label">最終更新:</span>
            <span style="font-size: 0.75rem; color: #64748b;">--:--</span>
          </div>
        </div>
      </section>

      <!-- システム監視 -->
      <section class="info-card">
        <h3>🔍 システム状態</h3>
        <div class="metrics">
          <div class="metric">
            <span class="value" id="active-users">--</span>
            <span class="unit">アクティブユーザー</span>
          </div>
          <div class="metric">
            <span class="value" id="active-boards">--</span>
            <span class="unit">公開中ボード</span>
          </div>
        </div>
      </section>

      <!-- データベース詳細 -->
      <section class="info-card">
        <h3>🗄️ データベース詳細</h3>
        <div class="db-details">
          <div class="config-item">
            <span class="label">DB接続:</span>
            <span class="status-badge published">正常</span>
          </div>
          <details class="expandable-section">
            <summary>設定詳細 (JSON)</summary>
            <div class="json-viewer" id="config-json">
{
  "setupStatus": "pending",
  "spreadsheetId": null,
  "sheetName": null,
  "formCreated": false,
  "appPublished": false,
  "lastUpdated": null
}
            </div>
          </details>
        </div>
      </section>

      <!-- クイックアクション -->
      <section class="info-card">
        <h3>⚡ クイックアクション</h3>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button class="link-btn" style="width: 100%; text-align: center;" onclick="refreshSystemStatus()">
            システム状態更新
          </button>
          <button class="link-btn" style="width: 100%; text-align: center;" onclick="exportConfig()">
            設定をエクスポート
          </button>
          <button id="app-setup-btn" class="link-btn" style="width: 100%; text-align: center; display: none;" onclick="goToAppSetup()">
            ⚙️ アプリ設定画面
          </button>
        </div>
      </section>
    </div>
  </div>

  <!-- SharedUtilities.html は上部で既にインクルード済み -->

  <script>
    // グローバル状態管理
    let systemState = {
      connected: false,
      lastUpdate: null,
      config: null,
      loading: false
    };

    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('AdminPanel初期化開始');
      initializePanel();
      checkSystemAdminAccess();
      
      // 定期的なステータス更新
      setInterval(updateSystemStatus, 30000); // 30秒間隔
    });

    // パネル初期化
    function initializePanel() {
      try {
        setLoading(true);
        loadSpreadsheetList();
        loadSystemMetrics();
        updateLastUpdateTime();
        setLoading(false);
      } catch (error) {
        console.error('初期化エラー:', error);
        showError('初期化に失敗しました: ' + error.message);
        setLoading(false);
      }
    }

    // スプレッドシート一覧読み込み
    function loadSpreadsheetList() {
      const select = document.getElementById('spreadsheet-select');
      select.innerHTML = '<option value="">読み込み中...</option>';
      
      google.script.run
        .withSuccessHandler(function(spreadsheets) {
          select.innerHTML = '<option value="">スプレッドシートを選択...</option>';
          spreadsheets.forEach(sheet => {
            const option = document.createElement('option');
            option.value = sheet.id;
            option.textContent = sheet.name;
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          console.error('スプレッドシート読み込みエラー:', error);
          select.innerHTML = '<option value="">読み込みエラー</option>';
          showError('スプレッドシートの読み込みに失敗しました');
        })
        .getSpreadsheetList();
    }

    // システムメトリクス読み込み
    function loadSystemMetrics() {
      google.script.run
        .withSuccessHandler(function(metrics) {
          document.getElementById('active-users').textContent = metrics.activeUsers || '--';
          document.getElementById('active-boards').textContent = metrics.activeBoards || '--';
        })
        .withFailureHandler(function(error) {
          console.error('メトリクス読み込みエラー:', error);
        })
        .getSystemMetrics();
    }

    // 最終更新時刻更新
    function updateLastUpdateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('ja-JP', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      document.getElementById('last-update').textContent = `最終同期: ${timeString}`;
    }

    // ローディング状態設定
    function setLoading(loading) {
      systemState.loading = loading;
      const container = document.querySelector('.admin-container');
      if (loading) {
        container.classList.add('loading');
      } else {
        container.classList.remove('loading');
      }
    }

    // エラー表示 (SharedUtilitiesの通知システムを使用)
    function showError(message) {
      if (window.notifications && window.notifications.error) {
        window.notifications.error(message);
      } else {
        // フォールバック
        alert('エラー: ' + message);
      }
    }

    // 成功表示 (SharedUtilitiesの通知システムを使用)
    function showSuccess(message) {
      if (window.notifications && window.notifications.success) {
        window.notifications.success(message);
      } else {
        // フォールバック
        alert('成功: ' + message);
      }
    }

    // システム状態更新
    function updateSystemStatus() {
      updateLastUpdateTime();
      loadSystemMetrics();
    }

    // システム状態更新（ボタン用）
    function refreshSystemStatus() {
      setLoading(true);
      updateSystemStatus();
      setTimeout(() => {
        setLoading(false);
        showSuccess('システム状態を更新しました');
      }, 1000);
    }

    // 設定エクスポート
    function exportConfig() {
      google.script.run
        .withSuccessHandler(function(config) {
          const dataStr = JSON.stringify(config, null, 2);
          const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
          const exportFileDefaultName = 'studyquest-config.json';
          
          const linkElement = document.createElement('a');
          linkElement.setAttribute('href', dataUri);
          linkElement.setAttribute('download', exportFileDefaultName);
          linkElement.click();
          
          showSuccess('設定をエクスポートしました');
        })
        .withFailureHandler(function(error) {
          console.error('エクスポートエラー:', error);
          showError('設定のエクスポートに失敗しました');
        })
        .getCurrentConfig();
    }

    // システム管理者アクセス確認
    function checkSystemAdminAccess() {
      google.script.run
        .withSuccessHandler(function(isAdmin) {
          if (isAdmin) {
            console.log('システム管理者として認識されました');
            document.getElementById('app-setup-btn').style.display = 'block';
          } else {
            console.log('一般ユーザーとして認識されました');
            document.getElementById('app-setup-btn').style.display = 'none';
          }
        })
        .withFailureHandler(function(error) {
          console.warn('システム管理者確認エラー:', error);
          document.getElementById('app-setup-btn').style.display = 'none';
        })
        .checkIsSystemAdmin();
    }

    // アプリ設定画面へのナビゲーション
    function goToAppSetup() {
      setLoading(true);
      google.script.run
        .withSuccessHandler(function(webAppUrl) {
          const setupUrl = webAppUrl + '?mode=appSetup';
          window.open(setupUrl, '_top');
        })
        .withFailureHandler(function(error) {
          console.error('アプリ設定画面への遷移エラー:', error);
          showError('アプリ設定画面への移動に失敗しました');
          setLoading(false);
        })
        .getWebAppUrlCached();
    }

    // イベントリスナー設定
    document.addEventListener('DOMContentLoaded', function() {
      // スプレッドシート選択時
      document.getElementById('spreadsheet-select').addEventListener('change', function() {
        const spreadsheetId = this.value;
        if (spreadsheetId) {
          loadSheetList(spreadsheetId);
        }
      });

      // データ更新ボタン
      document.getElementById('refresh-data').addEventListener('click', function() {
        loadSpreadsheetList();
      });

      // 接続ボタン
      document.getElementById('connect-source').addEventListener('click', function() {
        connectToSource();
      });

      // 設定確認ボタン
      document.getElementById('verify-mapping').addEventListener('click', function() {
        verifyColumnMapping();
      });

      // 下書き保存ボタン
      document.getElementById('save-draft').addEventListener('click', function() {
        saveDraft();
      });

      // 公開ボタン
      document.getElementById('publish-now').addEventListener('click', function() {
        publishApp();
      });
    });

    // シート一覧読み込み
    function loadSheetList(spreadsheetId) {
      const select = document.getElementById('sheet-select');
      select.innerHTML = '<option value="">読み込み中...</option>';
      
      google.script.run
        .withSuccessHandler(function(sheets) {
          select.innerHTML = '<option value="">シートを選択...</option>';
          sheets.forEach(sheet => {
            const option = document.createElement('option');
            option.value = sheet.name;
            option.textContent = sheet.name;
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          console.error('シート読み込みエラー:', error);
          select.innerHTML = '<option value="">読み込みエラー</option>';
        })
        .getSheetList(spreadsheetId);
    }

    // データソース接続
    function connectToSource() {
      const spreadsheetId = document.getElementById('spreadsheet-select').value;
      const sheetName = document.getElementById('sheet-select').value;
      
      if (!spreadsheetId || !sheetName) {
        showError('スプレッドシートとシートを選択してください');
        return;
      }

      setLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('データソースに接続しました');
            // 進捗更新
            updateProgress(2);
            // 列マッピングを更新
            updateColumnMapping(result.columnMapping);
          } else {
            showError(result.error);
          }
          setLoading(false);
        })
        .withFailureHandler(function(error) {
          console.error('接続エラー:', error);
          showError('データソースへの接続に失敗しました');
          setLoading(false);
        })
        .connectToDataSource(spreadsheetId, sheetName);
    }

    // 進捗更新
    function updateProgress(step) {
      const steps = document.querySelectorAll('.step');
      steps.forEach((stepEl, index) => {
        stepEl.classList.remove('completed', 'current');
        if (index < step - 1) {
          stepEl.classList.add('completed');
        } else if (index === step - 1) {
          stepEl.classList.add('current');
        }
      });
    }

    // 列マッピング更新
    function updateColumnMapping(mapping) {
      // 実装予定: バックエンドから受け取った列マッピング情報で画面を更新
      console.log('Column mapping:', mapping);
    }

    // 列マッピング確認
    function verifyColumnMapping() {
      showSuccess('列マッピングを確認しました');
      updateProgress(3);
    }

    // 下書き保存
    function saveDraft() {
      const config = gatherConfiguration();
      
      setLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('下書きを保存しました');
            updateConfigDisplay(result.config);
          } else {
            showError(result.error);
          }
          setLoading(false);
        })
        .withFailureHandler(function(error) {
          console.error('保存エラー:', error);
          showError('下書きの保存に失敗しました');
          setLoading(false);
        })
        .saveDraftConfiguration(config);
    }

    // アプリ公開
    function publishApp() {
      const appName = document.getElementById('app-name').value;
      if (!appName.trim()) {
        showError('アプリケーション名を入力してください');
        return;
      }

      const config = gatherConfiguration();
      config.appName = appName;

      setLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('アプリを公開しました！');
            updatePublishStatus('published');
            updateConfigDisplay(result.config);
          } else {
            showError(result.error);
          }
          setLoading(false);
        })
        .withFailureHandler(function(error) {
          console.error('公開エラー:', error);
          showError('アプリの公開に失敗しました');
          setLoading(false);
        })
        .publishApplication(config);
    }

    // 設定収集
    function gatherConfiguration() {
      return {
        spreadsheetId: document.getElementById('spreadsheet-select').value,
        sheetName: document.getElementById('sheet-select').value,
        showNames: document.getElementById('show-names').checked,
        showReactions: document.getElementById('show-reactions').checked,
        timestamp: new Date().toISOString()
      };
    }

    // 設定表示更新
    function updateConfigDisplay(config) {
      document.getElementById('config-json').textContent = JSON.stringify(config, null, 2);
    }

    // 公開ステータス更新
    function updatePublishStatus(status) {
      const badge = document.querySelector('.status-badge.unpublished') || 
                   document.querySelector('.status-badge.published');
      if (badge) {
        badge.className = `status-badge ${status}`;
        badge.textContent = status === 'published' ? '公開中' : '未公開';
      }
    }

    console.log('AdminPanel スクリプト読み込み完了');
  </script>
</body>
</html>