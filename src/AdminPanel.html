<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <base target="_top" />
    <title>StudyQuest ç®¡ç†ãƒ‘ãƒãƒ«</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), fullscreen=*" />
    <!-- Shared Security Headers -->
    <!-- Shared TailwindCSS Configuration -->
    <?!= include('SharedTailwindConfig'); ?> <?!= include('UnifiedStyles'); ?> <?!=
    include('SharedUtilities'); ?>
    <script>
      const __USER_ID__ = '<?= userId ? userId : "" ?>';
    </script>
    <style>
      /* AdminPanelå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« - commit 421e817 ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹é€  + ç¾åœ¨ã®ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
      body {
        margin: 0;
        font-family:
          'Inter',
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        min-height: 100vh;
      }

      .admin-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1rem;
        min-height: 100vh;
        padding: 1rem;
      }

      .main-editor {
        padding: 1.5rem;
      }

      .info-panel {
        padding: 1rem;
        overflow-y: auto;
      }

      .card {
        margin-bottom: 1rem;
      }

      .info-card {
        margin-bottom: 0.75rem;
      }

      /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ */
      .status-header {
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-header h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
      }

      .system-monitor {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.875rem;
        color: #64748b;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 4px;
      }

      .status-indicator.active {
        background-color: #10b981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
      }

      .status-indicator.warning {
        background-color: #f59e0b;
      }

      .status-indicator.error {
        background-color: #ef4444;
      }

      /* é€²æ—ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç°¡ç´ åŒ– */
      .setup-progress {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
      }

      .step {
        flex: 1;
        text-align: center;
        padding: 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        background: rgba(107, 114, 128, 0.1);
        color: rgba(156, 163, 175, 1);
        transition: all 0.2s;
      }

      .step.completed {
        background: rgba(34, 197, 94, 0.2);
        color: rgba(34, 197, 94, 1);
      }

      .step.current {
        background: rgba(59, 130, 246, 0.2);
        color: rgba(59, 130, 246, 1);
        border: 2px solid rgba(59, 130, 246, 0.5);
      }

      /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  - Tailwindã‚¹ã‚¿ã‚¤ãƒ«ã§ç½®ãæ›ãˆ */
      .form-group {
        margin-bottom: 1rem;
      }

      .modern-select,
      input[type='text'] {
        width: 100%;
        padding: 0.75rem;
        background: rgba(55, 65, 81, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.5);
        border-radius: 0.5rem;
        color: white;
        font-size: 0.875rem;
        transition: all 0.2s;
      }

      .modern-select:focus,
      input[type='text']:focus {
        outline: none;
        border-color: rgba(59, 130, 246, 0.8);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }

      /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ - ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
      .toggle-group {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .toggle-switch {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        color: rgba(209, 213, 219, 1);
      }

      .toggle-switch input {
        display: none;
      }

      .slider {
        width: 44px;
        height: 24px;
        background: rgba(107, 114, 128, 0.5);
        border-radius: 12px;
        position: relative;
        transition: all 0.3s;
      }

      .slider:before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: white;
        top: 2px;
        left: 2px;
        transition: all 0.3s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }

      .toggle-switch input:checked + .slider {
        background: rgba(59, 130, 246, 0.8);
      }

      .toggle-switch input:checked + .slider:before {
        transform: translateX(20px);
      }

      /* ãƒœã‚¿ãƒ³ - ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
      .btn-primary,
      .btn-secondary {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
        font-size: 0.875rem;
      }

      .btn-primary {
        background: linear-gradient(to right, rgba(59, 130, 246, 1), rgba(147, 51, 234, 1));
        color: white;
      }

      .btn-primary:hover {
        background: linear-gradient(to right, rgba(37, 99, 235, 1), rgba(126, 34, 206, 1));
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: rgba(75, 85, 99, 0.5);
        color: rgba(209, 213, 219, 1);
        border: 1px solid rgba(107, 114, 128, 0.5);
      }

      .btn-secondary:hover {
        background: rgba(75, 85, 99, 0.7);
      }

      .action-buttons {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
      }

      /* å³ãƒ‘ãƒãƒ«ã®æƒ…å ±è¡¨ç¤º - ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
      .config-summary {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .config-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: rgba(55, 65, 81, 0.8);
        border-radius: 0.5rem;
        color: rgba(209, 213, 219, 1);
      }

      .label {
        font-weight: 500;
        color: rgba(156, 163, 175, 1);
        font-size: 0.875rem;
      }

      .link-btn {
        background: rgba(59, 130, 246, 0.2);
        color: rgba(96, 165, 250, 1);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
      }

      .link-btn:hover {
        background: rgba(59, 130, 246, 0.3);
      }

      .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .status-badge.unpublished {
        background: rgba(245, 158, 11, 0.2);
        color: rgba(245, 158, 11, 1);
      }

      .status-badge.published {
        background: rgba(34, 197, 94, 0.2);
        color: rgba(34, 197, 94, 1);
      }

      .status-badge.error {
        background: rgba(239, 68, 68, 0.2);
        color: rgba(239, 68, 68, 1);
      }

      /* ç°¡ç´ åŒ–ã•ã‚ŒãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º */
      .metrics {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .metric {
        text-align: center;
        padding: 1rem;
        background: rgba(55, 65, 81, 0.8);
        border-radius: 0.75rem;
        border: 1px solid rgba(75, 85, 99, 0.5);
        flex: 1;
        min-width: 200px;
      }

      .metric .value {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
        color: rgba(96, 165, 250, 1);
      }

      .metric .unit {
        font-size: 0.875rem;
        color: rgba(156, 163, 175, 1);
      }

      /* JSONè¡¨ç¤º - ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
      .json-viewer {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.5);
        border-radius: 0.5rem;
        padding: 1rem;
        font-family: 'Monaco', 'Menlo', 'SF Mono', monospace;
        font-size: 0.8rem;
        color: rgba(209, 213, 219, 1);
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }

      /* ä¿¡é ¼åº¦ãƒãƒƒã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
      .confidence-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        gap: 0.25rem;
      }

      .confidence-badge.high {
        background: rgba(34, 197, 94, 0.2);
        color: rgba(34, 197, 94, 1);
        border: 1px solid rgba(34, 197, 94, 0.3);
      }

      .confidence-badge.medium {
        background: rgba(245, 158, 11, 0.2);
        color: rgba(245, 158, 11, 1);
        border: 1px solid rgba(245, 158, 11, 0.3);
      }

      .confidence-badge.low {
        background: rgba(239, 68, 68, 0.2);
        color: rgba(239, 68, 68, 1);
        border: 1px solid rgba(239, 68, 68, 0.3);
      }

      .confidence-badge.manual {
        background: rgba(168, 85, 247, 0.2);
        color: rgba(168, 85, 247, 1);
        border: 1px solid rgba(168, 85, 247, 0.3);
      }

      /* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³é¸æŠæ™‚ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
      .modern-select.has-ai-selection {
        border-color: rgba(59, 130, 246, 0.6);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }

      .modern-select.has-manual-selection {
        border-color: rgba(168, 85, 247, 0.6);
        box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2);
      }

      .expandable-section {
        margin-top: 0.75rem;
      }

      .expandable-section summary {
        cursor: pointer;
        font-weight: 500;
        color: rgba(96, 165, 250, 1);
        padding: 0.75rem 0;
      }

      /* åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤º - ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
      .auto-detected-columns {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .column-match {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: 0.5rem;
      }

      .column-type {
        font-weight: 600;
        color: rgba(34, 197, 94, 1);
      }

      .detected-column {
        background: rgba(34, 197, 94, 0.2);
        color: rgba(34, 197, 94, 1);
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .confidence {
        font-size: 0.8rem;
        color: rgba(34, 197, 94, 0.8);
      }

      /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
      @media (max-width: 768px) {
        .admin-container {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto;
          padding: 1rem;
        }

        .status-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .setup-progress {
          flex-direction: column;
          gap: 0.5rem;
        }

        .metrics {
          flex-direction: column;
        }

        .metric {
          min-width: unset;
        }
      }

      /* SharedUtilitiesã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ */

      /* =============================================================================
     * ãƒ•ãƒƒã‚¿ãƒ¼ï¼šç¾åœ¨ã®ãƒœãƒ¼ãƒ‰æƒ…å ±è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ«
     * ============================================================================= */
      #boardInfoFooter {
        /* æ—¢å­˜ã®z-indexã‚ˆã‚Šã‚‚ä½ãè¨­å®šï¼ˆé€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠã‚ˆã‚Šä¸‹ï¼‰ */
        z-index: 30;
      }

      #boardInfoFooter .glass-panel {
        /* ãƒ•ãƒƒã‚¿ãƒ¼å°‚ç”¨ã®ã‚¬ãƒ©ã‚¹èª¿ã‚¹ã‚¿ã‚¤ãƒ« */
        background: rgba(55, 65, 81, 0.95);
        border: 1px solid rgba(75, 85, 99, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }

      #boardInfoFooter .glass-panel:hover {
        border-color: rgba(96, 165, 250, 0.4);
        transition: border-color 0.2s ease;
      }

      /* å•é¡Œæ–‡è¡¨ç¤ºã‚¨ãƒªã‚¢ */
      #currentQuestionText {
        max-width: 100%;
        line-height: 1.4;
      }

      /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
      @media (max-width: 768px) {
        #boardInfoFooter .flex.items-center.justify-between {
          flex-direction: column;
          align-items: stretch;
          gap: 1rem;
        }

        #boardInfoFooter .flex-1.min-w-0 {
          flex: none;
          text-align: center;
        }

        #boardInfoFooter .flex.items-center.gap-2.flex-shrink-0 {
          justify-content: center;
          flex-wrap: wrap;
        }

        #currentQuestionText {
          white-space: normal;
          overflow: visible;
          text-overflow: unset;
        }
      }

      /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«å¾®èª¿æ•´ */
      #boardInfoFooter .btn-primary,
      #boardInfoFooter .btn-secondary {
        white-space: nowrap;
        min-width: fit-content;
      }

      /* ã‚³ãƒ”ãƒ¼å®Œäº†çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      #copyViewUrlBtn:disabled {
        opacity: 0.8;
        cursor: not-allowed;
      }

      /* ãƒ•ãƒƒã‚¿ãƒ¼è¡¨ç¤ºæ™‚ã®bodyä½™ç™½èª¿æ•´ */
      body.has-footer {
        padding-bottom: 100px;
      }
    </style>
  </head>
  <body>
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[9999] hidden"
    >
      <div
        class="loading-spinner w-16 h-16 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"
      ></div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-[10000] space-y-2"></div>

    <div class="admin-container">
      <!-- å·¦ãƒ‘ãƒãƒ«: ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ -->
      <div class="main-editor">
        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="status-header glass-panel rounded-xl">
          <h1 class="text-cyan-400 font-bold">StudyQuest ç®¡ç†ãƒ‘ãƒãƒ«</h1>
          <div class="system-monitor">
            <span><span class="status-indicator active"></span>æ¥ç¶šæ­£å¸¸</span>
            <span id="last-update">æœ€çµ‚åŒæœŸ: --:--</span>
            <span id="health-check">DBæ­£å¸¸</span>
          </div>
        </header>

        <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é€²æ— -->
        <div class="setup-progress">
          <div class="step completed">1. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</div>
          <div class="step current">2. åˆ—è¨­å®š</div>
          <div class="step">3. å…¬é–‹</div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠã‚«ãƒ¼ãƒ‰ -->
        <section class="card glass-panel rounded-xl p-6">
          <h2 class="text-xl font-semibold text-white mb-4">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ</h2>

          <!-- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠæ–¹å¼ -->
          <div class="mb-6">
            <div class="flex gap-4 mb-4">
              <label class="flex items-center cursor-pointer">
                <input
                  type="radio"
                  name="source-method"
                  value="dropdown"
                  checked
                  class="mr-2"
                  id="method-dropdown"
                />
                <span class="text-gray-300">ğŸ“‹ ä¸€è¦§ã‹ã‚‰é¸æŠ</span>
              </label>
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="source-method" value="url" class="mr-2" id="method-url" />
                <span class="text-gray-300">ğŸ”— URLç›´æ¥å…¥åŠ›</span>
              </label>
            </div>
          </div>

          <!-- ä¸€è¦§é¸æŠæ–¹å¼ -->
          <div id="dropdown-method" class="space-y-4">
            <div class="form-group">
              <label for="spreadsheet-select" class="block text-sm font-medium text-gray-300 mb-2"
                >ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ:</label
              >
              <select id="spreadsheet-select" class="modern-select">
                <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="sheet-select" class="block text-sm font-medium text-gray-300 mb-2"
                >ã‚·ãƒ¼ãƒˆ:</label
              >
              <select id="sheet-select" class="modern-select">
                <option value="">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>
            <div class="action-buttons">
              <button id="refresh-data" class="btn-secondary" type="button">ğŸ”„ æ›´æ–°</button>
              <button id="connect-source" class="btn-primary" type="button">æ¥ç¶š</button>
            </div>
          </div>

          <!-- URLç›´æ¥å…¥åŠ›æ–¹å¼ -->
          <div id="url-method" class="space-y-4 hidden">
            <div class="form-group">
              <label for="spreadsheet-url" class="block text-sm font-medium text-gray-300 mb-2"
                >ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL:</label
              >
              <input
                type="text"
                id="spreadsheet-url"
                class="modern-select"
                placeholder="https://docs.google.com/spreadsheets/d/your-spreadsheet-id/edit#gid=0"
              />
              <div class="text-xs text-gray-400 mt-1">
                ğŸ’¡ Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
              </div>
            </div>
            <div class="form-group">
              <label for="sheet-name-input" class="block text-sm font-medium text-gray-300 mb-2"
                >ã‚·ãƒ¼ãƒˆå:</label
              >
              <input
                type="text"
                id="sheet-name-input"
                class="modern-select"
                placeholder="ã‚·ãƒ¼ãƒˆåã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1ï¼‰"
              />
            </div>
            <div class="action-buttons">
              <button id="url-validate" class="btn-secondary" type="button">âœ… URLæ¤œè¨¼</button>
              <button id="connect-url-source" class="btn-primary" type="button">æ¥ç¶š</button>
            </div>
          </div>
        </section>

        <!-- åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ -->
        <section class="card glass-panel rounded-xl p-6">
          <h2 class="text-xl font-semibold text-white mb-4">ğŸ“‹ åˆ—è¨­å®š</h2>

          <div class="column-dropdowns space-y-4 mb-4">
            <!-- å›ç­”åˆ—é¸æŠ -->
            <div class="form-group">
              <label
                for="answer-column-select"
                class="block text-sm font-medium text-gray-300 mb-2"
              >
                ğŸ’¬ å›ç­”åˆ—:
                <span class="text-xs text-gray-400 ml-2">(å€‹åˆ¥ã®å›ç­”å†…å®¹ãŒå…¥ã£ã¦ã„ã‚‹åˆ—)</span>
              </label>
              <select id="answer-column-select" class="modern-select" data-column-type="answer">
                <option value="">é¸æŠã—ã¦ãã ã•ã„...</option>
              </select>
              <div id="answer-confidence" class="text-xs mt-1 hidden">
                <span class="confidence-badge"></span>
              </div>
            </div>

            <!-- ç†ç”±åˆ—é¸æŠ -->
            <div class="form-group">
              <label
                for="reason-column-select"
                class="block text-sm font-medium text-gray-300 mb-2"
              >
                ğŸ“‹ ç†ç”±åˆ—:
                <span class="text-xs text-gray-400 ml-2">(å›ç­”ã®ç†ç”±ãƒ»æ ¹æ‹ ãŒå…¥ã£ã¦ã„ã‚‹åˆ—)</span>
              </label>
              <select id="reason-column-select" class="modern-select" data-column-type="reason">
                <option value="">é¸æŠã—ã¦ãã ã•ã„...</option>
              </select>
              <div id="reason-confidence" class="text-xs mt-1 hidden">
                <span class="confidence-badge"></span>
              </div>
            </div>

            <!-- ã‚¯ãƒ©ã‚¹åˆ—é¸æŠ -->
            <div class="form-group">
              <label for="class-column-select" class="block text-sm font-medium text-gray-300 mb-2">
                ğŸ« ã‚¯ãƒ©ã‚¹åˆ—:
                <span class="text-xs text-gray-400 ml-2">(æ‰€å±ã‚¯ãƒ©ã‚¹æƒ…å ±ãŒå…¥ã£ã¦ã„ã‚‹åˆ—)</span>
              </label>
              <select id="class-column-select" class="modern-select" data-column-type="class">
                <option value="">é¸æŠã—ã¦ãã ã•ã„...</option>
              </select>
              <div id="class-confidence" class="text-xs mt-1 hidden">
                <span class="confidence-badge"></span>
              </div>
            </div>

            <!-- åå‰åˆ—é¸æŠ -->
            <div class="form-group">
              <label for="name-column-select" class="block text-sm font-medium text-gray-300 mb-2">
                ğŸ‘¤ åå‰åˆ—:
                <span class="text-xs text-gray-400 ml-2">(å›ç­”è€…ã®åå‰ãŒå…¥ã£ã¦ã„ã‚‹åˆ—)</span>
              </label>
              <select id="name-column-select" class="modern-select" data-column-type="name">
                <option value="">é¸æŠã—ã¦ãã ã•ã„...</option>
              </select>
              <div id="name-confidence" class="text-xs mt-1 hidden">
                <span class="confidence-badge"></span>
              </div>
            </div>

            <!-- AIæ¤œå‡ºæƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div
              id="ai-detection-info"
              class="bg-blue-900 bg-opacity-30 border border-blue-500 border-opacity-30 rounded-lg p-3 hidden"
            >
              <div class="flex items-center space-x-2 mb-2">
                <span class="text-blue-400">ğŸ¤–</span>
                <span class="text-sm font-medium text-blue-300">AIè‡ªå‹•æ¤œå‡ºçµæœ</span>
              </div>
              <div id="ai-detection-details" class="text-xs text-blue-200 space-y-1">
                <!-- AIæ¤œå‡ºã®è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
              </div>
            </div>

            <!-- æ‰‹å‹•è¨­å®šæƒ…å ± -->
            <div
              id="manual-override-info"
              class="bg-yellow-900 bg-opacity-30 border border-yellow-500 border-opacity-30 rounded-lg p-3 hidden"
            >
              <div class="flex items-center space-x-2 mb-2">
                <span class="text-yellow-400">âœ‹</span>
                <span class="text-sm font-medium text-yellow-300">æ‰‹å‹•è¨­å®š</span>
              </div>
              <div class="text-xs text-yellow-200">
                ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§æ‰‹å‹•é¸æŠã•ã‚ŒãŸè¨­å®šãŒå„ªå…ˆã•ã‚Œã¾ã™
              </div>
            </div>
          </div>

          <div class="action-buttons">
            <button id="verify-mapping" class="btn-primary" type="button">è¨­å®šã‚’ç¢ºèª</button>
            <button id="reset-to-ai" class="btn-secondary" type="button" style="display: none">
              AIæ¤œå‡ºã«æˆ»ã™
            </button>
          </div>
        </section>

        <!-- è¡¨ç¤ºè¨­å®šã‚«ãƒ¼ãƒ‰ -->
        <section class="card glass-panel rounded-xl p-6">
          <h2 class="text-xl font-semibold text-white mb-4">âš™ï¸ è¡¨ç¤ºè¨­å®š</h2>
          <div class="toggle-group">
            <label class="toggle-switch">
              <input type="checkbox" id="show-names" checked />
              <span class="slider"></span>
              å›ç­”è€…åã‚’è¡¨ç¤º
            </label>
            <label class="toggle-switch">
              <input type="checkbox" id="show-reactions" checked />
              <span class="slider"></span>
              ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’è¡¨ç¤º
            </label>
          </div>
        </section>

        <!-- å…¬é–‹ã‚«ãƒ¼ãƒ‰ -->
        <section class="card glass-panel rounded-xl p-6">
          <h2 class="text-xl font-semibold text-white mb-4">ğŸš€ å…¬é–‹è¨­å®š</h2>
          <div class="space-y-4">
            <div class="config-item">
              <span class="label">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
              <span class="status-badge unpublished">æœªå…¬é–‹</span>
            </div>
            <div class="form-group">
              <label for="app-name" class="block text-sm font-medium text-gray-300 mb-2"
                >ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å:</label
              >
              <input type="text" id="app-name" placeholder="ä¾‹: ã‚¯ãƒ©ã‚¹è³ªå•ãƒœãƒ¼ãƒ‰" class="w-full" />
            </div>
            <div class="action-buttons">
              <button id="save-draft" class="btn-secondary" type="button">ä¸‹æ›¸ãä¿å­˜</button>
              <button id="publish-now" class="btn-primary" type="button">ä»Šã™ãå…¬é–‹</button>
            </div>
          </div>
        </section>
      </div>

      <!-- å³ãƒ‘ãƒãƒ«: æƒ…å ±è¡¨ç¤º -->
      <div class="info-panel">
        <!-- ç¾åœ¨ã®è¨­å®šã‚µãƒãƒªãƒ¼ -->
        <section class="info-card glass-panel rounded-xl p-4">
          <h3 class="text-lg font-semibold text-white mb-3">ğŸ“‹ ç¾åœ¨ã®è¨­å®š</h3>
          <div class="config-summary">
            <div class="config-item">
              <span class="label">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</span>
              <a href="#" class="link-btn" id="open-sheet">ã‚·ãƒ¼ãƒˆã‚’é–‹ã</a>
            </div>
            <div class="config-item">
              <span class="label">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:</span>
              <span class="status-badge unpublished">è¨­å®šä¸­</span>
            </div>
            <div class="config-item">
              <span class="label">æœ€çµ‚æ›´æ–°:</span>
              <span class="text-sm text-gray-400">--:--</span>
            </div>
          </div>
        </section>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
        <div class="info-card glass-panel rounded-xl p-4">
          <h3 class="text-lg font-semibold text-white mb-3">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
              <span class="text-gray-300">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</span>
              <span id="current-user-email" class="text-cyan-400">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
              <span class="text-gray-300">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</span>
              <span id="current-user-id" class="text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
              <span class="text-gray-300">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</span>
              <button
                onclick="window.sharedUtilities.auth.switchToAnotherAccount()"
                type="button"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm transition-colors"
              >
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
              </button>
            </div>
          </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´° -->
        <section class="info-card glass-panel rounded-xl p-4">
          <h3 class="text-lg font-semibold text-white mb-3">ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°</h3>
          <div class="space-y-4">
            <div class="config-item">
              <span class="label">DBæ¥ç¶š:</span>
              <span class="status-badge published">æ­£å¸¸</span>
            </div>
            <div class="resource-section">
              <h4 class="text-cyan-400 font-medium mb-3">ğŸ“š ãƒªã‚½ãƒ¼ã‚¹</h4>
              <div class="resource-buttons space-y-2">
                <button
                  id="open-spreadsheet-btn"
                  class="resource-btn w-full px-3 py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                  onclick="openSpreadsheet()"
                  disabled
                >
                  <span>ğŸ“Š</span>
                  <span>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã</span>
                </button>

                <button
                  id="open-form-btn"
                  class="resource-btn w-full px-3 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed hidden"
                  onclick="openForm()"
                  disabled
                >
                  <span>ğŸ“</span>
                  <span>ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã</span>
                </button>

                <button
                  id="open-board-btn"
                  class="resource-btn w-full px-3 py-2 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-500 hover:to-purple-600 text-white rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed hidden"
                  onclick="openBoard()"
                  disabled
                >
                  <span>ğŸ¯</span>
                  <span>å…¬é–‹ãƒœãƒ¼ãƒ‰ã‚’é–‹ã</span>
                </button>

                <div id="resource-status" class="text-xs text-gray-400 mt-2 text-center">
                  è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="info-card glass-panel rounded-xl p-4">
          <h3 class="text-lg font-semibold text-white mb-3">âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
          <div class="space-y-3">
            <button class="link-btn w-full text-center" type="button" onclick="exportConfig()">
              è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            <button
              id="create-form-btn"
              class="link-btn w-full text-center"
              type="button"
              onclick="createFormInterface()"
            >
              ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ
            </button>
            <button
              id="app-setup-btn"
              class="link-btn w-full text-center hidden"
              type="button"
              onclick="goToAppSetup()"
            >
              âš™ï¸ ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢
            </button>
          </div>
        </section>
      </div>
    </div>

    <!-- ç¾åœ¨ã®ãƒœãƒ¼ãƒ‰æƒ…å ±ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer
      id="boardInfoFooter"
      class="fixed bottom-0 left-0 right-0 z-30 p-3"
      style="display: none"
    >
      <div class="glass-panel rounded-xl p-4 max-w-5xl mx-auto">
        <div class="flex items-center justify-between gap-4">
          <!-- å·¦å´ï¼šå•é¡Œæ–‡è¡¨ç¤º -->
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-yellow-400">ğŸ“</span>
              <span class="text-xs text-gray-400">ç¾åœ¨ã®å›ç­”ãƒœãƒ¼ãƒ‰</span>
            </div>
            <div id="currentQuestionText" class="text-white font-medium truncate">
              èª­ã¿è¾¼ã¿ä¸­...
            </div>
          </div>

          <!-- å³å´ï¼šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
          <div class="flex items-center gap-2 flex-shrink-0">
            <button
              id="copyViewUrlBtn"
              class="btn-secondary text-sm px-3 py-2"
              title="é–²è¦§ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå…±æœ‰ç”¨ï¼‰"
              style="display: none"
            >
              ğŸ“‹ URLã‚³ãƒ”ãƒ¼
            </button>
            <button
              id="openBoardBtn"
              class="btn-primary text-sm px-3 py-2"
              title="å›ç­”ãƒœãƒ¼ãƒ‰ã‚’é–‹ã"
              style="display: none"
            >
              ğŸ“Š ãƒœãƒ¼ãƒ‰ã‚’é–‹ã
            </button>
            <button
              id="refreshBoardInfo"
              class="btn-secondary text-sm px-2 py-2"
              title="æƒ…å ±ã‚’æ›´æ–°"
            >
              ğŸ”„
            </button>
          </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆæœ€å°é™ï¼‰ -->
        <div class="text-xs text-gray-500 mt-2" id="boardStatus">æœ€çµ‚æ›´æ–°: --:--</div>
      </div>
    </footer>

    <!-- SharedUtilities.html ã¯ä¸Šéƒ¨ã§æ—¢ã«ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰æ¸ˆã¿ -->

    <script>
      // ç°¡ç´ åŒ–ã•ã‚ŒãŸçŠ¶æ…‹ç®¡ç†
      let systemState = {
        loading: false,
        config: null,
      };

      // åˆæœŸåŒ–
      document.addEventListener('DOMContentLoaded', async function () {
        console.log('AdminPanelåˆæœŸåŒ–é–‹å§‹');

        try {
          // ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–ã‚’éåŒæœŸå®Ÿè¡Œ
          await initializePanel();

          // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ï¼ˆä¸¦è¡Œå®Ÿè¡Œï¼‰
          checkSystemAdminAccess();

          // ãƒ•ãƒƒã‚¿ãƒ¼ã®åˆæœŸåŒ–
          initializeFooter();

          console.log('AdminPanelå…¨ä½“åˆæœŸåŒ–å®Œäº†');
        } catch (error) {
          console.error('AdminPanelåˆæœŸåŒ–ã®è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:', error);
          showError('ç®¡ç†ãƒ‘ãƒãƒ«ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }

        // å®šæœŸçš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        setInterval(updateSystemStatus, 30000); // 30ç§’é–“éš”
      });

      // ãƒ•ãƒƒã‚¿ãƒ¼åˆæœŸåŒ–
      function initializeFooter() {
        console.log('ãƒ•ãƒƒã‚¿ãƒ¼åˆæœŸåŒ–é–‹å§‹');

        // åˆå›ãƒœãƒ¼ãƒ‰æƒ…å ±ãƒ­ãƒ¼ãƒ‰
        loadBoardInfo();

        // æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©è¨­å®š
        const refreshBtn = document.getElementById('refreshBoardInfo');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', loadBoardInfo);
        }

        // body paddingèª¿æ•´ï¼ˆãƒ•ãƒƒã‚¿ãƒ¼åˆ†ã®ä½™ç™½ã‚’è¿½åŠ ï¼‰
        document.body.classList.add('has-footer');

        console.log('ãƒ•ãƒƒã‚¿ãƒ¼åˆæœŸåŒ–å®Œäº†');
      }

      // ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      function updateSystemStatus() {
        updateLastUpdateTime();
      }

      // æœ€çµ‚æ›´æ–°æ™‚åˆ»æ›´æ–°
      function updateLastUpdateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ja-JP', {
          hour: '2-digit',
          minute: '2-digit',
        });
        const updateElement = document.getElementById('last-update');
        if (updateElement) {
          updateElement.textContent = `æœ€çµ‚åŒæœŸ: ${timeString}`;
        }
      }

      // ãƒ‘ãƒãƒ«åˆæœŸåŒ– - éåŒæœŸå¯¾å¿œç‰ˆï¼ˆå®Œå…¨ãªè‡ªå‹•åæ˜ æ©Ÿèƒ½ä»˜ãï¼‰
      async function initializePanel() {
        try {
          console.log('AdminPaneléåŒæœŸåˆæœŸåŒ–é–‹å§‹');
          setLoading(true);

          // ä¸¦è¡Œå‡¦ç†ã§åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
          await Promise.all([loadSpreadsheetListAsync(), loadUserInfoAsync()]);

          // è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§å®Œå…¨ã«è‡ªå‹•åæ˜ 
          await loadAndApplyCurrentConfig();

          console.log('AdminPaneléåŒæœŸåˆæœŸåŒ–å®Œäº†');
          showSuccess('âœ… ç®¡ç†ãƒ‘ãƒãƒ«ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ');
        } catch (error) {
          console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
          showError('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        } finally {
          setLoading(false);
        }
      }

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿ï¼ˆéåŒæœŸç‰ˆï¼‰
      function loadSpreadsheetListAsync() {
        return new Promise((resolve, reject) => {
          const select = document.getElementById('spreadsheet-select');
          select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';

          google.script.run
            .withSuccessHandler(function (spreadsheets) {
              select.innerHTML = '<option value="">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';
              spreadsheets.forEach((sheet) => {
                const option = document.createElement('option');
                option.value = sheet.id;
                option.textContent = sheet.name;
                select.appendChild(option);
              });
              console.log(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿å®Œäº†: ${spreadsheets.length}ä»¶`);
              resolve(spreadsheets);
            })
            .withFailureHandler(function (error) {
              console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
              select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
              reject(new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message));
            })
            .getSpreadsheetList();
        });
      }

      // æ—§ç‰ˆã¨ã®äº’æ›æ€§ç¶­æŒ
      function loadSpreadsheetList() {
        loadSpreadsheetListAsync().catch((error) => {
          showError(error.message);
        });
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿ï¼ˆéåŒæœŸç‰ˆï¼‰
      function loadUserInfoAsync() {
        return new Promise((resolve, reject) => {
          console.log('loadUserInfoAsync: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—é–‹å§‹');

          google.script.run
            .withSuccessHandler(function (email) {
              console.log('getUserEmailæˆåŠŸ:', email);
              if (email && email.trim()) {
                document.getElementById('current-user-email').textContent = email;
                console.log('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¡¨ç¤ºå®Œäº†:', email);

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¡¨ç¤ºï¼ˆ__USER_ID__ãŒã‚ã‚Œã°ä½¿ç”¨ï¼‰
                if (typeof __USER_ID__ !== 'undefined' && __USER_ID__) {
                  document.getElementById('current-user-id').textContent = __USER_ID__;
                } else {
                  document.getElementById('current-user-id').textContent = 'N/A';
                }

                resolve({ email, userId: __USER_ID__ || null });
              } else {
                console.warn('User email not found in response:', email);
                document.getElementById('current-user-email').textContent = 'å–å¾—ä¸­...';
                reject(new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'));
              }
            })
            .withFailureHandler(function (error) {
              console.error('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
              document.getElementById('current-user-email').textContent = 'ã‚¨ãƒ©ãƒ¼';
              reject(new Error('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message));
            })
            .getUser('email');
        });
      }

      // æ—§ç‰ˆã¨ã®äº’æ›æ€§ç¶­æŒï¼ˆå†è©¦è¡Œæ©Ÿèƒ½ä»˜ãï¼‰
      function loadUserInfo() {
        loadUserInfoAsync().catch((error) => {
          console.warn('åˆå›å–å¾—å¤±æ•—ã€å†è©¦è¡Œã—ã¾ã™:', error.message);
          setTimeout(() => {
            console.log('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—å†è©¦è¡Œ');
            loadUserInfoAsync().catch((retryError) => {
              showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + retryError.message);
            });
          }, 2000);
        });
      }

      // è¨­å®šãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨å®Œå…¨è‡ªå‹•åæ˜ ï¼ˆæ–°å®Ÿè£…ï¼‰
      async function loadAndApplyCurrentConfig() {
        console.log('loadAndApplyCurrentConfig: å®Œå…¨è‡ªå‹•åæ˜ é–‹å§‹');

        try {
          // è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’éåŒæœŸã§å–å¾—
          const config = await getCurrentConfigAsync();
          console.log('è¨­å®šãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', config);

          // ãƒªã‚½ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
          updateResourceButtons(config);

          // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¯ConfigurationManagerã§ç®¡ç†ã•ã‚Œã€ç›´æ¥å‚ç…§ã¯ä¸å¯
          // å¿…è¦ã«å¿œã˜ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIçµŒç”±ã§å–å¾—
          console.log('è¨­å®šåˆæœŸåŒ–å®Œäº†');

            // 2. ã‚·ãƒ¼ãƒˆè‡ªå‹•é¸æŠ
            if (config.sheetName) {
              await autoSelectSheet(config.sheetName);
            }

            // 3. åˆ—è¨­å®šã®è‡ªå‹•åˆæœŸåŒ–
            await autoInitializeColumnSettings(config);

            // 4. é€²æ—ã‚¹ãƒ†ãƒƒãƒ—ã®æ›´æ–°
            updateProgressFromConfig(config);

            showSuccess('âœ… æ—¢å­˜ã®è¨­å®šã‚’å®Œå…¨ã«åæ˜ ã—ã¾ã—ãŸ');
          } else {
            console.log('æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼: åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦');
            showInfo('ğŸ’¡ æ–°è¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¦ãã ã•ã„');
          }
        } catch (error) {
          console.error('è¨­å®šè‡ªå‹•åæ˜ ã‚¨ãƒ©ãƒ¼:', error);
          showError('è¨­å®šã®è‡ªå‹•åæ˜ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚ãƒªã‚½ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ã‚’åˆæœŸçŠ¶æ…‹ã§è¡¨ç¤º
          updateResourceButtons(null);
        }
      }

      // è¨­å®šãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆPromiseç‰ˆï¼‰
      function getCurrentConfigAsync() {
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getCurrentConfig();
        });
      }

      // æ—§ç‰ˆã¨ã®äº’æ›æ€§ç¶­æŒ
      function loadCurrentConfig() {
        loadAndApplyCurrentConfig().catch((error) => {
          console.error('loadCurrentConfigäº’æ›ç‰ˆã‚¨ãƒ©ãƒ¼:', error);
        });
      }

      // ========== è‡ªå‹•åæ˜ æ©Ÿèƒ½ç¾¤ ==========

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè‡ªå‹•é¸æŠ
      async function autoSelectSpreadsheet(spreadsheetId) {
        console.log('autoSelectSpreadsheet: è‡ªå‹•é¸æŠé–‹å§‹', spreadsheetId);

        try {
          const select = document.getElementById('spreadsheet-select');
          if (!select) {
            throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé¸æŠè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }

          // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰è©²å½“ã™ã‚‹IDã‚’æ¢ã™
          const option = Array.from(select.options).find((opt) => opt.value === spreadsheetId);
          if (option) {
            select.value = spreadsheetId;
            console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè‡ªå‹•é¸æŠå®Œäº†:', option.textContent);

            // ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚‚è‡ªå‹•èª­ã¿è¾¼ã¿
            await loadSheetListAsync(spreadsheetId);
            return true;
          } else {
            console.warn('æŒ‡å®šã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä¸€è¦§ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', spreadsheetId);
            // ç›´æ¥URLã§æ¥ç¶šã‚’è©¦è¡Œ
            showInfo('ğŸ’¡ è¨­å®šæ¸ˆã¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ç›´æ¥æ¥ç¶šã‚’è©¦è¡Œã—ã¾ã™');
            return false;
          }
        } catch (error) {
          console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè‡ªå‹•é¸æŠã‚¨ãƒ©ãƒ¼:', error);
          throw error;
        }
      }

      // ã‚·ãƒ¼ãƒˆè‡ªå‹•é¸æŠ
      async function autoSelectSheet(sheetName) {
        console.log('autoSelectSheet: è‡ªå‹•é¸æŠé–‹å§‹', sheetName);

        try {
          const select = document.getElementById('sheet-select');
          if (!select) {
            throw new Error('ã‚·ãƒ¼ãƒˆé¸æŠè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }

          // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰è©²å½“ã™ã‚‹åå‰ã‚’æ¢ã™
          const option = Array.from(select.options).find((opt) => opt.textContent === sheetName);
          if (option) {
            select.value = option.value;
            console.log('ã‚·ãƒ¼ãƒˆè‡ªå‹•é¸æŠå®Œäº†:', sheetName);
            return true;
          } else {
            console.warn('æŒ‡å®šã®ã‚·ãƒ¼ãƒˆãŒä¸€è¦§ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', sheetName);
            showInfo(`ğŸ’¡ ã‚·ãƒ¼ãƒˆã€Œ${sheetName}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„`);
            return false;
          }
        } catch (error) {
          console.error('ã‚·ãƒ¼ãƒˆè‡ªå‹•é¸æŠã‚¨ãƒ©ãƒ¼:', error);
          throw error;
        }
      }

      // åˆ—è¨­å®šã®è‡ªå‹•åˆæœŸåŒ–ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†å¼·åŒ–ç‰ˆï¼‰
      async function autoInitializeColumnSettings(config) {
        console.log('autoInitializeColumnSettings: åˆ—è¨­å®šè‡ªå‹•åˆæœŸåŒ–é–‹å§‹', config);

        try {
          // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¯ConfigurationManagerã§ç®¡ç†ã•ã‚Œã‚‹ãŸã‚ã€APIçµŒç”±ã§å–å¾—ãŒå¿…è¦
          let sheetName = config.sheetName;

          if (!spreadsheetId) {
            console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒä¸è¶³ã€åˆ—è¨­å®šã‚¹ã‚­ãƒƒãƒ—');
            return;
          }

          // ã‚·ãƒ¼ãƒˆåãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã®è‡ªå‹•æ¤œå‡ºãƒ»é¸æŠ
          if (!sheetName) {
            console.log('ã‚·ãƒ¼ãƒˆåãŒä¸è¶³ã€è‡ªå‹•æ¤œå‡ºã‚’å®Ÿè¡Œ');
            try {
              const sheets = await loadSheetListAsync(spreadsheetId);
              if (sheets && sheets.length > 0) {
                // å„ªå…ˆé †ä½ã§ã‚·ãƒ¼ãƒˆã‚’é¸æŠ
                sheetName = detectBestSheetName(sheets);
                console.log('è‡ªå‹•æ¤œå‡ºã«ã‚ˆã‚‹ã‚·ãƒ¼ãƒˆé¸æŠ:', sheetName);

                // UIæ›´æ–°: è‡ªå‹•é¸æŠã•ã‚ŒãŸã‚·ãƒ¼ãƒˆã‚’åæ˜ 
                await autoSelectSheet(sheetName);
              } else {
                throw new Error('åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              }
            } catch (sheetError) {
              console.warn('ã‚·ãƒ¼ãƒˆè‡ªå‹•æ¤œå‡ºå¤±æ•—:', sheetError.message);
              sheetName = 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              showInfo('ğŸ’¡ ã‚·ãƒ¼ãƒˆæƒ…å ±ã®è‡ªå‹•æ¤œå‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
              return;
            }
          }

          // æ—¢å­˜ã®åˆ—è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (config.columnMapping || config.columnSelections) {
            console.log('æ—¢å­˜ã®åˆ—è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åˆ—è¨­å®šã‚’å¾©å…ƒ
            await restoreColumnSettingsFromConfig(config, sheetName);
          } else {
            console.log('åˆ—è¨­å®šãƒ‡ãƒ¼ã‚¿ãªã—ã€AIåˆ†æã‚’å®Ÿè¡Œ');
            // æ–°è¦ã«AIåˆ†æå®Ÿè¡Œ
            await analyzeAndSetupColumns(spreadsheetId, sheetName);
          }
        } catch (error) {
          console.error('åˆ—è¨­å®šè‡ªå‹•åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
          showError('åˆ—è¨­å®šã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      }

      // æœ€é©ãªã‚·ãƒ¼ãƒˆåã‚’æ¤œå‡º
      function detectBestSheetName(sheets) {
        console.log('detectBestSheetName: æœ€é©ã‚·ãƒ¼ãƒˆæ¤œå‡ºé–‹å§‹', sheets);

        // å„ªå…ˆé †ä½ãƒªã‚¹ãƒˆ
        const priorities = ['ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1', 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”', 'Sheet1', 'ã‚·ãƒ¼ãƒˆ1'];

        // å„ªå…ˆåã‹ã‚‰æ¤œç´¢
        for (const priority of priorities) {
          const sheet = sheets.find((s) => s.name === priority);
          if (sheet && sheet.rowCount > 1) {
            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            console.log('å„ªå…ˆã‚·ãƒ¼ãƒˆé¸æŠ:', priority);
            return priority;
          }
        }

        // ãƒ‡ãƒ¼ã‚¿ãŒæœ€ã‚‚å¤šã„ã‚·ãƒ¼ãƒˆã‚’é¸æŠ
        const sheetsWithData = sheets
          .filter((s) => s.rowCount > 1)
          .sort((a, b) => b.rowCount - a.rowCount);

        if (sheetsWithData.length > 0) {
          const selected = sheetsWithData[0].name;
          console.log('ãƒ‡ãƒ¼ã‚¿æœ€å¤§ã‚·ãƒ¼ãƒˆé¸æŠ:', selected);
          return selected;
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€åˆã®ã‚·ãƒ¼ãƒˆ
        const fallback = sheets[0].name;
        console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é¸æŠ:', fallback);
        return fallback;
      }

      // æ—¢å­˜ã®åˆ—è¨­å®šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾©å…ƒï¼ˆå¼•æ•°æ›´æ–°ç‰ˆï¼‰
      async function restoreColumnSettingsFromConfig(config, sheetName) {
        console.log('restoreColumnSettingsFromConfig: æ—¢å­˜è¨­å®šå¾©å…ƒé–‹å§‹', { config, sheetName });

        try {
          // æœ‰åŠ¹ãªã‚·ãƒ¼ãƒˆåã‚’æ±ºå®š
          const targetSheetName = sheetName || config.sheetName;
          if (!targetSheetName) {
            throw new Error('å¾©å…ƒã«å¿…è¦ãªã‚·ãƒ¼ãƒˆåãŒä¸è¶³ã—ã¦ã„ã¾ã™');
          }

          // åˆ—æ§‹é€ åˆ†æã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒå¿…è¦ãªå ´åˆã¯APIçµŒç”±ã§å®Ÿè¡Œ
          console.log('åˆ—æ§‹é€ åˆ†æã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸï¼ˆConfigurationManagerçµ±åˆä¸­ï¼‰');
          const result = { success: false, message: 'ConfigurationManagerçµ±åˆä¸­' };

          if (result && result.success && result.headers) {
            console.log('åˆ—æ§‹é€ åˆ†æå®Œäº†ã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¨­å®š');

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
            populateColumnDropdowns(result.headers, result.columnMapping || {});

            // æ—¢å­˜ã®é¸æŠçŠ¶æ³ãŒã‚ã‚Œã°åæ˜ 
            if (config.columnSelections) {
              applyPreviousColumnSelections(config.columnSelections);
            }

            console.log('æ—¢å­˜è¨­å®šã‹ã‚‰ã®åˆ—è¨­å®šå¾©å…ƒå®Œäº†');
          } else {
            throw new Error('åˆ—æ§‹é€ ã®åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } catch (error) {
          console.error('æ—¢å­˜è¨­å®šå¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
          throw error;
        }
      }

      // æ–°è¦AIåˆ†æã¨åˆ—è¨­å®š
      async function analyzeAndSetupColumns(spreadsheetId, sheetName) {
        console.log('analyzeAndSetupColumns: æ–°è¦AIåˆ†æé–‹å§‹');

        try {
          const result = await analyzeColumnsAsync(spreadsheetId, sheetName);

          if (result && result.success) {
            console.log('AIåˆ†æå®Œäº†ã€åˆ—è¨­å®šUIã‚’æ›´æ–°');
            updateColumnMapping(result);
          } else {
            throw new Error(result.error || 'AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } catch (error) {
          console.error('æ–°è¦AIåˆ†æã‚¨ãƒ©ãƒ¼:', error);
          throw error;
        }
      }

      // ä»¥å‰ã®åˆ—é¸æŠã‚’å¾©å…ƒ
      function applyPreviousColumnSelections(columnSelections) {
        console.log('applyPreviousColumnSelections: ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ', columnSelections);

        Object.keys(columnSelections).forEach((columnType) => {
          if (columnType.startsWith('_')) return; // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ã‚­ãƒƒãƒ—

          const selection = columnSelections[columnType];
          const dropdown = document.getElementById(`${columnType}-column-select`);

          if (dropdown && selection && typeof selection.columnIndex === 'number') {
            dropdown.value = selection.columnIndex;

            // é¸æŠã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¯ãƒ©ã‚¹è¨­å®š
            if (selection.selectionType === 'manual') {
              dropdown.classList.add('has-manual-selection');
              showConfidenceBadge(columnType, 100, 'manual');
            } else {
              dropdown.classList.add('has-ai-selection');
              showConfidenceBadge(columnType, selection.confidence || 0, 'ai');
            }

            console.log(`åˆ—é¸æŠå¾©å…ƒ: ${columnType} â†’ ${selection.columnLabel}`);
          }
        });
      }

      // é€²æ—ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¨­å®šã‹ã‚‰æ›´æ–°
      function updateProgressFromConfig(config) {
        console.log('updateProgressFromConfig: é€²æ—æ›´æ–°é–‹å§‹', config);

        try {
          let currentStep = 1;

          if (config.sheetName) {
            currentStep = 2; // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶šå®Œäº†
          }

          if (config.columnMapping || config.columnSelections) {
            currentStep = 2; // åˆ—è¨­å®šå®Œäº†
          }

          if (config.setupComplete) {
            currentStep = 3; // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†
          }

          console.log('é€²æ—ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°:', currentStep);
          updateProgress(currentStep);
        } catch (error) {
          console.error('é€²æ—æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      // éåŒæœŸç‰ˆã®è£œåŠ©é–¢æ•°ç¾¤
      function loadSheetListAsync(spreadsheetId) {
        return new Promise((resolve, reject) => {
          const select = document.getElementById('sheet-select');
          select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';

          google.script.run
            .withSuccessHandler(function (sheets) {
              select.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';
              sheets.forEach((sheet) => {
                const option = document.createElement('option');
                option.value = sheet.name;
                option.textContent = sheet.name;
                select.appendChild(option);
              });
              console.log(`ã‚·ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿å®Œäº†: ${sheets.length}ä»¶`);
              resolve(sheets);
            })
            .withFailureHandler(function (error) {
              console.error('ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
              select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
              reject(new Error('ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message));
            })
            .getSheetList(spreadsheetId);
        });
      }

      function analyzeColumnsAsync(spreadsheetId, sheetName) {
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .analyzeColumns(spreadsheetId, sheetName);
        });
      }

      // ========== ãƒªã‚½ãƒ¼ã‚¹ãƒœã‚¿ãƒ³é–¢é€£é–¢æ•° ==========

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ–°ã‚¿ãƒ–ã§é–‹ã
      function openSpreadsheet() {
        const btn = document.getElementById('open-spreadsheet-btn');
        const spreadsheetId = btn.dataset.spreadsheetId;

        if (!spreadsheetId) {
          showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        const spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/' + spreadsheetId + '/edit';
        window.open(spreadsheetUrl, '_blank');
        showSuccess('ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ãã¾ã—ãŸ');
      }

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ–°ã‚¿ãƒ–ã§é–‹ã
      function openForm() {
        const btn = document.getElementById('open-form-btn');
        const formUrl = btn.dataset.formUrl;

        if (!formUrl) {
          showError('ãƒ•ã‚©ãƒ¼ãƒ URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        window.open(formUrl, '_blank');
        showSuccess('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ãã¾ã—ãŸ');
      }

      // å…¬é–‹ãƒœãƒ¼ãƒ‰ã‚’æ–°ã‚¿ãƒ–ã§é–‹ã
      function openBoard() {
        const btn = document.getElementById('open-board-btn');
        const boardUrl = btn.dataset.boardUrl;

        if (!boardUrl) {
          showError('ãƒœãƒ¼ãƒ‰URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        window.open(boardUrl, '_blank');
        showSuccess('ğŸ¯ å…¬é–‹ãƒœãƒ¼ãƒ‰ã‚’é–‹ãã¾ã—ãŸ');
      }

      // ãƒªã‚½ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
      function updateResourceButtons(config) {
        console.log('updateResourceButtons: ãƒªã‚½ãƒ¼ã‚¹ãƒœã‚¿ãƒ³æ›´æ–°', config);

        const spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
        const formBtn = document.getElementById('open-form-btn');
        const boardBtn = document.getElementById('open-board-btn');
        const statusDiv = document.getElementById('resource-status');

        // è¨­å®šãŒç„¡ã„å ´åˆã®åˆæœŸçŠ¶æ…‹
        if (!config) {
          spreadsheetBtn.disabled = true;
          spreadsheetBtn.dataset.spreadsheetId = '';
          formBtn.classList.add('hidden');
          boardBtn.classList.add('hidden');
          statusDiv.textContent = 'è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
          return;
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã¯ConfigurationManagerã§ç®¡ç†ã•ã‚Œã‚‹ãŸã‚ã€APIçµŒç”±ã§å–å¾—
        spreadsheetBtn.disabled = true;
        statusDiv.textContent = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ©Ÿèƒ½ã¯ConfigurationManagerçµ±åˆä¸­';

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒœã‚¿ãƒ³ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ¸ˆã¿ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰
        if (config.formCreated && config.formUrl) {
          formBtn.classList.remove('hidden');
          formBtn.disabled = false;
          formBtn.dataset.formUrl = config.formUrl;
        } else {
          formBtn.classList.add('hidden');
        }

        // å…¬é–‹ãƒœãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆã‚¢ãƒ—ãƒªå…¬é–‹æ¸ˆã¿ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰
        if (config.appPublished && config.boardUrl) {
          boardBtn.classList.remove('hidden');
          boardBtn.disabled = false;
          boardBtn.dataset.boardUrl = config.boardUrl;
        } else if (config.appPublished) {
          // å…¬é–‹æ¸ˆã¿ã ãŒURLãŒç„¡ã„å ´åˆã¯ã€å‹•çš„ã«ç”Ÿæˆ
          boardBtn.classList.remove('hidden');
          boardBtn.disabled = false;
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‹ã‚‰ãƒœãƒ¼ãƒ‰URLã‚’ç”Ÿæˆ
          const baseUrl = window.location.origin + window.location.pathname;
          boardBtn.dataset.boardUrl = `${baseUrl}?userId=${config.tenantId}`;
        } else {
          boardBtn.classList.add('hidden');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        let statusParts = [];
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ConfigurationManagerçµŒç”±ã§å–å¾—
        if (config.formCreated) statusParts.push('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ ');
        if (config.appPublished) statusParts.push('ğŸ¯ ãƒœãƒ¼ãƒ‰');

        if (statusParts.length > 0) {
          statusDiv.textContent = `âœ… åˆ©ç”¨å¯èƒ½: ${statusParts.join(', ')}`;
          statusDiv.className = 'text-xs text-green-400 mt-2 text-center';
        } else {
          statusDiv.textContent = 'ğŸ’¡ ãƒªã‚½ãƒ¼ã‚¹ã®è¨­å®šã‚’é–‹å§‹ã—ã¦ãã ã•ã„';
          statusDiv.className = 'text-xs text-yellow-400 mt-2 text-center';
        }
      }

      // ä¸è¦ãªã‚·ã‚¹ãƒ†ãƒ ç›£è¦–æ©Ÿèƒ½ã‚’å‰Šé™¤

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è¨­å®š - SharedUtilitiesã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
      function setLoading(loading) {
        systemState.loading = loading;
        if (window.sharedUtilities && window.sharedUtilities.ui) {
          if (loading) {
            window.sharedUtilities.ui.showLoading();
          } else {
            window.sharedUtilities.ui.hideLoading();
          }
        }
      }

      // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º (SharedUtilitiesã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨)
      function showError(message) {
        if (window.sharedUtilities && window.sharedUtilities.notifications) {
          window.sharedUtilities.notifications.error(message);
        } else {
          console.error('Error:', message);
          alert('ã‚¨ãƒ©ãƒ¼: ' + message);
        }
      }

      // æˆåŠŸè¡¨ç¤º (SharedUtilitiesã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨)
      function showSuccess(message) {
        if (window.sharedUtilities && window.sharedUtilities.notifications) {
          window.sharedUtilities.notifications.success(message);
        } else {
          console.log('Success:', message);
          alert('æˆåŠŸ: ' + message);
        }
      }

      // æƒ…å ±è¡¨ç¤º (SharedUtilitiesã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨)
      function showInfo(message) {
        if (window.sharedUtilities && window.sharedUtilities.notifications) {
          window.sharedUtilities.notifications.info(message);
        } else {
          console.log('Info:', message);
          alert('æƒ…å ±: ' + message);
        }
      }

      // è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      function exportConfig() {
        google.script.run
          .withSuccessHandler(function (config) {
            const dataStr = JSON.stringify(config, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = 'studyquest-config.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            showSuccess('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
          })
          .withFailureHandler(function (error) {
            console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            showError('è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
          })
          .getCurrentConfig();
      }

      // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
      function checkSystemAdminAccess() {
        google.script.run
          .withSuccessHandler(function (isAdmin) {
            if (isAdmin) {
              console.log('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã—ãŸ');
              document.getElementById('app-setup-btn').style.display = 'block';
            } else {
              console.log('ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã—ãŸ');
              document.getElementById('app-setup-btn').style.display = 'none';
            }
          })
          .withFailureHandler(function (error) {
            console.warn('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('app-setup-btn').style.display = 'none';
          })
          .checkIsSystemAdmin();
      }

      // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
      function createFormInterface() {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ç¢ºèª
        if (!__USER_ID__ || __USER_ID__.trim() === '') {
          showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        const formName = prompt(
          'ä½œæˆã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\nä¾‹ï¼šã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€è³ªå•ãƒ•ã‚©ãƒ¼ãƒ '
        );

        if (!formName || !formName.trim()) {
          showError('ãƒ•ã‚©ãƒ¼ãƒ åãŒå…¥åŠ›ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
          return;
        }

        if (formName.trim().length > 50) {
          showError('ãƒ•ã‚©ãƒ¼ãƒ åã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        // åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ è¨­å®š
        const config = {
          title: formName.trim(),
          description: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ',
          fields: [
            {
              type: 'text',
              label: 'åå‰',
              required: true,
            },
            {
              type: 'text',
              label: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
              required: true,
            },
          ],
        };

        console.log('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆé–‹å§‹:', { userId: __USER_ID__, config });
        setLoading(true);

        google.script.run
          .withSuccessHandler(function (result) {
            if (result.success) {
              showSuccess('ãƒ•ã‚©ãƒ¼ãƒ ã€Œ' + formName + 'ã€ã‚’ä½œæˆã—ã¾ã—ãŸ');
              if (result.formUrl) {
                const openForm = confirm('ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚ä»Šã™ãé–‹ãã¾ã™ã‹ï¼Ÿ');
                if (openForm) {
                  window.open(result.formUrl, '_blank');
                }
              }
            } else {
              showError(result.error || 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            setLoading(false);
          })
          .withFailureHandler(function (error) {
            console.error('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            showError('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'Unknown error'));
            setLoading(false);
          })
          .createForm(__USER_ID__, config);
      }

      // ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
      function goToAppSetup() {
        setLoading(true);
        google.script.run
          .withSuccessHandler(function (webAppUrl) {
            const setupUrl = webAppUrl + '?mode=appSetup';
            window.open(setupUrl, '_top');
          })
          .withFailureHandler(function (error) {
            console.error('ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®é·ç§»ã‚¨ãƒ©ãƒ¼:', error);
            showError('ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
            setLoading(false);
          })
          .getWebAppUrl();
      }

      // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠæ–¹å¼ã®åˆ‡ã‚Šæ›¿ãˆ
      function toggleSourceMethod(method) {
        const dropdownMethod = document.getElementById('dropdown-method');
        const urlMethod = document.getElementById('url-method');

        if (method === 'url') {
          dropdownMethod.classList.add('hidden');
          urlMethod.classList.remove('hidden');
        } else {
          dropdownMethod.classList.remove('hidden');
          urlMethod.classList.add('hidden');
        }
      }

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLæ¤œè¨¼
      function validateSpreadsheetUrl() {
        const urlInput = document.getElementById('spreadsheet-url');
        const url = urlInput.value.trim();

        if (!url) {
          showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã®åŸºæœ¬çš„ãªæ¤œè¨¼
        const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
        const match = url.match(spreadsheetRegex);

        if (!match) {
          showError('æœ‰åŠ¹ãªGoogleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        const spreadsheetId = match[1];
        setLoading(true);

        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèª
        google.script.run
          .withSuccessHandler(function (result) {
            setLoading(false);
            if (result.success) {
              showSuccess('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒç¢ºèªã§ãã¾ã—ãŸ');
              // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜
              urlInput.dataset.spreadsheetId = spreadsheetId;
              // ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
              if (result.sheets && result.sheets.length > 0) {
                updateSheetNameSuggestions(result.sheets);
              }
            } else {
              showError(
                'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: ' + (result.error || 'Unknown error')
              );
            }
          })
          .withFailureHandler(function (error) {
            setLoading(false);
            console.error('URLæ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', error);
            showError('URLæ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          })
          .validateAccess(spreadsheetId);
      }

      // ã‚·ãƒ¼ãƒˆåå€™è£œã‚’æ›´æ–°
      function updateSheetNameSuggestions(sheets) {
        const sheetNameInput = document.getElementById('sheet-name-input');
        if (sheets && sheets.length > 0) {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’è¨­å®š
          sheetNameInput.value = sheets[0].name;

          // datalistã§å€™è£œã‚’è¡¨ç¤ºï¼ˆã‚ˆã‚Šè‰¯ã„UXï¼‰
          let datalist = document.getElementById('sheet-suggestions');
          if (!datalist) {
            datalist = document.createElement('datalist');
            datalist.id = 'sheet-suggestions';
            sheetNameInput.setAttribute('list', 'sheet-suggestions');
            sheetNameInput.parentNode.appendChild(datalist);
          }

          datalist.innerHTML = '';
          sheets.forEach((sheet) => {
            const option = document.createElement('option');
            option.value = sheet.name;
            datalist.appendChild(option);
          });
        }
      }

      // URLå…¥åŠ›æ–¹å¼ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶š
      function connectToUrlSource() {
        const urlInput = document.getElementById('spreadsheet-url');
        const sheetNameInput = document.getElementById('sheet-name-input');

        const url = urlInput.value.trim();
        const sheetName = sheetNameInput.value.trim();

        if (!url) {
          showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        if (!sheetName) {
          showError('ã‚·ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        // URLã‹ã‚‰ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’æŠ½å‡º
        const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
        const match = url.match(spreadsheetRegex);

        if (!match) {
          showError('æœ‰åŠ¹ãªGoogleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        const spreadsheetId = match[1];

        console.log('URLå…¥åŠ›æ–¹å¼ã§æ¥ç¶šé–‹å§‹:', { spreadsheetId, sheetName });
        setLoading(true);

        // æ—¢å­˜ã®connectToSourceé–¢æ•°ã¨åŒæ§˜ã®å‡¦ç†ã‚’å®Ÿè¡Œ
        google.script.run
          .withSuccessHandler(function (result) {
            console.log('URLå…¥åŠ›æ¥ç¶šæˆåŠŸ:', result);
            if (result && result.success) {
              // æ–°ã—ã„ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¼åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ›´æ–°
              updateColumnMapping(result);
              updateProgress(2);
              showSuccess('URLå…¥åŠ›æ–¹å¼ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ¥ç¶šã—ã¾ã—ãŸ');
            } else {
              showError(result.error || 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            setLoading(false);
          })
          .withFailureHandler(function (error) {
            console.error('URLå…¥åŠ›æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
            showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            setLoading(false);
          })
          .analyzeColumns(spreadsheetId, sheetName);
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      document.addEventListener('DOMContentLoaded', function () {
        // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠæ–¹å¼ã®åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('input[name="source-method"]').forEach((radio) => {
          radio.addEventListener('change', function () {
            toggleSourceMethod(this.value);
          });
        });

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé¸æŠæ™‚
        document.getElementById('spreadsheet-select').addEventListener('change', function () {
          const spreadsheetId = this.value;
          if (spreadsheetId) {
            loadSheetList(spreadsheetId);
          }
        });

        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒœã‚¿ãƒ³
        document.getElementById('refresh-data').addEventListener('click', function () {
          loadSpreadsheetList();
        });

        // æ¥ç¶šãƒœã‚¿ãƒ³ï¼ˆä¸€è¦§é¸æŠï¼‰
        document.getElementById('connect-source').addEventListener('click', function () {
          connectToSource();
        });

        // URLæ¤œè¨¼ãƒœã‚¿ãƒ³
        document.getElementById('url-validate').addEventListener('click', function () {
          validateSpreadsheetUrl();
        });

        // æ¥ç¶šãƒœã‚¿ãƒ³ï¼ˆURLå…¥åŠ›ï¼‰
        document.getElementById('connect-url-source').addEventListener('click', function () {
          connectToUrlSource();
        });

        // è¨­å®šç¢ºèªãƒœã‚¿ãƒ³
        document.getElementById('verify-mapping').addEventListener('click', function () {
          verifyColumnMapping();
        });

        // ä¸‹æ›¸ãä¿å­˜ãƒœã‚¿ãƒ³
        document.getElementById('save-draft').addEventListener('click', function () {
          saveDraft();
        });

        // å…¬é–‹ãƒœã‚¿ãƒ³
        document.getElementById('publish-now').addEventListener('click', function () {
          publishApp();
        });
      });

      // ã‚·ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
      function loadSheetList(spreadsheetId) {
        const select = document.getElementById('sheet-select');
        select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';

        google.script.run
          .withSuccessHandler(function (sheets) {
            select.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';
            sheets.forEach((sheet) => {
              const option = document.createElement('option');
              option.value = sheet.name;
              option.textContent = sheet.name;
              select.appendChild(option);
            });
          })
          .withFailureHandler(function (error) {
            console.error('ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
          })
          .getSheetList(spreadsheetId);
      }

      // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ¥ç¶š
      function connectToSource() {
        const spreadsheetId = document.getElementById('spreadsheet-select').value;
        const sheetName = document.getElementById('sheet-select').value;

        // å…¥åŠ›æ¤œè¨¼ã‚’è©³ç´°åŒ–
        if (!spreadsheetId) {
          showError(
            'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚å…ˆã«ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚'
          );
          return;
        }

        if (!sheetName) {
          showError(
            'ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€ã‚·ãƒ¼ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚'
          );
          return;
        }

        setLoading(true);
        console.log('connectToSource: æ¥ç¶šé–‹å§‹', { spreadsheetId, sheetName });

        google.script.run
          .withSuccessHandler(function (result) {
            console.log('connectToSource: æ¥ç¶šçµæœ', result);

            if (result.success) {
              showSuccess('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«æ¥ç¶šã—ã¾ã—ãŸ');
              // é€²æ—æ›´æ–°
              updateProgress(2);

              // æ–°ã—ã„ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¼åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ›´æ–°
              updateColumnMapping(result);

              // è‡ªå‹•æ¤œå‡ºã®ä¿¡é ¼åº¦ã‚’ãƒã‚§ãƒƒã‚¯
              if (result.columnMapping && result.columnMapping.confidence) {
                const confidence = result.columnMapping.confidence;
                const avgConfidence =
                  Object.values(confidence).reduce((sum, val) => sum + (val || 0), 0) /
                  Math.max(Object.keys(confidence).length, 1);

                if (avgConfidence < 70) {
                  showInfo('ğŸ’¡ AIæ¤œå‡ºã®ä¿¡é ¼åº¦ãŒä½ã‚ã§ã™ã€‚ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§æ‰‹å‹•èª¿æ•´ã—ã¦ãã ã•ã„ã€‚');
                }
              }
            } else {
              handleConnectionError(result.error, { spreadsheetId, sheetName });
            }
            setLoading(false);
          })
          .withFailureHandler(function (error) {
            console.error('connectToSource æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
            handleConnectionError(error.message || error, { spreadsheetId, sheetName });
            setLoading(false);
          })
          .connectDataSource(spreadsheetId, sheetName);
      }

      // æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      function handleConnectionError(errorMessage, context) {
        console.error('Connection error details:', { errorMessage, context });

        let userMessage = 'ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        let suggestions = [];

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åŸºã¥ãè©³ç´°ãªè¨ºæ–­
        if (errorMessage.includes('Permission') || errorMessage.includes('æ¨©é™')) {
          suggestions.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
          suggestions.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ã¦ã€ç·¨é›†æ¨©é™ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        } else if (errorMessage.includes('not found') || errorMessage.includes('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
          suggestions.push('æŒ‡å®šã•ã‚ŒãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¾ãŸã¯ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
          suggestions.push('ã‚·ãƒ¼ãƒˆåãŒæ­£ç¢ºã‹ç¢ºèªã—ã¦ãã ã•ã„');
        } else if (errorMessage.includes('timeout') || errorMessage.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
          suggestions.push('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
          suggestions.push('ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„');
        } else {
          suggestions.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒé–‹ã‘ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
          suggestions.push('æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™');
        }

        const fullMessage =
          userMessage + '\n\næ¨å¥¨å¯¾å‡¦æ³•:\n' + suggestions.map((s) => 'â€¢ ' + s).join('\n');
        showError(fullMessage);

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¼ã§ã¯æ‰‹å‹•è¨­å®šã¯è‡ªå‹•çš„ã«åˆ©ç”¨å¯èƒ½
        showInfo('ğŸ’¡ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ä½¿ç”¨ã—ã¦æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã§ãã¾ã™ã€‚');
      }

      // æ‰‹å‹•è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¼ã§ã¯ä¸è¦ - å‰Šé™¤æ¸ˆã¿ï¼‰
      // æ‰‹å‹•åˆ—è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¼ã§ã¯ä¸è¦ - å‰Šé™¤æ¸ˆã¿ï¼‰

      // é€²æ—æ›´æ–°
      function updateProgress(step) {
        const steps = document.querySelectorAll('.step');
        steps.forEach((stepEl, index) => {
          stepEl.classList.remove('completed', 'current');
          if (index < step - 1) {
            stepEl.classList.add('completed');
          } else if (index === step - 1) {
            stepEl.classList.add('current');
          }
        });
      }

      // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æ›´æ–°ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¼ï¼‰
      function updateColumnMapping(result) {
        console.log('Column mapping received:', result);

        if (!result || !result.success) {
          console.warn('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°çµæœãŒä¸æ­£ã§ã™');
          showError('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }

        const mapping = result.columnMapping;
        const headers = result.headers || [];

        console.log('Headers:', headers, 'Mapping:', mapping);

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
        populateColumnDropdowns(headers, mapping);

        // AIæ¤œå‡ºæƒ…å ±ã‚’è¡¨ç¤º
        displayAIDetectionInfo(mapping);

        showSuccess('âœ… åˆ—è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      }

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
      function populateColumnDropdowns(headers, mapping) {
        console.log('populateColumnDropdowns:', { headers, mapping });

        // 4ã¤ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å–å¾—
        const dropdowns = {
          answer: document.getElementById('answer-column-select'),
          reason: document.getElementById('reason-column-select'),
          class: document.getElementById('class-column-select'),
          name: document.getElementById('name-column-select'),
        };

        // å„ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        Object.keys(dropdowns).forEach((columnType) => {
          const dropdown = dropdowns[columnType];
          if (!dropdown) return;

          // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
          dropdown.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„...</option>';

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¿½åŠ 
          headers.forEach((header, index) => {
            if (header && header.trim()) {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = `${String.fromCharCode(65 + index)}åˆ—: ${header}`;
              dropdown.appendChild(option);
            }
          });
        });

        // AIæ¤œå‡ºçµæœã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®åˆæœŸé¸æŠã¨ã—ã¦è¨­å®š
        setAIDetectionSelections(mapping, dropdowns);

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        setupDropdownEventListeners(dropdowns);
      }

      // AIæ¤œå‡ºçµæœã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®åˆæœŸé¸æŠã¨ã—ã¦è¨­å®š
      function setAIDetectionSelections(mapping, dropdowns) {
        console.log('setAIDetectionSelections:', mapping);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ç¾åœ¨ã®AIæ¤œå‡ºçµæœã‚’ä¿å­˜
        window.currentAIMapping = mapping;

        // ãƒãƒƒãƒ”ãƒ³ã‚°ã®å¯¾å¿œé–¢ä¿‚ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®convertIndicesToMappingã¨çµ±ä¸€ï¼‰
        const mappingKeys = {
          answer: ['answer'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®COLUMN_HEADERS.OPINION â†’ answer
          reason: ['reason'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®COLUMN_HEADERS.REASON â†’ reason
          class: ['class'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®COLUMN_HEADERS.CLASS â†’ class
          name: ['name'], // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®COLUMN_HEADERS.NAME â†’ name
        };

        Object.keys(dropdowns).forEach((columnType) => {
          const dropdown = dropdowns[columnType];
          if (!dropdown) return;

          // å¯¾å¿œã™ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚­ãƒ¼ã‚’æ¢ã™
          let selectedIndex = null;
          let confidence = 0;

          mappingKeys[columnType].forEach((key) => {
            if (mapping[key] !== null && mapping[key] !== undefined) {
              selectedIndex = mapping[key];
              confidence =
                mapping.confidence && mapping.confidence[key] ? mapping.confidence[key] : 0;
            }
          });

          if (selectedIndex !== null) {
            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠã‚’è¨­å®š
            dropdown.value = selectedIndex;
            dropdown.classList.add('has-ai-selection');

            // ä¿¡é ¼åº¦ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
            showConfidenceBadge(columnType, confidence, 'ai');

            console.log(`AIæ¤œå‡º: ${columnType} â†’ ${selectedIndex}åˆ— (ä¿¡é ¼åº¦: ${confidence}%)`);
          }
        });

        // AIæ¤œå‡ºæƒ…å ±ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
        const aiInfo = document.getElementById('ai-detection-info');
        if (aiInfo) {
          aiInfo.classList.remove('hidden');
        }
      }

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      function setupDropdownEventListeners(dropdowns) {
        Object.keys(dropdowns).forEach((columnType) => {
          const dropdown = dropdowns[columnType];
          if (!dropdown) return;

          dropdown.addEventListener('change', function () {
            handleDropdownChange(columnType, this);
          });
        });

        // AIæ¤œå‡ºã«æˆ»ã™ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const resetButton = document.getElementById('reset-to-ai');
        if (resetButton) {
          resetButton.addEventListener('click', function () {
            resetToAIDetection();
          });
        }
      }

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤‰æ›´ã®å‡¦ç†
      function handleDropdownChange(columnType, dropdown) {
        const selectedValue = dropdown.value;
        console.log(`ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤‰æ›´: ${columnType} â†’ ${selectedValue}`);

        // æ—¢å­˜ã®CSSã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        dropdown.classList.remove('has-ai-selection', 'has-manual-selection');

        if (selectedValue === '') {
          // é¸æŠè§£é™¤
          hideConfidenceBadge(columnType);
        } else {
          // æ‰‹å‹•é¸æŠ
          dropdown.classList.add('has-manual-selection');
          showConfidenceBadge(columnType, 100, 'manual');

          // AIæ¤œå‡ºã«æˆ»ã™ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          const resetButton = document.getElementById('reset-to-ai');
          if (resetButton) {
            resetButton.style.display = 'inline-block';
          }

          // æ‰‹å‹•è¨­å®šæƒ…å ±ã‚’è¡¨ç¤º
          const manualInfo = document.getElementById('manual-override-info');
          if (manualInfo) {
            manualInfo.classList.remove('hidden');
          }
        }

        // é¸æŠçŠ¶æ³ã‚’æ›´æ–°
        updateSelectionStatus();
      }

      // ä¿¡é ¼åº¦ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
      function showConfidenceBadge(columnType, confidence, type) {
        const confidenceDiv = document.getElementById(`${columnType}-confidence`);
        const badge = confidenceDiv.querySelector('.confidence-badge');

        if (!confidenceDiv || !badge) return;

        let badgeClass = '';
        let badgeText = '';

        if (type === 'manual') {
          badgeClass = 'manual';
          badgeText = 'âœ‹ æ‰‹å‹•è¨­å®š';
        } else {
          // AIæ¤œå‡ºã®å ´åˆã®ä¿¡é ¼åº¦ã«ã‚ˆã‚‹è‰²åˆ†ã‘
          if (confidence >= 80) {
            badgeClass = 'high';
            badgeText = `ğŸ¤– AIæ¤œå‡º ${Math.round(confidence)}%`;
          } else if (confidence >= 50) {
            badgeClass = 'medium';
            badgeText = `ğŸ¤– AIæ¤œå‡º ${Math.round(confidence)}%`;
          } else {
            badgeClass = 'low';
            badgeText = `ğŸ¤– AIæ¤œå‡º ${Math.round(confidence)}%`;
          }
        }

        badge.className = `confidence-badge ${badgeClass}`;
        badge.textContent = badgeText;
        confidenceDiv.classList.remove('hidden');
      }

      // ä¿¡é ¼åº¦ãƒãƒƒã‚¸ã‚’éè¡¨ç¤º
      function hideConfidenceBadge(columnType) {
        const confidenceDiv = document.getElementById(`${columnType}-confidence`);
        if (confidenceDiv) {
          confidenceDiv.classList.add('hidden');
        }
      }

      // AIæ¤œå‡ºæƒ…å ±ã‚’è¡¨ç¤º
      function displayAIDetectionInfo(mapping) {
        const detailsDiv = document.getElementById('ai-detection-details');
        if (!detailsDiv) return;

        const details = [];
        const columnNames = {
          answerer: 'å›ç­”åˆ—',
          reason: 'ç†ç”±åˆ—',
          class: 'ã‚¯ãƒ©ã‚¹åˆ—',
          name: 'åå‰åˆ—',
        };

        Object.keys(columnNames).forEach((key) => {
          if (mapping[key] !== null && mapping[key] !== undefined) {
            const columnLabel = String.fromCharCode(65 + mapping[key]) + 'åˆ—';
            const confidence =
              mapping.confidence && mapping.confidence[key] ? mapping.confidence[key] : 0;
            details.push(
              `${columnNames[key]}: ${columnLabel} (ä¿¡é ¼åº¦: ${Math.round(confidence)}%)`
            );
          }
        });

        detailsDiv.innerHTML = details.map((detail) => `<div>â€¢ ${detail}</div>`).join('');
      }

      // é¸æŠçŠ¶æ³ã‚’æ›´æ–°
      function updateSelectionStatus() {
        const hasManualSelection =
          document.querySelectorAll('.modern-select.has-manual-selection').length > 0;
        const hasAISelection =
          document.querySelectorAll('.modern-select.has-ai-selection').length > 0;

        console.log('é¸æŠçŠ¶æ³:', { hasManualSelection, hasAISelection });

        // AIæ¤œå‡ºæƒ…å ±ã¨ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
        const resetButton = document.getElementById('reset-to-ai');
        if (resetButton) {
          resetButton.style.display = hasManualSelection ? 'inline-block' : 'none';
        }
      }

      // AIæ¤œå‡ºçµæœã«æˆ»ã™
      function resetToAIDetection() {
        console.log('AIæ¤œå‡ºçµæœã«ãƒªã‚»ãƒƒãƒˆ');

        if (!window.currentAIMapping) {
          showError('AIæ¤œå‡ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }

        // å…¨ã¦ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        const dropdowns = {
          answer: document.getElementById('answer-column-select'),
          reason: document.getElementById('reason-column-select'),
          class: document.getElementById('class-column-select'),
          name: document.getElementById('name-column-select'),
        };

        // AIæ¤œå‡ºçµæœã‚’å†è¨­å®š
        setAIDetectionSelections(window.currentAIMapping, dropdowns);

        // æ‰‹å‹•è¨­å®šæƒ…å ±ã‚’éè¡¨ç¤º
        const manualInfo = document.getElementById('manual-override-info');
        if (manualInfo) {
          manualInfo.classList.add('hidden');
        }

        // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        const resetButton = document.getElementById('reset-to-ai');
        if (resetButton) {
          resetButton.style.display = 'none';
        }

        showSuccess('âœ… AIæ¤œå‡ºçµæœã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
      }

      // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª
      function verifyColumnMapping() {
        const spreadsheetId = document.getElementById('spreadsheet-select').value;
        const sheetName = document.getElementById('sheet-select').value;

        if (!spreadsheetId || !sheetName) {
          showError('æ¤œè¨¼ã™ã‚‹ã«ã¯ã¾ãšã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨ã‚·ãƒ¼ãƒˆã‚’æ¥ç¶šã—ã¦ãã ã•ã„');
          return;
        }

        setLoading(true);

        console.log('verifyColumnMapping: åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°æ¤œè¨¼é–‹å§‹', { spreadsheetId, sheetName });

        // æ—¢å­˜ã®getHeaderIndicesé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦æ¤œè¨¼
        google.script.run
          .withSuccessHandler(function (headerIndices) {
            console.log('verifyColumnMapping: ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œè¨¼æˆåŠŸ', headerIndices);

            if (!headerIndices || Object.keys(headerIndices).length === 0) {
              showError('ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚·ãƒ¼ãƒˆã®æ§‹é€ ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
              setLoading(false);
              return;
            }

            // æ¤œè¨¼çµæœã‚’è¡¨ç¤º
            displayVerificationResults(headerIndices);

            // è¨­å®šã‚’ä¿å­˜
            saveColumnConfiguration(spreadsheetId, sheetName, headerIndices);

            showSuccess('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã®æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ');
            updateProgress(3);
            setLoading(false);
          })
          .withFailureHandler(function (error) {
            console.error('verifyColumnMapping ã‚¨ãƒ©ãƒ¼:', error);
            showError('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'Unknown error'));
            setLoading(false);
          })
          .getHeaderIndices(spreadsheetId, sheetName);
      }

      // æ¤œè¨¼çµæœã®è¡¨ç¤º
      function displayVerificationResults(headerIndices) {
        const columnsContainer = document.querySelector('.auto-detected-columns');
        if (!columnsContainer) return;

        // æ—¢å­˜ã®åˆ—è¡¨ç¤ºã«æ¤œè¨¼æ¸ˆã¿ãƒãƒ¼ã‚¯ã‚’è¿½åŠ 
        const columnMatches = columnsContainer.querySelectorAll('.column-match');
        columnMatches.forEach((match) => {
          const verifiedBadge = document.createElement('span');
          verifiedBadge.className = 'status-badge published';
          verifiedBadge.textContent = 'âœ“ æ¤œè¨¼æ¸ˆã¿';
          verifiedBadge.style.fontSize = '0.75rem';
          verifiedBadge.style.marginLeft = '0.5rem';
          match.appendChild(verifiedBadge);
        });

        console.log('æ¤œè¨¼çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸ:', headerIndices);
      }

      // åˆ—è¨­å®šã®ä¿å­˜
      function saveColumnConfiguration(spreadsheetId, sheetName, headerIndices) {
        const config = {
          spreadsheetId: spreadsheetId,
          sheetName: sheetName,
          headerIndices: headerIndices,
          verifiedAt: new Date().toISOString(),
        };

        google.script.run
          .withSuccessHandler(function (result) {
            if (result.success) {
              console.log('åˆ—è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ:', config);
            } else {
              console.warn('åˆ—è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', result.error);
            }
          })
          .withFailureHandler(function (error) {
            console.error('åˆ—è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          })
          .saveDraftConfiguration(config);
      }

      // ä¸‹æ›¸ãä¿å­˜
      function saveDraft() {
        const config = gatherConfiguration();

        setLoading(true);
        google.script.run
          .withSuccessHandler(function (result) {
            if (result.success) {
              showSuccess('ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ');
              updateResourceButtons(result.config);
            } else {
              showError(result.error);
            }
            setLoading(false);
          })
          .withFailureHandler(function (error) {
            console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            showError('ä¸‹æ›¸ãã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            setLoading(false);
          })
          .saveDraftConfiguration(config);
      }

      // ã‚¢ãƒ—ãƒªå…¬é–‹
      function publishApp() {
        const appName = document.getElementById('app-name').value;
        if (!appName.trim()) {
          showError(
            'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹ï¼šã€Œã‚¯ãƒ©ã‚¹è³ªå•ãƒœãƒ¼ãƒ‰ã€ã€Œç†ç§‘å®Ÿé¨“ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã€'
          );
          document.getElementById('app-name').focus();
          return;
        }

        // é•·ã™ãã‚‹åå‰ã‚’ãƒã‚§ãƒƒã‚¯
        if (appName.trim().length > 50) {
          showError('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          document.getElementById('app-name').focus();
          return;
        }

        const config = gatherConfiguration();
        config.appName = appName;

        setLoading(true);
        google.script.run
          .withSuccessHandler(function (result) {
            if (result.success) {
              showSuccess('ã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã—ã¾ã—ãŸï¼');
              updatePublishStatus('published');
              updateResourceButtons(result.config);
            } else {
              showError(result.error);
            }
            setLoading(false);
          })
          .withFailureHandler(function (error) {
            console.error('å…¬é–‹ã‚¨ãƒ©ãƒ¼:', error);
            showError(
              'ã‚¢ãƒ—ãƒªã®å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
            );
            setLoading(false);
          })
          .publishApplication(config);
      }

      // è¨­å®šåé›†ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¼å¯¾å¿œï¼‰
      function gatherConfiguration() {
        const sourceMethod = document.querySelector('input[name="source-method"]:checked').value;

        let spreadsheetId, sheetName;

        if (sourceMethod === 'url') {
          // URLå…¥åŠ›æ–¹å¼
          const urlInput = document.getElementById('spreadsheet-url');
          const url = urlInput.value.trim();
          const spreadsheetRegex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
          const match = url.match(spreadsheetRegex);

          if (match) {
            spreadsheetId = match[1];
          }
          sheetName = document.getElementById('sheet-name-input').value.trim();
        } else {
          // ä¸€è¦§é¸æŠæ–¹å¼
          spreadsheetId = document.getElementById('spreadsheet-select').value;
          sheetName = document.getElementById('sheet-select').value;
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰åˆ—é¸æŠã‚’åé›†
        const columnSelections = gatherColumnSelections();

        return {
          spreadsheetId: spreadsheetId,
          sheetName: sheetName,
          sourceMethod: sourceMethod,
          columnSelections: columnSelections, // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠçµæœ
          showNames: document.getElementById('show-names').checked,
          showReactions: document.getElementById('show-reactions').checked,
          timestamp: new Date().toISOString(),
        };
      }

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰åˆ—é¸æŠæƒ…å ±ã‚’åé›†
      function gatherColumnSelections() {
        const dropdowns = {
          answer: document.getElementById('answer-column-select'),
          reason: document.getElementById('reason-column-select'),
          class: document.getElementById('class-column-select'),
          name: document.getElementById('name-column-select'),
        };

        const selections = {};
        let hasAnySelection = false;

        Object.keys(dropdowns).forEach((columnType) => {
          const dropdown = dropdowns[columnType];
          if (!dropdown) return;

          const selectedValue = dropdown.value;
          const isAI = dropdown.classList.contains('has-ai-selection');
          const isManual = dropdown.classList.contains('has-manual-selection');

          if (selectedValue !== '') {
            selections[columnType] = {
              columnIndex: parseInt(selectedValue),
              columnLabel: String.fromCharCode(65 + parseInt(selectedValue)) + 'åˆ—',
              selectionType: isManual ? 'manual' : 'ai',
              confidence: getColumnConfidence(columnType),
            };
            hasAnySelection = true;
          }
        });

        // AIæ¤œå‡ºã®å…ƒãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚ã‚‹
        if (window.currentAIMapping) {
          selections._aiMapping = window.currentAIMapping;
        }

        selections._hasSelections = hasAnySelection;

        console.log('gatherColumnSelections:', selections);
        return selections;
      }

      // åˆ—ã®ä¿¡é ¼åº¦ã‚’å–å¾—
      function getColumnConfidence(columnType) {
        const confidenceDiv = document.getElementById(`${columnType}-confidence`);
        if (!confidenceDiv || confidenceDiv.classList.contains('hidden')) {
          return 0;
        }

        const badge = confidenceDiv.querySelector('.confidence-badge');
        if (!badge) return 0;

        const text = badge.textContent;
        const match = text.match(/(\d+)%/);
        return match ? parseInt(match[1]) : badge.classList.contains('manual') ? 100 : 0;
      }

      // æ—§updateConfigDisplayé–¢æ•°ã¯å‰Šé™¤æ¸ˆã¿ - updateResourceButtons()ã‚’ä½¿ç”¨

      // å…¬é–‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      function updatePublishStatus(status) {
        const badge =
          document.querySelector('.status-badge.unpublished') ||
          document.querySelector('.status-badge.published');
        if (badge) {
          badge.className = `status-badge ${status}`;
          badge.textContent = status === 'published' ? 'å…¬é–‹ä¸­' : 'æœªå…¬é–‹';
        }
      }

      // =============================================================================
      // ãƒ•ãƒƒã‚¿ãƒ¼ï¼šç¾åœ¨ã®ãƒœãƒ¼ãƒ‰æƒ…å ±è¡¨ç¤ºæ©Ÿèƒ½
      // =============================================================================

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      let currentBoardInfo = null;

      // ãƒœãƒ¼ãƒ‰æƒ…å ±ãƒ­ãƒ¼ãƒ‰
      function loadBoardInfo() {
        google.script.run
          .withSuccessHandler(function (boardInfo) {
            currentBoardInfo = boardInfo;
            updateFooterDisplay(boardInfo);
          })
          .withFailureHandler(function (error) {
            console.error('ãƒœãƒ¼ãƒ‰æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            updateFooterDisplay({
              isActive: false,
              questionText: 'æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼',
              error: error.message,
            });
          })
          .getCurrentBoardInfoAndUrls();
      }

      // ãƒ•ãƒƒã‚¿ãƒ¼è¡¨ç¤ºæ›´æ–°
      function updateFooterDisplay(boardInfo) {
        const footer = document.getElementById('boardInfoFooter');
        const questionText = document.getElementById('currentQuestionText');
        const openBtn = document.getElementById('openBoardBtn');
        const copyBtn = document.getElementById('copyViewUrlBtn');
        const statusText = document.getElementById('boardStatus');

        // ãƒ•ãƒƒã‚¿ãƒ¼ã‚’è¡¨ç¤º
        footer.style.display = 'block';

        // å•é¡Œæ–‡è¨­å®š
        questionText.textContent = boardInfo.questionText || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

        if (boardInfo.status === 'active' && boardInfo.urls) {
          // ãƒœã‚¿ãƒ³è¡¨ç¤ºãƒ»æ©Ÿèƒ½è¨­å®š
          openBtn.style.display = 'block';
          copyBtn.style.display = 'block';

          openBtn.onclick = () => window.open(boardInfo.urls.view, '_blank');
          copyBtn.onclick = () => copyViewUrl(boardInfo.urls.view);

          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
          statusText.textContent = `æœ€çµ‚æ›´æ–°: ${boardInfo.lastUpdated || 'ä¸æ˜'}`;
        } else {
          // éã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
          openBtn.style.display = 'none';
          copyBtn.style.display = 'none';
          statusText.textContent = boardInfo.error || 'ãƒœãƒ¼ãƒ‰ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã™';
        }
      }

      // URLã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ï¼ˆå®Ÿç”¨é‡è¦–ï¼‰
      function copyViewUrl(url) {
        if (!url) {
          showError('ã‚³ãƒ”ãƒ¼ã™ã‚‹URLãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(url)
            .then(() => {
              showSuccess('é–²è¦§ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
              // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«å¤‰æ›´ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
              const btn = document.getElementById('copyViewUrlBtn');
              const originalText = btn.textContent;
              btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
              btn.disabled = true;
              setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
              }, 2000);
            })
            .catch(() => {
              fallbackCopyUrl(url);
            });
        } else {
          fallbackCopyUrl(url);
        }
      }

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼‰
      function fallbackCopyUrl(url) {
        const textarea = document.createElement('textarea');
        textarea.value = url;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          showSuccess('é–²è¦§ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        } catch (err) {
          // æœ€çµ‚æ‰‹æ®µï¼šURLã‚’è¡¨ç¤ºã—ã¦æ‰‹å‹•ã‚³ãƒ”ãƒ¼ã‚’ä¿ƒã™
          prompt('ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', url);
        }
        document.body.removeChild(textarea);
      }

      console.log('AdminPanel ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
    </script>
  </body>
</html>
