<!DOCTYPE html>
<!-- Layout Update v1.2 - 2025-07-19 - Fixed Header Overlap + Domain Display + Clean CSS -->
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <title>みんなの回答ボード	管理パネル - StudyQuest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#1a1b26" />
  <meta name="description" content="StudyQuestの回答ボード管理パネル - 直感的で使いやすい教育ツール" />
  <!-- Shared Security Headers -->
  <?!= include('SharedSecurityHeaders'); ?>
  
  <!-- User ID will be retrieved dynamically from backend -->


  <!-- Shared TailwindCSS Configuration -->
  <?!= include('SharedTailwindConfig'); ?>

  <!-- Unified Styles and Shared Components -->
  <?!= include('UnifiedStyles'); ?>
  <?!= include('SharedUtilities'); ?>
  
  <!-- Admin Panel Specific Styles -->
  <?!= include('adminPanel-layout.css'); ?>
  
  <!-- Core JavaScript Libraries (must be loaded first) -->
  <?!= include('ClientOptimizer'); ?>
  <?!= include('UnifiedCache.js'); ?>
  
  <script>
  // GASOptimizer and UnifiedCache are now guaranteed to be defined
  // Enhanced Global Error Handling with Smart Recovery
  window.addEventListener('error', function(event) {
    const errorMessage = event.error?.message || '';
    const errorStack = event.error?.stack || '';
    const errorLine = event.lineno || 'unknown';
    
    // Non-critical GAS internal errors (suppress with logging)
    const suppressedErrors = [
      'document.write',
      'Unexpected token',
      'Failed to execute \'write\' on \'Document\'',
      'SyntaxError: Failed to execute \'write\'',
      'Identifier \'userId\' has already been declared',
      'mae_html_user_bin_i18n_mae_html_user',
      'warden_bin_i18n_warden',
      'unrecognized feature',
      'Unrecognized feature',
      'ambient-light-sensor',
      'speaker',
      'vibrate',
      'vr',
      'cdn.tailwindcss.com should not be used in production',
      'tailwindcss.com/docs/installation',
      'should not be used in production',
      'PostCSS plugin',
      'Tailwind CLI'
    ];
    
    // Critical errors that need intervention
    const criticalErrors = [
      'await is only valid in async functions',
      'Cannot set property',
      'Cannot read property',
      'is not defined',
      'is not a function'
    ];
    
    const shouldSuppress = suppressedErrors.some(pattern => 
      errorMessage.includes(pattern) || errorStack.includes(pattern)
    );
    
    const isCritical = criticalErrors.some(pattern => 
      errorMessage.includes(pattern) || errorStack.includes(pattern)
    );
    
    if (shouldSuppress) {
      // Log suppressed error for debugging (optional)
      console.debug('Suppressed Google Apps Script internal error:', errorMessage);
      event.preventDefault();
      return;
    }
    
    if (isCritical) {
      console.error('🚨 Critical Error Detected:', {
        message: errorMessage,
        line: errorLine,
        stack: errorStack.substring(0, 500) // Truncate for readability
      });
      
      // Attempt recovery for specific critical errors
      if (errorMessage.includes('is not defined') || errorMessage.includes('is not a function')) {
        console.log('🔧 Attempting function recovery...');
        // Trigger fallback initialization after a short delay
        setTimeout(() => {
          if (typeof window.initializeAdminPanelMaster === 'function') {
            console.log('🔄 Re-initializing admin panel...');
            window.initializeAdminPanelMaster();
          }
        }, 1000);
      }
      
      // Show user-friendly error message for critical issues
      setTimeout(() => {
        if (window.showMessage && typeof window.showMessage === 'function') {
          window.showMessage('システムの初期化で問題が発生しました。ページを再読み込みしてください。', 'warning');
        }
      }, 2000);
    }
    
    // Log important errors
    console.error('Global error caught:', event.error);
  });
  
  // Enhanced Promise rejection handling
  window.addEventListener('unhandledrejection', function(event) {
    const reason = event.reason?.toString() || '';
    
    // Suppress Google Apps Script internal promise rejections
    if (reason.includes('document.write') || 
        reason.includes('mae_html_user') ||
        reason.includes('warden_bin')) {
      console.debug('Suppressed internal promise rejection:', reason);
      event.preventDefault();
      return;
    }
    
    console.error('Unhandled promise rejection:', event.reason);
    event.preventDefault();
  });

  // GASOptimizer インスタンスの初期化
  var gasOptimizer = new GASOptimizer();
  
  // UnifiedCache インスタンスの初期化
  var unifiedCache = (typeof UnifiedCache !== 'undefined')
    ? new UnifiedCache()
    : { getOrSet: function(_, fn) { return fn(); } };
  
  // runGas ラッパー関数 - キャッシュ対応
  function runGas(functionName, ...args) {
    return gasOptimizer.call(functionName, ...args);
  }
  
  // runGasWithUserId function is defined in adminPanel-api.js.html to avoid duplication
  
  // callWithCache 関数 - 読み取り専用操作用
  function callWithCache(functionName, cacheKey, ttl, ...args) {
    return unifiedCache.getOrSet(cacheKey, function() {
      return gasOptimizer.call(functionName, ...args);
    }, ttl);
  }
  
  // マルチテナント対応: callWithCacheWithUserId関数
  function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
    if (!userId) {
      console.error('❌  - No userId available for cached call:', functionName);
      throw new Error('ユーザーIDが設定されていません。ページを再読み込みしてください。');
    }
    
    return unifiedCache.getOrSet(cacheKey, function() {
      console.log('✅  - callWithCacheWithUserId:', functionName, 'userId:', userId);
      return gasOptimizer.call(functionName, userId, ...args);
    }, ttl);
  }
  </script>
  <script>
  const __IS_SYSTEM_ADMIN_RAW__ = '<?= escapeJavaScript(typeof isDeployUser !== "undefined" ? isDeployUser : "false") ?>';
  const __IS_SYSTEM_ADMIN__ = __IS_SYSTEM_ADMIN_RAW__ === 'true' || __IS_SYSTEM_ADMIN_RAW__ === true;
  window.isSystemAdmin = __IS_SYSTEM_ADMIN__;
  console.log('Template Debug:');
  console.log('- Raw template value:', __IS_SYSTEM_ADMIN_RAW__);
  console.log('- Raw template type:', typeof __IS_SYSTEM_ADMIN_RAW__);
  console.log('- Processed value:', __IS_SYSTEM_ADMIN__);
  console.log('- window.isSystemAdmin final:', window.isSystemAdmin);
  
  </script>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans">
  <!-- Unified Loading Overlay - Content managed by UnifiedLoadingManager -->
  <div id="loading-overlay" class="loading-overlay page-specific hidden"></div>
  <header id="admin-header" class="glass-panel border-b border-gray-700 fixed top-1 sm:top-2 left-2 right-2 sm:left-4 sm:right-4 z-50 rounded-lg sm:rounded-xl shadow-lg">
  <div class="relative -top-1 sm:-top-2 max-w-6xl mx-auto px-4 sm:px-6 py-4 sm:py-5 flex items-center justify-between gap-4">
        <!-- ロゴとタイトル -->
        <div class="flex items-center gap-3 flex-shrink-0">
          <div class="w-8 h-8 bg-gradient-to-r from-cyan-400 to-purple-400 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <div class="min-w-0">
            <div class="hidden sm:block">
              <h1 class="text-lg sm:text-xl font-bold text-white leading-tight truncate">みんなの回答ボード	管理パネル</h1>
              <p class="text-xs text-gray-400">StudyQuest</p>
            </div>
            <div class="sm:hidden">
              <h1 class="text-base font-bold text-white truncate">みんなの回答ボード</h1>
            </div>
          </div>
        </div>
        
        <!-- ドメイン・ステータス情報 -->
        <div class="flex items-center gap-2 flex-shrink-0">
          <!-- ドメイン情報（Login.htmlスタイル） -->
          <div id="header-domain-info">
            <!-- ドメイン一致表示（緑色パネル） -->
            <!-- ドメイン一致表示（Login.htmlスタイル） -->
            <div id="header-domain-match" class="glass-panel bg-gradient-to-r from-green-500/10 to-emerald-500/10 rounded-lg p-3 border border-green-400/30 hidden">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-green-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <div class="text-green-400 font-semibold text-sm" id="header-domain-match-text">G Suite ドメイン</div>
                  <div class="text-green-200 text-xs">セキュアアクセス有効</div>
                </div>
              </div>
            </div>
            
            <!-- ドメイン不一致表示（Login.htmlスタイル） -->
            <div id="header-domain-mismatch" class="glass-panel bg-gradient-to-r from-yellow-500/10 to-orange-500/10 rounded-lg p-3 border border-yellow-400/30 hidden">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <div>
                  <div class="text-yellow-400 font-semibold text-sm" id="header-domain-mismatch-text">ドメイン不一致</div>
                  <div class="text-yellow-200 text-xs">アクセス制限あり</div>
                </div>
              </div>
            </div>
            
            <!-- 初期状態表示 -->
            <div id="header-domain-initial" class="glass-panel bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-lg p-3 border border-blue-400/30">
              <div class="flex items-center gap-2">
                <div id="header-status-dot" class="w-3 h-3 bg-blue-400 rounded-full animate-pulse flex-shrink-0"></div>
                <div>
                  <div class="text-blue-400 font-semibold text-sm" id="header-domain-name-initial">ドメイン確認中</div>
                  <div class="text-blue-200 text-xs" id="header-status-text-initial">セットアップ中</div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
  </header>
  <main id="admin-main" class="flex-1 max-w-6xl mx-auto px-4 sm:px-6
              pt-16 sm:pt-20
              pb-16 sm:pb-20
              h-screen overflow-y-auto">
    <!-- メインコンテンツ：ステータスバー＋左右パネル -->
    <div class="responsive-grid grid grid-cols-1 lg:grid-cols-3 gap-4">

    <!-- シンプル統合ステータスバー -->
    <section class="col-span-1 lg:col-span-3">
      <div class="glass-panel p-4 rounded-lg">
        <div class="flex items-center justify-between">
          <!-- 左側: ステータス表示 -->
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
              <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <div>
              <span class="text-sm font-medium text-white" id="guidance-text">セットアップを開始してください</span>
              <div class="text-xs text-gray-400 mt-1" id="progress-message">3ステップで簡単セットアップ</div>
            </div>
          </div>
          
          <!-- 右側: ステップナビゲーター表示 -->
          <div class="flex items-center gap-2">
            <div class="flex items-center gap-1.5" id="step-1-indicator">
              <div class="w-7 h-7 bg-gray-600 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all duration-300">1</div>
              <span class="text-xs text-gray-400 hidden sm:inline font-medium">データ準備</span>
            </div>
            <div class="w-4 h-px bg-gradient-to-r from-gray-600 to-gray-500 rounded-full"></div>
            <div class="flex items-center gap-1.5" id="step-2-indicator">
              <div class="w-7 h-7 bg-gray-600 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all duration-300">2</div>
              <span class="text-xs text-gray-400 hidden sm:inline font-medium">シート設定</span>
            </div>
            <div class="w-4 h-px bg-gradient-to-r from-gray-600 to-gray-500 rounded-full"></div>
            <div class="flex items-center gap-1.5" id="step-3-indicator">
              <div class="w-7 h-7 bg-gray-600 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all duration-300">3</div>
              <span class="text-xs text-gray-400 hidden sm:inline font-medium">表示設定</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 左右パネル -->
      <div class="left-panel col-span-2 space-y-2">
        
        <!-- 自動停止通知バナー -->
        <div id="auto-stop-notification" class="hidden glass-panel p-4 border-l-4 border-yellow-500 bg-yellow-900/20">
          <div class="flex items-start gap-3">
            <svg class="w-6 h-6 text-yellow-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <div class="flex-1">
              <h3 class="text-yellow-300 font-semibold mb-1">自動停止されました</h3>
              <p class="text-gray-300 text-sm mb-2">
                回答ボードは予定時刻に自動的に非公開になりました。
              </p>
              <div class="text-xs text-gray-400 mb-3" id="auto-stop-details">
                停止時刻: <span id="auto-stopped-time"></span>
              </div>
              <button type="button" id="republish-after-auto-stop-btn" 
                      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                再公開する
              </button>
            </div>
            <button type="button" onclick="document.getElementById('auto-stop-notification').classList.add('hidden')" 
                    class="text-gray-400 hover:text-white transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- ステップ1: データソース設定 -->
        <div class="glass-panel p-4 lg:p-6" id="data-setup-section">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl flex items-center justify-center font-bold text-sm shadow-lg ring-2 ring-blue-400/20">
                1
              </div>
              <div>
                <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                  データ準備
                  <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                </h2>
                <p class="text-xs text-gray-400">フォームやスプレッドシートを設定</p>
              </div>
            </div>
            <button type="button" class="toggle-section" onclick="safeCall('toggleSection', 'step1-content')" aria-expanded="true" aria-label="セクションを展開/折りたたみ">
              <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>
          
          <div id="step1-content" class="progressive-section expanded">
            <!-- 統合されたデータ準備セクション -->
            <div class="google-integration p-4 rounded-xl text-white mb-4">
              <div class="flex items-center gap-3 mb-3">
                <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <div>
                  <h3 class="font-semibold">データ準備</h3>
                  <p class="text-xs opacity-90">フォームとスプレッドシートを作成</p>
                </div>
              </div>
              <p class="text-sm mb-4 opacity-90">
                Google Workspaceと連携して、学習者の意見を収集するフォームとデータ管理用のスプレッドシートを作成します。
              </p>
              
              <!-- 水平配置のボタン -->
              <div class="flex gap-3">
                <button type="button" id="quickstart-btn" class="btn btn-google flex-1">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                  <span id="quickstart-text">クイックスタート</span>
                </button>
                <button type="button" id="create-board-btn" class="btn btn-google flex-1">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  <span id="create-board-text">カスタムセットアップ</span>
                </button>
              </div>
              
              <!-- フォーム作成完了表示（統合移動） -->
              <div class="mt-4 hidden" id="form-url-section">
                <div class="bg-gradient-to-r from-green-600/20 to-emerald-600/20 border border-green-500/30 rounded-xl p-4">
                  <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center">
                      <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                    </div>
                    <div>
                      <h4 class="text-base font-semibold text-green-300">フォームが作成されました</h4>
                      <p class="text-xs text-gray-400">次にシート設定を行ってください</p>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <input type="url" id="form-url-input" class="form-control flex-1 text-sm" readonly placeholder="フォームURLが生成されます">
                    <button type="button" id="copy-form-url-btn" class="btn btn-secondary px-3" title="URLをコピー">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                      </svg>
                    </button>
                    <a id="open-form-url-link" href="#" target="_blank" class="btn btn-secondary px-3" title="フォームを開く">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                      </svg>
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- QuickStart Progress (最適化された進行表示) -->
            <div id="quickstart-progress" class="hidden bg-gradient-to-br from-emerald-900/20 to-blue-900/20 border border-emerald-400/30 rounded-xl p-5 mb-4 backdrop-blur-sm">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-blue-500 rounded-full flex items-center justify-center">
                  <svg class="w-4 h-4 text-white animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                </div>
                <div>
                  <h4 class="text-base font-semibold text-emerald-300">自動セットアップ進行中</h4>
                  <p class="text-xs text-gray-400">数分でボードの準備が完了します</p>
                </div>
              </div>
              
              <!-- Enhanced Progress Steps -->
              <div class="space-y-3 mb-5">
                <div class="flex items-center gap-4" id="progress-step-1">
                  <div class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-600 flex items-center justify-center transition-all duration-300">
                    <div class="w-3 h-3 rounded-full bg-gray-500 transition-all duration-300" id="progress-step-1-dot"></div>
                  </div>
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-300" id="progress-step-1-text">環境準備</div>
                    <div class="text-xs text-gray-500 mt-1" id="progress-step-1-detail">ユーザー専用フォルダの作成中...</div>
                  </div>
                  <div class="text-xs text-gray-400 opacity-0 transition-opacity duration-300" id="progress-step-1-time">30秒</div>
                </div>
                
                <div class="flex items-center gap-4" id="progress-step-2">
                  <div class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-600 flex items-center justify-center transition-all duration-300">
                    <div class="w-3 h-3 rounded-full bg-gray-500 transition-all duration-300" id="progress-step-2-dot"></div>
                  </div>
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-300" id="progress-step-2-text">フォーム作成</div>
                    <div class="text-xs text-gray-500 mt-1" id="progress-step-2-detail">フォームとスプレッドシートを自動作成中...</div>
                  </div>
                  <div class="text-xs text-gray-400 opacity-0 transition-opacity duration-300" id="progress-step-2-time">1分</div>
                </div>
                
                <div class="flex items-center gap-4" id="progress-step-3">
                  <div class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-600 flex items-center justify-center transition-all duration-300">
                    <div class="w-3 h-3 rounded-full bg-gray-500 transition-all duration-300" id="progress-step-3-dot"></div>
                  </div>
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-300" id="progress-step-3-text">ボード設定</div>
                    <div class="text-xs text-gray-500 mt-1" id="progress-step-3-detail">回答ボードの設定と最適化中...</div>
                  </div>
                  <div class="text-xs text-gray-400 opacity-0 transition-opacity duration-300" id="progress-step-3-time">45秒</div>
                </div>
                
                <div class="flex items-center gap-4" id="progress-step-4">
                  <div class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-600 flex items-center justify-center transition-all duration-300">
                    <div class="w-3 h-3 rounded-full bg-gray-500 transition-all duration-300" id="progress-step-4-dot"></div>
                  </div>
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-300" id="progress-step-4-text">完了準備</div>
                    <div class="text-xs text-gray-500 mt-1" id="progress-step-4-detail">最終確認と利用準備を実行中...</div>
                  </div>
                  <div class="text-xs text-gray-400 opacity-0 transition-opacity duration-300" id="progress-step-4-time">15秒</div>
                </div>
              </div>
              
              <!-- Enhanced Progress Bar -->
              <div class="bg-gray-800/50 rounded-full p-1 mb-4">
                <div class="flex items-center justify-between mb-2 px-2">
                  <span class="text-xs font-medium text-gray-300">全体の進捗</span>
                  <span class="text-sm font-bold text-emerald-400" id="progress-percentage">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                  <div class="bg-gradient-to-r from-emerald-500 via-blue-500 to-purple-500 h-3 rounded-full transition-all duration-700 ease-out shadow-lg" style="width: 0%" id="progress-bar"></div>
                </div>
              </div>
              
              <div class="text-center bg-gray-800/30 rounded-lg p-3">
                <p class="text-sm font-medium text-emerald-300" id="progress-status">初期化中...</p>
                <p class="text-xs text-gray-400 mt-1">しばらくお待ちください</p>
              </div>
            </div>

            <!-- 既存ユーザー向けの追加オプション -->
            <div id="existing-user-section" class="hidden bg-gray-800/30 border border-gray-600/30 rounded-xl p-4 mb-4">
              <h4 class="text-sm font-semibold text-gray-300 mb-3">追加オプション</h4>
              <button type="button" id="create-additional-form-btn" class="btn btn-secondary w-full text-sm">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span id="create-additional-form-text" class="text-gray-200">新規のフォームを作成</span>
              </button>
              <p class="text-xs text-gray-400 mt-2">現在のボードに連携する新しいフォームを作成</p>
            </div>
            
            <!-- 外部リソースの連携 (上級者向け) -->
            <details class="bg-gray-800/30 border border-gray-600/30 rounded-xl">
              <summary class="p-4 cursor-pointer text-sm font-medium text-gray-300 hover:text-white flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                </svg>
                外部リソースの連携 (上級者向け)
              </summary>
              <div class="p-4 pt-0 space-y-4">
                <div class="bg-cyan-900/20 border border-cyan-500/30 rounded-lg p-4">
                  <label class="block text-sm font-medium text-cyan-200 mb-2">
                    GoogleスプレッドシートのURL
                  </label>
                  <div class="space-y-3">
                    <input type="url" 
                           id="resource-url-input" 
                           placeholder="https://docs.google.com/spreadsheets/d/..."
                           class="form-control"
                           aria-describedby="resource-url-help">
                    <p id="resource-url-help" class="text-xs text-cyan-300 mt-1">
                      既存のGoogleスプレッドシートのURLを貼り付けてください
                    </p>
                    <button type="button" id="add-resource-btn" class="btn btn-primary w-full">
                      <span id="add-resource-text">リソースを追加</span>
                    </button>
                  </div>
                </div>
              </div>
            </details>
            
            <!-- カスタムフォーム情報表示エリア -->
            <div id="custom-form-info-section" class="hidden mt-4">
              <!-- updateCustomFormInfo()で動的に内容が設定される -->
            </div>
          </div>
        </div>


        <!-- ステップ2: データシート設定 -->
        <div class="glass-panel p-4 lg:p-6" id="sheet-selection-section">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl flex items-center justify-center font-bold text-sm shadow-lg ring-2 ring-green-400/20">
                2
              </div>
              <div>
                <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                  シート設定
                  <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                </h2>
                <p class="text-xs text-gray-400">質問内容と表示設定を管理</p>
              </div>
            </div>
            <button type="button" class="toggle-section" onclick="safeCall('toggleSection', 'step2-content')" aria-expanded="true" aria-label="セクションを展開/折りたたみ">
              <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>
          
          <div id="step2-content" class="progressive-section expanded">
            <div class="space-y-4">
              <!-- データシート選択の説明 -->
              <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                <div class="flex items-center gap-2 mb-2">
                  <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                  </svg>
                  <span class="text-sm font-medium text-green-200">データシート選択</span>
                </div>
                <p class="text-xs text-green-300">作成したデータシートから質問文と回答タイプを設定します</p>
              </div>
              
              <!-- 履歴テーブル -->
              <div class="bg-gray-800/30 border border-gray-600/30 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h4 class="text-sm font-medium text-blue-200">過去の設定から選択</h4>
                  </div>
                  <button type="button" id="clear-history-btn" class="text-xs text-red-400 hover:text-red-300 hover:underline">
                    履歴をクリア
                  </button>
                </div>
                <div class="overflow-x-auto">
                  <table class="w-full text-sm table-fixed">
                    <thead class="bg-gray-800">
                      <tr>
                        <th class="px-3 py-2 text-left text-xs text-gray-300 w-32">公開日時</th>
                        <th class="px-3 py-2 text-left text-xs text-gray-300">問題文</th>
                        <th class="px-3 py-2 text-left text-xs text-gray-300 w-24">回答形式</th>
                        <th class="px-3 py-2 text-left text-xs text-gray-300 w-16">回答数</th>
                      </tr>
                    </thead>
                    <tbody id="history-table-body">
                      <tr>
                        <td colspan="4" class="px-3 py-4 text-center text-gray-400 text-sm">
                          履歴がありません
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Enhanced Sheet Selection Control -->
              <div class="space-y-4">
                <label for="sheet-select" class="block text-sm font-medium text-white">
                  <span class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    データシート
                    <span class="text-xs text-green-400 bg-green-400/10 px-2 py-1 rounded-full">選択すると即座にアクティブ化</span>
                  </span>
                </label>
                <div class="flex gap-2">
                  <div class="flex-1 relative">
                    <select id="sheet-select" class="form-control w-full" aria-describedby="sheet-help">
                      <option>読み込み中...</option>
                    </select>
                    <!-- Loading indicator for sheet selection -->
                    <div id="sheet-loading" class="hidden absolute right-10 top-1/2 transform -translate-y-1/2">
                      <svg class="w-4 h-4 text-green-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                      </svg>
                    </div>
                  </div>
                  <button type="button" id="open-spreadsheet-btn-step2" class="btn btn-secondary px-3 flex-shrink-0" title="スプレッドシートを開く">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                  </button>
                </div>
                
                <!-- Enhanced Help and Status -->
                <div class="space-y-2">
                  <p id="sheet-help" class="text-xs text-gray-400">
                    フォームの回答や表示したいデータが含まれるシートを選択してください
                  </p>
                  
                  <!-- Active Sheet Status -->
                  <div id="active-sheet-status" class="hidden bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                    <div class="flex items-center gap-2">
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                      <span class="text-sm text-green-300 font-medium">アクティブシート:</span>
                      <span id="active-sheet-name" class="text-sm text-white font-medium"></span>
                    </div>
                    <div class="mt-2 text-xs text-green-200">
                      <span id="active-sheet-info">列設定が自動更新されます</span>
                    </div>
                  </div>
                  
                  <!-- Selection Confirmation -->
                  <div id="sheet-selection-feedback" class="hidden">
                    <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3">
                      <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-sm text-blue-300 font-medium">シート変更完了</span>
                      </div>
                      <p class="text-xs text-blue-200 mt-1">列選択が更新されました。Step 3で詳細設定を行ってください。</p>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- ステップ3: 表示設定・公開 -->
        <div class="glass-panel p-4 lg:p-6" id="config-section">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl flex items-center justify-center font-bold text-sm shadow-lg ring-2 ring-purple-400/20">
                3
              </div>
              <div>
                <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                  表示設定・公開
                  <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
                </h2>
                <p class="text-xs text-gray-400">列設定と表示オプションを設定</p>
              </div>
            </div>
            <button type="button" class="toggle-section" onclick="safeCall('toggleSection', 'step3-content')" aria-expanded="true" aria-label="セクションを展開/折りたたみ">
              <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>
          
          <div id="step3-content" class="progressive-section expanded">
            <div id="config-area" class="space-y-4 hidden">
              <div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  <span class="text-sm font-medium text-purple-200">列マッピング設定</span>
                </div>
                <p class="text-xs text-purple-300">スプレッドシートの列を回答ボードの項目に割り当てます</p>
              </div>
              
              <!-- 必須設定 -->
              <div class="space-y-4">
                <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4">
                  <label class="block">
                    <div class="flex items-center gap-2 mb-2">
                      <span class="text-sm font-medium text-white">回答データ列</span>
                      <span class="px-2 py-1 bg-red-500 text-white text-xs rounded-full">必須</span>
                    </div>
                    <div class="flex gap-2">
                      <select id="opinionHeader" class="form-control flex-1" aria-describedby="main-help"></select>
                      <button type="button" id="reguess-headers-btn" class="btn bg-gradient-to-r from-purple-600/80 to-purple-700/80 hover:from-purple-600 hover:to-purple-700 text-white px-3 py-2 relative overflow-hidden group" title="AI搭載 高精度列判定システム">
                        <span class="relative z-10 flex items-center gap-1">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                          </svg>
                          <span class="text-xs font-bold">AI判定</span>
                        </span>
                        <div class="absolute inset-0 bg-gradient-to-r from-purple-400/20 to-purple-500/20 transform translate-x-full group-hover:translate-x-0 transition-transform duration-300"></div>
                      </button>
                    </div>
                    <p id="main-help" class="text-xs text-red-300 mt-1">
                      回答内容が含まれる列を選択してください
                    </p>
                  </label>
                </div>
                
                <!-- オプション設定 -->
                <details class="bg-gray-800/30 border border-gray-600/30 rounded-xl">
                  <summary class="p-4 cursor-pointer text-sm font-medium text-gray-300 hover:text-white flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                    </svg>
                    オプション設定（任意）
                  </summary>
                  <div class="p-4 pt-0 space-y-4" id="detail-options">
                    <label class="block">
                      <span class="text-sm text-gray-300 mb-2 block">理由列</span>
                      <select id="reason-column" class="form-control"></select>
                    </label>
                    <label class="block">
                      <span class="text-sm text-gray-300 mb-2 block">名前列</span>
                      <select id="name-column" class="form-control"></select>
                    </label>
                    <label class="block">
                      <span class="text-sm text-gray-300 mb-2 block">クラス列</span>
                      <select id="class-column" class="form-control"></select>
                    </label>
                    
                    <div class="flex items-center mt-4">
                      <input type="checkbox" id="show-names" name="show-names" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                      <label for="show-names" class="ml-2 block text-sm text-gray-300">名前を表示する</label>
                    </div>
                    <div class="flex items-center mt-2">
                      <input type="checkbox" id="show-counts" name="show-counts" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                      <label for="show-counts" class="ml-2 block text-sm text-gray-300">リアクション数を表示する</label>
                    </div>
                  </div>
                </details>
              </div>
              
              <!-- Enhanced Preview and Publish Section -->
              <div class="space-y-4 pt-4">
                <!-- Preview Settings Summary -->
                <div id="publish-preview-panel" class="hidden bg-gradient-to-br from-purple-900/30 to-blue-900/30 border border-purple-500/30 rounded-xl p-4">
                  <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full flex items-center justify-center">
                      <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                      </svg>
                    </div>
                    <div>
                      <h4 class="text-base font-semibold text-purple-300">公開前プレビュー</h4>
                      <p class="text-xs text-gray-400">設定内容を確認してから公開できます</p>
                    </div>
                  </div>
                  
                  <!-- Configuration Summary -->
                  <div class="space-y-3 mb-4">
                    <div class="grid grid-cols-2 gap-3 text-sm">
                      <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">対象シート</div>
                        <div class="text-white font-medium" id="preview-sheet-name">未選択</div>
                      </div>
                      <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">質問文列</div>
                        <div class="text-white font-medium" id="preview-opinion-column">未設定</div>
                      </div>
                      <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">名前列</div>
                        <div class="text-white font-medium" id="preview-name-column">未設定</div>
                      </div>
                      <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">クラス列</div>
                        <div class="text-white font-medium" id="preview-class-column">未設定</div>
                      </div>
                    </div>
                    
                    <!-- Sample Data Preview -->
                    <div id="sample-data-preview" class="hidden bg-gray-800/30 rounded-lg p-3">
                      <div class="text-xs text-gray-400 mb-2">データプレビュー (最新3件)</div>
                      <div class="space-y-2 text-xs" id="sample-data-list">
                        <!-- Dynamically populated -->
                      </div>
                    </div>
                  </div>
                  
                  <!-- Preview Actions -->
                  <div class="flex gap-2">
                    <button type="button" id="preview-board-btn" class="btn btn-secondary flex-1 text-sm">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                      </svg>
                      ボードプレビュー
                    </button>
                    <button type="button" id="refresh-preview-btn" class="btn btn-secondary px-3" title="プレビューを更新">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                      </svg>
                    </button>
                  </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="space-y-3">
                  <button type="button" id="save-publish-btn" disabled class="btn btn-primary w-full btn-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span id="save-publish-text">設定を保存して公開</span>
                  </button>

                  <button type="button" id="unpublish-board-btn" class="btn btn-warning w-full hidden">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path>
                    </svg>
                    <span id="unpublish-board-text">公開を停止</span>
                  </button>
                </div>
              </div>
            </div>
            
            <div id="config-placeholder" class="text-center py-8">
              <div class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-3">
                <div class="loading-skeleton w-full h-full rounded-full hidden" id="config-loading"></div>
                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                </svg>
              </div>
              <p class="text-gray-400 text-sm">シートを選択すると列設定が表示されます</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 右側：情報・ヘルプパネル -->
      <div class="right-panel space-y-4">
        
        <!-- システム状況 -->
        <div id="system-info-panel" class="glass-panel p-4 lg:p-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 bg-gradient-to-br from-gray-500 to-gray-600 rounded-xl flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
      </div>
      <h3 class="font-semibold text-gray-300">システム状況</h3>
    </div>

    <div class="space-y-4">
      <!-- アカウント情報 -->
      <div class="bg-gray-800/30 border border-gray-600/30 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-200 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          アカウント
        </h4>
        <div class="space-y-2 text-xs">
          <div class="flex justify-between items-center">
            <span class="text-gray-400">メールアドレス:</span>
            <span class="text-white font-medium" id="info-admin-email">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">ユーザーID:</span>
            <span class="text-white font-mono text-xs bg-gray-700 px-1.5 py-0.5 rounded" id="info-user-id">-</span>
          </div>
          <div class="text-right pt-2">
          <button type="button" onclick="adminPanel.logoutAndRedirect()" class="text-cyan-400 hover:text-cyan-300 hover:underline text-xs">
            ログイン画面に戻る
          </button>
          </div>
        </div>
      </div>

      <!-- 公開設定 -->
      <div class="bg-gray-800/30 border border-gray-600/30 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-200 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
          公開設定
        </h4>
        <div class="space-y-2 text-xs">
          <div class="flex justify-between items-center">
            <span class="text-gray-400">公開状態:</span>
            <span class="px-2 py-1 rounded text-xs font-medium" id="info-publish-status">
              <span class="inline-flex items-center gap-1">
                <div class="w-2 h-2 rounded-full" id="info-publish-indicator"></div>
                <span id="info-publish-text">確認中</span>
              </span>
            </span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">公開シート:</span>
            <span class="text-white font-semibold" id="info-published-sheet">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">表示モード:</span>
            <span class="text-white" id="info-display-mode">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">カウント表示:</span>
            <span class="text-white" id="info-show-counts">-</span>
          </div>
        </div>
      </div>

      <!-- データ状況 -->
      <div class="bg-gray-800/30 border border-gray-600/30 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-200 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          データ状況
        </h4>
        <div class="space-y-2 text-xs">
          <div class="flex justify-between items-center">
            <span class="text-gray-400">総回答数:</span>
            <span class="text-white font-bold text-lg" id="info-answer-count">-</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">総リアクション数:</span>
            <span class="text-white font-bold text-lg" id="info-reaction-count">-</span>
          </div>
        </div>
      </div>

      <!-- リソース -->
      <div class="bg-gray-800/30 border border-gray-600/30 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-200 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
          </svg>
          リソース
        </h4>
        <div class="space-y-3 text-xs">
          <div class="flex gap-2">
            <button type="button" id="open-spreadsheet-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded flex items-center justify-center gap-2 transition-all" disabled>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              スプレッドシート
            </button>
            <button type="button" id="open-form-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded flex items-center justify-center gap-2 transition-all" disabled>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              フォーム
            </button>
          </div>
        </div>
        
      </div>
      
      <!-- セットアップ修復ツール -->
      <div class="bg-red-900/10 border border-red-500/30 rounded-lg p-3 transition-all hover:border-red-500/50">
        <h4 class="text-sm font-medium text-red-300 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          修復ツール
        </h4>
        <div class="space-y-2">
          <button type="button" id="setup-repair-btn" onclick="runSetupRepair()" 
                  class="w-full bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded flex items-center justify-center gap-2 transition-all text-xs">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z"></path>
            </svg>
            セットアップ状態を修復
          </button>
          <p class="text-xs text-red-200/70">
            ステップ表示の不整合やフォームURL問題を自動修復します
          </p>
        </div>
      </div>
      
      <!-- アプリ設定リンク -->
<? if (isDeployUser) { ?>
      <div id="app-setup-link" class="bg-blue-900/10 border border-blue-500/30 rounded-lg p-3 transition-all hover:border-blue-500/50">
        <button type="button" onclick="openAppSetupPage()" class="w-full flex items-center justify-between text-sm font-medium text-blue-300 hover:text-blue-200 transition-colors">
          <div class="flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span>アプリ設定管理</span>
          </div>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
        </button>
        <p class="text-xs text-blue-200/70 mt-2 ml-6">
          アプリの有効/無効状態を管理できます
        </p>
      </div>
<? } ?>
      
      <!-- セキュリティと統合情報 -->
      <div class="bg-gray-800/30 border border-gray-600/30 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-200 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
          セキュリティと統合
        </h4>
        <div class="space-y-2 text-xs">
          <div class="flex items-center justify-between">
            <a href="#" onclick="showSecurityInfo(); return false;" class="text-cyan-400 hover:text-cyan-300 hover:underline">
              セキュリティ仕様について
            </a>
          </div>
          <div class="flex items-center justify-between">
            <a href="#" onclick="showGoogleIntegrationInfo(); return false;" class="text-cyan-400 hover:text-cyan-300 hover:underline">
              Google連携の利点
            </a>
          </div>
        </div>
      </div>
      
      <details id="account-deletion-section" class="bg-red-900/10 border border-red-500/30 rounded-lg transition-all hover:border-red-500/50">
        <summary class="p-3 cursor-pointer text-sm font-medium text-red-300 hover:text-red-200 flex items-center justify-between">
          <span>アカウントの管理</span>
          <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </summary>
        <div class="p-3 pt-0 space-y-3">
          <p class="text-xs text-red-200/80 mb-3">
            この操作は元に戻せません。アカウントを削除すると、作成したすべてのボードと設定が完全に消去されます。
          </p>
          
          <!-- 設定リセットボタン -->
          <div class="bg-orange-900/20 border border-orange-500/30 rounded-lg p-3">
            <div class="flex items-start gap-2 mb-2">
              <svg class="w-4 h-4 text-orange-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              <div class="flex-1">
                <h5 class="text-xs font-medium text-orange-300 mb-1">設定をリセット</h5>
                <p class="text-xs text-orange-200/80 mb-3">設定を初期状態にリセットします。アカウントは削除されません。</p>
                <button type="button" id="reset-config-btn" 
                        class="text-xs bg-orange-600 hover:bg-orange-700 text-white px-3 py-1.5 rounded border border-orange-500 transition-colors flex items-center gap-1.5"
                        title="データベースの設定を初期値にリセット">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  設定をリセット
                </button>
              </div>
            </div>
          </div>
          
          <!-- アカウント削除ボタン -->
          <button type="button" id="delete-account-btn" class="btn btn-danger w-full text-sm py-2">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            <span>自分のアカウントを完全に削除する</span>
          </button>
        </div>
      </details>
      </div>
    </div>
  </main>
  
  <!-- 統合フッター -->
  <footer id="admin-footer" class="fixed bottom-0 left-0 right-0 glass-panel border-t border-gray-700 min-h-16 sm:min-h-20 hidden">
    <div class="max-w-6xl mx-auto px-6 py-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4" id="footer-content">
        <!-- 上側/左側: 公開中の問題文と終了日時 -->
        <div class="flex-1">
          <div class="flex items-center gap-4 mb-1">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span class="text-green-400 font-semibold text-sm">公開中:</span>
            </div>
            
            <!-- 予定終了日時表示 -->
            <div class="flex items-center gap-2" id="scheduled-end-display">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span class="text-xs text-gray-400">予定終了:</span>
              <span class="text-xs font-medium" id="scheduled-end-time">未設定</span>
            </div>
          </div>
          <p class="text-blue-300 font-medium text-lg break-words" id="current-topic-text" style="max-width: 60ch; line-height: 1.4;">読み込み中...</p>
        </div>
        
        <!-- 下側/右側: ボードURL操作 -->
        <div class="flex items-center gap-3 flex-shrink-0">
          <input type="text" id="board-url" readonly
                 class="px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-sm cursor-pointer hover:bg-gray-700 focus:ring-2 focus:ring-green-400 min-w-[300px]"
                 onclick="this.select()" placeholder="URLが生成されます">
          <button type="button" onclick="copyBoardUrl(this)" class="btn btn-secondary px-3 py-2 flex items-center" title="URLをコピー" aria-label="生徒用URLをコピー">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
          </button>
          <a id="view-board-link" href="#" target="_blank" rel="noopener noreferrer" 
             class="btn bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white px-4 py-2 flex items-center gap-2 transform hover:scale-105 transition-all duration-200 shadow-lg hover:shadow-xl" 
             title="回答ボードを新しいタブで開く" aria-label="新しいタブで回答ボードを開く">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            <span class="font-semibold text-sm">ボードを見る</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </footer>
  <div id="message-area" class="fixed top-24 right-6 z-50" aria-live="polite" role="status"></div>
  
  <!-- 共通モーダルコンポーネントを読み込み -->
  <?!= include('SharedModals'); ?>
  <!-- Admin Panel JavaScript Components -->
  <!-- Core functions must be loaded first -->
  <?!= include('adminPanel-core.js'); ?>
  <?!= include('adminPanel-status.js'); ?>
  
  <!-- API functions must be loaded before UI and events that depend on them -->
  <?!= include('adminPanel-api.js'); ?>
  
  <!-- UI functions depend on API functions -->
  <?!= include('adminPanel-ui.js'); ?>
  
  <!-- Form controls need to be available before events -->
  <?!= include('adminPanel-forms.js'); ?>
  
  <!-- Events depend on all other modules -->
  <?!= include('adminPanel-events.js'); ?>
  
  <!-- Main initialization script must be loaded last -->
  <?!= include('adminPanel.js'); ?>

  <script>
    // 管理者モーダルの初期化
    document.addEventListener('DOMContentLoaded', function() {
      if (window.sharedModals) {
        window.sharedModals.loadAdminModals();
      }
    });
  </script>

</body>
</html>
