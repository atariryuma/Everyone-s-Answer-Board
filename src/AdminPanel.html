<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <title>StudyQuest - ç®¡ç†ç”»é¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --color-primary: #8be9fd;
      --color-background: #1a1b26;
      --color-surface: rgba(26, 27, 38, 0.7);
      --color-text: #c0caf5;
      --color-border: rgba(255, 255, 255, 0.1);
      --color-success: #10b981;
      --color-error: #ef4444;
      --color-warning: #f59e0b;
    }
    
    body {
      margin: 0;
      background: var(--color-background);
      color: var(--color-text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    .glass-panel {
      background: var(--color-surface);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      border: 1px solid var(--color-border);
      transition: all 0.3s ease;
    }
    
    .glass-panel:hover {
      border-color: rgba(255, 255, 255, 0.2);
      transform: translate3d(0, -2px, 0);
    }
    
    button:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    
    button:not(:disabled):hover {
      transform: translate3d(0, -2px, 0);
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
    
    button:active:not(:disabled) {
      transform: translate3d(0, 0, 0);
    }
    
    :focus-visible { 
      outline: 3px solid var(--color-primary); 
      outline-offset: 2px; 
      border-radius: 4px; 
    }
    
    .spinner {
      animation: spin 1s linear infinite;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(139, 233, 253, 0.3);
      border-top: 2px solid var(--color-primary);
      border-radius: 50%;
    }
    
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    
    .status-success { background: var(--color-success); }
    .status-warning { background: var(--color-warning); }
    .status-error { background: var(--color-error); }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      max-width: 400px;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    
    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .notification.success { background: var(--color-success); }
    .notification.error { background: var(--color-error); }
    .notification.warning { background: var(--color-warning); }
  </style>
</head>
<body>
  <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="relative overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-r from-cyan-400/10 to-purple-400/10"></div>
      <div class="relative max-w-4xl mx-auto px-6 py-8">
        <div class="text-center">
          <h1 class="text-4xl font-bold bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent mb-2">
            StudyQuest
          </h1>
          <p class="text-lg text-slate-400">ç®¡ç†ç”»é¢</p>
        </div>
      </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="max-w-4xl mx-auto px-6 pb-20">
      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¦‚è¦ -->
      <div class="glass-panel rounded-2xl p-8 mb-8 fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <span class="w-8 h-8 bg-gradient-to-r from-cyan-400 to-purple-400 rounded-lg flex items-center justify-center">
            ğŸ“Š
          </span>
          ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-gradient-to-r from-blue-500/10 to-cyan-500/10 rounded-xl p-6 border border-blue-400/20">
            <div class="flex items-center justify-between mb-4">
              <span class="text-blue-400 font-medium">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</span>
              <span id="spreadsheet-status" class="flex items-center">
                <span class="status-dot status-warning"></span>
                <span class="text-sm">æœªè¨­å®š</span>
              </span>
            </div>
            <p id="spreadsheet-name" class="text-2xl font-bold text-white">--</p>
          </div>
          
          <div class="bg-gradient-to-r from-green-500/10 to-emerald-500/10 rounded-xl p-6 border border-green-400/20">
            <div class="flex items-center justify-between mb-4">
              <span class="text-green-400 font-medium">ç·å›ç­”æ•°</span>
              <span class="text-green-400">ğŸ“</span>
            </div>
            <p id="total-answers" class="text-2xl font-bold text-white">0</p>
          </div>
          
          <div class="bg-gradient-to-r from-purple-500/10 to-pink-500/10 rounded-xl p-6 border border-purple-400/20">
            <div class="flex items-center justify-between mb-4">
              <span class="text-purple-400 font-medium">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆ</span>
              <span class="text-purple-400">ğŸ“‹</span>
            </div>
            <p id="active-sheet" class="text-lg font-bold text-white">--</p>
          </div>
        </div>
      </div>

      <!-- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®š -->
      <div class="glass-panel rounded-2xl p-8 mb-8 fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <span class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-400 rounded-lg flex items-center justify-center">
            ğŸ†•
          </span>
          ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®š
        </h2>
        
        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-3">
              Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL
            </label>
            <input 
              type="url" 
              id="spreadsheet-url" 
              placeholder="https://docs.google.com/spreadsheets/d/..."
              class="w-full p-4 bg-slate-800/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition-all"
            >
          </div>
          
          <button 
            type="button" 
            id="setup-button" 
            onclick="setupSpreadsheet()"
            class="w-full md:w-auto px-8 py-4 bg-gradient-to-r from-cyan-400 to-purple-400 text-black font-bold rounded-xl hover:from-cyan-300 hover:to-purple-300 transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:transform-none"
          >
            ğŸš€ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è¨­å®š
          </button>
        </div>
      </div>

      <!-- ã‚·ãƒ¼ãƒˆç®¡ç† -->
      <div class="glass-panel rounded-2xl p-8 mb-8 fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <span class="w-8 h-8 bg-gradient-to-r from-green-400 to-teal-400 rounded-lg flex items-center justify-center">
            ğŸ“‹
          </span>
          ã‚·ãƒ¼ãƒˆç®¡ç†
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-3">
              ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆé¸æŠ
            </label>
            <select 
              id="sheet-select" 
              onchange="switchSheet()"
              class="w-full p-4 bg-slate-800/50 border border-slate-600 rounded-xl text-white focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition-all"
            >
              <option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="flex flex-col justify-end">
            <button 
              type="button" 
              onclick="refreshSheets()"
              class="px-6 py-4 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all duration-300"
            >
              ğŸ”„ ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’æ›´æ–°
            </button>
          </div>
        </div>
      </div>

      <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="glass-panel rounded-2xl p-8 fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <span class="w-8 h-8 bg-gradient-to-r from-orange-400 to-red-400 rounded-lg flex items-center justify-center">
            âš¡
          </span>
          ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button 
            type="button" 
            onclick="openBoard()"
            class="p-6 bg-gradient-to-r from-blue-500/20 to-purple-500/20 border border-blue-400/30 rounded-xl text-left hover:border-blue-400/50 transition-all"
          >
            <div class="text-2xl mb-2">ğŸ“–</div>
            <div class="text-lg font-semibold text-white">ãƒœãƒ¼ãƒ‰ã‚’é–‹ã</div>
            <div class="text-sm text-slate-400">å›ç­”ãƒœãƒ¼ãƒ‰ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™</div>
          </button>
          
          <button 
            type="button" 
            onclick="exportData()"
            class="p-6 bg-gradient-to-r from-green-500/20 to-teal-500/20 border border-green-400/30 rounded-xl text-left hover:border-green-400/50 transition-all"
          >
            <div class="text-2xl mb-2">ğŸ“Š</div>
            <div class="text-lg font-semibold text-white">ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</div>
            <div class="text-sm text-slate-400">å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™</div>
          </button>
        </div>
      </div>
    </main>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="glass-panel rounded-2xl p-8 flex items-center space-x-4">
        <div class="spinner"></div>
        <span id="loading-message" class="text-white font-medium">å‡¦ç†ä¸­...</span>
      </div>
    </div>
  </div>

  <script>
    // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function setLoading(show, message = 'å‡¦ç†ä¸­...') {
      const loading = document.getElementById('loading');
      const loadingMessage = document.getElementById('loading-message');
      
      if (show) {
        loadingMessage.textContent = message;
        loading.classList.remove('hidden');
      } else {
        loading.classList.add('hidden');
      }
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateStatus() {
      setLoading(true, 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ä¸­...');
      
      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            updateStatusDisplay(result.data);
          }
          setLoading(false);
        })
        .withFailureHandler((error) => {
          console.error('Status update failed:', error);
          setLoading(false);
        })
        .getDashboardData();
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
    function updateStatusDisplay(data) {
      const spreadsheetStatus = document.getElementById('spreadsheet-status');
      const spreadsheetName = document.getElementById('spreadsheet-name');
      const totalAnswers = document.getElementById('total-answers');
      const activeSheet = document.getElementById('active-sheet');
      
      if (data.hasActiveSpreadsheet) {
        spreadsheetStatus.innerHTML = `
          <span class="status-dot status-success"></span>
          <span class="text-sm text-green-400">æ¥ç¶šæ¸ˆã¿</span>
        `;
        spreadsheetName.textContent = 'è¨­å®šæ¸ˆã¿';
      } else {
        spreadsheetStatus.innerHTML = `
          <span class="status-dot status-warning"></span>
          <span class="text-sm text-yellow-400">æœªè¨­å®š</span>
        `;
        spreadsheetName.textContent = '--';
      }
      
      totalAnswers.textContent = data.totalAnswers || 0;
      activeSheet.textContent = data.activeSheetName || '--';
    }
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®š
    function setupSpreadsheet() {
      const urlInput = document.getElementById('spreadsheet-url');
      const url = urlInput.value.trim();
      
      if (!url) {
        showNotification('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      if (!url.includes('docs.google.com/spreadsheets')) {
        showNotification('æœ‰åŠ¹ãªGoogleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      setLoading(true, 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è¨­å®šä¸­...');
      
      const spreadsheetId = extractSpreadsheetId(url);
      
      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            showNotification('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
            urlInput.value = '';
            updateStatus();
            loadSheets();
          } else {
            showNotification(result?.message || 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
          setLoading(false);
        })
        .withFailureHandler((error) => {
          showNotification('è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          setLoading(false);
        })
        .setupSpreadsheet(spreadsheetId);
    }
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDæŠ½å‡º
    function extractSpreadsheetId(url) {
      const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return match ? match[1] : url;
    }
    
    // ã‚·ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
    function loadSheets() {
      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            updateSheetSelect(result.sheets);
          } else {
            console.warn('Sheet loading failed:', result?.message);
          }
        })
        .withFailureHandler((error) => {
          console.error('Sheet loading error:', error);
        })
        .getAvailableSheets();
    }
    
    // ã‚·ãƒ¼ãƒˆé¸æŠæ›´æ–°
    function updateSheetSelect(sheets) {
      const sheetSelect = document.getElementById('sheet-select');
      sheetSelect.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      
      if (sheets && sheets.length > 0) {
        sheets.forEach(sheet => {
          const option = document.createElement('option');
          option.value = sheet.name;
          option.textContent = sheet.name;
          if (sheet.isActive) {
            option.selected = true;
          }
          sheetSelect.appendChild(option);
        });
      }
    }
    
    // ã‚·ãƒ¼ãƒˆæ›´æ–°
    function refreshSheets() {
      setLoading(true, 'ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’æ›´æ–°ä¸­...');
      
      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            updateSheetSelect(result.sheets);
            showNotification('ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
          } else {
            showNotification(result?.message || 'ã‚·ãƒ¼ãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
          setLoading(false);
        })
        .withFailureHandler((error) => {
          showNotification('ã‚·ãƒ¼ãƒˆä¸€è¦§ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          setLoading(false);
        })
        .getAvailableSheets();
    }
    
    // ã‚·ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
    function switchSheet() {
      const selectedSheet = document.getElementById('sheet-select').value;
      if (!selectedSheet) return;
      
      setLoading(true, 'ã‚·ãƒ¼ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆä¸­...');
      
      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            showNotification('ã‚·ãƒ¼ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ', 'success');
            updateStatus();
          } else {
            showNotification(result?.message || 'ã‚·ãƒ¼ãƒˆã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
          setLoading(false);
        })
        .withFailureHandler((error) => {
          showNotification('åˆ‡ã‚Šæ›¿ãˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          setLoading(false);
        })
        .switchToSheet(selectedSheet);
    }
    
    // ãƒœãƒ¼ãƒ‰ã‚’é–‹ã
    function openBoard() {
      const baseUrl = window.location.origin + window.location.pathname;
      const boardUrl = baseUrl + '?action=view';
      window.open(boardUrl, '_blank');
    }
    
    // ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›
    function exportData() {
      showNotification('ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'warning');
    }
    
    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      updateStatus();
      loadSheets();
    });
  </script>
</body>
</html>