<script>
/* =============================================================================
   StudyQuest - Registration Logic
   Extracted from Registration.html for better maintainability
   Handles registration process and modal management
   ============================================================================= */

// =============================================================================
// REGISTRATION STATE MANAGEMENT
// =============================================================================

let userEmail = '';
let isRegistrationInProgress = false;
let selectedAgeGroup = '';
let uiInitialized = false;

// =============================================================================
// REGISTRATION UTILITY FUNCTIONS
// =============================================================================

/**
 * Update user display after successful authentication
 * @param {string} email - User email address
 */
function updateUserDisplay(email) {
  userEmail = email;
  
  // Update UI elements
  if (window.sharedUtilities) {
    window.sharedUtilities.dom.updateSafely('status-text', '認証済み', 'text');
    window.sharedUtilities.dom.updateSafely('user-email', email, 'text');
    window.sharedUtilities.message.showSimple('回答ボードを作成できます', 'success');
  } else {
    const statusTextEl = document.getElementById('status-text');
    const userEmailEl = document.getElementById('user-email');
    const messageAreaEl = document.getElementById('message-area');
    
    if (statusTextEl) statusTextEl.textContent = '認証済み';
    if (userEmailEl) userEmailEl.textContent = email;
    if (messageAreaEl) {
      messageAreaEl.textContent = '回答ボードを作成できます';
      messageAreaEl.className = 'message-area success';
    }
  }
  
  // Enable registration button
  const registerBtn = document.getElementById('register-btn');
  if (registerBtn) {
    registerBtn.disabled = false;
  }
}

// =============================================================================
// REGISTRATION PROCESS
// =============================================================================

/**
 * Execute registration process
 */
function executeRegistrationWithConfirmation() {
  if (isRegistrationInProgress || !userEmail) return;

  // Directly execute registration without age-specific modals
  executeRegistration();
}

/**
 * Execute the main registration process
 */
function executeRegistration() {
  if (isRegistrationInProgress || !userEmail) return;

  isRegistrationInProgress = true;
  
  // Update button state using shared utilities
  if (window.sharedUtilities) {
    window.sharedUtilities.loading.setButton('register-btn', '登録処理中...');
  } else {
    const registerBtn = document.getElementById('register-btn');
    const btnContent = document.getElementById('btn-content');
    if (registerBtn && btnContent) {
      registerBtn.disabled = true;
      btnContent.innerHTML = '<span class="spinner"></span>登録処理中...';
    }
  }

  // Clear message area
  if (window.sharedUtilities) {
    window.sharedUtilities.message.showSimple('', 'info');
  }

  // Call Google Apps Script
  if (window.sharedUtilities) {
    window.sharedUtilities.gas.call(
      'quickStartSetup',
      showSuccessResult,
      function(error) {
        console.error('Registration error:', error);
        window.sharedUtilities.message.showSimple(error.message || '登録に失敗しました', 'error');
        window.sharedUtilities.loading.restoreButton('register-btn');
        isRegistrationInProgress = false;
      },
      [],
      '登録処理'
    );
  } else {
    google.script.run
      .withSuccessHandler(showSuccessResult)
      .withFailureHandler(error => {
        console.error('Registration error:', error);
        if (window.sharedUtilities) {
          window.sharedUtilities.message.showSimple(error.message || '登録に失敗しました', 'error');
        }
        
        const registerBtn = document.getElementById('register-btn');
        const btnContent = document.getElementById('btn-content');
        if (registerBtn && btnContent) {
          registerBtn.disabled = false;
          btnContent.textContent = '回答ボードを作成';
        }
        isRegistrationInProgress = false;
      })
      .quickStartSetup();
  }
}

/**
 * Show success result and handle navigation
 * @param {Object} result - Registration result
 */
function showSuccessResult(result) {
  const mainContainer = document.getElementById('main-container');
  const successContainer = document.getElementById('success-container');
  const adminPanelBtn = document.getElementById('admin-panel-btn');
  
  if (mainContainer) mainContainer.style.display = 'none';
  if (successContainer) successContainer.style.display = 'block';
  
  if (result?.adminUrl && result?.userId) {
    if (adminPanelBtn) adminPanelBtn.href = result.adminUrl;
    
    console.log('Registration complete, verifying user before navigation:', { 
      adminUrl: result.adminUrl, 
      userId: result.userId 
    });
    
    // Verify user exists before navigation
    google.script.run
      .withSuccessHandler(userExists => {
        console.log('User verification result:', userExists);
        if (userExists && userExists.found) {
          console.log('User verified, proceeding with navigation');
          
          // Show manual navigation dialog for reliability
          setTimeout(() => {
            if (window.sharedUtilities && window.sharedUtilities.navigation) {
              window.sharedUtilities.navigation.showManualNavigationDialog(
                result.adminUrl, 
                '登録完了！管理パネルに移動します'
              );
            }
          }, 2000);
          
          // Try automatic navigation
          google.script.run
            .withSuccessHandler(navResult => {
              if (navResult && navResult.success) {
                console.log('Server navigation prepared:', navResult.redirectUrl);
                try {
                  if (window.parent && window.parent.location) {
                    window.parent.location.replace(navResult.redirectUrl);
                  } else {
                    window.open(navResult.redirectUrl, '_top');
                  }
                } catch (e) {
                  console.log('Automatic navigation failed, user will use manual dialog');
                }
              }
            })
            .withFailureHandler(error => {
              console.warn('Server navigation failed:', error);
            })
            .navigateToAdminPanel(result.userId);
        } else {
          console.error('User verification failed, showing error message');
          if (window.sharedUtilities) {
            window.sharedUtilities.message.showSimple(
              'アカウント作成は完了しましたが、データベースでの確認ができませんでした。しばらく待ってから管理パネルにアクセスしてください。', 
              'warning'
            );
          }
          
          setTimeout(() => {
            if (window.sharedUtilities && window.sharedUtilities.navigation) {
              window.sharedUtilities.navigation.showManualNavigationDialog(
                result.adminUrl, 
                'データベース同期待ち - 管理パネルにアクセス'
              );
            }
          }, 5000);
        }
      })
      .withFailureHandler(error => {
        console.error('User verification error:', error);
        if (window.sharedUtilities) {
          window.sharedUtilities.message.showSimple(
            'ユーザー確認でエラーが発生しました。管理パネルに直接アクセスしてください。', 
            'error'
          );
        }
        
        setTimeout(() => {
          if (window.sharedUtilities && window.sharedUtilities.navigation) {
            window.sharedUtilities.navigation.showManualNavigationDialog(
              result.adminUrl, 
              'エラー発生 - 管理パネルにアクセス'
            );
          }
        }, 3000);
      })
      .verifyUserExists(result.userId);
  }
}

// =============================================================================
// MODAL MANAGEMENT
// =============================================================================

/**
 * Setup modal triggers for privacy and digital citizenship
 */
function setupModalTriggers() {
  const modalTriggers = document.querySelectorAll('[data-modal-trigger]');
  modalTriggers.forEach(trigger => {
    trigger.addEventListener('click', (e) => {
      e.preventDefault();
      const modalType = trigger.getAttribute('data-modal-trigger');
      
      // Fixed to teacher for registration page
      const ageGroup = 'teacher';
      
      console.log(`Opening modal: ${modalType} for age group: ${ageGroup}`);
      
      // Use SharedModals system
      if (modalType === 'enhanced-privacy') {
        window.showEnhancedPrivacyModal && window.showEnhancedPrivacyModal(ageGroup);
      } else if (modalType === 'enhanced-digital-citizenship') {
        window.showEnhancedDigitalCitizenshipModal && window.showEnhancedDigitalCitizenshipModal(ageGroup);
      }
    });
  });
}

// =============================================================================
// PAGE INITIALIZATION
// =============================================================================

/**
 * Initialize the registration page
 */
function initializePage() {
  google.script.run
    .withSuccessHandler(result => {
      if (result?.status === 'existing_user') {
        if (result?.userId) {
          // Use server-side navigation for existing users
          google.script.run
            .withSuccessHandler(navResult => {
              if (navResult && navResult.success) {
                window.location.href = navResult.redirectUrl;
              } else {
                if (window.sharedUtilities && window.sharedUtilities.navigation) {
                  window.sharedUtilities.navigation.safeNavigate(result.adminUrl, {
                    fallbackMessage: '管理パネルに移動中...',
                    delay: 1000
                  });
                }
              }
            })
            .withFailureHandler(() => {
              if (window.sharedUtilities && window.sharedUtilities.navigation) {
                window.sharedUtilities.navigation.safeNavigate(result.adminUrl, {
                  fallbackMessage: '管理パネルに移動中...',
                  delay: 1000
                });
              }
            })
            .navigateToAdminPanel(result.userId);
        } else {
          if (window.sharedUtilities && window.sharedUtilities.navigation) {
            window.sharedUtilities.navigation.safeNavigate(result.adminUrl, {
              fallbackMessage: '管理パネルに移動中...',
              delay: 1000
            });
          }
        }
        return;
      }
      
      // Verify user authentication for new users
      google.script.run
        .withSuccessHandler(authResult => {
          if (authResult?.email || authResult?.userEmail) {
            updateUserDisplay(authResult.email || authResult.userEmail);
          } else {
            throw new Error('メールアドレスが取得できませんでした');
          }
        })
        .withFailureHandler(err => {
          const statusTextEl = document.getElementById('status-text');
          if (statusTextEl) statusTextEl.textContent = '認証エラー';
          
          if (window.sharedUtilities) {
            window.sharedUtilities.message.showSimple('ページの再読み込みが必要です', 'error');
          }
          console.error(err);
        })
        .verifyUserAuthentication();
    })
    .getExistingBoard();
}

// =============================================================================
// DOMAIN INFO MANAGEMENT
// =============================================================================

/**
 * Fetch and display domain information
 */
function fetchAndDisplayDomainInfo() {
  google.script.run
    .withSuccessHandler(displayDomainInfo)
    .withFailureHandler(error => {
      console.error('ドメイン情報の取得に失敗しました:', error);
    })
    .getDeployUserDomainInfo();
}

/**
 * Display domain information in the header
 * @param {Object} info - Domain information object
 */
function displayDomainInfo(info) {
  const headerDomainMatch = document.getElementById('header-domain-match');
  const headerDomainMismatch = document.getElementById('header-domain-mismatch');
  const headerDomainInitial = document.getElementById('header-domain-initial');
  const headerDomainMatchText = document.getElementById('header-domain-match-text');
  const headerDomainMismatchText = document.getElementById('header-domain-mismatch-text');

  // Hide all domain displays initially
  if (headerDomainMatch) headerDomainMatch.classList.add('hidden');
  if (headerDomainMismatch) headerDomainMismatch.classList.add('hidden');
  if (headerDomainInitial) headerDomainInitial.classList.add('hidden');

  if (!info || info.error) {
    console.warn('ドメイン情報エラー:', info?.error || 'Unknown error');
    return;
  }

  if (info.currentDomain === info.deployDomain) {
    // Domain match
    if (headerDomainMatch && headerDomainMatchText) {
      headerDomainMatch.classList.remove('hidden');
      headerDomainMatchText.textContent = `${info.deployDomain} ドメイン`;
    }
  } else {
    // Domain mismatch
    if (headerDomainMismatch && headerDomainMismatchText) {
      headerDomainMismatch.classList.remove('hidden');
      headerDomainMismatchText.textContent = `外部アクセス (User: ${info.currentDomain} | Deploy: ${info.deployDomain})`;
    }
  }
}

// =============================================================================
// EVENT LISTENERS SETUP
// =============================================================================

/**
 * Initialize event listeners for the registration page
 */
function initializeEventListeners() {
  const registerBtn = document.getElementById('register-btn');
  
  if (registerBtn) {
    registerBtn.addEventListener('click', executeRegistrationWithConfirmation);
  }
  
  // Setup modal triggers
  setupModalTriggers();
  
  console.log('Registration page event listeners initialized');
}

// =============================================================================
// INITIALIZATION
// =============================================================================

/**
 * Initialize registration page when DOM is ready
 */
function initializeRegistrationPage() {
  console.log('🔧 Initializing Registration Page Logic...');
  
  // Initialize page components
  initializePage();
  initializeEventListeners();
  
  // Fetch domain information
  fetchAndDisplayDomainInfo();
  
  console.log('✅ Registration Page Logic initialized');
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeRegistrationPage);
} else {
  initializeRegistrationPage();
}

// =============================================================================
// EXPORT TO GLOBAL SCOPE
// =============================================================================

// Export registration utilities to global scope
window.registrationUtilities = {
  state: {
    userEmail: () => userEmail,
    isInProgress: () => isRegistrationInProgress
  },
  ui: {
    updateUserDisplay: updateUserDisplay
  },
  process: {
    execute: executeRegistration,
    executeWithConfirmation: executeRegistrationWithConfirmation,
    showSuccess: showSuccessResult
  },
  domain: {
    fetch: fetchAndDisplayDomainInfo,
    display: displayDomainInfo
  },
  modal: {
    setupTriggers: setupModalTriggers
  }
};

</script>