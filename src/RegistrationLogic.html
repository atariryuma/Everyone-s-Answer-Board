<script>
/* =============================================================================
   StudyQuest - Registration Logic
   Extracted from Registration.html for better maintainability
   Handles registration process and modal management
   ============================================================================= */

// =============================================================================
// REGISTRATION STATE MANAGEMENT
// =============================================================================

let userEmail = '';
let isRegistrationInProgress = false;
let selectedAgeGroup = '';
let uiInitialized = false;

// =============================================================================
// REGISTRATION UTILITY FUNCTIONS
// =============================================================================

/**
 * Update user display after successful authentication
 * @param {string} email - User email address
 */
function updateUserDisplay(email) {
  userEmail = email;
  
  // Update UI elements
  if (window.sharedUtilities) {
    window.sharedUtilities.dom.updateSafely('status-text', 'Ë™çË®ºÊ∏à„Åø', 'text');
    window.sharedUtilities.dom.updateSafely('user-email', email, 'text');
    window.sharedUtilities.message.showSimple('ÂõûÁ≠î„Éú„Éº„Éâ„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô', 'success');
  } else {
    const statusTextEl = document.getElementById('status-text');
    const userEmailEl = document.getElementById('user-email');
    const messageAreaEl = document.getElementById('message-area');
    
    if (statusTextEl) statusTextEl.textContent = 'Ë™çË®ºÊ∏à„Åø';
    if (userEmailEl) userEmailEl.textContent = email;
    if (messageAreaEl) {
      messageAreaEl.textContent = 'ÂõûÁ≠î„Éú„Éº„Éâ„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô';
      messageAreaEl.className = 'message-area success';
    }
  }
  
  // Enable registration button
  const registerBtn = document.getElementById('register-btn');
  if (registerBtn) {
    registerBtn.disabled = false;
  }
}

// =============================================================================
// REGISTRATION PROCESS
// =============================================================================

/**
 * Execute registration process
 */
function executeRegistrationWithConfirmation() {
  if (isRegistrationInProgress || !userEmail) return;

  // Directly execute registration without age-specific modals
  executeRegistration();
}

/**
 * Execute the main registration process
 */
function executeRegistration() {
  if (isRegistrationInProgress || !userEmail) return;

  isRegistrationInProgress = true;
  
  // Update button state using shared utilities
  if (window.sharedUtilities) {
    window.sharedUtilities.loading.setButton('register-btn', 'ÁôªÈå≤Âá¶ÁêÜ‰∏≠...');
  } else {
    const registerBtn = document.getElementById('register-btn');
    const btnContent = document.getElementById('btn-content');
    if (registerBtn && btnContent) {
      registerBtn.disabled = true;
      btnContent.innerHTML = '<span class="spinner"></span>ÁôªÈå≤Âá¶ÁêÜ‰∏≠...';
    }
  }

  // Clear message area
  if (window.sharedUtilities) {
    window.sharedUtilities.message.showSimple('', 'info');
  }

  // Call Google Apps Script
  if (window.sharedUtilities) {
    window.sharedUtilities.gas.call(
      'quickStartSetup',
      showSuccessResult,
      function(error) {
        console.error('Registration error:', error);
        window.sharedUtilities.message.showSimple(error.message || 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        window.sharedUtilities.loading.restoreButton('register-btn');
        isRegistrationInProgress = false;
      },
      [],
      'ÁôªÈå≤Âá¶ÁêÜ'
    );
  } else {
    google.script.run
      .withSuccessHandler(showSuccessResult)
      .withFailureHandler(error => {
        console.error('Registration error:', error);
        if (window.sharedUtilities) {
          window.sharedUtilities.message.showSimple(error.message || 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        }
        
        const registerBtn = document.getElementById('register-btn');
        const btnContent = document.getElementById('btn-content');
        if (registerBtn && btnContent) {
          registerBtn.disabled = false;
          btnContent.textContent = 'ÂõûÁ≠î„Éú„Éº„Éâ„Çí‰ΩúÊàê';
        }
        isRegistrationInProgress = false;
      })
      .quickStartSetup();
  }
}

/**
 * Show success result and handle navigation
 * @param {Object} result - Registration result
 */
function showSuccessResult(result) {
  const mainContainer = document.getElementById('main-container');
  const successContainer = document.getElementById('success-container');
  const adminPanelBtn = document.getElementById('admin-panel-btn');
  
  if (mainContainer) mainContainer.style.display = 'none';
  if (successContainer) successContainer.style.display = 'block';
  
  if (result?.adminUrl && result?.userId) {
    if (adminPanelBtn) adminPanelBtn.href = result.adminUrl;
    
    console.log('Registration complete, verifying user before navigation:', { 
      adminUrl: result.adminUrl, 
      userId: result.userId 
    });
    
    // Verify user exists before navigation
    google.script.run
      .withSuccessHandler(userExists => {
        console.log('User verification result:', userExists);
        if (userExists && userExists.found) {
          console.log('User verified, proceeding with navigation');
          
          // Show manual navigation dialog for reliability
          setTimeout(() => {
            if (window.sharedUtilities && window.sharedUtilities.navigation) {
              window.sharedUtilities.navigation.showManualNavigationDialog(
                result.adminUrl, 
                'ÁôªÈå≤ÂÆå‰∫ÜÔºÅÁÆ°ÁêÜ„Éë„Éç„É´„Å´ÁßªÂãï„Åó„Åæ„Åô'
              );
            }
          }, 2000);
          
          // Try automatic navigation
          google.script.run
            .withSuccessHandler(navResult => {
              if (navResult && navResult.success) {
                console.log('Server navigation prepared:', navResult.redirectUrl);
                try {
                  if (window.parent && window.parent.location) {
                    window.parent.location.replace(navResult.redirectUrl);
                  } else {
                    window.open(navResult.redirectUrl, '_top');
                  }
                } catch (e) {
                  console.log('Automatic navigation failed, user will use manual dialog');
                }
              }
            })
            .withFailureHandler(error => {
              console.warn('Server navigation failed:', error);
            })
            .navigateToAdminPanel(result.userId);
        } else {
          console.error('User verification failed, showing error message');
          if (window.sharedUtilities) {
            window.sharedUtilities.message.showSimple(
              '„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê„ÅØÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„Åå„ÄÅ„Éá„Éº„Çø„Éô„Éº„Çπ„Åß„ÅÆÁ¢∫Ë™ç„Åå„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÁÆ°ÁêÜ„Éë„Éç„É´„Å´„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 
              'warning'
            );
          }
          
          setTimeout(() => {
            if (window.sharedUtilities && window.sharedUtilities.navigation) {
              window.sharedUtilities.navigation.showManualNavigationDialog(
                result.adminUrl, 
                '„Éá„Éº„Çø„Éô„Éº„ÇπÂêåÊúüÂæÖ„Å° - ÁÆ°ÁêÜ„Éë„Éç„É´„Å´„Ç¢„ÇØ„Çª„Çπ'
              );
            }
          }, 5000);
        }
      })
      .withFailureHandler(error => {
        console.error('User verification error:', error);
        if (window.sharedUtilities) {
          window.sharedUtilities.message.showSimple(
            '„É¶„Éº„Ç∂„ÉºÁ¢∫Ë™ç„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÁÆ°ÁêÜ„Éë„Éç„É´„Å´Áõ¥Êé•„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 
            'error'
          );
        }
        
        setTimeout(() => {
          if (window.sharedUtilities && window.sharedUtilities.navigation) {
            window.sharedUtilities.navigation.showManualNavigationDialog(
              result.adminUrl, 
              '„Ç®„É©„ÉºÁô∫Áîü - ÁÆ°ÁêÜ„Éë„Éç„É´„Å´„Ç¢„ÇØ„Çª„Çπ'
            );
          }
        }, 3000);
      })
      .verifyUserExists(result.userId);
  }
}

// =============================================================================
// MODAL MANAGEMENT
// =============================================================================

/**
 * Setup modal triggers for privacy and digital citizenship
 */
function setupModalTriggers() {
  const modalTriggers = document.querySelectorAll('[data-modal-trigger]');
  modalTriggers.forEach(trigger => {
    trigger.addEventListener('click', (e) => {
      e.preventDefault();
      const modalType = trigger.getAttribute('data-modal-trigger');
      
      // Fixed to teacher for registration page
      const ageGroup = 'teacher';
      
      console.log(`Opening modal: ${modalType} for age group: ${ageGroup}`);
      
      // Use SharedModals system
      if (modalType === 'enhanced-privacy') {
        window.showEnhancedPrivacyModal && window.showEnhancedPrivacyModal(ageGroup);
      } else if (modalType === 'enhanced-digital-citizenship') {
        window.showEnhancedDigitalCitizenshipModal && window.showEnhancedDigitalCitizenshipModal(ageGroup);
      }
    });
  });
}

// =============================================================================
// PAGE INITIALIZATION
// =============================================================================

/**
 * Initialize the registration page
 */
function initializePage() {
  google.script.run
    .withSuccessHandler(result => {
      if (result?.status === 'existing_user') {
        if (result?.userId) {
          // Use server-side navigation for existing users
          google.script.run
            .withSuccessHandler(navResult => {
              if (navResult && navResult.success) {
                window.location.href = navResult.redirectUrl;
              } else {
                if (window.sharedUtilities && window.sharedUtilities.navigation) {
                  window.sharedUtilities.navigation.safeNavigate(result.adminUrl, {
                    fallbackMessage: 'ÁÆ°ÁêÜ„Éë„Éç„É´„Å´ÁßªÂãï‰∏≠...',
                    delay: 1000
                  });
                }
              }
            })
            .withFailureHandler(() => {
              if (window.sharedUtilities && window.sharedUtilities.navigation) {
                window.sharedUtilities.navigation.safeNavigate(result.adminUrl, {
                  fallbackMessage: 'ÁÆ°ÁêÜ„Éë„Éç„É´„Å´ÁßªÂãï‰∏≠...',
                  delay: 1000
                });
              }
            })
            .navigateToAdminPanel(result.userId);
        } else {
          if (window.sharedUtilities && window.sharedUtilities.navigation) {
            window.sharedUtilities.navigation.safeNavigate(result.adminUrl, {
              fallbackMessage: 'ÁÆ°ÁêÜ„Éë„Éç„É´„Å´ÁßªÂãï‰∏≠...',
              delay: 1000
            });
          }
        }
        return;
      }
      
      // Verify user authentication for new users
      google.script.run
        .withSuccessHandler(authResult => {
          if (authResult?.email || authResult?.userEmail) {
            updateUserDisplay(authResult.email || authResult.userEmail);
          } else {
            throw new Error('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
          }
        })
        .withFailureHandler(err => {
          const statusTextEl = document.getElementById('status-text');
          if (statusTextEl) statusTextEl.textContent = 'Ë™çË®º„Ç®„É©„Éº';
          
          if (window.sharedUtilities) {
            window.sharedUtilities.message.showSimple('„Éö„Éº„Ç∏„ÅÆÂÜçË™≠„ÅøËæº„Åø„ÅåÂøÖË¶Å„Åß„Åô', 'error');
          }
          console.error(err);
        })
        .verifyUserAuthentication();
    })
    .getExistingBoard();
}

// =============================================================================
// DOMAIN INFO MANAGEMENT
// =============================================================================

/**
 * Fetch and display domain information
 */
function fetchAndDisplayDomainInfo() {
  google.script.run
    .withSuccessHandler(displayDomainInfo)
    .withFailureHandler(error => {
      console.error('„Éâ„É°„Ç§„É≥ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
    })
    .getDeployUserDomainInfo();
}

/**
 * Display domain information in the header
 * @param {Object} info - Domain information object
 */
function displayDomainInfo(info) {
  const headerDomainMatch = document.getElementById('header-domain-match');
  const headerDomainMismatch = document.getElementById('header-domain-mismatch');
  const headerDomainInitial = document.getElementById('header-domain-initial');
  const headerDomainMatchText = document.getElementById('header-domain-match-text');
  const headerDomainMismatchText = document.getElementById('header-domain-mismatch-text');

  // Hide all domain displays initially
  if (headerDomainMatch) headerDomainMatch.classList.add('hidden');
  if (headerDomainMismatch) headerDomainMismatch.classList.add('hidden');
  if (headerDomainInitial) headerDomainInitial.classList.add('hidden');

  if (!info || info.error) {
    console.warn('„Éâ„É°„Ç§„É≥ÊÉÖÂ†±„Ç®„É©„Éº:', info?.error || 'Unknown error');
    return;
  }

  if (info.currentDomain === info.deployDomain) {
    // Domain match
    if (headerDomainMatch && headerDomainMatchText) {
      headerDomainMatch.classList.remove('hidden');
      headerDomainMatchText.textContent = `${info.deployDomain} „Éâ„É°„Ç§„É≥`;
    }
  } else {
    // Domain mismatch
    if (headerDomainMismatch && headerDomainMismatchText) {
      headerDomainMismatch.classList.remove('hidden');
      headerDomainMismatchText.textContent = `Â§ñÈÉ®„Ç¢„ÇØ„Çª„Çπ (User: ${info.currentDomain} | Deploy: ${info.deployDomain})`;
    }
  }
}

// =============================================================================
// EVENT LISTENERS SETUP
// =============================================================================

/**
 * Initialize event listeners for the registration page
 */
function initializeEventListeners() {
  const registerBtn = document.getElementById('register-btn');
  
  if (registerBtn) {
    registerBtn.addEventListener('click', executeRegistrationWithConfirmation);
  }
  
  // Setup modal triggers
  setupModalTriggers();
  
  console.log('Registration page event listeners initialized');
}

// =============================================================================
// INITIALIZATION
// =============================================================================

/**
 * Initialize registration page when DOM is ready
 */
function initializeRegistrationPage() {
  console.log('üîß Initializing Registration Page Logic...');
  
  // Initialize page components
  initializePage();
  initializeEventListeners();
  
  // Fetch domain information
  fetchAndDisplayDomainInfo();
  
  console.log('‚úÖ Registration Page Logic initialized');
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeRegistrationPage);
} else {
  initializeRegistrationPage();
}

// =============================================================================
// EXPORT TO GLOBAL SCOPE
// =============================================================================

// Export registration utilities to global scope
window.registrationUtilities = {
  state: {
    userEmail: () => userEmail,
    isInProgress: () => isRegistrationInProgress
  },
  ui: {
    updateUserDisplay: updateUserDisplay
  },
  process: {
    execute: executeRegistration,
    executeWithConfirmation: executeRegistrationWithConfirmation,
    showSuccess: showSuccessResult
  },
  domain: {
    fetch: fetchAndDisplayDomainInfo,
    display: displayDomainInfo
  },
  modal: {
    setupTriggers: setupModalTriggers
  }
};

</script>