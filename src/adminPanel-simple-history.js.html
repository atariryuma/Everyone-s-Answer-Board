<script>
/**
 * 簡易履歴管理システム
 * ローカルストレージのみを使用するシンプルなアプローチ
 */

// 履歴管理定数
const HISTORY_STORAGE_KEY = 'answerBoardHistory';
const MAX_HISTORY_ITEMS = 5;

/**
 * ローカルストレージから履歴を取得
 * @returns {Array} 履歴配列
 */
function getSimpleHistory() {
  try {
    const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
    return historyJson ? JSON.parse(historyJson) : [];
  } catch (error) {
    logWarn('履歴データの読み込みに失敗:', error);
    return [];
  }
}

/**
 * 履歴をローカルストレージに保存
 * @param {Array} historyArray 履歴配列
 */
function saveSimpleHistory(historyArray) {
  try {
    const safeHistory = Array.isArray(historyArray) ? historyArray : [];
    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(safeHistory));
    logDebug('履歴を保存しました:', safeHistory.length, '件');
  } catch (error) {
    logWarn('履歴の保存に失敗:', error);
  }
}

/**
 * 新しい履歴項目を追加
 * @param {Object} historyItem 履歴アイテム
 */
function addToSimpleHistory(historyItem) {
  try {
    if (!historyItem || !historyItem.questionText) {
      logWarn('無効な履歴アイテムです');
      return;
    }

    const history = getSimpleHistory();
    const newItem = {
      id: 'history_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      questionText: historyItem.questionText,
      publishedAt: new Date().toISOString(),
      displayMode: historyItem.displayMode || 'NAMED',
      configData: historyItem.configData || {} // configJsonとして保存される実際の設定データ
    };

    // 先頭に追加
    history.unshift(newItem);

    // 最大件数を超えた場合は削除
    if (history.length > MAX_HISTORY_ITEMS) {
      history.splice(MAX_HISTORY_ITEMS);
    }

    saveSimpleHistory(history);
    updateHistoryTable();
    
    logDebug('履歴に追加しました:', newItem);
  } catch (error) {
    logError(error, 'addToSimpleHistory', ERROR_SEVERITY.MEDIUM, ERROR_CATEGORIES.USER_INPUT);
  }
}

/**
 * 履歴をクリア
 */
function clearSimpleHistory() {
  try {
    localStorage.removeItem(HISTORY_STORAGE_KEY);
    updateHistoryTable();
    logDebug('履歴をクリアしました');
  } catch (error) {
    logWarn('履歴のクリアに失敗:', error);
  }
}

/**
 * 履歴から復元する（シンプル版）
 * @param {string} historyId 履歴ID
 */
async function restoreFromSimpleHistory(historyId) {
  try {
    const history = getSimpleHistory();
    const selectedItem = history.find(item => item.id === historyId);
    
    if (!selectedItem) {
      showMessage('選択された履歴が見つかりません', 'error');
      return;
    }

    // 確認ダイアログ
    const confirmed = confirm('「' + selectedItem.questionText + '」の設定を復元しますか？\n\n現在の設定は上書きされます。');
    if (!confirmed) return;

    // 設定データを直接データベースに保存
    const userId = getUserId();
    if (!userId) {
      showMessage('ユーザーIDが取得できません', 'error');
      return;
    }

    // configDataをconfigJsonとして保存
    const result = await runGasWithUserId('updateUserConfig', selectedItem.configData);
    
    if (result && result.success) {
      showMessage('履歴から設定を復元しました', 'success');
      
      // キャッシュをクリアして再読み込み
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      
      // 管理画面を再読み込み
      setTimeout(() => {
        location.reload();
      }, 1000);
      
    } else {
      showMessage('設定の復元に失敗しました', 'error');
    }
    
  } catch (error) {
    logError(error, 'restoreFromSimpleHistory', ERROR_SEVERITY.HIGH, ERROR_CATEGORIES.USER_INPUT);
    showMessage('履歴の復元中にエラーが発生しました', 'error');
  }
}

/**
 * 履歴テーブルを更新
 */
function updateHistoryTable() {
  try {
    const historyTableBody = document.getElementById('history-table-body');
    if (!historyTableBody) return;

    const history = getSimpleHistory();
    
    if (history.length === 0) {
      historyTableBody.innerHTML = '<tr><td colspan="3" class="text-gray-500 text-center py-4">履歴がありません</td></tr>';
      return;
    }

    historyTableBody.innerHTML = history.map(item => {
      const publishedDate = new Date(item.publishedAt).toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      return `
        <tr class="hover:bg-gray-50">
          <td class="py-2 px-3 text-sm">${escapeHtml(item.questionText)}</td>
          <td class="py-2 px-3 text-xs text-gray-500">${publishedDate}</td>
          <td class="py-2 px-3 text-right">
            <button onclick="restoreFromSimpleHistory('${item.id}')" 
                    class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 rounded border border-blue-300 hover:bg-blue-50">
              復元
            </button>
          </td>
        </tr>
      `;
    }).join('');
    
  } catch (error) {
    logWarn('履歴テーブルの更新に失敗:', error);
  }
}

// HTMLエスケープはSharedUtilities.htmlで定義されています

// 初期化時に履歴テーブルを更新
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(updateHistoryTable, 100);
});

// =============================================================================
// 互換性レイヤー - 複雑な履歴システムとの互換性を維持
// =============================================================================

// 互換性関数: loadSimpleHistoryTable
if (typeof loadSimpleHistoryTable === 'undefined') {
  window.loadSimpleHistoryTable = function() {
    if (typeof updateHistoryTable === 'function') {
      updateHistoryTable();
    } else {
      console.warn('⚠️ updateHistoryTable関数が利用できません');
    }
  };
}

// 互換性関数: getHistoryFromStorage（レガシー）
if (typeof getHistoryFromStorage === 'undefined') {
  window.getHistoryFromStorage = function() {
    return getSimpleHistory();
  };
}

// 互換性関数: saveHistoryToStorage（レガシー）
if (typeof saveHistoryToStorage === 'undefined') {
  window.saveHistoryToStorage = function(historyArray) {
    saveSimpleHistory(historyArray);
  };
}

// 互換性関数: saveToHistory（レガシー）
if (typeof saveToHistory === 'undefined') {
  window.saveToHistory = function(historyItem) {
    addToSimpleHistory(historyItem);
  };
}

// HistoryManager の互換レイヤー
if (!window.HistoryManager) {
  window.HistoryManager = {
    renderTable: function() {
      if (typeof updateHistoryTable === 'function') {
        updateHistoryTable();
      }
      return true;
    },
    addToHistory: function(item) {
      if (typeof addToSimpleHistory === 'function') {
        addToSimpleHistory(item);
      }
    },
    _initialized: true
  };
}

console.log('✅ 履歴システム（互換性レイヤー含む）初期化完了');

</script>