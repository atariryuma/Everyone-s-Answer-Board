<script>
  // Login Page JavaScript

  let googleAccountsClient;
  let isLoading = false;
  let redirectUrl = '/exec';
  let currentUserEmail = '';

  // Initialize login page
  function initializeLoginPage() {
    // Enhanced error handling for document.write issues compatible with Google libraries
    if (typeof document !== 'undefined' && document.write) {
      // Only override if not already overridden in LoginPage.html
      if (!window._originalDocumentWrite) {
        const originalDocWrite = document.write;
        const originalDocWriteln = document.writeln;
        
        document.write = function(...args) {
          try {
            console.warn('document.write called in login.js.html - args:', args);
            return undefined;
          } catch (e) {
            console.error('document.write error caught:', e);
            return undefined;
          }
        };
        
        document.writeln = function(...args) {
          try {
            console.warn('document.writeln called in login.js.html - args:', args);
            return undefined;
          } catch (e) {
            console.error('document.writeln error caught:', e);
            return undefined;
          }
        };
        
        window._originalDocumentWrite = originalDocWrite;
        window._originalDocumentWriteln = originalDocWriteln;
      }
    }

    setLoading(true, 'Googleアカウントの情報を確認しています...');

    // Check if client ID is available
    if (!window.GOOGLE_CLIENT_ID || window.GOOGLE_CLIENT_ID.trim() === '') {
      setLoading(false, 'Google Client IDが設定されていません');
      return;
    }

    // Wait for Google Identity Services and Google APIs to load with enhanced error handling
    let attempts = 0;
    const maxAttempts = 100; // 10 seconds timeout
    let retryCount = 0;
    const maxRetries = 3;

    const checkGoogleAPI = setInterval(() => {
      attempts++;
      
      try {
        if (attempts > maxAttempts) {
          clearInterval(checkGoogleAPI);
          
          if (retryCount < maxRetries) {
            retryCount++;
            console.warn(`Google API loading attempt ${retryCount}/${maxRetries} - retrying...`);
            
            // Retry by reloading the scripts
            setTimeout(() => {
              attempts = 0;
              reloadGoogleScripts();
            }, 2000);
          } else {
            setLoading(false, 'Google APIの読み込みがタイムアウトしました');
            showGoogleLoadingFallback();
          }
          return;
        }

        // Check for Google APIs availability with detailed logging
        const googleAvailable = typeof google !== 'undefined';
        const accountsAvailable = googleAvailable && google.accounts;
        const gapiAvailable = typeof gapi !== 'undefined';
        
        if (attempts % 10 === 0) { // Log every second
          console.log(`Google API loading status (attempt ${attempts}):`, {
            google: googleAvailable,
            accounts: accountsAvailable,
            gapi: gapiAvailable
          });
        }

        if (googleAvailable && accountsAvailable && gapiAvailable) {
          clearInterval(checkGoogleAPI);
          initializeGoogleAuth();
        }
      } catch (error) {
        console.error('Error checking Google API availability:', error);
        clearInterval(checkGoogleAPI);
        setLoading(false, 'Google APIの初期化でエラーが発生しました');
      }
    }, 100);
  }

  // Helper function to reload Google scripts
  function reloadGoogleScripts() {
    try {
      // Remove existing scripts
      const existingGoogleScripts = document.querySelectorAll('script[src*="google"]');
      existingGoogleScripts.forEach(script => {
        if (script.src.includes('gsi/client') || script.src.includes('apis.google.com')) {
          script.remove();
        }
      });
      
      // Add fresh scripts
      const gsiScript = document.createElement('script');
      gsiScript.src = 'https://accounts.google.com/gsi/client';
      gsiScript.async = true;
      gsiScript.defer = true;
      document.head.appendChild(gsiScript);
      
      const gapiScript = document.createElement('script');
      gapiScript.src = 'https://apis.google.com/js/api.js';
      gapiScript.async = true;
      gapiScript.defer = true;
      document.head.appendChild(gapiScript);
      
      console.log('Google scripts reloaded');
    } catch (error) {
      console.error('Error reloading Google scripts:', error);
    }
  }

  // Show fallback UI when Google libraries fail to load
  function showGoogleLoadingFallback() {
    const userEmailDisplay = document.getElementById('user-email-display');
    const loginBtn = document.getElementById('login-btn');
    
    if (userEmailDisplay) {
      userEmailDisplay.textContent = 'Google認証の読み込みに失敗しました';
    }
    
    if (loginBtn) {
      loginBtn.innerHTML = 'ページを再読み込みしてください';
      loginBtn.onclick = () => window.location.reload();
      loginBtn.disabled = false;
    }
  }

  // Initialize Google OAuth client
  function initializeGoogleAuth() {
    try {
      // Initialize Google API client
      gapi.load('client', () => {
        gapi.client.init({
          apiKey: '',
          discoveryDocs: []
        });
      });

      googleAccountsClient = google.accounts.oauth2.initTokenClient({
        client_id: window.GOOGLE_CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
        callback: handleCredentialResponse,
      });

      // Get server-side domain information
      getServerSideInfo();
    } catch (error) {
      console.error('Google Auth initialization error:', error);
      setLoading(false, 'Google認証の初期化に失敗しました');
    }
  }

  // Get server-side domain information
  function getServerSideInfo() {
    google.script.run
      .withSuccessHandler(serverInfo => {
        // Display organization information
        displayOrganizationInfo(serverInfo);

        // Check if user is already authenticated
        const token = gapi.client.getToken();
        if (token) {
          updateUserInfo(token.access_token, serverInfo);
        } else {
          // User needs to login
          setLoading(false, '認証が必要です');
          requestUserLogin();
        }
      })
      .withFailureHandler(handleError)
      .getSystemDomainInfo();
  }

  // Update user information display
  function updateUserInfo(accessToken, serverInfo) {
    fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${accessToken}`)
      .then(response => response.json())
      .then(userInfo => {
        if (userInfo.email) {
          currentUserEmail = userInfo.email;
          document.getElementById('user-email-display').textContent = userInfo.email;

          const userDomain = userInfo.email.split('@')[1];
          const isAdminDomain = userDomain === serverInfo.adminDomain;

          displayDomainStatus(isAdminDomain, serverInfo.adminDomain);

          document.getElementById('login-btn').disabled = false;

          verifyAuthentication();
        } else {
          throw new Error('ユーザー情報の取得に失敗しました');
        }
      })
      .catch(error => {
        console.error('User info fetch error:', error);
        handleError(error);
      });
  }

  // Display organization information
  function displayOrganizationInfo(serverInfo) {
    if (serverInfo && serverInfo.adminDomain) {
      const orgInfoEl = document.getElementById('organization-info');
      const orgNameEl = document.getElementById('organization-name');

      // Extract organization name from domain
      const domainParts = serverInfo.adminDomain.split('.');
      const orgName = domainParts[0].charAt(0).toUpperCase() + domainParts[0].slice(1);

      orgNameEl.textContent = orgName;
      orgInfoEl.classList.remove('hidden');
    }
  }

  // Display domain status badge
  function displayDomainStatus(isMatch, adminDomain) {
    const badgeEl = document.getElementById('domain-status-badge');
    const badgeClass = isMatch ? 'match' : 'mismatch';
    const icon = isMatch ?
      '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
      '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>';

    const text = isMatch ?
      `${adminDomain} ドメインに所属` :
      `管理ドメイン(${adminDomain})と不一致`;

    badgeEl.innerHTML = `
      <div class="domain-badge ${badgeClass}">
        ${icon}
        <span>${text}</span>
      </div>
    `;
    badgeEl.classList.remove('hidden');
  }

  // Verify authentication with server
  function verifyAuthentication() {
    if (window.sharedUtilities && window.sharedUtilities.auth) {
      window.sharedUtilities.auth.verifyAuthentication()
        .then(fetchExistingBoard)
        .catch(handleError);
    } else {
      fetchExistingBoard();
    }
  }

  // Register account on server for new users
  function registerAccount() {
    google.script.run
      .withSuccessHandler(res => {
        if (res && res.adminUrl) {
          redirectUrl = res.adminUrl;
        }
        setLoading(false);
      })
      .withFailureHandler(handleError)
      .registerNewUser(currentUserEmail);
  }

  // Retrieve existing board info from server
  function fetchExistingBoard() {
    google.script.run
      .withSuccessHandler(result => {
        if (!result) return;

        if (result.status === 'existing_user') {
          redirectUrl = result.adminUrl;
          setLoading(false);
        } else if (result.status === 'setup_required') {
          redirectUrl = `/exec?mode=admin&userId=${result.userId}`;
          setLoading(false);
        } else if (result.status === 'new_user') {
          registerAccount();
        } else {
          console.error('Unexpected getExistingBoard result:', result);
          setLoading(false);
        }
      })
      .withFailureHandler(error => {
        console.error('getExistingBoard error:', error);
        handleError(error);
      })
      .getExistingBoard();
  }

  // Request user login
  function requestUserLogin() {
    if (googleAccountsClient) {
      googleAccountsClient.requestAccessToken({ prompt: 'consent' });
    } else {
      handleError(new Error('Google認証クライアントが初期化されていません'));
    }
  }

  // Handle credential response
  function handleCredentialResponse(response) {
    if (response.error) {
      console.error('Authentication error:', response.error);
      handleError(response);
      return;
    }

    // Refresh server-side info after successful authentication
    getServerSideInfo();
  }

  // Set loading state with improved UX
  function setLoading(loading, message = '') {
    isLoading = loading;
    const loginBtn = document.getElementById('login-btn');
    const userEmailDisplay = document.getElementById('user-email-display');

    if (loading) {
      loginBtn.disabled = true;
      loginBtn.innerHTML = `
        <div class="spinner"></div>
        ${message || 'ログイン中...'}
      `;
      loginBtn.style.cursor = 'not-allowed';
      userEmailDisplay.textContent = message || '認証中...';
    } else {
      loginBtn.disabled = false;
      loginBtn.innerHTML = 'ログイン';
      loginBtn.style.cursor = 'pointer';
      if (!message) {
        userEmailDisplay.textContent = '-';
      }
    }
  }

  // Handle errors
  function handleError(error) {
    console.error('Login error:', error);
    setLoading(false);

    const userEmailDisplay = document.getElementById('user-email-display');
    const loginBtn = document.getElementById('login-btn');

    // Determine error type and show appropriate message
    let errorMessage = 'エラーが発生しました';
    if (error && error.message) {
      if (error.message.includes('network') || error.message.includes('Network')) {
        errorMessage = 'ネットワークエラー';
      } else if (error.message.includes('auth') || error.message.includes('Auth')) {
        errorMessage = '認証エラー';
      } else if (error.message.includes('timeout') || error.message.includes('Timeout')) {
        errorMessage = 'タイムアウト';
      }
    }

    userEmailDisplay.textContent = errorMessage;

    // Show retry button
    loginBtn.innerHTML = 'エラー - 再試行';
    loginBtn.disabled = false;

    // Reset after 5 seconds
    setTimeout(() => {
      loginBtn.innerHTML = 'ログイン';
      userEmailDisplay.textContent = '-';
      // Retry initialization
      initializeLoginPage();
    }, 5000);
  }

  // Account switching
  function switchAccount() {
    if (googleAccountsClient) {
      setLoading(true, 'アカウントを切り替えています...');
      googleAccountsClient.requestAccessToken({ prompt: 'select_account' });
    }
  }

  // Login button handler with improved flow
  function handleLogin() {
    if (isLoading) return;

    const userEmail = document.getElementById('user-email-display').textContent;
    if (userEmail && userEmail !== '-' && userEmail !== 'エラーが発生しました') {
      setLoading(true, '管理パネルにリダイレクトしています...');

      // Add a small delay for better UX
      setTimeout(() => {
        // Redirect to admin panel or setup page
        window.location.href = redirectUrl;
      }, 500);
    } else {
      // Request authentication
      setLoading(true, 'Googleアカウントでログインしています...');
      requestUserLogin();
    }
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    initializeLoginPage();

    // Add event listeners
    document.getElementById('login-btn').addEventListener('click', handleLogin);
    document.getElementById('switch-account-link').addEventListener('click', (e) => {
      e.preventDefault();
      switchAccount();
    });

    // Add keyboard support
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !document.getElementById('login-btn').disabled) {
        handleLogin();
      }
    });
  });

  // Handle focus management for accessibility
  document.addEventListener('focusin', (e) => {
    if (e.target.classList.contains('login-btn')) {
      e.target.style.boxShadow = '0 0 0 2px #3b82f6';
    }
  });

  document.addEventListener('focusout', (e) => {
    if (e.target.classList.contains('login-btn')) {
      e.target.style.boxShadow = '';
    }
  });
</script>
