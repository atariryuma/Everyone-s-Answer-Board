<script>
  // Login Page JavaScript
  console.log('ğŸ”¥ LOGIN.JS.HTML STARTING TO LOAD');

  let googleAccountsClient;
  let isLoading = false;
  let redirectUrl = '/exec';
  let currentUserEmail = '';

  // Initialize login page - sequenced flow
  function initializeLoginPage() {
    console.log('ğŸš€ Initializing login page...');
    setLoading(true, 'ã‚·ã‚¹ãƒ†ãƒ ã‚’æº–å‚™ã—ã¦ã„ã¾ã™...');

    // Sequenced initialization: Google Services â†’ ClientID â†’ Login
    initializeLoginSequence()
      .then(() => {
        console.log('âœ… Login system fully initialized');
        window.loginSystemReady = true;
      })
      .catch(error => {
        console.error('âŒ Login initialization failed:', error);
        handleInitializationError(error);
      });
  }

  // Sequenced initialization function
  function initializeLoginSequence() {
    return new Promise((resolve, reject) => {
      console.log('ğŸ”„ Step 0: Checking system configuration...');
      setLoading(true, 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ç¢ºèªä¸­...');
      
      // Step 0: Check system configuration
      checkSystemConfigurationFromClient()
        .then((configResult) => {
          console.log('âœ… Step 0 complete: System configuration checked');
          
          if (!configResult.isFullyConfigured) {
            console.warn('âš ï¸ System is not fully configured. Missing:', configResult.missingProperties);
            setLoading(false, 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãŒä¸å®Œå…¨ã§ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚');
            showConfigurationError(configResult);
            return reject(new Error('System configuration incomplete'));
          }
          
          console.log('ğŸ”„ Step 1: Waiting for Google APIs...');
          setLoading(true, 'Google APIã‚’èª­ã¿è¾¼ã¿ä¸­...');
          
          // Step 1: Wait for Google APIs to load
          return waitForGoogleAPIs();
        })
        .then(() => {
          console.log('âœ… Step 1 complete: Google APIs loaded');
          console.log('ğŸ”„ Step 2: Getting GOOGLE_CLIENT_ID...');
          setLoading(true, 'Google Client IDã‚’å–å¾—ä¸­...');
          
          // Step 2: Get GOOGLE_CLIENT_ID from server
          return getGoogleClientIdFromServer();
        })
        .then((clientId) => {
          console.log('âœ… Step 2 complete: GOOGLE_CLIENT_ID obtained:', clientId);
          console.log('ğŸ”„ Step 3: Initializing Google Auth...');
          setLoading(true, 'Googleèªè¨¼ã‚’åˆæœŸåŒ–ä¸­...');
          
          // Step 3: Initialize Google Auth
          return initializeGoogleAuth();
        })
        .then(() => {
          console.log('âœ… Step 3 complete: Google Auth initialized');
          console.log('ğŸ”„ Step 4: Starting login flow...');
          setLoading(true, 'ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ä¸­...');
          
          // Step 4: Start login flow
          return startLoginFlow();
        })
        .then(() => {
          console.log('âœ… Step 4 complete: Login flow started');
          resolve();
        })
        .catch(error => {
          console.error('âŒ Initialization sequence failed:', error);
          reject(error);
        });
    });
  }

  // Show configuration error to user
  function showConfigurationError(configResult) {
    const userEmailDisplay = document.getElementById('user-email-display');
    const loginBtn = document.getElementById('login-btn');
    
    if (userEmailDisplay) {
      userEmailDisplay.innerHTML = `
        <div style="color: #ef4444; font-size: 14px;">
          <strong>ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚¨ãƒ©ãƒ¼</strong><br>
          ä¸è¶³ã—ã¦ã„ã‚‹è¨­å®š: ${configResult.missingProperties.join(', ')}<br>
          <small>ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„</small>
        </div>
      `;
    }
    
    if (loginBtn) {
      loginBtn.innerHTML = 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ç¢ºèª';
      loginBtn.disabled = true;
      loginBtn.style.backgroundColor = '#6b7280';
      loginBtn.style.cursor = 'not-allowed';
    }
  }

  // Wait for Google APIs to load with Promise-based approach
  function waitForGoogleAPIs() {
    return new Promise((resolve, reject) => {
      let attempts = 0;
      const maxAttempts = 50; // 5 seconds timeout
      
      const checkAPIs = () => {
        attempts++;
        
        const googleAvailable = typeof google !== 'undefined';
        const accountsAvailable = googleAvailable && google.accounts;
        const gapiAvailable = typeof gapi !== 'undefined';
        
        if (googleAvailable && accountsAvailable && gapiAvailable) {
          resolve();
          return;
        }
        
        if (attempts >= maxAttempts) {
          reject(new Error('Google APIs failed to load within timeout'));
          return;
        }
        
        setTimeout(checkAPIs, 100);
      };
      
      checkAPIs();
    });
  }

  // Handle initialization errors
  function handleInitializationError(error) {
    console.error('Login initialization error:', error);
    
    let errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ';
    let isRetriable = true;
    
    if (error.message.includes('timeout')) {
      errorMessage = 'Google APIã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ';
    } else if (error.message.includes('network')) {
      errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    } else if (error.message.includes('GOOGLE_CLIENT_ID')) {
      errorMessage = 'Google Client IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
      isRetriable = false;
    } else if (error.message.includes('System configuration incomplete')) {
      errorMessage = 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãŒä¸å®Œå…¨ã§ã™';
      isRetriable = false;
    }
    
    setLoading(false, errorMessage);
    
    if (isRetriable) {
      showRetryButton();
    } else {
      showConfigurationButton();
    }
  }

  // Show configuration button for non-retriable errors
  function showConfigurationButton() {
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
      loginBtn.innerHTML = 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ç¢ºèª';
      loginBtn.disabled = false;
      loginBtn.onclick = () => {
        checkSystemConfigurationFromClient()
          .then((result) => {
            showDetailedConfigurationInfo(result);
          })
          .catch((error) => {
            console.error('Configuration check failed:', error);
            alert('è¨­å®šç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          });
      };
    }
  }

  // Show detailed configuration information
  function showDetailedConfigurationInfo(configResult) {
    const userEmailDisplay = document.getElementById('user-email-display');
    
    if (userEmailDisplay) {
      let statusHtml = '<div style="font-size: 14px; line-height: 1.4;">';
      statusHtml += '<strong>ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ è¨­å®šçŠ¶æ³</strong><br>';
      statusHtml += `<span style="color: ${configResult.isFullyConfigured ? '#10b981' : '#ef4444'};">`;
      statusHtml += configResult.isFullyConfigured ? 'âœ… è¨­å®šå®Œäº†' : 'âŒ è¨­å®šä¸å®Œå…¨';
      statusHtml += '</span><br><br>';
      
      if (configResult.missingProperties && configResult.missingProperties.length > 0) {
        statusHtml += '<strong>ä¸è¶³ã—ã¦ã„ã‚‹è¨­å®š:</strong><br>';
        configResult.missingProperties.forEach(prop => {
          statusHtml += `â€¢ ${prop}<br>`;
        });
        statusHtml += '<br>';
      }
      
      statusHtml += '<strong>è¨­å®šæ‰‹é †:</strong><br>';
      statusHtml += '1. Google Apps Script ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’é–‹ã<br>';
      statusHtml += '2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š > ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£<br>';
      statusHtml += '3. ä¸è¶³ã—ã¦ã„ã‚‹é …ç›®ã‚’è¿½åŠ <br>';
      statusHtml += '</div>';
      
      userEmailDisplay.innerHTML = statusHtml;
    }
  }

  // Show retry button for failed initialization
  function showRetryButton() {
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
      loginBtn.innerHTML = 'å†è©¦è¡Œ';
      loginBtn.disabled = false;
      loginBtn.onclick = () => {
        loginBtn.onclick = null; // Remove retry handler
        initializeLoginPage(); // Retry initialization
      };
    }
  }

  // Helper function to reload Google scripts
  function reloadGoogleScripts() {
    try {
      // Remove existing scripts
      const existingGoogleScripts = document.querySelectorAll('script[src*="google"]');
      existingGoogleScripts.forEach(script => {
        if (script.src.includes('gsi/client') || script.src.includes('apis.google.com')) {
          script.remove();
        }
      });
      
      // Add fresh scripts
      const gsiScript = document.createElement('script');
      gsiScript.src = 'https://accounts.google.com/gsi/client';
      gsiScript.async = true;
      gsiScript.defer = true;
      document.head.appendChild(gsiScript);
      
      const gapiScript = document.createElement('script');
      gapiScript.src = 'https://apis.google.com/js/api.js';
      gapiScript.async = true;
      gapiScript.defer = true;
      document.head.appendChild(gapiScript);
      
      console.log('Google scripts reloaded');
    } catch (error) {
      console.error('Error reloading Google scripts:', error);
    }
  }

  // Show fallback UI when Google libraries fail to load
  function showGoogleLoadingFallback() {
    const userEmailDisplay = document.getElementById('user-email-display');
    const loginBtn = document.getElementById('login-btn');
    
    if (userEmailDisplay) {
      userEmailDisplay.textContent = 'Googleèªè¨¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
    }
    
    if (loginBtn) {
      loginBtn.innerHTML = 'ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„';
      loginBtn.onclick = () => window.location.reload();
      loginBtn.disabled = false;
    }
  }

  // Initialize Google OAuth client - improved version
  function initializeGoogleAuth() {
    return new Promise((resolve, reject) => {
      try {
        console.log('ğŸ”§ Initializing Google OAuth client...');
        
        // Initialize Google API client
        gapi.load('client', () => {
          gapi.client.init({
            apiKey: '',
            discoveryDocs: []
          }).then(() => {
            console.log('âœ… GAPI client initialized');
          }).catch(error => {
            console.warn('âš ï¸ GAPI client init failed:', error);
            // Continue even if GAPI init fails
          });
        });

        // Initialize OAuth client
        googleAccountsClient = google.accounts.oauth2.initTokenClient({
          client_id: window.GOOGLE_CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
          callback: handleCredentialResponse,
        });

        if (googleAccountsClient) {
          console.log('âœ… Google OAuth client initialized');
          resolve();
        } else {
          throw new Error('Failed to initialize OAuth client');
        }
      } catch (error) {
        console.error('âŒ Google Auth initialization error:', error);
        reject(error);
      }
    });
  }

  // Start the login flow - new simplified approach
  function startLoginFlow() {
    return new Promise((resolve, reject) => {
      console.log('ğŸ”„ Starting login flow...');
      
      // Get server-side domain information
      setLoading(true, 'ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...');
      
      getServerSideInfo()
        .then(serverInfo => {
          console.log('âœ… Server info retrieved:', serverInfo);
          
          // Check if user is already authenticated
          const token = gapi.client.getToken();
          if (token && token.access_token) {
            console.log('âœ… User already has token');
            return updateUserInfo(token.access_token, serverInfo);
          } else {
            console.log('â„¹ï¸ User needs to authenticate');
            setLoading(false, 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
            enableLoginButton();
            return Promise.resolve();
          }
        })
        .then(() => {
          resolve();
        })
        .catch(error => {
          console.error('âŒ Login flow failed:', error);
          reject(error);
        });
    });
  }

  // Show welcome message for new users
  function showWelcomeMessage() {
    const userEmailDisplay = document.getElementById('user-email-display');
    
    if (userEmailDisplay) {
      userEmailDisplay.innerHTML = `
        <div style="color: #10b981; font-size: 14px; line-height: 1.4;">
          <strong>ğŸ‰ ã‚ˆã†ã“ã StudyQuest ã¸ï¼</strong><br>
          <span style="color: #6b7280; font-size: 12px;">
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚<br>
            æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚
          </span>
        </div>
      `;
    }
  }

  // Show existing user welcome message
  function showExistingUserMessage() {
    const userEmailDisplay = document.getElementById('user-email-display');
    
    if (userEmailDisplay) {
      userEmailDisplay.innerHTML = `
        <div style="color: #3b82f6; font-size: 14px; line-height: 1.4;">
          <strong>ğŸš€ ãŠã‹ãˆã‚Šãªã•ã„ï¼</strong><br>
          <span style="color: #6b7280; font-size: 12px;">
            ${currentUserEmail}<br>
            ç®¡ç†ãƒ‘ãƒãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
          </span>
        </div>
      `;
    }
  }

  // Enable login button for user interaction
  function enableLoginButton() {
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
      loginBtn.disabled = false;
      
      // Change button text based on user status
      if (currentUserEmail && redirectUrl && redirectUrl !== '/exec') {
        loginBtn.innerHTML = 'ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã';
      } else {
        loginBtn.innerHTML = 'Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã¯ã˜ã‚ã‚‹';
      }
      
      loginBtn.onclick = handleLogin;
    }
  }

  // Get server-side domain information - Promise-based
  function getServerSideInfo() {
    return new Promise((resolve, reject) => {
      console.log('ğŸ”„ Getting server-side domain info...');
      
      // Check if google.script.run is available
      if (!google || !google.script || !google.script.run) {
        console.error('âŒ Google Apps Script runtime not available');
        reject(new Error('Google Apps Script runtime not available'));
        return;
      }
      
      google.script.run
        .withSuccessHandler(serverInfo => {
          console.log('âœ… Server info received:', serverInfo);
          console.log('ğŸ” Server info details:', JSON.stringify(serverInfo, null, 2));
          
          if (serverInfo && serverInfo.error) {
            console.error('âŒ Server returned error:', serverInfo.error);
            reject(new Error(serverInfo.error));
            return;
          }
          
          // Display organization information
          displayOrganizationInfo(serverInfo);
          resolve(serverInfo);
        })
        .withFailureHandler(error => {
          console.error('âŒ Failed to get server info:', error);
          console.error('âŒ Error details:', JSON.stringify(error, null, 2));
          reject(error);
        })
        .getSystemDomainInfo();
    });
  }

  // Update user information display - Promise-based
  function updateUserInfo(accessToken, serverInfo) {
    return new Promise((resolve, reject) => {
      console.log('ğŸ”„ Getting user info with access token...');
      
      setLoading(true, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...');
      
      fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${accessToken}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(userInfo => {
          console.log('âœ… User info received:', userInfo);
          
          if (!userInfo.email) {
            throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
          }
          
          currentUserEmail = userInfo.email;
          document.getElementById('user-email-display').textContent = userInfo.email;

          const userDomain = userInfo.email.split('@')[1];
          const isAdminDomain = userDomain === serverInfo.adminDomain;

          displayDomainStatus(isAdminDomain, serverInfo.adminDomain);

          // Continue with authentication verification
          return verifyAuthentication();
        })
        .then(() => {
          console.log('âœ… User info updated successfully');
          resolve();
        })
        .catch(error => {
          console.error('âŒ User info update failed:', error);
          reject(error);
        });
    });
  }

  // Display organization information
  function displayOrganizationInfo(serverInfo) {
    console.log('ğŸ¢ Attempting to display organization info:', serverInfo);
    
    if (!serverInfo) {
      console.warn('âš ï¸ Server info is null or undefined');
      return;
    }
    
    if (!serverInfo.adminDomain) {
      console.warn('âš ï¸ No admin domain in server info');
      return;
    }
    
    const orgInfoEl = document.getElementById('organization-info');
    const orgNameEl = document.getElementById('organization-name');

    if (!orgInfoEl || !orgNameEl) {
      console.error('âŒ Organization display elements not found in DOM');
      return;
    }

    try {
      // Extract organization name from domain
      const domainParts = serverInfo.adminDomain.split('.');
      const orgName = domainParts[0].charAt(0).toUpperCase() + domainParts[0].slice(1);

      console.log('ğŸ¢ Setting organization name:', orgName);
      orgNameEl.textContent = orgName;
      orgInfoEl.classList.remove('hidden');
      
      console.log('âœ… Organization info displayed successfully');
    } catch (error) {
      console.error('âŒ Error displaying organization info:', error);
    }
  }

  // Display domain status badge
  function displayDomainStatus(isMatch, adminDomain) {
    const badgeEl = document.getElementById('domain-status-badge');
    const badgeClass = isMatch ? 'match' : 'mismatch';
    const icon = isMatch ?
      '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
      '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>';

    const text = isMatch ?
      `${adminDomain} ãƒ‰ãƒ¡ã‚¤ãƒ³ã«æ‰€å±` :
      `ç®¡ç†ãƒ‰ãƒ¡ã‚¤ãƒ³(${adminDomain})ã¨ä¸ä¸€è‡´`;

    badgeEl.innerHTML = `
      <div class="domain-badge ${badgeClass}">
        ${icon}
        <span>${text}</span>
      </div>
    `;
    badgeEl.classList.remove('hidden');
  }

  // Verify authentication with server - Promise-based
  function verifyAuthentication() {
    return new Promise((resolve, reject) => {
      console.log('ğŸ”„ Verifying authentication...');
      
      // Skip shared utilities auth check and go directly to board check
      fetchExistingBoard()
        .then(result => {
          console.log('âœ… Authentication verified');
          resolve(result);
        })
        .catch(error => {
          console.error('âŒ Authentication verification failed:', error);
          reject(error);
        });
    });
  }

  // Register account on server for new users - Promise-based
  function registerAccount() {
    return new Promise((resolve, reject) => {
      console.log('ğŸ”„ Registering new user:', currentUserEmail);
      
      setLoading(true, 'åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è¡Œã£ã¦ã„ã¾ã™...');
      
      google.script.run
        .withSuccessHandler(res => {
          console.log('âœ… User registered successfully:', res);
          
          if (res && res.adminUrl) {
            redirectUrl = res.adminUrl;
            showWelcomeMessage();
            setLoading(false, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
            enableLoginButton();
          } else {
            setLoading(false, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã¯å®Œäº†ã—ã¾ã—ãŸãŒã€ç®¡ç†URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            enableLoginButton();
          }
          
          resolve(res);
        })
        .withFailureHandler(error => {
          console.error('âŒ User registration failed:', error);
          reject(error);
        })
        .registerNewUser(currentUserEmail);
    });
  }

  // Retrieve existing board info from server - Promise-based
  function fetchExistingBoard() {
    return new Promise((resolve, reject) => {
      console.log('ğŸ”„ Fetching existing board info...');
      
      setLoading(true, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...');
      
      google.script.run
        .withSuccessHandler(result => {
          console.log('âœ… Board info received:', result);
          
          if (!result) {
            console.error('âŒ No result returned from getExistingBoard');
            reject(new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ'));
            return;
          }

          if (result.status === 'existing_user') {
            console.log('âœ… Existing user found, redirecting to admin panel');
            redirectUrl = result.adminUrl;
            showExistingUserMessage();
            setLoading(false, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ');
            enableLoginButton();
            resolve(result);
          } else if (result.status === 'setup_required') {
            console.log('â„¹ï¸ Setup required for user');
            redirectUrl = `/exec?mode=admin&userId=${result.userId}`;
            setLoading(false, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã™');
            enableLoginButton();
            resolve(result);
          } else if (result.status === 'new_user') {
            console.log('â„¹ï¸ New user, registering account');
            registerAccount()
              .then(resolve)
              .catch(reject);
          } else {
            console.error('âŒ Unexpected getExistingBoard result:', result);
            reject(new Error('äºˆæœŸã—ãªã„ã‚µãƒ¼ãƒãƒ¼å¿œç­”: ' + result.status));
          }
        })
        .withFailureHandler(error => {
          console.error('âŒ getExistingBoard failed:', error);
          reject(error);
        })
        .getExistingBoard();
    });
  }

  // Request user login
  function requestUserLogin() {
    if (googleAccountsClient) {
      googleAccountsClient.requestAccessToken({ prompt: 'consent' });
    } else {
      handleError(new Error('Googleèªè¨¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“'));
    }
  }

  // Handle credential response
  function handleCredentialResponse(response) {
    if (response.error) {
      console.error('âŒ Authentication error:', response.error);
      handleError(response);
      return;
    }

    console.log('âœ… Authentication successful');

    // Store access token for gapi client usage
    if (response.access_token && gapi && gapi.client) {
      gapi.client.setToken({ access_token: response.access_token });
    }

    // Restart the login flow after successful authentication
    setLoading(true, 'èªè¨¼ãŒæˆåŠŸã—ã¾ã—ãŸã€‚æƒ…å ±ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...');
    
    startLoginFlow()
      .then(() => {
        console.log('âœ… Login flow completed after authentication');
      })
      .catch(error => {
        console.error('âŒ Login flow failed after authentication:', error);
        handleError(error);
      });
  }

  // Set loading state with improved UX
  function setLoading(loading, message = '') {
    isLoading = loading;
    const loginBtn = document.getElementById('login-btn');
    const userEmailDisplay = document.getElementById('user-email-display');

    if (loading) {
      loginBtn.disabled = true;
      loginBtn.innerHTML = `
        <div class="spinner"></div>
        ${message || 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...'}
      `;
      loginBtn.style.cursor = 'not-allowed';
      userEmailDisplay.textContent = message || 'èªè¨¼ä¸­...';
    } else {
      loginBtn.disabled = false;
      loginBtn.innerHTML = 'ã¯ã˜ã‚ã‚‹';
      loginBtn.style.cursor = 'pointer';
      if (!message) {
        userEmailDisplay.textContent = '-';
      }
    }
  }

  // Handle errors - enhanced version
  function handleError(error) {
    console.error('âŒ Login error:', error);
    setLoading(false);

    const userEmailDisplay = document.getElementById('user-email-display');
    const loginBtn = document.getElementById('login-btn');

    // Determine error type and show appropriate message
    let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    let isRetriable = true;
    
    if (error && error.message) {
      if (error.message.includes('network') || error.message.includes('Network')) {
        errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ - æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
      } else if (error.message.includes('auth') || error.message.includes('Auth')) {
        errorMessage = 'èªè¨¼ã‚¨ãƒ©ãƒ¼ - å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
      } else if (error.message.includes('timeout') || error.message.includes('Timeout')) {
        errorMessage = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - å†è©¦è¡Œã—ã¦ãã ã•ã„';
      } else if (error.message.includes('Client ID')) {
        errorMessage = 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚¨ãƒ©ãƒ¼ - ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„';
        isRetriable = false;
      } else if (error.message.includes('Domain')) {
        errorMessage = 'ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼ - è¨±å¯ã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„';
        isRetriable = false;
      } else {
        errorMessage = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      }
    }

    if (userEmailDisplay) {
      userEmailDisplay.textContent = errorMessage;
    }

    // Show appropriate button based on error type
    if (loginBtn) {
      if (isRetriable) {
        loginBtn.innerHTML = 'å†è©¦è¡Œ';
        loginBtn.disabled = false;
        loginBtn.onclick = () => {
          loginBtn.onclick = null;
          initializeLoginPage();
        };
      } else {
        loginBtn.innerHTML = 'ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿';
        loginBtn.disabled = false;
        loginBtn.onclick = () => {
          window.location.reload();
        };
      }
    }

    // Auto-retry for network errors after 10 seconds
    if (isRetriable && error && error.message && error.message.includes('network')) {
      setTimeout(() => {
        console.log('ğŸ”„ Auto-retrying after network error...');
        initializeLoginPage();
      }, 10000);
    }
  }

  // Account switching
  function switchAccount() {
    if (googleAccountsClient) {
      setLoading(true, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ã¾ã™...');
      googleAccountsClient.requestAccessToken({ prompt: 'select_account' });
    }
  }

  // Login button handler with improved flow
  function handleLogin() {
    if (isLoading) {
      console.log('â³ Login already in progress, ignoring click');
      return;
    }

    const userEmail = document.getElementById('user-email-display').textContent;
    
    // Check if user is already authenticated and ready to proceed
    if (currentUserEmail && redirectUrl && redirectUrl !== '/exec') {
      console.log('âœ… User authenticated, redirecting to:', redirectUrl);
      setLoading(true, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™...');

      // Add a small delay for better UX
      setTimeout(() => {
        window.location.href = redirectUrl;
      }, 500);
    } else {
      // Request authentication
      console.log('ğŸ”„ Starting authentication process...');
      setLoading(true, 'Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ã„ã¾ã™...');
      requestUserLogin();
    }
  }

  // Simple and reliable initialization
  console.log('ğŸ“¦ Login.js loaded successfully');
  
  function initializeLoginSystem() {
    console.log('ğŸš€ Initializing login system...');
    
    const loginBtn = document.getElementById('login-btn');
    const switchAccountLink = document.getElementById('switch-account-link');
    
    if (!loginBtn || !switchAccountLink) {
      console.error('âŒ Required elements not found, retrying in 500ms...');
      setTimeout(initializeLoginSystem, 500);
      return;
    }
    
    console.log('âœ… All required elements found');
    
    // Initialize the login page
    initializeLoginPage();
    
    // Add event listeners
    loginBtn.addEventListener('click', handleLogin);
    switchAccountLink.addEventListener('click', (e) => {
      e.preventDefault();
      switchAccount();
    });
    
    // Add keyboard support
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !loginBtn.disabled) {
        handleLogin();
      }
    });
    
    console.log('âœ… Login system initialized successfully');
  }

  // Start initialization as soon as possible
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeLoginSystem);
  } else {
    initializeLoginSystem();
  }

  // Handle focus management for accessibility
  document.addEventListener('focusin', (e) => {
    if (e.target.classList.contains('login-btn')) {
      e.target.style.boxShadow = '0 0 0 2px #3b82f6';
    }
  });

  document.addEventListener('focusout', (e) => {
    if (e.target.classList.contains('login-btn')) {
      e.target.style.boxShadow = '';
    }
  });
</script>
