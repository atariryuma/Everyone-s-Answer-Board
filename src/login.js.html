<script>
  // グローバルエラーハンドラー
  window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    const userEmailDisplay = document.getElementById('user-email-display');
    if (userEmailDisplay && event.error.message) {
      userEmailDisplay.textContent = 'システムエラーが発生しました';
    }
  });

  // Promise rejection ハンドラー
  window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    const userEmailDisplay = document.getElementById('user-email-display');
    if (userEmailDisplay) {
      userEmailDisplay.textContent = '通信エラーが発生しました';
    }
  });

  // UI状態管理 - グローバルスコープに移動して他の関数からアクセス可能にする
  window.setLoading = function(flag, text = '') {
    const loginBtn = document.getElementById('login-btn');
    if (!loginBtn) {
      console.warn('login-btn element not found, skipping loading state change');
      return;
    }
    loginBtn.disabled = flag;
    
    if (flag) {
      loginBtn.innerHTML = `
        <div class="flex items-center justify-center">
          <div class="loading-spinner w-5 h-5 border-2 border-white border-t-transparent rounded-full mr-2"></div>
          ${text || '処理中…'}
        </div>
      `;
    } else {
      loginBtn.textContent = 'はじめる';
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.getElementById('login-btn');
    const userEmailDisplay = document.getElementById('user-email-display');
    let tokenClient;

    // 既存のgetGoogleClientId()関数を使用
    const getClientId = () => {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(res => {
            if (res && res.clientId) {
              resolve(res.clientId);
            } else {
              reject(new Error('client id not found'));
            }
          })
          .withFailureHandler(reject)
          .getGoogleClientId();
      });
    };

    // 既存のgetExistingBoard()関数を使用 - 安定動作していた実装
    const fetchBoard = () => {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getExistingBoard();
      });
    };

    // バックエンドの安定した関数を使用してユーザー登録
    const registerUser = () => {
      return new Promise((resolve, reject) => {
        // getCurrentUserStatus()でユーザーメール取得
        google.script.run
          .withSuccessHandler(response => {
            if (response && response.status === 'success' && response.userInfo && response.userInfo.adminEmail) {
              const currentUserEmail = response.userInfo.adminEmail;
              
              // 既存のregisterNewUser()関数を呼び出し
              google.script.run
                .withSuccessHandler(res => {
                  if (res && res.adminUrl) {
                    showAdminPanelRedirect(res.adminUrl, '新規ユーザー登録が完了しました');
                    resolve();
                  } else {
                    reject(new Error('registration failed'));
                  }
                })
                .withFailureHandler(reject)
                .registerNewUser(currentUserEmail);
            } else {
              reject(new Error('ユーザーメールアドレスを取得できません'));
            }
          })
          .withFailureHandler(reject)
          .getCurrentUserStatus();
      });
    };

    // 現在のユーザーメールアドレスを表示
    const displayCurrentUserEmail = () => {
      google.script.run
        .withSuccessHandler(response => {
          if (response && response.status === 'success' && response.userInfo && response.userInfo.adminEmail) {
            userEmailDisplay.textContent = response.userInfo.adminEmail;
          } else {
            userEmailDisplay.textContent = 'ユーザー情報を取得中...';
            console.warn('User email not found in response:', response);
          }
        })
        .withFailureHandler(error => {
          console.warn('User email display failed:', error);
          userEmailDisplay.textContent = 'ユーザー情報取得エラー';
        })
        .getCurrentUserStatus();
    };

    // GAS内蔵認証を使用した簡易ログイン処理
    const handleSimpleLogin = () => {
      try {
        setLoading(true, 'ユーザー情報確認中…');
        
        // URL システムのリセットを事前に実行
        google.script.run
          .withSuccessHandler(() => {
            console.log('URL system reset completed');
            // バックエンドのgetExistingBoard()が返す3つの状態を処理
            fetchBoard()
              .then(handleFetchBoardResponse)
              .catch(handleFetchBoardError);
          })
          .withFailureHandler((error) => {
            console.warn('URL system reset failed:', error);
            // リセットに失敗してもログイン処理は続行
            fetchBoard()
              .then(handleFetchBoardResponse)
              .catch(handleFetchBoardError);
          })
          .forceUrlSystemReset();
      } catch (err) {
        console.error('Login function error:', err);
        userEmailDisplay.textContent = 'ログイン処理エラー';
        setLoading(false);
      }
    };

    // fetchBoard の結果を処理する関数
    const handleFetchBoardResponse = (res) => {
      try {
        if (!res || typeof res !== 'object') {
          throw new Error('無効なレスポンスを受信しました');
        }
        
        if (res.status === 'existing_user') {
          // 既存ユーザー: 管理画面リダイレクト画面を表示
          if (res.adminUrl) {
            showAdminPanelRedirect(res.adminUrl, 'ログインが完了しました');
          } else {
            throw new Error('管理画面URLが見つかりません');
          }
        } else if (res.status === 'setup_required') {
          // セットアップ必要: 管理画面リダイレクト画面を表示
          if (res.adminUrl) {
            showAdminPanelRedirect(res.adminUrl, 'セットアップを完了してください');
          } else {
            throw new Error('管理画面URLが見つかりません');
          }
        } else if (res.status === 'new_user') {
          // 新規ユーザー: 登録処理実行
          return registerUser();
        } else {
          throw new Error(res.message || `未知のステータス: ${res.status}`);
        }
      } catch (innerErr) {
        console.error('Response handling error:', innerErr);
        userEmailDisplay.textContent = innerErr.message || 'レスポンス処理エラー';
        setLoading(false);
      }
    };

    // fetchBoard のエラーを処理する関数
    const handleFetchBoardError = (err) => {
      console.error('Backend error:', err);
      userEmailDisplay.textContent = 'サーバーエラーが発生しました';
      setLoading(false);
    };


    // 初期化処理 - 組織ポリシー制限を回避するため簡易認証を使用
    const init = () => {
      loginBtn.addEventListener('click', () => {
        // OAuth制限を回避して直接ログイン処理を実行
        handleSimpleLogin();
      });

      // ユーザーメールアドレスを表示
      displayCurrentUserEmail();

      // OAuth設定は省略し、直接初期化完了
      setLoading(false);

      // 既存のgetSystemDomainInfo()で組織情報表示
      google.script.run
        .withSuccessHandler(info => {
          if (info && info.adminDomain) {
            const orgNameEl = document.getElementById('organization-name');
            const orgPanelEl = document.getElementById('organization-panel');
            
            if (orgNameEl && orgPanelEl) {
              orgNameEl.textContent = info.adminDomain;
              orgPanelEl.style.display = 'block';
            }
          }
        })
        .withFailureHandler(error => {
          console.warn('Domain info failed:', error);
          // 組織情報が取得できない場合はパネルを非表示のまま
          const orgPanelEl = document.getElementById('organization-panel');
          if (orgPanelEl) {
            orgPanelEl.style.display = 'none';
          }
        })
        .getSystemDomainInfo();
    };

    setLoading(true, '読み込み中…');
    init();
  });

  // アカウント切り替え機能
  function switchAccount() {
    const userEmailDisplay = document.getElementById('user-email-display');
    const switchBtn = document.getElementById('switch-account-btn');
    
    if (confirm('別のアカウントでログインしますか？\n現在のセッションがクリアされます。')) {
      // ボタンを無効化
      if (switchBtn) {
        switchBtn.disabled = true;
        switchBtn.textContent = 'セッションクリア中...';
      }
      
      if (userEmailDisplay) {
        userEmailDisplay.textContent = 'アカウント切り替え中...';
      }
      
      // バックエンドのセッションクリーンアップ関数を呼び出し
      google.script.run
        .withSuccessHandler(result => {
          console.log('Session cleanup result:', result);
          // Google認証のログアウトURLにリダイレクト
          window.location.href = 'https://accounts.google.com/logout';
        })
        .withFailureHandler(error => {
          console.error('Session cleanup failed:', error);
          alert('セッションクリアに失敗しました。手動でGoogleアカウントからログアウトしてください。');
          // 失敗時もGoogleログアウトページへ
          window.location.href = 'https://accounts.google.com/logout';
        })
        .resetUserAuthentication();
    }
  }

  // セキュリティモーダル制御関数
  function showSecurityModal() {
    const modal = document.getElementById('security-modal');
    if (modal) {
      modal.classList.remove('hidden');
    }
  }

  function closeSecurityModal() {
    const modal = document.getElementById('security-modal');
    if (modal) {
      modal.classList.add('hidden');
    }
  }

  // =============================================================================
  // 管理パネルリダイレクト関数
  // =============================================================================
  
  /**
   * 管理パネルにリダイレクトする
   * @param {string} adminUrl - 管理パネルのURL
   */
  window.redirectToAdminPanel = function(adminUrl) {
    try {
      if (!adminUrl || typeof adminUrl !== 'string') {
        console.error('redirectToAdminPanel: 無効なURLが渡されました:', adminUrl);
        alert('管理パネルのURLが無効です。');
        return;
      }
      
      console.log('管理パネルにリダイレクト中:', adminUrl);
      window.location.href = adminUrl;
    } catch (error) {
      console.error('redirectToAdminPanel error:', error);
      alert('リダイレクトに失敗しました。URLを手動でコピーしてアクセスしてください。');
    }
  };

  // =============================================================================
  // 管理パネルリダイレクト画面表示関数
  // =============================================================================
  
  /**
   * 管理パネルへのリダイレクト画面を表示 (エラーハンドリング強化)
   * @param {string} adminUrl - 管理パネルのURL
   * @param {string} message - 表示メッセージ
   */
  function showAdminPanelRedirect(adminUrl, message) {
    try {
      // 引数の妥当性チェック
      if (!adminUrl || typeof adminUrl !== 'string') {
        console.error('showAdminPanelRedirect: 無効なadminUrlが渡されました:', adminUrl);
        alert('管理パネルのURLが無効です。ページを再読み込みしてください。');
        return;
      }
      
      if (!message || typeof message !== 'string') {
        message = 'ログインが完了しました'; // デフォルトメッセージ
      }
      
      // ローディング状態を停止 (既存のsetLoading関数を使用)
      if (typeof setLoading === 'function') {
        setLoading(false);
      } else {
        console.warn('setLoading function not found, skipping loading state reset');
      }
      
      // ログインモーダルを非表示 (実際の要素構造に合わせて修正)
      const mainContent = document.querySelector('.login-modal');
      if (mainContent) {
        mainContent.style.display = 'none';
      } else {
        console.warn('login-modal element not found, proceeding with redirect display');
      }
    } catch (error) {
      console.error('showAdminPanelRedirect initialization error:', error);
      // エラーが発生しても処理を続行
    }
    
    // リダイレクト画面のHTML (ログイン画面のスタイルと統一、背景要素を含む)
    const redirectHTML = `
      <div class="login-background">
        <div class="min-h-screen flex items-center justify-center p-4">
          <div class="login-modal rounded-2xl p-8">
          <!-- ヘッダー -->
          <div class="text-center mb-8">
            <div class="text-6xl mb-4">✅</div>
            <h1 class="text-3xl font-bold text-cyan-400 mb-2">${message}</h1>
            <p class="text-lg text-gray-300">管理パネルに移動してご利用ください</p>
          </div>
          
          <!-- URL表示 -->
          <div class="glass-panel rounded-xl p-4 mb-6">
            <h2 class="text-lg font-semibold text-white mb-4">🔗 管理パネルURL</h2>
            <div class="bg-gray-800 p-3 rounded-lg">
              <div class="text-cyan-400 font-mono text-sm break-all">
                ${adminUrl}
              </div>
            </div>
          </div>
          
          <!-- アクション -->
          <div class="space-y-4">
            <button 
              onclick="redirectToAdminPanel('${adminUrl.replace(/'/g, "\\'")}'); return false;"
              class="w-full btn bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 text-white font-bold py-3 px-6 rounded-lg">
              🚀 管理パネルを開く
            </button>
            
            <div class="text-center space-y-3">
              <button 
                onclick="copyUrlToClipboard('${adminUrl.replace(/'/g, "\\'")}'); return false;"
                class="text-sm text-cyan-400 hover:text-cyan-300 underline">
                📋 URLをコピー
              </button>
              <br>
              <div class="text-xs text-gray-400 space-y-1">
                <p>※ このURLをブックマークしておくと、次回から直接アクセスできます</p>
                <p>※ セキュリティのため、URLは他人と共有しないでください</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // 既存のコンテンツを置き換え (画面中央表示のため既存要素を置換)
    try {
      // 既存のlogin-background要素を探して置換
      const loginBackground = document.querySelector('.login-background') || 
                             document.querySelector('body > div:first-child') ||
                             document.body;
      
      if (loginBackground && loginBackground !== document.body) {
        // 既存要素を完全に置換
        loginBackground.outerHTML = redirectHTML;
      } else {
        // フォールバック: body全体を置換
        document.body.innerHTML = redirectHTML;
      }
      
      // ページトップにスクロール
      window.scrollTo(0, 0);
      
      console.log('✅ リダイレクト画面を表示しました');
    } catch (error) {
      console.error('リダイレクト画面の表示に失敗:', error);
      // フォールバック: 緊急時のシンプルなリダイレクト
      try {
        // まず自動リダイレクトを試行
        const userChoice = confirm(`${message}\n\n管理パネルに移動しますか？\n\nURL: ${adminUrl}\n\n「OK」で移動、「キャンセル」でURLをコピー`);
        
        if (userChoice) {
          window.location.href = adminUrl;
        } else {
          // URLをコピーする機能を提供
          if (window.copyUrlToClipboard) {
            window.copyUrlToClipboard(adminUrl);
          } else {
            // 最終手段: prompt表示
            window.prompt('下記のURLをコピーして手動でアクセスしてください:', adminUrl);
          }
        }
      } catch (fallbackError) {
        console.error('フォールバック処理も失敗:', fallbackError);
        alert(`画面表示に問題が発生しました。\n\n手動で下記URLにアクセスしてください:\n${adminUrl}`);
      }
      return;
    }
    
    // オプション: 5秒後の自動リダイレクト（コメントアウト状態）
    // startAutoRedirect(adminUrl);
  }
  
  /**
   * URLをクリップボードにコピー (エラーハンドリング強化)
   * @param {string} url - コピーするURL
   */
  window.copyUrlToClipboard = function(url) {
    // 引数の妥当性チェック
    if (!url || typeof url !== 'string') {
      console.warn('copyUrlToClipboard: 無効なURLが渡されました:', url);
      alert('コピーするURLが無効です。');
      return;
    }
    
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => {
          // 一時的な成功メッセージを表示
          const copyBtn = event && event.target;
          if (copyBtn) {
            const originalText = copyBtn.textContent;
            copyBtn.textContent = '✅ コピーしました';
            copyBtn.disabled = true;
            
            setTimeout(() => {
              copyBtn.textContent = originalText;
              copyBtn.disabled = false;
            }, 2000);
          } else {
            // ボタン要素が見つからない場合のフォールバック
            alert('URLをクリップボードにコピーしました');
          }
        }).catch((error) => {
          console.warn('Clipboard API failed:', error);
          window.fallbackCopyUrl(url);
        });
      } else {
        // Clipboard API非対応
        window.fallbackCopyUrl(url);
      }
    } catch (error) {
      console.error('copyUrlToClipboard error:', error);
      window.fallbackCopyUrl(url);
    }
  }
  
  /**
   * クリップボードAPI非対応時のフォールバック (エラーハンドリング強化)
   * @param {string} url - コピーするURL
   */
  window.fallbackCopyUrl = function(url) {
    try {
      const textArea = document.createElement('textarea');
      textArea.value = url;
      textArea.style.position = 'fixed';
      textArea.style.top = '-9999px';
      textArea.style.left = '-9999px';
      textArea.style.opacity = '0';
      textArea.setAttribute('readonly', '');
      textArea.setAttribute('aria-hidden', 'true');
      
      document.body.appendChild(textArea);
      
      // iOS対応: selectとsetSelectionRangeを使用
      textArea.select();
      if (textArea.setSelectionRange) {
        textArea.setSelectionRange(0, url.length);
      }
      
      // コピー実行
      const successful = document.execCommand('copy');
      
      if (successful) {
        alert('URLをクリップボードにコピーしました');
      } else {
        throw new Error('execCommand failed');
      }
      
    } catch (err) {
      console.error('fallbackCopyUrl error:', err);
      // 最後の手段: URLを表示してユーザーに手動コピーを促す
      const message = `コピーに失敗しました。下記のURLを手動でコピーしてください:\n\n${url}`;
      if (window.prompt) {
        window.prompt('URLを選択してコピーしてください:', url);
      } else {
        alert(message);
      }
    } finally {
      // textAreaの削除（安全に）
      try {
        const textAreas = document.querySelectorAll('textarea[aria-hidden="true"]');
        textAreas.forEach(ta => {
          if (ta.parentNode) {
            ta.parentNode.removeChild(ta);
          }
        });
      } catch (cleanupError) {
        console.warn('Textarea cleanup warning:', cleanupError);
      }
    }
  }
  
  /**
   * 自動リダイレクトを開始（オプション機能）
   * @param {string} url - リダイレクト先URL
   */
  window.startAutoRedirect = function(url) {
    const autoRedirectDiv = document.getElementById('auto-redirect');
    const countdownSpan = document.getElementById('countdown');
    
    if (autoRedirectDiv && countdownSpan) {
      autoRedirectDiv.style.display = 'block';
      let countdown = 3;
      
      const interval = setInterval(() => {
        countdown--;
        countdownSpan.textContent = countdown;
        
        if (countdown <= 0) {
          clearInterval(interval);
          window.location.href = url;
        }
      }, 1000);
      
      // グローバルに保存して、キャンセルできるようにする
      window.autoRedirectInterval = interval;
    }
  }
  
  /**
   * 自動リダイレクトをキャンセル
   */
  window.cancelAutoRedirect = function() {
    if (window.autoRedirectInterval) {
      clearInterval(window.autoRedirectInterval);
      window.autoRedirectInterval = null;
    }
    
    const autoRedirectDiv = document.getElementById('auto-redirect');
    if (autoRedirectDiv) {
      autoRedirectDiv.style.display = 'none';
    }
  }
</script>

