<script>

  function setLoginButtonState(disabled, text = 'はじめる') {
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
      loginBtn.disabled = disabled;
      loginBtn.textContent = text;
    }
  }

  // Initialization wrapper function with error handling
  async function init() {
    try {
      console.log('🔄 Starting login page initialization...');

      // Set initial loading state
      window.setLoading(true, '読み込み中…');
      setLoginButtonState(true, '読み込み中');

      const loginBtn = document.getElementById('login-btn');
      const userEmailDisplay = document.getElementById('user-email-display');

      // DOM要素の存在確認
      if (!loginBtn) {
        console.error('❌ Critical: login-btn element not found');
        window.setLoading(false);
        return;
      }
      if (!userEmailDisplay) {
        console.error('❌ Critical: user-email-display element not found');
        window.setLoading(false);
        return;
      }

      // Call existing initialization functions
      initLogin();

      // Main initialization logic (directly integrated)
      // ボタンイベントリスナーの設定
      loginBtn.addEventListener('click', () => {
        try {
          handleLogin();
        } catch (error) {
          console.error('❌ Login handler failed:', error);
          userEmailDisplay.textContent = 'ログイン処理でエラーが発生しました。ページを更新してください。';
          userEmailDisplay.classList.add('text-red-400');
        }
      });

      // ドメイン表示の更新
      const domainInfo = await fetchDomainInfo();
      displayDomainInfo(domainInfo);

      // ユーザーメール表示の初期化 (非同期 - 最後に実行)
      try {
        displayCurrentUserEmail();
      } catch (error) {
        console.error('Display user email failed:', error);
        if (!userEmailDisplay.dataset.emailSet) {
          setEmailDisplayDefault();
        }
        // ユーザーメール表示エラー時のローディング解除
        window.setLoading(false);
        setLoginButtonState(false);
      }

      console.log('✅ Login page initialization completed');
    } catch (error) {
      console.error('❌ Initialization failed:', error);
      window.setLoading(false);

      // 統一された通知システムを使用
      if (window.notifications) {
        window.notifications.error('初期化に失敗しました。ページを再読み込みしてください。', 10000);
      }

      // 最終フォールバック: 基本的な表示を確保
      const userEmailDisplay = document.getElementById('user-email-display');
      if (userEmailDisplay) {
        userEmailDisplay.textContent = '初期化エラーが発生しました。ページを更新してください。';
        userEmailDisplay.classList.add('text-red-400');
      }

      const loginBtn = document.getElementById('login-btn');
      if (loginBtn) {
        loginBtn.disabled = false;
        loginBtn.textContent = 'はじめる';
      }
    }
  }

  function initLogin() {
    try {
      console.log('🔄 Fresh login experience initialization...');

      const loginBtn = document.getElementById('login-btn');
      const userEmailDisplay = document.getElementById('user-email-display');

      // ✅ フレッシュなログイン体験: 堅牢なエラーハンドリング
        // サーバーサイドから渡されたキャッシュバスティング情報を確認（安全な取得）
        let loginState = {};
        let isLogoutRedirect = false;
        let fallbackReason = null;

        // サーバーサイド変数の安全な取得
        loginState = {};
        isLogoutRedirect = false;
        fallbackReason = null;

        // URLパラメータから状態を復元
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('logout') === 'true') {
          isLogoutRedirect = true;
        }
        if (urlParams.get('fallback')) {
          fallbackReason = urlParams.get('fallback');
        }

        console.log('🔄 Fresh login experience initialized', {
          loginState,
          isLogoutRedirect,
          fallbackReason
        });

        // ログアウト後のリダイレクトの場合、ユーザーにクリーンな状態であることを示す
        if (isLogoutRedirect && userEmailDisplay) {
          let statusMessage = '✅ ログアウトが完了しました。新しくログインしてください。';

          if (fallbackReason) {
            if (fallbackReason.includes('server_error')) {
              statusMessage = '⚠️ サーバーエラーが発生しましたが、ログアウトは完了しました。';
            } else if (fallbackReason.includes('critical_error')) {
              statusMessage = '🔧 システムエラーが発生しましたが、セッションはクリアされました。';
            }
          }

          userEmailDisplay.textContent = statusMessage;
          userEmailDisplay.classList.add('text-green-400');

          // 3秒後にメッセージをクリア - CLAUDE.md V8 compliant: Promise-based delay
          const createPromiseDelay = (ms) => new Promise(resolve => {
            const start = Date.now();
            const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
            check();
          });

          createPromiseDelay(3000).then(() => {
            if (userEmailDisplay) {
              userEmailDisplay.textContent = 'Google アカウントでログインしてください';
              userEmailDisplay.classList.remove('text-green-400');
            }
          }).catch(() => {
            // Silent error handling for cleanup
          });
        }

        // ✅ ブラウザキャッシュ完全クリア（ログアウト後のみ）
        if (isLogoutRedirect) {
          // ページレベルのキャッシュクリア
          if ('caches' in window) {
            caches.keys().then(names => {
              names.forEach(name => {
                if (name.includes('login') || name.includes('admin')) {
                  caches.delete(name);
                }
              });
            }).catch(e => console.warn('Cache clear failed:', e));
          }

          // Service Worker キャッシュクリア
          if (navigator.serviceWorker && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
              command: 'clearCache',
              reason: 'logout_redirect'
            });
          }

          console.log('🧹 Browser cache cleared for fresh login experience');
        }

      } catch (error) {
        console.warn('⚠️ Fresh login experience initialization failed:', error);
        // フォールバック: 通常のログイン処理を継続
      }

  }

    // registerAndRedirect関数削除 - getLoginStatus()で自動登録を実行

  const processUnifiedLogin = () => {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler((response) => {
            if (!response || !response.success) {
              // エラーメッセージを表示
              const errorMsg = response?.message || 'ログイン処理に失敗しました';
              userEmailDisplay.textContent = errorMsg;
              userEmailDisplay.classList.add('text-red-400');
              reject(new Error(errorMsg));
              return;
            }

            // ログイン成功: 管理パネルURLを決定して自動リダイレクト
            const adminUrl =
              response.adminUrl ||
              response.redirectUrl ||
              response.appUrl ||
              response.url ||
              '';

            if (typeof adminUrl === 'string' && adminUrl.trim().length > 0) {
              showAdminPanelRedirect(adminUrl, response.message);
            } else {
              console.error('processUnifiedLogin: 管理URLが返されませんでした', response);
              userEmailDisplay.textContent = 'ログインは成功しましたが、管理URLが見つかりません。管理者に連絡してください。';
              userEmailDisplay.classList.add('text-yellow-400');
              // ローディング解除
              window.setLoading(false);
              setLoginButtonState(false);
              // resolve to prevent further error flows
            }
            resolve();
          })
          .withFailureHandler((error) => {
            userEmailDisplay.textContent = `エラー: ${error.message}`;
            userEmailDisplay.classList.add('text-red-400');
            // エラー時もローディング状態を終了
            window.setLoading(false);
            setLoginButtonState(false);
            reject(error);
          })
          .processLoginAction();
      });
    };

    // === メールアドレス表示管理システム ===

    // ユーザーメール表示を既定値にリセット
    const setEmailDisplayDefault = () => {
      const userEmailDisplay = document.getElementById('user-email-display');
      if (!userEmailDisplay) return;
      userEmailDisplay.textContent = 'Google アカウントでログインしてください';
      userEmailDisplay.classList.remove('text-red-400', 'text-yellow-400', 'text-blue-400');
      userEmailDisplay.dataset.emailSet = '';
    };

    // 現在のユーザーメールアドレスを取得・表示（GAS内部上書き保護付き）
    const displayCurrentUserEmail = () => {
      const userEmailDisplay = document.getElementById('user-email-display');
      if (!userEmailDisplay) {
        console.error('❌ userEmailDisplay element not found');
        return;
      }

      try {
        userEmailDisplay.textContent = '🔄 アカウント情報を確認中...';

        google.script.run
          .withSuccessHandler((email) => {
            if (email && typeof email === 'string') {
              // メールアドレス表示の設定
              const emailText = `📧 ${email}`;
              userEmailDisplay.textContent = emailText;
              userEmailDisplay.classList.remove('text-red-400', 'text-yellow-400');
              userEmailDisplay.classList.add('text-blue-400');

              // 上書き防止フラグを設定
              userEmailDisplay.dataset.emailSet = 'true';

              // GAS内部システムからの上書きを防ぐ監視機能
              const emailProtector = setInterval(() => {
                if (userEmailDisplay.dataset.emailSet === 'true' &&
                    userEmailDisplay.textContent !== emailText) {
                  userEmailDisplay.textContent = emailText;
                  userEmailDisplay.classList.remove('text-red-400', 'text-yellow-400');
                  userEmailDisplay.classList.add('text-blue-400');
                }
              }, 800);

              // 5秒後に監視を停止（GAS内部処理完了後） - CLAUDE.md V8 compliant: Promise-based delay
              const createPromiseDelay = (ms) => new Promise(resolve => {
                const start = Date.now();
                const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
                check();
              });

              createPromiseDelay(5000).then(() => clearInterval(emailProtector)).catch(() => {
                // Silent error handling
              });

              // 成功時のローディング状態解除
              window.setLoading(false);
              setLoginButtonState(false);

            } else {
              setEmailDisplayDefault();
              // デフォルト設定時のローディング状態解除
              window.setLoading(false);
              setLoginButtonState(false);
            }
          })
          .withFailureHandler((error) => {
            console.warn('Email fetch failed:', error.message);
            setEmailDisplayDefault();
            // エラー時もローディング状態を終了
            window.setLoading(false);
            setLoginButtonState(false);
          })
          .getCurrentEmail();
      } catch (error) {
        console.error('DisplayCurrentUserEmail error:', error);
        setEmailDisplayDefault();
        // Catch ブロックでもローディング状態を終了
        window.setLoading(false);
        setLoginButtonState(false);
      }
    };

    // ログインエラーを処理する関数
    const handleLoginError = (err) => {
      console.error('Login error:', err);

      const displayMessage = err?.message ||
                            (typeof err === 'string' ? err : 'ログイン処理エラーが発生しました');

      // メールアドレスが設定済みの場合は上書きしない
      if (!userEmailDisplay.dataset.emailSet) {
        userEmailDisplay.textContent = displayMessage;
        userEmailDisplay.classList.add('text-red-400');
      }
      window.setLoading(false);
      setLoginButtonState(false);
    };

    // GAS内蔵認証を使用した簡易ログイン処理
    const handleLogin = () => {
      try {
        window.setLoading(true, 'ユーザー情報確認中…');
        setLoginButtonState(true, '処理中');

        // URL システムのリセットを事前に実行
        google.script.run
          .withSuccessHandler(() => {
            console.log('URL system reset completed');
            // 統合されたログインフローを実行
            processUnifiedLogin().catch(handleLoginError);
          })
          .withFailureHandler((error) => {
            console.warn('URL system reset failed:', error);
            // リセットに失敗してもログイン処理は続行
            processUnifiedLogin().catch(handleLoginError);
          })
          .forceUrlSystemReset();
      } catch (err) {
        console.error('Login function error:', err);
        userEmailDisplay.textContent = 'ログイン処理エラー';
        window.setLoading(false);
      setLoginButtonState(false);
      }
    };

    // initializeMainLoginLogic function removed - logic integrated into main init() function

    /**
     * ローカルドメイン情報表示 - ログインページ専用
     */
    function displayDomainInfo(info) {
      const match = document.getElementById('header-domain-match');
      const mismatch = document.getElementById('header-domain-mismatch');
      const initial = document.getElementById('header-domain-initial');

      // 全て非表示
      [match, mismatch, initial].forEach(element => {
        if (element) element.style.display = 'none';
      });

      if (info.error) return;

      if (info.isValidDomain) {
        if (match) {
          document.getElementById('header-domain-match-text').textContent = info.domain || '学校ドメイン';
          match.style.display = 'block';
        }
      } else {
        if (mismatch) {
          document.getElementById('header-domain-mismatch-text').textContent = info.domain ? `外部: ${info.domain}` : '外部アクセス';
          mismatch.style.display = 'block';
        }
      }
    }

    /**
     * ローカルドメイン情報取得 - ログインページ専用
     */
    async function fetchDomainInfo() {
      if (!google?.script?.run?.getDeployUserDomainInfo) {
        return { isValidDomain: true, domain: 'unknown' };
      }

      try {
        return await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getDeployUserDomainInfo();
        });
      } catch (error) {
        console.error('Domain info fetch failed:', error);
        return { error: true };
      }
    }

  // ✅ CLAUDE.md準拠: DOM ready initialization pattern
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

    // アカウント切り替え機能（2025年ベストプラクティス準拠）- DOMContentLoaded内で定義
    window.switchAccount = function() {
    const userEmailDisplay = document.getElementById('user-email-display');
    const switchBtn = document.getElementById('switch-account-btn');

    if (confirm('別のアカウントでログインしますか？\n\nポップアップウィンドウが開きます。\nポップアップブロッカーが有効な場合は、一時的に無効にしてください。')) {
      // UI状態更新
      if (switchBtn) {
        switchBtn.disabled = true;
        switchBtn.textContent = 'アカウント切り替え中...';
      }
      if (userEmailDisplay) {
        userEmailDisplay.textContent = '🔄 別のアカウントでログインしています...';
        userEmailDisplay.classList.remove('text-red-400', 'text-green-400');
        userEmailDisplay.classList.add('text-yellow-400');
      }

      console.log('🔄 Starting account switch process...');

      try {
        // Phase 1: ポップアップでGmailログアウトを実行
        console.log('📤 Opening Gmail logout popup...');
        const logoutWindow = window.open(
          'https://mail.google.com/mail/?logout&hl=ja',
          'GoogleAccountSwitch',
          'width=500,height=400,menubar=no,status=no,location=no,toolbar=no,scrollbars=no,top=200,left=200'
        );

        if (!logoutWindow) {
          throw new Error('ポップアップがブロックされました');
        }

        // Phase 2: シンプルなタイムアウト制御（セッションクリア不要）
        let timeoutId = setTimeout(() => {
          console.log('⏰ Popup timeout reached, closing popup...');

          // ポップアップを閉じる
          if (logoutWindow && !logoutWindow.closed) {
            logoutWindow.close();
          }

          // Gmailログアウト完了後は直接リロード（resetAuth不要）
          console.log('✅ Gmail logout completed, reloading page...');
          if (userEmailDisplay) {
            userEmailDisplay.textContent = '✅ アカウント切り替え完了！ページを更新します...';
            userEmailDisplay.classList.remove('text-yellow-400');
            userEmailDisplay.classList.add('text-green-400');
          }

          setTimeout(() => {
            // GAS 2021年以降: window.open(_top) でリロード
            window.open(window.location.href, '_top');
          }, 1000);
        }, 3500); // 3.5秒でタイムアウト

        // ポップアップが手動で閉じられた場合の監視
        const checkClosed = setInterval(() => {
          if (logoutWindow.closed) {
            clearInterval(checkClosed);
            clearTimeout(timeoutId);
            console.log('👆 Popup closed by user, proceeding with reload...');

            // 直接リロード（セッションは既にGmailでクリア済み）
            console.log('✅ Gmail logout completed, reloading page...');
            if (userEmailDisplay) {
              userEmailDisplay.textContent = '✅ アカウント切り替え完了！ページを更新します...';
              userEmailDisplay.classList.remove('text-yellow-400');
              userEmailDisplay.classList.add('text-green-400');
            }

            setTimeout(() => {
              // GAS 2021年以降: window.open(_top) でリロード
              window.open(window.location.href, '_top');
            }, 1000);
          }
        }, 500);

      } catch (error) {
        console.error('❌ Popup failed:', error);

        // フォールバック処理
        if (userEmailDisplay) {
          userEmailDisplay.textContent = '❌ ポップアップが開けませんでした。手動での切り替えが必要です。';
          userEmailDisplay.classList.remove('text-yellow-400');
          userEmailDisplay.classList.add('text-red-400');
        }

        if (switchBtn) {
          switchBtn.disabled = false;
          switchBtn.textContent = '別のアカウントでログイン';
        }

        // フォールバック指示
        setTimeout(() => {
          if (window.notifications) {
            window.notifications.warning(
              'ポップアップブロッカーによりアカウント切り替えができませんでした。\n\n手動での切り替え手順：\n1. 新しいタブでGmailを開く\n2. 右上のアカウントアイコンをクリック\n3. 「別のアカウントを追加」または「ログアウト」を選択\n4. このページを更新してください',
              10000
            );
          } else {
            alert(
              'ポップアップブロッカーによりアカウント切り替えができませんでした。\n\n手動での切り替え手順：\n1. 新しいタブでGmailを開く\n2. 右上のアカウントアイコンをクリック\n3. 「別のアカウントを追加」または「ログアウト」を選択\n4. このページを更新してください'
            );
          }
        }, 1000);
      }
    }
  }; // switchAccount function end


  // =============================================================================
  // グローバル関数定義（DOMContentLoaded外で定義）
  // =============================================================================

  // セキュリティモーダル制御関数 - アニメーション対応
  function showSecurityModal() {
    const modal = document.getElementById('security-modal');
    if (modal) {
      modal.style.animation = 'modalFade 0.3s ease-out';
      modal.classList.remove('hidden');

      // モーダル内コンテンツのアニメーション
      const modalContent = modal.querySelector('.glass-panel');
      if (modalContent) {
        modalContent.style.animation = 'modalScale 0.3s ease-out';
      }
    }
  }

  function closeSecurityModal() {
    const modal = document.getElementById('security-modal');
    if (modal) {
      // フェードアウトアニメーション
      modal.style.animation = 'fadeOut 0.2s ease-out';

      // CLAUDE.md V8 compliant: CSS transition completion event
      modal.addEventListener('animationend', () => {
        modal.classList.add('hidden');
        // アニメーションをリセット
        modal.style.animation = '';
        const modalContent = modal.querySelector('.glass-panel');
        if (modalContent) {
          modalContent.style.animation = '';
        }
      }, { once: true });
    }
  }

  // =============================================================================
  // 管理パネル即座リダイレクト機能 (シンプル版)
  // =============================================================================

  /**
   * 管理パネルアクセス成功画面を表示 (ユーザーアクティベーション必須)
   * @param {string} adminUrl - 管理パネルのURL
   * @param {string} message - 表示メッセージ
   */
  function showAdminPanelRedirect(adminUrl, message) {
    try {
      // 引数の妥当性チェック
      if (!adminUrl || typeof adminUrl !== 'string') {
        console.error('showAdminPanelRedirect: 無効なadminUrlが渡されました:', adminUrl);
        if (window.notifications) {
          window.notifications.error('管理パネルのURLが無効です。再読み込みしてください。', 7000);
        } else {
          alert('管理パネルのURLが無効です。ページを再読み込みしてください。');
        }
        return;
      }

      console.log('管理パネルアクセス成功画面を表示:', adminUrl);

      // ローディング状態を停止
      window.setLoading(false);
      setLoginButtonState(false);

      // サンドボックス制限準拠: ユーザークリック必須のHTMLアンカー方式
      const successHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>${message || 'ログインが完了しました'}</title>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <style>
            body { 
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: #1a1b26;
              min-height: 100vh;
              margin: 0;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 20px;
              position: relative;
              transition: background 2s ease-out;
            }
            body.success-transition {
              background: linear-gradient(135deg, #1a1b26 0%, #2a3d4a 30%, #1e3a3f 60%, #1a1b26 100%);
            }
            body::before {
              content: '';
              position: absolute;
              top: 0; left: 0; right: 0; bottom: 0;
              background-image: radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                                radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                                radial-gradient(circle at 40% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
              pointer-events: none;
              transition: background-image 2s ease-out, opacity 2s ease-out;
            }
            body.success-transition::before {
              background-image: radial-gradient(circle at 25% 25%, rgba(16, 185, 129, 0.15) 0%, transparent 60%),
                                radial-gradient(circle at 75% 75%, rgba(59, 130, 246, 0.15) 0%, transparent 60%),
                                radial-gradient(circle at 50% 50%, rgba(139, 233, 253, 0.1) 0%, transparent 70%);
              opacity: 0.8;
            }
            .container {
              background: rgba(26,27,38,0.7);
              backdrop-filter: blur(12px);
              border: 1px solid rgba(255,255,255,0.1);
              border-radius: 16px;
              padding: 2rem;
              max-width: 420px;
              width: 90%;
              min-height: 580px;
              max-height: 90vh;
              overflow-y: auto;
              text-align: center;
              box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
              position: relative;
              z-index: 1;
              animation: slideUp 0.6s ease-out;
            }
            /* Responsive design matching login panel breakpoints */
            @media (max-width: 640px) {
              .container {
                width: 95%;
                max-width: 380px;
                min-height: 520px;
                padding: 1.5rem;
              }
              .main-button {
                min-height: 48px;
                padding: 1rem 1.5rem;
                font-size: 16px;
              }
            }
            @media (max-width: 768px) {
              .container {
                padding: 1rem;
              }
            }
            @media (max-height: 700px) {
              .container {
                min-height: auto;
                max-height: 85vh;
              }
            }
            @media (min-width: 768px) {
              .container {
                padding: 2rem;
              }
            }
            @media (min-width: 1024px) {
              .container {
                max-width: 450px;
                padding: 2.5rem;
              }
            }
            @keyframes slideUp {
              0% { opacity: 0; transform: translateY(20px); }
              100% { opacity: 1; transform: translateY(0); }
            }
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            .icon { font-size: 64px; margin-bottom: 20px; }
            .title { 
              color: #10b981; 
              font-size: 24px; 
              font-weight: bold; 
              margin-bottom: 16px; 
            }
            .subtitle { 
              color: #d1d5db; 
              margin-bottom: 32px; 
              line-height: 1.5;
            }
            .main-button {
              display: inline-block;
              background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
              color: white;
              font-weight: bold;
              padding: 16px 32px;
              border-radius: 12px;
              text-decoration: none;
              font-size: 18px;
              transition: all 0.3s ease;
              margin-bottom: 24px;
              box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
              width: 100%;
              box-sizing: border-box;
            }
            .main-button:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
            }
            .url-info {
              background: rgba(17, 24, 39, 0.8);
              border-radius: 8px;
              padding: 16px;
              margin: 20px 0;
              border: 1px solid rgba(75, 85, 99, 0.5);
            }
            .url-label {
              color: #9ca3af;
              font-size: 12px;
              font-weight: 600;
              margin-bottom: 8px;
            }
            .url-text {
              color: #60a5fa;
              font-family: 'Courier New', monospace;
              font-size: 12px;
              word-break: break-all;
              line-height: 1.4;
              background: rgba(17, 24, 39, 0.8);
              padding: 8px;
              border-radius: 4px;
            }
            .copy-btn {
              margin-top: 8px;
              color: #3b82f6;
              background: none;
              border: none;
              font-size: 12px;
              text-decoration: underline;
              cursor: pointer;
            }
            .copy-btn:hover { color: #60a5fa; }
            .note {
              color: #9ca3af;
              font-size: 13px;
              margin-top: 20px;
              line-height: 1.5;
              text-align: left;
            }
            .note div {
              margin-bottom: 4px;
              word-break: keep-all;
              overflow-wrap: break-word;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="icon">✅</div>
            <h1 class="title">${message || 'ログインが完了しました'}</h1>
            <p class="subtitle">管理パネルにアクセスしてください</p>
            
            <a href="${adminUrl}" class="main-button" id="admin-panel-btn" onclick="handleSingleClick(this)">
              <span id="admin-panel-btn-text">🚀 管理パネルを開く</span>
            </a>
            
            <div class="url-info">
              <div class="url-label">📱 管理パネルURL:</div>
              <div class="url-text">${adminUrl}</div>
              <button onclick="copyUrlToClipboard('${adminUrl}', this)" class="copy-btn">
                📋 URLをコピー
              </button>
            </div>
            
            <div class="note">
              <div class="mb-1">✓ このリンクは安全です</div>
              <div class="mb-1">✓ Google Apps Script公式のセキュリティガイドラインに準拠</div>
              <div class="mb-1">🖱️ ボタンをクリックして管理パネルに移動してください</div>
              <div class="mb-1">💡 このURLをブックマークすると、次回から直接アクセスできます</div>
              <div>🔒 セキュリティのため、URLは他人と共有しないでください</div>
            </div>
          </div>
        </body>
        </html>
      `;

      // 現在のコンテンツを成功画面に完全置換
      document.body.innerHTML = successHtml;

      // シンプルなリンク方式 + 二重クリック防止
      console.log('✅ シンプルリンク方式 - 管理パネルボタンが表示されました');

      // 二重クリック防止処理
      window.handleSingleClick = function(buttonElement) {
        if (buttonElement.dataset.clicked === 'true') {
          console.log('二重クリック防止: 既にクリック済みです');
          return false;
        }

        // クリック状態を記録
        buttonElement.dataset.clicked = 'true';

        // ボタンの状態を変更
        const btnText = buttonElement.querySelector('#admin-panel-btn-text');
        if (btnText) {
          btnText.textContent = '🔄 管理パネルに移動中...';
        }
        buttonElement.style.opacity = '0.7';
        buttonElement.style.pointerEvents = 'none';

        console.log('管理パネルに移動します');
        return true; // リンクの通常動作を継続
      };

      // CLAUDE.md V8 compliant: requestIdleCallback for background transition
      requestIdleCallback(() => {
        document.body.classList.add('success-transition');
      }, { timeout: 300 });

      console.log('✅ シンプルリンク画面を表示しました');
    } catch (error) {
      console.error('成功画面表示エラー:', error);
      // フォールバック: シンプルなconfirm
      const userChoice = confirm(
        `${message || 'ログインが完了しました'}\\n\\n管理パネルにアクセスしますか？`
      );
      if (userChoice) {
        // ユーザーが選択した場合のみリンクを表示
        const linkElement = document.createElement('a');
        linkElement.href = adminUrl;
        linkElement.target = '_top';
        linkElement.textContent = '管理パネルを開く';
        linkElement.style.cssText =
          'display:block;padding:20px;background:#4CAF50;color:white;text-align:center;text-decoration:none;margin:20px;border-radius:5px;';
        document.body.innerHTML = '';
        document.body.appendChild(linkElement);
      }
    }
  }

  /**
   * URLをクリップボードにコピー (成功画面用)
   * @param {string} url - コピーするURL
   * @param {HTMLElement} buttonElement - クリックされたボタン要素
   */
  window.copyUrlToClipboard = function (url, buttonElement) {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(url)
          .then(() => {
            // 一時的な成功表示
            const originalText = buttonElement.textContent;
            buttonElement.textContent = '✅ コピー完了!';
            buttonElement.disabled = true;
            // CLAUDE.md V8 compliant: Promise-based delay for button state reset
            const createPromiseDelay = (ms) => new Promise(resolve => {
              const start = Date.now();
              const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
              check();
            });

            createPromiseDelay(2000).then(() => {
              buttonElement.textContent = originalText;
              buttonElement.disabled = false;
            });
          })
          .catch((error) => {
            console.error('Clipboard API failed:', error);
            // ユーザーに手動コピーを促すメッセージをボタンの近くに表示
            const messageElement = document.createElement('span');
            messageElement.textContent = ' (手動でコピーしてください)';
            messageElement.style.color = 'orange';
            buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
            // CLAUDE.md V8 compliant: Promise-based auto-removal for clipboard error
            const createPromiseDelay = (ms) => new Promise(resolve => {
              const start = Date.now();
              const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
              check();
            });

            createPromiseDelay(5000).then(() => messageElement.remove());
          });
      } else {
        // Clipboard APIがサポートされていない場合のフォールバック
        console.warn('Clipboard API not supported. Manual copy required.');
        const messageElement = document.createElement('span');
        messageElement.textContent =
          ' (ブラウザがコピーをサポートしていません。手動でコピーしてください)';
        messageElement.style.color = 'orange';
        buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
        // CLAUDE.md V8 compliant: Promise-based auto-removal for clipboard fallback
        const createPromiseDelay = (ms) => new Promise(resolve => {
          const start = Date.now();
          const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
          check();
        });

        createPromiseDelay(5000).then(() => messageElement.remove());
      }
    } catch (error) {
      console.error('copyUrlToClipboard error:', error);
      // 予期せぬエラーの場合
      const messageElement = document.createElement('span');
      messageElement.textContent = ' (コピー中にエラーが発生しました)';
      messageElement.style.color = 'red';
      buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
      // CLAUDE.md V8 compliant: Promise-based auto-removal for copy error
      const createPromiseDelay = (ms) => new Promise(resolve => {
        const start = Date.now();
        const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
        check();
      });

      createPromiseDelay(5000).then(() => messageElement.remove());
    }
  };

  // 管理パネルへの遷移を処理する関数
  function handleAdminPanelRedirect(event, adminUrl, buttonElement) {
    event.preventDefault(); // デフォルトのリンク遷移をキャンセル

    const buttonText = buttonElement.querySelector('#admin-panel-btn-text');
    const buttonSpinner = buttonElement.querySelector('#admin-panel-btn-spinner');

    if (buttonText) buttonText.classList.add('hidden');
    if (buttonSpinner) buttonSpinner.classList.remove('hidden');
    buttonElement.classList.add('cursor-not-allowed'); // カーソルを変更
    buttonElement.style.pointerEvents = 'none'; // クリックイベントを無効化
    buttonElement.setAttribute('aria-disabled', 'true'); // アクセシビリティ対応

    // ユーザー情報確認中... のようなメッセージを表示したい場合は、ここで設定
    // 例: buttonText.textContent = '管理パネルへ遷移中...';

    // 実際の遷移
    // GAS 2021年以降: window.open(_top) でリダイレクト
    window.open(adminUrl, '_top');
  }

  // ✅ ドメイン情報取得: SharedUtilities.htmlの統一関数を使用

  // ✅ ドメイン情報表示: SharedUtilities.htmlの統一関数を使用

</script>
