<script>

  function setLoginButtonState(disabled, text = 'ã¯ã˜ã‚ã‚‹') {
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
      loginBtn.disabled = disabled;
      loginBtn.textContent = text;
    }
  }

  // Initialization wrapper function with error handling
  async function init() {
    try {
      console.log('ğŸ”„ Starting login page initialization...');

      // Set initial loading state
      window.setLoading(true, 'èª­ã¿è¾¼ã¿ä¸­â€¦');
      setLoginButtonState(true, 'èª­ã¿è¾¼ã¿ä¸­');

      const loginBtn = document.getElementById('login-btn');
      const userEmailDisplay = document.getElementById('user-email-display');

      // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
      if (!loginBtn) {
        console.error('âŒ Critical: login-btn element not found');
        window.setLoading(false);
        return;
      }
      if (!userEmailDisplay) {
        console.error('âŒ Critical: user-email-display element not found');
        window.setLoading(false);
        return;
      }

      // Call existing initialization functions
      initLogin();

      // Main initialization logic (directly integrated)
      // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
      loginBtn.addEventListener('click', () => {
        try {
          handleLogin();
        } catch (error) {
          console.error('âŒ Login handler failed:', error);
          userEmailDisplay.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚';
          userEmailDisplay.classList.add('text-red-400');
        }
      });

      // ãƒ‰ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã®æ›´æ–°
      const domainInfo = await fetchDomainInfo();
      displayDomainInfo(domainInfo);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºã®åˆæœŸåŒ– (éåŒæœŸ - æœ€å¾Œã«å®Ÿè¡Œ)
      try {
        displayCurrentUserEmail();
      } catch (error) {
        console.error('Display user email failed:', error);
        if (!userEmailDisplay.dataset.emailSet) {
          setEmailDisplayDefault();
        }
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤
        window.setLoading(false);
        setLoginButtonState(false);
      }

      console.log('âœ… Login page initialization completed');
    } catch (error) {
      console.error('âŒ Initialization failed:', error);
      window.setLoading(false);

      // çµ±ä¸€ã•ã‚ŒãŸé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
      if (window.notifications) {
        window.notifications.error('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 10000);
      }

      // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªè¡¨ç¤ºã‚’ç¢ºä¿
      const userEmailDisplay = document.getElementById('user-email-display');
      if (userEmailDisplay) {
        userEmailDisplay.textContent = 'åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚';
        userEmailDisplay.classList.add('text-red-400');
      }

      const loginBtn = document.getElementById('login-btn');
      if (loginBtn) {
        loginBtn.disabled = false;
        loginBtn.textContent = 'ã¯ã˜ã‚ã‚‹';
      }
    }
  }

  function initLogin() {
    try {
      console.log('ğŸ”„ Fresh login experience initialization...');

      const loginBtn = document.getElementById('login-btn');
      const userEmailDisplay = document.getElementById('user-email-display');

      // âœ… ãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãªãƒ­ã‚°ã‚¤ãƒ³ä½“é¨“: å …ç‰¢ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰æ¸¡ã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ã‚’ç¢ºèªï¼ˆå®‰å…¨ãªå–å¾—ï¼‰
        let loginState = {};
        let isLogoutRedirect = false;
        let fallbackReason = null;

        // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å¤‰æ•°ã®å®‰å…¨ãªå–å¾—
        loginState = {};
        isLogoutRedirect = false;
        fallbackReason = null;

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰çŠ¶æ…‹ã‚’å¾©å…ƒ
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('logout') === 'true') {
          isLogoutRedirect = true;
        }
        if (urlParams.get('fallback')) {
          fallbackReason = urlParams.get('fallback');
        }

        console.log('ğŸ”„ Fresh login experience initialized', {
          loginState,
          isLogoutRedirect,
          fallbackReason
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
        if (isLogoutRedirect && userEmailDisplay) {
          let statusMessage = 'âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ–°ã—ããƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';

          if (fallbackReason) {
            if (fallbackReason.includes('server_error')) {
              statusMessage = 'âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã¯å®Œäº†ã—ã¾ã—ãŸã€‚';
            } else if (fallbackReason.includes('critical_error')) {
              statusMessage = 'ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚';
            }
          }

          userEmailDisplay.textContent = statusMessage;
          userEmailDisplay.classList.add('text-green-400');

          // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ - CLAUDE.md V8 compliant: Promise-based delay
          const createPromiseDelay = (ms) => new Promise(resolve => {
            const start = Date.now();
            const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
            check();
          });

          createPromiseDelay(3000).then(() => {
            if (userEmailDisplay) {
              userEmailDisplay.textContent = 'Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
              userEmailDisplay.classList.remove('text-green-400');
            }
          }).catch(() => {
            // Silent error handling for cleanup
          });
        }

        // âœ… ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œå…¨ã‚¯ãƒªã‚¢ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®ã¿ï¼‰
        if (isLogoutRedirect) {
          // ãƒšãƒ¼ã‚¸ãƒ¬ãƒ™ãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
          if ('caches' in window) {
            caches.keys().then(names => {
              names.forEach(name => {
                if (name.includes('login') || name.includes('admin')) {
                  caches.delete(name);
                }
              });
            }).catch(e => console.warn('Cache clear failed:', e));
          }

          // Service Worker ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
          if (navigator.serviceWorker && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
              command: 'clearCache',
              reason: 'logout_redirect'
            });
          }

          console.log('ğŸ§¹ Browser cache cleared for fresh login experience');
        }

      } catch (error) {
        console.warn('âš ï¸ Fresh login experience initialization failed:', error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’ç¶™ç¶š
      }

  }

    // registerAndRedirecté–¢æ•°å‰Šé™¤ - getLoginStatus()ã§è‡ªå‹•ç™»éŒ²ã‚’å®Ÿè¡Œ

  const processUnifiedLogin = () => {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler((response) => {
            if (!response || !response.success) {
              // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
              const errorMsg = response?.message || 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ';
              userEmailDisplay.textContent = errorMsg;
              userEmailDisplay.classList.add('text-red-400');
              reject(new Error(errorMsg));
              return;
            }

            // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ç®¡ç†ãƒ‘ãƒãƒ«URLã‚’æ±ºå®šã—ã¦è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            const adminUrl =
              response.adminUrl ||
              response.redirectUrl ||
              response.appUrl ||
              response.url ||
              '';

            if (typeof adminUrl === 'string' && adminUrl.trim().length > 0) {
              showAdminPanelRedirect(adminUrl, response.message);
            } else {
              console.error('processUnifiedLogin: ç®¡ç†URLãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', response);
              userEmailDisplay.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ç®¡ç†URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚';
              userEmailDisplay.classList.add('text-yellow-400');
              // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤
              window.setLoading(false);
              setLoginButtonState(false);
              // resolve to prevent further error flows
            }
            resolve();
          })
          .withFailureHandler((error) => {
            userEmailDisplay.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            userEmailDisplay.classList.add('text-red-400');
            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’çµ‚äº†
            window.setLoading(false);
            setLoginButtonState(false);
            reject(error);
          })
          .processLoginAction();
      });
    };

    // === ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¡¨ç¤ºç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ===

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºã‚’æ—¢å®šå€¤ã«ãƒªã‚»ãƒƒãƒˆ
    const setEmailDisplayDefault = () => {
      const userEmailDisplay = document.getElementById('user-email-display');
      if (!userEmailDisplay) return;
      userEmailDisplay.textContent = 'Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
      userEmailDisplay.classList.remove('text-red-400', 'text-yellow-400', 'text-blue-400');
      userEmailDisplay.dataset.emailSet = '';
    };

    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ãƒ»è¡¨ç¤ºï¼ˆGASå†…éƒ¨ä¸Šæ›¸ãä¿è­·ä»˜ãï¼‰
    const displayCurrentUserEmail = () => {
      const userEmailDisplay = document.getElementById('user-email-display');
      if (!userEmailDisplay) {
        console.error('âŒ userEmailDisplay element not found');
        return;
      }

      try {
        userEmailDisplay.textContent = 'ğŸ”„ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’ç¢ºèªä¸­...';

        google.script.run
          .withSuccessHandler((email) => {
            if (email && typeof email === 'string') {
              // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¡¨ç¤ºã®è¨­å®š
              const emailText = `ğŸ“§ ${email}`;
              userEmailDisplay.textContent = emailText;
              userEmailDisplay.classList.remove('text-red-400', 'text-yellow-400');
              userEmailDisplay.classList.add('text-blue-400');

              // ä¸Šæ›¸ãé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
              userEmailDisplay.dataset.emailSet = 'true';

              // GASå†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®ä¸Šæ›¸ãã‚’é˜²ãç›£è¦–æ©Ÿèƒ½
              const emailProtector = setInterval(() => {
                if (userEmailDisplay.dataset.emailSet === 'true' &&
                    userEmailDisplay.textContent !== emailText) {
                  userEmailDisplay.textContent = emailText;
                  userEmailDisplay.classList.remove('text-red-400', 'text-yellow-400');
                  userEmailDisplay.classList.add('text-blue-400');
                }
              }, 800);

              // 5ç§’å¾Œã«ç›£è¦–ã‚’åœæ­¢ï¼ˆGASå†…éƒ¨å‡¦ç†å®Œäº†å¾Œï¼‰ - CLAUDE.md V8 compliant: Promise-based delay
              const createPromiseDelay = (ms) => new Promise(resolve => {
                const start = Date.now();
                const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
                check();
              });

              createPromiseDelay(5000).then(() => clearInterval(emailProtector)).catch(() => {
                // Silent error handling
              });

              // æˆåŠŸæ™‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è§£é™¤
              window.setLoading(false);
              setLoginButtonState(false);

            } else {
              setEmailDisplayDefault();
              // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šæ™‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è§£é™¤
              window.setLoading(false);
              setLoginButtonState(false);
            }
          })
          .withFailureHandler((error) => {
            console.warn('Email fetch failed:', error.message);
            setEmailDisplayDefault();
            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’çµ‚äº†
            window.setLoading(false);
            setLoginButtonState(false);
          })
          .getCurrentEmail();
      } catch (error) {
        console.error('DisplayCurrentUserEmail error:', error);
        setEmailDisplayDefault();
        // Catch ãƒ–ãƒ­ãƒƒã‚¯ã§ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’çµ‚äº†
        window.setLoading(false);
        setLoginButtonState(false);
      }
    };

    // ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
    const handleLoginError = (err) => {
      console.error('Login error:', err);

      const displayMessage = err?.message ||
                            (typeof err === 'string' ? err : 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');

      // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šæ¸ˆã¿ã®å ´åˆã¯ä¸Šæ›¸ãã—ãªã„
      if (!userEmailDisplay.dataset.emailSet) {
        userEmailDisplay.textContent = displayMessage;
        userEmailDisplay.classList.add('text-red-400');
      }
      window.setLoading(false);
      setLoginButtonState(false);
    };

    // GASå†…è”µèªè¨¼ã‚’ä½¿ç”¨ã—ãŸç°¡æ˜“ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    const handleLogin = () => {
      try {
        window.setLoading(true, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç¢ºèªä¸­â€¦');
        setLoginButtonState(true, 'å‡¦ç†ä¸­');

        // URL ã‚·ã‚¹ãƒ†ãƒ ã®ãƒªã‚»ãƒƒãƒˆã‚’äº‹å‰ã«å®Ÿè¡Œ
        google.script.run
          .withSuccessHandler(() => {
            console.log('URL system reset completed');
            // çµ±åˆã•ã‚ŒãŸãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
            processUnifiedLogin().catch(handleLoginError);
          })
          .withFailureHandler((error) => {
            console.warn('URL system reset failed:', error);
            // ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¦ã‚‚ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã¯ç¶šè¡Œ
            processUnifiedLogin().catch(handleLoginError);
          })
          .forceUrlSystemReset();
      } catch (err) {
        console.error('Login function error:', err);
        userEmailDisplay.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼';
        window.setLoading(false);
      setLoginButtonState(false);
      }
    };

    // initializeMainLoginLogic function removed - logic integrated into main init() function

    /**
     * ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±è¡¨ç¤º - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸å°‚ç”¨
     */
    function displayDomainInfo(info) {
      const match = document.getElementById('header-domain-match');
      const mismatch = document.getElementById('header-domain-mismatch');
      const initial = document.getElementById('header-domain-initial');

      // å…¨ã¦éè¡¨ç¤º
      [match, mismatch, initial].forEach(element => {
        if (element) element.style.display = 'none';
      });

      if (info.error) return;

      if (info.isValidDomain) {
        if (match) {
          document.getElementById('header-domain-match-text').textContent = info.domain || 'å­¦æ ¡ãƒ‰ãƒ¡ã‚¤ãƒ³';
          match.style.display = 'block';
        }
      } else {
        if (mismatch) {
          document.getElementById('header-domain-mismatch-text').textContent = info.domain ? `å¤–éƒ¨: ${info.domain}` : 'å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹';
          mismatch.style.display = 'block';
        }
      }
    }

    /**
     * ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±å–å¾— - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸å°‚ç”¨
     */
    async function fetchDomainInfo() {
      if (!google?.script?.run?.getDeployUserDomainInfo) {
        return { isValidDomain: true, domain: 'unknown' };
      }

      try {
        return await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getDeployUserDomainInfo();
        });
      } catch (error) {
        console.error('Domain info fetch failed:', error);
        return { error: true };
      }
    }

  // âœ… CLAUDE.mdæº–æ‹ : DOM ready initialization pattern
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ï¼ˆ2025å¹´ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹æº–æ‹ ï¼‰- DOMContentLoadedå†…ã§å®šç¾©
    window.switchAccount = function() {
    const userEmailDisplay = document.getElementById('user-email-display');
    const switchBtn = document.getElementById('switch-account-btn');

    if (confirm('åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ãã¾ã™ã€‚\nãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ãŒæœ‰åŠ¹ãªå ´åˆã¯ã€ä¸€æ™‚çš„ã«ç„¡åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚')) {
      // UIçŠ¶æ…‹æ›´æ–°
      if (switchBtn) {
        switchBtn.disabled = true;
        switchBtn.textContent = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆä¸­...';
      }
      if (userEmailDisplay) {
        userEmailDisplay.textContent = 'ğŸ”„ åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã™...';
        userEmailDisplay.classList.remove('text-red-400', 'text-green-400');
        userEmailDisplay.classList.add('text-yellow-400');
      }

      console.log('ğŸ”„ Starting account switch process...');

      try {
        // Phase 1: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§Gmailãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’å®Ÿè¡Œ
        console.log('ğŸ“¤ Opening Gmail logout popup...');
        const logoutWindow = window.open(
          'https://mail.google.com/mail/?logout&hl=ja',
          'GoogleAccountSwitch',
          'width=500,height=400,menubar=no,status=no,location=no,toolbar=no,scrollbars=no,top=200,left=200'
        );

        if (!logoutWindow) {
          throw new Error('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
        }

        // Phase 2: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢ä¸è¦ï¼‰
        let timeoutId = setTimeout(() => {
          console.log('â° Popup timeout reached, closing popup...');

          // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
          if (logoutWindow && !logoutWindow.closed) {
            logoutWindow.close();
          }

          // Gmailãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†å¾Œã¯ç›´æ¥ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆresetAuthä¸è¦ï¼‰
          console.log('âœ… Gmail logout completed, reloading page...');
          if (userEmailDisplay) {
            userEmailDisplay.textContent = 'âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆå®Œäº†ï¼ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™...';
            userEmailDisplay.classList.remove('text-yellow-400');
            userEmailDisplay.classList.add('text-green-400');
          }

          setTimeout(() => {
            // GAS 2021å¹´ä»¥é™: window.open(_top) ã§ãƒªãƒ­ãƒ¼ãƒ‰
            window.open(window.location.href, '_top');
          }, 1000);
        }, 3500); // 3.5ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒæ‰‹å‹•ã§é–‰ã˜ã‚‰ã‚ŒãŸå ´åˆã®ç›£è¦–
        const checkClosed = setInterval(() => {
          if (logoutWindow.closed) {
            clearInterval(checkClosed);
            clearTimeout(timeoutId);
            console.log('ğŸ‘† Popup closed by user, proceeding with reload...');

            // ç›´æ¥ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯æ—¢ã«Gmailã§ã‚¯ãƒªã‚¢æ¸ˆã¿ï¼‰
            console.log('âœ… Gmail logout completed, reloading page...');
            if (userEmailDisplay) {
              userEmailDisplay.textContent = 'âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆå®Œäº†ï¼ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™...';
              userEmailDisplay.classList.remove('text-yellow-400');
              userEmailDisplay.classList.add('text-green-400');
            }

            setTimeout(() => {
              // GAS 2021å¹´ä»¥é™: window.open(_top) ã§ãƒªãƒ­ãƒ¼ãƒ‰
              window.open(window.location.href, '_top');
            }, 1000);
          }
        }, 500);

      } catch (error) {
        console.error('âŒ Popup failed:', error);

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
        if (userEmailDisplay) {
          userEmailDisplay.textContent = 'âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§ã®åˆ‡ã‚Šæ›¿ãˆãŒå¿…è¦ã§ã™ã€‚';
          userEmailDisplay.classList.remove('text-yellow-400');
          userEmailDisplay.classList.add('text-red-400');
        }

        if (switchBtn) {
          switchBtn.disabled = false;
          switchBtn.textContent = 'åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æŒ‡ç¤º
        setTimeout(() => {
          if (window.notifications) {
            window.notifications.warning(
              'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã«ã‚ˆã‚Šã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\næ‰‹å‹•ã§ã®åˆ‡ã‚Šæ›¿ãˆæ‰‹é †ï¼š\n1. æ–°ã—ã„ã‚¿ãƒ–ã§Gmailã‚’é–‹ã\n2. å³ä¸Šã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n3. ã€Œåˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ ã€ã¾ãŸã¯ã€Œãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ã‚’é¸æŠ\n4. ã“ã®ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„',
              10000
            );
          } else {
            alert(
              'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã«ã‚ˆã‚Šã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\næ‰‹å‹•ã§ã®åˆ‡ã‚Šæ›¿ãˆæ‰‹é †ï¼š\n1. æ–°ã—ã„ã‚¿ãƒ–ã§Gmailã‚’é–‹ã\n2. å³ä¸Šã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n3. ã€Œåˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ ã€ã¾ãŸã¯ã€Œãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ã‚’é¸æŠ\n4. ã“ã®ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„'
            );
          }
        }, 1000);
      }
    }
  }; // switchAccount function end


  // =============================================================================
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°å®šç¾©ï¼ˆDOMContentLoadedå¤–ã§å®šç¾©ï¼‰
  // =============================================================================

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡é–¢æ•° - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
  function showSecurityModal() {
    const modal = document.getElementById('security-modal');
    if (modal) {
      modal.style.animation = 'modalFade 0.3s ease-out';
      modal.classList.remove('hidden');

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      const modalContent = modal.querySelector('.glass-panel');
      if (modalContent) {
        modalContent.style.animation = 'modalScale 0.3s ease-out';
      }
    }
  }

  function closeSecurityModal() {
    const modal = document.getElementById('security-modal');
    if (modal) {
      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      modal.style.animation = 'fadeOut 0.2s ease-out';

      // CLAUDE.md V8 compliant: CSS transition completion event
      modal.addEventListener('animationend', () => {
        modal.classList.add('hidden');
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        modal.style.animation = '';
        const modalContent = modal.querySelector('.glass-panel');
        if (modalContent) {
          modalContent.style.animation = '';
        }
      }, { once: true });
    }
  }

  // =============================================================================
  // ç®¡ç†ãƒ‘ãƒãƒ«å³åº§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ©Ÿèƒ½ (ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ)
  // =============================================================================

  /**
   * Simple HTML escape function for XSS protection
   * @param {string} unsafe - Unsafe string
   * @returns {string} Escaped string
   */
  function escapeHtml(unsafe) {
    if (!unsafe || typeof unsafe !== 'string') return '';
    return unsafe
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  /**
   * ç®¡ç†ãƒ‘ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸç”»é¢ã‚’è¡¨ç¤º (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å¿…é ˆ)
   * @param {string} adminUrl - ç®¡ç†ãƒ‘ãƒãƒ«ã®URL
   * @param {string} message - è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   */
  function showAdminPanelRedirect(adminUrl, message) {
    try {
      // å¼•æ•°ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
      if (!adminUrl || typeof adminUrl !== 'string') {
        console.error('showAdminPanelRedirect: ç„¡åŠ¹ãªadminUrlãŒæ¸¡ã•ã‚Œã¾ã—ãŸ:', adminUrl);
        if (window.notifications) {
          window.notifications.error('ç®¡ç†ãƒ‘ãƒãƒ«ã®URLãŒç„¡åŠ¹ã§ã™ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 7000);
        } else {
          alert('ç®¡ç†ãƒ‘ãƒãƒ«ã®URLãŒç„¡åŠ¹ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
        return;
      }

      console.log('ç®¡ç†ãƒ‘ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸç”»é¢ã‚’è¡¨ç¤º:', adminUrl);

      // XSSå¯¾ç­–: ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
      const safeMessage = escapeHtml(message || 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ');
      const safeAdminUrl = escapeHtml(adminUrl);

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’åœæ­¢
      window.setLoading(false);
      setLoginButtonState(false);

      // ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åˆ¶é™æº–æ‹ : ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒªãƒƒã‚¯å¿…é ˆã®HTMLã‚¢ãƒ³ã‚«ãƒ¼æ–¹å¼
      const successHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>${safeMessage}</title>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <style>
            body { 
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: #1a1b26;
              min-height: 100vh;
              margin: 0;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 20px;
              position: relative;
              transition: background 2s ease-out;
            }
            body.success-transition {
              background: linear-gradient(135deg, #1a1b26 0%, #2a3d4a 30%, #1e3a3f 60%, #1a1b26 100%);
            }
            body::before {
              content: '';
              position: absolute;
              top: 0; left: 0; right: 0; bottom: 0;
              background-image: radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                                radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                                radial-gradient(circle at 40% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
              pointer-events: none;
              transition: background-image 2s ease-out, opacity 2s ease-out;
            }
            body.success-transition::before {
              background-image: radial-gradient(circle at 25% 25%, rgba(16, 185, 129, 0.15) 0%, transparent 60%),
                                radial-gradient(circle at 75% 75%, rgba(59, 130, 246, 0.15) 0%, transparent 60%),
                                radial-gradient(circle at 50% 50%, rgba(139, 233, 253, 0.1) 0%, transparent 70%);
              opacity: 0.8;
            }
            .container {
              background: rgba(26,27,38,0.7);
              backdrop-filter: blur(12px);
              border: 1px solid rgba(255,255,255,0.1);
              border-radius: 16px;
              padding: 2rem;
              max-width: 420px;
              width: 90%;
              min-height: 580px;
              max-height: 90vh;
              overflow-y: auto;
              text-align: center;
              box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
              position: relative;
              z-index: 1;
              animation: slideUp 0.6s ease-out;
            }
            /* Responsive design matching login panel breakpoints */
            @media (max-width: 640px) {
              .container {
                width: 95%;
                max-width: 380px;
                min-height: 520px;
                padding: 1.5rem;
              }
              .main-button {
                min-height: 48px;
                padding: 1rem 1.5rem;
                font-size: 16px;
              }
            }
            @media (max-width: 768px) {
              .container {
                padding: 1rem;
              }
            }
            @media (max-height: 700px) {
              .container {
                min-height: auto;
                max-height: 85vh;
              }
            }
            @media (min-width: 768px) {
              .container {
                padding: 2rem;
              }
            }
            @media (min-width: 1024px) {
              .container {
                max-width: 450px;
                padding: 2.5rem;
              }
            }
            @keyframes slideUp {
              0% { opacity: 0; transform: translateY(20px); }
              100% { opacity: 1; transform: translateY(0); }
            }
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            .icon { font-size: 64px; margin-bottom: 20px; }
            .title { 
              color: #10b981; 
              font-size: 24px; 
              font-weight: bold; 
              margin-bottom: 16px; 
            }
            .subtitle { 
              color: #d1d5db; 
              margin-bottom: 32px; 
              line-height: 1.5;
            }
            .main-button {
              display: inline-block;
              background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
              color: white;
              font-weight: bold;
              padding: 16px 32px;
              border-radius: 12px;
              text-decoration: none;
              font-size: 18px;
              transition: all 0.3s ease;
              margin-bottom: 24px;
              box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
              width: 100%;
              box-sizing: border-box;
            }
            .main-button:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
            }
            .url-info {
              background: rgba(17, 24, 39, 0.8);
              border-radius: 8px;
              padding: 16px;
              margin: 20px 0;
              border: 1px solid rgba(75, 85, 99, 0.5);
            }
            .url-label {
              color: #9ca3af;
              font-size: 12px;
              font-weight: 600;
              margin-bottom: 8px;
            }
            .url-text {
              color: #60a5fa;
              font-family: 'Courier New', monospace;
              font-size: 12px;
              word-break: break-all;
              line-height: 1.4;
              background: rgba(17, 24, 39, 0.8);
              padding: 8px;
              border-radius: 4px;
            }
            .copy-btn {
              margin-top: 8px;
              color: #3b82f6;
              background: none;
              border: none;
              font-size: 12px;
              text-decoration: underline;
              cursor: pointer;
            }
            .copy-btn:hover { color: #60a5fa; }
            .note {
              color: #9ca3af;
              font-size: 13px;
              margin-top: 20px;
              line-height: 1.5;
              text-align: left;
            }
            .note div {
              margin-bottom: 4px;
              word-break: keep-all;
              overflow-wrap: break-word;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="icon">âœ…</div>
            <h1 class="title">${safeMessage}</h1>
            <p class="subtitle">ç®¡ç†ãƒ‘ãƒãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„</p>

            <a href="${adminUrl}" class="main-button" id="admin-panel-btn" onclick="handleSingleClick(this)">
              <span id="admin-panel-btn-text">ğŸš€ ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã</span>
            </a>

            <div class="url-info">
              <div class="url-label">ğŸ“± ç®¡ç†ãƒ‘ãƒãƒ«URL:</div>
              <div class="url-text">${safeAdminUrl}</div>
              <button onclick="copyUrlToClipboard('${adminUrl}', this)" class="copy-btn">
                ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼
              </button>
            </div>
            
            <div class="note">
              <div class="mb-1">âœ“ ã“ã®ãƒªãƒ³ã‚¯ã¯å®‰å…¨ã§ã™</div>
              <div class="mb-1">âœ“ Google Apps Scriptå…¬å¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«æº–æ‹ </div>
              <div class="mb-1">ğŸ–±ï¸ ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç®¡ç†ãƒ‘ãƒãƒ«ã«ç§»å‹•ã—ã¦ãã ã•ã„</div>
              <div class="mb-1">ğŸ’¡ ã“ã®URLã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã™ã‚‹ã¨ã€æ¬¡å›ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™</div>
              <div>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€URLã¯ä»–äººã¨å…±æœ‰ã—ãªã„ã§ãã ã•ã„</div>
            </div>
          </div>
        </body>
        </html>
      `;

      // ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æˆåŠŸç”»é¢ã«å®Œå…¨ç½®æ›
      document.body.innerHTML = successHtml;

      // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªãƒ³ã‚¯æ–¹å¼ + äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
      console.log('âœ… ã‚·ãƒ³ãƒ—ãƒ«ãƒªãƒ³ã‚¯æ–¹å¼ - ç®¡ç†ãƒ‘ãƒãƒ«ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');

      // äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢å‡¦ç†
      window.handleSingleClick = function(buttonElement) {
        if (buttonElement.dataset.clicked === 'true') {
          console.log('äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢: æ—¢ã«ã‚¯ãƒªãƒƒã‚¯æ¸ˆã¿ã§ã™');
          return false;
        }

        // ã‚¯ãƒªãƒƒã‚¯çŠ¶æ…‹ã‚’è¨˜éŒ²
        buttonElement.dataset.clicked = 'true';

        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å¤‰æ›´
        const btnText = buttonElement.querySelector('#admin-panel-btn-text');
        if (btnText) {
          btnText.textContent = 'ğŸ”„ ç®¡ç†ãƒ‘ãƒãƒ«ã«ç§»å‹•ä¸­...';
        }
        buttonElement.style.opacity = '0.7';
        buttonElement.style.pointerEvents = 'none';

        console.log('ç®¡ç†ãƒ‘ãƒãƒ«ã«ç§»å‹•ã—ã¾ã™');
        return true; // ãƒªãƒ³ã‚¯ã®é€šå¸¸å‹•ä½œã‚’ç¶™ç¶š
      };

      // CLAUDE.md V8 compliant: requestIdleCallback for background transition
      requestIdleCallback(() => {
        document.body.classList.add('success-transition');
      }, { timeout: 300 });

      console.log('âœ… ã‚·ãƒ³ãƒ—ãƒ«ãƒªãƒ³ã‚¯ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
    } catch (error) {
      console.error('æˆåŠŸç”»é¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚·ãƒ³ãƒ—ãƒ«ãªconfirm
      const userChoice = confirm(
        `${message || 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ'}\\n\\nç®¡ç†ãƒ‘ãƒãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã‹ï¼Ÿ`
      );
      if (userChoice) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸå ´åˆã®ã¿ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
        const linkElement = document.createElement('a');
        linkElement.href = adminUrl;
        linkElement.target = '_top';
        linkElement.textContent = 'ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã';
        linkElement.style.cssText =
          'display:block;padding:20px;background:#4CAF50;color:white;text-align:center;text-decoration:none;margin:20px;border-radius:5px;';
        document.body.innerHTML = '';
        document.body.appendChild(linkElement);
      }
    }
  }

  /**
   * URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ (æˆåŠŸç”»é¢ç”¨)
   * @param {string} url - ã‚³ãƒ”ãƒ¼ã™ã‚‹URL
   * @param {HTMLElement} buttonElement - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³è¦ç´ 
   */
  window.copyUrlToClipboard = function (url, buttonElement) {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(url)
          .then(() => {
            // ä¸€æ™‚çš„ãªæˆåŠŸè¡¨ç¤º
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†!';
            buttonElement.disabled = true;
            // CLAUDE.md V8 compliant: Promise-based delay for button state reset
            const createPromiseDelay = (ms) => new Promise(resolve => {
              const start = Date.now();
              const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
              check();
            });

            createPromiseDelay(2000).then(() => {
              buttonElement.textContent = originalText;
              buttonElement.disabled = false;
            });
          })
          .catch((error) => {
            console.error('Clipboard API failed:', error);
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰‹å‹•ã‚³ãƒ”ãƒ¼ã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒœã‚¿ãƒ³ã®è¿‘ãã«è¡¨ç¤º
            const messageElement = document.createElement('span');
            messageElement.textContent = ' (æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)';
            messageElement.style.color = 'orange';
            buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
            // CLAUDE.md V8 compliant: Promise-based auto-removal for clipboard error
            const createPromiseDelay = (ms) => new Promise(resolve => {
              const start = Date.now();
              const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
              check();
            });

            createPromiseDelay(5000).then(() => messageElement.remove());
          });
      } else {
        // Clipboard APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        console.warn('Clipboard API not supported. Manual copy required.');
        const messageElement = document.createElement('span');
        messageElement.textContent =
          ' (ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚³ãƒ”ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)';
        messageElement.style.color = 'orange';
        buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
        // CLAUDE.md V8 compliant: Promise-based auto-removal for clipboard fallback
        const createPromiseDelay = (ms) => new Promise(resolve => {
          const start = Date.now();
          const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
          check();
        });

        createPromiseDelay(5000).then(() => messageElement.remove());
      }
    } catch (error) {
      console.error('copyUrlToClipboard error:', error);
      // äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
      const messageElement = document.createElement('span');
      messageElement.textContent = ' (ã‚³ãƒ”ãƒ¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ)';
      messageElement.style.color = 'red';
      buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
      // CLAUDE.md V8 compliant: Promise-based auto-removal for copy error
      const createPromiseDelay = (ms) => new Promise(resolve => {
        const start = Date.now();
        const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
        check();
      });

      createPromiseDelay(5000).then(() => messageElement.remove());
    }
  };

  // ç®¡ç†ãƒ‘ãƒãƒ«ã¸ã®é·ç§»ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
  function handleAdminPanelRedirect(event, adminUrl, buttonElement) {
    event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ³ã‚¯é·ç§»ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

    const buttonText = buttonElement.querySelector('#admin-panel-btn-text');
    const buttonSpinner = buttonElement.querySelector('#admin-panel-btn-spinner');

    if (buttonText) buttonText.classList.add('hidden');
    if (buttonSpinner) buttonSpinner.classList.remove('hidden');
    buttonElement.classList.add('cursor-not-allowed'); // ã‚«ãƒ¼ã‚½ãƒ«ã‚’å¤‰æ›´
    buttonElement.style.pointerEvents = 'none'; // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–
    buttonElement.setAttribute('aria-disabled', 'true'); // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç¢ºèªä¸­... ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã¯ã€ã“ã“ã§è¨­å®š
    // ä¾‹: buttonText.textContent = 'ç®¡ç†ãƒ‘ãƒãƒ«ã¸é·ç§»ä¸­...';

    // å®Ÿéš›ã®é·ç§»
    // GAS 2021å¹´ä»¥é™: window.open(_top) ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    window.open(adminUrl, '_top');
  }

  // âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±å–å¾—: SharedUtilities.htmlã®çµ±ä¸€é–¢æ•°ã‚’ä½¿ç”¨

  // âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±è¡¨ç¤º: SharedUtilities.htmlã®çµ±ä¸€é–¢æ•°ã‚’ä½¿ç”¨

</script>
