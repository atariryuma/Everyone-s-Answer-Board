<script>
  document.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.getElementById('login-btn');
    const userEmailDisplay = document.getElementById('user-email-display');
    let tokenClient;

    // UI状態管理 - 既存バックエンド関数の動作に合わせて最適化
    const setLoading = (flag, text = '') => {
      if (!loginBtn) return;
      loginBtn.disabled = flag;
      loginBtn.textContent = flag ? text || '処理中…' : 'はじめる';
    };

    // 既存のgetGoogleClientId()関数を使用
    const getClientId = () => {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(res => {
            if (res && res.clientId) {
              resolve(res.clientId);
            } else {
              reject(new Error('client id not found'));
            }
          })
          .withFailureHandler(reject)
          .getGoogleClientId();
      });
    };

    // 既存のgetExistingBoard()関数を使用 - 安定動作していた実装
    const fetchBoard = () => {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getExistingBoard();
      });
    };

    // 既存のregisterNewUser()関数を使用 - バックエンドが期待する引数形式
    const registerUser = () => {
      return new Promise((resolve, reject) => {
        const currentUserEmail = Session.getActiveUser().getEmail();
        google.script.run
          .withSuccessHandler(res => {
            if (res && res.adminUrl) {
              window.location.href = res.adminUrl;
              resolve();
            } else {
              reject(new Error('registration failed'));
            }
          })
          .withFailureHandler(reject)
          .registerNewUser(currentUserEmail);
      });
    };

    // GAS内蔵認証を使用した簡易ログイン処理
    const handleSimpleLogin = () => {
      setLoading(true, 'ユーザー情報確認中…');
      
      // バックエンドのgetExistingBoard()が返す3つの状態を処理
      fetchBoard()
        .then(res => {
          if (res.status === 'existing_user') {
            // 既存ユーザー: 直接管理画面へ
            window.location.href = res.adminUrl;
          } else if (res.status === 'setup_required') {
            // セットアップ必要: アプリ設定画面へ
            window.location.href = `/exec?mode=admin&userId=${res.userId}`;
          } else if (res.status === 'new_user') {
            // 新規ユーザー: 登録処理実行
            return registerUser();
          } else {
            throw new Error(res.message || 'unknown status');
          }
        })
        .catch(err => {
          console.error(err);
          userEmailDisplay.textContent = 'エラーが発生しました';
          setLoading(false);
        });
    };

    // 初期化処理 - 組織ポリシー制限を回避するため簡易認証を使用
    const init = () => {
      loginBtn.addEventListener('click', () => {
        // OAuth制限を回避して直接ログイン処理を実行
        handleSimpleLogin();
      });

      // OAuth設定は省略し、直接初期化完了
      setLoading(false);

      // 既存のgetSystemDomainInfo()で組織情報表示
      google.script.run
        .withSuccessHandler(info => {
          if (info && info.adminDomain) {
            const orgNameEl = document.getElementById('organization-name');
            const orgInfoEl = document.getElementById('organization-info');
            if (orgNameEl && orgInfoEl) {
              orgNameEl.textContent = info.adminDomain;
              orgInfoEl.classList.remove('hidden');
            }
          }
        })
        .getSystemDomainInfo();
    };

    setLoading(true, '読み込み中…');
    init();
  });
</script>

