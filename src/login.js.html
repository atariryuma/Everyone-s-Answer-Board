<script>

  function setLoginButtonState(disabled, text = 'ã¯ã˜ã‚ã‚‹') {
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
      loginBtn.disabled = disabled;
      loginBtn.textContent = text;
    }
  }

  async function init() {
    try {

      window.setLoading(true, 'èª­ã¿è¾¼ã¿ä¸­â€¦');
      setLoginButtonState(true, 'èª­ã¿è¾¼ã¿ä¸­');

      const loginBtn = document.getElementById('login-btn');
      const userEmailDisplay = document.getElementById('user-email-display');

      if (!loginBtn) {
        console.error('âŒ Critical: login-btn element not found');
        window.setLoading(false);
        return;
      }
      if (!userEmailDisplay) {
        console.error('âŒ Critical: user-email-display element not found');
        window.setLoading(false);
        return;
      }

      initLogin();

      loginBtn.addEventListener('click', () => {
        try {
          handleLogin();
        } catch (error) {
          console.error('âŒ Login handler failed:', error);
          userEmailDisplay.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚';
          userEmailDisplay.classList.add('text-red-400');
        }
      });

      const domainInfo = await fetchDomainInfo();
      displayDomainInfo(domainInfo);

      try {
        displayCurrentUserEmail();
      } catch (error) {
        console.error('Display user email failed:', error);
        if (!userEmailDisplay.dataset.emailSet) {
          setEmailDisplayDefault();
        }
        window.setLoading(false);
        setLoginButtonState(false);
      }

    } catch (error) {
      console.error('âŒ Initialization failed:', error);
      window.setLoading(false);

      if (window.notifications) {
        window.notifications.error('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 10000);
      }

      const userEmailDisplay = document.getElementById('user-email-display');
      if (userEmailDisplay) {
        userEmailDisplay.textContent = 'åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚';
        userEmailDisplay.classList.add('text-red-400');
      }

      const loginBtn = document.getElementById('login-btn');
      if (loginBtn) {
        loginBtn.disabled = false;
        loginBtn.textContent = 'ã¯ã˜ã‚ã‚‹';
      }
    }
  }

  function initLogin() {
    try {

      const loginBtn = document.getElementById('login-btn');
      const userEmailDisplay = document.getElementById('user-email-display');

        let loginState = {};
        let isLogoutRedirect = false;
        let fallbackReason = null;

        loginState = {};
        isLogoutRedirect = false;
        fallbackReason = null;

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('logout') === 'true') {
          isLogoutRedirect = true;
        }
        if (urlParams.get('fallback')) {
          fallbackReason = urlParams.get('fallback');
        }

        if (isLogoutRedirect && userEmailDisplay) {
          let statusMessage = 'âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ–°ã—ããƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';

          if (fallbackReason) {
            if (fallbackReason.includes('server_error')) {
              statusMessage = 'âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã¯å®Œäº†ã—ã¾ã—ãŸã€‚';
            } else if (fallbackReason.includes('critical_error')) {
              statusMessage = 'ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚';
            }
          }

          userEmailDisplay.textContent = statusMessage;
          userEmailDisplay.classList.add('text-green-400');

          const createPromiseDelay = (ms) => new Promise(resolve => {
            const start = Date.now();
            const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
            check();
          });

          createPromiseDelay(3000).then(() => {
            if (userEmailDisplay) {
              userEmailDisplay.textContent = 'Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
              userEmailDisplay.classList.remove('text-green-400');
            }
          }).catch(() => {
          });
        }

        if (isLogoutRedirect) {
          if ('caches' in window) {
            caches.keys().then(names => {
              names.forEach(name => {
                if (name.includes('login') || name.includes('admin')) {
                  caches.delete(name);
                }
              });
            }).catch(e => console.warn('Cache clear failed:', e));
          }

          if (navigator.serviceWorker && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
              command: 'clearCache',
              reason: 'logout_redirect'
            });
          }

        }

      } catch (error) {
        console.warn('âš ï¸ Fresh login experience initialization failed:', error);
      }

  }


  const processUnifiedLogin = () => {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler((response) => {
            if (!response || !response.success) {
              const errorMsg = response?.message || 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ';
              userEmailDisplay.textContent = errorMsg;
              userEmailDisplay.classList.add('text-red-400');
              reject(new Error(errorMsg));
              return;
            }

            const adminUrl =
              response.adminUrl ||
              response.redirectUrl ||
              response.appUrl ||
              response.url ||
              '';

            if (typeof adminUrl === 'string' && adminUrl.trim().length > 0) {
              showAdminPanelRedirect(adminUrl, response.message);
            } else {
              console.error('processUnifiedLogin: ç®¡ç†URLãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', response);
              userEmailDisplay.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ç®¡ç†URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚';
              userEmailDisplay.classList.add('text-yellow-400');
              window.setLoading(false);
              setLoginButtonState(false);
            }
            resolve();
          })
          .withFailureHandler((error) => {
            userEmailDisplay.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            userEmailDisplay.classList.add('text-red-400');
            window.setLoading(false);
            setLoginButtonState(false);
            reject(error);
          })
          .processLoginAction();
      });
    };


    const setEmailDisplayDefault = () => {
      const userEmailDisplay = document.getElementById('user-email-display');
      if (!userEmailDisplay) return;
      userEmailDisplay.textContent = 'Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
      userEmailDisplay.classList.remove('text-red-400', 'text-yellow-400', 'text-blue-400');
      userEmailDisplay.dataset.emailSet = '';
    };

    const displayCurrentUserEmail = () => {
      const userEmailDisplay = document.getElementById('user-email-display');
      if (!userEmailDisplay) {
        console.error('âŒ userEmailDisplay element not found');
        return;
      }

      try {
        userEmailDisplay.textContent = 'ğŸ”„ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’ç¢ºèªä¸­...';

        google.script.run
          .withSuccessHandler((email) => {
            if (email && typeof email === 'string') {
              const emailText = `ğŸ“§ ${email}`;
              userEmailDisplay.textContent = emailText;
              userEmailDisplay.classList.remove('text-red-400', 'text-yellow-400');
              userEmailDisplay.classList.add('text-blue-400');

              userEmailDisplay.dataset.emailSet = 'true';

              const emailProtector = setInterval(() => {
                if (userEmailDisplay.dataset.emailSet === 'true' &&
                    userEmailDisplay.textContent !== emailText) {
                  userEmailDisplay.textContent = emailText;
                  userEmailDisplay.classList.remove('text-red-400', 'text-yellow-400');
                  userEmailDisplay.classList.add('text-blue-400');
                }
              }, 800);

              const createPromiseDelay = (ms) => new Promise(resolve => {
                const start = Date.now();
                const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
                check();
              });

              createPromiseDelay(5000).then(() => clearInterval(emailProtector)).catch(() => {
              });

              window.setLoading(false);
              setLoginButtonState(false);

            } else {
              setEmailDisplayDefault();
              window.setLoading(false);
              setLoginButtonState(false);
            }
          })
          .withFailureHandler((error) => {
            console.warn('Email fetch failed:', error.message);
            setEmailDisplayDefault();
            window.setLoading(false);
            setLoginButtonState(false);
          })
          .getCurrentEmail();
      } catch (error) {
        console.error('DisplayCurrentUserEmail error:', error);
        setEmailDisplayDefault();
        window.setLoading(false);
        setLoginButtonState(false);
      }
    };

    const handleLoginError = (err) => {
      console.error('Login error:', err);

      const displayMessage = err?.message ||
                            (typeof err === 'string' ? err : 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');

      if (!userEmailDisplay.dataset.emailSet) {
        userEmailDisplay.textContent = displayMessage;
        userEmailDisplay.classList.add('text-red-400');
      }
      window.setLoading(false);
      setLoginButtonState(false);
    };

    const handleLogin = () => {
      try {
        window.setLoading(true, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç¢ºèªä¸­â€¦');
        setLoginButtonState(true, 'å‡¦ç†ä¸­');

        google.script.run
          .withSuccessHandler(() => {
            processUnifiedLogin().catch(handleLoginError);
          })
          .withFailureHandler((error) => {
            console.warn('URL system reset failed:', error);
            processUnifiedLogin().catch(handleLoginError);
          })
          .forceUrlSystemReset();
      } catch (err) {
        console.error('Login function error:', err);
        userEmailDisplay.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼';
        window.setLoading(false);
      setLoginButtonState(false);
      }
    };


    /**
     * ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±è¡¨ç¤º - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸å°‚ç”¨
     */
    function displayDomainInfo(info) {
      const match = document.getElementById('header-domain-match');
      const mismatch = document.getElementById('header-domain-mismatch');
      const initial = document.getElementById('header-domain-initial');

      [match, mismatch, initial].forEach(element => {
        if (element) element.style.display = 'none';
      });

      if (info.error) return;

      if (info.isValidDomain) {
        if (match) {
          document.getElementById('header-domain-match-text').textContent = info.domain || 'å­¦æ ¡ãƒ‰ãƒ¡ã‚¤ãƒ³';
          match.style.display = 'block';
        }
      } else {
        if (mismatch) {
          document.getElementById('header-domain-mismatch-text').textContent = info.domain ? `å¤–éƒ¨: ${info.domain}` : 'å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹';
          mismatch.style.display = 'block';
        }
      }
    }

    /**
     * ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±å–å¾— - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸å°‚ç”¨
     */
    async function fetchDomainInfo() {
      if (!google?.script?.run?.getDeployUserDomainInfo) {
        return { isValidDomain: true, domain: 'unknown' };
      }

      try {
        return await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getDeployUserDomainInfo();
        });
      } catch (error) {
        console.error('Domain info fetch failed:', error);
        return { error: true };
      }
    }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

    window.switchAccount = function() {
    const userEmailDisplay = document.getElementById('user-email-display');
    const switchBtn = document.getElementById('switch-account-btn');

    if (confirm('åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ãã¾ã™ã€‚\nãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ãŒæœ‰åŠ¹ãªå ´åˆã¯ã€ä¸€æ™‚çš„ã«ç„¡åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚')) {
      if (switchBtn) {
        switchBtn.disabled = true;
        switchBtn.textContent = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆä¸­...';
      }
      if (userEmailDisplay) {
        userEmailDisplay.textContent = 'ğŸ”„ åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã™...';
        userEmailDisplay.classList.remove('text-red-400', 'text-green-400');
        userEmailDisplay.classList.add('text-yellow-400');
      }


      try {
        const logoutWindow = window.open(
          'https://mail.google.com/mail/?logout&hl=ja',
          'GoogleAccountSwitch',
          'width=500,height=400,menubar=no,status=no,location=no,toolbar=no,scrollbars=no,top=200,left=200'
        );

        if (!logoutWindow) {
          throw new Error('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
        }

        let timeoutId = setTimeout(() => {

          if (logoutWindow && !logoutWindow.closed) {
            logoutWindow.close();
          }

          if (userEmailDisplay) {
            userEmailDisplay.textContent = 'âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆå®Œäº†ï¼ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™...';
            userEmailDisplay.classList.remove('text-yellow-400');
            userEmailDisplay.classList.add('text-green-400');
          }

          setTimeout(() => {
            window.open(window.location.href, '_top');
          }, 1000);
        }, 3500); // 3.5ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

        const checkClosed = setInterval(() => {
          if (logoutWindow.closed) {
            clearInterval(checkClosed);
            clearTimeout(timeoutId);

            if (userEmailDisplay) {
              userEmailDisplay.textContent = 'âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆå®Œäº†ï¼ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™...';
              userEmailDisplay.classList.remove('text-yellow-400');
              userEmailDisplay.classList.add('text-green-400');
            }

            setTimeout(() => {
              window.open(window.location.href, '_top');
            }, 1000);
          }
        }, 500);

      } catch (error) {
        console.error('âŒ Popup failed:', error);

        if (userEmailDisplay) {
          userEmailDisplay.textContent = 'âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§ã®åˆ‡ã‚Šæ›¿ãˆãŒå¿…è¦ã§ã™ã€‚';
          userEmailDisplay.classList.remove('text-yellow-400');
          userEmailDisplay.classList.add('text-red-400');
        }

        if (switchBtn) {
          switchBtn.disabled = false;
          switchBtn.textContent = 'åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³';
        }

        setTimeout(() => {
          if (window.notifications) {
            window.notifications.warning(
              'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã«ã‚ˆã‚Šã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\næ‰‹å‹•ã§ã®åˆ‡ã‚Šæ›¿ãˆæ‰‹é †ï¼š\n1. æ–°ã—ã„ã‚¿ãƒ–ã§Gmailã‚’é–‹ã\n2. å³ä¸Šã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n3. ã€Œåˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ ã€ã¾ãŸã¯ã€Œãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ã‚’é¸æŠ\n4. ã“ã®ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„',
              10000
            );
          } else {
            alert(
              'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã«ã‚ˆã‚Šã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\næ‰‹å‹•ã§ã®åˆ‡ã‚Šæ›¿ãˆæ‰‹é †ï¼š\n1. æ–°ã—ã„ã‚¿ãƒ–ã§Gmailã‚’é–‹ã\n2. å³ä¸Šã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n3. ã€Œåˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ ã€ã¾ãŸã¯ã€Œãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ã‚’é¸æŠ\n4. ã“ã®ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„'
            );
          }
        }, 1000);
      }
    }
  }; // switchAccount function end



  function showSecurityModal() {
    const modal = document.getElementById('security-modal');
    if (modal) {
      modal.style.animation = 'modalFade 0.3s ease-out';
      modal.classList.remove('hidden');

      const modalContent = modal.querySelector('.glass-panel');
      if (modalContent) {
        modalContent.style.animation = 'modalScale 0.3s ease-out';
      }
    }
  }

  function closeSecurityModal() {
    const modal = document.getElementById('security-modal');
    if (modal) {
      modal.style.animation = 'fadeOut 0.2s ease-out';

      modal.addEventListener('animationend', () => {
        modal.classList.add('hidden');
        modal.style.animation = '';
        const modalContent = modal.querySelector('.glass-panel');
        if (modalContent) {
          modalContent.style.animation = '';
        }
      }, { once: true });
    }
  }


  /**
   * Simple HTML escape function for XSS protection
   * @param {string} unsafe - Unsafe string
   * @returns {string} Escaped string
   */
  function escapeHtml(unsafe) {
    if (!unsafe || typeof unsafe !== 'string') return '';
    return unsafe
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  /**
   * ç®¡ç†ãƒ‘ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸç”»é¢ã‚’è¡¨ç¤º (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å¿…é ˆ)
   * @param {string} adminUrl - ç®¡ç†ãƒ‘ãƒãƒ«ã®URL
   * @param {string} message - è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   */
  function showAdminPanelRedirect(adminUrl, message) {
    try {
      if (!adminUrl || typeof adminUrl !== 'string') {
        console.error('showAdminPanelRedirect: ç„¡åŠ¹ãªadminUrlãŒæ¸¡ã•ã‚Œã¾ã—ãŸ:', adminUrl);
        if (window.notifications) {
          window.notifications.error('ç®¡ç†ãƒ‘ãƒãƒ«ã®URLãŒç„¡åŠ¹ã§ã™ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 7000);
        } else {
          alert('ç®¡ç†ãƒ‘ãƒãƒ«ã®URLãŒç„¡åŠ¹ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
        return;
      }


      const safeMessage = escapeHtml(message || 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ');
      const safeAdminUrl = escapeHtml(adminUrl);

      window.setLoading(false);
      setLoginButtonState(false);

      const successHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>${safeMessage}</title>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <style>
            body { 
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: #1a1b26;
              min-height: 100vh;
              margin: 0;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 20px;
              position: relative;
              transition: background 2s ease-out;
            }
            body.success-transition {
              background: linear-gradient(135deg, #1a1b26 0%, #2a3d4a 30%, #1e3a3f 60%, #1a1b26 100%);
            }
            body::before {
              content: '';
              position: absolute;
              top: 0; left: 0; right: 0; bottom: 0;
              background-image: radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                                radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                                radial-gradient(circle at 40% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
              pointer-events: none;
              transition: background-image 2s ease-out, opacity 2s ease-out;
            }
            body.success-transition::before {
              background-image: radial-gradient(circle at 25% 25%, rgba(16, 185, 129, 0.15) 0%, transparent 60%),
                                radial-gradient(circle at 75% 75%, rgba(59, 130, 246, 0.15) 0%, transparent 60%),
                                radial-gradient(circle at 50% 50%, rgba(139, 233, 253, 0.1) 0%, transparent 70%);
              opacity: 0.8;
            }
            .container {
              background: rgba(26,27,38,0.7);
              backdrop-filter: blur(12px);
              border: 1px solid rgba(255,255,255,0.1);
              border-radius: 16px;
              padding: 2rem;
              max-width: 420px;
              width: 90%;
              min-height: 580px;
              max-height: 90vh;
              overflow-y: auto;
              text-align: center;
              box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
              position: relative;
              z-index: 1;
              animation: slideUp 0.6s ease-out;
            }
            /* Responsive design matching login panel breakpoints */
            @media (max-width: 640px) {
              .container {
                width: 95%;
                max-width: 380px;
                min-height: 520px;
                padding: 1.5rem;
              }
              .main-button {
                min-height: 48px;
                padding: 1rem 1.5rem;
                font-size: 16px;
              }
            }
            @media (max-width: 768px) {
              .container {
                padding: 1rem;
              }
            }
            @media (max-height: 700px) {
              .container {
                min-height: auto;
                max-height: 85vh;
              }
            }
            @media (min-width: 768px) {
              .container {
                padding: 2rem;
              }
            }
            @media (min-width: 1024px) {
              .container {
                max-width: 450px;
                padding: 2.5rem;
              }
            }
            @keyframes slideUp {
              0% { opacity: 0; transform: translateY(20px); }
              100% { opacity: 1; transform: translateY(0); }
            }
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            .icon { font-size: 64px; margin-bottom: 20px; }
            .title { 
              color: #10b981; 
              font-size: 24px; 
              font-weight: bold; 
              margin-bottom: 16px; 
            }
            .subtitle { 
              color: #d1d5db; 
              margin-bottom: 32px; 
              line-height: 1.5;
            }
            .main-button {
              display: inline-block;
              background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
              color: white;
              font-weight: bold;
              padding: 16px 32px;
              border-radius: 12px;
              text-decoration: none;
              font-size: 18px;
              transition: all 0.3s ease;
              margin-bottom: 24px;
              box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
              width: 100%;
              box-sizing: border-box;
            }
            .main-button:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
            }
            .url-info {
              background: rgba(17, 24, 39, 0.8);
              border-radius: 8px;
              padding: 16px;
              margin: 20px 0;
              border: 1px solid rgba(75, 85, 99, 0.5);
            }
            .url-label {
              color: #9ca3af;
              font-size: 12px;
              font-weight: 600;
              margin-bottom: 8px;
            }
            .url-text {
              color: #60a5fa;
              font-family: 'Courier New', monospace;
              font-size: 12px;
              word-break: break-all;
              line-height: 1.4;
              background: rgba(17, 24, 39, 0.8);
              padding: 8px;
              border-radius: 4px;
            }
            .copy-btn {
              margin-top: 8px;
              color: #3b82f6;
              background: none;
              border: none;
              font-size: 12px;
              text-decoration: underline;
              cursor: pointer;
            }
            .copy-btn:hover { color: #60a5fa; }
            .note {
              color: #9ca3af;
              font-size: 13px;
              margin-top: 20px;
              line-height: 1.5;
              text-align: left;
            }
            .note div {
              margin-bottom: 4px;
              word-break: keep-all;
              overflow-wrap: break-word;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="icon">âœ…</div>
            <h1 class="title">${safeMessage}</h1>
            <p class="subtitle">ç®¡ç†ãƒ‘ãƒãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„</p>

            <a href="${adminUrl}" class="main-button" id="admin-panel-btn" onclick="handleSingleClick(this)">
              <span id="admin-panel-btn-text">ğŸš€ ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã</span>
            </a>

            <div class="url-info">
              <div class="url-label">ğŸ“± ç®¡ç†ãƒ‘ãƒãƒ«URL:</div>
              <div class="url-text">${safeAdminUrl}</div>
              <button onclick="copyUrlToClipboard('${adminUrl}', this)" class="copy-btn">
                ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼
              </button>
            </div>
            
            <div class="note">
              <div class="mb-1">âœ“ ã“ã®ãƒªãƒ³ã‚¯ã¯å®‰å…¨ã§ã™</div>
              <div class="mb-1">âœ“ Google Apps Scriptå…¬å¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«æº–æ‹ </div>
              <div class="mb-1">ğŸ–±ï¸ ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç®¡ç†ãƒ‘ãƒãƒ«ã«ç§»å‹•ã—ã¦ãã ã•ã„</div>
              <div class="mb-1">ğŸ’¡ ã“ã®URLã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã™ã‚‹ã¨ã€æ¬¡å›ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™</div>
              <div>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€URLã¯ä»–äººã¨å…±æœ‰ã—ãªã„ã§ãã ã•ã„</div>
            </div>
          </div>
        </body>
        </html>
      `;

      document.body.innerHTML = successHtml;


      window.handleSingleClick = function(buttonElement) {
        if (buttonElement.dataset.clicked === 'true') {
          return false;
        }

        buttonElement.dataset.clicked = 'true';

        const btnText = buttonElement.querySelector('#admin-panel-btn-text');
        if (btnText) {
          btnText.textContent = 'ğŸ”„ ç®¡ç†ãƒ‘ãƒãƒ«ã«ç§»å‹•ä¸­...';
        }
        buttonElement.style.opacity = '0.7';
        buttonElement.style.pointerEvents = 'none';

        return true; // ãƒªãƒ³ã‚¯ã®é€šå¸¸å‹•ä½œã‚’ç¶™ç¶š
      };

      requestIdleCallback(() => {
        document.body.classList.add('success-transition');
      }, { timeout: 300 });

    } catch (error) {
      console.error('æˆåŠŸç”»é¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
      const userChoice = confirm(
        `${message || 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ'}\\n\\nç®¡ç†ãƒ‘ãƒãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã‹ï¼Ÿ`
      );
      if (userChoice) {
        const linkElement = document.createElement('a');
        linkElement.href = adminUrl;
        linkElement.target = '_top';
        linkElement.textContent = 'ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã';
        linkElement.style.cssText =
          'display:block;padding:20px;background:#4CAF50;color:white;text-align:center;text-decoration:none;margin:20px;border-radius:5px;';
        document.body.innerHTML = '';
        document.body.appendChild(linkElement);
      }
    }
  }

  /**
   * URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ (æˆåŠŸç”»é¢ç”¨)
   * @param {string} url - ã‚³ãƒ”ãƒ¼ã™ã‚‹URL
   * @param {HTMLElement} buttonElement - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³è¦ç´ 
   */
  window.copyUrlToClipboard = function (url, buttonElement) {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(url)
          .then(() => {
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†!';
            buttonElement.disabled = true;
            const createPromiseDelay = (ms) => new Promise(resolve => {
              const start = Date.now();
              const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
              check();
            });

            createPromiseDelay(2000).then(() => {
              buttonElement.textContent = originalText;
              buttonElement.disabled = false;
            });
          })
          .catch((error) => {
            console.error('Clipboard API failed:', error);
            const messageElement = document.createElement('span');
            messageElement.textContent = ' (æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)';
            messageElement.style.color = 'orange';
            buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
            const createPromiseDelay = (ms) => new Promise(resolve => {
              const start = Date.now();
              const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
              check();
            });

            createPromiseDelay(5000).then(() => messageElement.remove());
          });
      } else {
        console.warn('Clipboard API not supported. Manual copy required.');
        const messageElement = document.createElement('span');
        messageElement.textContent =
          ' (ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚³ãƒ”ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)';
        messageElement.style.color = 'orange';
        buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
        const createPromiseDelay = (ms) => new Promise(resolve => {
          const start = Date.now();
          const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
          check();
        });

        createPromiseDelay(5000).then(() => messageElement.remove());
      }
    } catch (error) {
      console.error('copyUrlToClipboard error:', error);
      const messageElement = document.createElement('span');
      messageElement.textContent = ' (ã‚³ãƒ”ãƒ¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ)';
      messageElement.style.color = 'red';
      buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
      const createPromiseDelay = (ms) => new Promise(resolve => {
        const start = Date.now();
        const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
        check();
      });

      createPromiseDelay(5000).then(() => messageElement.remove());
    }
  };

  function handleAdminPanelRedirect(event, adminUrl, buttonElement) {
    event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ³ã‚¯é·ç§»ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

    const buttonText = buttonElement.querySelector('#admin-panel-btn-text');
    const buttonSpinner = buttonElement.querySelector('#admin-panel-btn-spinner');

    if (buttonText) buttonText.classList.add('hidden');
    if (buttonSpinner) buttonSpinner.classList.remove('hidden');
    buttonElement.classList.add('cursor-not-allowed'); // ã‚«ãƒ¼ã‚½ãƒ«ã‚’å¤‰æ›´
    buttonElement.style.pointerEvents = 'none'; // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–
    buttonElement.setAttribute('aria-disabled', 'true'); // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ


    window.open(adminUrl, '_top');
  }



</script>
