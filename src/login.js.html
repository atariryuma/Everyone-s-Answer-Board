<script>
  // Login Page JavaScript
  
  let googleAccountsClient;
  let isLoading = false;
  
  // Initialize login page
  function initializeLoginPage() {
    setLoading(true, 'Googleアカウントの情報を確認しています...');
    
    // Wait for Google Identity Services to load
    const checkGoogleAPI = setInterval(() => {
      if (typeof google !== 'undefined' && google.accounts) {
        clearInterval(checkGoogleAPI);
        initializeGoogleAuth();
      }
    }, 100);
  }
  
  // Initialize Google OAuth client
  function initializeGoogleAuth() {
    try {
      googleAccountsClient = google.accounts.oauth2.initTokenClient({
        client_id: '<?= GOOGLE_CLIENT_ID ?>',
        scope: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
        callback: handleCredentialResponse,
      });
      
      // Get server-side domain information
      getServerSideInfo();
    } catch (error) {
      console.error('Google Auth initialization error:', error);
      setLoading(false, 'Google認証の初期化に失敗しました');
    }
  }
  
  // Get server-side domain information
  function getServerSideInfo() {
    google.script.run
      .withSuccessHandler(serverInfo => {
        // Check if user is already authenticated
        const token = gapi.client.getToken();
        if (token) {
          updateUserInfo(token.access_token, serverInfo);
        } else {
          // User needs to login
          setLoading(false, '認証が必要です');
          requestUserLogin();
        }
      })
      .withFailureHandler(handleError)
      .getSystemDomainInfo();
  }
  
  // Update user information display
  function updateUserInfo(accessToken, serverInfo) {
    fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${accessToken}`)
      .then(response => response.json())
      .then(userInfo => {
        if (userInfo.email) {
          // Update email display
          document.getElementById('user-email-display').textContent = userInfo.email;
          
          // Check domain match
          const userDomain = userInfo.email.split('@')[1];
          const isAdminDomain = userDomain === serverInfo.adminDomain;
          
          // Display domain status
          displayDomainStatus(isAdminDomain, serverInfo.adminDomain);
          
          // Enable login button
          document.getElementById('login-btn').disabled = false;
          setLoading(false);
        } else {
          throw new Error('ユーザー情報の取得に失敗しました');
        }
      })
      .catch(error => {
        console.error('User info fetch error:', error);
        handleError(error);
      });
  }
  
  // Display domain status badge
  function displayDomainStatus(isMatch, adminDomain) {
    const badgeEl = document.getElementById('domain-status-badge');
    const badgeClass = isMatch ? 'match' : 'mismatch';
    const icon = isMatch ? 
      '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
      '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>';
    
    const text = isMatch ? 
      `${adminDomain} ドメインに所属` : 
      `管理ドメイン(${adminDomain})と不一致`;
    
    badgeEl.innerHTML = `
      <div class="domain-badge ${badgeClass}">
        ${icon}
        <span>${text}</span>
      </div>
    `;
    badgeEl.classList.remove('hidden');
  }
  
  // Request user login
  function requestUserLogin() {
    if (googleAccountsClient) {
      googleAccountsClient.requestAccessToken({ prompt: 'consent' });
    } else {
      handleError(new Error('Google認証クライアントが初期化されていません'));
    }
  }
  
  // Handle credential response
  function handleCredentialResponse(response) {
    if (response.error) {
      console.error('Authentication error:', response.error);
      handleError(response);
      return;
    }
    
    // Refresh server-side info after successful authentication
    getServerSideInfo();
  }
  
  // Set loading state
  function setLoading(loading, message = '') {
    isLoading = loading;
    const loginBtn = document.getElementById('login-btn');
    const userEmailDisplay = document.getElementById('user-email-display');
    
    if (loading) {
      loginBtn.disabled = true;
      loginBtn.innerHTML = `
        <div class="loading-spinner"></div>
        ${message || 'ログイン中...'}
      `;
      userEmailDisplay.textContent = message || '認証中...';
    } else {
      loginBtn.disabled = false;
      loginBtn.innerHTML = 'ログイン';
      if (!message) {
        userEmailDisplay.textContent = '-';
      }
    }
  }
  
  // Handle errors
  function handleError(error) {
    console.error('Login error:', error);
    setLoading(false);
    
    const userEmailDisplay = document.getElementById('user-email-display');
    userEmailDisplay.textContent = 'エラーが発生しました';
    
    // Show error message temporarily
    const loginBtn = document.getElementById('login-btn');
    loginBtn.innerHTML = 'エラー - 再試行';
    loginBtn.disabled = false;
    
    // Reset after 3 seconds
    setTimeout(() => {
      loginBtn.innerHTML = 'ログイン';
      userEmailDisplay.textContent = '-';
    }, 3000);
  }
  
  // Account switching
  function switchAccount() {
    if (googleAccountsClient) {
      setLoading(true, 'アカウントを切り替えています...');
      googleAccountsClient.requestAccessToken({ prompt: 'select_account' });
    }
  }
  
  // Login button handler
  function handleLogin() {
    if (isLoading) return;
    
    const userEmail = document.getElementById('user-email-display').textContent;
    if (userEmail && userEmail !== '-' && userEmail !== 'エラーが発生しました') {
      setLoading(true, '管理パネルにリダイレクトしています...');
      
      // Redirect to admin panel
      window.location.href = '/exec';
    } else {
      // Request authentication
      requestUserLogin();
    }
  }
  
  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    initializeLoginPage();
    
    // Add event listeners
    document.getElementById('login-btn').addEventListener('click', handleLogin);
    document.getElementById('switch-account-link').addEventListener('click', (e) => {
      e.preventDefault();
      switchAccount();
    });
    
    // Add keyboard support
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !document.getElementById('login-btn').disabled) {
        handleLogin();
      }
    });
  });
  
  // Handle focus management for accessibility
  document.addEventListener('focusin', (e) => {
    if (e.target.classList.contains('login-btn')) {
      e.target.style.boxShadow = '0 0 0 2px #3b82f6';
    }
  });
  
  document.addEventListener('focusout', (e) => {
    if (e.target.classList.contains('login-btn')) {
      e.target.style.boxShadow = '';
    }
  });
</script>