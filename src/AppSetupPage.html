<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Shared Security Headers -->
    <?!= include('SharedSecurityHeaders'); ?>
    <title>ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰ - ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</title>
    
    <!-- Shared TailwindCSS Configuration -->
    <?!= include('SharedTailwindConfig'); ?>
    
    <!-- Shared Styles -->
    <?!= include('UnifiedStyles.css'); ?>
    <script>
      function getUrlParameterUserId() {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get('userId') || '';
        } catch (error) {
          console.warn('URL parameter extraction failed:', error);
          return '';
        }
      }

      const templateUserId = '<?= typeof userIdParam !== "undefined" ? userIdParam : "" ?>';
      let __USER_ID__ = getUrlParameterUserId() || templateUserId;
    </script>
  </head>
  <body style="background: var(--brand-background); color: var(--brand-text);" class="font-sans">
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[9999] hidden"
    >
      <div
        class="global-spinner"
      ></div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-[10000] space-y-2"></div>
    <div class="max-w-6xl mx-auto p-6">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="text-center mb-6">
        <h1 class="text-4xl font-bold text-cyan-400 mb-2">âš™ï¸ ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰ ã‚¢ãƒ—ãƒªè¨­å®š</h1>
        <p class="text-xl text-gray-300">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é‹ç”¨è¨­å®šã‚’ç®¡ç†ã—ã¾ã™</p>
        <p class="text-sm text-gray-400 mt-2">
          ã“ã®ãƒšãƒ¼ã‚¸ã§ã‚¢ãƒ—ãƒªã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™
        </p>
      </div>


      <!-- ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
      <div class="glass-panel rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold text-white mb-4">ğŸ“Š ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
        <div id="status-display" class="space-y-3">
          <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
            <div class="flex items-center">
              <span class="text-gray-300 mr-3">ã‚¢ãƒ—ãƒªçŠ¶æ…‹:</span>
              <span id="current-status" class="px-3 py-1 rounded-full text-sm font-medium">
                <span
                  class="spinner-small mr-2"
                ></span>
                èª­ã¿è¾¼ã¿ä¸­...
              </span>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
            <div class="flex items-center">
              <span class="text-gray-300 mr-3">ç®¡ç†è€…:</span>
              <span id="current-admin" class="text-white">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
            <div class="flex items-center">
              <span class="text-gray-300 mr-3">æœ€çµ‚æ›´æ–°:</span>
              <span id="last-updated" class="text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚¢ãƒ—ãƒªçŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆãƒ‘ãƒãƒ« -->
      <div class="glass-panel rounded-xl p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-2xl font-semibold text-white">ğŸ”’ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡</h2>
            <p class="text-gray-400">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’ç®¡ç†ã—ã¾ã™</p>
          </div>
          <div class="flex items-center space-x-2">
            <div id="app-status-indicator" class="w-3 h-3 rounded-full bg-gray-500"></div>
            <span id="app-status-text" class="text-sm text-gray-400">çŠ¶æ…‹ç¢ºèªä¸­...</span>
          </div>
        </div>

        <!-- ã‚¢ãƒ—ãƒªåˆ¶å¾¡ãƒœã‚¿ãƒ³ -->
        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-gray-800 rounded-lg">
            <h3 class="text-lg font-medium text-red-400 mb-3">ğŸš« ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢</h3>
            <p class="text-sm text-gray-400 mb-4">
              å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åœæ­¢ã—ã¾ã™ã€‚ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
            </p>
            <div class="space-y-3">
              <input
                type="text"
                id="disable-reason"
                placeholder="åœæ­¢ç†ç”±ï¼ˆä¾‹ï¼šã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ï¼‰"
                class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-red-500 focus:outline-none text-sm"
              />
              <button
                id="disable-app-btn"
                onclick="disableApp()"
                class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors"
              >
                ğŸš« ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
              </button>
            </div>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h3 class="text-lg font-medium text-green-400 mb-3">âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†é–‹</h3>
            <p class="text-sm text-gray-400 mb-4">
              åœæ­¢ä¸­ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†é–‹ã—ã€å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã—ã¾ã™ã€‚
            </p>
            <div class="pt-8">
              <button
                id="enable-app-btn"
                onclick="enableApp()"
                class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors"
              >
                âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†é–‹
              </button>
            </div>
          </div>
        </div>

        <!-- ç¾åœ¨ã®åˆ¶é™æƒ…å ±è¡¨ç¤º -->
        <div id="restriction-info" class="hidden p-4 bg-red-900/20 border border-red-500/30 rounded-lg">
          <h4 class="text-md font-medium text-red-400 mb-2">âš ï¸ ç¾åœ¨ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™</h4>
          <div class="text-sm text-gray-300 space-y-1">
            <div>ç†ç”±: <span id="restriction-reason">-</span></div>
            <div>åœæ­¢è€…: <span id="restriction-by">-</span></div>
            <div>åœæ­¢æ—¥æ™‚: <span id="restriction-at">-</span></div>
          </div>
        </div>
      </div>

      <!-- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
      <div class="glass-panel rounded-xl p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-2xl font-semibold text-white">ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ</h2>
            <p class="text-gray-400">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¦‚è¦æƒ…å ±</p>
          </div>
          <button onclick="loadSystemStats()" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
            ğŸ”„ æ›´æ–°
          </button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-blue-400" id="total-users">-</div>
            <div class="text-sm text-gray-400">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div>
          </div>
          <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-400" id="active-users">-</div>
            <div class="text-sm text-gray-400">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
          </div>
          <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-purple-400" id="published-boards">-</div>
            <div class="text-sm text-gray-400">å…¬é–‹ãƒœãƒ¼ãƒ‰æ•°</div>
          </div>
          <div class="bg-gray-800 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-yellow-400" id="recent-activity">-</div>
            <div class="text-sm text-gray-400">24æ™‚é–“ä»¥å†…ã®æ´»å‹•</div>
          </div>
        </div>
      </div>

      <!-- ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ãƒ»ç›£è¦–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="glass-panel rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold text-white mb-4">ğŸ” ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ãƒ»ç›£è¦–</h2>
        <p class="text-sm text-gray-400 mb-4">ã‚·ã‚¹ãƒ†ãƒ ã®å¥å…¨æ€§ç¢ºèªã¨å•é¡Œè§£æ±ºã®ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™</p>

        <div class="space-y-4">
          <!-- åŸºæœ¬è¨ºæ–­ï¼ˆã‚ˆãä½¿ã†æ©Ÿèƒ½ï¼‰ -->
          <div class="p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-lg font-medium text-blue-400">ğŸ©º åŸºæœ¬è¨ºæ–­</h3>
                <p class="text-sm text-gray-400">ã¾ãšã¯ã“ã¡ã‚‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
              </div>
              <span class="px-2 py-1 bg-blue-600/30 text-blue-300 rounded text-xs">æ¨å¥¨</span>
            </div>
            <p class="text-sm text-gray-300 mb-4">
              ã‚·ã‚¹ãƒ†ãƒ ã®åŸºæœ¬çš„ãªå¥å…¨æ€§ï¼ˆDBæ¥ç¶šãƒ»è¨­å®šãƒ»æ¨©é™ï¼‰ã‚’ç¢ºèªã—ã¾ã™ã€‚å•é¡ŒãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯è‡ªå‹•ä¿®å¾©ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚
            </p>
            <div class="flex gap-3">
              <button
                type="button"
                id="run-diagnosis-btn"
                onclick="runSystemDiagnosis()"
                class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex-1"
              >
                è¨ºæ–­å®Ÿè¡Œ
              </button>
              <button
                type="button"
                id="run-repair-btn"
                onclick="runAutoRepair()"
                class="btn bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg flex-1"
              >
                è‡ªå‹•ä¿®å¾©
              </button>
            </div>
          </div>

          <!-- è©³ç´°è¨ºæ–­ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
          <details class="bg-gray-800 rounded-lg">
            <summary class="p-4 cursor-pointer text-gray-300 hover:text-white">
              ğŸ”¬ è©³ç´°è¨ºæ–­ãƒ„ãƒ¼ãƒ«ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰
            </summary>
            <div class="p-4 pt-0 grid md:grid-cols-2 gap-4">
              <div class="p-4 bg-gray-700/50 rounded-lg">
                <h4 class="text-md font-medium text-purple-400 mb-2">ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–</h4>
                <p class="text-xs text-gray-400 mb-3">ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³ãƒ»å®Ÿè¡Œãƒ­ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼ç‡ã‚’ç¢ºèª</p>
                <button
                  type="button"
                  id="run-monitoring-btn"
                  onclick="runSystemMonitoring()"
                  class="btn bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg w-full text-sm"
                >
                  ç›£è¦–å®Ÿè¡Œ
                </button>
              </div>

              <div class="p-4 bg-gray-700/50 rounded-lg">
                <h4 class="text-md font-medium text-green-400 mb-2">âœ… ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§</h4>
                <p class="text-xs text-gray-400 mb-3">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ»è¨­å®šã®æ•´åˆæ€§ã‚’è©³ç´°ãƒã‚§ãƒƒã‚¯</p>
                <button
                  type="button"
                  id="run-integrity-btn"
                  onclick="runIntegrityCheck()"
                  class="btn bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg w-full text-sm"
                >
                  æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
                </button>
              </div>
            </div>
          </details>

          <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
          <div id="diagnostic-results" class="hidden mt-6">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-medium text-white">ğŸ“‹ è¨ºæ–­çµæœ</h3>
              <button
                type="button"
                onclick="copyDiagnosticResult()"
                class="btn bg-gray-600 hover:bg-gray-700 text-white py-1 px-3 rounded text-sm flex items-center gap-2"
              >
                ğŸ“‹ ã‚³ãƒ”ãƒ¼
              </button>
            </div>
            <div class="bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto">
              <pre id="diagnostic-output" class="text-sm text-gray-300 whitespace-pre-wrap"></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="glass-panel rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold text-white mb-4">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>

        <div class="space-y-4">
          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
          <div id="user-list-container">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-medium text-white">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h3>
              <div class="flex gap-2">
                <button
                  type="button"
                  id="refresh-users-btn"
                  onclick="loadUserList()"
                  class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm"
                >
                  ğŸ”„ æ›´æ–°
                </button>
              </div>
            </div>

            <div id="user-table-wrapper" class="bg-gray-800 rounded-lg overflow-hidden">
              <div id="user-loading" class="p-8 text-center text-gray-400">
                <div
                  class="spinner mx-auto mb-2"
                ></div>
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...
              </div>
              <div id="user-table-content" class="hidden">
                <table class="w-full">
                  <thead class="bg-gray-900">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-300">
                        ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                      </th>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-300">ç™»éŒ²æ—¥</th>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-300">ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹</th>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-300">ãƒœãƒ¼ãƒ‰çŠ¶æ…‹</th>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-300">
                        æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹
                      </th>
                      <th class="px-4 py-3 text-center text-sm font-medium text-gray-300">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="user-table-body" class="divide-y divide-gray-700"></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
      <div class="text-center">
        <button
          type="button"
          onclick="goBackToAdminPanel()"
          class="btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-2 px-6 rounded-lg"
        >
          â† ç®¡ç†ãƒ‘ãƒãƒ«ã«æˆ»ã‚‹
        </button>
      </div>
    </div>

    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div
      id="delete-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="glass-panel rounded-xl p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-semibold text-white mb-4">âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</h3>

        <div class="mb-4">
          <p class="text-gray-300 mb-2">ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
          <div class="bg-gray-800 p-3 rounded-lg">
            <p class="text-cyan-400 font-medium" id="delete-user-email"></p>
            <p class="text-sm text-gray-400" id="delete-user-id"></p>
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >å‰Šé™¤ç†ç”± <span class="text-red-400">*</span></label
          >
          <textarea
            id="deletion-reason"
            class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white resize-none"
            rows="3"
            placeholder="å‰Šé™¤ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå¿…é ˆï¼‰"
            required
          ></textarea>
          <p class="text-xs text-gray-400 mt-1">ã“ã®æƒ…å ±ã¯ç›£æŸ»ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã¾ã™</p>
        </div>

        <div class="bg-red-900/20 border border-red-500/50 p-3 rounded-lg mb-4">
          <p class="text-red-200 text-sm">
            âš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
          </p>
        </div>

        <div class="flex gap-3">
          <button
            type="button"
            onclick="cancelDeletion()"
            class="flex-1 btn bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            type="button"
            id="confirm-delete-btn"
            onclick="confirmDeletion()"
            class="flex-1 btn bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg"
          >
            å‰Šé™¤å®Ÿè¡Œ
          </button>
        </div>
      </div>
    </div>


    <script>

      function showMessage(message, type = 'info', duration = 5000) {
        if (window.notifications) {
          window.notifications.showMessage(message, type, duration);
          return;
        }

        const notificationContainer = document.getElementById('notification-container');
        if (!notificationContainer) {
          console.error('Notification container not found!');
          return;
        }

        const colors = {
          success: 'bg-green-600/20 border-green-500/50 text-green-100',
          error: 'bg-red-600/20 border-red-500/50 text-red-100',
          warning: 'bg-yellow-600/20 border-yellow-500/50 text-yellow-100',
          info: 'bg-blue-600/20 border-blue-500/50 text-blue-100',
        };

        const icon = {
          success: 'âœ…',
          error: 'âŒ',
          warning: 'âš ï¸',
          info: 'â„¹ï¸',
        };

        const notification = document.createElement('div');
        notification.className = `notification glass-panel rounded-lg p-4 border shadow-lg flex items-center transition-all duration-300 ease-out transform translate-x-full opacity-0 ${colors[type]}`;
        notification.innerHTML = `
                <div class="mr-3 text-2xl">${icon[type]}</div>
                <div class="flex-1 text-sm">${message}</div>
                <button type="button" class="ml-4 text-gray-400 hover:text-white text-xl leading-none" onclick="this.closest('.notification').remove()">âœ•</button>
            `;

        notificationContainer.appendChild(notification);

        requestIdleCallback(() => {
          notification.classList.remove('translate-x-full', 'opacity-0');
          notification.classList.add('translate-x-0', 'opacity-100');
        }, { timeout: 10 });

        if (duration > 0) {
          const createPromiseDelay = (ms) => new Promise(resolve => {
            const start = Date.now();
            const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
            check();
          });

          createPromiseDelay(duration).then(() => {
            notification.classList.remove('translate-x-0', 'opacity-100');
            notification.classList.add('translate-x-full', 'opacity-0');
            notification.addEventListener('transitionend', () => notification.remove());
          });
        }
      }



      function goBackToAdminPanel() {
        if (window.notifications) {
          window.notifications.info('â† ç®¡ç†ãƒ‘ãƒãƒ«ã«æˆ»ã£ã¦ã„ã¾ã™...', 2000);
        }

        google.script.run
          .withSuccessHandler((webAppUrl) => {
            const targetUrl = webAppUrl + '?mode=admin&userId=' + __USER_ID__;             // ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã§ã¯ window.top ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚Œã‚‹ãŸã‚
            window.open(targetUrl, '_top');
          })
          .withFailureHandler((error) => {
            console.error('WebApp URLå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            if (window.notifications) {
              window.notifications.error('ç®¡ç†ãƒ‘ãƒãƒ«ã«æˆ»ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚', 3000);
            }
            const currentUrl = window.location.href.split('?')[0];
            const targetUrl = currentUrl + '?mode=admin&userId=' + __USER_ID__;             window.open(targetUrl, '_top');
          })
          .getWebAppUrl();
      }


      let currentUserList = [];
      let userToDelete = null;


      function loadUserList() {
        const loadingDiv = document.getElementById('user-loading');
        const contentDiv = document.getElementById('user-table-content');

        loadingDiv.classList.remove('hidden');
        contentDiv.classList.add('hidden');

        google.script.run
          .withSuccessHandler((result) => {
            if (result.success === true) {
              currentUserList = result.users;
              displayUserList(result.users);
            } else {
              showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“', 'error');
            }
            loadingDiv.classList.add('hidden');
          })
          .withFailureHandler((error) => {
            showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            loadingDiv.classList.add('hidden');
          })
          .getAdminUsers();
      }

      function displayUserList(users) {
        const tableBody = document.getElementById('user-table-body');
        const contentDiv = document.getElementById('user-table-content');

        if (users.length === 0) {
          tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-400">
                            ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
                        </td>
                    </tr>
                `;
        } else {
          tableBody.innerHTML = users
            .map((user) => {
              const isActive = user.isActive === true;
              const statusBadge = isActive
                ? '<span class="px-2 py-1 bg-green-600 text-green-100 rounded-full text-xs">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span>'
                : '<span class="px-2 py-1 bg-red-600 text-red-100 rounded-full text-xs">éã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span>';

              let boardPublished = false;
              try {
                const config = JSON.parse(user.configJson || '{}');
                boardPublished = config.isPublished === true;
              } catch (e) {}

              const boardBadge = boardPublished
                ? '<span class="px-2 py-1 bg-purple-600 text-purple-100 rounded-full text-xs">å…¬é–‹ä¸­</span>'
                : '<span class="px-2 py-1 bg-gray-600 text-gray-100 rounded-full text-xs">éå…¬é–‹</span>';

              const registrationDate = user.createdAt
                ? new Date(user.createdAt).toLocaleDateString('ja-JP')
                : 'ä¸æ˜';

              const lastAccess = user.lastModified
                ? new Date(user.lastModified).toLocaleDateString('ja-JP')
                : 'ä¸æ˜';

              return `
                        <tr class="hover:bg-gray-700/50">
                            <td class="px-4 py-3 text-sm text-white">${window.sharedUtilities.security.escapeHtml(user.userEmail || 'N/A')}</td>
                            <td class="px-4 py-3 text-sm text-gray-300">${window.sharedUtilities.security.escapeHtml(registrationDate)}</td>
                            <td class="px-4 py-3">${statusBadge}</td>
                            <td class="px-4 py-3">${boardBadge}</td>
                            <td class="px-4 py-3 text-sm text-gray-300">${window.sharedUtilities.security.escapeHtml(lastAccess)}</td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex gap-1 justify-center">
                                    <button
                                        data-user-id="${window.sharedUtilities.security.escapeHtml(user.userId)}"
                                        onclick="toggleUserStatus(this.dataset.userId)"
                                        class="btn ${isActive ? 'bg-orange-600 hover:bg-orange-700' : 'bg-green-600 hover:bg-green-700'} text-white px-2 py-1 rounded text-xs"
                                        title="${isActive ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«'}">
                                        ${isActive ? 'ç„¡åŠ¹åŒ–' : 'æœ‰åŠ¹åŒ–'}
                                    </button>
                                    <button
                                        data-user-id="${window.sharedUtilities.security.escapeHtml(user.userId)}"
                                        onclick="toggleUserBoard(this.dataset.userId)"
                                        class="btn ${boardPublished ? 'bg-gray-600 hover:bg-gray-700' : 'bg-purple-600 hover:bg-purple-700'} text-white px-2 py-1 rounded text-xs"
                                        title="${boardPublished ? 'ãƒœãƒ¼ãƒ‰ã‚’éå…¬é–‹ã«' : 'ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã«'}">
                                        ${boardPublished ? 'éå…¬é–‹' : 'å…¬é–‹'}
                                    </button>
                                    <button
                                        data-user-id="${user.userId}"
                                        data-user-email="${user.userEmail}"
                                        onclick="showDeleteConfirmation(this.dataset.userId, this.dataset.userEmail)"
                                        class="btn bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs"
                                        title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤">
                                        å‰Šé™¤
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
            })
            .join('');
        }

        contentDiv.classList.remove('hidden');
      }

      function showDeleteConfirmation(userId, userEmail) {
        userToDelete = { userId, userEmail };

        document.getElementById('delete-user-email').textContent = userEmail;
        document.getElementById('delete-user-id').textContent = `ID: ${userId}`;
        document.getElementById('deletion-reason').value = '';
        document.getElementById('delete-modal').classList.remove('hidden');
      }

      function cancelDeletion() {
        userToDelete = null;
        document.getElementById('delete-modal').classList.add('hidden');
      }

      function confirmDeletion() {
        if (!userToDelete) return;

        const reason = document.getElementById('deletion-reason').value.trim();
        if (!reason) {
          showMessage('å‰Šé™¤ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
          return;
        }

        const confirmBtn = document.getElementById('confirm-delete-btn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'å‰Šé™¤ä¸­...';

        google.script.run
          .withSuccessHandler((result) => {
            if (result && result.success) {
              showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
              cancelDeletion();
              loadUserList(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            } else {
              showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'å‰Šé™¤å®Ÿè¡Œ';
          })
          .withFailureHandler((error) => {
            showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'å‰Šé™¤å®Ÿè¡Œ';
          })
          .deleteUser(userToDelete.userId, reason);
      }




      function runSystemDiagnosis() {
        executeSystemFunction(
          'run-diagnosis-btn',
          'ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ä¸­...',
          'testSystemDiagnosis',
          'è¨ºæ–­å®Ÿè¡Œ'
        );
      }

      function runAutoRepair() {
        executeSystemFunction('run-repair-btn', 'è‡ªå‹•ä¿®å¾©ä¸­...', 'performAutoRepair', 'ä¿®å¾©å®Ÿè¡Œ');
      }

      function runSystemMonitoring() {
        executeSystemFunction(
          'run-monitoring-btn',
          'ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ä¸­...',
          'monitorSystem',
          'ç›£è¦–å®Ÿè¡Œ'
        );
      }

      function runIntegrityCheck() {
        executeSystemFunction(
          'run-integrity-btn',
          'æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ä¸­...',
          'checkDataIntegrity',
          'æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯'
        );
      }

      function executeSystemFunction(buttonId, progressMessage, functionName, originalText) {
        const button = document.getElementById(buttonId);
        const resultsDiv = document.getElementById('diagnostic-results');
        const outputElement = document.getElementById('diagnostic-output');

        button.disabled = true;
        button.textContent = progressMessage;

        outputElement.textContent = 'å®Ÿè¡Œä¸­...';
        resultsDiv.classList.remove('hidden');

        showMessage(progressMessage, 'info');

        google.script.run
          .withSuccessHandler((result) => {
            showDiagnosticResult(result, functionName);

            button.disabled = false;
            button.textContent = originalText;
          })
          .withFailureHandler((error) => {
            outputElement.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${error.message || error}`;
            showMessage(
              `âŒ ${functionName} ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message || error}`,
              'error'
            );

            button.disabled = false;
            button.textContent = originalText;
          })
          [functionName]();
      }


      function showDiagnosticResult(result, functionName) {
        const output = document.getElementById('diagnostic-output');
        const timestamp = new Date().toLocaleString('ja-JP');

        output.textContent = `ã€${functionName} å®Ÿè¡Œçµæœã€‘\nå®Ÿè¡Œæ™‚é–“: ${timestamp}\n\n${JSON.stringify(result, null, 2)}`;

        showMessage(
          result.success ? `âœ… ${functionName}: å®Ÿè¡Œå®Œäº†` : `âŒ ${functionName}: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ`,
          result.success ? 'success' : 'error'
        );
      }

      function copyDiagnosticResult() {
        const output = document.getElementById('diagnostic-output');
        const text = output.textContent;

        if (!text || text === 'å®Ÿè¡Œä¸­...') {
          showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
          return;
        }

        navigator.clipboard.writeText(text)
          .then(() => {
            showMessage('ğŸ“‹ è¨ºæ–­çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
          })
          .catch((err) => {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand('copy');
              showMessage('ğŸ“‹ è¨ºæ–­çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
            } catch (e) {
              showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
            document.body.removeChild(textarea);
          });
      }

      function loadSystemStats() {
        google.script.run
          .withSuccessHandler(function(users) {
            if (users && users.success && users.users) {
              displaySystemStats(users.users);
            }
          })
          .withFailureHandler(function(error) {
            console.error('çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          })
          .getAdminUsers();
      }

      function displaySystemStats(users) {
        const totalUsers = users.length;
        const activeUsers = users.filter(u => u.isActive === true).length;

        let publishedBoards = 0;
        let recentActivity = 0;
        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);

        users.forEach(user => {
          try {
            const config = JSON.parse(user.configJson || '{}');
            if (config.isPublished === true) publishedBoards++;
          } catch (e) {}

          const lastActivity = new Date(user.lastModified || user.createdAt);
          if (lastActivity > yesterday) recentActivity++;
        });

        document.getElementById('total-users').textContent = totalUsers;
        document.getElementById('active-users').textContent = activeUsers;
        document.getElementById('published-boards').textContent = publishedBoards;
        document.getElementById('recent-activity').textContent = recentActivity;
      }

      function toggleUserStatus(userId) {
        const confirmMessage = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ';
        if (!confirm(confirmMessage)) return;

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              loadUserList();
              loadSystemStats();
            } else {
              showMessage('çŠ¶æ…‹å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('çŠ¶æ…‹å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          })
          .toggleUserActiveStatus(userId);
      }

      function toggleUserBoard(userId) {
        const confirmMessage = 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒœãƒ¼ãƒ‰å…¬é–‹çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ';
        if (!confirm(confirmMessage)) return;

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              loadUserList();
              loadSystemStats();
            } else {
              showMessage('ãƒœãƒ¼ãƒ‰çŠ¶æ…‹å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('çŠ¶æ…‹å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          })
          .toggleUserBoardStatus(userId);
      }


      function updateAppControlStatus() {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success && result.data) {
              const data = result.data;
              const isDisabled = data.isDisabled;

              const currentStatus = document.getElementById('current-status');
              const currentAdmin = document.getElementById('current-admin');
              const lastUpdated = document.getElementById('last-updated');

              if (isDisabled) {
                currentStatus.innerHTML = '<span class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-medium">ğŸš« åœæ­¢ä¸­</span>';
              } else {
                currentStatus.innerHTML = '<span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium">âœ… é‹ç”¨ä¸­</span>';
              }

              if (data.restriction && data.restriction.disabledBy) {
                currentAdmin.textContent = data.restriction.disabledBy;
              } else if (data.lastEnabled && data.lastEnabled.enabledBy) {
                currentAdmin.textContent = data.lastEnabled.enabledBy;
              } else {
                google.script.run
                  .withSuccessHandler(function(email) {
                    if (email) currentAdmin.textContent = email;
                  })
                  .getCurrentEmail();
              }

              let updateTime = data.timestamp;
              if (data.restriction && data.restriction.disabledAt) {
                updateTime = data.restriction.disabledAt;
              } else if (data.lastEnabled && data.lastEnabled.enabledAt) {
                updateTime = data.lastEnabled.enabledAt;
              }

              if (updateTime) {
                lastUpdated.textContent = new Date(updateTime).toLocaleString('ja-JP');
              } else {
                lastUpdated.textContent = new Date().toLocaleString('ja-JP');
              }

              const statusIndicator = document.getElementById('app-status-indicator');
              const statusText = document.getElementById('app-status-text');
              const disableBtn = document.getElementById('disable-app-btn');
              const enableBtn = document.getElementById('enable-app-btn');
              const restrictionInfo = document.getElementById('restriction-info');

              if (isDisabled) {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                statusText.textContent = 'åœæ­¢ä¸­';
                statusText.className = 'text-sm text-red-400';
                disableBtn.disabled = true;
                enableBtn.disabled = false;

                if (data.restriction) {
                  document.getElementById('restriction-reason').textContent =
                    data.restriction.reason || 'ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹';
                  document.getElementById('restriction-by').textContent =
                    data.restriction.disabledBy || '-';
                  document.getElementById('restriction-at').textContent =
                    data.restriction.disabledAt ? new Date(data.restriction.disabledAt).toLocaleString('ja-JP') : '-';
                  restrictionInfo.classList.remove('hidden');
                }
              } else {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                statusText.textContent = 'é‹ç”¨ä¸­';
                statusText.className = 'text-sm text-green-400';
                disableBtn.disabled = false;
                enableBtn.disabled = true;
                restrictionInfo.classList.add('hidden');
              }
            } else {
              showMessage('ã‚¢ãƒ—ãƒªåˆ¶å¾¡çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
          })
          .withFailureHandler(function(error) {
            console.error('ã‚¢ãƒ—ãƒªåˆ¶å¾¡çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            showMessage('ã‚¢ãƒ—ãƒªåˆ¶å¾¡çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          })
          .getAppAccessStatus();
      }

      function disableApp() {
        const reasonInput = document.getElementById('disable-reason');
        const reason = reasonInput.value.trim() || 'ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹';

        const confirmMessage = `ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã€‚\nç†ç”±: ${reason}\n\nå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`;
        if (!confirm(confirmMessage)) return;

        const button = document.getElementById('disable-app-btn');
        button.disabled = true;
        button.textContent = 'åœæ­¢ä¸­...';

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              showMessage('âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'success');
              reasonInput.value = ''; // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
              updateAppControlStatus(); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ï¼ˆğŸ“Šç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ã‚‚å«ã‚€ï¼‰
            } else {
              showMessage('âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
            button.disabled = false;
            button.textContent = 'ğŸš« ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢';
          })
          .withFailureHandler(function(error) {
            console.error('ã‚¢ãƒ—ãƒªåœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
            showMessage('âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            button.disabled = false;
            button.textContent = 'ğŸš« ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢';
          })
          .disableAppAccess(reason);
      }

      function enableApp() {
        const confirmMessage = 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†é–‹ã—ã¾ã™ã€‚\nå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ';
        if (!confirm(confirmMessage)) return;

        const button = document.getElementById('enable-app-btn');
        button.disabled = true;
        button.textContent = 'å†é–‹ä¸­...';

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              showMessage('âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†é–‹ã—ã¾ã—ãŸ', 'success');
              updateAppControlStatus(); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ï¼ˆğŸ“Šç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ã‚‚å«ã‚€ï¼‰
            } else {
              showMessage('âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
            button.disabled = false;
            button.textContent = 'âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†é–‹';
          })
          .withFailureHandler(function(error) {
            console.error('ã‚¢ãƒ—ãƒªå†é–‹ã‚¨ãƒ©ãƒ¼:', error);
            showMessage('âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†é–‹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            button.disabled = false;
            button.textContent = 'âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†é–‹';
          })
          .enableAppAccess();
      }

      document.addEventListener('DOMContentLoaded', function() {
        loadUserList();
        loadSystemStats();
        updateAppControlStatus(); // ã‚¢ãƒ—ãƒªåˆ¶å¾¡çŠ¶æ…‹ã‚‚åˆæœŸåŒ–
      });
    </script>

    <!-- GASæ¨å¥¨: JavaScriptèª­ã¿è¾¼ã¿ã¯</body>ç›´å‰ã«é›†ç´„ -->
    <?!= include('SharedUtilities'); ?>
    <?!= include('SharedErrorHandling'); ?>
  </body>
</html>
