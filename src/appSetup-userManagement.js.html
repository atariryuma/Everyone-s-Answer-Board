<script>
/**
 * AppSetupPage ユーザー管理機能モジュール
 * ユーザー一覧表示、削除、アクセス制御
 */

// グローバル変数
let currentUserList = [];
let userToDelete = null;
let userManagementVisible = false;

/**
 * ユーザー管理パネルの表示/非表示を切り替え
 */
function toggleUserManagement() {
    const container = document.getElementById('user-list-container');
    const button = document.querySelector('button[onclick="toggleUserManagement()"]');
    
    if (!container) return;
    
    userManagementVisible = !userManagementVisible;
    
    if (userManagementVisible) {
        container.classList.remove('hidden');
        if (button) button.textContent = '👥 ユーザー管理を閉じる';
        loadUserList();
    } else {
        container.classList.add('hidden');
        if (button) button.textContent = '👥 ユーザー管理を開く';
    }
}

/**
 * ユーザー一覧を読み込み
 */
function loadUserList() {
    const tableBody = document.getElementById('user-table-body');
    const updateButton = document.querySelector('button[onclick="loadUserList()"]');
    
    if (tableBody) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="px-4 py-8 text-center text-gray-400">
                    <div class="flex items-center justify-center space-x-2">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"></div>
                        <span>ユーザー一覧を読み込み中...</span>
                    </div>
                </td>
            </tr>
        `;
    }
    
    if (updateButton) {
        updateButton.disabled = true;
        updateButton.textContent = '読み込み中...';
    }

    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                currentUserList = result.users || [];
                displayUserList(currentUserList);
            } else {
                displayUserListError('ユーザー一覧の取得に失敗しました: ' + result.message);
            }
            
            if (updateButton) {
                updateButton.disabled = false;
                updateButton.textContent = '🔄 更新';
            }
        })
        .withFailureHandler(error => {
            console.error('Load user list error:', error);
            displayUserListError('ユーザー一覧の取得に失敗しました: ' + error.message);
            
            if (updateButton) {
                updateButton.disabled = false;
                updateButton.textContent = '🔄 更新';
            }
        })
        .getAllUsersForAdminForUI();
}

/**
 * ユーザー一覧を表示
 */
function displayUserList(users) {
    const tableBody = document.getElementById('user-table-body');
    if (!tableBody) return;

    if (!users || users.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="px-4 py-8 text-center text-gray-400">
                    登録ユーザーがいません
                </td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = users.map(user => {
        const isActive = user.isActive === true || String(user.isActive).toLowerCase() === 'true';
        const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('ja-JP') : '不明';
        const lastAccessDate = user.lastAccessedAt ? new Date(user.lastAccessedAt).toLocaleDateString('ja-JP') : '未アクセス';
        
        const statusClass = isActive ? 'text-green-400' : 'text-red-400';
        const statusIcon = isActive ? '🟢' : '🔴';
        const statusText = isActive ? 'アクティブ' : '非アクティブ';

        return `
            <tr class="hover:bg-gray-700/50" data-user-id="${user.userId}">
                <td class="px-4 py-3 text-sm text-white" title="${user.adminEmail}">
                    ${user.adminEmail}
                </td>
                <td class="px-4 py-3 text-sm text-gray-300">${createdDate}</td>
                <td class="px-4 py-3 text-sm ${statusClass}">${statusIcon} ${statusText}</td>
                <td class="px-4 py-3 text-center space-x-2">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer user-active-toggle" 
                               data-user-id="${user.userId}" data-email="${user.adminEmail}"
                               ${isActive ? 'checked' : ''} 
                               onchange="toggleUserActiveStatus('${user.userId}', this.checked, '${user.adminEmail}')">
                        <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600"></div>
                    </label>
                    <button type="button" onclick="deleteUser('${user.userId}', '${user.adminEmail}')" 
                            class="btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs ml-2">
                        🗑️ 削除
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

/**
 * ユーザー一覧のエラー表示
 */
function displayUserListError(errorMessage) {
    const tableBody = document.getElementById('user-table-body');
    if (!tableBody) return;

    tableBody.innerHTML = `
        <tr>
            <td colspan="4" class="px-4 py-8 text-center text-red-400">
                <div class="flex items-center justify-center space-x-2">
                    <span>❌</span>
                    <span>${errorMessage}</span>
                </div>
            </td>
        </tr>
    `;
}

/**
 * ユーザーのアクティブ状態を切り替え
 */
function toggleUserActiveStatus(userId, isActive, userEmail) {
    console.log(`Toggling user active status: ${userId} -> ${isActive}`);
    
    // 楽観的UI更新
    const toggle = document.querySelector(`[data-user-id="${userId}"].user-active-toggle`);
    const row = document.querySelector(`tr[data-user-id="${userId}"]`);
    
    if (row) {
        const statusCell = row.querySelector('td:nth-child(3)');
        const statusClass = isActive ? 'text-green-400' : 'text-red-400';
        const statusIcon = isActive ? '🟢' : '🔴';
        const statusText = isActive ? 'アクティブ' : '非アクティブ';
        
        if (statusCell) {
            statusCell.className = `px-4 py-3 text-sm ${statusClass}`;
            statusCell.textContent = `${statusIcon} ${statusText}`;
        }
    }

    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                console.log('User active status updated successfully:', result);
            } else {
                console.error('Failed to update user active status:', result);
                // UI をロールバック
                rollbackUserStatusUI(userId, !isActive, toggle, row);
                alert('ユーザー状態の更新に失敗しました: ' + result.message);
            }
        })
        .withFailureHandler(error => {
            console.error('Update user active status error:', error);
            // UI をロールバック
            rollbackUserStatusUI(userId, !isActive, toggle, row);
            alert('ユーザー状態の更新に失敗しました: ' + error.message);
        })
        .updateUserActiveStatusForUI(userId, isActive);
}

/**
 * ユーザー状態UIのロールバック
 */
function rollbackUserStatusUI(userId, originalState, toggle, row) {
    if (toggle) toggle.checked = originalState;
    if (row) {
        const statusCell = row.querySelector('td:nth-child(3)');
        const statusClass = originalState ? 'text-green-400' : 'text-red-400';
        const statusIcon = originalState ? '🟢' : '🔴';
        const statusText = originalState ? 'アクティブ' : '非アクティブ';
        
        if (statusCell) {
            statusCell.className = `px-4 py-3 text-sm ${statusClass}`;
            statusCell.textContent = `${statusIcon} ${statusText}`;
        }
    }
}

/**
 * ユーザー削除の確認ダイアログを表示
 */
function deleteUser(userId, userEmail) {
    userToDelete = { userId, userEmail };
    showDeleteConfirmation(userId, userEmail);
}

/**
 * 削除確認モーダルを表示
 */
function showDeleteConfirmation(userId, userEmail) {
    const modal = document.getElementById('delete-modal');
    const userEmailSpan = document.getElementById('user-email-to-delete');
    const userIdSpan = document.getElementById('user-id-to-delete');
    
    if (!modal) return;
    
    if (userEmailSpan) userEmailSpan.textContent = userEmail;
    if (userIdSpan) userIdSpan.textContent = userId;
    
    // アクセス制御タブとアカウント削除タブの初期設定
    setupDeleteModalTabs(userId, userEmail);
    
    modal.classList.remove('hidden');
}

/**
 * 削除モーダルのタブ設定
 */
function setupDeleteModalTabs(userId, userEmail) {
    const accessTab = document.getElementById('tab-access');
    const deleteTab = document.getElementById('tab-delete');
    const accessBtn = document.getElementById('tab-btn-access');
    const deleteBtn = document.getElementById('tab-btn-delete');
    
    // 現在のユーザー状態を取得してアクセス制御タブを設定
    const user = currentUserList.find(u => u.userId === userId);
    if (user && accessTab) {
        const userToggle = document.getElementById('user-access-toggle');
        if (userToggle) {
            const isActive = user.isActive === true || String(user.isActive).toLowerCase() === 'true';
            userToggle.checked = isActive;
        }
    }
    
    // タブ切り替え機能
    if (accessBtn && deleteBtn && accessTab && deleteTab) {
        accessBtn.onclick = () => switchDeleteModalTab('access');
        deleteBtn.onclick = () => switchDeleteModalTab('delete');
        
        // デフォルトでアクセス制御タブを表示
        switchDeleteModalTab('access');
    }
}

/**
 * 削除モーダルのタブ切り替え
 */
function switchDeleteModalTab(tabName) {
    const accessTab = document.getElementById('tab-access');
    const deleteTab = document.getElementById('tab-delete');
    const accessBtn = document.getElementById('tab-btn-access');
    const deleteBtn = document.getElementById('tab-btn-delete');
    
    if (tabName === 'access') {
        if (accessTab) accessTab.classList.remove('hidden');
        if (deleteTab) deleteTab.classList.add('hidden');
        if (accessBtn) accessBtn.classList.add('border-purple-500', 'text-purple-400');
        if (deleteBtn) deleteBtn.classList.remove('border-purple-500', 'text-purple-400');
    } else {
        if (accessTab) accessTab.classList.add('hidden');
        if (deleteTab) deleteTab.classList.remove('hidden');
        if (accessBtn) accessBtn.classList.remove('border-purple-500', 'text-purple-400');
        if (deleteBtn) deleteBtn.classList.add('border-purple-500', 'text-purple-400');
    }
}

/**
 * ユーザーアクセス設定を保存
 */
function saveUserAccessSettings() {
    if (!userToDelete) return;
    
    const userToggle = document.getElementById('user-access-toggle');
    const saveBtn = document.getElementById('save-access-settings');
    
    if (!userToggle || !saveBtn) return;
    
    const newActiveStatus = userToggle.checked;
    const originalText = saveBtn.textContent;
    
    saveBtn.disabled = true;
    saveBtn.textContent = '保存中...';
    
    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                alert('ユーザーアクセス設定を更新しました');
                // ユーザーリストを再読み込み
                loadUserList();
                // モーダルを閉じる
                closeDeleteModal();
            } else {
                alert('設定の更新に失敗しました: ' + result.message);
            }
            
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        })
        .withFailureHandler(error => {
            console.error('Save user access settings error:', error);
            alert('設定の更新に失敗しました: ' + error.message);
            
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        })
        .updateUserActiveStatusForUI(userToDelete.userId, newActiveStatus);
}

/**
 * ユーザー削除を確定実行
 */
function confirmDeletion() {
    if (!userToDelete) return;
    
    const reasonTextarea = document.getElementById('deletion-reason');
    const reason = reasonTextarea ? reasonTextarea.value.trim() : '';
    
    if (!reason || reason.length < 20) {
        alert('削除理由を20文字以上で入力してください。');
        return;
    }
    
    if (!confirm(`本当に ${userToDelete.userEmail} を削除しますか？\n\nこの操作は取り消せません。`)) {
        return;
    }
    
    const deleteBtn = document.querySelector('button[onclick="confirmDeletion()"]');
    const originalText = deleteBtn ? deleteBtn.textContent : '';
    
    if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.textContent = '削除中...';
    }
    
    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                alert('ユーザーを削除しました');
                // ユーザーリストを再読み込み
                loadUserList();
                // モーダルを閉じる
                closeDeleteModal();
            } else {
                alert('削除に失敗しました: ' + result.message);
            }
            
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.textContent = originalText;
            }
        })
        .withFailureHandler(error => {
            console.error('Delete user error:', error);
            alert('削除に失敗しました: ' + error.message);
            
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.textContent = originalText;
            }
        })
        .deleteUserAccountByAdminForUI(userToDelete.userId, reason);
}

/**
 * 削除モーダルを閉じる
 */
function closeDeleteModal() {
    const modal = document.getElementById('delete-modal');
    const reasonTextarea = document.getElementById('deletion-reason');
    
    if (modal) modal.classList.add('hidden');
    if (reasonTextarea) reasonTextarea.value = '';
    
    userToDelete = null;
}

/**
 * 削除ログを表示
 */
function showDeletionLogs() {
    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                showLogsModal(result.logs, 'deletion');
            } else {
                alert('削除ログの取得に失敗しました: ' + result.message);
            }
        })
        .withFailureHandler(error => {
            console.error('Failed to fetch deletion logs:', error);
            alert('削除ログの取得に失敗しました: ' + error.message);
        })
        .getDeletionLogsForUI();
}

/**
 * ログモーダルを表示（削除ログ用）
 */
function showLogsModal(logs, type) {
    const modal = document.getElementById('logs-modal');
    const title = modal.querySelector('h3');
    const header = document.getElementById('dynamic-header');
    const tbody = document.getElementById('logs-table-body');
    
    if (!modal || !header || !tbody) return;
    
    if (type === 'deletion') {
        title.textContent = '📋 削除ログ';
        
        // ヘッダーを設定
        header.innerHTML = `
            <tr>
                <th class="px-4 py-2 text-left">削除日時</th>
                <th class="px-4 py-2 text-left">実行者</th>
                <th class="px-4 py-2 text-left">対象ユーザー</th>
                <th class="px-4 py-2 text-left">削除理由</th>
                <th class="px-4 py-2 text-left">タイプ</th>
            </tr>
        `;
        
        // データを表示
        if (!logs || logs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-4 py-8 text-center text-gray-400">
                        削除ログがありません
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = logs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('ja-JP');
                return `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-4 py-2 text-sm text-gray-300">${timestamp}</td>
                        <td class="px-4 py-2 text-sm text-white">${log.executorEmail || ''}</td>
                        <td class="px-4 py-2 text-sm text-gray-300">${log.targetEmail || ''}</td>
                        <td class="px-4 py-2 text-sm text-gray-300">${log.reason || ''}</td>
                        <td class="px-4 py-2 text-sm text-gray-300">${log.deleteType || ''}</td>
                    </tr>
                `;
            }).join('');
        }
    }
    
    modal.classList.remove('hidden');
}
</script>