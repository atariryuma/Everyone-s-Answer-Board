<script>
/**
 * AppSetupPage ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºã€å‰Šé™¤ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
 */

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentUserList = [];
let userToDelete = null;
let userManagementVisible = false;

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
 */
function toggleUserManagement() {
    const container = document.getElementById('user-list-container');
    const button = document.querySelector('button[onclick="toggleUserManagement()"]');
    
    if (!container) return;
    
    userManagementVisible = !userManagementVisible;
    
    if (userManagementVisible) {
        container.classList.remove('hidden');
        if (button) button.textContent = 'ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚’é–‰ã˜ã‚‹';
        loadUserList();
    } else {
        container.classList.add('hidden');
        if (button) button.textContent = 'ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚’é–‹ã';
    }
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
 */
function loadUserList() {
    const tableBody = document.getElementById('user-table-body');
    const updateButton = document.querySelector('button[onclick="loadUserList()"]');
    
    if (tableBody) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="px-4 py-8 text-center text-gray-400">
                    <div class="flex items-center justify-center space-x-2">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"></div>
                        <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                </td>
            </tr>
        `;
    }
    
    if (updateButton) {
        updateButton.disabled = true;
        updateButton.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
    }

    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                currentUserList = result.users || [];
                displayUserList(currentUserList);
            } else {
                displayUserListError('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
            }
            
            if (updateButton) {
                updateButton.disabled = false;
                updateButton.textContent = 'ğŸ”„ æ›´æ–°';
            }
        })
        .withFailureHandler(error => {
            console.error('Load user list error:', error);
            displayUserListError('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            
            if (updateButton) {
                updateButton.disabled = false;
                updateButton.textContent = 'ğŸ”„ æ›´æ–°';
            }
        })
        .getAllUsersForAdminForUI();
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
 */
function displayUserList(users) {
    const tableBody = document.getElementById('user-table-body');
    if (!tableBody) return;

    if (!users || users.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="px-4 py-8 text-center text-gray-400">
                    ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“
                </td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = users.map(user => {
        const isActive = user.isActive === true || String(user.isActive).toLowerCase() === 'true';
        const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('ja-JP') : 'ä¸æ˜';
        const lastAccessDate = user.lastAccessedAt ? new Date(user.lastAccessedAt).toLocaleDateString('ja-JP') : 'æœªã‚¢ã‚¯ã‚»ã‚¹';
        
        const statusClass = isActive ? 'text-green-400' : 'text-red-400';
        const statusIcon = isActive ? 'ğŸŸ¢' : 'ğŸ”´';
        const statusText = isActive ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–';

        return `
            <tr class="hover:bg-gray-700/50" data-user-id="${user.userId}">
                <td class="px-4 py-3 text-sm text-white" title="${user.adminEmail}">
                    ${user.adminEmail}
                </td>
                <td class="px-4 py-3 text-sm text-gray-300">${createdDate}</td>
                <td class="px-4 py-3 text-sm ${statusClass}">${statusIcon} ${statusText}</td>
                <td class="px-4 py-3 text-center space-x-2">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer user-active-toggle" 
                               data-user-id="${user.userId}" data-email="${user.adminEmail}"
                               ${isActive ? 'checked' : ''} 
                               onchange="toggleUserActiveStatus('${user.userId}', this.checked, '${user.adminEmail}')">
                        <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600"></div>
                    </label>
                    <button type="button" onclick="deleteUser('${user.userId}', '${user.adminEmail}')" 
                            class="btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs ml-2">
                        ğŸ—‘ï¸ å‰Šé™¤
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
 */
function displayUserListError(errorMessage) {
    const tableBody = document.getElementById('user-table-body');
    if (!tableBody) return;

    tableBody.innerHTML = `
        <tr>
            <td colspan="4" class="px-4 py-8 text-center text-red-400">
                <div class="flex items-center justify-center space-x-2">
                    <span>âŒ</span>
                    <span>${errorMessage}</span>
                </div>
            </td>
        </tr>
    `;
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
 */
function toggleUserActiveStatus(userId, isActive, userEmail) {
    console.log(`Toggling user active status: ${userId} -> ${isActive}`);
    
    // æ¥½è¦³çš„UIæ›´æ–°
    const toggle = document.querySelector(`[data-user-id="${userId}"].user-active-toggle`);
    const row = document.querySelector(`tr[data-user-id="${userId}"]`);
    
    if (row) {
        const statusCell = row.querySelector('td:nth-child(3)');
        const statusClass = isActive ? 'text-green-400' : 'text-red-400';
        const statusIcon = isActive ? 'ğŸŸ¢' : 'ğŸ”´';
        const statusText = isActive ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–';
        
        if (statusCell) {
            statusCell.className = `px-4 py-3 text-sm ${statusClass}`;
            statusCell.textContent = `${statusIcon} ${statusText}`;
        }
    }

    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                console.log('User active status updated successfully:', result);
            } else {
                console.error('Failed to update user active status:', result);
                // UI ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
                rollbackUserStatusUI(userId, !isActive, toggle, row);
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
            }
        })
        .withFailureHandler(error => {
            console.error('Update user active status error:', error);
            // UI ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
            rollbackUserStatusUI(userId, !isActive, toggle, row);
            alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .updateUserActiveStatusForUI(userId, isActive);
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹UIã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
 */
function rollbackUserStatusUI(userId, originalState, toggle, row) {
    if (toggle) toggle.checked = originalState;
    if (row) {
        const statusCell = row.querySelector('td:nth-child(3)');
        const statusClass = originalState ? 'text-green-400' : 'text-red-400';
        const statusIcon = originalState ? 'ğŸŸ¢' : 'ğŸ”´';
        const statusText = originalState ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–';
        
        if (statusCell) {
            statusCell.className = `px-4 py-3 text-sm ${statusClass}`;
            statusCell.textContent = `${statusIcon} ${statusText}`;
        }
    }
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function deleteUser(userId, userEmail) {
    userToDelete = { userId, userEmail };
    showDeleteConfirmation(userId, userEmail);
}

/**
 * å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
 */
function showDeleteConfirmation(userId, userEmail) {
    const modal = document.getElementById('delete-modal');
    const userEmailSpan = document.getElementById('user-email-to-delete');
    const userIdSpan = document.getElementById('user-id-to-delete');
    
    if (!modal) return;
    
    if (userEmailSpan) userEmailSpan.textContent = userEmail;
    if (userIdSpan) userIdSpan.textContent = userId;
    
    // ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚¿ãƒ–ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã‚¿ãƒ–ã®åˆæœŸè¨­å®š
    setupDeleteModalTabs(userId, userEmail);
    
    modal.classList.remove('hidden');
}

/**
 * å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ãƒ–è¨­å®š
 */
function setupDeleteModalTabs(userId, userEmail) {
    const accessTab = document.getElementById('tab-access');
    const deleteTab = document.getElementById('tab-delete');
    const accessBtn = document.getElementById('tab-btn-access');
    const deleteBtn = document.getElementById('tab-btn-delete');
    
    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã‚’å–å¾—ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚¿ãƒ–ã‚’è¨­å®š
    const user = currentUserList.find(u => u.userId === userId);
    if (user && accessTab) {
        const userToggle = document.getElementById('user-access-toggle');
        if (userToggle) {
            const isActive = user.isActive === true || String(user.isActive).toLowerCase() === 'true';
            userToggle.checked = isActive;
        }
    }
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    if (accessBtn && deleteBtn && accessTab && deleteTab) {
        accessBtn.onclick = () => switchDeleteModalTab('access');
        deleteBtn.onclick = () => switchDeleteModalTab('delete');
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚¿ãƒ–ã‚’è¡¨ç¤º
        switchDeleteModalTab('access');
    }
}

/**
 * å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
 */
function switchDeleteModalTab(tabName) {
    const accessTab = document.getElementById('tab-access');
    const deleteTab = document.getElementById('tab-delete');
    const accessBtn = document.getElementById('tab-btn-access');
    const deleteBtn = document.getElementById('tab-btn-delete');
    
    if (tabName === 'access') {
        if (accessTab) accessTab.classList.remove('hidden');
        if (deleteTab) deleteTab.classList.add('hidden');
        if (accessBtn) accessBtn.classList.add('border-purple-500', 'text-purple-400');
        if (deleteBtn) deleteBtn.classList.remove('border-purple-500', 'text-purple-400');
    } else {
        if (accessTab) accessTab.classList.add('hidden');
        if (deleteTab) deleteTab.classList.remove('hidden');
        if (accessBtn) accessBtn.classList.remove('border-purple-500', 'text-purple-400');
        if (deleteBtn) deleteBtn.classList.add('border-purple-500', 'text-purple-400');
    }
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã‚’ä¿å­˜
 */
function saveUserAccessSettings() {
    if (!userToDelete) return;
    
    const userToggle = document.getElementById('user-access-toggle');
    const saveBtn = document.getElementById('save-access-settings');
    
    if (!userToggle || !saveBtn) return;
    
    const newActiveStatus = userToggle.checked;
    const originalText = saveBtn.textContent;
    
    saveBtn.disabled = true;
    saveBtn.textContent = 'ä¿å­˜ä¸­...';
    
    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                loadUserList();
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeDeleteModal();
            } else {
                alert('è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
            }
            
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        })
        .withFailureHandler(error => {
            console.error('Save user access settings error:', error);
            alert('è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        })
        .updateUserActiveStatusForUI(userToDelete.userId, newActiveStatus);
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚’ç¢ºå®šå®Ÿè¡Œ
 */
function confirmDeletion() {
    if (!userToDelete) return;
    
    const reasonTextarea = document.getElementById('deletion-reason');
    const reason = reasonTextarea ? reasonTextarea.value.trim() : '';
    
    if (!reason || reason.length < 20) {
        alert('å‰Šé™¤ç†ç”±ã‚’20æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    if (!confirm(`æœ¬å½“ã« ${userToDelete.userEmail} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
    }
    
    const deleteBtn = document.querySelector('button[onclick="confirmDeletion()"]');
    const originalText = deleteBtn ? deleteBtn.textContent : '';
    
    if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.textContent = 'å‰Šé™¤ä¸­...';
    }
    
    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                loadUserList();
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeDeleteModal();
            } else {
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
            }
            
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.textContent = originalText;
            }
        })
        .withFailureHandler(error => {
            console.error('Delete user error:', error);
            alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.textContent = originalText;
            }
        })
        .deleteUserAccountByAdminForUI(userToDelete.userId, reason);
}

/**
 * å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
 */
function closeDeleteModal() {
    const modal = document.getElementById('delete-modal');
    const reasonTextarea = document.getElementById('deletion-reason');
    
    if (modal) modal.classList.add('hidden');
    if (reasonTextarea) reasonTextarea.value = '';
    
    userToDelete = null;
}

/**
 * å‰Šé™¤ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showDeletionLogs() {
    google.script.run
        .withSuccessHandler(result => {
            if (result.status === 'success') {
                showLogsModal(result.logs, 'deletion');
            } else {
                alert('å‰Šé™¤ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
            }
        })
        .withFailureHandler(error => {
            console.error('Failed to fetch deletion logs:', error);
            alert('å‰Šé™¤ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getDeletionLogsForUI();
}

/**
 * ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆå‰Šé™¤ãƒ­ã‚°ç”¨ï¼‰
 */
function showLogsModal(logs, type) {
    const modal = document.getElementById('logs-modal');
    const title = modal.querySelector('h3');
    const header = document.getElementById('dynamic-header');
    const tbody = document.getElementById('logs-table-body');
    
    if (!modal || !header || !tbody) return;
    
    if (type === 'deletion') {
        title.textContent = 'ğŸ“‹ å‰Šé™¤ãƒ­ã‚°';
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
        header.innerHTML = `
            <tr>
                <th class="px-4 py-2 text-left">å‰Šé™¤æ—¥æ™‚</th>
                <th class="px-4 py-2 text-left">å®Ÿè¡Œè€…</th>
                <th class="px-4 py-2 text-left">å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                <th class="px-4 py-2 text-left">å‰Šé™¤ç†ç”±</th>
                <th class="px-4 py-2 text-left">ã‚¿ã‚¤ãƒ—</th>
            </tr>
        `;
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        if (!logs || logs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-4 py-8 text-center text-gray-400">
                        å‰Šé™¤ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = logs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('ja-JP');
                return `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-4 py-2 text-sm text-gray-300">${timestamp}</td>
                        <td class="px-4 py-2 text-sm text-white">${log.executorEmail || ''}</td>
                        <td class="px-4 py-2 text-sm text-gray-300">${log.targetEmail || ''}</td>
                        <td class="px-4 py-2 text-sm text-gray-300">${log.reason || ''}</td>
                        <td class="px-4 py-2 text-sm text-gray-300">${log.deleteType || ''}</td>
                    </tr>
                `;
            }).join('');
        }
    }
    
    modal.classList.remove('hidden');
}
</script>