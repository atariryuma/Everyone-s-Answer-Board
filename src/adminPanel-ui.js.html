<script>
// =============================================================================
// ADMIN PANEL UI UPDATES & DISPLAY CONTROL
// =============================================================================

// =============================================================================
// MAIN UI UPDATE FUNCTIONS
// =============================================================================

// Update UI with new status data
function updateUIWithNewStatus(status) {
  if (!validateStatus(status)) {
    console.warn('Invalid status received, skipping UI update');
    return;
  }
  
  currentStatus = status;
  console.log('âœ… AdminPanel: Status updated');
  
  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ç¢ºèª
  const setupStatus = getSetupStatusFromUserInfo(status.userInfo);
  console.log('ğŸ”§ Setup Status:', setupStatus);
  
  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†æ™‚ã®å°‚ç”¨å‡¦ç†
  if (setupStatus === 'pending') {
    updateUIForSetupPending(status);
    return; // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†æ™‚ã¯é€šå¸¸ã®UIæ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—
  }
  
  // Update static UI elements first
  updateStaticUI(status);
  
  // Update dynamic content based on state
  if (status.activeSheetName) {
    updateDynamicContent(status);
  } else {
    updateUIForNoActiveSheet(status);
  }
  
  // Update footer and guidance
  updateFooterAndGuidance(status);
  
  // Update step indicators
  updateStepIndicators(status.setupStep || 1);
}

// Update static UI elements
function updateStaticUI(status) {
  // Update database info panel
  updateDatabaseInfo(status);
  
  // Update existing user section
  updateExistingUserSection(status);
  
  // Populate sheet selection
  populateSheetSelect(status.allSheets, status.activeSheetName);
  
  // Update custom form info
  updateCustomFormInfo(status);
  
  // Check for auto-publish dialog
  checkAutoPublishDialog(status);
}

// =============================================================================
// DATABASE INFO PANEL UPDATES
// =============================================================================

function updateDatabaseInfo(status) {
  if (!status || !status.userInfo) {
    console.warn('System info update failed: No user info available');
    return;
  }

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’è¨­å®š
  if (status.userInfo.spreadsheetUrl) {
    currentSpreadsheetUrl = status.userInfo.spreadsheetUrl;
  }

  // åŸºæœ¬æƒ…å ±ã®æ›´æ–°
  safeSetText('info-admin-email', status.userInfo.adminEmail);
  safeSetText('info-user-id', status.userInfo.userId);
  safeSetText('info-published-sheet', status.publishedSheetName || 'ãªã—');
  safeSetText('info-answer-count', status.answerCount || '0');
  safeSetText('info-reaction-count', status.totalReactions || '0');

  // å…¬é–‹çŠ¶æ…‹ã®è¡¨ç¤ºã‚’æ›´æ–°
  const isPublished = status && (status.appPublished || (status.activeSheetName && status.publishedSheetName));
  updatePublicationStatusUI(isPublished);
  
  // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®æ›´æ–°
  const displayMode = status.showNames ? 'åå‰è¡¨ç¤º' : 'åŒ¿åè¡¨ç¤º';
  safeSetText('info-display-mode', displayMode);
  
  // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã®æ›´æ–°
  const showCounts = status.showCounts !== undefined ? (status.showCounts ? 'è¡¨ç¤º' : 'éè¡¨ç¤º') : 'è¡¨ç¤º';
  safeSetText('info-show-counts', showCounts);
  
  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹åŒæœŸ
  syncCheckboxStates(status);
}

// Update publication status UI
function updatePublicationStatusUI(isPublished) {
  const statusElement = safeGetElement('info-publish-status');
  const indicatorElement = safeGetElement('info-publish-indicator');
  const textElement = safeGetElement('info-publish-text');
  
  if (statusElement) {
    if (isPublished) {
      statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-green-600 text-white';
      if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-green-400';
      if (textElement) textElement.textContent = 'å…¬é–‹ä¸­';
    } else {
      statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-gray-600 text-gray-300';
      if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      if (textElement) textElement.textContent = 'éå…¬é–‹';
    }
  }
}

// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åŒæœŸã™ã‚‹é–¢æ•°
function syncCheckboxStates(status) {
  // è¨­å®šãƒ‡ãƒ¼ã‚¿ã®å„ªå…ˆé †ä½: å…¬é–‹ã‚·ãƒ¼ãƒˆè¨­å®š > ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š > ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  const activeSheetName = status.activeSheetName || status.publishedSheetName;
  const sheetConfig = activeSheetName && status.systemStatus ? 
    status.systemStatus[`sheet_${activeSheetName}`] : null;
  
  // showNames ã®å€¤ã‚’æ±ºå®š
  const showNames = sheetConfig?.showNames !== undefined ? 
    sheetConfig.showNames : 
    (status.showNames !== undefined ? status.showNames : false);
  
  // showCounts ã®å€¤ã‚’æ±ºå®š
  const showCounts = sheetConfig?.showCounts !== undefined ? 
    sheetConfig.showCounts : 
    (status.showCounts !== undefined ? status.showCounts : true);

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
  const showNamesCheckbox = safeGetElement('show-names');
  const showCountsCheckbox = safeGetElement('show-counts');
  
  if (showNamesCheckbox) {
    showNamesCheckbox.checked = showNames;
  }
  
  if (showCountsCheckbox) {
    showCountsCheckbox.checked = showCounts;
  }
}

// =============================================================================
// SHEET SELECTION AND CONFIGURATION
// =============================================================================

// Populate sheet selection dropdown
function populateSheetSelect(sheetNames, activeSheetName) {
  const select = document.getElementById('sheet-select');
  if (!select) {
    console.warn('Sheet select element not found');
    return;
  }

  // Clear existing options
  select.innerHTML = '<option value="">-- ã‚·ãƒ¼ãƒˆã‚’é¸æŠ --</option>';
  
  if (sheetNames && sheetNames.length > 0) {
    sheetNames.forEach(sheet => {
      const option = document.createElement('option');
      option.value = sheet.name;
      option.textContent = sheet.name;
      select.appendChild(option);
    });
    select.disabled = false;
  } else {
    select.innerHTML = '<option value="">åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
    select.disabled = true;
  }
  
  // Set active sheet if available
  if (activeSheetName) {
    select.value = activeSheetName;
    selectedSheet = activeSheetName;
  }
  
  // Add change event listener for data preview
  select.removeEventListener('change', handleSheetSelectionChange);
  select.addEventListener('change', handleSheetSelectionChange);
  
  // Update UI for selected sheet
  updateUIForSelectedSheet();
}

// Populate header options for configuration
function populateHeaderOptions(headers) {
  const selects = [
    'opinion-column',
    'name-column', 
    'class-column',
    'timestamp-column'
  ];
  
  selects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      // Store current value
      const currentValue = select.value;
      
      // Clear and repopulate
      select.innerHTML = '<option value="">-- åˆ—ã‚’é¸æŠ --</option>';
      
      headers.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      
      // Restore previous value if still valid
      if (currentValue && headers.includes(currentValue)) {
        select.value = currentValue;
      }
    }
  });
}

// Populate configuration with guessed values
function populateConfig(cfg) {
  if (!cfg) return;
  
  const mappings = {
    'opinion-column': cfg.opinionColumn,
    'name-column': cfg.nameColumn,
    'class-column': cfg.classColumn,
    'timestamp-column': cfg.timestampColumn,
    'show-names': cfg.showNames,
    'show-counts': cfg.showCounts
  };
  
  Object.keys(mappings).forEach(elementId => {
    const element = document.getElementById(elementId);
    const value = mappings[elementId];
    
    if (element && value !== undefined) {
      if (element.type === 'checkbox') {
        element.checked = Boolean(value);
      } else {
        element.value = value;
      }
    }
  });
  
  updateConfigButtons();
}

// Clear configuration fields
function clearConfigFields() {
  const fieldIds = [
    'opinion-column',
    'name-column',
    'class-column', 
    'timestamp-column'
  ];
  
  fieldIds.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.value = '';
    }
  });
  
  updateConfigButtons();
}

// Build configuration object from form
function buildConfigObject() {
  return {
    sheetName: selectedSheet,
    opinionColumn: document.getElementById('opinion-column')?.value || '',
    nameColumn: document.getElementById('name-column')?.value || '',
    classColumn: document.getElementById('class-column')?.value || '',
    timestampColumn: document.getElementById('timestamp-column')?.value || '',
    showNames: document.getElementById('show-names')?.checked || false,
    showCounts: document.getElementById('show-counts')?.checked !== false // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆtrue
  };
}

// Validate configuration
function validateConfig() {
  const opinionColumn = document.getElementById('opinion-column')?.value;
  return opinionColumn && opinionColumn.trim() !== '';
}

// Update configuration buttons state
function updateConfigButtons() {
  const isValid = validateConfig();
  const saveBtn = document.getElementById('save-publish-btn');
  
  if (saveBtn) {
    saveBtn.disabled = !isValid;
    if (isValid) {
      saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }
}

// =============================================================================
// STEP INDICATORS AND GUIDANCE
// =============================================================================

// Update step indicators
function updateStepIndicators(currentStep) {
  const steps = [
    document.getElementById('step-1-indicator'),
    document.getElementById('step-2-indicator'),
    document.getElementById('step-3-indicator')
  ];

  steps.forEach((step, index) => {
    if (!step) return;
    
    const stepNumber = index + 1;
    const circle = step.querySelector('div');
    const text = step.querySelector('span');

    if (stepNumber < currentStep) {
      // å®Œäº†ã—ãŸã‚¹ãƒ†ãƒƒãƒ—
      if (circle) {
        circle.className = 'w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all';
      }
      if (text) {
        text.classList.remove('text-gray-500');
        text.classList.add('text-gray-300');
      }
    } else if (stepNumber === currentStep) {
      // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—
      if (circle) {
        circle.className = 'w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all ring-2 ring-blue-400 ring-offset-2 ring-offset-gray-800';
      }
      if (text) {
        text.classList.remove('text-gray-500');
        text.classList.add('text-white', 'font-semibold');
      }
    } else {
      // æœªå®Œäº†ã®ã‚¹ãƒ†ãƒƒãƒ—
      if (circle) {
        circle.className = 'w-6 h-6 bg-gray-600 text-gray-400 rounded-full flex items-center justify-center font-bold text-xs transition-all';
      }
      if (text) {
        text.classList.remove('text-white', 'font-semibold');
        text.classList.add('text-gray-500');
      }
    }
  });
}

// Update footer and guidance text
function updateFooterAndGuidance(status) {
  const footer = document.getElementById('admin-footer');
  const guidanceText = document.getElementById('guidance-text');
  
  if (!footer || !guidanceText) return;

  const isPublished = status.isPublished;

  if (isPublished && status.appUrls && status.appUrls.viewUrl) {
    footer.classList.remove('hidden');
    
    // Update board URL
    const boardUrlInput = document.getElementById('board-url');
    const viewBoardLink = document.getElementById('view-board-link');
    
    if (boardUrlInput) boardUrlInput.value = status.appUrls.viewUrl;
    if (viewBoardLink) viewBoardLink.href = status.appUrls.viewUrl;
    
    // Update topic text
    updateTopicText(status);
    
    guidanceText.textContent = 'å›ç­”ãƒœãƒ¼ãƒ‰ã¯ç¾åœ¨å…¬é–‹ä¸­ã§ã™ã€‚';
  } else {
    footer.classList.add('hidden');
    
    // Update guidance based on setup step
    updateGuidanceForStep(status.setupStep || 1, guidanceText);
  }
  
  adjustLayout();
}

// Update topic text in footer
function updateTopicText(status) {
  const topicTextElement = document.getElementById('current-topic-text');
  if (!topicTextElement) return;
  
  let topic = 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
  
  if (status.customFormInfo && status.customFormInfo.mainQuestion) {
    topic = status.customFormInfo.mainQuestion;
  } else if (status.publishedSheetName && status.userInfo && status.userInfo.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      const sheetKey = 'sheet_' + status.publishedSheetName;
      const sheetConfig = config[sheetKey] || {};
      topic = sheetConfig.opinionHeader || status.publishedSheetName || 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
    } catch (e) {
      topic = status.publishedSheetName || 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
    }
  }
  
  topicTextElement.textContent = topic;
}

// Update guidance text for specific step
function updateGuidanceForStep(step, guidanceElement) {
  const messages = {
    1: 'ã‚¹ãƒ†ãƒƒãƒ—1: ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã¾ãŸã¯æ—¢å­˜ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚',
    2: 'ã‚¹ãƒ†ãƒƒãƒ—2: è¡¨ç¤ºã—ãŸã„ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚',
    3: 'ã‚¹ãƒ†ãƒƒãƒ—3: åˆ—ã‚’è¨­å®šã—ã¦ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¾ã—ã‚‡ã†ã€‚'
  };
  
  guidanceElement.textContent = messages[step] || 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚';
}

// =============================================================================
// SECTION TOGGLE FUNCTIONALITY
// =============================================================================

// Toggle section expansion/collapse
function toggleSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (!section) {
    console.warn('Section not found:', sectionId);
    return;
  }
  
  // Find the toggle button for this section
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  const arrow = toggleBtn ? toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up') : null;
  
  // Toggle the section visibility
  if (section.classList.contains('hidden')) {
    // Show section
    section.classList.remove('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'true');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-up');
      arrow.classList.add('fa-chevron-down');
    }
  } else {
    // Hide section
    section.classList.add('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'false');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-down');
      arrow.classList.add('fa-chevron-up');
    }
  }
}

// =============================================================================
// MODAL MANAGEMENT
// =============================================================================

// Show form configuration modal
function showFormConfigModal() {
  const modal = document.getElementById('form-config-modal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    loadSavedClassChoices();
    manageFocusForModal('form-config-modal', true);
  }
}

// Hide form configuration modal
function hideFormConfigModal() {
  const modal = document.getElementById('form-config-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('form-config-modal', false);
  }
}

// Show privacy modal
function showPrivacyModal(onContinue) {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('privacy-modal', true);
    
    // Set up continue handler
    const continueBtn = document.getElementById('privacy-modal-continue');
    if (continueBtn && onContinue) {
      continueBtn.onclick = onContinue;
    }
  }
}

// Hide privacy modal
function hidePrivacyModal() {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('privacy-modal', false);
  }
}

// Show digital citizenship modal
function showDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('digital-citizenship-modal', true);
  }
}

// Hide digital citizenship modal
function hideDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('digital-citizenship-modal', false);
  }
}

// Show confirmation modal
function showConfirmationModal(title, message, onConfirm) {
  const modal = document.getElementById('confirmation-modal');
  const titleElement = document.getElementById('confirmation-title');
  const messageElement = document.getElementById('confirmation-message');
  const confirmBtn = document.getElementById('confirmation-confirm');
  
  if (modal && titleElement && messageElement && confirmBtn) {
    titleElement.textContent = title;
    messageElement.textContent = message;
    
    confirmBtn.onclick = function() {
      hideConfirmationModal();
      if (onConfirm) onConfirm();
    };
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('confirmation-modal', true);
  }
}

// Hide confirmation modal
function hideConfirmationModal() {
  const modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('confirmation-modal', false);
  }
}

// =============================================================================
// DYNAMIC CONTENT UPDATES
// =============================================================================

// Update dynamic content when board is active
function updateDynamicContent(status) {
  // Enable buttons that require active state
  const buttons = [
    'open-spreadsheet-btn',
    'open-form-btn'
  ];
  
  buttons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = false;
      button.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  });
}

// Update UI when no sheet is active
function updateUIForNoActiveSheet(status) {
  // Disable buttons that require active state
  const buttons = [
    'open-form-btn'
  ];
  
  buttons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = true;
      button.classList.add('opacity-50', 'cursor-not-allowed');
    }
  });
}

// Update existing user section
function updateExistingUserSection(status) {
  // Update any user-specific UI elements
  if (status.userInfo) {
    // Update user-specific elements here if needed
  }
}

// Update custom form info
function updateCustomFormInfo(status) {
  if (status.customFormInfo) {
    // Update form-related UI elements
    const formTitle = document.getElementById('form-title-display');
    const formQuestion = document.getElementById('form-question-display');
    
    if (formTitle) {
      formTitle.textContent = status.customFormInfo.title || 'ãƒ•ã‚©ãƒ¼ãƒ æœªä½œæˆ';
    }
    
    if (formQuestion) {
      formQuestion.textContent = status.customFormInfo.mainQuestion || '';
    }
  }
}

// Check for auto-publish dialog
function checkAutoPublishDialog(status) {
  // Implementation for auto-publish dialog if needed
  if (status.needsAutoPublish) {
    // Show auto-publish confirmation
  }
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize UI components
function initializeUI() {
  console.log('âœ… AdminPanel: UI components ready');
  
  // Load initial status
  loadStatus();
}

// =============================================================================
// DATA PREVIEW FUNCTIONALITY
// =============================================================================

// Handle sheet selection change for data preview
function handleSheetSelectionChange(event) {
  const selectedSheet = event.target.value;
  const previewSection = document.getElementById('data-preview-section');
  
  if (selectedSheet && previewSection) {
    previewSection.classList.remove('hidden');
    loadDataPreview(selectedSheet);
  } else if (previewSection) {
    previewSection.classList.add('hidden');
  }
}

// Load data preview for selected sheet
function loadDataPreview(sheetName) {
  const previewContent = document.getElementById('data-preview-content');
  if (!previewContent) return;
  
  // Show loading state
  previewContent.innerHTML = `
    <div class="animate-pulse">
      <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
      <div class="h-4 bg-gray-700 rounded w-1/2"></div>
    </div>
  `;
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    previewContent.innerHTML = '<p class="text-red-400">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
    return;
  }
  
  runGasWithUserId('getSheetDetails', currentStatus.userInfo.spreadsheetId, sheetName)
    .then(function(details) {
      if (details && details.headers) {
        const headersList = details.headers.slice(0, 5); // First 5 headers
        const moreHeaders = details.headers.length > 5 ? `...ä»–${details.headers.length - 5}åˆ—` : '';
        
        previewContent.innerHTML = `
          <div class="text-sm">
            <div class="mb-2">
              <span class="text-gray-400">åˆ—æ•°:</span>
              <span class="text-white font-medium">${details.headers.length}åˆ—</span>
            </div>
            <div class="mb-2">
              <span class="text-gray-400">ä¸»è¦ãªåˆ—:</span>
              <div class="flex flex-wrap gap-1 mt-1">
                ${headersList.map(header => `
                  <span class="px-2 py-1 bg-blue-500/20 text-blue-200 rounded text-xs">${header}</span>
                `).join('')}
                ${moreHeaders ? `<span class="text-gray-400 text-xs">${moreHeaders}</span>` : ''}
              </div>
            </div>
            <div class="text-xs text-gray-400 mt-2">
              ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’ç¢ºèªã—ã¦ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§åˆ—è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„
            </div>
          </div>
        `;
      } else {
        previewContent.innerHTML = '<p class="text-yellow-400">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>';
      }
    })
    .catch(function(error) {
      console.error('Data preview error:', error);
      previewContent.innerHTML = '<p class="text-red-400">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
    });
}

// =============================================================================
// SETUP STATUS HANDLING FUNCTIONS
// =============================================================================

/**
 * userInfoã‹ã‚‰setupStatusã‚’å®‰å…¨ã«å–å¾—
 * @param {Object} userInfo - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} setupStatus ('pending', 'completed', 'error')
 */
function getSetupStatusFromUserInfo(userInfo) {
  try {
    if (!userInfo || !userInfo.configJson) {
      return 'pending'; // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒãªã„å ´åˆã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†ã¨ã¿ãªã™
    }
    
    const config = typeof userInfo.configJson === 'string' 
      ? JSON.parse(userInfo.configJson) 
      : userInfo.configJson;
    
    // setupStatusãŒæ˜ç¤ºçš„ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
    if (config.setupStatus) {
      return config.setupStatus;
    }
    
    // setupStatusãŒãªã„å ´åˆã€ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰æ¨æ¸¬
    if (config.appPublished === true && config.formCreated === true) {
      return 'completed';
    }
    
    return 'pending';
    
  } catch (error) {
    console.warn('getSetupStatusFromUserInfo JSONè§£æã‚¨ãƒ©ãƒ¼:', error.message);
    return 'pending'; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†ã¨ã¿ãªã™
  }
}

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†æ™‚ã®å°‚ç”¨UIå‡¦ç†
 * @param {Object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function updateUIForSetupPending(status) {
  console.log('ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†ãƒ¢ãƒ¼ãƒ‰ã§UIæ›´æ–°é–‹å§‹');
  
  try {
    // 1. å…¨ä½“çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    showSetupPendingMessage();
    
    // 2. å…¬é–‹é–¢é€£ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    disablePublishingButtons();
    
    // 3. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
    showSetupGuide(status);
    
    // 4. åŸºæœ¬çš„ãªé™çš„UIè¦ç´ ã¯æ›´æ–°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç­‰ï¼‰
    updateBasicStaticUI(status);
    
    console.log('âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†ãƒ¢ãƒ¼ãƒ‰ UIæ›´æ–°å®Œäº†');
    
  } catch (error) {
    console.error('updateUIForSetupPending ã‚¨ãƒ©ãƒ¼:', error);
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®UIæ›´æ–°ã‚’å®Ÿè¡Œ
    updateStaticUI(status);
  }
}

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
 */
function showSetupPendingMessage() {
  // å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã‚’å–å¾—ï¼ˆå·¦ãƒ‘ãƒãƒ«ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼‰
  const messageContainer = document.querySelector('.left-panel') || 
                          document.querySelector('.responsive-grid') ||
                          document.getElementById('data-setup-section');
  
  if (messageContainer) {
    // æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å‰ã«æŒ¿å…¥ï¼ˆç½®æ›ã§ã¯ãªãï¼‰
    const setupGuide = document.createElement('div');
    setupGuide.id = 'setup-pending-guide';
    setupGuide.className = 'setup-pending-overlay glass-panel p-6 mb-6';
    setupGuide.innerHTML = `
      <div class="text-center">
        <div class="text-4xl mb-4">âš™ï¸</div>
        <h2 class="text-xl font-bold text-gray-800 mb-3">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã—ã¦ãã ã•ã„</h2>
        <p class="text-gray-600 mb-4 text-sm">ç®¡ç†ãƒ‘ãƒãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é€²ã‚ã¦ãã ã•ã„</p>
        <div class="setup-steps text-left max-w-sm mx-auto">
          <div class="step-item flex items-center mb-2 p-2 bg-white/50 rounded-lg">
            <span class="step-number bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 text-xs font-bold">1</span>
            <span class="text-gray-700 text-sm">ğŸ“Š ãƒ‡ãƒ¼ã‚¿æº–å‚™</span>
          </div>
          <div class="step-item flex items-center mb-2 p-2 bg-white/50 rounded-lg">
            <span class="step-number bg-gray-400 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 text-xs font-bold">2</span>
            <span class="text-gray-500 text-sm">ğŸ›ï¸ ã‚·ãƒ¼ãƒˆãƒ»åˆ—è¨­å®š</span>
          </div>
          <div class="step-item flex items-center mb-2 p-2 bg-white/50 rounded-lg">
            <span class="step-number bg-gray-400 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 text-xs font-bold">3</span>
            <span class="text-gray-500 text-sm">ğŸš€ å…¬é–‹è¨­å®š</span>
          </div>
        </div>
      </div>
    `;
    
    // æ—¢å­˜ã®ã‚¬ã‚¤ãƒ‰ãŒã‚ã‚Œã°å‰Šé™¤
    const existingGuide = document.getElementById('setup-pending-guide');
    if (existingGuide) {
      existingGuide.remove();
    }
    
    // æœ€åˆã®å­è¦ç´ ã¨ã—ã¦æŒ¿å…¥
    messageContainer.insertBefore(setupGuide, messageContainer.firstChild);
  } else {
    console.warn('showSetupPendingMessage: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  }
}

/**
 * å…¬é–‹é–¢é€£ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆsetupStatusæœªå®Œäº†æ™‚ï¼‰
 */
function disablePublishingButtons() {
  // å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹å…¬é–‹é–¢é€£ãƒœã‚¿ãƒ³ã®ã¿
  const publishButtons = [
    'save-publish-btn',
    'unpublish-board-btn'
  ];
  
  // æ®µéšçš„UIåˆ¶å¾¡ã§ç„¡åŠ¹åŒ–ã™ã¹ãè¿½åŠ è¦ç´ 
  const setupRelatedElements = [
    'open-spreadsheet-btn',
    'open-form-btn', 
    'open-resource-btn',
    'reguess-headers-btn',
    'add-resource-btn'
  ];
  
  // è¨­å®šé–¢é€£ã®å…¥åŠ›è¦ç´ 
  const configElements = [
    'sheet-select',
    'opinion-column',
    'name-column',
    'class-column',
    'timestamp-column',
    'show-names',
    'show-counts'
  ];
  
  const allElementsToDisable = [...publishButtons, ...setupRelatedElements, ...configElements];
  
  let disabledCount = 0;
  let notFoundCount = 0;
  
  allElementsToDisable.forEach(elementId => {
    const element = document.getElementById(elementId);
    if (element) {
      element.disabled = true;
      element.classList.add('opacity-50', 'cursor-not-allowed');
      element.title = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã—ã¦ãã ã•ã„';
      disabledCount++;
    } else {
      notFoundCount++;
      console.debug(`disablePublishingButtons: è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${elementId}`);
    }
  });
  
  console.log(`âœ… UIè¦ç´ ç„¡åŠ¹åŒ–å®Œäº†: ${disabledCount}å€‹ç„¡åŠ¹åŒ–, ${notFoundCount}å€‹æœªç™ºè¦‹`);
}

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
 * @param {Object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function showSetupGuide(status) {
  // å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹å·¦ãƒ‘ãƒãƒ«ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
  const leftPanel = document.querySelector('.left-panel') || 
                   document.getElementById('system-info-panel');
  
  if (leftPanel) {
    // æ—¢å­˜ã®ã‚¬ã‚¤ãƒ‰ãŒã‚ã‚Œã°å‰Šé™¤
    const existingGuide = leftPanel.querySelector('.setup-guide');
    if (existingGuide) {
      existingGuide.remove();
    }
    
    const guideElement = document.createElement('div');
    guideElement.className = 'setup-guide bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4';
    guideElement.innerHTML = `
      <h3 class="text-sm font-semibold text-yellow-800 mb-2">ğŸ“‹ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰</h3>
      <ol class="text-xs text-yellow-700 space-y-1">
        <li>1. Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ</li>
        <li>2. ãƒ‡ãƒ¼ã‚¿åˆ—ã‚’è¨­å®š</li>
        <li>3. ã‚·ãƒ¼ãƒˆåã¨åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¨­å®š</li>
        <li>4. ã‚¢ãƒ—ãƒªã‚’å…¬é–‹</li>
      </ol>
    `;
    leftPanel.insertBefore(guideElement, leftPanel.firstChild);
  } else {
    console.warn('showSetupGuide: å·¦ãƒ‘ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  }
}

/**
 * åŸºæœ¬çš„ãªé™çš„UIè¦ç´ ã®ã¿æ›´æ–°
 * @param {Object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function updateBasicStaticUI(status) {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãªã©æœ€ä½é™ã®æƒ…å ±ã®ã¿æ›´æ–°
  if (status.userInfo) {
    // æ—¢å­˜ã®updateDatabaseInfoé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦é‡è¤‡ã‚’é¿ã‘ã‚‹
    updateDatabaseInfo(status);
  }
}

// Initialize when DOM is ready
if (document.readyState !== 'loading') {
  setTimeout(initializeUI, 300);
} else {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeUI, 300);
  });
}
</script>
