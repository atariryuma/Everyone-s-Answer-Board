<script>
let lastSelectedSheetName = null; // To prevent redundant sheet selection change events

// UI Update Mutex to prevent race conditions
let isUIUpdateInProgress = false;
let pendingUIUpdate = null;

// =============================================================================
// EARLY FUNCTION DEFINITIONS (Critical functions that must be available immediately)
// =============================================================================

// Define critical functions early and register them globally
if (typeof window !== 'undefined') {
  // Placeholder functions that will be properly defined later
  // All critical functions are now defined in adminPanel-framework.js.html which loads first
  // Keeping only functions not moved to framework
  window.hideFormConfigModal = window.hideFormConfigModal || function() { console.warn('hideFormConfigModal not yet loaded'); };
  window.showPrivacyModal = window.showPrivacyModal || function() { console.warn('showPrivacyModal not yet loaded'); };
}


// =============================================================================
// ADMIN PANEL UI UPDATES & DISPLAY CONTROL
// =============================================================================

// =============================================================================
// UTILITY FUNCTIONS
// =============================================================================

// Unified publication state detection with enhanced flow completion recognition
function getPublicationState(status) {
  if (!status) {
    return { isPublished: false, reason: 'No status data' };
  }
  
  // Check multiple possible publication indicators in priority order
  let isPublished = false;
  let reason = '';
  
  // 1. Direct isPublished property
  if (status.isPublished === true) {
    isPublished = true;
    reason = 'status.isPublished=true';
  }
  // 2. Direct appPublished property  
  else if (status.appPublished === true) {
    isPublished = true;
    reason = 'status.appPublished=true';
  }
  // 3. Check configJson for appPublished
  else if (status.userInfo?.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      if (config.appPublished === true) {
        isPublished = true;
        reason = 'configJson.appPublished=true';
        
        // Enhanced validation: Verify setup completion indicators
        const hasCompletedSetup = (
          config.setupStatus === 'completed' &&
          config.formCreated === true &&
          config.publishedSheetName &&
          config.publishedSpreadsheetId
        );
        
        if (hasCompletedSetup) {
          reason += ' („Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊ∏à„Åø)';
        } else {
          console.log('‚ö†Ô∏è Publication state: appPublished=true but setup incomplete', {
            setupStatus: config.setupStatus,
            formCreated: config.formCreated,
            hasPublishedSheet: !!config.publishedSheetName,
            hasPublishedSpreadsheet: !!config.publishedSpreadsheetId
          });
          reason += ' („Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó‰∏çÂÆåÂÖ®)';
        }
      } 
      // 4. Enhanced completion check: Allow recognition of completed but not yet published setups
      else if (config.setupStatus === 'completed' && 
               config.formCreated === true && 
               config.publishedSheetName && 
               config.publishedSpreadsheetId) {
        // This covers cases where setup is complete but appPublished might not be properly set
        console.log('üîß Publication state: Setup complete but appPublished=false - potential state inconsistency');
        reason = '„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü„Å†„ÅåÂÖ¨ÈñãÁä∂ÊÖã‰∏çÊï¥Âêà';
        // Don't auto-publish, but log for debugging
      }
    } catch (e) {
      console.warn('Failed to parse configJson:', e);
    }
  }
  
  // Maintained strict logic to prevent false positives
  // Note: Removed loose fallback logic that assumed activeSheetName = published
  
  return { 
    isPublished, 
    reason,
    // Add confidence level for better debugging
    confidence: isPublished ? (reason.includes('„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊ∏à„Åø') ? 'high' : 'medium') : 'low'
  };
}

// Generate viewUrl with comprehensive fallback logic
function generateViewUrl(status, userId) {
  // 1. Use existing viewUrl if available
  let viewUrl = status.appUrls?.viewUrl;
  if (viewUrl) {
    return viewUrl;
  }
  
  // 2. Generate from appUrls.webApp with userId
  if (status.appUrls?.webApp && userId) {
    return status.appUrls.webApp + '?userId=' + encodeURIComponent(userId) + '&mode=view';
  }
  
  // 3. Generate from status.webAppUrl with userId
  if (status.webAppUrl && userId) {
    return status.webAppUrl + '?userId=' + encodeURIComponent(userId) + '&mode=view';
  }
  
  // 4. Simple fallback without userId
  if (status.appUrls?.webApp) {
    return status.appUrls.webApp + '?mode=view';
  }
  
  logWarn('Could not generate viewUrl');
  return null;
}

// =============================================================================
// MAIN UI UPDATE FUNCTIONS
// =============================================================================

// Update UI with new status data
// Full implementation of updateUIWithNewStatus for later use
function _fullUpdateUIWithNewStatus(status) {
  if (!validateStatus(status)) {
    logWarn('Invalid status received, skipping UI update');
    return;
  }

  // UI Update Mutex: Prevent concurrent UI updates
  if (isUIUpdateInProgress) {
    logDebug('UI update in progress, queuing this update');
    pendingUIUpdate = status;
    return;
  }

  isUIUpdateInProgress = true;
  
  try {
    // Phase 1: „Éá„Éº„ÇøÊ∫ñÂÇôÔºàÂêåÊúüÂá¶ÁêÜÔºâ
    status = prepareStatusData(status);
    currentStatus = status;
    
    // Phase 2: ‰∏¶ÂàóUIÊõ¥Êñ∞ÔºàÈùûÂêåÊúüÂá¶ÁêÜ„ÅÆÊúÄÈÅ©ÂåñÔºâ
    executeParallelUIUpdates(status);
    
  } catch (error) {
    logError('UIÊõ¥Êñ∞„Åß„Ç®„É©„Éº:', error);
  } finally {
    // ÊúÄÂæå„Å´Mutex„ÇíËß£Èô§
    setTimeout(() => finishUIUpdate(), 0);
  }
}

// Make the full implementation available for the framework version
if (typeof window !== 'undefined') {
  window._fullUpdateUIWithNewStatus = _fullUpdateUIWithNewStatus;
}

// „Éá„Éº„ÇøÊ∫ñÂÇô„ÅÆÊúÄÈÅ©ÂåñÔºàÂêåÊúüÂá¶ÁêÜÈÉ®ÂàÜÔºâ
function prepareStatusData(status) {
  // 1. configJsonÊ≠£Ë¶èÂåñÂá¶ÁêÜÔºàÂåÖÊã¨ÁöÑ„Ç∑„Çπ„ÉÜ„É†ÊúÄÈÅ©ÂåñÔºâ
  status.config = normalizeConfigJson(status.config, status.userInfo);
  
  // 2. Ê≠£Ë¶èÂåñ„Åï„Çå„Åü„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆËøΩÂä†ÔºàË®àÁÆóÈõÜÁ¥ÑÂá¶ÁêÜÔºâ
  const publicationState = getPublicationState(status);
  const viewUrl = generateViewUrl(status, userId);
  
  status._normalized = {
    isPublished: publicationState.isPublished,
    publishReason: publicationState.reason,
    viewUrl: viewUrl,
    hasValidViewUrl: !!viewUrl
  };
  
  return status;
}

// ‰∏¶ÂàóUIÊõ¥Êñ∞„ÅÆÂÆüË°åÔºàÈùûÂêåÊúüÂá¶ÁêÜ„ÅÆÊúÄÈÅ©ÂåñÔºâ
function executeParallelUIUpdates(status) {
  const setupStatus = getSetupStatusFromUserInfo(status.userInfo);
  const currentStep = status.setupStep || 1;
  
  // ‰∏¶ÂàóÂÆüË°åÂèØËÉΩ„Å™Êõ¥Êñ∞„Çø„Çπ„ÇØ„ÇíÂÆöÁæ©
  const updateTasks = [
    // Task 1: ÈùôÁöÑË¶ÅÁ¥†„ÅÆÊõ¥Êñ∞
    () => {
      clearInitialDisplayElements();
      updateStaticUI(status);
      updateUnpublishButton(status);
      if (setupStatus === 'pending') {
        updateButtonStatesForSetup(status);
      }
    },
    
    // Task 2: ÂãïÁöÑ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÊõ¥Êñ∞
    () => {
      if (status.activeSheetName) {
        updateDynamicContent(status);
      } else {
        updateUIForNoActiveSheet(status);
      }
    },
    
    // Task 3: „Éï„ÉÉ„Çø„Éº„Å®„Ç¨„Ç§„ÉÄ„É≥„Çπ„ÅÆÊõ¥Êñ∞
    () => updateFooterAndGuidance(status),
    
    // Task 4: „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº„ÅÆÊõ¥Êñ∞ÔºàÁµ±ÂêàÊúÄÈÅ©ÂåñÁâàÔºâ
    () => updateStepIndicators(status?.setupStep || currentStep, status)
  ];
  
  // ‰∏¶ÂàóÂÆüË°åÔºàrequestAnimationFrame„ÅßÊúÄÈÅ©ÂåñÔºâ
  requestAnimationFrame(() => {
    // Èáç„ÅÑÂá¶ÁêÜ„ÇíË§áÊï∞„ÅÆ„Éï„É¨„Éº„É†„Å´ÂàÜÊï£
    executeTasksInBatches(updateTasks);
  });
}

// „Çø„Çπ„ÇØ„ÅÆ„Éê„ÉÉ„ÉÅÂÆüË°åÔºà„Éï„É¨„Éº„É†ÂàÜÊï£ÊúÄÈÅ©ÂåñÔºâ
function executeTasksInBatches(tasks, batchSize = 2) {
  if (tasks.length === 0) return;
  
  // ÁèæÂú®„ÅÆ„Éê„ÉÉ„ÉÅ„ÇíÂÆüË°å
  const currentBatch = tasks.splice(0, batchSize);
  currentBatch.forEach(task => {
    try {
      task();
    } catch (error) {
      logError('UIÊõ¥Êñ∞„Çø„Çπ„ÇØ„Ç®„É©„Éº:', error);
    }
  });
  
  // ÊÆã„Çä„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊ¨°„ÅÆ„Éï„É¨„Éº„É†„ÅßÂÆüË°å
  if (tasks.length > 0) {
    requestAnimationFrame(() => executeTasksInBatches(tasks, batchSize));
  }
}

// UIÊõ¥Êñ∞ÂÆå‰∫ÜÂá¶ÁêÜ
function finishUIUpdate() {
  isUIUpdateInProgress = false;
  
  // ÂæÖÊ©ü‰∏≠„ÅÆÊõ¥Êñ∞„Åå„ÅÇ„Çå„Å∞ÂÆüË°å
  if (pendingUIUpdate) {
    const nextUpdate = pendingUIUpdate;
    pendingUIUpdate = null;
    updateUIWithNewStatus(nextUpdate);
  }
}

// =============================================================================
// HELPER FUNCTIONS FOR UI UPDATES
// =============================================================================

// Update unpublish button state
function updateUnpublishButton(status) {
  const unpublishBtn = document.getElementById('unpublish-board-btn');
  if (!unpublishBtn) return;

  // Use same strict logic as footer: both normalized and explicit checks
  const isPublished = status._normalized?.isPublished || false;
  let explicitAppPublished = status.appPublished === true;
  
  if (!explicitAppPublished && status.userInfo?.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      explicitAppPublished = config.appPublished === true;
    } catch (configError) {
      console.warn('‚ùå Failed to parse configJson for unpublish button check:', configError);
      explicitAppPublished = false;
    }
  }
  
  const finalIsPublished = isPublished && explicitAppPublished;

  if (finalIsPublished) {
    unpublishBtn.classList.remove('hidden');
  } else {
    unpublishBtn.classList.add('hidden');
  }
}

// Update spreadsheet access button state
function updateSpreadsheetButton() {
  const btn = document.getElementById('open-spreadsheet-btn-step2');
  if (!btn) return;
  
  if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetUrl) {
    btn.disabled = false;
    btn.onclick = function() {
      window.open(currentStatus.userInfo.spreadsheetUrl, '_blank');
    };
    logDebug('‚úÖ Spreadsheet button enabled with URL:', currentStatus.userInfo.spreadsheetUrl);
  } else {
    btn.disabled = true;
    btn.onclick = null;
    logDebug('‚ö†Ô∏è Spreadsheet button disabled - no URL available');
  }
}

// Update static UI elements
function updateStaticUI(status) {
  // Update database info panel
  updateDatabaseInfo(status);
  
  // Update existing user section
  updateExistingUserSection(status);
  
  // Populate sheet selection - fix property name mismatch
  logDebug('üîç Debug: Checking sheet data properties', {
    allSheets: status.allSheets,
    sheetNames: status.sheetNames,
    activeSheetName: status.activeSheetName
  });
  
  const sheetsData = status.sheetNames || status.allSheets || [];
  populateSheetSelect(sheetsData, status.activeSheetName);
  
  // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Éº„Éà„ÅÆÁ¢∫ÂÆü„Å™ÂèçÊò†ÔºàÂº∑ÂåñÔºâ
  if (status.activeSheetName) {
    setTimeout(() => {
      const select = document.getElementById('sheet-select');
      if (select && select.value !== status.activeSheetName) {
        console.log('üîÑ Force updating active sheet selection:', status.activeSheetName);
        updateActiveSheetUI(status.activeSheetName);
      }
    }, 100);
  }
  
  // Update custom form info
  updateCustomFormInfo(status);
  
  // Check for auto-publish dialog
  checkAutoPublishDialog(status);
}

// =============================================================================
// DATABASE INFO PANEL UPDATES
// =============================================================================

function updateDatabaseInfo(status) {
  if (!status || !status.userInfo) {
    console.warn('System info update failed: No user info available');
    return;
  }

  // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàURL„ÇíË®≠ÂÆö
  if (status.userInfo.spreadsheetUrl) {
    currentSpreadsheetUrl = status.userInfo.spreadsheetUrl;
  }

  const cfg = status.config || {};

  // Âü∫Êú¨ÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
  safeSetText('info-admin-email', status.userInfo.adminEmail);
  safeSetText('info-user-id', status.userInfo.userId);
  safeSetText('info-published-sheet', cfg.publishedSheetName || status.publishedSheetName || '„Å™„Åó');
  

  // ÂÖ¨ÈñãÁä∂ÊÖã„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
  const isPublished = cfg.isPublished !== undefined
    ? cfg.isPublished
    : status.appPublished || status.isPublished || (status.activeSheetName && (cfg.publishedSheetName || status.publishedSheetName));
  updatePublicationStatusUI(isPublished);

  // Ë°®Á§∫„É¢„Éº„Éâ„ÅÆÊõ¥Êñ∞
  const displayModeFlag = cfg.showNames !== undefined ? cfg.showNames : status.showNames;
  const displayMode = displayModeFlag ? 'ÂêçÂâçË°®Á§∫' : 'ÂåøÂêçË°®Á§∫';
  safeSetText('info-display-mode', displayMode);

  // „Ç´„Ç¶„É≥„ÉàË°®Á§∫„ÅÆÊõ¥Êñ∞
  const showCountsFlag = cfg.showCounts !== undefined
    ? cfg.showCounts
    : (status.showCounts !== undefined ? status.showCounts : false);
  const showCounts = showCountsFlag ? 'Ë°®Á§∫' : 'ÈùûË°®Á§∫';
  safeSetText('info-show-counts', showCounts);

  // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖãÂêåÊúü
  syncCheckboxStates(status);
}

// Update publication status UI
function updatePublicationStatusUI(isPublished) {
  const statusElement = safeGetElement('info-publish-status');
  const indicatorElement = safeGetElement('info-publish-indicator');
  const textElement = safeGetElement('info-publish-text');
  
  if (statusElement) {
    if (isPublished) {
      statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-green-600 text-white';
      if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-green-400';
      if (textElement) textElement.textContent = 'ÂÖ¨Èñã‰∏≠';
    } else {
      statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-gray-600 text-gray-300';
      if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      if (textElement) textElement.textContent = 'ÈùûÂÖ¨Èñã';
    }
  }
}

// „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÂêåÊúü„Åô„ÇãÈñ¢Êï∞
function syncCheckboxStates(status) {
  // Priority: Database config (configJson) > status properties > defaults
  let showNames = false;
  let showCounts = false;
  
  // 1. Prefer status.config if available
  if (status.config) {
    if (status.config.showNames !== undefined) showNames = status.config.showNames;
    if (status.config.showCounts !== undefined) showCounts = status.config.showCounts;
  } else if (status.userInfo?.configJson) {
    // 2. Fallback to raw configJson
    try {
      const config = JSON.parse(status.userInfo.configJson);
      if (config.showNames !== undefined) showNames = config.showNames;
      if (config.showCounts !== undefined) showCounts = config.showCounts;
    } catch (e) {
      logWarn('Failed to parse configJson, using status properties');
      if (status.showNames !== undefined) showNames = status.showNames;
      if (status.showCounts !== undefined) showCounts = status.showCounts;
    }
  } else {
    // 3. Use status properties as last resort
    if (status.showNames !== undefined) showNames = status.showNames;
    if (status.showCounts !== undefined) showCounts = status.showCounts;
  }

  // Update checkbox elements
  const showNamesCheckbox = safeGetElement('show-names');
  const showCountsCheckbox = safeGetElement('show-counts');
  
  if (showNamesCheckbox) {
    showNamesCheckbox.checked = showNames;
  }
  
  if (showCountsCheckbox) {
    showCountsCheckbox.checked = showCounts;
  }
}

// =============================================================================
// SHEET SELECTION AND CONFIGURATION
// =============================================================================

// Populate sheet selection dropdown
function populateSheetSelect(sheetNames, activeSheetName) {
  const select = document.getElementById('sheet-select');
  if (!select) {
    logWarn('Sheet select element not found');
    return;
  }

  logDebug('üìã Populating sheet select with data:', {
    sheetNames: sheetNames,
    activeSheetName: activeSheetName,
    dataType: typeof sheetNames,
    isArray: Array.isArray(sheetNames)
  });

  // Clear existing options
  select.innerHTML = '<option value="">-- „Ç∑„Éº„Éà„ÇíÈÅ∏Êäû --</option>';
  
  if (sheetNames && sheetNames.length > 0) {
    logDebug('‚úÖ Adding sheets to dropdown:', sheetNames.length);
    
    sheetNames.forEach((sheet, index) => {
      const option = document.createElement('option');
      
      // Handle both object and string formats
      let sheetName;
      if (typeof sheet === 'object' && sheet.name) {
        sheetName = sheet.name;
        option.value = sheet.name;
        logDebug(`üìÑ Sheet ${index + 1}: ${sheet.name} (ID: ${sheet.id})`);
      } else if (typeof sheet === 'string') {
        sheetName = sheet;
        option.value = sheet;
        logDebug(`üìÑ Sheet ${index + 1}: ${sheet}`);
      } else {
        console.warn('‚ö†Ô∏è Unknown sheet format:', sheet);
        return;
      }
      
      // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Éº„Éà„ÅÆË°®Á§∫„ÇíÊîπÂñÑ
      if (sheetName === activeSheetName) {
        option.textContent = `${sheetName} („Ç¢„ÇØ„ÉÜ„Ç£„Éñ)`;
        option.style.fontWeight = 'bold';
        option.style.color = '#10b981'; // Á∑ëËâ≤„Åß„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÇíË°®Á§∫
        option.className = 'active-sheet-option';
        logDebug(`‚úÖ Active sheet marked: ${sheetName}`);
      } else {
        option.textContent = sheetName;
      }
      
      select.appendChild(option);
    });
    select.disabled = false;
    logDebug('‚úÖ Sheet dropdown populated successfully');
  } else {
    console.warn('‚ö†Ô∏è No sheets available:', sheetNames);
    select.innerHTML = '<option value="">Âà©Áî®ÂèØËÉΩ„Å™„Ç∑„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</option>';
    select.disabled = true;
  }
  
  // Set active sheet if available (Âº∑Âåñ„Åï„Çå„ÅüÈÅ∏Êäû„É≠„Ç∏„ÉÉ„ÇØ)
  if (activeSheetName) {
    // „Ç∑„Éº„ÉàÂêç„ÅÆÊ≠£Ë¶èÂåñ„ÇíËÄÉÊÖÆ„Åó„ÅüÈÅ∏ÊäûÂá¶ÁêÜ
    const normalizedActiveSheet = activeSheetName.trim();
    
    // Ê≠£Á¢∫„Å™‰∏ÄËá¥„ÇíÁ¢∫Ë™ç
    const availableOptions = Array.from(select.options);
    const matchingOption = availableOptions.find(option => option.value === normalizedActiveSheet);
    
    if (matchingOption) {
      select.value = normalizedActiveSheet;
      selectedSheet = normalizedActiveSheet;
      lastSelectedSheetName = normalizedActiveSheet;
      logDebug('‚úÖ Active sheet set successfully:', normalizedActiveSheet);
    } else {
      // ÈÉ®ÂàÜ‰∏ÄËá¥„Åæ„Åü„ÅØ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ
      console.warn('‚ö†Ô∏è Active sheet not found in options, attempting fallback:', {
        activeSheetName: normalizedActiveSheet,
        availableOptions: availableOptions.map(opt => opt.value)
      });
      
      // ÊúÄÂàù„ÅÆÊúâÂäπ„Å™„Ç™„Éó„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû
      if (availableOptions.length > 1) { // Skip the default "-- „Ç∑„Éº„Éà„ÇíÈÅ∏Êäû --"
        const firstSheet = availableOptions[1].value;
        select.value = firstSheet;
        selectedSheet = firstSheet;
        lastSelectedSheetName = firstSheet;
        logDebug('üîÑ Fallback to first available sheet:', firstSheet);
      }
    }
    
    // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
    if (select.value) {
      logDebug('‚úÖ Final sheet selection confirmed:', select.value);
    } else {
      console.error('‚ùå Sheet selection failed - no sheet selected');
    }
  }
  
  // Add change event listener for data preview
  select.removeEventListener('change', handleSheetSelectionChange);
  select.addEventListener('change', handleSheetSelectionChange);
  
  // Update UI for selected sheet and enable spreadsheet button
  updateUIForSelectedSheet();
  updateSpreadsheetButton();
}

// Populate header options for configuration
function populateHeaderOptions(headers) {
  // Throttle function calls to prevent spam
  if (window.populateHeaderOptionsRunning) {
    return;
  }
  window.populateHeaderOptionsRunning = true;
  
  const selects = [
    'opinionHeader',      // Main required field
    'reason-column',     // Optional details field (reason column)
    'name-column', 
    'class-column'
  ];
  
  selects.forEach(selectId => {
    const select = document.getElementById(selectId);
    
    if (select) {
      // Store current value
      const currentValue = select.value;
      
      // Clear and repopulate with appropriate placeholder
      if (headers && headers.length > 0) {
        select.innerHTML = '<option value="">-- Âàó„ÇíÈÅ∏Êäû --</option>';
        select.disabled = false;
      } else {
        select.innerHTML = '<option value="">-- „Ç∑„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>';
        select.disabled = true;
      }
      
      const excludedHeaders = [
        '„Å™„Çã„Åª„Å©ÔºÅ',
        '„ÅÑ„ÅÑ„Å≠ÔºÅ',
        '„ÇÇ„Å£„Å®Áü•„Çä„Åü„ÅÑÔºÅ',
        '„Éè„Ç§„É©„Ç§„Éà',
        '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ', // „Éï„Ç©„Éº„É†„ÅßËá™ÂãïÂèéÈõÜ„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Éû„ÉÉ„Éî„É≥„Ç∞ÂØæË±°„Åã„ÇâÈô§Â§ñ
        '„Çø„Ç§„É†„Çπ„Çø„É≥„Éó' // „É¶„Éº„Ç∂„Éº„ÅÆË¶ÅÊúõ„Å´„Çà„ÇäÈô§Â§ñ
      ];

      const filteredHeaders = headers.filter(header => !excludedHeaders.includes(header));

      filteredHeaders.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      
      // Restore previous value if still valid
      if (currentValue && headers.includes(currentValue)) {
        select.value = currentValue;
      }
    }
  });
  
  // Reset throttle after a delay
  setTimeout(() => {
    window.populateHeaderOptionsRunning = false;
  }, 100);
}

// Populate configuration with guessed values
function populateConfig(cfg) {
  if (!cfg) return;
  
  // Throttle function calls to prevent spam
  if (window.populateConfigRunning) {
    return;
  }
  window.populateConfigRunning = true;
  
  const mappings = {
    // Main opinion dropdown (primary target)
    'opinionHeader': cfg.opinionHeader || cfg.opinionColumn,
    
    // Detail configuration dropdowns (secondary targets with property name fixes)
    'reason-column': cfg.reasonColumn || cfg.reasonHeader,
    'name-column': cfg.nameColumn || cfg.nameHeader,
    'class-column': cfg.classColumn || cfg.classHeader,
    'show-names': cfg.showNames,
    'show-counts': cfg.showCounts
  };
  
  Object.keys(mappings).forEach(elementId => {
    const element = document.getElementById(elementId);
    const value = mappings[elementId];
    
    if (element && value !== undefined) {
      if (element.type === 'checkbox') {
        element.checked = Boolean(value);
      } else {
        element.value = value;
      }
    }
  });
  
  // Reset throttle after a delay
  setTimeout(() => {
    window.populateConfigRunning = false;
  }, 100);
  
  updateConfigButtons();
}

// Clear configuration fields
function clearConfigFields() {
  const fieldIds = [
    'opinionHeader',      // Main required field
    'reason-column',
    'name-column',
    'class-column'
  ];
  
  fieldIds.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.value = '';
    }
  });
  
  updateConfigButtons();
}

// Build configuration object from form
function buildConfigObject() {
  // Get values from primary elements (with fallback to secondary elements)
  const opinionValue = document.getElementById('opinionHeader')?.value || 
                      document.getElementById('reason-column')?.value || '';
  const nameValue = document.getElementById('name-column')?.value || '';
  const classValue = document.getElementById('class-column')?.value || '';
  const showNames = document.getElementById('show-names')?.checked || false;
  const showCounts = document.getElementById('show-counts')?.checked || false;
  
  return {
    sheetName: selectedSheet,
    // Use property names that match backend expectations (opinionHeader format)
    opinionHeader: opinionValue,
    nameHeader: nameValue,
    classHeader: classValue,
    reasonHeader: document.getElementById('reason-column')?.value || '',
    // Also provide legacy format for backward compatibility
    opinionColumn: opinionValue,
    nameColumn: nameValue,
    classColumn: classValue,
    showNames: showNames,
    showCounts: showCounts
  };
}

// Validate configuration
function validateConfig() {
  // Check primary element first, then fallback to secondary element
  const opinionValue = document.getElementById('opinionHeader')?.value || 
                      document.getElementById('reason-column')?.value || '';
  
  return opinionValue && opinionValue.trim() !== '';
}

// Update configuration buttons state
function updateConfigButtons() {
  const isValid = validateConfig();
  const saveBtn = document.getElementById('save-publish-btn');
  
  if (saveBtn) {
    saveBtn.disabled = !isValid;
    if (isValid) {
      saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }
}

// =============================================================================
// STEP INDICATORS AND GUIDANCE
// =============================================================================

// Áµ±‰∏Ä„Åï„Çå„Åü„Çπ„ÉÜ„ÉÉ„ÉóÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ - ÂÖ¨ÈñãÁä∂ÊÖãÂÑ™ÂÖàÂà§ÂÆöÂØæÂøúÁâà
function getStepCompletionFromConfig(status) {
  if (!status?.userInfo?.configJson) {
    return { step1: false, step2: false, step3: false, isPublished: false };
  }

  try {
    const config = typeof status.userInfo.configJson === 'string' 
      ? JSON.parse(status.userInfo.configJson) 
      : status.userInfo.configJson;

    // ÂÖ¨ÈñãÁä∂ÊÖã„ÅÆÂÑ™ÂÖà„ÉÅ„Çß„ÉÉ„ÇØÔºà„Éá„Éº„Çø‰∏çÊï¥Âêà„Å´Èñ¢‰øÇ„Å™„ÅèÂÖ¨ÈñãÊ∏à„Åø„Å™„ÇâÂÖ®„Çπ„ÉÜ„ÉÉ„ÉóÂÆå‰∫ÜÔºâ
    const publicationState = getPublicationState(status);
    if (publicationState.isPublished) {
      return {
        step1: true,
        step2: true,
        step3: true,
        isPublished: true
      };
    }

    // ÈÄöÂ∏∏„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÂÆå‰∫ÜÂà§ÂÆö
    // Step 1: „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàID„ÅÆÂ≠òÂú®Á¢∫Ë™ç
    const step1Complete = !!(status.userInfo.spreadsheetId);
    
    // Step 2: „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫ÜÁä∂ÊÖã„ÅÆÁ¢∫Ë™ç
    const step2Complete = config.setupStatus === 'completed' && 
                          config.formCreated === true && 
                          config.formUrl && config.formUrl.trim();
    
    // Step 3: ÂÖ¨ÈñãÁä∂ÊÖã„ÅÆÁ¢∫Ë™ç
    const step3Complete = config.appPublished === true;
    
    return {
      step1: step1Complete,
      step2: step2Complete,
      step3: step3Complete,
      isPublished: step3Complete
    };
  } catch (error) {
    console.warn('‚ùå configJson„ÅÆËß£Êûê„Å´Â§±Êïó:', error);
    return { step1: false, step2: false, step3: false, isPublished: false };
  }
}

// Update step indicators - ÊúÄÈÅ©ÂåñÁâàÔºà„Éê„ÉÉ„ÉÅDOMÊõ¥Êñ∞Ôºâ
function updateStepIndicators(currentStep, status = null) {
  const steps = [
    document.getElementById('step-1-indicator'),
    document.getElementById('step-2-indicator'),
    document.getElementById('step-3-indicator')
  ];

  // „Éá„Éº„Çø„Éô„Éº„ÇπÁä∂ÊÖã„Åã„ÇâÂÆüÈöõ„ÅÆÂÆå‰∫ÜÁä∂Ê≥Å„ÇíÂèñÂæó
  const completion = getStepCompletionFromConfig(status);
  logDebug('üìä Step completion from database:', completion);

  // DOMÊõ¥Êñ∞„Çí„Éê„ÉÉ„ÉÅÂåñ„Åô„Çã„Åü„ÇÅ„ÅÆË®≠ÂÆöÈÖçÂàó„Çí‰ΩúÊàê
  const updates = [];
  
  steps.forEach((step, index) => {
    if (!step) return;
    
    const stepNumber = index + 1;
    const circle = step.querySelector('div');
    const text = step.querySelector('span');

    // Êó¢Â≠ò„ÅÆ„Éê„ÉÉ„Ç∏„ÇíÂâäÈô§ÔºàÊúÄÈÅ©ÂåñÔºâ
    const existingBadge = step.querySelector('.publication-badge');
    if (existingBadge) {
      existingBadge.remove();
    }

    // „Éá„Éº„Çø„Éô„Éº„ÇπÁä∂ÊÖã„Å´Âü∫„Å•„ÅèÂÆå‰∫ÜÂà§ÂÆö
    const isStepComplete = completion[`step${stepNumber}`];
    
    // Êõ¥Êñ∞ÊÉÖÂ†±„ÇíÈÖçÂàó„Å´ËøΩÂä†ÔºàÂÆüÈöõ„ÅÆDOMÊõ¥Êñ∞„ÅØÂæå„Åß‰∏ÄÊã¨ÂÆüË°åÔºâ
    updates.push({
      circle,
      text,
      stepNumber,
      isStepComplete,
      isCurrentStep: stepNumber === currentStep
    });
  });
  
  // „Éê„ÉÉ„ÉÅDOMÊõ¥Êñ∞ÂÆüË°åÔºà„É™„Éï„É≠„Éº„ÇíÊúÄÂ∞èÂåñÔºâ
  requestAnimationFrame(() => {
    executeBatchStepUpdates(updates);
    // ÈÄ≤Ë°åÁä∂Ê≥Å„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÊõ¥Êñ∞ÔºàÂêå„Åò„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éï„É¨„Éº„É†ÂÜÖ„ÅßÂÆüË°åÔºâ
    updateProgressMessage(currentStep, status, completion);
  });
}

// „Éê„ÉÉ„ÉÅDOMÊõ¥Êñ∞„ÅÆÂÆüË°åÔºàÊúÄÈÅ©Âåñ„Åï„Çå„ÅüDOMÊìç‰ΩúÔºâ
function executeBatchStepUpdates(updates) {
  const styleConfigs = {
    completed: {
      circleClass: 'w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all',
      circleContent: '‚úì',
      textClasses: { remove: ['text-gray-500', 'text-cyan-400'], add: ['text-green-400', 'font-medium'] }
    },
    current: {
      circleClass: 'w-6 h-6 bg-cyan-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all ring-2 ring-cyan-400 ring-offset-2 ring-offset-gray-900 animate-pulse',
      textClasses: { remove: ['text-gray-500', 'text-green-400'], add: ['text-cyan-400', 'font-bold'] }
    },
    pending: {
      circleClass: 'w-6 h-6 bg-gray-700 text-gray-500 rounded-full flex items-center justify-center font-bold text-xs transition-all border border-gray-600',
      textClasses: { remove: ['text-white', 'text-green-400', 'text-cyan-400', 'font-bold', 'font-medium'], add: ['text-gray-500'] }
    }
  };

  updates.forEach(({ circle, text, stepNumber, isStepComplete, isCurrentStep }) => {
    let config;
    
    if (isStepComplete) {
      config = styleConfigs.completed;
    } else if (isCurrentStep) {
      config = styleConfigs.current;
    } else {
      config = styleConfigs.pending;
    }

    // CircleË¶ÅÁ¥†„ÅÆÊõ¥Êñ∞
    if (circle) {
      circle.className = config.circleClass;
      circle.innerHTML = config.circleContent || stepNumber;
    }

    // TextË¶ÅÁ¥†„ÅÆÊõ¥Êñ∞Ôºà„ÇØ„É©„ÇπÊìç‰Ωú„ÅÆÊúÄÈÅ©ÂåñÔºâ
    if (text && config.textClasses) {
      text.classList.remove(...config.textClasses.remove);
      text.classList.add(...config.textClasses.add);
    }
  });
}

function updateProgressMessage(currentStep, status = null, completion = null) {
  const messageElement = document.getElementById('progress-message');
  if (!messageElement) return;
  
  // completion„ÅåÊ∏°„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂèñÂæó
  if (!completion) {
    completion = getStepCompletionFromConfig(status);
  }
  
  // ÊîπÂñÑ„Åï„Çå„Åü„É°„ÉÉ„Çª„Éº„Ç∏„Å®„Ç¨„Ç§„ÉÄ„É≥„Çπ
  const messageData = getEnhancedProgressMessage(currentStep, completion, status);
  
  messageElement.textContent = messageData.message;
  messageElement.className = `text-sm ${messageData.colorClass} font-medium transition-colors duration-300`;
}

// Âº∑Âåñ„Åï„Çå„Åü„Éó„É≠„Ç∞„É¨„Çπ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÁîüÊàê
function getEnhancedProgressMessage(currentStep, completion, status) {
  const messageConfigs = {
    1: {
      completed: {
        message: '‚úÖ „Éá„Éº„ÇøÊ∫ñÂÇôÂÆå‰∫ÜÔºö„Éï„Ç©„Éº„É†„Éª„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô',
        colorClass: 'text-green-400'
      },
      inProgress: {
        message: 'üìã „ÇØ„Ç§„ÉÉ„ÇØ„Çπ„Çø„Éº„ÉàÔºàËá™ÂãïÔºâ„Åæ„Åü„ÅØ„Ç´„Çπ„Çø„É†„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÔºàÊó¢Â≠ò„Éá„Éº„ÇøÔºâ„ÇíÈÅ∏Êäû',
        colorClass: 'text-cyan-400'
      }
    },
    2: {
      completed: {
        message: '‚úÖ „Ç∑„Éº„ÉàË®≠ÂÆöÂÆå‰∫ÜÔºöÂõûÁ≠î„Éá„Éº„Çø„ÅÆË°®Á§∫Ê∫ñÂÇô„Åå„Åß„Åç„Åæ„Åó„Åü',
        colorClass: 'text-green-400'  
      },
      inProgress: {
        message: '‚öôÔ∏è „Ç∑„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„ÄÅË°®Á§∫„Åô„ÇãÂàóÔºàË≥™Âïè„ÉªÂõûÁ≠î„Å™„Å©Ôºâ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
        colorClass: 'text-yellow-400'
      }
    },
    3: {
      published: {
        message: 'üéâ „Éú„Éº„ÉâÂÖ¨Èñã‰∏≠ÔºöÂèÇÂä†ËÄÖ„ÅåÂõûÁ≠î„ÇíÊäïÁ®ø„ÉªÈñ≤Ë¶ß„Åß„Åç„Åæ„Åô',
        colorClass: 'text-green-400'
      },
      readyToPublish: {
        message: 'üöÄ ÂÖ¨ÈñãÊ∫ñÂÇôÂÆå‰∫ÜÔºö„Äå„Éú„Éº„Éâ„ÇíÂÖ¨Èñã„Äç„ÅßÂèÇÂä†ËÄÖ„Å´ÂÖ±Êúâ„Åó„Åæ„Åó„Çá„ÅÜ',
        colorClass: 'text-purple-400'
      },
      needsConfiguration: {
        message: 'üîß ÂàóË®≠ÂÆö„ÇíÂÆå‰∫Ü„Åó„Å¶„Åã„ÇâÂÖ¨Èñã„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
        colorClass: 'text-orange-400'
      }
    }
  };
  
  // „Çπ„ÉÜ„ÉÉ„Éó„Åî„Å®„ÅÆÁä∂ÊÖãÂà§ÂÆö„Å®„É°„ÉÉ„Çª„Éº„Ç∏ÈÅ∏Êäû
  switch (currentStep) {
    case 1:
      return completion.step1 ? 
        messageConfigs[1].completed : 
        messageConfigs[1].inProgress;
        
    case 2:
      return completion.step2 ? 
        messageConfigs[2].completed : 
        messageConfigs[2].inProgress;
        
    case 3:
      if (completion.isPublished) {
        return messageConfigs[3].published;
      } else if (completion.step2) {
        return messageConfigs[3].readyToPublish;
      } else {
        return messageConfigs[3].needsConfiguration;
      }
      
    default:
      return {
        message: 'üéâ „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫ÜÔºöStudyQuest„Çí„ÅäÊ•Ω„Åó„Åø„Åè„Å†„Åï„ÅÑÔºÅ',
        colorClass: 'text-green-400'
      };
  }
}

// „Éá„Éê„Ç¶„É≥„ÇπÊ©üËÉΩÁî®„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÁÆ°ÁêÜ
let footerUpdateTimeout = null;

// Update footer and guidance text (with debounce)
function updateFooterAndGuidance(status) {
  // „Éá„Éê„Ç¶„É≥„ÇπÂá¶ÁêÜÔºöÁü≠ÊôÇÈñì„ÅÆÈÄ£Á∂öÂëº„Å≥Âá∫„Åó„ÇíÂà∂Âæ°
  clearTimeout(footerUpdateTimeout);
  footerUpdateTimeout = setTimeout(() => {
    updateFooterAndGuidanceImmediate(status);
  }, 150); // 150msÈÅÖÂª∂
}

// ÂÆüÈöõ„ÅÆ„Éï„ÉÉ„Çø„ÉºÊõ¥Êñ∞Âá¶ÁêÜ
function updateFooterAndGuidanceImmediate(status) {
  console.group('ü¶∂ updateFooterAndGuidance');
  
  const footer = document.getElementById('admin-footer');
  const guidanceText = document.getElementById('guidance-text');
  
  if (!footer || !guidanceText) {
    console.warn('‚ùå Footer or guidance elements not found');
    console.groupEnd();
    return;
  }

  // Use normalized publication state from status object with additional validation
  const isPublished = status._normalized?.isPublished || false;
  const viewUrl = status._normalized?.viewUrl;
  
  // Additional strict check: ensure appPublished is explicitly true
  let explicitAppPublished = status.appPublished === true;
  
  if (!explicitAppPublished && status.userInfo?.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      explicitAppPublished = config.appPublished === true;
    } catch (configError) {
      console.warn('‚ùå Failed to parse configJson for publication check:', configError);
      explicitAppPublished = false;
    }
  }
  
  // Final publication decision: both normalized and explicit checks must agree
  const finalIsPublished = isPublished && explicitAppPublished;
  
  // Êú¨Áï™Áí∞Â¢É„Åß„ÅØË©≥Á¥∞„É≠„Ç∞„ÇíÂâäÊ∏õ
  if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
    console.log('üîç Enhanced publication check:', {
      'normalized isPublished': isPublished,
      'explicit appPublished': explicitAppPublished,
      'final decision': finalIsPublished,
      'publish reason': status._normalized?.publishReason,
      'normalized viewUrl': viewUrl,
      'has valid viewUrl': status._normalized?.hasValidViewUrl,
      'will show footer': finalIsPublished
    });
  } else {
    console.log(`üîç Publication check: ${finalIsPublished ? 'ÂÖ¨Èñã‰∏≠' : 'ÈùûÂÖ¨Èñã'}`);
  }

  // Show footer if published (with strict validation)
  if (finalIsPublished) {
    footer.classList.remove('hidden');
    
    // Update board URL using our generated viewUrl (if available)
    const boardUrlInput = document.getElementById('board-url');
    const viewBoardLink = document.getElementById('view-board-link');
    
    if (boardUrlInput) {
      boardUrlInput.value = viewUrl || 'URLÁîüÊàê‰∏≠...';
      console.log('üìù Board URL input updated:', viewUrl || 'URL generation pending');
    }
    if (viewBoardLink && viewUrl) {
      viewBoardLink.href = viewUrl;
      console.log('üîó View board link updated:', viewUrl);
    } else if (viewBoardLink) {
      viewBoardLink.removeAttribute('href');
      console.log('üîó View board link cleared - no URL available');
    }
    
    // Update topic text
    updateTopicText(status);
    
    guidanceText.textContent = 'ÂõûÁ≠î„Éú„Éº„Éâ„ÅØÁèæÂú®ÂÖ¨Èñã‰∏≠„Åß„Åô„ÄÇ';
  } else {
    footer.classList.add('hidden');
    console.log('‚ùå Footer hidden - board not published');
    
    // Update guidance based on setup step
    updateGuidanceForStep(status.setupStep || 1, guidanceText);
  }
  
  console.groupEnd();
  
  // Ëá™ÂãïÂÅúÊ≠¢ÈÄöÁü•„ÅÆË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØ
  checkAndShowAutoStopNotification(status);
  
  adjustLayout();
}

// Update UI for selected sheet
function updateUIForSelectedSheet() {
  var hasSelection = selectedSheet && selectedSheet.trim() !== '';
  
  // Update step indicators based on server-provided setupStep
  const currentStep = currentStatus.setupStep || 1;
  updateStepIndicators(currentStep);
  
  // Enable/disable configuration section
  var configSection = document.getElementById('config-section');
  if (configSection) {
    if (hasSelection) {
      configSection.classList.remove('opacity-50', 'pointer-events-none');
      
      // Èò≤Âæ°ÁöÑ„É≠„Ç∏„ÉÉ„ÇØ: config-area„ÅåÁ¢∫ÂÆü„Å´Ë°®Á§∫„Åï„Çå„Çã„Çà„ÅÜ„Å´„Åô„Çã
      var configArea = document.getElementById('config-area');
      if (configArea) {
        configArea.classList.remove('hidden');
        console.log('üõ°Ô∏è updateUIForSelectedSheet: Config area shown defensively');
      }
    } else {
      configSection.classList.add('opacity-50', 'pointer-events-none');
    }
  }
  
  // Update guidance text
  var guidanceText = document.getElementById('guidance-text');
  if (guidanceText) {
    if (hasSelection) {
      guidanceText.textContent = '„Çπ„ÉÜ„ÉÉ„Éó3: Âàó„ÇíË®≠ÂÆö„Åó„Å¶„Éú„Éº„Éâ„ÇíÂÖ¨Èñã„Åó„Åæ„Åó„Çá„ÅÜ';
    } else {
      guidanceText.textContent = '„Çπ„ÉÜ„ÉÉ„Éó2: Ë°®Á§∫„Åó„Åü„ÅÑ„Ç∑„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    }
  }

  // Toggle placeholder visibility
  var configPlaceholder = document.getElementById('config-placeholder');
  if (configPlaceholder) {
    if (hasSelection) {
      configPlaceholder.classList.add('hidden');
    } else {
      configPlaceholder.classList.remove('hidden');
    }
  }
}

// Update topic text in footer
function updateTopicText(status) {
  const topicTextElement = document.getElementById('current-topic-text');
  const scheduledEndTimeElement = document.getElementById('scheduled-end-time');
  
  if (!topicTextElement) return;

  let topic = 'ÔºàÂïèÈ°åÊñáÊú™Ë®≠ÂÆöÔºâ';
  // „Çà„ÇäÂåÖÊã¨ÁöÑ„Å™configÂèñÂæó
  let cfg = status.config || {};
  
  // userInfo.configJson„Åã„Çâ„ÇÇÊÉÖÂ†±„ÇíÂèñÂæó
  if (status.userInfo?.configJson) {
    try {
      const fullConfig = JSON.parse(status.userInfo.configJson);
      cfg = { ...cfg, ...fullConfig };
    } catch (e) {
      console.warn('Failed to parse userInfo.configJson:', e);
    }
  }

  if (status.customFormInfo && status.customFormInfo.mainQuestion) {
    topic = status.customFormInfo.mainQuestion;
  } else if (cfg.opinionHeader) {
    topic = cfg.opinionHeader;
  } else {
    const sheetName = cfg.publishedSheetName || status.publishedSheetName;
    if (sheetName) {
      if (status.userInfo?.configJson) {
        try {
          const fullCfg = JSON.parse(status.userInfo.configJson);
          const sheetCfg = fullCfg['sheet_' + (sheetName || '')] || {};
          
          // guessedConfigÂÜÖ„ÅÆopinionHeader„ÇíÂÑ™ÂÖà
          if (sheetCfg.guessedConfig && sheetCfg.guessedConfig.opinionHeader) {
            topic = sheetCfg.guessedConfig.opinionHeader;
          } else if (sheetCfg.opinionHeader) {
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Áõ¥Êé•„ÅÆopinionHeader
            topic = sheetCfg.opinionHeader;
          } else {
            // „Ç∑„Éº„ÉàÂêç„Åß„ÅØ„Å™„Åè„ÄÅÈÅ©Âàá„Å™„Éá„Éï„Ç©„É´„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            topic = 'ÔºàË≥™ÂïèÊñá„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºâ';
          }
        } catch (e) {
          // „ÇØ„Ç§„ÉÉ„ÇØ„Çπ„Çø„Éº„ÉàÁõ¥Âæå„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÊîπÂñÑ
          if (sheetName && fullCfg['sheet_' + (sheetName || '')]?.flowType === 'quickstart') {
            // „ÇØ„Ç§„ÉÉ„ÇØ„Çπ„Çø„Éº„ÉàÁî®„Éá„Éï„Ç©„É´„ÉàË≥™ÂïèÊñá„ÇíË°®Á§∫
            topic = '„ÅÇ„Å™„Åü„ÅÆËÄÉ„Åà„ÇÑÊ∞ó„Å•„ÅÑ„Åü„Åì„Å®„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ';
          } else {
            topic = 'ÔºàË≥™ÂïèÊñá„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºâ';
          }
        }
      } else {
        // „Ç∑„Éº„ÉàÂêç„Çí„Åù„ÅÆ„Åæ„ÅæË°®Á§∫„Åõ„Åö„ÄÅÈÅ©Âàá„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        topic = 'ÔºàË≥™ÂïèÊñá„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºâ';
      }
    }
  }

  topicTextElement.textContent = topic;
  
  // ‰∫àÂÆöÁµÇ‰∫ÜÊó•ÊôÇ„ÅÆÊõ¥Êñ∞
  if (scheduledEndTimeElement) {
    updateScheduledEndTime(cfg, scheduledEndTimeElement);
  }
}

// ‰∫àÂÆöÁµÇ‰∫ÜÊó•ÊôÇ„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
function updateScheduledEndTime(config, element) {
  // Ë§áÊï∞„ÅÆ„ÇΩ„Éº„Çπ„Åã„Çâ scheduledEndAt „ÇíÂèñÂæó„ÇíË©¶Ë°å
  const scheduledEndAt = config.scheduledEndAt || 
                         config.scheduledEndTime ||  // Âè§„ÅÑ„Éï„Ç£„Éº„É´„ÉâÂêç„Å®„ÅÆ‰∫íÊèõÊÄß
                         (window.lastStatusCache?.config?.scheduledEndAt) ||
                         (window.lastStatusCache?.config?.scheduledEndTime);
  
  // scheduledEndAt„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅpublishedAt + autoStopMinutes„Åã„ÇâË®àÁÆó
  let finalScheduledEndTime = scheduledEndAt;
  
  if (!finalScheduledEndTime && config.publishedAt && config.autoStopMinutes) {
    const publishedTime = new Date(config.publishedAt);
    const autoStopMs = config.autoStopMinutes * 60 * 1000;
    finalScheduledEndTime = new Date(publishedTime.getTime() + autoStopMs).toISOString();
    console.log('üïê ÁµÇ‰∫Ü‰∫àÂÆöÊôÇÂàª„ÇíË®àÁÆó„Åó„Åæ„Åó„Åü:', finalScheduledEndTime);
  }
  
  if (finalScheduledEndTime) {
    try {
      const endDate = new Date(finalScheduledEndTime);
      const formattedTime = endDate.toLocaleString('ja-JP', {
        year: '2-digit',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // ÁèæÂú®ÊôÇÂàª„Å®„ÅÆÊØîËºÉ
      const now = new Date();
      const isOverdue = endDate < now;
      const timeRemaining = endDate.getTime() - now.getTime();
      const oneHourMs = 60 * 60 * 1000; // 1ÊôÇÈñì„ÅÆ„Éü„É™Áßí
      
      if (isOverdue) {
        element.textContent = `${formattedTime} (ÊúüÈôêÂàá„Çå)`;
        element.className = 'text-xs font-medium text-red-400';
      } else if (timeRemaining <= oneHourMs) {
        // 1ÊôÇÈñì‰ª•ÂÜÖ„ÅÆÂ†¥Âêà„ÅØË≠¶ÂëäË°®Á§∫
        const minutesRemaining = Math.floor(timeRemaining / (60 * 1000));
        element.textContent = `${formattedTime} (ÊÆã„Çä${minutesRemaining}ÂàÜ)`;
        element.className = 'text-xs font-medium text-red-400 animate-pulse';
        console.log('‚ö†Ô∏è ÊúüÈôê„Åæ„Åß1ÊôÇÈñì‰ª•ÂÜÖ„Åß„Åô:', minutesRemaining + 'ÂàÜ');
      } else {
        element.textContent = formattedTime;
        element.className = 'text-xs font-medium text-orange-400';
      }
    } catch (e) {
      element.textContent = 'Ë®≠ÂÆö„Ç®„É©„Éº';
      element.className = 'text-xs font-medium text-gray-400';
    }
  } else {
    element.textContent = 'Êú™Ë®≠ÂÆö';
    element.className = 'text-xs font-medium text-gray-400';
  }
}

// Update guidance text for specific step
function updateGuidanceForStep(step, guidanceElement) {
  const messages = {
    1: '„Çπ„ÉÜ„ÉÉ„Éó1: „Éú„Éº„Éâ„Çí‰ΩúÊàê„Åæ„Åü„ÅØÊó¢Â≠ò„ÅÆ„É™„ÇΩ„Éº„Çπ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
    2: '„Çπ„ÉÜ„ÉÉ„Éó2: Ë°®Á§∫„Åó„Åü„ÅÑ„Ç∑„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
    3: '„Çπ„ÉÜ„ÉÉ„Éó3: Âàó„ÇíË®≠ÂÆö„Åó„Å¶„Éú„Éº„Éâ„ÇíÂÖ¨Èñã„Åó„Åæ„Åó„Çá„ÅÜ'
  };
  
  // ÂÖ¨ÈñãÁµÇ‰∫ÜÂæå„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó1„Åß„ÅØ„ÄÅÊòéÁ¢∫„Å´„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÜçÈñã„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
  if (step === 1) {
    guidanceElement.textContent = '„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
  } else {
    guidanceElement.textContent = messages[step] || '„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
  }
}

// Ëá™ÂãïÂÅúÊ≠¢ÈÄöÁü•„ÅÆË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØ
function checkAndShowAutoStopNotification(status) {
  const notificationElement = document.getElementById('auto-stop-notification');
  const autoStoppedTimeElement = document.getElementById('auto-stopped-time');
  
  if (!notificationElement || !autoStoppedTimeElement) return;
  
  const config = status.config || {};
  
  // Ëá™ÂãïÂÅúÊ≠¢„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÈÄöÁü•„ÇíË°®Á§∫
  if (config.autoStoppedAt && config.autoStopReason === 'scheduled_timeout') {
    console.log('üîî Ëá™ÂãïÂÅúÊ≠¢ÈÄöÁü•„ÇíË°®Á§∫„Åó„Åæ„Åô:', config.autoStoppedAt);
    
    // ÂÅúÊ≠¢ÊôÇÂàª„ÇíË°®Á§∫
    try {
      const stoppedDate = new Date(config.autoStoppedAt);
      const formattedTime = stoppedDate.toLocaleString('ja-JP', {
        year: '2-digit',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      autoStoppedTimeElement.textContent = formattedTime;
    } catch (e) {
      autoStoppedTimeElement.textContent = 'ÊôÇÂàª‰∏çÊòé';
    }
    
    // ÈÄöÁü•„ÇíË°®Á§∫
    notificationElement.classList.remove('hidden');
    
    // ÂÜçÂÖ¨Èñã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
    const republishBtn = document.getElementById('republish-after-auto-stop-btn');
    if (republishBtn) {
      // Êó¢Â≠ò„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
      republishBtn.replaceWith(republishBtn.cloneNode(true));
      
      // Êñ∞„Åó„ÅÑ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
      const newRepublishBtn = document.getElementById('republish-after-auto-stop-btn');
      newRepublishBtn.addEventListener('click', function() {
        // Step 3„Å´ÁßªÂãï„Åó„Å¶ÂÜçÂÖ¨Èñã„Çí‰øÉ„Åô
        const step3Section = document.getElementById('step3-content');
        if (step3Section) {
          step3Section.classList.remove('hidden');
          step3Section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // ÈÄöÁü•„ÇíÈùûË°®Á§∫
        notificationElement.classList.add('hidden');
        
        showMessage('Ë°®Á§∫Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶ÂÜçÂÖ¨Èñã„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'info');
      });
    }
  } else {
    // Ëá™ÂãïÂÅúÊ≠¢„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÁü•„ÇíÈùûË°®Á§∫
    notificationElement.classList.add('hidden');
  }
}

// =============================================================================
// SECTION TOGGLE FUNCTIONALITY
// =============================================================================

// Toggle section expansion/collapse
// toggleSection function is now defined in adminPanel-framework.js.html

// Automatically collapse completed sections
function collapseCompletedSection(stepNumber) {
  const sectionId = `step${stepNumber}-content`;
  const section = document.getElementById(sectionId);
  if (!section) return;
  
  console.log(`üìÅ Auto-collapsing completed step ${stepNumber}`);
  
  // Collapse the section
  section.classList.add('hidden');
  
  // Update toggle button state
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  if (toggleBtn) {
    toggleBtn.setAttribute('aria-expanded', 'false');
    const arrow = toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
    if (arrow) {
      arrow.classList.remove('fa-chevron-down');
      arrow.classList.add('fa-chevron-up');
    }
  }
  
  // Note: Visual indicators are now managed by manageSectionStates()
}

// Automatically expand active section
function expandActiveSection(stepNumber) {
  const sectionId = `step${stepNumber}-content`;
  const section = document.getElementById(sectionId);
  if (!section) return;
  
  console.log(`üìÇ Auto-expanding active step ${stepNumber}`);
  
  // Expand the section
  section.classList.remove('hidden');
  
  // Special handling for Step 3: ensure config-area is visible
  if (stepNumber === 3) {
    const configArea = document.getElementById('config-area');
    if (configArea && currentStatus && currentStatus.activeSheetName) {
      configArea.classList.remove('hidden');
      console.log(`üìã expandActiveSection: Config area shown for Step 3`);
    }
  }
  
  // Update toggle button state
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  if (toggleBtn) {
    toggleBtn.setAttribute('aria-expanded', 'true');
    const arrow = toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
    if (arrow) {
      arrow.classList.remove('fa-chevron-up');
      arrow.classList.add('fa-chevron-down');
    }
  }
  
  // Note: Visual indicators are now managed by manageSectionStates()
}

// Manage section states based on current step (simplified - no visual effects)
function manageSectionStates(currentStep) {
  console.log(`üîÑ Managing section states for step ${currentStep}`);
  
  // „Çπ„ÉÜ„ÉÉ„Éó„Åî„Å®„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥Âà∂Âæ°
  for (let i = 1; i <= 3; i++) {
    const sectionId = `step${i}-content`;
    const section = document.getElementById(sectionId);
    
    if (i === currentStep) {
      // ÁèæÂú®„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó: Â±ïÈñã„Åó„Å¶ÊúâÂäπÂåñ
      expandActiveSection(i);
      
      // Step 3„ÅÆÁâπÂà•Âá¶ÁêÜ: config-area„ÅÆË°®Á§∫
      if (i === 3) {
        const configArea = document.getElementById('config-area');
        if (configArea && currentStatus && currentStatus.activeSheetName) {
          configArea.classList.remove('hidden');
          console.log(`üìã Step 3: Config area shown for sheet: ${currentStatus.activeSheetName}`);
        }
      }
      
      console.log(`üîÑ Step ${i}: Active (current step)`);
    } else if (i < currentStep) {
      // ÂÆå‰∫ÜÊ∏à„Åø„Çπ„ÉÜ„ÉÉ„Éó: „Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Å†„Åå„ÄÅÂ±ïÈñã„ÅØ‰ªªÊÑè
      if (section) {
        section.classList.add('opacity-90'); // ÂÆå‰∫Ü„Åó„ÅüÁä∂ÊÖã„ÇíË¶ñË¶öÁöÑ„Å´Á§∫„Åô
      }
      console.log(`‚úÖ Step ${i}: Completed (accessible)`);
    } else {
      // Êú™Êù•„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó: Step 1„ÅÆÂ†¥Âêà„ÅØpendingÁä∂ÊÖã„Åß„ÇÇÂÖ®„Å¶Èñ≤Ë¶ßÂèØËÉΩ
      if (currentStep === 1) {
        // Step 1„Åß„ÅØÂÖ®„Çπ„ÉÜ„ÉÉ„Éó„Å´„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩÔºà„Éá„Éº„ÇøÁ¢∫Ë™ç„ÅÆ„Åü„ÇÅÔºâ
        if (section) {
          section.classList.add('opacity-75'); // Êú™Êù•„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å®„Åó„Å¶ËªΩ„ÅèË°®Á§∫
        }
        console.log(`‚è≠Ô∏è Step ${i}: Available for preview`);
      } else {
        // Step 2‰ª•Èôç„Åß„ÅØÈ†ÜÊ¨°ÈñãÊîæ
        if (section) {
          section.classList.add('opacity-50'); // Êú™Êù•„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å®„Åó„Å¶Ë°®Á§∫
        }
        console.log(`‚è≠Ô∏è Step ${i}: Future step (available)`);
      }
    }
  }
}

// =============================================================================
// MODAL MANAGEMENT
// =============================================================================

// Show form configuration modal
// showFormConfigModal function is now defined in adminPanel-framework.js.html

// Hide form configuration modal
function hideFormConfigModal() {
  if (window.sharedModals) {
    window.sharedModals.hideModal('form-config-modal');
    manageFocusForModal('form-config-modal', false);
  } else {
    // Fallback for legacy support
    const modal = document.getElementById('form-config-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      manageFocusForModal('form-config-modal', false);
    }
  }
}

// Override placeholder with actual function
if (typeof window !== 'undefined') {
  window.hideFormConfigModal = hideFormConfigModal;
}

// Show privacy modal
function showPrivacyModal(onContinue) {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('privacy-modal', true);
    
    // Set up continue handler
    const continueBtn = document.getElementById('privacy-modal-continue');
    if (continueBtn && onContinue) {
      continueBtn.onclick = onContinue;
    }
  }
}

// Override placeholder with actual function
if (typeof window !== 'undefined') {
  window.showPrivacyModal = showPrivacyModal;
}

// Hide privacy modal
// hidePrivacyModal function is now defined in adminPanel-framework.js.html

// Show digital citizenship modal
function showDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('digital-citizenship-modal', true);
  }
}

// Hide digital citizenship modal
function hideDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('digital-citizenship-modal', false);
  }
}

// Show confirmation modal
function showConfirmationModal(title, message, onConfirm) {
  const modal = document.getElementById('confirmation-modal');
  const titleElement = document.getElementById('modal-title');
  const messageElement = document.getElementById('modal-message');
  const confirmBtn = document.getElementById('modal-confirm-btn');
  const cancelBtn = document.getElementById('modal-cancel-btn');
  
  console.log('üîç showConfirmationModal: Ë¶ÅÁ¥†Ê§úÁ¥¢ÂÆå‰∫Ü');
  
  if (modal && titleElement && messageElement && confirmBtn) {
    titleElement.textContent = title;
    messageElement.textContent = message;
    
    // Á¢∫Ë™ç„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    confirmBtn.onclick = function() {
      console.log('‚úÖ Á¢∫Ë™ç„Éú„Çø„É≥„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
      hideConfirmationModal();
      if (onConfirm) {
        try {
          onConfirm();
        } catch (error) {
          console.error('‚ùå Á¢∫Ë™ç„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å„Ç®„É©„Éº:', error);
        }
      }
    };
    
    // „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    if (cancelBtn) {
      cancelBtn.onclick = function() {
        console.log('‚ùå „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
        hideConfirmationModal();
      };
    }
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('confirmation-modal', true);
    console.log('‚úÖ Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü');
  } else {
    console.error('‚ùå „É¢„Éº„ÉÄ„É´Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ');
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éñ„É©„Ç¶„Ç∂Ê®ôÊ∫ñ„ÅÆÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
    if (window.confirm(`${title}\n\n${message}`)) {
      if (onConfirm) {
        try {
          onConfirm();
        } catch (error) {
          console.error('‚ùå „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁ¢∫Ë™ç„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å„Ç®„É©„Éº:', error);
        }
      }
    }
  }
}

// Hide confirmation modal
function hideConfirmationModal() {
  const modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('confirmation-modal', false);
  }
}

// =============================================================================
// DYNAMIC CONTENT UPDATES
// =============================================================================

// Update dynamic content when board is active
function updateDynamicContent(status) {
  // Enable buttons that require active state
  const buttons = [
    'open-spreadsheet-btn'
  ];
  
  buttons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = false;
      button.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  });
}

// Update UI when no sheet is active
function updateUIForNoActiveSheet(status) {
  // Disable buttons that require active state
  const buttons = [
    // No form buttons to disable since we only support spreadsheets
  ];
  
  buttons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = true;
      button.classList.add('opacity-50', 'cursor-not-allowed');
    }
  });
}

// Update existing user section
function updateExistingUserSection(status) {
  // Update any user-specific UI elements
  if (status.userInfo) {
    // Update user-specific elements here if needed
  }
}

// Update custom form info
function updateCustomFormInfo(status) {
  if (status.customFormInfo) {
    // Update form-related UI elements
    const formTitle = document.getElementById('form-title-display');
    const formQuestion = document.getElementById('form-question-display');
    
    if (formTitle) {
      formTitle.textContent = status.customFormInfo.title || '„Éï„Ç©„Éº„É†Êú™‰ΩúÊàê';
    }
    
    if (formQuestion) {
      formQuestion.textContent = status.customFormInfo.mainQuestion || '';
    }
  }
  
  // „Éï„Ç©„Éº„É†URLË°®Á§∫„ÅÆÊõ¥Êñ∞ÔºàconfigJson„Åã„ÇâÁ¢∫ÂÆü„Å´ÂèñÂæóÔºâ
  updateFormUrlDisplay(status);
}

// „Éï„Ç©„Éº„É†URLË°®Á§∫„ÇíÁ¢∫ÂÆü„Å´Êõ¥Êñ∞
function updateFormUrlDisplay(status = null) {
  const formUrlInput = document.getElementById('form-url-input');
  const formUrlSection = document.getElementById('form-url-section');
  const openFormLink = document.getElementById('open-form-url-link');

  if (!formUrlInput) return;

  // ÁèæÂú®„ÅÆstatus„ÅÆÊúÄÈÅ©Âåñ„Åï„Çå„ÅüÂèñÂæó
  const currentStatusToUse = status || currentStatus;
  if (!currentStatusToUse || !currentStatusToUse.userInfo) {
    logWarn('‚ö†Ô∏è updateFormUrlDisplay: statusÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
    return;
  }

  // Êñ∞„Åó„ÅÑÁµ±‰∏Ä„Éò„É´„Éë„ÉºÈñ¢Êï∞„Åã„Çâ„Éï„Ç©„Éº„É†URL„ÇíÂèñÂæó
  const resourceUrls = getActiveResourceUrls(currentStatusToUse);
  const formUrl = resourceUrls.form;

  // UIÊõ¥Êñ∞„ÅÆÊúÄÈÅ©Âåñ
  if (formUrl) {
    updateFormUrlElements(formUrlInput, openFormLink, formUrl);
    handleFormUrlSectionVisibility(formUrlSection);
    logDebug('üîó FormURL UIÊõ¥Êñ∞ÂÆå‰∫Ü:', formUrl);
  } else {
    clearFormUrlElements(formUrlInput, formUrlSection);
    logDebug('üì≠ FormURLÊú™Ë®≠ÂÆö„ÅÆ„Åü„ÇÅUIÈùûË°®Á§∫');
  }
}

// „Éï„Ç©„Éº„É†URLË¶ÅÁ¥†Êõ¥Êñ∞„ÅÆÊúÄÈÅ©Âåñ
function updateFormUrlElements(input, link, url) {
  input.value = url;
  if (link) {
    link.href = url;
  }
}

// „Éï„Ç©„Éº„É†URLË¶ÅÁ¥†„ÇØ„É™„Ç¢„ÅÆÊúÄÈÅ©Âåñ
function clearFormUrlElements(input, section) {
  input.value = '';
  if (section) {
    section.classList.add('hidden');
  }
}

// „Éï„Ç©„Éº„É†URL„Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫Âà∂Âæ°„ÅÆÊúÄÈÅ©Âåñ
function handleFormUrlSectionVisibility(section) {
  if (!section) return;
  
  const formJustCreated = sessionStorage.getItem('form_just_created');
  if (formJustCreated === 'true') {
    section.classList.remove('hidden');
    logDebug('üÜï Êñ∞Ë¶è„Éï„Ç©„Éº„É†‰ΩúÊàê„Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫');
    
    // „Éï„É©„Ç∞„ÇØ„É™„Ç¢„ÅÆÊúÄÈÅ©ÂåñÔºà„Çø„Ç§„Éû„ÉºÂá¶ÁêÜÔºâ
    setTimeout(() => {
      sessionStorage.removeItem('form_just_created');
      logDebug('üßπ „Éï„Ç©„Éº„É†‰ΩúÊàê„Éï„É©„Ç∞„ÇØ„É™„Ç¢');
    }, 10000);
  } else {
    section.classList.add('hidden');
  }
}

// Check for auto-publish dialog
function checkAutoPublishDialog(status) {
  // Implementation for auto-publish dialog if needed
  if (status.needsAutoPublish) {
    // Show auto-publish confirmation
  }
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// UI initialization is now handled in adminPanel-framework.js.html

// =============================================================================
// SHEET SELECTION FUNCTIONALITY  
// =============================================================================

// „Ç∑„Éº„ÉàÈÅ∏ÊäûÂá¶ÁêÜ‰∏≠„Éï„É©„Ç∞ÔºàÈáçË§áÈò≤Ê≠¢Ôºâ
let sheetSelectionInProgress = false;

// Handle sheet selection change (ÊúÄÈÅ©ÂåñÁâà)
function handleSheetSelectionChange(event) {
  const newSelectedSheet = event.target.value;

  // ÈáçË§áÂÆüË°åÈò≤Ê≠¢
  if (sheetSelectionInProgress) {
    console.log('üìä Sheet selection already in progress, skipping...');
    return;
  }

  // Prevent redundant calls if the selected sheet hasn't actually changed
  if (newSelectedSheet === lastSelectedSheetName) {
    console.log('üìä Sheet selection unchanged, skipping redundant processing.');
    return;
  }
  
  sheetSelectionInProgress = true;
  console.log('üìä Sheet selection changed: ' + newSelectedSheet);
  
  try {
    // Update global selected sheet variable and last selected sheet
    selectedSheet = newSelectedSheet;
    lastSelectedSheetName = newSelectedSheet;
    
    if (newSelectedSheet) {
      console.log('üìã Loading config for sheet:', newSelectedSheet);

      // Âü∫Êú¨Ê§úË®º
      if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
        console.error('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
      }

      // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Éº„Éà„ÅÆÂàó„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶ÂàóÈÅ∏Êäû„ÇíÊõ¥Êñ∞
      loadConfigForSelected(newSelectedSheet, currentStatus.userInfo.spreadsheetId)
        .then(result => {
          console.log('‚úÖ „Ç∑„Éº„ÉàË®≠ÂÆöË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', result);
          updateUIForSelectedSheet();
        })
        .catch(error => {
          console.error('‚ùå „Ç∑„Éº„ÉàË®≠ÂÆöË™≠„ÅøËæº„ÅøÂ§±Êïó:', error);
          showMessage('„Ç∑„Éº„Éà„ÅÆË®≠ÂÆöË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
          updateUIForSelectedSheet();
        })
        .finally(() => {
          // Âá¶ÁêÜ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
          sheetSelectionInProgress = false;
        });
        
      // Âç≥Â∫ß„Å´„Ç∑„Éº„Éà„Çí„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ
      activateSelectedSheet(newSelectedSheet);
    } else {
      // „Ç∑„Éº„ÉàÈÅ∏Êäû„ÅåËß£Èô§„Åï„Çå„ÅüÂ†¥Âêà
      clearColumnSelections();
      updateUIForSelectedSheet();
    }
  } catch (error) {
    console.error('‚ùå Sheet selection error:', error);
  } finally {
    // Âá¶ÁêÜ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„ÉàÔºà„Ç®„É©„ÉºÊôÇ„ÇÇÁ¢∫ÂÆü„Å´Ôºâ
    sheetSelectionInProgress = false;
  }
}

// „Ç∑„Éº„Éà„ÇíÂç≥Â∫ß„Å´„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ„Åô„ÇãÈñ¢Êï∞
function activateSelectedSheet(sheetName) {
  if (!sheetName || !currentStatus || !currentStatus.userInfo) {
    console.warn('‚ö†Ô∏è „Ç∑„Éº„Éà„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ„Å´ÂøÖË¶Å„Å™ÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
    return;
  }

  console.log(`üéØ „Ç∑„Éº„Éà„ÇíÂç≥Â∫ß„Å´„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ: ${sheetName}`);
  
  // „Çµ„Éº„Éê„ÉºÂÅ¥„Åß„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Éº„Éà„ÇíË®≠ÂÆö
  runGasWithUserId('setActiveSheet', '„Ç∑„Éº„Éà„Çí„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ‰∏≠...', sheetName)
    .then(response => {
      console.log('‚úÖ „Ç∑„Éº„Éà„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñÂÆå‰∫Ü:', response);
      
      // currentStatus„ÇíÊõ¥Êñ∞
      if (currentStatus.userInfo.configJson) {
        try {
          const config = JSON.parse(currentStatus.userInfo.configJson);
          config.publishedSheetName = sheetName;
          currentStatus.userInfo.configJson = JSON.stringify(config);
          currentStatus.activeSheetName = sheetName;
          
          // „Ç∑„Éº„Éà„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
          updateSheetSelectActiveIndicator(sheetName);
          
          console.log('‚úÖ „É≠„Éº„Ç´„É´Áä∂ÊÖãÊõ¥Êñ∞ÂÆå‰∫Ü');
        } catch (e) {
          console.warn('‚ö†Ô∏è configJsonÊõ¥Êñ∞„Å´Â§±Êïó:', e);
        }
      }
    })
    .catch(error => {
      console.error('‚ùå „Ç∑„Éº„Éà„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñÂ§±Êïó:', error);
      showMessage('„Ç∑„Éº„Éà„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'warning');
    });
}

// „Ç∑„Éº„Éà„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñË°®Á§∫„ÇíÊõ¥Êñ∞
function updateSheetSelectActiveIndicator(activeSheetName) {
  const select = document.getElementById('sheet-select');
  if (!select) return;
  
  // ÂÖ®„Å¶„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Åã„Çâ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñË°®Á§∫„ÇíÂâäÈô§
  Array.from(select.options).forEach(option => {
    if (option.value && option.textContent.includes(' („Ç¢„ÇØ„ÉÜ„Ç£„Éñ)')) {
      option.textContent = option.value;
      option.style.fontWeight = 'normal';
      option.style.color = '';
      option.className = '';
    }
  });
  
  // Êñ∞„Åó„ÅÑ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Éº„Éà„Å´Ë°®Á§∫„ÇíËøΩÂä†
  const activeOption = Array.from(select.options).find(option => option.value === activeSheetName);
  if (activeOption) {
    activeOption.textContent = `${activeSheetName} („Ç¢„ÇØ„ÉÜ„Ç£„Éñ)`;
    activeOption.style.fontWeight = 'bold';
    activeOption.style.color = '#10b981';
    activeOption.className = 'active-sheet-option';
  }
}

// ÈáçË§áUIÊõ¥Êñ∞Èò≤Ê≠¢Áî®„Ç≠„É£„ÉÉ„Ç∑„É•
let lastUIUpdateSheet = null;
let uiUpdateCount = 0;

// Êñ∞„Åó„ÅÑÈñ¢Êï∞: „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Éº„ÉàUIÊõ¥Êñ∞
function updateActiveSheetUI(sheetName) {
  // ÈáçË§áÈò≤Ê≠¢: Âêå„Åò„Ç∑„Éº„Éà„Å´ÂØæ„Åô„ÇãÈÄ£Á∂öÊõ¥Êñ∞„ÇíÂà∂Èôê
  if (lastUIUpdateSheet === sheetName && uiUpdateCount >= 2) {
    return; // ÈáçË§áÊõ¥Êñ∞„Çí„Çπ„Ç≠„ÉÉ„Éó
  }
  
  if (lastUIUpdateSheet !== sheetName) {
    uiUpdateCount = 0; // Êñ∞„Åó„ÅÑ„Ç∑„Éº„Éà„ÅÆÂ†¥Âêà„ÅØ„Ç´„Ç¶„É≥„Éà„É™„Çª„ÉÉ„Éà
  }
  
  console.log('üîÑ updateActiveSheetUI called with:', sheetName);
  
  const select = document.getElementById('sheet-select');
  if (!select) {
    console.warn('‚ö†Ô∏è Sheet select element not found');
    return;
  }
  
  // „Ç∑„Éº„ÉàÈÅ∏Êäû„ÇíÊõ¥Êñ∞
  if (sheetName && select.value !== sheetName) {
    const normalizedSheetName = sheetName.trim();
    const availableOptions = Array.from(select.options);
    const matchingOption = availableOptions.find(option => option.value === normalizedSheetName);
    
    if (matchingOption) {
      select.value = normalizedSheetName;
      selectedSheet = normalizedSheetName;
      lastSelectedSheetName = normalizedSheetName;
      lastUIUpdateSheet = normalizedSheetName;
      uiUpdateCount++;
      console.log('‚úÖ Active sheet UI updated:', normalizedSheetName);
      
      // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñË°®Á§∫„ÇÇÊõ¥Êñ∞
      updateSheetSelectActiveIndicator(normalizedSheetName);
      
      // UIÁä∂ÊÖã„ÇÇÊõ¥Êñ∞
      updateUIForSelectedSheet();
    } else {
      console.warn('‚ö†Ô∏è Sheet not found in select options:', normalizedSheetName);
    }
  }
}

// Êñ∞„Åó„ÅÑÈñ¢Êï∞: „Ç∑„Éº„ÉàÈÅ∏Êäû„ÅÆÂÜçÂêåÊúü
function refreshSheetSelection() {
  console.log('üîÑ refreshSheetSelection called');
  
  // ÁèæÂú®„ÅÆÁä∂ÊÖã„Åã„Çâ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
  if (window.currentStatus && window.currentStatus.activeSheetName) {
    updateActiveSheetUI(window.currentStatus.activeSheetName);
  } else if (selectedSheet) {
    updateActiveSheetUI(selectedSheet);
  }
}

// ÂàóÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢„Åô„ÇãÈñ¢Êï∞
function clearColumnSelections() {
  console.log('üßπ ÂàóÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢');
  
  const columnSelects = [
    'opinion-column',
    'name-column', 
    'reason-column',
    'class-column',
    'timestamp-column'
  ];
  
  columnSelects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.innerHTML = '<option value="">-- „Ç∑„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>';
      select.disabled = true;
    }
  });
}

// Load configuration for selected sheet - OPTIMIZED
function loadConfigForSelected(sheetName, spreadsheetId, retryCount = 0, maxRetries = 3) {
  console.log('üìã Loading config for: ' + sheetName);

  if (!spreadsheetId || !sheetName) {
    console.error('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
    return Promise.reject(new Error('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô'));
  }

  return new Promise((resolve, reject) => {

  // Check if fresh save protection is active - skip cache if so
  const timeSinceFreshSave = Date.now() - (window.freshSaveTimestamp || 0);
  const isFreshSaveActive = timeSinceFreshSave < 30000; // 30 seconds
  
    // Check if we already have sheet details from integrated API
    if (!isFreshSaveActive && currentStatus && currentStatus.sheetDetails && 
        currentStatus.activeSheetName === sheetName && currentStatus.sheetDetails.allHeaders && currentStatus.sheetDetails.allHeaders.length > 0) {
      console.log('‚ö° Using cached sheet details from integrated API');
      try {
        populateHeaderOptions(currentStatus.sheetDetails.allHeaders);
        console.log('‚úÖ Header options populated from cache');
        populateConfig(currentStatus.sheetDetails.guessedConfig);
        console.log('‚úÖ AI configuration applied from cache');
        resolve({ source: 'cache', headers: currentStatus.sheetDetails.allHeaders, config: currentStatus.sheetDetails.guessedConfig });
        return; // Early return - no API call needed
      } catch (error) {
        console.error('Error in cached config population:', error);
        // Fall through to API call if cache fails
      }
    }

  // Force fresh API call if fresh save protection is active or cache unavailable
  if (isFreshSaveActive) {
    console.log('üîÑ Fresh save protection active - forcing API call for latest data');
  } else {
    console.log('üìû Making API call for sheet details:', sheetName);
  }
  
    runGasWithUserId('getSheetDetails', '„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...', spreadsheetId, sheetName)
      .then(function(details) {
        console.log('‚úÖ Sheet details loaded via API:', details);
        
        // If headers are empty, and we have retries left, try again after a delay
        if (details && (!details.allHeaders || details.allHeaders.length === 0) && retryCount < maxRetries) {
          console.warn(`‚ö†Ô∏è No headers found for ${sheetName}. Retrying in 2 seconds... (Attempt ${retryCount + 1}/${maxRetries})`);
          showMessage(`„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíÂÜçÂèñÂæó‰∏≠... (${retryCount + 1}/${maxRetries})`, 'info');
          setTimeout(() => {
            loadConfigForSelected(sheetName, spreadsheetId, retryCount + 1, maxRetries)
              .then(resolve)
              .catch(reject);
          }, 2000); // Retry after 2 seconds
          return;
        }

        try {
          populateHeaderOptions(details.allHeaders);
          console.log('‚úÖ Header options populated from API');
          populateConfig(details.guessedConfig);
          console.log('‚úÖ AI configuration applied from API');
          if (retryCount > 0) {
            showMessage('‚úÖ „Ç∑„Éº„ÉàÊÉÖÂ†±„ÅåÊ≠£Â∏∏„Å´Ë™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„ÅüÔºÅ', 'success');
          }
          resolve({ source: 'api', headers: details.allHeaders, config: details.guessedConfig });
        } catch (error) {
          console.error('Error in API config population sequence:', error);
          showMessage('Ë®≠ÂÆö„ÅÆÈÅ©Áî®‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
          reject(error);
        }
      })
      .catch(function(error) {
        console.error('Failed to load sheet config via API:', error);
        
        // „Çà„ÇäË©≥Á¥∞„Å™„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË°®Á§∫
        let errorMessage = '„Ç∑„Éº„ÉàË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
        
        if (error && error.message) {
          if (error.message.includes('„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì')) {
            errorMessage = `ÊåáÂÆö„Åï„Çå„Åü„Ç∑„Éº„Éà "${sheetName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ`;
          } else if (error.message.includes('„Éò„ÉÉ„ÉÄ„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì')) {
            errorMessage = `„Ç∑„Éº„Éà "${sheetName}" „ÅÆ1Ë°åÁõÆ„Å´„Éò„ÉÉ„ÉÄ„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ`;
          } else if (error.message.includes('„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê')) {
            errorMessage = '„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å∏„ÅÆ„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ';
          } else if (error.message.includes('SheetsService')) {
            errorMessage = 'Google Sheets API„Çµ„Éº„Éì„Çπ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          } else {
            errorMessage = `„Ç®„É©„Éº„ÅÆË©≥Á¥∞: ${error.message}`;
          }
        }
        
        showMessage(errorMessage, 'error');
        
        // „Ç®„É©„ÉºÊôÇ„ÅÆ„É™„Éà„É©„Ç§„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊèê‰æõ
        if (retryCount < maxRetries) {
          setTimeout(() => {
            const retryButton = document.createElement('button');
            retryButton.textContent = 'ÂÜçË©¶Ë°å';
            retryButton.className = 'ml-2 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600';
            retryButton.onclick = () => {
              retryButton.remove();
              loadConfigForSelected(sheetName, spreadsheetId, retryCount + 1, maxRetries)
                .then(resolve)
                .catch(reject);
            };
            
            const messageElement = document.querySelector('.message');
            if (messageElement) {
              messageElement.appendChild(retryButton);
            }
          }, 1000);
        } else {
          reject(error);
        }
      });
  }); // PromiseÁµÇ‰∫Ü
}


// =============================================================================
// SETUP STATUS HANDLING FUNCTIONS
// =============================================================================

/**
 * userInfo„Åã„ÇâsetupStatus„ÇíÂÆâÂÖ®„Å´ÂèñÂæó
 * @param {Object} userInfo - „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
 * @returns {string} setupStatus ('pending', 'completed', 'error')
 */
function getSetupStatusFromUserInfo(userInfo) {
  try {
    if (!userInfo || !userInfo.configJson) {
      return 'pending'; // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊú™ÂÆå‰∫Ü„Å®„Åø„Å™„Åô
    }

    const config = typeof userInfo.configJson === 'string'
      ? JSON.parse(userInfo.configJson)
      : userInfo.configJson;

    // setupStatus„ÅåÊòéÁ§∫ÁöÑ„Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
    if (config.setupStatus) {
      console.log('üîß configJson setupStatus:', config.setupStatus);
      return config.setupStatus;
    }
    
    // setupStatus„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅ‰ªñ„ÅÆ„Éï„Ç£„Éº„É´„Éâ„Åã„ÇâÊé®Ê∏¨ÔºàÂæ™Áí∞ÂèÇÁÖßÂõûÈÅøÔºâ
    // Note: „Åì„ÅÆÊé®Ê∏¨„É≠„Ç∏„ÉÉ„ÇØ„ÅØÂæ™Áí∞ÂèÇÁÖß„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„ÄÅformUrl„Éô„Éº„Çπ„Å´Â§âÊõ¥
    if (config.formCreated === true && config.formUrl && config.formUrl.trim()) {
      return 'completed';
    }
    
    return 'pending';
    
  } catch (error) {
    console.warn('getSetupStatusFromUserInfo JSONËß£Êûê„Ç®„É©„Éº:', error.message);
    return 'pending'; // „Ç®„É©„ÉºÊôÇ„ÅØ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊú™ÂÆå‰∫Ü„Å®„Åø„Å™„Åô
  }
}


/**
 * ÂàùÊúüË°®Á§∫Ë¶ÅÁ¥†„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÈÅ©Âàá„Å™„Éâ„É°„Ç§„É≥Ë°®Á§∫„Å´Âàá„ÇäÊõø„Åà
 */
function clearInitialDisplayElements() {
  // ÂàùÊúüË°®Á§∫„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶„ÄÅÈÅ©Âàá„Å™„Éâ„É°„Ç§„É≥Ë°®Á§∫„Å´Âàá„ÇäÊõø„Åà
  const initialContainer = document.getElementById('header-domain-initial');
  if (initialContainer) {
    initialContainer.style.display = 'none';
    console.log('‚úÖ ÂàùÊúü„Éâ„É°„Ç§„É≥Ë°®Á§∫„ÇíÈùûË°®Á§∫');
  }
  
  // ÈÅ©Âàá„Å™„Éâ„É°„Ç§„É≥ÊÉÖÂ†±„ÇíË°®Á§∫
  showAppropriateHeaderStatus();
  
  // Êó¢Â≠ò„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Ç¨„Ç§„Éâ„ÅÆ„ÅøÂâäÈô§
  const existingGuides = [
    document.getElementById('setup-pending-guide'),
    document.querySelector('.setup-guide')
  ];
  
  existingGuides.forEach(guide => {
    if (guide) {
      guide.remove();
      console.log('‚úÖ Êó¢Â≠ò„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Ç¨„Ç§„Éâ„ÇíÂâäÈô§');
    }
  });
}

/**
 * „Éò„ÉÉ„ÉÄ„Éº„Å´ÈÅ©Âàá„Å™„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫„ÇíË®≠ÂÆö
 */
function showAppropriateHeaderStatus() {
  // „Éâ„É°„Ç§„É≥‰∏ÄËá¥Ë°®Á§∫Ôºà‰ªÆÔºâ„ÇíË°®Á§∫
  const domainMatch = document.getElementById('header-domain-match');
  const domainMismatch = document.getElementById('header-domain-mismatch');
  
  if (domainMatch && domainMismatch) {
    // ÁèæÂú®„ÅØ„Éâ„É°„Ç§„É≥‰∏ÄËá¥„Å®„Åó„Å¶Ë°®Á§∫ÔºàÂÆüÈöõ„ÅÆ„Éâ„É°„Ç§„É≥„ÉÅ„Çß„ÉÉ„ÇØ„ÅØÂà•ÈÄîÂÆüË£ÖÔºâ
    domainMatch.style.display = 'block';
    domainMismatch.style.display = 'none';
    
    // „Éâ„É°„Ç§„É≥Âêç„ÇíÈÅ©Âàá„Å´Ë®≠ÂÆö
    const domainText = document.getElementById('header-domain-match-text');
    if (domainText) {
      domainText.textContent = 'naha-okinawa.ed.jp';
    }
    
    console.log('‚úÖ „Éâ„É°„Ç§„É≥‰∏ÄËá¥Ë°®Á§∫„ÇíÊúâÂäπÂåñ');
  }
}

/**
 * „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁä∂Ê≥Å„Å´Âøú„Åò„Å¶„Éú„Çø„É≥Áä∂ÊÖã„ÇíÊõ¥Êñ∞
 * @param {Object} status - „Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
 */
function updateButtonStatesForSetup(status) {
  // „Çà„ÇäÁ©è„ÇÑ„Åã„Å™UIÂà∂Âæ°Ôºà„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁÑ°ÂäπÂåñ„Åß„ÅØ„Å™„Åè„ÄÅÈÅ©Âàá„Å™„Ç¨„Ç§„ÉÄ„É≥„ÇπÔºâ

  // ÊúÄ‰ΩéÈôêÁÑ°ÂäπÂåñ„Åô„Åπ„ÅçÂÖ¨ÈñãÈñ¢ÈÄ£„Éú„Çø„É≥„ÅÆ„Åø
  const criticalPublishButtons = [
    'save-publish-btn',
    'unpublish-board-btn'
  ];
  
  criticalPublishButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      // „Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÁÑ°ÂäπÂåñ
      const hasSpreadsheet = status.userInfo && status.userInfo.spreadsheetId;
      const hasActiveSheet = status.activeSheetName;
      
      if (!hasSpreadsheet || !hasActiveSheet) {
        button.disabled = true;
        button.classList.add('opacity-75');
        button.title = 'ÂÖà„Å´„Éá„Éº„Çø„ÇΩ„Éº„Çπ„Å®„Ç∑„Éº„Éà„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      } else {
        button.disabled = false;
        button.classList.remove('opacity-75');
        button.title = '';
      }
    }
  });
  
  console.log('‚úÖ „Éú„Çø„É≥Áä∂ÊÖã„ÇíÈÅ©Âàá„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü');
}


/**
 * Âü∫Êú¨ÁöÑ„Å™ÈùôÁöÑUIË¶ÅÁ¥†„ÅÆ„ÅøÊõ¥Êñ∞
 * @param {Object} status - „Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
 */
function updateBasicStaticUI(status) {
  // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Å™„Å©ÊúÄ‰ΩéÈôê„ÅÆÊÉÖÂ†±„ÅÆ„ÅøÊõ¥Êñ∞
  if (status.userInfo) {
    // Êó¢Â≠ò„ÅÆupdateDatabaseInfoÈñ¢Êï∞„Çí‰ΩøÁî®„Åó„Å¶ÈáçË§á„ÇíÈÅø„Åë„Çã
    updateDatabaseInfo(status);
  }
}

// Update system status display
/**
 * ÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Åô„Åπ„Å¶„ÅÆ„É™„ÇΩ„Éº„ÇπURL„ÇíÂèñÂæó„Åó„ÄÅÁµ±‰∏Ä„Åï„Çå„Åü„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å®„Åó„Å¶Ëøî„Åô„ÄÇ
 * @param {object} status - ÊúÄÊñ∞„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
 * @returns {object} - ÂêÑ„É™„ÇΩ„Éº„Çπ„ÅÆURL„ÇíÊ†ºÁ¥ç„Åó„Åü„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
 */
function getActiveResourceUrls(status) {
  const urls = {
    spreadsheet: null,
    folder: null,
    form: null,
    editForm: null
  };

  if (!status || !status.userInfo) {
    console.log('getActiveResourceUrls: status or userInfo missing', status); // Gemini Debug
    return urls; // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åå„Å™„Åë„Çå„Å∞Á©∫„ÅÆURL„ÇíËøî„Åô
  }

  // 1. „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàURL„ÅÆÂèñÂæó (userInfoÁõ¥‰∏ã„Åã„Çâ)
  urls.spreadsheet = status.userInfo.spreadsheetUrl || null;

  // 2. configJson„ÅÆËß£Êûê (‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°å)
  let config = {};
  if (status.userInfo.configJson) {
    try {
      config = typeof status.userInfo.configJson === 'string' 
        ? JSON.parse(status.userInfo.configJson) 
        : status.userInfo.configJson;
      console.log('getActiveResourceUrls: configJson parsed:', config); // Gemini Debug
    } catch (e) {
      console.warn("configJson„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", e);
    }
  }

  // 3. „Éï„Ç©„É´„ÉÄURL„ÅÆÂèñÂæó (configJson„Åã„Çâ„ÄÅ„Åæ„Åü„ÅØfolderId „Åã„ÇâÊßãÁØâ)
  urls.folder = config.folderUrl || null;
  
  // „Éï„Ç©„É´„ÉÄURL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÄÅfolderId„Åã„ÇâÊßãÁØâ„ÇíË©¶Ë°å
  if (!urls.folder && config.folderId) {
    const safeFolderId = String(config.folderId || '');
    urls.folder = 'https://drive.google.com/drive/folders/' + safeFolderId;
    console.log('üìÅ Folder URL constructed from folderId:', urls.folder);
  }

  // 4. „Éï„Ç©„Éº„É†URL„ÅÆÂèñÂæó (configJson„Åã„Çâ„ÄÅÂÖ¨Èñã„Ç∑„Éº„Éà„ÇíÂÑ™ÂÖà)
  const publishedSheetName = config.publishedSheetName;
  if (publishedSheetName) {
    const sheetConfig = config['sheet_' + String(publishedSheetName || '')];
    if (sheetConfig) {
      urls.form = sheetConfig.formUrl || urls.form;
      urls.editForm = sheetConfig.editFormUrl || urls.editForm;
    }
  }
  
  // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éà„ÉÉ„Éó„É¨„Éô„É´„ÅÆ„Éï„Ç©„Éº„É†URL
  if (!urls.form && config.formUrl) {
    urls.form = config.formUrl;
  }
  if (!urls.editForm && config.editFormUrl) {
    urls.editForm = config.editFormUrl;
  }

  return urls;
}

function updateSystemStatusDisplay(status) {
  console.log('--- Entering updateSystemStatusDisplay ---'); // Gemini Debug
  if (!status) return;

  // „Åô„Åπ„Å¶„ÅÆ„É™„ÇΩ„Éº„ÇπURL„Çí‰∏ÄÊã¨ÂèñÂæó
  console.log('Calling getActiveResourceUrls...'); // Gemini Debug
  const resourceUrls = getActiveResourceUrls(status);
  console.log('resourceUrls received:', resourceUrls); // Gemini Debug

  // Update publish status
  const publishIndicator = document.getElementById('info-publish-indicator');
  const publishText = document.getElementById('info-publish-text');

  if (status.isPublished) {
    publishIndicator.className = 'w-2 h-2 rounded-full bg-green-400';
    publishText.textContent = 'ÂÖ¨Èñã‰∏≠';
  } else {
    publishIndicator.className = 'w-2 h-2 rounded-full bg-gray-400';
    publishText.textContent = 'ÈùûÂÖ¨Èñã';
  }

  // Update other status fields
  document.getElementById('info-published-sheet').textContent = status.sheetName || '-';
  document.getElementById('info-display-mode').textContent = status.displayMode || '-';
  document.getElementById('info-show-counts').textContent = status.showCounts ? 'Ë°®Á§∫' : 'ÈùûË°®Á§∫';

  // Enable resource buttons if URLs are available
  const spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
  if (spreadsheetBtn) {
    spreadsheetBtn.disabled = !resourceUrls.spreadsheet;
    if (resourceUrls.spreadsheet) {
      spreadsheetBtn.onclick = () => window.open(resourceUrls.spreadsheet, '_blank');
      spreadsheetBtn.title = '„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÇíÈñã„Åè';
    } else {
      spreadsheetBtn.title = '„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàURL„ÅåÊú™Ë®≠ÂÆö„Åß„Åô';
    }
  }

  // „Éï„Ç©„Éº„É†„Éú„Çø„É≥„ÅÆÊúâÂäπÂåñ
  const formBtn = document.getElementById('open-form-btn');
  if (formBtn) {
    formBtn.disabled = false;
    formBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    if (resourceUrls.form) {
      formBtn.onclick = () => window.open(resourceUrls.form, '_blank');
      formBtn.title = '„Éï„Ç©„Éº„É†„ÇíÈñã„Åè';
    } else {
      formBtn.onclick = () => showMessage('„Éï„Ç©„Éº„É†URL„ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇ„Éï„Ç©„Éº„É†„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
      formBtn.title = '„Éï„Ç©„Éº„É†URL„ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇ„Éï„Ç©„Éº„É†„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    }
  }

  // Handle generic resource button in Step 1 (any resource)
  const resourceBtn = document.getElementById('add-resource-btn');
  if (resourceBtn) {
    const anyResourceUrl = resourceUrls.spreadsheet || resourceUrls.folder || resourceUrls.form || resourceUrls.editForm;
    resourceBtn.disabled = false;
    if (anyResourceUrl) {
      resourceBtn.onclick = () => window.open(anyResourceUrl, '_blank');
      resourceBtn.title = '„É™„ÇΩ„Éº„Çπ„ÇíÈñã„Åè';
    } else {
      resourceBtn.onclick = () => showMessage('„É™„ÇΩ„Éº„ÇπURL„ÅåÊú™Ë®≠ÂÆö„Åß„Åô', 'warning');
      resourceBtn.title = '„É™„ÇΩ„Éº„ÇπURL„ÅåÊú™Ë®≠ÂÆö„Åß„Åô';
    }
  }

  // Handle new resource buttons
  console.log('resourceUrls:', resourceUrls); // Gemini Debug
  updateNewResourceButtons(resourceUrls);
}

// Navigate to specific step
// navigateToStep function is now defined in adminPanel-framework.js.html


// „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁä∂Ê≥Å„Çí„Ç∞„É≠„Éº„Éê„É´„Çπ„ÉÜ„Éº„Çø„Çπ„Åã„ÇâÂèñÂæó




// Validate configuration
function validateConfiguration() {
  if (!currentConfig || !currentConfig.columnMappings) return false;
  
  const mappings = currentConfig.columnMappings;
  const hasContent = Object.values(mappings).includes('content');
  const hasAuthor = Object.values(mappings).includes('author');
  
  return hasContent && hasAuthor;
}


// =============================================================================
// HISTORY MANAGEMENT FUNCTIONS
// =============================================================================

// Â±•Ê≠¥ÁÆ°ÁêÜ„ÅÆÂÆöÊï∞
const HISTORY_STORAGE_KEY = 'answerBoardHistory';
const MAX_HISTORY_ITEMS = 50;

/**
 * ÂõûÁ≠î„Éú„Éº„Éâ„ÅÆÂ±•Ê≠¥„Çí‰øùÂ≠ò
 * @param {Object} historyItem - ‰øùÂ≠ò„Åô„ÇãÂ±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†
 */
function saveToHistory(historyItem) {
  try {
    if (!historyItem || !historyItem.questionText) {
      logWarn('Invalid history item, skipping save');
      return;
    }

    const history = getHistoryFromStorage();
    
    // AIÂàóÂà§ÂÆöÁµêÊûú„ÇíÂê´„ÇÄÊã°Âºµ„Åï„Çå„ÅüÂ±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
    const newItem = {
      id: generateHistoryId(),
      timestamp: new Date().toISOString(),
      publishedAt: historyItem.publishedAt || new Date().toISOString(),
      publishedEndAt: historyItem.publishedEndAt || null,
      // Êñ∞„Åó„ÅÑ„Éï„Ç£„Éº„É´„Éâ: ÁµÇ‰∫ÜÈñ¢ÈÄ£
      endTime: historyItem.endTime || null, // ÂÆüÈöõ„ÅÆÁµÇ‰∫ÜÊó•ÊôÇÔºàÁµÇ‰∫ÜÊôÇ„Å´Ë®òÈå≤Ôºâ
      scheduledEndTime: historyItem.scheduledEndTime || null, // ‰∫àÂÆöÁµÇ‰∫ÜÊó•ÊôÇ
      questionText: historyItem.questionText,
      sheetName: historyItem.sheetName || '',
      answerCount: historyItem.answerCount || 0,
      reactionCount: historyItem.reactionCount || 0,
      config: historyItem.config || {},
      formUrl: historyItem.formUrl || '',
      spreadsheetUrl: historyItem.spreadsheetUrl || '',
      setupType: historyItem.setupType || 'unknown', // „ÇØ„Ç§„ÉÉ„ÇØ„Çπ„Çø„Éº„Éà„ÄÅ„Ç´„Çπ„Çø„É†„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÄÅÂ§ñÈÉ®„É™„ÇΩ„Éº„Çπ„ÇíË≠òÂà•
      isActive: historyItem.isActive || false, // ÁèæÂú®ÂÖ¨Èñã‰∏≠„Åã„Å©„ÅÜ„Åã
      displayMode: historyItem.displayMode || 'ÈÄöÂ∏∏Ë°®Á§∫',
      countDisplay: historyItem.countDisplay || 'Ë°®Á§∫',
      status: historyItem.status || 'published',
      
      // AIÂàóÂà§ÂÆöÁµêÊûú„ÅÆ‰øùÂ≠òÔºàÂæ©ÂÖÉÊôÇ„Å´ÂøÖË¶ÅÔºâ
      sheetDetails: {
        allHeaders: currentStatus?.sheetDetails?.allHeaders || [],
        guessedConfig: currentStatus?.sheetDetails?.guessedConfig || {},
        existingConfig: currentStatus?.sheetDetails?.existingConfig || {}
      },
      
      // Âæ©ÂÖÉ„Å´ÂøÖË¶Å„Å™ËøΩÂä†ÊÉÖÂ†±
      activeSheetName: currentStatus?.activeSheetName || historyItem.sheetName,
      spreadsheetId: currentStatus?.userInfo?.spreadsheetId || '',
      
      // ‰øùÂ≠òÊôÇÁÇπ„Åß„ÅÆË®≠ÂÆöÂÆå‰∫ÜÁä∂ÊÖã
      configurationComplete: !!(currentStatus?.sheetDetails?.guessedConfig?.opinionHeader)
    };
    
    history.unshift(newItem);
    
    // ÊúÄÂ§ßÊï∞„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÅØÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§
    if (history.length > MAX_HISTORY_ITEMS) {
      history.splice(MAX_HISTORY_ITEMS);
    }
    
    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
    logDebug('Enhanced history saved:', newItem);
    
    // „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„Å´ÂêåÊúüÔºàÈùûÂêåÊúü„ÄÅ„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
    syncHistoryToServer(newItem).then(result => {
      if (result.status === 'error') {
        logWarn('Server sync failed after retries:', result.message);
        // „Çµ„Éº„Éê„ÉºÂêåÊúüÂ§±Êïó„Çí„É¶„Éº„Ç∂„Éº„Å´ÈÄöÁü•Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
        if (typeof showMessage === 'function' && result.retryCount > 2) {
          showMessage('‚ö†Ô∏è „Çµ„Éº„Éê„Éº„Å∏„ÅÆÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„Åå„ÄÅ„É≠„Éº„Ç´„É´„Å´„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü', 'warning');
        }
      } else {
        logDebug('Server sync completed successfully');
      }
    }).catch(error => {
      logError('Unexpected error in server sync:', error);
    });
    
    // UI „ÇíÊõ¥Êñ∞
    loadSimpleHistoryTable();
    
  } catch (error) {
    logWarn('Failed to save history:', error);
  }
}

/**
 * Â±•Ê≠¥„Çí„Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„Å´ÂêåÊúü
 * @param {Object} historyItem - ÂêåÊúü„Åô„ÇãÂ±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†
 */
async function syncHistoryToServer(historyItem, retryCount = 0) {
  const MAX_RETRIES = 1; // 2‚Üí1„Å´ÂâäÊ∏õ„Åß„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂêë‰∏ä
  
  try {
    if (!historyItem || !historyItem.id) {
      logWarn('Invalid history item for server sync:', historyItem);
      return { status: 'error', message: 'Invalid history item' };
    }
    
    logDebug('Syncing history to server (attempt ' + (retryCount + 1) + '):', historyItem.questionText);
    
    // ËªΩÈáè„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åß„Çµ„Éº„Éê„ÉºÂêåÊúü„ÇíÂÆüË°å  
    const timeoutPromise = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('Server sync timeout')), 15000); // 30s‚Üí15s„Å´Áü≠Á∏Æ
    });
    
    const syncPromise = runGasWithUserId('saveHistoryToSheetAPI', false, historyItem);
    const response = await Promise.race([syncPromise, timeoutPromise]);
    
    if (response && response.status === 'success') {
      logDebug('History synced to server successfully');
      return { status: 'success', message: 'Server sync completed' };
    } else {
      const errorMsg = response?.message || 'Unknown server error';
      logWarn('Server history sync failed:', errorMsg);
      
      // „É™„Éà„É©„Ç§„É≠„Ç∏„ÉÉ„ÇØ
      if (retryCount < MAX_RETRIES) {
        logDebug('Retrying server sync in 2 seconds...');
        await new Promise(resolve => setTimeout(resolve, 2000));
        return await syncHistoryToServer(historyItem, retryCount + 1);
      }
      
      return { status: 'error', message: errorMsg, retryCount: retryCount + 1 };
    }
  } catch (error) {
    const errorMsg = error.message || 'Server sync failed';
    logWarn('Failed to sync history to server:', errorMsg);
    
    // „É™„Éà„É©„Ç§„É≠„Ç∏„ÉÉ„ÇØ
    if (retryCount < MAX_RETRIES && !errorMsg.includes('timeout')) {
      logDebug('Retrying server sync due to error in 2 seconds...');
      await new Promise(resolve => setTimeout(resolve, 2000));
      return await syncHistoryToServer(historyItem, retryCount + 1);
    }
    
    return { status: 'error', message: errorMsg, retryCount: retryCount + 1 };
  }
}

/**
 * Â±•Ê≠¥„Çí localStorage „Åã„ÇâÂèñÂæó
 * @returns {Array} Â±•Ê≠¥ÈÖçÂàó
 */
function getHistoryFromStorage() {
  try {
    const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
    return historyJson ? JSON.parse(historyJson) : [];
  } catch (error) {
    logWarn('Failed to parse history from storage:', error);
    return [];
  }
}

/**
 * „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„Å®„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆÂ±•Ê≠¥„ÇíÁµ±Âêà
 * @returns {Promise<Array>} Áµ±Âêà„Åï„Çå„ÅüÂ±•Ê≠¥ÈÖçÂàó
 */
async function getMergedHistory() {
  try {
    // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÂèñÂæóÔºàÊ§úË®º‰ªò„ÅçÔºâ
    let localHistory = [];
    try {
      localHistory = getHistoryFromStorage();
      if (!Array.isArray(localHistory)) {
        logWarn('Local history is not an array, resetting to empty');
        localHistory = [];
      }
    } catch (localError) {
      logWarn('Failed to load local history:', localError);
      localHistory = [];
    }
    
    // „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„Åã„ÇâÂèñÂæóÔºà„Çø„Ç§„É†„Ç¢„Ç¶„Éà‰ªò„ÅçÔºâ
    let serverHistory = [];
    try {
      logDebug('Loading server history...');
      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Server history timeout')), 8000); // 15s‚Üí8s„Å´Áü≠Á∏Æ
      });
      
      const historyPromise = runGasWithUserId('getHistoryFromServerAPI', false);
      const response = await Promise.race([historyPromise, timeoutPromise]);
      
      if (response && response.status === 'success') {
        if (Array.isArray(response.historyArray)) {
          serverHistory = response.historyArray.filter(item => item?.id); // ËªΩÈáèÊ§úË®º
          if (serverHistory.length > 0) logDebug('Server history loaded:', serverHistory.length, 'items');
        } else {
          logWarn('Server response historyArray is not an array');
        }
      } else {
        logWarn('Server history response failed:', response?.message || 'Unknown error');
      }
    } catch (serverError) {
      if (serverError.message.includes('timeout')) {
        logWarn('Server history request timed out, using local only');
      } else {
        logWarn('Failed to load server history:', serverError.message);
      }
    }
    
    // ËªΩÈáèÁµ±ÂêàÂá¶ÁêÜÔºöIDÈáçË§á„ÇíÈô§Âéª
    const mergedMap = new Map();
    let totalItems = 0;
    
    // „É≠„Éº„Ç´„É´Â±•Ê≠¥„ÇíËøΩÂä†ÔºàËªΩÈáèÊ§úË®ºÔºâ
    for (const item of localHistory) {
      if (item?.id) {
        mergedMap.set(item.id, { ...item, source: 'local' });
        totalItems++;
      }
    }
    
    // „Çµ„Éº„Éê„ÉºÂ±•Ê≠¥„ÇíËøΩÂä†Ôºà„Çµ„Éº„Éê„ÉºÂÅ¥ÂÑ™ÂÖàÔºâ
    for (const item of serverHistory) {
      if (item?.id) {
        mergedMap.set(item.id, { ...item, source: 'server' });
        totalItems++;
      }
    }
    
    // ËªΩÈáè„ÇΩ„Éº„ÉàÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞Á∞°Áï•ÂåñÔºâ
    const mergedArray = Array.from(mergedMap.values()).sort((a, b) => {
      const aTime = new Date(a.timestamp || a.publishedAt || a.createdAt || 0).getTime();
      const bTime = new Date(b.timestamp || b.publishedAt || b.createdAt || 0).getTime();
      return bTime - aTime; // ÈôçÈ†Ü
    });
    
    if (mergedArray.length > 0) {
      logDebug(`History merged: ${mergedArray.length} items (${localHistory.length} local, ${serverHistory.length} server)`);
    }
    
    return mergedArray;
  } catch (error) {
    logError('Critical error in getMergedHistory:', error);
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºö„É≠„Éº„Ç´„É´„ÅÆ„ÅøÔºà„Åï„Çâ„Å´ÂÆâÂÖ®„Å´Ôºâ
    try {
      const fallbackHistory = getHistoryFromStorage();
      logDebug('Using fallback local history:', fallbackHistory.length, 'items');
      return Array.isArray(fallbackHistory) ? fallbackHistory : [];
    } catch (fallbackError) {
      logError('Even fallback failed:', fallbackError);
      return [];
    }
  }
}

/**
 * Â±•Ê≠¥Áî®„ÅÆ„É¶„Éã„Éº„ÇØID„ÇíÁîüÊàê
 * @returns {string} „É¶„Éã„Éº„ÇØID
 */
function generateHistoryId() {
  return 'history_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

/**
 * Draft session storage management functions
 */

// Draft session storage key
const DRAFT_SESSION_KEY = 'answerboard_draft_state';

/**
 * Save draft state to session storage
 * @param {Object} draftData - Draft form data
 */
function saveDraftToSession(draftData) {
  try {
    if (!draftData || !draftData.questionText) {
      logWarn('Invalid draft data, skipping session save');
      return;
    }

    // Create unique form identifier
    const formId = `${currentStatus?.userInfo?.spreadsheetId || 'unknown'}_${draftData.sheetName || selectedSheet || 'unknown'}`;
    
    const draftState = {
      formId,
      createdAt: new Date().toISOString(),
      questionText: draftData.questionText,
      sheetName: draftData.sheetName || selectedSheet,
      config: draftData.config || {},
      displayMode: draftData.displayMode || 'ÈÄöÂ∏∏Ë°®Á§∫', // ÈÄöÂ∏∏Ë°®Á§∫ or ÂåøÂêçË°®Á§∫
      countDisplay: draftData.countDisplay || 'Ë°®Á§∫', // Ë°®Á§∫ or ÈùûË°®Á§∫
      
      // AI column prediction results for recovery
      sheetDetails: {
        allHeaders: currentStatus?.sheetDetails?.allHeaders || [],
        guessedConfig: currentStatus?.sheetDetails?.guessedConfig || {},
        existingConfig: currentStatus?.sheetDetails?.existingConfig || {}
      },
      
      // Form configuration state
      spreadsheetId: currentStatus?.userInfo?.spreadsheetId || '',
      configurationComplete: !!(currentStatus?.sheetDetails?.guessedConfig?.opinionHeader),
      
      // Timestamp for draft management
      lastUpdated: new Date().toISOString()
    };
    
    sessionStorage.setItem(DRAFT_SESSION_KEY, JSON.stringify(draftState));
    logDebug('Draft saved to session storage:', draftState.questionText);
    
  } catch (error) {
    logWarn('Failed to save draft to session:', error);
  }
}

/**
 * Get draft state from session storage
 * @returns {Object|null} Draft state or null if not found
 */
function getDraftFromSession() {
  try {
    const draftJson = sessionStorage.getItem(DRAFT_SESSION_KEY);
    if (!draftJson) return null;
    
    const draftState = JSON.parse(draftJson);
    logDebug('Draft loaded from session storage:', draftState.questionText);
    return draftState;
    
  } catch (error) {
    logWarn('Failed to load draft from session:', error);
    return null;
  }
}

/**
 * Clear draft from session storage
 */
function clearDraftFromSession() {
  try {
    sessionStorage.removeItem(DRAFT_SESSION_KEY);
    logDebug('Draft cleared from session storage');
  } catch (error) {
    logWarn('Failed to clear draft from session:', error);
  }
}

/**
 * Check if draft exists in session storage
 * @returns {boolean} True if draft exists
 */
function hasDraftInSession() {
  try {
    return !!sessionStorage.getItem(DRAFT_SESSION_KEY);
  } catch (error) {
    logWarn('Failed to check draft in session:', error);
    return false;
  }
}

/**
 * Recover draft state from session storage on page load
 * @returns {Promise<boolean>} True if draft was recovered successfully
 */
async function recoverDraftFromSession() {
  try {
    const draftState = getDraftFromSession();
    if (!draftState) {
      logDebug('No draft found in session storage');
      return false;
    }
    
    logDebug('Attempting to recover draft from session:', draftState.questionText);
    
    // Show recovery notification
    showMessage('‰∏ãÊõ∏„Åç„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...', 'info');
    
    // Restore basic form state
    if (draftState.sheetName) {
      selectedSheet = draftState.sheetName;
      const sheetSelect = document.getElementById('sheet-select');
      if (sheetSelect) {
        sheetSelect.value = draftState.sheetName;
      }
    }
    
    // Restore spreadsheet ID if available
    if (draftState.spreadsheetId && currentStatus?.userInfo) {
      currentStatus.userInfo.spreadsheetId = draftState.spreadsheetId;
    }
    
    // Restore sheet details and AI prediction results
    if (draftState.sheetDetails && currentStatus) {
      if (!currentStatus.sheetDetails) {
        currentStatus.sheetDetails = {};
      }
      
      currentStatus.sheetDetails.allHeaders = draftState.sheetDetails.allHeaders || [];
      currentStatus.sheetDetails.guessedConfig = draftState.sheetDetails.guessedConfig || {};
      currentStatus.sheetDetails.existingConfig = draftState.sheetDetails.existingConfig || {};
    }
    
    // Restore question text
    const questionInput = document.getElementById('question-input');
    if (questionInput && draftState.questionText) {
      questionInput.value = draftState.questionText;
    }
    
    // Restore display mode settings
    const anonymousCheckbox = document.getElementById('anonymous-mode');
    if (anonymousCheckbox) {
      anonymousCheckbox.checked = draftState.displayMode === 'ÂåøÂêçË°®Á§∫';
    }
    
    // Update UI to reflect recovered state
    if (draftState.configurationComplete) {
      // Show that AI column prediction is completed
      const currentStep = document.querySelector('[data-step="4"]');
      if (currentStep) {
        updateStepProgress(4, currentStatus);
      }
    }
    
    // Update any config panels if they exist
    if (draftState.config && Object.keys(draftState.config).length > 0) {
      updateConfigPanelUI(draftState.config);
    }
    
    // Show success message
    const ageMinutes = Math.floor((new Date() - new Date(draftState.createdAt)) / (1000 * 60));
    const ageText = ageMinutes < 1 ? 'Áõ¥Ââç' : `${ageMinutes}ÂàÜÂâç`;
    showMessage(`‰∏ãÊõ∏„Åç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºà${ageText}„Å´‰ΩúÊàêÔºâ`, 'success');
    
    logDebug('Draft recovered successfully from session storage');
    return true;
    
  } catch (error) {
    logError('Failed to recover draft from session:', error);
    showMessage('‰∏ãÊõ∏„Åç„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return false;
  }
}

/**
 * Update config panel UI with recovered settings
 * @param {Object} config - Configuration object
 */
function updateConfigPanelUI(config) {
  try {
    // Update opinion header if available
    if (config.opinionHeader) {
      const opinionSelect = document.getElementById('opinion-header-select');
      if (opinionSelect) {
        opinionSelect.value = config.opinionHeader;
      }
    }
    
    // Update name header if available
    if (config.nameHeader) {
      const nameSelect = document.getElementById('name-header-select');
      if (nameSelect) {
        nameSelect.value = config.nameHeader;
      }
    }
    
    // Update reaction settings if available
    if (config.allowReactions !== undefined) {
      const reactionCheckbox = document.getElementById('allow-reactions');
      if (reactionCheckbox) {
        reactionCheckbox.checked = !!config.allowReactions;
      }
    }
    
    logDebug('Config panel UI updated with recovered settings');
    
  } catch (error) {
    logWarn('Failed to update config panel UI:', error);
  }
}

// ÊóßÊù•„ÅÆ„Ç´„Éº„ÉâÂΩ¢Âºè„ÅÆÂ±•Ê≠¥Ë°®Á§∫„ÅØÂâäÈô§ - Á∞°Âçò„Å™„ÉÜ„Éº„Éñ„É´ÂΩ¢Âºè„ÅÆ„Åø‰ΩøÁî®

/**
 * Á∞°Âçò„Å™Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´„ÇíË°®Á§∫ÔºàÊñ∞ÂÆüË£ÖÔºâ
 */

async function loadSimpleHistoryTable() {
  const tableBody = document.getElementById('history-table-body');
  
  if (!tableBody) {
    logWarn('History table body not found');
    return;
  }
  
  try {
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ÔºàÊîπÂñÑ„Åï„Çå„Åü„Çπ„Çø„Ç§„É´Ôºâ
    tableBody.innerHTML = `
      <tr>
        <td colspan="4" class="px-3 py-6 text-center text-gray-500 text-sm">
          <div class="flex flex-col items-center justify-center">
            <div class="spinner mb-3"></div>
            <div>Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
            <div class="text-xs text-gray-600 mt-1">„É≠„Éº„Ç´„É´„Å®„Çµ„Éº„Éê„Éº„ÅÆÂ±•Ê≠¥„ÇíÁµ±Âêà„Åó„Å¶„ÅÑ„Åæ„Åô</div>
          </div>
        </td>
      </tr>
    `;
    
    // „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„Å®„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆÂ±•Ê≠¥„ÇíÂèñÂæó„ÉªÁµ±Âêà
    const mergedHistory = await getMergedHistory();
    
    // „ÉÜ„Éº„Éñ„É´„Çí„ÇØ„É™„Ç¢
    tableBody.innerHTML = '';
    
    if (!Array.isArray(mergedHistory) || mergedHistory.length === 0) {
      // Â±•Ê≠¥„ÅåÁ©∫„ÅÆÂ†¥ÂêàÔºàÊîπÂñÑ„Åï„Çå„Åü„É°„ÉÉ„Çª„Éº„Ç∏Ôºâ
      const emptyRow = document.createElement('tr');
      emptyRow.innerHTML = `
        <td colspan="4" class="px-3 py-8 text-center text-gray-500 text-sm">
          <div class="flex flex-col items-center">
            <div class="text-4xl mb-2">üìù</div>
            <div class="font-medium mb-1">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
            <div class="text-xs text-gray-600">„Éï„Ç©„Éº„É†„ÇíÂÖ¨Èñã„Åô„Çã„Å®Â±•Ê≠¥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
          </div>
        </td>
      `;
      tableBody.appendChild(emptyRow);
      return;
    }
    
    // Â±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†„Çí„ÉÜ„Éº„Éñ„É´Ë°å„Å®„Åó„Å¶Ë°®Á§∫Ôºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
    let successCount = 0;
    let errorCount = 0;
    
    mergedHistory.forEach((item, index) => {
      try {
        if (!item || !item.id) {
          logWarn('Invalid history item at index', index, item);
          errorCount++;
          return;
        }
        
        const row = createHistoryTableRow(item, index);
        if (row) {
          tableBody.appendChild(row);
          successCount++;
        } else {
          errorCount++;
        }
      } catch (rowError) {
        logWarn('Failed to create row for history item at index', index, rowError);
        errorCount++;
      }
    });
    
    // Áµ±Ë®àÊÉÖÂ†±„Çí„É≠„Ç∞„Å´Âá∫Âäõ
    logDebug(`History table loaded: ${successCount} success, ${errorCount} errors`);
    
    if (errorCount > 0) {
      showMessage(`‚ö†Ô∏è ‰∏ÄÈÉ®„ÅÆÂ±•Ê≠¥È†ÖÁõÆÔºà${errorCount}‰ª∂Ôºâ„ÅÆË°®Á§∫„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åó„Åü`, 'warning');
    }
    
    logDebug('History table loaded with', mergedHistory.length, 'items');
  } catch (error) {
    logError('Failed to load history table:', error);
    
    // „Ç®„É©„ÉºÊôÇ„ÅØ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆ„Åø‰ΩøÁî®
    const localHistory = getHistoryFromStorage();
    tableBody.innerHTML = '';
    
    if (localHistory.length === 0) {
      const emptyRow = document.createElement('tr');
      emptyRow.innerHTML = `
        <td colspan="4" class="px-3 py-4 text-center text-gray-500 text-sm">
          Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü
        </td>
      `;
      tableBody.appendChild(emptyRow);
    } else {
      localHistory.forEach((item, index) => {
        const row = createHistoryTableRow(item, index);
        tableBody.appendChild(row);
      });
    }
  }
}

/**
 * Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´Ë°å„Çí‰ΩúÊàê
 * @param {Object} item - Â±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†
 * @param {number} index - „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
 * @returns {HTMLElement} „ÉÜ„Éº„Éñ„É´Ë°åË¶ÅÁ¥†
 */
function createHistoryTableRow(item, index) {
  const row = document.createElement('tr');
  
  // ÂÖ¨Èñã‰∏≠„ÅÆÈ†ÖÁõÆ„ÅØÁ∑ëËâ≤„ÅÆ„Éè„Ç§„É©„Ç§„Éà
  const isActive = !!item.isActive;
  row.className = isActive 
    ? 'hover:bg-green-700/20 cursor-pointer transition-colors bg-green-900/10' 
    : 'hover:bg-gray-700/30 cursor-pointer transition-colors';
  
  row.onclick = () => selectHistoryItem(item.id);
  
  const formatDateTime = (dateString) => {
    if (!dateString) return '<span class="text-gray-500 text-xs">Êú™Ë®≠ÂÆö</span>';
    
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) {
        return '<span class="text-red-400 text-xs">ÁÑ°Âäπ„Å™Êó•‰ªò</span>';
      }
      
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      
      let relativeTime = '';
      if (diffDays > 7) {
        // 1ÈÄ±Èñì‰ª•‰∏äÂâç„ÅØÈÄöÂ∏∏„ÅÆÊó•‰ªòË°®Á§∫
        relativeTime = date.toLocaleString('ja-JP', {
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } else if (diffDays > 0) {
        relativeTime = `${diffDays}Êó•Ââç`;
      } else if (diffHours > 0) {
        relativeTime = `${diffHours}ÊôÇÈñìÂâç`;
      } else if (diffMinutes > 0) {
        relativeTime = `${diffMinutes}ÂàÜÂâç`;
      } else {
        relativeTime = '„Åü„Å£„Åü‰ªä';
      }
      
      const fullDate = date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        weekday: 'short'
      });
      
      return `<span class="text-xs" title="${fullDate}">${relativeTime}</span>`;
    } catch (error) {
      return '<span class="text-red-400 text-xs">Êó•‰ªò„Ç®„É©„Éº</span>';
    }
  };
  
  // ÂõûÁ≠îÂΩ¢Âºè„ÅÆË°®Á§∫„É≠„Ç∏„ÉÉ„ÇØÔºàÊîπÂñÑÁâàÔºâ
  const getAnswerFormatDisplay = (item) => {
    // 1. QuickStart„ÅÆÂ†¥Âêà„ÅØÁ¢∫ÂÆü„Å´„ÉÜ„Ç≠„Çπ„Éà„Å®Âà§ÂÆö
    if (item.setupType === 'quickstart') {
      return `<span class="text-green-400">„ÉÜ„Ç≠„Çπ„Éà</span>`;
    }
    
    // 2. setupType „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
    if (item.setupType) {
      switch (item.setupType) {
        case 'external':
          return `<span class="text-orange-400">Â§ñÈÉ®</span>`;
        case 'custom':
          // „Ç´„Çπ„Çø„É†„ÅÆÂ†¥Âêà„ÅØË©≥Á¥∞Ë®≠ÂÆö„ÇíÁ¢∫Ë™çÔºà‰∏ãË®ò„ÅÆÂà§ÂÆö„Å´ÈÄ≤„ÇÄÔºâ
          break;
      }
    }
    
    const config = item.config;
    if (!config) {
      // config„Åå„Å™„ÅÑÂ†¥Âêà„ÇÇ„ÉÜ„Ç≠„Çπ„Éà„Å®„Åó„Å¶Êâ±„ÅÜÔºà"‰∏çÊòé"„ÇíË°®Á§∫„Åó„Å™„ÅÑÔºâ
      return `<span class="text-green-400">„ÉÜ„Ç≠„Çπ„Éà</span>`;
    }
    
    // 3. „Éï„Ç©„Éº„É†Ë®≠ÂÆö„Åã„ÇâÂà§ÂÆö
    // Ë§áÊï∞ÈÅ∏ÊäûÔºàcheckboxÔºâ„ÅÆÂà§ÂÆö
    if (config.multipleChoice || 
        config.allowMultipleAnswers || 
        (config.formElements && config.formElements.some(elem => elem.type === 'checkbox'))) {
      return `<span class="text-purple-400">Ë§áÊï∞</span>`;
    }
    
    // Âçò‰∏ÄÈÅ∏ÊäûÔºàradio/selectÔºâ„ÅÆÂà§ÂÆö
    if (config.singleChoice || 
        config.choices || 
        config.options ||
        (config.formElements && config.formElements.some(elem => elem.type === 'radio' || elem.type === 'select'))) {
      return `<span class="text-blue-400">ÈÅ∏Êäû</span>`;
    }
    
    // 4. Ë≥™ÂïèÊñá„ÅÆÂÜÖÂÆπ„Åã„ÇâÊé®Ê∏¨ÔºàAI„ÅåÊé®Ê∏¨„Åó„ÅüÂÜÖÂÆπÔºâ
    const questionText = item.questionText || '';
    if (questionText.includes('ÈÅ∏Êäû') || questionText.includes('„Å©„Çå')) {
      if (questionText.includes('Ë§áÊï∞') || questionText.includes('„ÅÑ„Åè„Å§')) {
        return `<span class="text-purple-400">Ë§áÊï∞</span>`;
      } else {
        return `<span class="text-blue-400">ÈÅ∏Êäû</span>`;
      }
    }
    
    // 5. „Éá„Éï„Ç©„É´„ÉàÔºö„ÉÜ„Ç≠„Çπ„ÉàÔºàËá™Áî±Ë®òËø∞Ôºâ
    return `<span class="text-green-400">„ÉÜ„Ç≠„Çπ„Éà</span>`;
  };
  
  // Visual indicators for display options
  const getDisplayModeIcon = (displayMode) => {
    return displayMode === 'ÂåøÂêçË°®Á§∫' ? 'üé≠' : 'üë•';
  };
  
  const getCountDisplayIcon = (countDisplay) => {
    return countDisplay === 'ÈùûË°®Á§∫' ? 'üö´' : 'üìä';
  };
  
  const getStatusIcon = (status, isActive) => {
    if (isActive && status === 'published') return 'üåê';
    if (status === 'ended') return '‚èπÔ∏è';
    if (status === 'draft') return 'üìù';
    return 'üåê'; // default for published
  };
  
  // Helper functions for tooltip text descriptions
  const getStatusText = (status, isActive) => {
    if (isActive && status === 'published') return 'ÂÖ¨Èñã‰∏≠';
    if (status === 'ended') return 'ÁµÇ‰∫Ü';
    if (status === 'draft') return '‰∏ãÊõ∏„Åç';
    return 'ÂÖ¨ÈñãÊ∏à„Åø';
  };

  const getDisplayModeText = (displayMode) => {
    return displayMode === 'ÂåøÂêçË°®Á§∫' ? 'ÂåøÂêçË°®Á§∫' : 'ÈÄöÂ∏∏Ë°®Á§∫';
  };

  const getCountDisplayText = (countDisplay) => {
    return countDisplay === 'ÈùûË°®Á§∫' ? '„Ç´„Ç¶„É≥„ÉàÈùûË°®Á§∫' : '„Ç´„Ç¶„É≥„ÉàË°®Á§∫';
  };
  
  // Format display mode and count display as compact visual indicators
  const displayMode = item.displayMode || item.config?.displayMode || 'ÈÄöÂ∏∏Ë°®Á§∫';
  const countDisplay = item.countDisplay || item.config?.countDisplay || 'Ë°®Á§∫';
  const status = item.status || item.config?.status || 'published';
  const displayModeIcon = getDisplayModeIcon(displayMode);
  const countDisplayIcon = getCountDisplayIcon(countDisplay);
  const statusIcon = getStatusIcon(status, isActive);
  
  // Combine visual indicators
  const visualIndicators = `${statusIcon} ${displayModeIcon} ${countDisplayIcon}`;

  // Enhanced question text display with truncation
  const questionText = item.questionText || 'ÔºàË≥™ÂïèÊñáÊú™Ë®≠ÂÆöÔºâ';
  const displayQuestionText = questionText.length > 40 
    ? questionText.substring(0, 40) + '...' 
    : questionText;
  
  // Sheet name display (if available)
  const sheetName = item.sheetName || '';
  const sheetDisplay = sheetName ? `<div class="text-xs text-gray-500 mt-1">üìä ${escapeHtml(sheetName)}</div>` : '';
  
  // Create detailed tooltip text with better formatting
  const tooltipText = `Ë≥™Âïè: ${escapeHtml(questionText)}
Áä∂ÊÖã: ${getStatusText(status, isActive)}
Ë°®Á§∫: ${getDisplayModeText(displayMode)}
„Ç´„Ç¶„É≥„Éà: ${getCountDisplayText(countDisplay)}
„Ç∑„Éº„Éà: ${sheetName || 'Êú™Ë®≠ÂÆö'}
‰ΩúÊàê: ${item.createdAt ? new Date(item.createdAt).toLocaleString('ja-JP') : '‰∏çÊòé'}
ÂÖ¨Èñã: ${item.publishedAt ? new Date(item.publishedAt).toLocaleString('ja-JP') : 'Êú™ÂÖ¨Èñã'}`;

  row.innerHTML = `
    <td class="px-3 py-2 text-xs text-gray-300">${formatDateTime(item.createdAt || item.timestamp)}</td>
    <td class="px-3 py-2 text-xs text-gray-300">${formatDateTime(item.publishedAt)}</td>
    <td class="px-3 py-2 text-xs text-gray-300" title="${escapeHtml(tooltipText)}" style="max-width: 250px;">
      <div class="flex items-start gap-2">
        <div class="flex-1 min-w-0">
          <div class="truncate leading-tight">${escapeHtml(displayQuestionText)}</div>
          ${sheetDisplay}
        </div>
        <div class="text-xs opacity-75 flex-shrink-0 flex gap-1">
          <span title="Áä∂ÊÖã: ${getStatusText(status, isActive)}">${statusIcon}</span>
          <span title="Ë°®Á§∫„É¢„Éº„Éâ: ${getDisplayModeText(displayMode)}">${displayModeIcon}</span>
          <span title="„Ç´„Ç¶„É≥„ÉàË°®Á§∫: ${getCountDisplayText(countDisplay)}">${countDisplayIcon}</span>
        </div>
      </div>
    </td>
    <td class="px-3 py-2 text-xs text-center">${getAnswerFormatDisplay(item)}</td>
  `;
  
  return row;
}

/**
 * Â±•Ê≠¥ÈÅ∏ÊäûÊôÇ„ÅÆËá™Âãï„Éï„É≠„ÉºÂá¶ÁêÜ
 * @param {string} historyId - Â±•Ê≠¥ID
 */
async function selectHistoryItem(historyId) {
  try {
    // Áµ±ÂêàÂ±•Ê≠¥„Åã„ÇâÊ§úÁ¥¢Ôºà„É≠„Éº„Ç´„É´ + „Çµ„Éº„Éê„ÉºÔºâ
    const mergedHistory = await getMergedHistory();
    const item = mergedHistory.find(h => h.id === historyId);
    
    if (!item) {
      showMessage('Â±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü', 'error');
      return;
    }
    
    // Âæ©ÂÖÉ„Éó„É≠„Çª„ÇπÈñãÂßã„ÅÆÈÄöÁü•„Å®ÈÄ≤ÊçóË°®Á§∫
    const progressSteps = [
      'üîç Â±•Ê≠¥„Éá„Éº„Çø„ÇíËß£Êûê‰∏≠...',
      'üìä AIÂàóÂà§ÂÆöÁµêÊûú„ÇíË™≠„ÅøËæº„Åø‰∏≠...',
      '‚öôÔ∏è Ë®≠ÂÆö„ÇíÈÅ©Áî®‰∏≠...',
      '‚úÖ Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü'
    ];
    
    let currentStep = 0;
    const showProgress = (message) => {
      showMessage(message, 'info', 2000);
    };
    
    showProgress(progressSteps[currentStep++]);
    
    // 1. „Ç∑„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíË®≠ÂÆö
    if (item.sheetName && item.spreadsheetId) {
      selectedSheet = item.sheetName;
      
      // currentStatus „Å´„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíË®≠ÂÆö
      if (!currentStatus) {
        currentStatus = {};
      }
      if (!currentStatus.userInfo) {
        currentStatus.userInfo = {};
      }
      currentStatus.userInfo.spreadsheetId = item.spreadsheetId;
      currentStatus.activeSheetName = item.activeSheetName || item.sheetName;
      
      // sheet select UI „ÇíÊõ¥Êñ∞
      const sheetSelect = document.getElementById('sheet-select');
      if (sheetSelect) {
        sheetSelect.value = item.sheetName;
      }
    }
    
    // 2. AIÂàóÂà§ÂÆöÁµêÊûú„ÇíÂæ©ÂÖÉÔºàPromiseÂåñ„ÅßÁ¢∫ÂÆüÊÄßÂêë‰∏äÔºâ
    await new Promise(resolve => {
      setTimeout(() => {
        showProgress(progressSteps[currentStep++]); // AIÂàóÂà§ÂÆöÁµêÊûú„ÇíÂæ©ÂÖÉ‰∏≠...
        
        if (item.sheetDetails) {
          if (!window.currentStatus) window.currentStatus = {};
          window.currentStatus.sheetDetails = {
            allHeaders: item.sheetDetails.allHeaders || [],
            guessedConfig: item.sheetDetails.guessedConfig || {},
            existingConfig: item.sheetDetails.existingConfig || {}
          };
          
          logDebug('Restored AI column prediction results:', window.currentStatus.sheetDetails);
          
          // 3. „Éò„ÉÉ„ÉÄ„ÉºÈÅ∏ÊäûËÇ¢„ÇíË®≠ÂÆö
          if (item.sheetDetails.allHeaders && item.sheetDetails.allHeaders.length > 0) {
            if (typeof populateHeaderOptions === 'function') {
              populateHeaderOptions(item.sheetDetails.allHeaders);
              console.log('‚úÖ Header options restored from history');
            } else {
              logWarn('populateHeaderOptions function not available');
            }
          }
          
          // 4. AIÂà§ÂÆöË®≠ÂÆö„ÇíÈÅ©Áî®
          if (item.sheetDetails.guessedConfig) {
            setTimeout(() => {
              if (typeof populateConfig === 'function') {
                populateConfig(item.sheetDetails.guessedConfig);
                console.log('‚úÖ AI configuration restored from history');
              } else {
                logWarn('populateConfig function not available');
              }
              resolve();
            }, 100);
          } else {
            resolve();
          }
        } else {
          resolve();
        }
      }, 500);
    });
    
    // 5. „Éï„Ç©„Éº„É†Ë®≠ÂÆö„ÇíÂæ©ÂÖÉÔºàÊîπÂñÑ„Åï„Çå„Åü„Çø„Ç§„Éü„É≥„Ç∞Âà∂Âæ°Ôºâ
    showProgress(progressSteps[currentStep++]); // Ë®≠ÂÆö„ÇíÈÅ©Áî®‰∏≠...
    
    if (item.config) {
      await new Promise(resolve => {
        setTimeout(() => {
          restoreConfigFromHistory(item.config);
          resolve();
        }, 200);
      });
    }
    
    // 6. UIÁä∂ÊÖã„ÇíStep 3ÔºàË®≠ÂÆöÂÆå‰∫ÜÔºâ„Å´Êõ¥Êñ∞
    const step3Section = document.getElementById('step3-content');
    if (step3Section) {
      step3Section.classList.remove('hidden');
      step3Section.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊõ¥Êñ∞
    if (typeof updateStepIndicators === 'function') {
      updateStepIndicators(3);
    }
    if (typeof manageSectionStates === 'function') {
      manageSectionStates(3);
    }
    
    // Ë®≠ÂÆö„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    if (typeof updateConfigButtons === 'function') {
      updateConfigButtons();
    }
    
    // Ë®≠ÂÆöÂÆå‰∫ÜÁä∂ÊÖã„ÇíÂèçÊò†
    if (item.configurationComplete && typeof updateUIForSelectedSheet === 'function') {
      updateUIForSelectedSheet();
    }
    
    // ÊúÄÁµÇÂÆå‰∫ÜÈÄöÁü•ÔºàÁ¢∫ÂÆü„Å™ÂÆå‰∫Ü„Çí‰øùË®ºÔºâ
    await new Promise(resolve => {
      setTimeout(() => {
        showProgress(progressSteps[currentStep++]); // Âæ©ÂÖÉÂÆå‰∫Ü
        setTimeout(() => {
          const truncatedQuestion = item.questionText && item.questionText.length > 50 
            ? item.questionText.substring(0, 50) + '...'
            : item.questionText || 'Â±•Ê≠¥È†ÖÁõÆ';
          showMessage(`„Äå${truncatedQuestion}„Äç„ÅÆË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø„Åó„Åæ„Åó„Åü`, 'success');
          resolve();
        }, 500);
      }, 300);
    });
    
  } catch (error) {
    logError('Failed to select history item:', error);
    
    // Ë©≥Á¥∞„Å™„Ç®„É©„ÉºÂàÜÊûê„Å®ÈÉ®ÂàÜÂæ©ÂÖÉ„ÅÆË©¶Ë°å
    let errorMessage = 'Â±•Ê≠¥„ÅÆÈÅ∏Êäû„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
    let partiallyRestored = false;
    
    try {
      // ÈÉ®ÂàÜÂæ©ÂÖÉ„ÇíË©¶Ë°å
      const mergedHistory = await getMergedHistory();
      const item = mergedHistory.find(h => h.id === historyId);
      
      if (item) {
        // ÊúÄ‰ΩéÈôê„ÅÆË®≠ÂÆöÂæ©ÂÖÉ„ÇíË©¶Ë°å
        if (item.sheetName) {
          selectedSheet = item.sheetName;
          const sheetSelect = document.getElementById('sheet-select');
          if (sheetSelect) {
            sheetSelect.value = item.sheetName;
          }
          partiallyRestored = true;
        }
        
        if (item.config && item.config.opinionHeader) {
          const opinionSelect = document.getElementById('opinionHeader');
          if (opinionSelect) {
            opinionSelect.innerHTML = `<option value="${item.config.opinionHeader}">${item.config.opinionHeader}</option>`;
            opinionSelect.value = item.config.opinionHeader;
            partiallyRestored = true;
          }
        }
        
        if (partiallyRestored) {
          errorMessage = `„Äå${item.questionText}„Äç„ÅÆÂü∫Êú¨Ë®≠ÂÆö„ÅÆ„ÅøË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇAIÂàóÂà§ÂÆö„ÅØÊâãÂãï„ÅßÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
          showMessage(errorMessage, 'warning');
          
          // Step 2„Å´ÁßªÂãïÔºàÊâãÂãïË®≠ÂÆö„Çí‰øÉ„ÅôÔºâ
          updateStepIndicators(2);
          manageSectionStates(2);
          return;
        }
      }
    } catch (partialError) {
      logWarn('Partial restoration also failed:', partialError);
    }
    
    // ÂÆåÂÖ®„Å™Â§±ÊïóÊôÇ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
    if (error.message.includes('not found')) {
      errorMessage = 'ÊåáÂÆö„Åï„Çå„ÅüÂ±•Ê≠¥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Çµ„Éº„Éê„Éº„Å®„ÅÆÂêåÊúü„Å´ÂïèÈ°å„Åå„ÅÇ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ';
    } else if (error.message.includes('network') || error.message.includes('timeout')) {
      errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    } else if (error.message.includes('permission')) {
      errorMessage = '„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ';
    }
    
    showMessage(errorMessage, 'error');
  }
}

/**
 * Â±•Ê≠¥„Åã„ÇâË®≠ÂÆö„ÇíÂæ©ÂÖÉ
 * @param {Object} config - Ë®≠ÂÆö„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
 */
function restoreConfigFromHistory(config) {
  try {
    logDebug('Restoring config from history:', config);
    
    // „Éï„Ç©„Éº„É†Ë®≠ÂÆö„ÅÆÂæ©ÂÖÉÔºà„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„ÅçÔºâ
    const configMappings = [
      { configKey: 'opinionHeader', elementId: 'opinionHeader', label: 'Opinion Header' },
      { configKey: 'nameHeader', elementId: 'name-column', label: 'Name Column' },
      { configKey: 'classHeader', elementId: 'class-column', label: 'Class Column' },
      { configKey: 'reasonHeader', elementId: 'reason-column', label: 'Reason Column' }
    ];
    
    configMappings.forEach(({ configKey, elementId, label }) => {
      if (config[configKey]) {
        const element = document.getElementById(elementId);
        if (element) {
          element.value = config[configKey];
          logDebug(`‚úÖ ${label} restored:`, config[configKey]);
          
          // Â§âÊõ¥„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´„Åó„Å¶Èñ¢ÈÄ£UI„ÇíÊõ¥Êñ∞
          const event = new Event('change', { bubbles: true });
          element.dispatchEvent(event);
        } else {
          logWarn(`‚ö†Ô∏è Element not found for ${label} (${elementId})`);
        }
      }
    });
    
    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂæ©ÂÖÉÔºà„Ç§„Éô„É≥„Éà‰ªò„ÅçÔºâ
    const checkboxMappings = [
      { configKey: 'showNames', elementId: 'show-names', label: 'Show Names' },
      { configKey: 'showCounts', elementId: 'show-counts', label: 'Show Counts' }
    ];
    
    checkboxMappings.forEach(({ configKey, elementId, label }) => {
      const checkbox = document.getElementById(elementId);
      if (checkbox) {
        const value = config[configKey] || false;
        checkbox.checked = value;
        logDebug(`‚úÖ ${label} restored:`, value);
        
        // Â§âÊõ¥„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´
        const event = new Event('change', { bubbles: true });
        checkbox.dispatchEvent(event);
      } else {
        logWarn(`‚ö†Ô∏è Checkbox not found for ${label} (${elementId})`);
      }
    });
    
    // ËøΩÂä†„ÅÆË®≠ÂÆöÈ†ÖÁõÆ„ÅÆÂæ©ÂÖÉ
    if (config.displayMode) {
      const displayModeElements = document.querySelectorAll('input[name="displayMode"]');
      displayModeElements.forEach(radio => {
        if (radio.value === config.displayMode) {
          radio.checked = true;
          const event = new Event('change', { bubbles: true });
          radio.dispatchEvent(event);
        }
      });
      logDebug('‚úÖ Display mode restored:', config.displayMode);
    }
    
    if (config.countDisplay) {
      const countDisplayElements = document.querySelectorAll('input[name="countDisplay"]');
      countDisplayElements.forEach(radio => {
        if (radio.value === config.countDisplay) {
          radio.checked = true;
          const event = new Event('change', { bubbles: true });
          radio.dispatchEvent(event);
        }
      });
      logDebug('‚úÖ Count display restored:', config.countDisplay);
    }
    
    // Ë®≠ÂÆö„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    if (typeof updateConfigButtons === 'function') {
      updateConfigButtons();
      logDebug('‚úÖ Config buttons updated');
    }
    
    // UIÁä∂ÊÖã„ÅÆÂº∑Âà∂Êõ¥Êñ∞
    setTimeout(() => {
      if (typeof validateConfiguration === 'function') {
        validateConfiguration();
      }
      logDebug('‚úÖ Configuration validation completed');
    }, 100);
    
  } catch (error) {
    logError('Failed to restore config from history:', error);
    showMessage('‚ö†Ô∏è Ë®≠ÂÆö„ÅÆÂæ©ÂÖÉ„Å´‰∏ÄÈÉ®Â§±Êïó„Åó„Åæ„Åó„Åü„Åå„ÄÅÂèØËÉΩ„Å™È†ÖÁõÆ„ÅØÂæ©ÂÖÉ„Åï„Çå„Åæ„Åó„Åü', 'warning');
  }
}

// createHistoryItemElementÈñ¢Êï∞„ÅØÂâäÈô§ - „ÉÜ„Éº„Éñ„É´ÂΩ¢Âºè„ÅÆcreateHistoryTableRow„Çí‰ΩøÁî®

/**
 * HTML„Ç®„Çπ„Ç±„Éº„ÉóÈñ¢Êï∞
 * @param {string} text - „Ç®„Çπ„Ç±„Éº„Éó„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà
 * @returns {string} „Ç®„Çπ„Ç±„Éº„Éó„Åï„Çå„Åü„ÉÜ„Ç≠„Çπ„Éà
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ÊóßÊù•„ÅÆË§áÈõë„Å™Â±•Ê≠¥ÁÆ°ÁêÜÈñ¢Êï∞Áæ§„ÅØÂâäÈô§ - selectHistoryItem()„Å´„Çà„ÇãËá™Âãï„Éï„É≠„Éº„ÅÆ„Åø‰ΩøÁî®

// =============================================================================
// CONFIG JSON Ê≠£Ë¶èÂåñ„Éª‰øÆÂæ©„Ç∑„Çπ„ÉÜ„É†
// =============================================================================

/**
 * configJson„ÅÆÊï¥ÂêàÊÄß„ÇíÁ¢∫‰øù„Åó„ÄÅÁüõÁõæ„Åó„ÅüÁä∂ÊÖã„Çí‰øÆÂæ©„Åô„Çã
 * @param {Object} config - ‰øÆÂæ©ÂØæË±°„ÅÆconfig
 * @param {Object} userInfo - „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±
 * @return {Object} Ê≠£Ë¶èÂåñ„Åï„Çå„Åüconfig
 */
function normalizeConfigJson(config, userInfo) {
  if (!config || typeof config !== 'object') {
    console.warn('‚ö†Ô∏è normalizeConfigJson: ÁÑ°Âäπ„Å™config„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà');
    return config;
  }
  
  // „Ç≠„É£„ÉÉ„Ç∑„É•„ÉÅ„Çß„ÉÉ„ÇØÔºàÂêå„Åò„Éá„Éº„Çø„ÅÆÈáçË§áÂá¶ÁêÜ„ÇíÈò≤Ê≠¢Ôºâ
  if (window.processCache && window.generateSimpleHash && window.isCacheValid) {
    const configHash = window.generateSimpleHash(config);
    const cacheEntry = window.processCache.configNormalization;
    
    if (window.isCacheValid(cacheEntry) && cacheEntry.dataHash === configHash) {
      console.log('üöÄ configJsonÊ≠£Ë¶èÂåñ: „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÁµêÊûú„ÇíÂèñÂæó');
      return cacheEntry.data;
    }
  }
  
  // Êú¨Áï™Áí∞Â¢É„Åß„ÅØË©≥Á¥∞„É≠„Ç∞„ÇíÂâäÊ∏õ
  if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
    console.log('üîß configJsonÊ≠£Ë¶èÂåñÈñãÂßã:', {
      setupStatus: config.setupStatus,
      setupStep: config.setupStep,
      appPublished: config.appPublished,
      publishedSheetName: config.publishedSheetName
    });
  }
  
  // Step 1: publishedSheetName‰øÆÂæ©
  config = fixPublishedSheetName(config);
  
  // Step 2: setupStepÂÜçË®àÁÆóÔºàÁµ±‰∏ÄÈñ¢Êï∞‰ΩøÁî®Ôºâ
  // Note: setupStep„ÅØË®àÁÆó„Éó„É≠„Éë„ÉÜ„Ç£„Å®„Åó„Å¶Â∏∏„Å´ÂãïÁöÑ„Å´ÁÆóÂá∫„Åï„Çå„ÄÅconfigJson„Å´„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì
  
  // Step 3: „Ç∞„É≠„Éº„Éê„É´ÂàóË®≠ÂÆöÂêåÊúü
  config = syncGlobalColumnSettings(config);
  
  // Step 4: ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆË£úÂÆå
  config = ensureRequiredFields(config);
  
  // Step 5: ÂÜóÈï∑„Éï„Ç£„Éº„É´„Éâ„ÅÆÂâäÈô§
  config = removeRedundantFields(config);
  
  // Êú¨Áï™Áí∞Â¢É„Åß„ÅØË©≥Á¥∞„É≠„Ç∞„ÇíÂâäÊ∏õ
  if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
    console.log('‚úÖ configJsonÊ≠£Ë¶èÂåñÂÆå‰∫Ü:', {
      setupStatus: config.setupStatus,
      appPublished: config.appPublished,
      publishedSheetName: config.publishedSheetName
    });
  }
  
  // „Ç≠„É£„ÉÉ„Ç∑„É•Êõ¥Êñ∞
  if (window.processCache && window.generateSimpleHash) {
    const configHash = window.generateSimpleHash(config);
    const cacheEntry = window.processCache.configNormalization;
    cacheEntry.data = config;
    cacheEntry.dataHash = configHash;
    cacheEntry.timestamp = Date.now();
  }
  
  return config;
}

/**
 * ÂÜóÈï∑„Éï„Ç£„Éº„É´„Éâ„ÅÆÂâäÈô§Ôºà„Éá„Éº„ÇøÊï¥ÂêàÊÄßÂêë‰∏äÔºâ
 * @param {Object} config - ÂØæË±°config
 * @return {Object} „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Åï„Çå„Åüconfig
 */
function removeRedundantFields(config) {
  const cleanConfig = { ...config };
  
  // setupStep„ÅØË®àÁÆó„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆ„Åü„ÇÅ„ÄÅ‰øùÂ≠òÊ∏à„Åø„ÅÆÂÄ§„ÇíÂâäÈô§
  delete cleanConfig.setupStep;
  
  console.log('üßπ ÂÜóÈï∑„Éï„Ç£„Éº„É´„ÉâÂâäÈô§: setupStep');
  
  return cleanConfig;
}

/**
 * ConfigJson„ÅÆÊï¥ÂêàÊÄßÊ§úË®ºÊ©üËÉΩÔºà„Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÂ∞ÇÁî®Ôºâ
 * @param {Object} config - Ê§úË®ºÂØæË±°„ÅÆconfig
 * @param {Object} userInfo - „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±
 */
function validateConfigJsonIntegrity(config, userInfo) {
  if (!config || !userInfo) {
    console.warn('‚ö†Ô∏è Êï¥ÂêàÊÄßÊ§úË®º: ÁÑ°Âäπ„Å™„Éë„É©„É°„Éº„Çø');
    return;
  }
  
  const setupStatus = config.setupStatus || 'pending';
  const formCreated = !!config.formCreated;
  const appPublished = !!config.appPublished;
  const hasFormUrl = !!(config.formUrl && config.formUrl.trim());
  const hasPublishedSheet = !!(config.publishedSheetName && config.publishedSheetName.trim());
  const hasSpreadsheet = !!(userInfo.spreadsheetId && userInfo.spreadsheetId.trim());
  
  console.group('üîç ConfigJsonÊï¥ÂêàÊÄßÊ§úË®º');
  
  // Âü∫Êú¨Áä∂ÊÖã„ÅÆË°®Á§∫
  console.log('üìä ÁèæÂú®„ÅÆÁä∂ÊÖã:', {
    setupStatus,
    formCreated,
    appPublished,
    hasFormUrl,
    hasPublishedSheet,
    hasSpreadsheet
  });
  
  // ÈáçË¶Å„Å™‰∏çÊï¥Âêà„ÇíÊ§úÂá∫
  const issues = [];
  
  if (setupStatus === 'completed' && !formCreated) {
    issues.push('‚ùå setupStatus=completed„Å™„ÅÆ„Å´formCreated=false');
  }
  
  if (formCreated && !hasFormUrl) {
    issues.push('‚ùå formCreated=true„Å™„ÅÆ„Å´formUrl„ÅåÊú™Ë®≠ÂÆö');
  }
  
  if (appPublished && !hasPublishedSheet) {
    issues.push('‚ùå appPublished=true„Å™„ÅÆ„Å´publishedSheetName„ÅåÊú™Ë®≠ÂÆö');
  }
  
  if (!hasSpreadsheet && (setupStatus === 'completed' || formCreated || appPublished)) {
    issues.push('‚ùå „Éá„Éº„Çø„ÇΩ„Éº„ÇπÊú™Ë®≠ÂÆö„Å™„ÅÆ„Å´È´òÂ∫¶„Å™Ë®≠ÂÆö„ÅåÊúâÂäπ');
  }
  
  // setupStep„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆË≠¶Âëä
  if (config.setupStep !== undefined) {
    issues.push('‚ö†Ô∏è setupStep„ÅåconfigJson„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºàÂÜóÈï∑Ôºâ');
  }
  
  // ÁµêÊûúË°®Á§∫
  if (issues.length === 0) {
    console.log('‚úÖ Êï¥ÂêàÊÄßÊ§úË®ºÂÆå‰∫Ü: ÂïèÈ°å„Å™„Åó');
  } else {
    console.warn('‚ö†Ô∏è Êï¥ÂêàÊÄßÂïèÈ°åÊ§úÂá∫:', issues);
  }
  
  console.groupEnd();
}

/**
 * publishedSheetName‰øÆÂæ©Èñ¢Êï∞
 * @param {Object} config - ‰øÆÂæ©ÂØæË±°„ÅÆconfig
 * @return {Object} ‰øÆÂæ©„Åï„Çå„Åüconfig
 */
function fixPublishedSheetName(config) {
  // publishedSheetName„Åå'„Éï„Ç©„Éº„É†„ÅÆÂõûÁ≠î 1'„ÅÆ„Çà„ÅÜ„Å™„Éá„Éï„Ç©„É´„ÉàÂêç„ÅÆÂ†¥Âêà„ÇÇ‰øÆÂæ©ÂØæË±°
  const isDefaultSheetName = config.publishedSheetName === '„Éï„Ç©„Éº„É†„ÅÆÂõûÁ≠î 1' || 
                            config.publishedSheetName?.startsWith('„Éï„Ç©„Éº„É†„ÅÆÂõûÁ≠î');
                            
  if ((!config.publishedSheetName || 
       config.publishedSheetName.trim() === '' || 
       isDefaultSheetName) && 
      config.publishedSpreadsheetId) {
    
    // AIÂàóÂà§ÂÆöÁµêÊûú„Åã„ÇâË≥™ÂïèÊñá„ÇíÂèñÂæó„ÇíË©¶Ë°å
    if (currentStatus?.sheetDetails?.guessedConfig?.opinionHeader) {
      const questionText = currentStatus.sheetDetails.guessedConfig.opinionHeader;
      config.publishedSheetName = questionText;
      
      if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
        console.log('üîß publishedSheetName‰øÆÂæ© (AIÂàóÂà§ÂÆöÁµêÊûú‰ΩøÁî®):', {
          ÂÖÉ„ÅÆÂêçÂâç: config.publishedSheetName,
          Êñ∞„Åó„ÅÑÂêçÂâç: questionText
        });
      }
      return config;
    }
    
    // AIÂàóÂà§ÂÆöÁµêÊûú„ÅåÁÑ°„ÅÑÂ†¥Âêà„ÅØÂæìÊù•„ÅÆsheet_„Ç≠„ÉºÊ§úÁ¥¢
    const sheetKeys = Object.keys(config).filter(key => key.startsWith('sheet_'));
    
    if (sheetKeys.length > 0) {
      // ÊúÄÂàù„Å´Ë¶ã„Å§„Åã„Å£„Åü„Ç∑„Éº„ÉàÂêç„Çí‰ΩøÁî®
      const detectedSheetName = sheetKeys[0].replace('sheet_', '');
      config.publishedSheetName = detectedSheetName;
      
      if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
        console.log('üîß publishedSheetName‰øÆÂæ© („Ç∑„Éº„Éà„Ç≠„Éº‰ΩøÁî®):', {
          Ê§úÂá∫„Åï„Çå„Åü„Ç∑„Éº„ÉàÂêç: detectedSheetName,
          Âà©Áî®ÂèØËÉΩ„Å™„Ç∑„Éº„ÉàË®≠ÂÆö: sheetKeys
        });
      }
    }
  }
  
  return config;
}





/**
 * „Ç∞„É≠„Éº„Éê„É´ÂàóË®≠ÂÆö„ÇíÊúÄÊñ∞„ÅÆ„Ç∑„Éº„ÉàË®≠ÂÆö„Å®ÂêåÊúü
 * @param {Object} config - ÂêåÊúüÂØæË±°„ÅÆconfig
 * @return {Object} ÂêåÊúü„Åï„Çå„Åüconfig
 */
function syncGlobalColumnSettings(config) {
  if (!config.publishedSheetName) {
    return config; // „Ç∑„Éº„ÉàÂêç„Åå‰∏çÊòé„Å™Â†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
  }
  
  const sheetConfigKey = 'sheet_' + String(config.publishedSheetName || '');
  const sheetConfig = config[sheetConfigKey];
  
  if (sheetConfig && typeof sheetConfig === 'object') {
    // „Ç∑„Éº„ÉàÂõ∫ÊúâË®≠ÂÆö„Çí„Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö„Å´ÂêåÊúü
    config.opinionHeader = sheetConfig.opinionHeader || config.opinionHeader || '';
    config.nameHeader = sheetConfig.nameHeader || config.nameHeader || '';
    config.reasonHeader = sheetConfig.reasonHeader || config.reasonHeader || '';
    config.classHeader = sheetConfig.classHeader || config.classHeader || '';
    config.timestampHeader = sheetConfig.timestampHeader || config.timestampHeader || '';
    
    // „Éï„Ç©„Éº„É†URLÂêåÊúü - „Ç∑„Éº„ÉàÂõ∫Êúâ„ÅÆformUrl„Çí„Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö„Å´ÂêåÊúü
    if (sheetConfig.formUrl) {
      config.formUrl = sheetConfig.formUrl;
      console.log('üîó „Éï„Ç©„Éº„É†URLÂêåÊúü:', {
        „Ç∑„Éº„ÉàÂêç: config.publishedSheetName,
        „Éï„Ç©„Éº„É†URL: config.formUrl
      });
    }
    
    console.log('üîß „Ç∞„É≠„Éº„Éê„É´ÂàóË®≠ÂÆöÂêåÊúüÂÆå‰∫Ü:', {
      „Ç∑„Éº„ÉàÂêç: config.publishedSheetName,
      „É°„Ç§„É≥Ë≥™Âïè: config.opinionHeader,
      ÂêçÂâçÂàó: config.nameHeader
    });
  }
  
  return config;
}

/**
 * ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆË£úÂÆå
 * @param {Object} config - Ë£úÂÆåÂØæË±°„ÅÆconfig
 * @return {Object} Ë£úÂÆå„Åï„Çå„Åüconfig
 */
function ensureRequiredFields(config) {
  const defaults = {
    showNames: false,
    showCounts: false,
    highlightMode: false,
    autoStopEnabled: true,
    autoStopMinutes: 360
  };
  
  Object.keys(defaults).forEach(key => {
    if (config[key] === undefined) {
      config[key] = defaults[key];
    }
  });
  
  return config;
}


/**
 * ÂÖ¨ÈñãÊ∏à„ÅøÁä∂ÊÖãÁî®configJson‰øÆÂæ©Èñ¢Êï∞
 * @param {Object} config - ‰øÆÂæ©ÂØæË±°„ÅÆconfig
 * @return {Object} ‰øÆÂæ©„Åï„Çå„Åüconfig
 */
function fixConfigForPublishedState(config) {
  const fixedConfig = { ...config };
  
  // ÂÖ¨ÈñãÊ∏à„ÅøÁä∂ÊÖã„ÅÆÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„Çí‰øÆÂæ©
  if (fixedConfig.setupStatus !== 'completed') {
    console.log('üîß setupStatus fixed from pending to completed');
    fixedConfig.setupStatus = 'completed';
  }
  
  if (!fixedConfig.formCreated) {
    console.log('üîß formCreated status fixed from false to true');
    fixedConfig.formCreated = true;
  }
  
  if (!fixedConfig.appPublished) {
    console.log('üîß appPublished status fixed from false to true');
    fixedConfig.appPublished = true;
  }
  
  // Form URL temporary setting (if actual form URL is unknown)
  if (!fixedConfig.formUrl || fixedConfig.formUrl.trim() === '') {
    console.log('üîß formUrl temporary setting for published state maintenance');
    fixedConfig.formUrl = 'https://docs.google.com/temp-form-url'; // Temporary license URL
  }
  
  return fixedConfig;
}


// Á∞°Âçò„Å™Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', async function() {
  // Load history table
  loadSimpleHistoryTable();
  
  // Check for and recover draft from session storage
  if (hasDraftInSession()) {
    await recoverDraftFromSession();
  }
});

// Êó•ÊôÇ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÈñ¢Êï∞
function formatDateTime(date) {
  try {
    const options = {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      timeZone: 'Asia/Tokyo'
    };
    return new Intl.DateTimeFormat('ja-JP', options).format(date).replace(/\//g, '-');
  } catch (error) {
    console.warn('‚ö†Ô∏è Date formatting failed:', error);
    return date.toISOString().split('T')[0] + ' ' + date.toISOString().split('T')[1].substring(0, 5);
  }
}

// Êñ∞„Åó„ÅÑ„É™„ÇΩ„Éº„Çπ„Éú„Çø„É≥„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
function updateNewResourceButtons(resourceUrls) {
  const folderBtn = document.getElementById('open-folder-btn');

  // Ë§áÊï∞„ÅÆ„ÇΩ„Éº„Çπ„Åã„Çâ„Éï„Ç©„É´„ÉÄURL„ÇíÂèñÂæó„ÇíË©¶Ë°å
  let folderUrl = resourceUrls.folder;
  
  // „Éï„Ç©„É´„ÉÄURL„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅ‰ªñ„ÅÆ„ÇΩ„Éº„Çπ„ÇíÁ¢∫Ë™ç
  if (!folderUrl) {
    // configJson„Åã„ÇâÁõ¥Êé•ÂèñÂæó„ÇíË©¶Ë°å
    const config = window.configJson || window.AdminPanel?.status?.config;
    if (config) {
      folderUrl = config.folderUrl || (config.folderId && ('https://drive.google.com/drive/folders/' + String(config.folderId || '')));
    }
    
    // „Éï„Ç©„É´„ÉÄID„Åã„ÇâÁõ¥Êé•URL„ÇíÊßãÁØâ
    if (!folderUrl && config?.folderId) {
      folderUrl = 'https://drive.google.com/drive/folders/' + String(config.folderId || '');
      console.log('üìÅ Folder URL constructed from folderId:', folderUrl);
    }
  }
  
  // „Éï„Ç©„É´„ÉÄ„Éú„Çø„É≥„ÅÆÊúâÂäπÂåñ
  if (folderBtn) {
    folderBtn.disabled = false;
    folderBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    if (folderUrl) {
      folderBtn.onclick = () => {
        console.log('üìÅ Opening folder URL:', folderUrl);
        const link = document.createElement('a');
        link.href = folderUrl;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        document.body.appendChild(link);
        link.click();
        link.remove();
      };
      folderBtn.title = '„Éâ„É©„Ç§„Éñ„Éï„Ç©„É´„ÉÄ„ÇíÈñã„Åè';
      console.log('‚úÖ Folder button enabled with URL:', folderUrl);
    } else {
      folderBtn.onclick = () => showMessage('„Éï„Ç©„É´„ÉÄURL„ÅåÊú™Ë®≠ÂÆö„Åß„Åô', 'warning');
      folderBtn.title = '„Éï„Ç©„É´„ÉÄURL„ÅåÊú™Ë®≠ÂÆö„Åß„Åô';
      console.log('‚ö†Ô∏è Folder button enabled - no URL available');
    }
  }
}

// ÂàùÊúüÂåñ„ÅØ adminPanel-core.js „ÅÆÁµ±ÂêàÂàùÊúüÂåñ„Ç∑„Çπ„ÉÜ„É†„ÅßÁÆ°ÁêÜ„Åï„Çå„Åæ„Åô
</script>
