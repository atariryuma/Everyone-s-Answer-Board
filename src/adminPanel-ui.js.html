<script>
let lastSelectedSheetName = null; // To prevent redundant sheet selection change events

// UI Update Mutex to prevent race conditions
let isUIUpdateInProgress = false;
let pendingUIUpdate = null;

// =============================================================================
// ADMIN PANEL UI UPDATES & DISPLAY CONTROL
// =============================================================================

// =============================================================================
// UTILITY FUNCTIONS
// =============================================================================

// Unified publication state detection with enhanced flow completion recognition
function getPublicationState(status) {
  if (!status) {
    return { isPublished: false, reason: 'No status data' };
  }
  
  // Check multiple possible publication indicators in priority order
  let isPublished = false;
  let reason = '';
  
  // 1. Direct isPublished property
  if (status.isPublished === true) {
    isPublished = true;
    reason = 'status.isPublished=true';
  }
  // 2. Direct appPublished property  
  else if (status.appPublished === true) {
    isPublished = true;
    reason = 'status.appPublished=true';
  }
  // 3. Check configJson for appPublished
  else if (status.userInfo?.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      if (config.appPublished === true) {
        isPublished = true;
        reason = 'configJson.appPublished=true';
        
        // Enhanced validation: Verify setup completion indicators
        const hasCompletedSetup = (
          config.setupStatus === 'completed' &&
          config.formCreated === true &&
          config.publishedSheetName &&
          config.publishedSpreadsheetId
        );
        
        if (hasCompletedSetup) {
          reason += ' (ÂÆåÂÖ®„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊ∏à„Åø)';
        } else {
          console.log('‚ö†Ô∏è Publication state: appPublished=true but setup incomplete', {
            setupStatus: config.setupStatus,
            formCreated: config.formCreated,
            hasPublishedSheet: !!config.publishedSheetName,
            hasPublishedSpreadsheet: !!config.publishedSpreadsheetId
          });
          reason += ' („Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó‰∏çÂÆåÂÖ®)';
        }
      } 
      // 4. Enhanced completion check: Allow recognition of completed but not yet published setups
      else if (config.setupStatus === 'completed' && 
               config.formCreated === true && 
               config.publishedSheetName && 
               config.publishedSpreadsheetId) {
        // This covers cases where setup is complete but appPublished might not be properly set
        console.log('üîß Publication state: Setup complete but appPublished=false - potential state inconsistency');
        reason = '„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü„Å†„ÅåÂÖ¨ÈñãÁä∂ÊÖã‰∏çÊï¥Âêà';
        // Don't auto-publish, but log for debugging
      }
    } catch (e) {
      console.warn('Failed to parse configJson:', e);
    }
  }
  
  // Maintained strict logic to prevent false positives
  // Note: Removed loose fallback logic that assumed activeSheetName = published
  
  return { 
    isPublished, 
    reason,
    // Add confidence level for better debugging
    confidence: isPublished ? (reason.includes('ÂÆåÂÖ®„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊ∏à„Åø') ? 'high' : 'medium') : 'low'
  };
}

// Generate viewUrl with comprehensive fallback logic
function generateViewUrl(status, userId) {
  // 1. Use existing viewUrl if available
  let viewUrl = status.appUrls?.viewUrl;
  if (viewUrl) {
    return viewUrl;
  }
  
  // 2. Generate from appUrls.webApp with userId
  if (status.appUrls?.webApp && userId) {
    return status.appUrls.webApp + '?userId=' + encodeURIComponent(userId) + '&mode=view';
  }
  
  // 3. Generate from status.webAppUrl with userId
  if (status.webAppUrl && userId) {
    return status.webAppUrl + '?userId=' + encodeURIComponent(userId) + '&mode=view';
  }
  
  // 4. Simple fallback without userId
  if (status.appUrls?.webApp) {
    return status.appUrls.webApp + '?mode=view';
  }
  
  logWarn('Could not generate viewUrl');
  return null;
}

// =============================================================================
// MAIN UI UPDATE FUNCTIONS
// =============================================================================

// Update UI with new status data
function updateUIWithNewStatus(status) {
  if (!validateStatus(status)) {
    logWarn('Invalid status received, skipping UI update');
    return;
  }

  // UI Update Mutex: Prevent concurrent UI updates
  if (isUIUpdateInProgress) {
    logDebug('UI update in progress, queuing this update');
    pendingUIUpdate = status;
    return;
  }

  isUIUpdateInProgress = true;
  
  try {
    // 1. configJsonÊ≠£Ë¶èÂåñÂá¶ÁêÜÔºàÂåÖÊã¨ÁöÑ„Ç∑„Çπ„ÉÜ„É†ÊúÄÈÅ©ÂåñÔºâ
    status = validateAndFixUIState(status);
    
    // 2. Standardize status object with publication state and viewUrl
    const publicationState = getPublicationState(status);
    const viewUrl = generateViewUrl(status, userId);
    
    // Add normalized properties to status object
    status._normalized = {
      isPublished: publicationState.isPublished,
      publishReason: publicationState.reason,
      viewUrl: viewUrl,
      hasValidViewUrl: !!viewUrl
    };
    
    currentStatus = status;
  
  // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç
  const setupStatus = getSetupStatusFromUserInfo(status.userInfo);
  
  // Âõ∫ÂÆöË°®Á§∫Ë¶ÅÁ¥†„Çí„ÇØ„É™„Ç¢ÔºàsetupStatusÈñ¢‰øÇ„Å™„ÅèÂÆüË°åÔºâ
  clearInitialDisplayElements();
  
  // Update static UI elements firstÔºàÂ∏∏„Å´ÂÆüË°åÔºâ
  updateStaticUI(status);
  
  // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊú™ÂÆå‰∫ÜÊôÇ„ÅÆËøΩÂä†Âá¶ÁêÜ
  if (setupStatus === 'pending') {
    updateButtonStatesForSetup(status);
  }
  
  // Update dynamic content based on state
  if (status.activeSheetName) {
    updateDynamicContent(status);
  } else {
    updateUIForNoActiveSheet(status);
  }
  
  // Update footer and guidance
  updateFooterAndGuidance(status);
  
  // Update step indicators and manage sections
  const currentStep = status.setupStep || 1;
  updateStepIndicators(currentStep, status);
  manageSectionStates(currentStep);
  
  // „Ç∑„Éº„ÉàÊú™ÈÅ∏ÊäûÊôÇ„ÅØÂàóÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
  if (!status.activeSheetName) {
    clearColumnSelections();
  }
  
  // Update unpublish button state
  updateUnpublishButton(status);

  // Update system status display and resource buttons („Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Éª„Éï„Ç©„Éº„É†„Éú„Çø„É≥„ÅÆÊúâÂäπÂåñÂá¶ÁêÜ„ÇíÂê´„ÇÄ)
  updateSystemStatusDisplay(status);

    // If an active sheet is set on initial load, load its configuration
    if (status.activeSheetName && status.userInfo && status.userInfo.spreadsheetId) {
      selectedSheet = status.activeSheetName;
      loadConfigForSelected(status.activeSheetName, status.userInfo.spreadsheetId)
        .then(result => {
          console.log('‚úÖ ÂàùÊúüÂåñÊôÇ„ÅÆ„Ç∑„Éº„ÉàË®≠ÂÆöË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', result);
        })
        .catch(error => {
          console.warn('‚ö†Ô∏è ÂàùÊúüÂåñÊôÇ„ÅÆ„Ç∑„Éº„ÉàË®≠ÂÆöË™≠„ÅøËæº„ÅøÂ§±Êïó:', error);
        });
    }
    
  } finally {
    // Release the UI update mutex
    isUIUpdateInProgress = false;
    
    // Process any pending UI update
    if (pendingUIUpdate) {
      const nextUpdate = pendingUIUpdate;
      pendingUIUpdate = null;
      logDebug('Processing queued UI update');
      setTimeout(() => updateUIWithNewStatus(nextUpdate), 0);
    }
  }
}

// Update unpublish button state
function updateUnpublishButton(status) {
  const unpublishBtn = document.getElementById('unpublish-board-btn');
  if (!unpublishBtn) return;

  // Use same strict logic as footer: both normalized and explicit checks
  const isPublished = status._normalized?.isPublished || false;
  let explicitAppPublished = status.appPublished === true;
  
  if (!explicitAppPublished && status.userInfo?.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      explicitAppPublished = config.appPublished === true;
    } catch (configError) {
      console.warn('‚ùå Failed to parse configJson for unpublish button check:', configError);
      explicitAppPublished = false;
    }
  }
  
  const finalIsPublished = isPublished && explicitAppPublished;

  if (finalIsPublished) {
    unpublishBtn.classList.remove('hidden');
  } else {
    unpublishBtn.classList.add('hidden');
  }
}

// Update spreadsheet access button state
function updateSpreadsheetButton() {
  const btn = document.getElementById('open-spreadsheet-btn-step2');
  if (!btn) return;
  
  if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetUrl) {
    btn.disabled = false;
    btn.onclick = function() {
      window.open(currentStatus.userInfo.spreadsheetUrl, '_blank');
    };
    logDebug('‚úÖ Spreadsheet button enabled with URL:', currentStatus.userInfo.spreadsheetUrl);
  } else {
    btn.disabled = true;
    btn.onclick = null;
    logDebug('‚ö†Ô∏è Spreadsheet button disabled - no URL available');
  }
}

// Update static UI elements
function updateStaticUI(status) {
  // Update database info panel
  updateDatabaseInfo(status);
  
  // Update existing user section
  updateExistingUserSection(status);
  
  // Populate sheet selection - fix property name mismatch
  logDebug('üîç Debug: Checking sheet data properties', {
    allSheets: status.allSheets,
    sheetNames: status.sheetNames,
    activeSheetName: status.activeSheetName
  });
  
  const sheetsData = status.sheetNames || status.allSheets || [];
  populateSheetSelect(sheetsData, status.activeSheetName);
  
  // Update custom form info
  updateCustomFormInfo(status);
  
  // Check for auto-publish dialog
  checkAutoPublishDialog(status);
}

// =============================================================================
// DATABASE INFO PANEL UPDATES
// =============================================================================

function updateDatabaseInfo(status) {
  if (!status || !status.userInfo) {
    console.warn('System info update failed: No user info available');
    return;
  }

  // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàURL„ÇíË®≠ÂÆö
  if (status.userInfo.spreadsheetUrl) {
    currentSpreadsheetUrl = status.userInfo.spreadsheetUrl;
  }

  const cfg = status.config || {};

  // Âü∫Êú¨ÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
  safeSetText('info-admin-email', status.userInfo.adminEmail);
  safeSetText('info-user-id', status.userInfo.userId);
  safeSetText('info-published-sheet', cfg.publishedSheetName || status.publishedSheetName || '„Å™„Åó');
  safeSetText('info-answer-count', status.answerCount || '0');
  safeSetText('info-reaction-count', status.totalReactions || '0');

  // ÂÖ¨ÈñãÁä∂ÊÖã„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
  const isPublished = cfg.isPublished !== undefined
    ? cfg.isPublished
    : status.appPublished || status.isPublished || (status.activeSheetName && (cfg.publishedSheetName || status.publishedSheetName));
  updatePublicationStatusUI(isPublished);

  // Ë°®Á§∫„É¢„Éº„Éâ„ÅÆÊõ¥Êñ∞
  const displayModeFlag = cfg.showNames !== undefined ? cfg.showNames : status.showNames;
  const displayMode = displayModeFlag ? 'ÂêçÂâçË°®Á§∫' : 'ÂåøÂêçË°®Á§∫';
  safeSetText('info-display-mode', displayMode);

  // „Ç´„Ç¶„É≥„ÉàË°®Á§∫„ÅÆÊõ¥Êñ∞
  const showCountsFlag = cfg.showCounts !== undefined
    ? cfg.showCounts
    : (status.showCounts !== undefined ? status.showCounts : false);
  const showCounts = showCountsFlag ? 'Ë°®Á§∫' : 'ÈùûË°®Á§∫';
  safeSetText('info-show-counts', showCounts);

  // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖãÂêåÊúü
  syncCheckboxStates(status);
}

// Update publication status UI
function updatePublicationStatusUI(isPublished) {
  const statusElement = safeGetElement('info-publish-status');
  const indicatorElement = safeGetElement('info-publish-indicator');
  const textElement = safeGetElement('info-publish-text');
  
  if (statusElement) {
    if (isPublished) {
      statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-green-600 text-white';
      if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-green-400';
      if (textElement) textElement.textContent = 'ÂÖ¨Èñã‰∏≠';
    } else {
      statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-gray-600 text-gray-300';
      if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      if (textElement) textElement.textContent = 'ÈùûÂÖ¨Èñã';
    }
  }
}

// „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÂêåÊúü„Åô„ÇãÈñ¢Êï∞
function syncCheckboxStates(status) {
  // Priority: Database config (configJson) > status properties > defaults
  let showNames = false;
  let showCounts = false;
  
  // 1. Prefer status.config if available
  if (status.config) {
    if (status.config.showNames !== undefined) showNames = status.config.showNames;
    if (status.config.showCounts !== undefined) showCounts = status.config.showCounts;
  } else if (status.userInfo?.configJson) {
    // 2. Fallback to raw configJson
    try {
      const config = JSON.parse(status.userInfo.configJson);
      if (config.showNames !== undefined) showNames = config.showNames;
      if (config.showCounts !== undefined) showCounts = config.showCounts;
    } catch (e) {
      logWarn('Failed to parse configJson, using status properties');
      if (status.showNames !== undefined) showNames = status.showNames;
      if (status.showCounts !== undefined) showCounts = status.showCounts;
    }
  } else {
    // 3. Use status properties as last resort
    if (status.showNames !== undefined) showNames = status.showNames;
    if (status.showCounts !== undefined) showCounts = status.showCounts;
  }

  // Update checkbox elements
  const showNamesCheckbox = safeGetElement('show-names');
  const showCountsCheckbox = safeGetElement('show-counts');
  
  if (showNamesCheckbox) {
    showNamesCheckbox.checked = showNames;
  }
  
  if (showCountsCheckbox) {
    showCountsCheckbox.checked = showCounts;
  }
}

// =============================================================================
// SHEET SELECTION AND CONFIGURATION
// =============================================================================

// Populate sheet selection dropdown
function populateSheetSelect(sheetNames, activeSheetName) {
  const select = document.getElementById('sheet-select');
  if (!select) {
    logWarn('Sheet select element not found');
    return;
  }

  logDebug('üìã Populating sheet select with data:', {
    sheetNames: sheetNames,
    activeSheetName: activeSheetName,
    dataType: typeof sheetNames,
    isArray: Array.isArray(sheetNames)
  });

  // Clear existing options
  select.innerHTML = '<option value="">-- „Ç∑„Éº„Éà„ÇíÈÅ∏Êäû --</option>';
  
  if (sheetNames && sheetNames.length > 0) {
    logDebug('‚úÖ Adding sheets to dropdown:', sheetNames.length);
    
    sheetNames.forEach((sheet, index) => {
      const option = document.createElement('option');
      
      // Handle both object and string formats
      let sheetName;
      if (typeof sheet === 'object' && sheet.name) {
        sheetName = sheet.name;
        option.value = sheet.name;
        logDebug(`üìÑ Sheet ${index + 1}: ${sheet.name} (ID: ${sheet.id})`);
      } else if (typeof sheet === 'string') {
        sheetName = sheet;
        option.value = sheet;
        logDebug(`üìÑ Sheet ${index + 1}: ${sheet}`);
      } else {
        console.warn('‚ö†Ô∏è Unknown sheet format:', sheet);
        return;
      }
      
      // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Éº„Éà„ÅÆË°®Á§∫„ÇíÊîπÂñÑ
      if (sheetName === activeSheetName) {
        option.textContent = `${sheetName} („Ç¢„ÇØ„ÉÜ„Ç£„Éñ)`;
        option.style.fontWeight = 'bold';
        option.style.color = '#10b981'; // Á∑ëËâ≤„Åß„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÇíË°®Á§∫
        option.className = 'active-sheet-option';
        logDebug(`‚úÖ Active sheet marked: ${sheetName}`);
      } else {
        option.textContent = sheetName;
      }
      
      select.appendChild(option);
    });
    select.disabled = false;
    logDebug('‚úÖ Sheet dropdown populated successfully');
  } else {
    console.warn('‚ö†Ô∏è No sheets available:', sheetNames);
    select.innerHTML = '<option value="">Âà©Áî®ÂèØËÉΩ„Å™„Ç∑„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</option>';
    select.disabled = true;
  }
  
  // Set active sheet if available
  if (activeSheetName) {
    select.value = activeSheetName;
    selectedSheet = activeSheetName;
    lastSelectedSheetName = activeSheetName; // Update last selected sheet
    logDebug('‚úÖ Active sheet set:', activeSheetName);
  }
  
  // Add change event listener for data preview
  select.removeEventListener('change', handleSheetSelectionChange);
  select.addEventListener('change', handleSheetSelectionChange);
  
  // Update UI for selected sheet and enable spreadsheet button
  updateUIForSelectedSheet();
  updateSpreadsheetButton();
}

// Populate header options for configuration
function populateHeaderOptions(headers) {
  // Throttle function calls to prevent spam
  if (window.populateHeaderOptionsRunning) {
    return;
  }
  window.populateHeaderOptionsRunning = true;
  
  const selects = [
    'opinionHeader',      // Main required field
    'reason-column',     // Optional details field (reason column)
    'name-column', 
    'class-column'
  ];
  
  selects.forEach(selectId => {
    const select = document.getElementById(selectId);
    
    if (select) {
      // Store current value
      const currentValue = select.value;
      
      // Clear and repopulate with appropriate placeholder
      if (headers && headers.length > 0) {
        select.innerHTML = '<option value="">-- Âàó„ÇíÈÅ∏Êäû --</option>';
        select.disabled = false;
      } else {
        select.innerHTML = '<option value="">-- „Ç∑„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>';
        select.disabled = true;
      }
      
      const excludedHeaders = [
        '„Å™„Çã„Åª„Å©ÔºÅ',
        '„ÅÑ„ÅÑ„Å≠ÔºÅ',
        '„ÇÇ„Å£„Å®Áü•„Çä„Åü„ÅÑÔºÅ',
        '„Éè„Ç§„É©„Ç§„Éà',
        '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ', // „Éï„Ç©„Éº„É†„ÅßËá™ÂãïÂèéÈõÜ„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Éû„ÉÉ„Éî„É≥„Ç∞ÂØæË±°„Åã„ÇâÈô§Â§ñ
        '„Çø„Ç§„É†„Çπ„Çø„É≥„Éó' // „É¶„Éº„Ç∂„Éº„ÅÆË¶ÅÊúõ„Å´„Çà„ÇäÈô§Â§ñ
      ];

      const filteredHeaders = headers.filter(header => !excludedHeaders.includes(header));

      filteredHeaders.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      
      // Restore previous value if still valid
      if (currentValue && headers.includes(currentValue)) {
        select.value = currentValue;
      }
    }
  });
  
  // Reset throttle after a delay
  setTimeout(() => {
    window.populateHeaderOptionsRunning = false;
  }, 100);
}

// Populate configuration with guessed values
function populateConfig(cfg) {
  if (!cfg) return;
  
  // Throttle function calls to prevent spam
  if (window.populateConfigRunning) {
    return;
  }
  window.populateConfigRunning = true;
  
  const mappings = {
    // Main opinion dropdown (primary target)
    'opinionHeader': cfg.opinionHeader || cfg.opinionColumn,
    
    // Detail configuration dropdowns (secondary targets with property name fixes)
    'reason-column': cfg.reasonColumn || cfg.reasonHeader,
    'name-column': cfg.nameColumn || cfg.nameHeader,
    'class-column': cfg.classColumn || cfg.classHeader,
    'show-names': cfg.showNames,
    'show-counts': cfg.showCounts
  };
  
  Object.keys(mappings).forEach(elementId => {
    const element = document.getElementById(elementId);
    const value = mappings[elementId];
    
    if (element && value !== undefined) {
      if (element.type === 'checkbox') {
        element.checked = Boolean(value);
      } else {
        element.value = value;
      }
    }
  });
  
  // Reset throttle after a delay
  setTimeout(() => {
    window.populateConfigRunning = false;
  }, 100);
  
  updateConfigButtons();
}

// Clear configuration fields
function clearConfigFields() {
  const fieldIds = [
    'opinionHeader',      // Main required field
    'reason-column',
    'name-column',
    'class-column'
  ];
  
  fieldIds.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.value = '';
    }
  });
  
  updateConfigButtons();
}

// Build configuration object from form
function buildConfigObject() {
  // Get values from primary elements (with fallback to secondary elements)
  const opinionValue = document.getElementById('opinionHeader')?.value || 
                      document.getElementById('reason-column')?.value || '';
  const nameValue = document.getElementById('name-column')?.value || '';
  const classValue = document.getElementById('class-column')?.value || '';
  const showNames = document.getElementById('show-names')?.checked || false;
  const showCounts = document.getElementById('show-counts')?.checked || false;
  
  return {
    sheetName: selectedSheet,
    // Use property names that match backend expectations (opinionHeader format)
    opinionHeader: opinionValue,
    nameHeader: nameValue,
    classHeader: classValue,
    reasonHeader: document.getElementById('reason-column')?.value || '',
    // Also provide legacy format for backward compatibility
    opinionColumn: opinionValue,
    nameColumn: nameValue,
    classColumn: classValue,
    showNames: showNames,
    showCounts: showCounts
  };
}

// Validate configuration
function validateConfig() {
  // Check primary element first, then fallback to secondary element
  const opinionValue = document.getElementById('opinionHeader')?.value || 
                      document.getElementById('reason-column')?.value || '';
  
  return opinionValue && opinionValue.trim() !== '';
}

// Update configuration buttons state
function updateConfigButtons() {
  const isValid = validateConfig();
  const saveBtn = document.getElementById('save-publish-btn');
  
  if (saveBtn) {
    saveBtn.disabled = !isValid;
    if (isValid) {
      saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }
}

// =============================================================================
// STEP INDICATORS AND GUIDANCE
// =============================================================================

// Update step indicators
function updateStepIndicators(currentStep, status = null) {
  const steps = [
    document.getElementById('step-1-indicator'),
    document.getElementById('step-2-indicator'),
    document.getElementById('step-3-indicator')
  ];

  // ÂÖ¨ÈñãÁä∂ÊÖã„ÅÆÂà§ÂÆö
  const isPublished = status?._normalized?.isPublished || (window.lastStatusCache?._normalized?.isPublished);

  steps.forEach((step, index) => {
    if (!step) return;
    
    const stepNumber = index + 1;
    const circle = step.querySelector('div');
    const text = step.querySelector('span');

    // Êó¢Â≠ò„ÅÆÂÖ¨ÈñãÁä∂ÊÖã„Éê„ÉÉ„Ç∏„ÇíÂâäÈô§
    const existingBadge = step.querySelector('.publication-badge');
    if (existingBadge) {
      existingBadge.remove();
    }

    if (stepNumber < currentStep) {
      // ÂÆå‰∫Ü„Åó„Åü„Çπ„ÉÜ„ÉÉ„Éó: „ÉÅ„Çß„ÉÉ„ÇØ„Éû„Éº„ÇØË°®Á§∫
      if (circle) {
        circle.className = 'w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all';
        circle.innerHTML = '‚úì'; // „ÉÅ„Çß„ÉÉ„ÇØ„Éû„Éº„ÇØ
      }
      if (text) {
        text.classList.remove('text-gray-500');
        text.classList.add('text-green-400', 'font-medium');
      }
    } else if (stepNumber === currentStep) {
      // ÁèæÂú®„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó: Âº∑Ë™øË°®Á§∫„Å®Áï™Âè∑
      if (circle) {
        circle.className = 'w-6 h-6 bg-cyan-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all ring-2 ring-cyan-400 ring-offset-2 ring-offset-gray-900 animate-pulse';
        circle.innerHTML = stepNumber;
      }
      if (text) {
        text.classList.remove('text-gray-500');
        text.classList.add('text-cyan-400', 'font-bold');
      }
    } else {
      // Êú™Êù•„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó: „Ç∞„É¨„Éº„Ç¢„Ç¶„Éà
      if (circle) {
        circle.className = 'w-6 h-6 bg-gray-700 text-gray-500 rounded-full flex items-center justify-center font-bold text-xs transition-all border border-gray-600';
        circle.innerHTML = stepNumber;
      }
      if (text) {
        text.classList.remove('text-white', 'font-semibold', 'text-green-400', 'text-cyan-400', 'font-bold', 'font-medium');
        text.classList.add('text-gray-500');
      }
    }

    // „Çπ„ÉÜ„ÉÉ„Éó3„ÅßÂÖ¨Èñã‰∏≠„ÅÆÂ†¥Âêà„ÄÅÂÆå‰∫Ü„Éû„Éº„ÇØ„ÇíË°®Á§∫Ôºà„Éê„ÉÉ„Ç∏„ÅØÂâäÈô§Ôºâ
    if (stepNumber === 3 && isPublished) {
      // circle„ÅØÊó¢„Å´ÂèñÂæóÊ∏à„Åø„ÅÆdivË¶ÅÁ¥†„Çí‰ΩøÁî®
      if (circle && !circle.classList.contains('step-completed')) {
        circle.className = 'w-7 h-7 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all duration-300 shadow-lg step-completed';
        circle.innerHTML = '‚úì';
      }
      // „ÉÜ„Ç≠„Çπ„Éà„ÇÇÂÆå‰∫ÜÁä∂ÊÖã„Å´„Åô„Çã
      if (text) {
        text.classList.remove('text-gray-400', 'text-cyan-400');
        text.classList.add('text-green-400', 'font-medium');
      }
    }
  });
  
  // ÈÄ≤Ë°åÁä∂Ê≥Å„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÊõ¥Êñ∞
  updateProgressMessage(currentStep, status);
}

function updateProgressMessage(currentStep, status = null) {
  const messageElement = document.getElementById('progress-message');
  if (!messageElement) return;
  
  // ÂÖ¨ÈñãÁä∂ÊÖã„ÅÆÂà§ÂÆö
  const isPublished = status?._normalized?.isPublished || (window.lastStatusCache?._normalized?.isPublished);
  
  let message = '';
  switch (currentStep) {
    case 1:
      message = 'üìã „Çπ„ÉÜ„ÉÉ„Éó1: „Éá„Éº„Çø„ÇΩ„Éº„Çπ„ÇíÊ∫ñÂÇô„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      break;
    case 2:
      message = '‚öôÔ∏è „Çπ„ÉÜ„ÉÉ„Éó2: „Ç∑„Éº„Éà„Å®Âàó„ÅÆË®≠ÂÆö„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      break;
    case 3:
      if (isPublished) {
        message = '‚úÖ „Éú„Éº„Éâ„ÅåÂÖ¨Èñã‰∏≠„Åß„Åô„ÄÇË®≠ÂÆöÂ§âÊõ¥„ÇÑÂÖ¨ÈñãÂÅúÊ≠¢„Åå„Åß„Åç„Åæ„Åô';
      } else {
        message = 'üöÄ „Çπ„ÉÜ„ÉÉ„Éó3: Âàó„ÇíË®≠ÂÆö„Åó„Å¶„Éú„Éº„Éâ„ÇíÂÖ¨Èñã„Åó„Åæ„Åó„Çá„ÅÜ';
      }
      break;
    default:
      message = 'üéâ „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ';
  }
  
  messageElement.textContent = message;
  messageElement.className = `text-sm ${currentStep === 1 ? 'text-cyan-400' : currentStep === 2 ? 'text-yellow-400' : 'text-green-400'} font-medium mb-4`;
}

// Update footer and guidance text
function updateFooterAndGuidance(status) {
  console.group('ü¶∂ updateFooterAndGuidance');
  
  const footer = document.getElementById('admin-footer');
  const guidanceText = document.getElementById('guidance-text');
  
  if (!footer || !guidanceText) {
    console.warn('‚ùå Footer or guidance elements not found');
    console.groupEnd();
    return;
  }

  // Use normalized publication state from status object with additional validation
  const isPublished = status._normalized?.isPublished || false;
  const viewUrl = status._normalized?.viewUrl;
  
  // Additional strict check: ensure appPublished is explicitly true
  let explicitAppPublished = status.appPublished === true;
  
  if (!explicitAppPublished && status.userInfo?.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      explicitAppPublished = config.appPublished === true;
    } catch (configError) {
      console.warn('‚ùå Failed to parse configJson for publication check:', configError);
      explicitAppPublished = false;
    }
  }
  
  // Final publication decision: both normalized and explicit checks must agree
  const finalIsPublished = isPublished && explicitAppPublished;
  
  console.log('üîç Enhanced publication check:', {
    'normalized isPublished': isPublished,
    'explicit appPublished': explicitAppPublished,
    'final decision': finalIsPublished,
    'publish reason': status._normalized?.publishReason,
    'normalized viewUrl': viewUrl,
    'has valid viewUrl': status._normalized?.hasValidViewUrl,
    'will show footer': finalIsPublished
  });

  // Show footer if published (with strict validation)
  if (finalIsPublished) {
    footer.classList.remove('hidden');
    
    // Update board URL using our generated viewUrl (if available)
    const boardUrlInput = document.getElementById('board-url');
    const viewBoardLink = document.getElementById('view-board-link');
    
    if (boardUrlInput) {
      boardUrlInput.value = viewUrl || 'URLÁîüÊàê‰∏≠...';
      console.log('üìù Board URL input updated:', viewUrl || 'URL generation pending');
    }
    if (viewBoardLink && viewUrl) {
      viewBoardLink.href = viewUrl;
      console.log('üîó View board link updated:', viewUrl);
    } else if (viewBoardLink) {
      viewBoardLink.removeAttribute('href');
      console.log('üîó View board link cleared - no URL available');
    }
    
    // Update topic text
    updateTopicText(status);
    
    guidanceText.textContent = 'ÂõûÁ≠î„Éú„Éº„Éâ„ÅØÁèæÂú®ÂÖ¨Èñã‰∏≠„Åß„Åô„ÄÇ';
    console.log('‚úÖ Footer shown - board is published');
  } else {
    footer.classList.add('hidden');
    console.log('‚ùå Footer hidden - board not published');
    
    // Update guidance based on setup step
    updateGuidanceForStep(status.setupStep || 1, guidanceText);
  }
  
  console.groupEnd();
  
  // Ëá™ÂãïÂÅúÊ≠¢ÈÄöÁü•„ÅÆË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØ
  checkAndShowAutoStopNotification(status);
  
  adjustLayout();
}

// Update UI for selected sheet
function updateUIForSelectedSheet() {
  var hasSelection = selectedSheet && selectedSheet.trim() !== '';
  
  // Update step indicators based on current status (Áµ±‰∏Ä„Åï„Çå„Åü„É≠„Ç∏„ÉÉ„ÇØ„Çí‰ΩøÁî®)
  const currentStep = currentStatus && currentStatus.setupStep ? currentStatus.setupStep : 1;
  updateStepIndicators(currentStep);
  
  // Enable/disable configuration section
  var configSection = document.getElementById('config-section');
  if (configSection) {
    if (hasSelection) {
      configSection.classList.remove('opacity-50', 'pointer-events-none');
      
      // Èò≤Âæ°ÁöÑ„É≠„Ç∏„ÉÉ„ÇØ: config-area„ÅåÁ¢∫ÂÆü„Å´Ë°®Á§∫„Åï„Çå„Çã„Çà„ÅÜ„Å´„Åô„Çã
      var configArea = document.getElementById('config-area');
      if (configArea) {
        configArea.classList.remove('hidden');
        console.log('üõ°Ô∏è updateUIForSelectedSheet: Config area shown defensively');
      }
    } else {
      configSection.classList.add('opacity-50', 'pointer-events-none');
    }
  }
  
  // Update guidance text
  var guidanceText = document.getElementById('guidance-text');
  if (guidanceText) {
    if (hasSelection) {
      guidanceText.textContent = '„Çπ„ÉÜ„ÉÉ„Éó3: Âàó„ÇíË®≠ÂÆö„Åó„Å¶„Éú„Éº„Éâ„ÇíÂÖ¨Èñã„Åó„Åæ„Åó„Çá„ÅÜ';
    } else {
      guidanceText.textContent = '„Çπ„ÉÜ„ÉÉ„Éó2: Ë°®Á§∫„Åó„Åü„ÅÑ„Ç∑„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    }
  }

  // Toggle placeholder visibility
  var configPlaceholder = document.getElementById('config-placeholder');
  if (configPlaceholder) {
    if (hasSelection) {
      configPlaceholder.classList.add('hidden');
    } else {
      configPlaceholder.classList.remove('hidden');
    }
  }
}

// Update topic text in footer
function updateTopicText(status) {
  const topicTextElement = document.getElementById('current-topic-text');
  const scheduledEndTimeElement = document.getElementById('scheduled-end-time');
  
  if (!topicTextElement) return;

  let topic = 'ÔºàÂïèÈ°åÊñáÊú™Ë®≠ÂÆöÔºâ';
  // „Çà„ÇäÂåÖÊã¨ÁöÑ„Å™configÂèñÂæó
  let cfg = status.config || {};
  
  // userInfo.configJson„Åã„Çâ„ÇÇÊÉÖÂ†±„ÇíÂèñÂæó
  if (status.userInfo?.configJson) {
    try {
      const fullConfig = JSON.parse(status.userInfo.configJson);
      cfg = { ...cfg, ...fullConfig };
    } catch (e) {
      console.warn('Failed to parse userInfo.configJson:', e);
    }
  }

  if (status.customFormInfo && status.customFormInfo.mainQuestion) {
    topic = status.customFormInfo.mainQuestion;
  } else if (cfg.opinionHeader) {
    topic = cfg.opinionHeader;
  } else {
    const sheetName = cfg.publishedSheetName || status.publishedSheetName;
    if (sheetName) {
      if (status.userInfo?.configJson) {
        try {
          const fullCfg = JSON.parse(status.userInfo.configJson);
          const sheetCfg = fullCfg['sheet_' + sheetName] || {};
          topic = sheetCfg.opinionHeader || sheetName || 'ÔºàÂïèÈ°åÊñáÊú™Ë®≠ÂÆöÔºâ';
        } catch (e) {
          topic = sheetName || 'ÔºàÂïèÈ°åÊñáÊú™Ë®≠ÂÆöÔºâ';
        }
      } else {
        topic = sheetName;
      }
    }
  }

  topicTextElement.textContent = topic;
  
  // ‰∫àÂÆöÁµÇ‰∫ÜÊó•ÊôÇ„ÅÆÊõ¥Êñ∞
  if (scheduledEndTimeElement) {
    updateScheduledEndTime(cfg, scheduledEndTimeElement);
  }
}

// ‰∫àÂÆöÁµÇ‰∫ÜÊó•ÊôÇ„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
function updateScheduledEndTime(config, element) {
  // Ë§áÊï∞„ÅÆ„ÇΩ„Éº„Çπ„Åã„Çâ scheduledEndAt „ÇíÂèñÂæó„ÇíË©¶Ë°å
  const scheduledEndAt = config.scheduledEndAt || 
                         config.scheduledEndTime ||  // Âè§„ÅÑ„Éï„Ç£„Éº„É´„ÉâÂêç„Å®„ÅÆ‰∫íÊèõÊÄß
                         (window.lastStatusCache?.config?.scheduledEndAt) ||
                         (window.lastStatusCache?.config?.scheduledEndTime);
  
  // scheduledEndAt„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅpublishedAt + autoStopMinutes„Åã„ÇâË®àÁÆó
  let finalScheduledEndTime = scheduledEndAt;
  
  if (!finalScheduledEndTime && config.publishedAt && config.autoStopMinutes) {
    const publishedTime = new Date(config.publishedAt);
    const autoStopMs = config.autoStopMinutes * 60 * 1000;
    finalScheduledEndTime = new Date(publishedTime.getTime() + autoStopMs).toISOString();
    console.log('üïê ÁµÇ‰∫Ü‰∫àÂÆöÊôÇÂàª„ÇíË®àÁÆó„Åó„Åæ„Åó„Åü:', finalScheduledEndTime);
  }
  
  if (finalScheduledEndTime) {
    try {
      const endDate = new Date(finalScheduledEndTime);
      const formattedTime = endDate.toLocaleString('ja-JP', {
        year: '2-digit',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // ÁèæÂú®ÊôÇÂàª„Å®„ÅÆÊØîËºÉ
      const now = new Date();
      const isOverdue = endDate < now;
      const timeRemaining = endDate.getTime() - now.getTime();
      const oneHourMs = 60 * 60 * 1000; // 1ÊôÇÈñì„ÅÆ„Éü„É™Áßí
      
      if (isOverdue) {
        element.textContent = `${formattedTime} (ÊúüÈôêÂàá„Çå)`;
        element.className = 'text-xs font-medium text-red-400';
      } else if (timeRemaining <= oneHourMs) {
        // 1ÊôÇÈñì‰ª•ÂÜÖ„ÅÆÂ†¥Âêà„ÅØË≠¶ÂëäË°®Á§∫
        const minutesRemaining = Math.floor(timeRemaining / (60 * 1000));
        element.textContent = `${formattedTime} (ÊÆã„Çä${minutesRemaining}ÂàÜ)`;
        element.className = 'text-xs font-medium text-red-400 animate-pulse';
        console.log('‚ö†Ô∏è ÊúüÈôê„Åæ„Åß1ÊôÇÈñì‰ª•ÂÜÖ„Åß„Åô:', minutesRemaining + 'ÂàÜ');
      } else {
        element.textContent = formattedTime;
        element.className = 'text-xs font-medium text-orange-400';
      }
    } catch (e) {
      element.textContent = 'Ë®≠ÂÆö„Ç®„É©„Éº';
      element.className = 'text-xs font-medium text-gray-400';
    }
  } else {
    element.textContent = 'Êú™Ë®≠ÂÆö';
    element.className = 'text-xs font-medium text-gray-400';
  }
}

// Update guidance text for specific step
function updateGuidanceForStep(step, guidanceElement) {
  const messages = {
    1: '„Çπ„ÉÜ„ÉÉ„Éó1: „Éú„Éº„Éâ„Çí‰ΩúÊàê„Åæ„Åü„ÅØÊó¢Â≠ò„ÅÆ„É™„ÇΩ„Éº„Çπ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
    2: '„Çπ„ÉÜ„ÉÉ„Éó2: Ë°®Á§∫„Åó„Åü„ÅÑ„Ç∑„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
    3: '„Çπ„ÉÜ„ÉÉ„Éó3: Âàó„ÇíË®≠ÂÆö„Åó„Å¶„Éú„Éº„Éâ„ÇíÂÖ¨Èñã„Åó„Åæ„Åó„Çá„ÅÜ'
  };
  
  // ÂÖ¨ÈñãÁµÇ‰∫ÜÂæå„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó1„Åß„ÅØ„ÄÅÊòéÁ¢∫„Å´„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÜçÈñã„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
  if (step === 1) {
    guidanceElement.textContent = '„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
  } else {
    guidanceElement.textContent = messages[step] || '„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
  }
}

// Ëá™ÂãïÂÅúÊ≠¢ÈÄöÁü•„ÅÆË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØ
function checkAndShowAutoStopNotification(status) {
  const notificationElement = document.getElementById('auto-stop-notification');
  const autoStoppedTimeElement = document.getElementById('auto-stopped-time');
  
  if (!notificationElement || !autoStoppedTimeElement) return;
  
  const config = status.config || {};
  
  // Ëá™ÂãïÂÅúÊ≠¢„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÈÄöÁü•„ÇíË°®Á§∫
  if (config.autoStoppedAt && config.autoStopReason === 'scheduled_timeout') {
    console.log('üîî Ëá™ÂãïÂÅúÊ≠¢ÈÄöÁü•„ÇíË°®Á§∫„Åó„Åæ„Åô:', config.autoStoppedAt);
    
    // ÂÅúÊ≠¢ÊôÇÂàª„ÇíË°®Á§∫
    try {
      const stoppedDate = new Date(config.autoStoppedAt);
      const formattedTime = stoppedDate.toLocaleString('ja-JP', {
        year: '2-digit',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      autoStoppedTimeElement.textContent = formattedTime;
    } catch (e) {
      autoStoppedTimeElement.textContent = 'ÊôÇÂàª‰∏çÊòé';
    }
    
    // ÈÄöÁü•„ÇíË°®Á§∫
    notificationElement.classList.remove('hidden');
    
    // ÂÜçÂÖ¨Èñã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
    const republishBtn = document.getElementById('republish-after-auto-stop-btn');
    if (republishBtn) {
      // Êó¢Â≠ò„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
      republishBtn.replaceWith(republishBtn.cloneNode(true));
      
      // Êñ∞„Åó„ÅÑ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
      const newRepublishBtn = document.getElementById('republish-after-auto-stop-btn');
      newRepublishBtn.addEventListener('click', function() {
        // Step 3„Å´ÁßªÂãï„Åó„Å¶ÂÜçÂÖ¨Èñã„Çí‰øÉ„Åô
        const step3Section = document.getElementById('step3-content');
        if (step3Section) {
          step3Section.classList.remove('hidden');
          step3Section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // ÈÄöÁü•„ÇíÈùûË°®Á§∫
        notificationElement.classList.add('hidden');
        
        showMessage('Ë°®Á§∫Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶ÂÜçÂÖ¨Èñã„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'info');
      });
    }
  } else {
    // Ëá™ÂãïÂÅúÊ≠¢„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÁü•„ÇíÈùûË°®Á§∫
    notificationElement.classList.add('hidden');
  }
}

// =============================================================================
// SECTION TOGGLE FUNCTIONALITY
// =============================================================================

// Toggle section expansion/collapse
function toggleSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (!section) {
    console.warn('Section not found:', sectionId);
    return;
  }
  
  // Find the toggle button for this section
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  const arrow = toggleBtn ? toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up') : null;
  
  // Toggle the section visibility
  if (section.classList.contains('hidden')) {
    // Show section
    section.classList.remove('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'true');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-up');
      arrow.classList.add('fa-chevron-down');
    }
  } else {
    // Hide section
    section.classList.add('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'false');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-down');
      arrow.classList.add('fa-chevron-up');
    }
  }
}

// Automatically collapse completed sections
function collapseCompletedSection(stepNumber) {
  const sectionId = `step${stepNumber}-content`;
  const section = document.getElementById(sectionId);
  if (!section) return;
  
  console.log(`üìÅ Auto-collapsing completed step ${stepNumber}`);
  
  // Collapse the section
  section.classList.add('hidden');
  
  // Update toggle button state
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  if (toggleBtn) {
    toggleBtn.setAttribute('aria-expanded', 'false');
    const arrow = toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
    if (arrow) {
      arrow.classList.remove('fa-chevron-down');
      arrow.classList.add('fa-chevron-up');
    }
  }
  
  // Note: Visual indicators are now managed by manageSectionStates()
}

// Automatically expand active section
function expandActiveSection(stepNumber) {
  const sectionId = `step${stepNumber}-content`;
  const section = document.getElementById(sectionId);
  if (!section) return;
  
  console.log(`üìÇ Auto-expanding active step ${stepNumber}`);
  
  // Expand the section
  section.classList.remove('hidden');
  
  // Special handling for Step 3: ensure config-area is visible
  if (stepNumber === 3) {
    const configArea = document.getElementById('config-area');
    if (configArea && currentStatus && currentStatus.activeSheetName) {
      configArea.classList.remove('hidden');
      console.log(`üìã expandActiveSection: Config area shown for Step 3`);
    }
  }
  
  // Update toggle button state
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  if (toggleBtn) {
    toggleBtn.setAttribute('aria-expanded', 'true');
    const arrow = toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
    if (arrow) {
      arrow.classList.remove('fa-chevron-up');
      arrow.classList.add('fa-chevron-down');
    }
  }
  
  // Note: Visual indicators are now managed by manageSectionStates()
}

// Manage section states based on current step (simplified - no visual effects)
function manageSectionStates(currentStep) {
  console.log(`üîÑ Managing section states for step ${currentStep}`);
  
  // „Çπ„ÉÜ„ÉÉ„Éó„Åî„Å®„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥Âà∂Âæ°
  for (let i = 1; i <= 3; i++) {
    const sectionId = `step${i}-content`;
    const section = document.getElementById(sectionId);
    
    if (i === currentStep) {
      // ÁèæÂú®„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó: Â±ïÈñã„Åó„Å¶ÊúâÂäπÂåñ
      expandActiveSection(i);
      
      // Step 3„ÅÆÁâπÂà•Âá¶ÁêÜ: config-area„ÅÆË°®Á§∫
      if (i === 3) {
        const configArea = document.getElementById('config-area');
        if (configArea && currentStatus && currentStatus.activeSheetName) {
          configArea.classList.remove('hidden');
          console.log(`üìã Step 3: Config area shown for sheet: ${currentStatus.activeSheetName}`);
        }
      }
      
      console.log(`üîÑ Step ${i}: Active (current step)`);
    } else if (i < currentStep) {
      // ÂÆå‰∫ÜÊ∏à„Åø„Çπ„ÉÜ„ÉÉ„Éó: „Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Å†„Åå„ÄÅÂ±ïÈñã„ÅØ‰ªªÊÑè
      if (section) {
        section.classList.add('opacity-90'); // ÂÆå‰∫Ü„Åó„ÅüÁä∂ÊÖã„ÇíË¶ñË¶öÁöÑ„Å´Á§∫„Åô
      }
      console.log(`‚úÖ Step ${i}: Completed (accessible)`);
    } else {
      // Êú™Êù•„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó: Step 1„ÅÆÂ†¥Âêà„ÅØpendingÁä∂ÊÖã„Åß„ÇÇÂÖ®„Å¶Èñ≤Ë¶ßÂèØËÉΩ
      if (currentStep === 1) {
        // Step 1„Åß„ÅØÂÖ®„Çπ„ÉÜ„ÉÉ„Éó„Å´„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩÔºà„Éá„Éº„ÇøÁ¢∫Ë™ç„ÅÆ„Åü„ÇÅÔºâ
        if (section) {
          section.classList.add('opacity-75'); // Êú™Êù•„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å®„Åó„Å¶ËªΩ„ÅèË°®Á§∫
        }
        console.log(`‚è≠Ô∏è Step ${i}: Available for preview`);
      } else {
        // Step 2‰ª•Èôç„Åß„ÅØÈ†ÜÊ¨°ÈñãÊîæ
        if (section) {
          section.classList.add('opacity-50'); // Êú™Êù•„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å®„Åó„Å¶Ë°®Á§∫
        }
        console.log(`‚è≠Ô∏è Step ${i}: Future step (available)`);
      }
    }
  }
}

// =============================================================================
// MODAL MANAGEMENT
// =============================================================================

// Show form configuration modal
function showFormConfigModal() {
  if (window.sharedModals) {
    window.sharedModals.showFormConfig();
    loadSavedClassChoices();
    manageFocusForModal('form-config-modal', true);
  } else {
    // Fallback for legacy support
    const modal = document.getElementById('form-config-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      loadSavedClassChoices();
      manageFocusForModal('form-config-modal', true);
    }
  }
}

// Hide form configuration modal
function hideFormConfigModal() {
  if (window.sharedModals) {
    window.sharedModals.hideModal('form-config-modal');
    manageFocusForModal('form-config-modal', false);
  } else {
    // Fallback for legacy support
    const modal = document.getElementById('form-config-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      manageFocusForModal('form-config-modal', false);
    }
  }
}

// Show privacy modal
function showPrivacyModal(onContinue) {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('privacy-modal', true);
    
    // Set up continue handler
    const continueBtn = document.getElementById('privacy-modal-continue');
    if (continueBtn && onContinue) {
      continueBtn.onclick = onContinue;
    }
  }
}

// Hide privacy modal
function hidePrivacyModal() {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('privacy-modal', false);
  }
}

// Show digital citizenship modal
function showDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('digital-citizenship-modal', true);
  }
}

// Hide digital citizenship modal
function hideDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('digital-citizenship-modal', false);
  }
}

// Show confirmation modal
function showConfirmationModal(title, message, onConfirm) {
  const modal = document.getElementById('confirmation-modal');
  const titleElement = document.getElementById('modal-title');
  const messageElement = document.getElementById('modal-message');
  const confirmBtn = document.getElementById('modal-confirm-btn');
  const cancelBtn = document.getElementById('modal-cancel-btn');
  
  console.log('üîç showConfirmationModal: Ë¶ÅÁ¥†Ê§úÁ¥¢ÁµêÊûú:', {
    modal: !!modal,
    titleElement: !!titleElement,
    messageElement: !!messageElement,
    confirmBtn: !!confirmBtn,
    cancelBtn: !!cancelBtn
  });
  
  if (modal && titleElement && messageElement && confirmBtn) {
    titleElement.textContent = title;
    messageElement.textContent = message;
    
    // Á¢∫Ë™ç„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    confirmBtn.onclick = function() {
      console.log('‚úÖ Á¢∫Ë™ç„Éú„Çø„É≥„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
      hideConfirmationModal();
      if (onConfirm) {
        try {
          onConfirm();
        } catch (error) {
          console.error('‚ùå Á¢∫Ë™ç„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å„Ç®„É©„Éº:', error);
        }
      }
    };
    
    // „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    if (cancelBtn) {
      cancelBtn.onclick = function() {
        console.log('‚ùå „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
        hideConfirmationModal();
      };
    }
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('confirmation-modal', true);
    console.log('‚úÖ Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü');
  } else {
    console.error('‚ùå „É¢„Éº„ÉÄ„É´Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ');
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éñ„É©„Ç¶„Ç∂Ê®ôÊ∫ñ„ÅÆÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
    if (window.confirm(`${title}\n\n${message}`)) {
      if (onConfirm) {
        try {
          onConfirm();
        } catch (error) {
          console.error('‚ùå „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁ¢∫Ë™ç„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å„Ç®„É©„Éº:', error);
        }
      }
    }
  }
}

// Hide confirmation modal
function hideConfirmationModal() {
  const modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('confirmation-modal', false);
  }
}

// =============================================================================
// DYNAMIC CONTENT UPDATES
// =============================================================================

// Update dynamic content when board is active
function updateDynamicContent(status) {
  // Enable buttons that require active state
  const buttons = [
    'open-spreadsheet-btn'
  ];
  
  buttons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = false;
      button.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  });
}

// Update UI when no sheet is active
function updateUIForNoActiveSheet(status) {
  // Disable buttons that require active state
  const buttons = [
    // No form buttons to disable since we only support spreadsheets
  ];
  
  buttons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = true;
      button.classList.add('opacity-50', 'cursor-not-allowed');
    }
  });
}

// Update existing user section
function updateExistingUserSection(status) {
  // Update any user-specific UI elements
  if (status.userInfo) {
    // Update user-specific elements here if needed
  }
}

// Update custom form info
function updateCustomFormInfo(status) {
  if (status.customFormInfo) {
    // Update form-related UI elements
    const formTitle = document.getElementById('form-title-display');
    const formQuestion = document.getElementById('form-question-display');
    
    if (formTitle) {
      formTitle.textContent = status.customFormInfo.title || '„Éï„Ç©„Éº„É†Êú™‰ΩúÊàê';
    }
    
    if (formQuestion) {
      formQuestion.textContent = status.customFormInfo.mainQuestion || '';
    }
  }
  
  // „Éï„Ç©„Éº„É†URLË°®Á§∫„ÅÆÊõ¥Êñ∞ÔºàconfigJson„Åã„ÇâÁ¢∫ÂÆü„Å´ÂèñÂæóÔºâ
  updateFormUrlDisplay(status);
}

// „Éï„Ç©„Éº„É†URLË°®Á§∫„ÇíÁ¢∫ÂÆü„Å´Êõ¥Êñ∞
function updateFormUrlDisplay(status = null) {
  const formUrlInput = document.getElementById('form-url-input');
  const formUrlSection = document.getElementById('form-url-section');
  const openFormLink = document.getElementById('open-form-url-link');
  
  if (!formUrlInput) return;
  
  // ÁèæÂú®„ÅÆstatus„Åå„Å™„ÅÑÂ†¥Âêà„ÅØglobal currentStatus„Çí‰ΩøÁî®
  const currentStatusToUse = status || currentStatus;
  let formUrl = null;
  
  // 1. configJson„Åã„ÇâÁõ¥Êé•ÂèñÂæóÔºàÊúÄ„ÇÇÁ¢∫ÂÆüÔºâ
  if (currentStatusToUse && currentStatusToUse.userInfo && currentStatusToUse.userInfo.configJson) {
    try {
      const configJson = typeof currentStatusToUse.userInfo.configJson === 'string' 
        ? JSON.parse(currentStatusToUse.userInfo.configJson) 
        : currentStatusToUse.userInfo.configJson;
      
      if (configJson && configJson.formUrl) {
        formUrl = configJson.formUrl;
        logDebug('‚úÖ FormURLË°®Á§∫: configJson„Åã„ÇâÁõ¥Êé•ÂèñÂæóÊàêÂäü');
      }
    } catch (error) {
      logWarn('‚ö†Ô∏è configJson„ÅÆËß£Êûê„Åß„Ç®„É©„Éº:', error);
    }
  }
  
  // 2. „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆformUrl„Åã„ÇâÂèñÂæóÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
  if (!formUrl && currentStatusToUse && currentStatusToUse.userInfo && currentStatusToUse.userInfo.formUrl) {
    formUrl = currentStatusToUse.userInfo.formUrl;
    logDebug('üìã FormURLË°®Á§∫: userInfo.formUrl„Åã„ÇâÂèñÂæó');
  }
  
  // 3. „Ç´„Çπ„Çø„É†„Éï„Ç©„Éº„É†ÊÉÖÂ†±„Åã„ÇâÂèñÂæóÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
  if (!formUrl && currentStatusToUse && currentStatusToUse.customFormInfo && currentStatusToUse.customFormInfo.formUrl) {
    formUrl = currentStatusToUse.customFormInfo.formUrl;
    logDebug('üìÑ FormURLË°®Á§∫: customFormInfo.formUrl„Åã„ÇâÂèñÂæó');
  }
  
  // UIË¶ÅÁ¥†„ÅÆÊõ¥Êñ∞
  if (formUrl) {
    formUrlInput.value = formUrl;
    if (openFormLink) {
      openFormLink.href = formUrl;
    }
    
    // „Éï„Ç©„Éº„É†‰ΩúÊàêÂÆå‰∫Ü„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆË°®Á§∫Âà∂Âæ°
    if (formUrlSection) {
      // Êñ∞„Åó„Åè„Éï„Ç©„Éº„É†„Åå‰ΩúÊàê„Åï„Çå„ÅüÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
      const formJustCreated = sessionStorage.getItem('form_just_created');
      if (formJustCreated === 'true') {
        formUrlSection.classList.remove('hidden');
        logDebug('üÜï Êñ∞Ë¶è„Éï„Ç©„Éº„É†‰ΩúÊàê„ÅÆ„Åü„ÇÅÂÆå‰∫Ü„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫');
        
        // 10ÁßíÂæå„Å´„Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢Ôºà„Çª„ÇØ„Ç∑„Éß„É≥„ÅØË°®Á§∫„Åó„Åü„Åæ„ÅæÔºâ
        setTimeout(() => {
          sessionStorage.removeItem('form_just_created');
          logDebug('üßπ „Éï„Ç©„Éº„É†‰ΩúÊàêÂÆå‰∫Ü„Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
        }, 10000);
      } else {
        formUrlSection.classList.add('hidden');
        logDebug('üìã Êó¢Â≠ò„Éï„Ç©„Éº„É†„ÅÆ„Åü„ÇÅÂÆå‰∫Ü„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫');
      }
    }
    logDebug('üîó FormURL UIÊõ¥Êñ∞ÂÆå‰∫Ü:', formUrl);
  } else {
    formUrlInput.value = '';
    if (formUrlSection) {
      formUrlSection.classList.add('hidden');
    }
    logDebug('üì≠ FormURLÊú™Ë®≠ÂÆö„ÅÆ„Åü„ÇÅUIÈùûË°®Á§∫');
  }
}

// Check for auto-publish dialog
function checkAutoPublishDialog(status) {
  // Implementation for auto-publish dialog if needed
  if (status.needsAutoPublish) {
    // Show auto-publish confirmation
  }
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize UI components
function initializeUI() {
  console.log('‚úÖ AdminPanel: UI components ready');
  // UIÂàùÊúüÂåñ„ÅÆ„ÅøÂÆüË°å„ÄÅloadStatus„ÅØ adminPanel-api.js „ÅßÂá¶ÁêÜ„Åï„Çå„Çã
}

// =============================================================================
// SHEET SELECTION FUNCTIONALITY  
// =============================================================================

// Handle sheet selection change
function handleSheetSelectionChange(event) {
  const newSelectedSheet = event.target.value;

  // Prevent redundant calls if the selected sheet hasn't actually changed
  if (newSelectedSheet === lastSelectedSheetName) {
    console.log('üìä Sheet selection changed, but value is the same. Skipping redundant processing.');
    return;
  }
  
  console.log('üìä Sheet selection changed:', {
    previousSheet: selectedSheet,
    newSelectedSheet: newSelectedSheet
  });
  
  // Update global selected sheet variable and last selected sheet
  selectedSheet = newSelectedSheet;
  lastSelectedSheetName = newSelectedSheet;
  
  if (newSelectedSheet) {
    console.log('üìã Loading config for sheet:', newSelectedSheet);

    // 1. Âç≥Â∫ß„Å´„Ç∑„Éº„Éà„Çí„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ
    activateSelectedSheet(newSelectedSheet);

    // Call getSheetDetails once and use its result for config
    if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
      console.error('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
      return;
    }

    // 2. „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Éº„Éà„ÅÆÂàó„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶ÂàóÈÅ∏Êäû„ÇíÊõ¥Êñ∞
    loadConfigForSelected(newSelectedSheet, currentStatus.userInfo.spreadsheetId)
      .then(result => {
        console.log('‚úÖ „Ç∑„Éº„ÉàË®≠ÂÆöË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', result);
        // UIÊõ¥Êñ∞ÂÆå‰∫ÜÂæå„ÅÆÂá¶ÁêÜ
        updateUIForSelectedSheet();
      })
      .catch(error => {
        console.error('‚ùå „Ç∑„Éº„ÉàË®≠ÂÆöË™≠„ÅøËæº„ÅøÂ§±Êïó:', error);
        showMessage('„Ç∑„Éº„Éà„ÅÆË®≠ÂÆöË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        // „Ç®„É©„ÉºÊôÇ„ÇÇUIÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        updateUIForSelectedSheet();
      });
  } else {
    // „Ç∑„Éº„ÉàÈÅ∏Êäû„ÅåËß£Èô§„Åï„Çå„ÅüÂ†¥Âêà
    clearColumnSelections();
    updateUIForSelectedSheet();
  }
}

// „Ç∑„Éº„Éà„ÇíÂç≥Â∫ß„Å´„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ„Åô„ÇãÈñ¢Êï∞
function activateSelectedSheet(sheetName) {
  if (!sheetName || !currentStatus || !currentStatus.userInfo) {
    console.warn('‚ö†Ô∏è „Ç∑„Éº„Éà„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ„Å´ÂøÖË¶Å„Å™ÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
    return;
  }

  console.log(`üéØ „Ç∑„Éº„Éà„ÇíÂç≥Â∫ß„Å´„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ: ${sheetName}`);
  
  // „Çµ„Éº„Éê„ÉºÂÅ¥„Åß„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Éº„Éà„ÇíË®≠ÂÆö
  runGasWithUserId('setActiveSheet', '„Ç∑„Éº„Éà„Çí„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ‰∏≠...', sheetName)
    .then(response => {
      console.log('‚úÖ „Ç∑„Éº„Éà„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñÂÆå‰∫Ü:', response);
      
      // currentStatus„ÇíÊõ¥Êñ∞
      if (currentStatus.userInfo.configJson) {
        try {
          const config = JSON.parse(currentStatus.userInfo.configJson);
          config.publishedSheetName = sheetName;
          currentStatus.userInfo.configJson = JSON.stringify(config);
          currentStatus.activeSheetName = sheetName;
          
          // „Ç∑„Éº„Éà„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
          updateSheetSelectActiveIndicator(sheetName);
          
          console.log('‚úÖ „É≠„Éº„Ç´„É´Áä∂ÊÖãÊõ¥Êñ∞ÂÆå‰∫Ü');
        } catch (e) {
          console.warn('‚ö†Ô∏è configJsonÊõ¥Êñ∞„Å´Â§±Êïó:', e);
        }
      }
    })
    .catch(error => {
      console.error('‚ùå „Ç∑„Éº„Éà„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñÂ§±Êïó:', error);
      showMessage('„Ç∑„Éº„Éà„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'warning');
    });
}

// „Ç∑„Éº„Éà„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñË°®Á§∫„ÇíÊõ¥Êñ∞
function updateSheetSelectActiveIndicator(activeSheetName) {
  const select = document.getElementById('sheet-select');
  if (!select) return;
  
  // ÂÖ®„Å¶„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Åã„Çâ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñË°®Á§∫„ÇíÂâäÈô§
  Array.from(select.options).forEach(option => {
    if (option.value && option.textContent.includes(' („Ç¢„ÇØ„ÉÜ„Ç£„Éñ)')) {
      option.textContent = option.value;
      option.style.fontWeight = 'normal';
      option.style.color = '';
      option.className = '';
    }
  });
  
  // Êñ∞„Åó„ÅÑ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∑„Éº„Éà„Å´Ë°®Á§∫„ÇíËøΩÂä†
  const activeOption = Array.from(select.options).find(option => option.value === activeSheetName);
  if (activeOption) {
    activeOption.textContent = `${activeSheetName} („Ç¢„ÇØ„ÉÜ„Ç£„Éñ)`;
    activeOption.style.fontWeight = 'bold';
    activeOption.style.color = '#10b981';
    activeOption.className = 'active-sheet-option';
  }
}

// ÂàóÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢„Åô„ÇãÈñ¢Êï∞
function clearColumnSelections() {
  console.log('üßπ ÂàóÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢');
  
  const columnSelects = [
    'opinion-column',
    'name-column', 
    'reason-column',
    'class-column',
    'timestamp-column'
  ];
  
  columnSelects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.innerHTML = '<option value="">-- „Ç∑„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>';
      select.disabled = true;
    }
  });
}

// Load configuration for selected sheet - OPTIMIZED
function loadConfigForSelected(sheetName, spreadsheetId, retryCount = 0, maxRetries = 3) {
  console.log('üìã Loading config for:', { selectedSheet: sheetName, spreadsheetId: spreadsheetId, retry: retryCount });

  if (!spreadsheetId || !sheetName) {
    console.error('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
    return Promise.reject(new Error('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô'));
  }

  return new Promise((resolve, reject) => {

  // Check if fresh save protection is active - skip cache if so
  const timeSinceFreshSave = Date.now() - (window.freshSaveTimestamp || 0);
  const isFreshSaveActive = timeSinceFreshSave < 30000; // 30 seconds
  
    // Check if we already have sheet details from integrated API
    if (!isFreshSaveActive && currentStatus && currentStatus.sheetDetails && 
        currentStatus.activeSheetName === sheetName && currentStatus.sheetDetails.allHeaders && currentStatus.sheetDetails.allHeaders.length > 0) {
      console.log('‚ö° Using cached sheet details from integrated API');
      try {
        populateHeaderOptions(currentStatus.sheetDetails.allHeaders);
        console.log('‚úÖ Header options populated from cache');
        populateConfig(currentStatus.sheetDetails.guessedConfig);
        console.log('‚úÖ AI configuration applied from cache');
        resolve({ source: 'cache', headers: currentStatus.sheetDetails.allHeaders, config: currentStatus.sheetDetails.guessedConfig });
        return; // Early return - no API call needed
      } catch (error) {
        console.error('Error in cached config population:', error);
        // Fall through to API call if cache fails
      }
    }

  // Force fresh API call if fresh save protection is active or cache unavailable
  if (isFreshSaveActive) {
    console.log('üîÑ Fresh save protection active - forcing API call for latest data');
  } else {
    console.log('üìû Making API call for sheet details:', sheetName);
  }
  
    runGasWithUserId('getSheetDetails', '„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...', spreadsheetId, sheetName)
      .then(function(details) {
        console.log('‚úÖ Sheet details loaded via API:', details);
        
        // If headers are empty, and we have retries left, try again after a delay
        if (details && (!details.allHeaders || details.allHeaders.length === 0) && retryCount < maxRetries) {
          console.warn(`‚ö†Ô∏è No headers found for ${sheetName}. Retrying in 2 seconds... (Attempt ${retryCount + 1}/${maxRetries})`);
          showMessage(`„Ç∑„Éº„ÉàÊÉÖÂ†±„ÇíÂÜçÂèñÂæó‰∏≠... (${retryCount + 1}/${maxRetries})`, 'info');
          setTimeout(() => {
            loadConfigForSelected(sheetName, spreadsheetId, retryCount + 1, maxRetries)
              .then(resolve)
              .catch(reject);
          }, 2000); // Retry after 2 seconds
          return;
        }

        try {
          populateHeaderOptions(details.allHeaders);
          console.log('‚úÖ Header options populated from API');
          populateConfig(details.guessedConfig);
          console.log('‚úÖ AI configuration applied from API');
          if (retryCount > 0) {
            showMessage('‚úÖ „Ç∑„Éº„ÉàÊÉÖÂ†±„ÅåÊ≠£Â∏∏„Å´Ë™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„ÅüÔºÅ', 'success');
          }
          resolve({ source: 'api', headers: details.allHeaders, config: details.guessedConfig });
        } catch (error) {
          console.error('Error in API config population sequence:', error);
          showMessage('Ë®≠ÂÆö„ÅÆÈÅ©Áî®‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
          reject(error);
        }
      })
      .catch(function(error) {
        console.error('Failed to load sheet config via API:', error);
        
        // „Çà„ÇäË©≥Á¥∞„Å™„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË°®Á§∫
        let errorMessage = '„Ç∑„Éº„ÉàË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
        
        if (error && error.message) {
          if (error.message.includes('„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì')) {
            errorMessage = `ÊåáÂÆö„Åï„Çå„Åü„Ç∑„Éº„Éà "${sheetName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ`;
          } else if (error.message.includes('„Éò„ÉÉ„ÉÄ„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì')) {
            errorMessage = `„Ç∑„Éº„Éà "${sheetName}" „ÅÆ1Ë°åÁõÆ„Å´„Éò„ÉÉ„ÉÄ„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ`;
          } else if (error.message.includes('„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê')) {
            errorMessage = '„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å∏„ÅÆ„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ';
          } else if (error.message.includes('SheetsService')) {
            errorMessage = 'Google Sheets API„Çµ„Éº„Éì„Çπ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          } else {
            errorMessage = `„Ç®„É©„Éº„ÅÆË©≥Á¥∞: ${error.message}`;
          }
        }
        
        showMessage(errorMessage, 'error');
        
        // „Ç®„É©„ÉºÊôÇ„ÅÆ„É™„Éà„É©„Ç§„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊèê‰æõ
        if (retryCount < maxRetries) {
          setTimeout(() => {
            const retryButton = document.createElement('button');
            retryButton.textContent = 'ÂÜçË©¶Ë°å';
            retryButton.className = 'ml-2 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600';
            retryButton.onclick = () => {
              retryButton.remove();
              loadConfigForSelected(sheetName, spreadsheetId, retryCount + 1, maxRetries)
                .then(resolve)
                .catch(reject);
            };
            
            const messageElement = document.querySelector('.message');
            if (messageElement) {
              messageElement.appendChild(retryButton);
            }
          }, 1000);
        } else {
          reject(error);
        }
      });
  }); // PromiseÁµÇ‰∫Ü
}


// =============================================================================
// SETUP STATUS HANDLING FUNCTIONS
// =============================================================================

/**
 * userInfo„Åã„ÇâsetupStatus„ÇíÂÆâÂÖ®„Å´ÂèñÂæó
 * @param {Object} userInfo - „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
 * @returns {string} setupStatus ('pending', 'completed', 'error')
 */
function getSetupStatusFromUserInfo(userInfo) {
  try {
    if (!userInfo || !userInfo.configJson) {
      return 'pending'; // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊú™ÂÆå‰∫Ü„Å®„Åø„Å™„Åô
    }

    const config = typeof userInfo.configJson === 'string'
      ? JSON.parse(userInfo.configJson)
      : userInfo.configJson;

    // setupStatus„ÅåÊòéÁ§∫ÁöÑ„Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
    if (config.setupStatus) {
      console.log('üîß configJson setupStatus:', config.setupStatus);
      return config.setupStatus;
    }
    
    // setupStatus„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅ‰ªñ„ÅÆ„Éï„Ç£„Éº„É´„Éâ„Åã„ÇâÊé®Ê∏¨ÔºàÂæ™Áí∞ÂèÇÁÖßÂõûÈÅøÔºâ
    // Note: „Åì„ÅÆÊé®Ê∏¨„É≠„Ç∏„ÉÉ„ÇØ„ÅØÂæ™Áí∞ÂèÇÁÖß„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„ÄÅformUrl„Éô„Éº„Çπ„Å´Â§âÊõ¥
    if (config.formCreated === true && config.formUrl && config.formUrl.trim()) {
      return 'completed';
    }
    
    return 'pending';
    
  } catch (error) {
    console.warn('getSetupStatusFromUserInfo JSONËß£Êûê„Ç®„É©„Éº:', error.message);
    return 'pending'; // „Ç®„É©„ÉºÊôÇ„ÅØ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊú™ÂÆå‰∫Ü„Å®„Åø„Å™„Åô
  }
}


/**
 * ÂàùÊúüË°®Á§∫Ë¶ÅÁ¥†„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÈÅ©Âàá„Å™„Éâ„É°„Ç§„É≥Ë°®Á§∫„Å´Âàá„ÇäÊõø„Åà
 */
function clearInitialDisplayElements() {
  // ÂàùÊúüË°®Á§∫„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶„ÄÅÈÅ©Âàá„Å™„Éâ„É°„Ç§„É≥Ë°®Á§∫„Å´Âàá„ÇäÊõø„Åà
  const initialContainer = document.getElementById('header-domain-initial');
  if (initialContainer) {
    initialContainer.style.display = 'none';
    console.log('‚úÖ ÂàùÊúü„Éâ„É°„Ç§„É≥Ë°®Á§∫„ÇíÈùûË°®Á§∫');
  }
  
  // ÈÅ©Âàá„Å™„Éâ„É°„Ç§„É≥ÊÉÖÂ†±„ÇíË°®Á§∫
  showAppropriateHeaderStatus();
  
  // Êó¢Â≠ò„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Ç¨„Ç§„Éâ„ÅÆ„ÅøÂâäÈô§
  const existingGuides = [
    document.getElementById('setup-pending-guide'),
    document.querySelector('.setup-guide')
  ];
  
  existingGuides.forEach(guide => {
    if (guide) {
      guide.remove();
      console.log('‚úÖ Êó¢Â≠ò„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Ç¨„Ç§„Éâ„ÇíÂâäÈô§');
    }
  });
}

/**
 * „Éò„ÉÉ„ÉÄ„Éº„Å´ÈÅ©Âàá„Å™„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫„ÇíË®≠ÂÆö
 */
function showAppropriateHeaderStatus() {
  // „Éâ„É°„Ç§„É≥‰∏ÄËá¥Ë°®Á§∫Ôºà‰ªÆÔºâ„ÇíË°®Á§∫
  const domainMatch = document.getElementById('header-domain-match');
  const domainMismatch = document.getElementById('header-domain-mismatch');
  
  if (domainMatch && domainMismatch) {
    // ÁèæÂú®„ÅØ„Éâ„É°„Ç§„É≥‰∏ÄËá¥„Å®„Åó„Å¶Ë°®Á§∫ÔºàÂÆüÈöõ„ÅÆ„Éâ„É°„Ç§„É≥„ÉÅ„Çß„ÉÉ„ÇØ„ÅØÂà•ÈÄîÂÆüË£ÖÔºâ
    domainMatch.style.display = 'block';
    domainMismatch.style.display = 'none';
    
    // „Éâ„É°„Ç§„É≥Âêç„ÇíÈÅ©Âàá„Å´Ë®≠ÂÆö
    const domainText = document.getElementById('header-domain-match-text');
    if (domainText) {
      domainText.textContent = 'naha-okinawa.ed.jp';
    }
    
    console.log('‚úÖ „Éâ„É°„Ç§„É≥‰∏ÄËá¥Ë°®Á§∫„ÇíÊúâÂäπÂåñ');
  }
}

/**
 * „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁä∂Ê≥Å„Å´Âøú„Åò„Å¶„Éú„Çø„É≥Áä∂ÊÖã„ÇíÊõ¥Êñ∞
 * @param {Object} status - „Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
 */
function updateButtonStatesForSetup(status) {
  // „Çà„ÇäÁ©è„ÇÑ„Åã„Å™UIÂà∂Âæ°ÔºàÂÆåÂÖ®ÁÑ°ÂäπÂåñ„Åß„ÅØ„Å™„Åè„ÄÅÈÅ©Âàá„Å™„Ç¨„Ç§„ÉÄ„É≥„ÇπÔºâ
  
  // ÊúÄ‰ΩéÈôêÁÑ°ÂäπÂåñ„Åô„Åπ„ÅçÂÖ¨ÈñãÈñ¢ÈÄ£„Éú„Çø„É≥„ÅÆ„Åø
  const criticalPublishButtons = [
    'save-publish-btn',
    'unpublish-board-btn'
  ];
  
  criticalPublishButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      // „Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÁÑ°ÂäπÂåñ
      const hasSpreadsheet = status.userInfo && status.userInfo.spreadsheetId;
      const hasActiveSheet = status.activeSheetName;
      
      if (!hasSpreadsheet || !hasActiveSheet) {
        button.disabled = true;
        button.classList.add('opacity-75');
        button.title = 'ÂÖà„Å´„Éá„Éº„Çø„ÇΩ„Éº„Çπ„Å®„Ç∑„Éº„Éà„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      } else {
        button.disabled = false;
        button.classList.remove('opacity-75');
        button.title = '';
      }
    }
  });
  
  console.log('‚úÖ „Éú„Çø„É≥Áä∂ÊÖã„ÇíÈÅ©Âàá„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü');
}


/**
 * Âü∫Êú¨ÁöÑ„Å™ÈùôÁöÑUIË¶ÅÁ¥†„ÅÆ„ÅøÊõ¥Êñ∞
 * @param {Object} status - „Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
 */
function updateBasicStaticUI(status) {
  // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Å™„Å©ÊúÄ‰ΩéÈôê„ÅÆÊÉÖÂ†±„ÅÆ„ÅøÊõ¥Êñ∞
  if (status.userInfo) {
    // Êó¢Â≠ò„ÅÆupdateDatabaseInfoÈñ¢Êï∞„Çí‰ΩøÁî®„Åó„Å¶ÈáçË§á„ÇíÈÅø„Åë„Çã
    updateDatabaseInfo(status);
  }
}

// Update system status display
function updateSystemStatusDisplay(status) {
  if (!status) return;
  
  // Update publish status
  const publishIndicator = document.getElementById('info-publish-indicator');
  const publishText = document.getElementById('info-publish-text');
  
  if (status.isPublished) {
    publishIndicator.className = 'w-2 h-2 rounded-full bg-green-400';
    publishText.textContent = 'ÂÖ¨Èñã‰∏≠';
  } else {
    publishIndicator.className = 'w-2 h-2 rounded-full bg-gray-400';
    publishText.textContent = 'ÈùûÂÖ¨Èñã';
  }
  
  // Update other status fields
  document.getElementById('info-published-sheet').textContent = status.sheetName || '-';
  document.getElementById('info-display-mode').textContent = status.displayMode || '-';
  document.getElementById('info-show-counts').textContent = status.showCounts ? 'Ë°®Á§∫' : 'ÈùûË°®Á§∫';
  document.getElementById('info-answer-count').textContent = status.answerCount || '0';
  document.getElementById('info-reaction-count').textContent = status.reactionCount || '0';
  
  // Enable resource buttons if URLs are available
  const spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
  const formBtn = document.getElementById('open-form-btn');
  const resourceBtn = document.getElementById('open-resource-btn');
  
  if (status.spreadsheetUrl) {
    if (spreadsheetBtn) {
      spreadsheetBtn.disabled = false;
      spreadsheetBtn.onclick = () => window.open(status.spreadsheetUrl, '_blank');
    }
  }

  // „Éï„Ç©„Éº„É†URL„ÅÆÂèñÂæóÔºàË§áÊï∞„ÇΩ„Éº„Çπ„Åã„ÇâÔºâ
  let formUrl = null;
  
  // 1. configJson„Åã„ÇâÂèñÂæó
  if (status.userInfo && status.userInfo.configJson) {
    try {
      const configJson = typeof status.userInfo.configJson === 'string' 
        ? JSON.parse(status.userInfo.configJson) 
        : status.userInfo.configJson;
      
      if (configJson && configJson.formUrl) {
        formUrl = configJson.formUrl;
        console.log('‚úÖ FormURL found in configJson:', formUrl);
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è configJson parse error:', error);
    }
  }
  
  // 2. userInfo.formUrl„Åã„ÇâÂèñÂæóÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
  if (!formUrl && status.userInfo && status.userInfo.formUrl) {
    formUrl = status.userInfo.formUrl;
    console.log('üìã FormURL found in userInfo:', formUrl);
  }
  
  // 3. customFormInfo„Åã„ÇâÂèñÂæóÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
  if (!formUrl && status.customFormInfo && status.customFormInfo.formUrl) {
    formUrl = status.customFormInfo.formUrl;
    console.log('üìÑ FormURL found in customFormInfo:', formUrl);
  }
  
  // status„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´formUrl„ÇíË®≠ÂÆö
  status.formUrl = formUrl;

  if (status.formUrl) { // status„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´formUrl„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà
    if (formBtn) {
      formBtn.disabled = false;
      // onclick „ÅØÊó¢„Å´ adminPanel-events.js „Åß openForm Èñ¢Êï∞„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ
      // „Åì„Åì„Åß„ÅØ disabled Áä∂ÊÖã„Å®„Çπ„Çø„Ç§„É´„ÅÆ„Åø„ÇíÂà∂Âæ°
      formBtn.title = '„Éï„Ç©„Éº„É†„ÇíÈñã„Åè';
      formBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      console.log('‚úÖ Form button enabled with URL:', status.formUrl);
    }
  } else { // formUrl„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅ„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ„Åó„ÄÅ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
    if (formBtn) {
      formBtn.disabled = true;
      // onclick „Ç§„Éô„É≥„Éà„ÅØÊó¢Â≠ò„ÅÆ„ÇÇ„ÅÆ„Çí‰øùÊåÅÔºàopenFormÈñ¢Êï∞Ôºâ
      formBtn.title = '„Éï„Ç©„Éº„É†URL„ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇ„Éï„Ç©„Éº„É†„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      formBtn.classList.add('opacity-50', 'cursor-not-allowed');
      console.log('‚ö†Ô∏è Form button disabled - no URL available');
    }
  }
  
  // Handle generic resource button in Step 1 (spreadsheet only)
  if (resourceBtn && status.spreadsheetUrl) {
    resourceBtn.disabled = false;
    resourceBtn.onclick = () => {
      window.open(status.spreadsheetUrl, '_blank');
    };
    
    // Update button title for spreadsheet only
    resourceBtn.title = '„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÇíÈñã„Åè';
  }
}

// Navigate to specific step
function navigateToStep(step) {
  currentStep = step;
  
  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
    const stepNumber = index + 1;
    indicator.classList.toggle('completed', stepNumber < step);
    indicator.classList.toggle('active', stepNumber === step);
  });
  
  // Show/hide step content
  document.querySelectorAll('.step-content').forEach((content, index) => {
    const stepNumber = index + 1;
    content.classList.toggle('hidden', stepNumber !== step);
  });
  
  // Update progress bar
  const progressBar = document.querySelector('.progress-bar');
  if (progressBar) {
    progressBar.style.width = `${(step / 3) * 100}%`;
  }
  
  validateCurrentStep();
}


// „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁä∂Ê≥Å„Çí„Ç∞„É≠„Éº„Éê„É´„Çπ„ÉÜ„Éº„Çø„Çπ„Åã„ÇâÂèñÂæó




// Validate configuration
function validateConfiguration() {
  if (!currentConfig || !currentConfig.columnMappings) return false;
  
  const mappings = currentConfig.columnMappings;
  const hasContent = Object.values(mappings).includes('content');
  const hasAuthor = Object.values(mappings).includes('author');
  
  return hasContent && hasAuthor;
}


// =============================================================================
// HISTORY MANAGEMENT FUNCTIONS
// =============================================================================

// Â±•Ê≠¥ÁÆ°ÁêÜ„ÅÆÂÆöÊï∞
const HISTORY_STORAGE_KEY = 'answerBoardHistory';
const MAX_HISTORY_ITEMS = 10;

/**
 * ÂõûÁ≠î„Éú„Éº„Éâ„ÅÆÂ±•Ê≠¥„Çí‰øùÂ≠ò
 * @param {Object} historyItem - ‰øùÂ≠ò„Åô„ÇãÂ±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†
 */
function saveToHistory(historyItem) {
  try {
    if (!historyItem || !historyItem.questionText) {
      logWarn('Invalid history item, skipping save');
      return;
    }

    const history = getHistoryFromStorage();
    
    // Êñ∞„Åó„ÅÑ„Ç¢„Ç§„ÉÜ„É†„ÇíÂÖàÈ†≠„Å´ËøΩÂä†
    const newItem = {
      id: generateHistoryId(),
      timestamp: new Date().toISOString(),
      publishedAt: historyItem.publishedAt || new Date().toISOString(),
      publishedEndAt: historyItem.publishedEndAt || null,
      // Êñ∞„Åó„ÅÑ„Éï„Ç£„Éº„É´„Éâ: ÁµÇ‰∫ÜÈñ¢ÈÄ£
      endTime: historyItem.endTime || null, // ÂÆüÈöõ„ÅÆÁµÇ‰∫ÜÊó•ÊôÇÔºàÁµÇ‰∫ÜÊôÇ„Å´Ë®òÈå≤Ôºâ
      scheduledEndTime: historyItem.scheduledEndTime || null, // ‰∫àÂÆöÁµÇ‰∫ÜÊó•ÊôÇ
      questionText: historyItem.questionText,
      sheetName: historyItem.sheetName || '',
      answerCount: historyItem.answerCount || 0,
      reactionCount: historyItem.reactionCount || 0,
      config: historyItem.config || {},
      formUrl: historyItem.formUrl || '',
      spreadsheetUrl: historyItem.spreadsheetUrl || '',
      setupType: historyItem.setupType || 'unknown', // „ÇØ„Ç§„ÉÉ„ÇØ„Çπ„Çø„Éº„Éà„ÄÅ„Ç´„Çπ„Çø„É†„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÄÅÂ§ñÈÉ®„É™„ÇΩ„Éº„Çπ„ÇíË≠òÂà•
      isActive: historyItem.isActive || false // ÁèæÂú®ÂÖ¨Èñã‰∏≠„Åã„Å©„ÅÜ„Åã
    };
    
    history.unshift(newItem);
    
    // ÊúÄÂ§ßÊï∞„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÅØÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§
    if (history.length > MAX_HISTORY_ITEMS) {
      history.splice(MAX_HISTORY_ITEMS);
    }
    
    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
    logDebug('History saved:', newItem);
    
    // UI „ÇíÊõ¥Êñ∞
    loadSimpleHistoryTable();
    
  } catch (error) {
    logWarn('Failed to save history:', error);
  }
}

/**
 * Â±•Ê≠¥„Çí localStorage „Åã„ÇâÂèñÂæó
 * @returns {Array} Â±•Ê≠¥ÈÖçÂàó
 */
function getHistoryFromStorage() {
  try {
    const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
    return historyJson ? JSON.parse(historyJson) : [];
  } catch (error) {
    logWarn('Failed to parse history from storage:', error);
    return [];
  }
}

/**
 * Â±•Ê≠¥Áî®„ÅÆ„É¶„Éã„Éº„ÇØID„ÇíÁîüÊàê
 * @returns {string} „É¶„Éã„Éº„ÇØID
 */
function generateHistoryId() {
  return 'history_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// ÊóßÊù•„ÅÆ„Ç´„Éº„ÉâÂΩ¢Âºè„ÅÆÂ±•Ê≠¥Ë°®Á§∫„ÅØÂâäÈô§ - Á∞°Âçò„Å™„ÉÜ„Éº„Éñ„É´ÂΩ¢Âºè„ÅÆ„Åø‰ΩøÁî®

/**
 * Á∞°Âçò„Å™Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´„ÇíË°®Á§∫ÔºàÊñ∞ÂÆüË£ÖÔºâ
 */
/**
 * „Çµ„Éº„Éê„Éº„Åã„ÇâÂ±•Ê≠¥„ÇíÂêåÊúü„Åó„Å¶LocalStorage„Å´‰øùÂ≠ò
 */
async function syncHistoryFromServer() {
  try {
    console.log('üîÑ „Çµ„Éº„Éê„Éº„Åã„ÇâÂ±•Ê≠¥„ÇíÂêåÊúü‰∏≠...');
    
    const response = await runGasWithUserId('getHistoryFromServerAPI', '„Çµ„Éº„Éê„Éº„Åã„ÇâÂ±•Ê≠¥„ÇíÂèñÂæó‰∏≠...');
    
    if (response && response.status === 'success' && Array.isArray(response.historyArray)) {
      // „Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÂ±•Ê≠¥„ÇíLocalStorage„Å´‰øùÂ≠ò
      localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(response.historyArray));
      console.log('‚úÖ „Çµ„Éº„Éê„Éº„Åã„ÇâÂ±•Ê≠¥„ÇíÂêåÊúü„Åó„Åæ„Åó„Åü:', response.count, '‰ª∂');
      return response.historyArray;
    } else {
      console.warn('‚ö†Ô∏è „Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÂ±•Ê≠¥ÂèñÂæó„ÅßË≠¶Âëä:', response);
      return [];
    }
  } catch (error) {
    console.error('‚ùå „Çµ„Éº„Éê„ÉºÂ±•Ê≠¥ÂêåÊúü„Ç®„É©„Éº:', error);
    return [];
  }
}

function loadSimpleHistoryTable() {
  const tableBody = document.getElementById('history-table-body');
  
  if (!tableBody) return;
  
  const history = getHistoryFromStorage();
  
  // „ÉÜ„Éº„Éñ„É´„Çí„ÇØ„É™„Ç¢
  tableBody.innerHTML = '';
  
  if (history.length === 0) {
    // Â±•Ê≠¥„ÅåÁ©∫„ÅÆÂ†¥Âêà
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = `
      <td colspan="4" class="px-3 py-4 text-center text-gray-500 text-sm">
        Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
      </td>
    `;
    tableBody.appendChild(emptyRow);
    return;
  }
  
  // Â±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†„Çí„ÉÜ„Éº„Éñ„É´Ë°å„Å®„Åó„Å¶Ë°®Á§∫
  history.forEach((item, index) => {
    const row = createHistoryTableRow(item, index);
    tableBody.appendChild(row);
  });
}

/**
 * Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´Ë°å„Çí‰ΩúÊàê
 * @param {Object} item - Â±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†
 * @param {number} index - „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
 * @returns {HTMLElement} „ÉÜ„Éº„Éñ„É´Ë°åË¶ÅÁ¥†
 */
function createHistoryTableRow(item, index) {
  const row = document.createElement('tr');
  
  // ÂÖ¨Èñã‰∏≠„ÅÆÈ†ÖÁõÆ„ÅØÁ∑ëËâ≤„ÅÆ„Éè„Ç§„É©„Ç§„Éà
  const isActive = item.isActive || (!item.endTime && item.publishedAt);
  row.className = isActive 
    ? 'hover:bg-green-700/20 cursor-pointer transition-colors bg-green-900/10' 
    : 'hover:bg-gray-700/30 cursor-pointer transition-colors';
  
  row.onclick = () => selectHistoryItem(item.id);
  
  const formatDateTime = (dateString) => {
    if (!dateString) return 'Êú™Ë®≠ÂÆö';
    const date = new Date(dateString);
    return date.toLocaleString('ja-JP', {
      year: '2-digit',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  };
  
  // ÂõûÁ≠îÂΩ¢Âºè„ÅÆË°®Á§∫„É≠„Ç∏„ÉÉ„ÇØ
  const getAnswerFormatDisplay = (item) => {
    // config„Åã„ÇâÂõûÁ≠îÂΩ¢Âºè„ÇíÂà§ÂÆö
    if (item.config) {
      const config = item.config;
      if (config.showNames && config.showCounts) {
        return `<span class="text-blue-400">ÂêçÂâç„ÉªÊï∞</span>`;
      } else if (config.showNames) {
        return `<span class="text-green-400">ÂêçÂâçË°®Á§∫</span>`;
      } else if (config.showCounts) {
        return `<span class="text-purple-400">Êï∞Ë°®Á§∫</span>`;
      } else {
        return `<span class="text-gray-400">Ê®ôÊ∫ñ</span>`;
      }
    }
    // config„Åå„Å™„ÅÑÂè§„ÅÑ„Éá„Éº„Çø„ÅÆÂ†¥Âêà
    return `<span class="text-gray-500">‰∏çÊòé</span>`;
  };
  
  // Ê¥ªÂãïÁä∂Ê≥Å„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº
  const statusIndicator = isActive 
    ? `<div class="w-2 h-2 bg-green-400 rounded-full animate-pulse inline-block mr-2"></div>`
    : `<div class="w-2 h-2 bg-gray-500 rounded-full inline-block mr-2"></div>`;
  
  row.innerHTML = `
    <td class="px-3 py-2 text-xs text-gray-300">${statusIndicator}${formatDateTime(item.publishedAt)}</td>
    <td class="px-3 py-2 text-xs text-gray-300 truncate" title="${escapeHtml(item.questionText)}">${escapeHtml(item.questionText)}</td>
    <td class="px-3 py-2 text-xs text-center">${getAnswerFormatDisplay(item)}</td>
    <td class="px-3 py-2 text-xs text-center ${isActive ? 'text-green-400 font-medium' : 'text-gray-300'}">${item.answerCount || 0}</td>
  `;
  
  return row;
}

/**
 * Â±•Ê≠¥ÈÅ∏ÊäûÊôÇ„ÅÆËá™Âãï„Éï„É≠„ÉºÂá¶ÁêÜ
 * @param {string} historyId - Â±•Ê≠¥ID
 */
function selectHistoryItem(historyId) {
  try {
    const history = getHistoryFromStorage();
    const item = history.find(h => h.id === historyId);
    
    if (!item) {
      showMessage('Â±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü', 'error');
      return;
    }
    
    // Ëá™Âãï„Åß„Ç∑„Éº„Éà„ÇíÈÅ∏Êäû
    if (item.sheetName) {
      const sheetSelect = document.getElementById('sheet-select');
      if (sheetSelect) {
        sheetSelect.value = item.sheetName;
        selectedSheet = item.sheetName;
        
        // „Ç∑„Éº„ÉàÈÅ∏Êäû„Ç§„Éô„É≥„Éà„ÇíÁô∫Áîü„Åï„Åõ„Å¶„Éó„É¨„Éì„É•„Éº„ÇíË™≠„ÅøËæº„Åø
        const changeEvent = new Event('change', { bubbles: true });
        sheetSelect.dispatchEvent(changeEvent);
      }
    }
    
    // Ë®≠ÂÆö„ÇíÂæ©ÂÖÉ
    if (item.config) {
      setTimeout(() => {
        restoreConfigFromHistory(item.config);
        
        // Step 3„ÅÆË°®Á§∫Ë®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥„Å´ÁßªÂãï
        const step3Section = document.getElementById('step3-content');
        if (step3Section) {
          step3Section.classList.remove('hidden');
          step3Section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // ÁèæÂú®„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Çí3„Å´Êõ¥Êñ∞
        updateStepIndicators(3);
        manageSectionStates(3);
        
        showMessage(`„Äå${item.questionText}„Äç„ÅÆË®≠ÂÆö„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü`, 'success');
      }, 500); // „Ç∑„Éº„ÉàÈÅ∏ÊäûÂá¶ÁêÜ„ÅÆÂÆå‰∫Ü„ÇíÂæÖ„Å§
    }
    
  } catch (error) {
    logError('Failed to select history item:', error);
    showMessage('Â±•Ê≠¥„ÅÆÈÅ∏Êäû„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
}

/**
 * Â±•Ê≠¥„Åã„ÇâË®≠ÂÆö„ÇíÂæ©ÂÖÉ
 * @param {Object} config - Ë®≠ÂÆö„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
 */
function restoreConfigFromHistory(config) {
  try {
    // „Éï„Ç©„Éº„É†Ë®≠ÂÆö„ÅÆÂæ©ÂÖÉ
    if (config.opinionHeader) {
      const opinionSelect = document.getElementById('opinionHeader');
      if (opinionSelect) opinionSelect.value = config.opinionHeader;
    }
    
    if (config.nameHeader) {
      const nameSelect = document.getElementById('name-column');
      if (nameSelect) nameSelect.value = config.nameHeader;
    }
    
    if (config.classHeader) {
      const classSelect = document.getElementById('class-column');
      if (classSelect) classSelect.value = config.classHeader;
    }
    
    if (config.reasonHeader) {
      const reasonSelect = document.getElementById('reason-column');
      if (reasonSelect) reasonSelect.value = config.reasonHeader;
    }
    
    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂæ©ÂÖÉ
    const showNamesCheckbox = document.getElementById('show-names');
    if (showNamesCheckbox) showNamesCheckbox.checked = config.showNames || false;
    
    const showCountsCheckbox = document.getElementById('show-counts');
    if (showCountsCheckbox) showCountsCheckbox.checked = config.showCounts || false;
    
    // Ë®≠ÂÆö„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    updateConfigButtons();
    
  } catch (error) {
    logError('Failed to restore config from history:', error);
  }
}

// createHistoryItemElementÈñ¢Êï∞„ÅØÂâäÈô§ - „ÉÜ„Éº„Éñ„É´ÂΩ¢Âºè„ÅÆcreateHistoryTableRow„Çí‰ΩøÁî®

/**
 * HTML„Ç®„Çπ„Ç±„Éº„ÉóÈñ¢Êï∞
 * @param {string} text - „Ç®„Çπ„Ç±„Éº„Éó„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà
 * @returns {string} „Ç®„Çπ„Ç±„Éº„Éó„Åï„Çå„Åü„ÉÜ„Ç≠„Çπ„Éà
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ÊóßÊù•„ÅÆË§áÈõë„Å™Â±•Ê≠¥ÁÆ°ÁêÜÈñ¢Êï∞Áæ§„ÅØÂâäÈô§ - selectHistoryItem()„Å´„Çà„ÇãËá™Âãï„Éï„É≠„Éº„ÅÆ„Åø‰ΩøÁî®

// =============================================================================
// CONFIG JSON Ê≠£Ë¶èÂåñ„Éª‰øÆÂæ©„Ç∑„Çπ„ÉÜ„É†
// =============================================================================

/**
 * configJson„ÅÆÊï¥ÂêàÊÄß„ÇíÁ¢∫‰øù„Åó„ÄÅÁüõÁõæ„Åó„ÅüÁä∂ÊÖã„Çí‰øÆÂæ©„Åô„Çã
 * @param {Object} config - ‰øÆÂæ©ÂØæË±°„ÅÆconfig
 * @param {Object} userInfo - „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±
 * @return {Object} Ê≠£Ë¶èÂåñ„Åï„Çå„Åüconfig
 */
function normalizeConfigJson(config, userInfo) {
  if (!config || typeof config !== 'object') {
    console.warn('‚ö†Ô∏è normalizeConfigJson: ÁÑ°Âäπ„Å™config„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà');
    return config;
  }
  
  console.log('üîß configJsonÊ≠£Ë¶èÂåñÈñãÂßã:', {
    setupStatus: config.setupStatus,
    setupStep: config.setupStep,
    appPublished: config.appPublished,
    publishedSheetName: config.publishedSheetName
  });
  
  // Step 1: publishedSheetName‰øÆÂæ©
  config = fixPublishedSheetName(config);
  
  // Step 2: setupStepÂÜçË®àÁÆóÔºàÁµ±‰∏ÄÈñ¢Êï∞‰ΩøÁî®Ôºâ
  // Note: setupStep„ÅØË®àÁÆó„Éó„É≠„Éë„ÉÜ„Ç£„Å®„Åó„Å¶Â∏∏„Å´ÂãïÁöÑ„Å´ÁÆóÂá∫„Åï„Çå„ÄÅconfigJson„Å´„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì
  
  // Step 3: „Ç∞„É≠„Éº„Éê„É´ÂàóË®≠ÂÆöÂêåÊúü
  config = syncGlobalColumnSettings(config);
  
  // Step 4: ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆË£úÂÆå
  config = ensureRequiredFields(config);
  
  // Step 5: ÂÜóÈï∑„Éï„Ç£„Éº„É´„Éâ„ÅÆÂâäÈô§
  config = removeRedundantFields(config);
  
  console.log('‚úÖ configJsonÊ≠£Ë¶èÂåñÂÆå‰∫Ü:', {
    setupStatus: config.setupStatus,
    appPublished: config.appPublished,
    publishedSheetName: config.publishedSheetName,
    setupStep: 'Ë®àÁÆó„Éó„É≠„Éë„ÉÜ„Ç£: ' + determineSetupStepUnified(userInfo, config)
  });
  
  return config;
}

/**
 * ÂÜóÈï∑„Éï„Ç£„Éº„É´„Éâ„ÅÆÂâäÈô§Ôºà„Éá„Éº„ÇøÊï¥ÂêàÊÄßÂêë‰∏äÔºâ
 * @param {Object} config - ÂØæË±°config
 * @return {Object} „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Åï„Çå„Åüconfig
 */
function removeRedundantFields(config) {
  const cleanConfig = { ...config };
  
  // setupStep„ÅØË®àÁÆó„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆ„Åü„ÇÅ„ÄÅ‰øùÂ≠òÊ∏à„Åø„ÅÆÂÄ§„ÇíÂâäÈô§
  delete cleanConfig.setupStep;
  
  console.log('üßπ ÂÜóÈï∑„Éï„Ç£„Éº„É´„ÉâÂâäÈô§: setupStep');
  
  return cleanConfig;
}

/**
 * ConfigJson„ÅÆÊï¥ÂêàÊÄßÊ§úË®ºÊ©üËÉΩÔºà„Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÂ∞ÇÁî®Ôºâ
 * @param {Object} config - Ê§úË®ºÂØæË±°„ÅÆconfig
 * @param {Object} userInfo - „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±
 */
function validateConfigJsonIntegrity(config, userInfo) {
  if (!config || !userInfo) {
    console.warn('‚ö†Ô∏è Êï¥ÂêàÊÄßÊ§úË®º: ÁÑ°Âäπ„Å™„Éë„É©„É°„Éº„Çø');
    return;
  }
  
  const setupStatus = config.setupStatus || 'pending';
  const formCreated = !!config.formCreated;
  const appPublished = !!config.appPublished;
  const hasFormUrl = !!(config.formUrl && config.formUrl.trim());
  const hasPublishedSheet = !!(config.publishedSheetName && config.publishedSheetName.trim());
  const hasSpreadsheet = !!(userInfo.spreadsheetId && userInfo.spreadsheetId.trim());
  
  console.group('üîç ConfigJsonÊï¥ÂêàÊÄßÊ§úË®º');
  
  // Âü∫Êú¨Áä∂ÊÖã„ÅÆË°®Á§∫
  console.log('üìä ÁèæÂú®„ÅÆÁä∂ÊÖã:', {
    setupStatus,
    formCreated,
    appPublished,
    hasFormUrl,
    hasPublishedSheet,
    hasSpreadsheet
  });
  
  // ÈáçË¶Å„Å™‰∏çÊï¥Âêà„ÇíÊ§úÂá∫
  const issues = [];
  
  if (setupStatus === 'completed' && !formCreated) {
    issues.push('‚ùå setupStatus=completed„Å™„ÅÆ„Å´formCreated=false');
  }
  
  if (formCreated && !hasFormUrl) {
    issues.push('‚ùå formCreated=true„Å™„ÅÆ„Å´formUrl„ÅåÊú™Ë®≠ÂÆö');
  }
  
  if (appPublished && !hasPublishedSheet) {
    issues.push('‚ùå appPublished=true„Å™„ÅÆ„Å´publishedSheetName„ÅåÊú™Ë®≠ÂÆö');
  }
  
  if (!hasSpreadsheet && (setupStatus === 'completed' || formCreated || appPublished)) {
    issues.push('‚ùå „Éá„Éº„Çø„ÇΩ„Éº„ÇπÊú™Ë®≠ÂÆö„Å™„ÅÆ„Å´È´òÂ∫¶„Å™Ë®≠ÂÆö„ÅåÊúâÂäπ');
  }
  
  // setupStep„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆË≠¶Âëä
  if (config.setupStep !== undefined) {
    issues.push('‚ö†Ô∏è setupStep„ÅåconfigJson„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºàÂÜóÈï∑Ôºâ');
  }
  
  // ÁµêÊûúË°®Á§∫
  if (issues.length === 0) {
    console.log('‚úÖ Êï¥ÂêàÊÄßÊ§úË®ºÂÆå‰∫Ü: ÂïèÈ°å„Å™„Åó');
  } else {
    console.warn('‚ö†Ô∏è Êï¥ÂêàÊÄßÂïèÈ°åÊ§úÂá∫:', issues);
  }
  
  console.groupEnd();
}

/**
 * publishedSheetName‰øÆÂæ©Èñ¢Êï∞
 * @param {Object} config - ‰øÆÂæ©ÂØæË±°„ÅÆconfig
 * @return {Object} ‰øÆÂæ©„Åï„Çå„Åüconfig
 */
function fixPublishedSheetName(config) {
  // publishedSheetName„ÅåÁ©∫ÊñáÂ≠ó„Åæ„Åü„ÅØÊú™ÂÆöÁæ©„Åß„ÄÅsheetÂõ∫ÊúâË®≠ÂÆö„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà
  if ((!config.publishedSheetName || config.publishedSheetName.trim() === '') && 
      config.publishedSpreadsheetId) {
    
    // sheet_„ÅßÂßã„Åæ„Çã„Ç≠„Éº„ÇíÊ§úÁ¥¢
    const sheetKeys = Object.keys(config).filter(key => key.startsWith('sheet_'));
    
    if (sheetKeys.length > 0) {
      // ÊúÄÂàù„Å´Ë¶ã„Å§„Åã„Å£„Åü„Ç∑„Éº„ÉàÂêç„Çí‰ΩøÁî®
      const detectedSheetName = sheetKeys[0].replace('sheet_', '');
      config.publishedSheetName = detectedSheetName;
      
      console.log('üîß publishedSheetName‰øÆÂæ©:', {
        Ê§úÂá∫„Åï„Çå„Åü„Ç∑„Éº„ÉàÂêç: detectedSheetName,
        Âà©Áî®ÂèØËÉΩ„Å™„Ç∑„Éº„ÉàË®≠ÂÆö: sheetKeys
      });
    }
  }
  
  return config;
}

/**
 * setupStepÂà§ÂÆö„ÅÆÁµ±‰∏ÄÂåñ„Åï„Çå„Åü„Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÂÆüË£Ö
 * „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅÆdetermineSetupStepUnified()„Å®ÂÆåÂÖ®„Å´ÂêåÊúü
 * @param {Object} userInfo - „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±
 * @param {Object} config - configÊÉÖÂ†±
 * @return {number} setupStep
 */
function determineSetupStepUnified(userInfo, config) {
  // Step 1: „Éá„Éº„Çø„ÇΩ„Éº„ÇπÊú™Ë®≠ÂÆö
  if (!userInfo || !userInfo.spreadsheetId || userInfo.spreadsheetId.trim() === '') {
    console.log('üîß setupStepÁµ±‰∏ÄÂà§ÂÆö(FE): Step 1 - „Éá„Éº„Çø„ÇΩ„Éº„ÇπÊú™Ë®≠ÂÆö');
    return 1;
  }
  
  // config„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÂøÖ„ÅöStep 2
  if (!config || typeof config !== 'object') {
    console.log('üîß setupStepÁµ±‰∏ÄÂà§ÂÆö(FE): Step 2 - configÊú™Ë®≠ÂÆö');
    return 2;
  }
  
  const setupStatus = config.setupStatus || 'pending';
  const formCreated = !!config.formCreated;
  const hasFormUrl = !!(config.formUrl && config.formUrl.trim());
  
  // Step 2Êù°‰ª∂: ÊòéÁ§∫ÁöÑ„Å™Âà§ÂÆöÔºà„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å®ÂÆåÂÖ®ÂêåÊúüÔºâ
  const isStep2 = (
    setupStatus === 'pending' ||      // ÊòéÁ§∫ÁöÑ„Å™Êú™ÂÆå‰∫ÜÁä∂ÊÖã
    setupStatus === 'reconfiguring' || // ÂÜçË®≠ÂÆö‰∏≠
    setupStatus === 'error' ||        // „Ç®„É©„ÉºÁä∂ÊÖã
    !formCreated ||                   // „Éï„Ç©„Éº„É†Êú™‰ΩúÊàê
    !hasFormUrl                       // „Éï„Ç©„Éº„É†URLÊú™Ë®≠ÂÆö
  );
  
  if (isStep2) {
    console.log('üîß setupStepÁµ±‰∏ÄÂà§ÂÆö(FE): Step 2 - „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊú™ÂÆå‰∫Ü', {
      setupStatus,
      formCreated,
      hasFormUrl
    });
    return 2;
  }
  
  // Step 3: „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫ÜÔºà„Åô„Åπ„Å¶„ÅÆÊù°‰ª∂„Çí„ÇØ„É™„Ç¢Ôºâ
  if (setupStatus === 'completed' && formCreated && hasFormUrl) {
    console.log('üîß setupStepÁµ±‰∏ÄÂà§ÂÆö(FE): Step 3 - „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü');
    return 3;
  }
  
  // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ‰∏çÊòé„Å™Áä∂ÊÖã„ÅØStep 2„Å®„Åó„Å¶Êâ±„ÅÜ
  console.log('üîß setupStepÁµ±‰∏ÄÂà§ÂÆö(FE): „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ - Step 2', {
    setupStatus,
    formCreated,
    hasFormUrl
  });
  return 2;
}


/**
 * „Ç∞„É≠„Éº„Éê„É´ÂàóË®≠ÂÆö„ÇíÊúÄÊñ∞„ÅÆ„Ç∑„Éº„ÉàË®≠ÂÆö„Å®ÂêåÊúü
 * @param {Object} config - ÂêåÊúüÂØæË±°„ÅÆconfig
 * @return {Object} ÂêåÊúü„Åï„Çå„Åüconfig
 */
function syncGlobalColumnSettings(config) {
  if (!config.publishedSheetName) {
    return config; // „Ç∑„Éº„ÉàÂêç„Åå‰∏çÊòé„Å™Â†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
  }
  
  const sheetConfigKey = `sheet_${config.publishedSheetName}`;
  const sheetConfig = config[sheetConfigKey];
  
  if (sheetConfig && typeof sheetConfig === 'object') {
    // „Ç∑„Éº„ÉàÂõ∫ÊúâË®≠ÂÆö„Çí„Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö„Å´ÂêåÊúü
    config.opinionHeader = sheetConfig.opinionHeader || config.opinionHeader || '';
    config.nameHeader = sheetConfig.nameHeader || config.nameHeader || '';
    config.reasonHeader = sheetConfig.reasonHeader || config.reasonHeader || '';
    config.classHeader = sheetConfig.classHeader || config.classHeader || '';
    config.timestampHeader = sheetConfig.timestampHeader || config.timestampHeader || '';
    
    // „Éï„Ç©„Éº„É†URLÂêåÊúü - „Ç∑„Éº„ÉàÂõ∫Êúâ„ÅÆformUrl„Çí„Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö„Å´ÂêåÊúü
    if (sheetConfig.formUrl) {
      config.formUrl = sheetConfig.formUrl;
      console.log('üîó „Éï„Ç©„Éº„É†URLÂêåÊúü:', {
        „Ç∑„Éº„ÉàÂêç: config.publishedSheetName,
        „Éï„Ç©„Éº„É†URL: config.formUrl
      });
    }
    
    console.log('üîß „Ç∞„É≠„Éº„Éê„É´ÂàóË®≠ÂÆöÂêåÊúüÂÆå‰∫Ü:', {
      „Ç∑„Éº„ÉàÂêç: config.publishedSheetName,
      „É°„Ç§„É≥Ë≥™Âïè: config.opinionHeader,
      ÂêçÂâçÂàó: config.nameHeader
    });
  }
  
  return config;
}

/**
 * ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆË£úÂÆå
 * @param {Object} config - Ë£úÂÆåÂØæË±°„ÅÆconfig
 * @return {Object} Ë£úÂÆå„Åï„Çå„Åüconfig
 */
function ensureRequiredFields(config) {
  const defaults = {
    showNames: false,
    showCounts: false,
    highlightMode: false,
    autoStopEnabled: true,
    autoStopMinutes: 360
  };
  
  Object.keys(defaults).forEach(key => {
    if (config[key] === undefined) {
      config[key] = defaults[key];
    }
  });
  
  return config;
}

/**
 * UIÁä∂ÊÖã„ÅÆÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ„Å®‰øÆÂæ©
 * @param {Object} status - „Çπ„ÉÜ„Éº„Çø„ÇπÊÉÖÂ†±
 * @return {Object} ‰øÆÂæ©„Åï„Çå„Åü„Çπ„ÉÜ„Éº„Çø„Çπ
 */
function validateAndFixUIState(status) {
  if (!status || !status.config) {
    return status;
  }
  
  // configJson„ÇíÊ≠£Ë¶èÂåñ
  status.config = normalizeConfigJson(status.config, status.userInfo);
  
  // configJson„ÅÆÊï¥ÂêàÊÄßÊ§úË®º
  validateConfigJsonIntegrity(status.config, status.userInfo);
  
  // UIË¶ÅÁ¥†„ÅÆÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
  const expectedStep = determineSetupStepUnified(status.userInfo, status.config);
  const currentUIStep = parseInt(document.querySelector('.step-indicator.active')?.textContent) || 1;
  
  if (expectedStep !== currentUIStep) {
    console.log('üîß UIÁä∂ÊÖã‰øÆÂæ©: setupStep‰∏çÊï¥ÂêàÊ§úÂá∫', {
      ÊúüÂæÖÂÄ§: expectedStep,
      ÁèæÂú®„ÅÆUI: currentUIStep
    });
    
    // UIÁä∂ÊÖã„ÇíÊ≠£„Åó„ÅÑ„Çπ„ÉÜ„ÉÉ„Éó„Å´Êõ¥Êñ∞
    updateStepIndicators(expectedStep, status);
  }
  
  return status;
}

// Á∞°Âçò„Å™Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
  // „Çµ„Éº„Éê„Éº„Åã„ÇâÂ±•Ê≠¥„ÇíÂêåÊúü„Åó„Å¶„Åã„Çâ„ÉÜ„Éº„Éñ„É´„ÇíË™≠„ÅøËæº„Åø
  syncHistoryFromServer()
    .then(function(syncedHistory) {
      console.log('üîÑ „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂ±•Ê≠¥ÂêåÊúüÂÆå‰∫Ü:', syncedHistory.length, '‰ª∂');
      loadSimpleHistoryTable();
    })
    .catch(function(syncError) {
      console.warn('‚ö†Ô∏è „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂ±•Ê≠¥ÂêåÊúü„Å´Â§±Êïó„ÄÅ„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÅßË°®Á§∫:', syncError);
      loadSimpleHistoryTable();
    });
});

// ÂàùÊúüÂåñ„ÅØ adminPanel-core.js „ÅÆÁµ±ÂêàÂàùÊúüÂåñ„Ç∑„Çπ„ÉÜ„É†„ÅßÁÆ°ÁêÜ„Åï„Çå„Åæ„Åô
</script>
