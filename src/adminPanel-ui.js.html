<script>
let lastSelectedSheetName = null; // To prevent redundant sheet selection change events

// UI Update Mutex to prevent race conditions
let isUIUpdateInProgress = false;
let pendingUIUpdate = null;

// =============================================================================
// ADMIN PANEL UI UPDATES & DISPLAY CONTROL
// =============================================================================

// =============================================================================
// UTILITY FUNCTIONS
// =============================================================================

// Unified publication state detection
function getPublicationState(status) {
  if (!status) {
    return { isPublished: false, reason: 'No status data' };
  }

  // Check multiple possible publication indicators in priority order
  let isPublished = false;
  let reason = '';

  // 1. Direct isPublished property
  if (status.isPublished === true) {
    isPublished = true;
    reason = 'status.isPublished=true';
  }
  // 2. Direct appPublished property
  else if (status.appPublished === true) {
    isPublished = true;
    reason = 'status.appPublished=true';
  }
  // 3. Check configJson for appPublished
  else if (status.userInfo?.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      if (config.appPublished === true) {
        isPublished = true;
        reason = 'configJson.appPublished=true';
      }
    } catch (e) {
      console.warn('Failed to parse configJson:', e);
    }
  }

  // 4. Fallback: if there's an active sheet, likely published
  if (!isPublished && status.activeSheetName) {
    isPublished = true;
    reason = 'activeSheetName exists (fallback)';
  }

  return { isPublished, reason };
}

// Generate viewUrl with comprehensive fallback logic
function generateViewUrl(status, userId) {
  // 1. Use existing viewUrl if available
  let viewUrl = status.appUrls?.viewUrl;
  if (viewUrl) {
    return viewUrl;
  }

  // 2. Generate from appUrls.webApp with userId
  if (status.appUrls?.webApp && userId) {
    return status.appUrls.webApp + '?userId=' + encodeURIComponent(userId) + '&mode=view';
  }

  // 3. Generate from status.webAppUrl with userId
  if (status.webAppUrl && userId) {
    return status.webAppUrl + '?userId=' + encodeURIComponent(userId) + '&mode=view';
  }

  // 4. Simple fallback without userId
  if (status.appUrls?.webApp) {
    return status.appUrls.webApp + '?mode=view';
  }

  logWarn('Could not generate viewUrl');
  return null;
}

// =============================================================================
// MAIN UI UPDATE FUNCTIONS
// =============================================================================

// Update UI with new status data
function updateUIWithNewStatus(status) {
  if (!validateStatus(status)) {
    logWarn('Invalid status received, skipping UI update');
    return;
  }

  // UI Update Mutex: Prevent concurrent UI updates
  if (isUIUpdateInProgress) {
    logDebug('UI update in progress, queuing this update');
    pendingUIUpdate = status;
    return;
  }

  isUIUpdateInProgress = true;

  try {
    // Standardize status object with publication state and viewUrl
    const publicationState = getPublicationState(status);
    const viewUrl = generateViewUrl(status, userId);

    // Add normalized properties to status object
    status._normalized = {
      isPublished: publicationState.isPublished,
      publishReason: publicationState.reason,
      viewUrl: viewUrl,
      hasValidViewUrl: !!viewUrl
    };

    currentStatus = status;

  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ç¢ºèª
  const setupStatus = getSetupStatusFromUserInfo(status.userInfo);

  // å›ºå®šè¡¨ç¤ºè¦ç´ ã‚’ã‚¯ãƒªã‚¢ï¼ˆsetupStatusé–¢ä¿‚ãªãå®Ÿè¡Œï¼‰
  clearInitialDisplayElements();

  // Update static UI elements firstï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
  updateStaticUI(status);

  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†æ™‚ã®è¿½åŠ å‡¦ç†
  if (setupStatus === 'pending') {
    updateButtonStatesForSetup(status);
  }

  // Update dynamic content based on state
  if (status.activeSheetName) {
    updateDynamicContent(status);
  } else {
    updateUIForNoActiveSheet(status);
  }

  // Update footer and guidance
  updateFooterAndGuidance(status);

  // Update step indicators and manage sections
  const currentStep = status.setupStep || 1;
  updateStepIndicators(currentStep);
  manageSectionStates(currentStep);

  // Update spreadsheet button state
  updateSpreadsheetButton();

  // Update unpublish button state
  updateUnpublishButton(status);

    // If an active sheet is set on initial load, load its configuration
    if (status.activeSheetName && status.userInfo && status.userInfo.spreadsheetId) {
      selectedSheet = status.activeSheetName;
      loadConfigForSelected(status.activeSheetName, status.userInfo.spreadsheetId);
    }

  } finally {
    // Release the UI update mutex
    isUIUpdateInProgress = false;

    // Process any pending UI update
    if (pendingUIUpdate) {
      const nextUpdate = pendingUIUpdate;
      pendingUIUpdate = null;
      logDebug('Processing queued UI update');
      setTimeout(() => updateUIWithNewStatus(nextUpdate), 0);
    }
  }
}

// Update unpublish button state
function updateUnpublishButton(status) {
  const unpublishBtn = document.getElementById('unpublish-board-btn');
  if (!unpublishBtn) return;

  if (status._normalized?.isPublished) {
    unpublishBtn.classList.remove('hidden');
  } else {
    unpublishBtn.classList.add('hidden');
  }
}

// Update spreadsheet access button state
function updateSpreadsheetButton() {
  const btn = document.getElementById('open-spreadsheet-btn-step2');
  if (!btn) return;

  if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetUrl) {
    btn.disabled = false;
    btn.onclick = function() {
      window.open(currentStatus.userInfo.spreadsheetUrl, '_blank');
    };
    console.log('âœ… Spreadsheet button enabled with URL:', currentStatus.userInfo.spreadsheetUrl);
  } else {
    btn.disabled = true;
    btn.onclick = null;
    console.log('âš ï¸ Spreadsheet button disabled - no URL available');
  }
}

// Update static UI elements
function updateStaticUI(status) {
  // Update database info panel
  updateDatabaseInfo(status);

  // Update existing user section
  updateExistingUserSection(status);

  // Populate sheet selection - fix property name mismatch
  console.log('ğŸ” Debug: Checking sheet data properties', {
    allSheets: status.allSheets,
    sheetNames: status.sheetNames,
    activeSheetName: status.activeSheetName
  });

  const sheetsData = status.sheetNames || status.allSheets || [];
  populateSheetSelect(sheetsData, status.activeSheetName);

  // Update custom form info
  updateCustomFormInfo(status);

  // Check for auto-publish dialog
  checkAutoPublishDialog(status);
}

// =============================================================================
// DATABASE INFO PANEL UPDATES
// =============================================================================

function updateDatabaseInfo(status) {
  if (!status || !status.userInfo) {
    console.warn('System info update failed: No user info available');
    return;
  }

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’è¨­å®š
  if (status.userInfo.spreadsheetUrl) {
    currentSpreadsheetUrl = status.userInfo.spreadsheetUrl;
  }

  const cfg = status.config || {};

  // åŸºæœ¬æƒ…å ±ã®æ›´æ–°
  safeSetText('info-admin-email', status.userInfo.adminEmail);
  safeSetText('info-user-id', status.userInfo.userId);
  safeSetText('info-published-sheet', cfg.publishedSheetName || status.publishedSheetName || 'ãªã—');
  safeSetText('info-answer-count', status.answerCount || '0');
  safeSetText('info-reaction-count', status.totalReactions || '0');

  // å…¬é–‹çŠ¶æ…‹ã®è¡¨ç¤ºã‚’æ›´æ–°
  const isPublished = cfg.isPublished !== undefined
    ? cfg.isPublished
    : status.appPublished || status.isPublished || (status.activeSheetName && (cfg.publishedSheetName || status.publishedSheetName));
  updatePublicationStatusUI(isPublished);

  // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®æ›´æ–°
  const displayModeFlag = cfg.showNames !== undefined ? cfg.showNames : status.showNames;
  const displayMode = displayModeFlag ? 'åå‰è¡¨ç¤º' : 'åŒ¿åè¡¨ç¤º';
  safeSetText('info-display-mode', displayMode);

  // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã®æ›´æ–°
  const showCountsFlag = cfg.showCounts !== undefined
    ? cfg.showCounts
    : (status.showCounts !== undefined ? status.showCounts : true);
  const showCounts = showCountsFlag ? 'è¡¨ç¤º' : 'éè¡¨ç¤º';
  safeSetText('info-show-counts', showCounts);

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹åŒæœŸ
  syncCheckboxStates(status);
}

// Update publication status UI
function updatePublicationStatusUI(isPublished) {
  const statusElement = safeGetElement('info-publish-status');
  const indicatorElement = safeGetElement('info-publish-indicator');
  const textElement = safeGetElement('info-publish-text');

  if (statusElement) {
    if (isPublished) {
      statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-green-600 text-white';
      if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-green-400';
      if (textElement) textElement.textContent = 'å…¬é–‹ä¸­';
    } else {
      statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-gray-600 text-gray-300';
      if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      if (textElement) textElement.textContent = 'éå…¬é–‹';
    }
  }
}

// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åŒæœŸã™ã‚‹é–¢æ•°
function syncCheckboxStates(status) {
  // Priority: Database config (configJson) > status properties > defaults
  let showNames = false;
  let showCounts = true;

  // 1. Prefer status.config if available
  if (status.config) {
    if (status.config.showNames !== undefined) showNames = status.config.showNames;
    if (status.config.showCounts !== undefined) showCounts = status.config.showCounts;
  } else if (status.userInfo?.configJson) {
    // 2. Fallback to raw configJson
    try {
      const config = JSON.parse(status.userInfo.configJson);
      if (config.showNames !== undefined) showNames = config.showNames;
      if (config.showCounts !== undefined) showCounts = config.showCounts;
    } catch (e) {
      logWarn('Failed to parse configJson, using status properties');
      if (status.showNames !== undefined) showNames = status.showNames;
      if (status.showCounts !== undefined) showCounts = status.showCounts;
    }
  } else {
    // 3. Use status properties as last resort
    if (status.showNames !== undefined) showNames = status.showNames;
    if (status.showCounts !== undefined) showCounts = status.showCounts;
  }

  // Update checkbox elements
  const showNamesCheckbox = safeGetElement('show-names');
  const showCountsCheckbox = safeGetElement('show-counts');

  if (showNamesCheckbox) {
    showNamesCheckbox.checked = showNames;
  }

  if (showCountsCheckbox) {
    showCountsCheckbox.checked = showCounts;
  }
}

// =============================================================================
// SHEET SELECTION AND CONFIGURATION
// =============================================================================

// Populate sheet selection dropdown
function populateSheetSelect(sheetNames, activeSheetName) {
  const select = document.getElementById('sheet-select');
  if (!select) {
    logWarn('Sheet select element not found');
    return;
  }

  console.log('ğŸ“‹ Populating sheet select with data:', {
    sheetNames: sheetNames,
    activeSheetName: activeSheetName,
    dataType: typeof sheetNames,
    isArray: Array.isArray(sheetNames)
  });

  // Clear existing options
  select.innerHTML = '<option value="">-- ã‚·ãƒ¼ãƒˆã‚’é¸æŠ --</option>';

  if (sheetNames && sheetNames.length > 0) {
    console.log('âœ… Adding sheets to dropdown:', sheetNames.length);

    sheetNames.forEach((sheet, index) => {
      const option = document.createElement('option');

      // Handle both object and string formats
      if (typeof sheet === 'object' && sheet.name) {
        option.value = sheet.name;
        option.textContent = sheet.name;
        console.log(`ğŸ“„ Sheet ${index + 1}: ${sheet.name} (ID: ${sheet.id})`);
      } else if (typeof sheet === 'string') {
        option.value = sheet;
        option.textContent = sheet;
        console.log(`ğŸ“„ Sheet ${index + 1}: ${sheet}`);
      } else {
        console.warn('âš ï¸ Unknown sheet format:', sheet);
        return;
      }

      select.appendChild(option);
    });
    select.disabled = false;
    console.log('âœ… Sheet dropdown populated successfully');
  } else {
    console.warn('âš ï¸ No sheets available:', sheetNames);
    select.innerHTML = '<option value="">åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
    select.disabled = true;
  }

  // Set active sheet if available
  if (activeSheetName) {
    select.value = activeSheetName;
    selectedSheet = activeSheetName;
    lastSelectedSheetName = activeSheetName; // Update last selected sheet
    console.log('âœ… Active sheet set:', activeSheetName);
  }

  // Add change event listener for data preview
  select.removeEventListener('change', handleSheetSelectionChange);
  select.addEventListener('change', handleSheetSelectionChange);

  // Update UI for selected sheet and enable spreadsheet button
  updateUIForSelectedSheet();
  updateSpreadsheetButton();
}

// Populate header options for configuration
function populateHeaderOptions(headers) {
  console.group('ğŸ¯ populateHeaderOptions');
  console.log('ğŸ“ Headers to populate:', headers.length, headers);

  const selects = [
    'opinionHeader',      // Main required field
    'opinion-column',     // Optional details field (backup)
    'name-column',
    'class-column'
  ];

  console.log('ğŸ¯ Target dropdown elements:', selects);

  selects.forEach(selectId => {
    console.log(`ğŸ” Looking for element: ${selectId}`);
    const select = document.getElementById(selectId);

    if (select) {
      console.log(`âœ… Found element: ${selectId}`);

      // Store current value
      const currentValue = select.value;
      console.log(`ğŸ“„ Current value: "${currentValue}"`);

      // Clear and repopulate
      select.innerHTML = '<option value="">-- åˆ—ã‚’é¸æŠ --</option>';
      console.log(`ğŸ§¹ Cleared dropdown: ${selectId}`);

      let optionsAdded = 0;
      const excludedHeaders = [
        'ãªã‚‹ã»ã©ï¼',
        'ã„ã„ã­ï¼',
        'ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ï¼',
        'ãƒã‚¤ãƒ©ã‚¤ãƒˆ',
        'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', // ãƒ•ã‚©ãƒ¼ãƒ ã§è‡ªå‹•åé›†ã•ã‚Œã‚‹ãŸã‚ã€ãƒãƒƒãƒ”ãƒ³ã‚°å¯¾è±¡ã‹ã‚‰é™¤å¤–
        'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—' // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ã«ã‚ˆã‚Šé™¤å¤–
      ];

      const filteredHeaders = headers.filter(header => !excludedHeaders.includes(header));

      filteredHeaders.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
        optionsAdded++;
      });

      console.log(`ğŸ“‹ Added ${optionsAdded} options to ${selectId}`);
      console.log(`ğŸ“Š Total options in ${selectId}:`, select.options.length);

      // Restore previous value if still valid
      if (currentValue && headers.includes(currentValue)) {
        select.value = currentValue;
        console.log(`â™»ï¸ Restored value: "${currentValue}" for ${selectId}`);
      }

      // Debug final state
      console.log(`ğŸ¯ Final state of ${selectId}:`, {
        value: select.value,
        optionsCount: select.options.length,
        visible: !select.hidden,
        disabled: select.disabled
      });

    } else {
      console.error(`âŒ Element not found: ${selectId}`);
    }
  });

  console.groupEnd();
}

// Populate configuration with guessed values
function populateConfig(cfg) {
  if (!cfg) return;

  console.group('ğŸ¤– populateConfig');
  console.log('ğŸ“ AI Config received:', cfg);

  const mappings = {
    // Main opinion dropdown (primary target)
    'opinionHeader': cfg.opinionHeader || cfg.opinionColumn,

    // Detail configuration dropdowns (secondary targets with property name fixes)
    'opinion-column': cfg.opinionColumn || cfg.opinionHeader,
    'name-column': cfg.nameColumn || cfg.nameHeader,
    'class-column': cfg.classColumn || cfg.classHeader,
    'show-names': cfg.showNames,
    'show-counts': cfg.showCounts
  };

  console.log('ğŸ¯ Mappings to apply:', mappings);

  Object.keys(mappings).forEach(elementId => {
    const element = document.getElementById(elementId);
    const value = mappings[elementId];

    console.log(`ğŸ” Setting ${elementId}:`, {
      element: !!element,
      value: value,
      valueType: typeof value
    });

    if (element && value !== undefined) {
      if (element.type === 'checkbox') {
        element.checked = Boolean(value);
        console.log(`â˜‘ï¸ Checkbox ${elementId} set to:`, element.checked);
      } else {
        element.value = value;
        console.log(`ğŸ“‹ Dropdown ${elementId} set to:`, element.value);

        // Verify the option exists in the dropdown
        const hasOption = Array.from(element.options).some(option => option.value === value);
        if (!hasOption) {
          console.warn(`âš ï¸ Option "${value}" not found in ${elementId} dropdown`);
          console.log(`Available options:`, Array.from(element.options).map(opt => opt.value));
        } else {
          console.log(`âœ… Option "${value}" successfully selected in ${elementId}`);
        }
      }
    } else {
      if (!element) {
        console.warn(`âŒ Element not found: ${elementId}`);
      }
      if (value === undefined) {
        console.log(`âšª No value for: ${elementId}`);
      }
    }
  });

  console.groupEnd();
  updateConfigButtons();
}

// Clear configuration fields
function clearConfigFields() {
  const fieldIds = [
    'opinionHeader',      // Main required field
    'opinion-column',
    'name-column',
    'class-column'
  ];

  fieldIds.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.value = '';
    }
  });

  updateConfigButtons();
}

// Build configuration object from form
function buildConfigObject() {
  console.group('ğŸ“‹ buildConfigObject');

  // Get values from primary elements (with fallback to secondary elements)
  const opinionValue = document.getElementById('opinionHeader')?.value ||
                      document.getElementById('opinion-column')?.value || '';
  const nameValue = document.getElementById('name-column')?.value || '';
  const classValue = document.getElementById('class-column')?.value || '';
  const showNames = document.getElementById('show-names')?.checked || false;
  const showCounts = document.getElementById('show-counts')?.checked || false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆfalseã«å¤‰æ›´

  const config = {
    sheetName: selectedSheet,
    // Use property names that match backend expectations (opinionHeader format)
    opinionHeader: opinionValue,
    nameHeader: nameValue,
    classHeader: classValue,
    // Also provide legacy format for backward compatibility
    opinionColumn: opinionValue,
    nameColumn: nameValue,
    classColumn: classValue,
    showNames: showNames,
    showCounts: showCounts
  };

  console.log('ğŸ“Š Built config object:', config);
  console.log('ğŸ¯ Primary opinion value from opinionHeader:', document.getElementById('opinionHeader')?.value);
  console.log('ğŸ”„ Fallback opinion value from opinion-column:', document.getElementById('opinion-column')?.value);
  console.groupEnd();

  return config;
}

// Validate configuration
function validateConfig() {
  // Check primary element first, then fallback to secondary element
  const opinionValue = document.getElementById('opinionHeader')?.value ||
                      document.getElementById('opinion-column')?.value || '';

  const isValid = opinionValue && opinionValue.trim() !== '';

  console.log('ğŸ” validateConfig:', {
    opinionHeader: document.getElementById('opinionHeader')?.value,
    opinionColumn: document.getElementById('opinion-column')?.value,
    finalValue: opinionValue,
    isValid: isValid
  });

  return isValid;
}

// Update configuration buttons state
function updateConfigButtons() {
  const isValid = validateConfig();
  const saveBtn = document.getElementById('save-publish-btn');

  if (saveBtn) {
    saveBtn.disabled = !isValid;
    if (isValid) {
      saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }
}

// =============================================================================
// STEP INDICATORS AND GUIDANCE
// =============================================================================

// Update step indicators
function updateStepIndicators(currentStep) {
  const steps = [
    document.getElementById('step-1-indicator'),
    document.getElementById('step-2-indicator'),
    document.getElementById('step-3-indicator')
  ];

  steps.forEach((step, index) => {
    if (!step) return;

    const stepNumber = index + 1;
    const circle = step.querySelector('div');
    const text = step.querySelector('span');

    if (stepNumber < currentStep) {
      // å®Œäº†ã—ãŸã‚¹ãƒ†ãƒƒãƒ—
      if (circle) {
        circle.className = 'w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all';
      }
      if (text) {
        text.classList.remove('text-gray-500');
        text.classList.add('text-gray-300');
      }
    } else if (stepNumber === currentStep) {
      // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—
      if (circle) {
        circle.className = 'w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all ring-2 ring-blue-400 ring-offset-2 ring-offset-gray-800';
      }
      if (text) {
        text.classList.remove('text-gray-500');
        text.classList.add('text-white', 'font-semibold');
      }
    } else {
      // æœªå®Œäº†ã®ã‚¹ãƒ†ãƒƒãƒ—
      if (circle) {
        circle.className = 'w-6 h-6 bg-gray-600 text-gray-400 rounded-full flex items-center justify-center font-bold text-xs transition-all';
      }
      if (text) {
        text.classList.remove('text-white', 'font-semibold');
        text.classList.add('text-gray-500');
      }
    }
  });
}

// Update footer and guidance text
function updateFooterAndGuidance(status) {
  console.group('ğŸ¦¶ updateFooterAndGuidance');

  const footer = document.getElementById('admin-footer');
  const guidanceText = document.getElementById('guidance-text');

  if (!footer || !guidanceText) {
    console.warn('âŒ Footer or guidance elements not found');
    console.groupEnd();
    return;
  }

  // Use normalized publication state from status object
  const isPublished = status._normalized?.isPublished || false;
  const viewUrl = status._normalized?.viewUrl;

  console.log('ğŸ” Simplified publication check:', {
    'normalized isPublished': isPublished,
    'publish reason': status._normalized?.publishReason,
    'normalized viewUrl': viewUrl,
    'has valid viewUrl': status._normalized?.hasValidViewUrl,
    'will show footer': isPublished
  });

  // Show footer if published (regardless of viewUrl availability for now)
  if (isPublished) {
    footer.classList.remove('hidden');

    // Update board URL using our generated viewUrl (if available)
    const boardUrlInput = document.getElementById('board-url');
    const viewBoardLink = document.getElementById('view-board-link');

    if (boardUrlInput) {
      boardUrlInput.value = viewUrl || 'URLç”Ÿæˆä¸­...';
      console.log('ğŸ“ Board URL input updated:', viewUrl || 'URL generation pending');
    }
    if (viewBoardLink && viewUrl) {
      viewBoardLink.href = viewUrl;
      console.log('ğŸ”— View board link updated:', viewUrl);
    } else if (viewBoardLink) {
      viewBoardLink.removeAttribute('href');
      console.log('ğŸ”— View board link cleared - no URL available');
    }

    // Update topic text
    updateTopicText(status);

    guidanceText.textContent = 'å›ç­”ãƒœãƒ¼ãƒ‰ã¯ç¾åœ¨å…¬é–‹ä¸­ã§ã™ã€‚';
    console.log('âœ… Footer shown - board is published');
  } else {
    footer.classList.add('hidden');
    console.log('âŒ Footer hidden - board not published');

    // Update guidance based on setup step
    updateGuidanceForStep(status.setupStep || 1, guidanceText);
  }

  console.groupEnd();
  adjustLayout();
}

// Update topic text in footer
function updateTopicText(status) {
  const topicTextElement = document.getElementById('current-topic-text');
  if (!topicTextElement) return;

  let topic = 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
  const cfg = status.config || {};

  if (status.customFormInfo && status.customFormInfo.mainQuestion) {
    topic = status.customFormInfo.mainQuestion;
  } else if (cfg.opinionHeader) {
    topic = cfg.opinionHeader;
  } else {
    const sheetName = cfg.publishedSheetName || status.publishedSheetName;
    if (sheetName) {
      if (status.userInfo?.configJson) {
        try {
          const fullCfg = JSON.parse(status.userInfo.configJson);
          const sheetCfg = fullCfg['sheet_' + sheetName] || {};
          topic = sheetCfg.opinionHeader || sheetName || 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
        } catch (e) {
          topic = sheetName || 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
        }
      } else {
        topic = sheetName;
      }
    }
  }

  topicTextElement.textContent = topic;
}

// Update guidance text for specific step
function updateGuidanceForStep(step, guidanceElement) {
  const messages = {
    1: 'ã‚¹ãƒ†ãƒƒãƒ—1: ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã¾ãŸã¯æ—¢å­˜ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚',
    2: 'ã‚¹ãƒ†ãƒƒãƒ—2: è¡¨ç¤ºã—ãŸã„ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚',
    3: 'ã‚¹ãƒ†ãƒƒãƒ—3: åˆ—ã‚’è¨­å®šã—ã¦ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¾ã—ã‚‡ã†ã€‚'
  };

  guidanceElement.textContent = messages[step] || 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚';
}

// =============================================================================
// SECTION TOGGLE FUNCTIONALITY
// =============================================================================

// Toggle section expansion/collapse
function toggleSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (!section) {
    console.warn('Section not found:', sectionId);
    return;
  }

  // Find the toggle button for this section
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  const arrow = toggleBtn ? toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up') : null;

  // Toggle the section visibility
  if (section.classList.contains('hidden')) {
    // Show section
    section.classList.remove('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'true');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-up');
      arrow.classList.add('fa-chevron-down');
    }
  } else {
    // Hide section
    section.classList.add('hidden');
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', 'false');
    }
    if (arrow) {
      arrow.classList.remove('fa-chevron-down');
      arrow.classList.add('fa-chevron-up');
    }
  }
}

// Automatically collapse completed sections
function collapseCompletedSection(stepNumber) {
  const sectionId = `step${stepNumber}-content`;
  const section = document.getElementById(sectionId);
  if (!section) return;

  console.log(`ğŸ“ Auto-collapsing completed step ${stepNumber}`);

  // Collapse the section
  section.classList.add('hidden');

  // Update toggle button state
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  if (toggleBtn) {
    toggleBtn.setAttribute('aria-expanded', 'false');
    const arrow = toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
    if (arrow) {
      arrow.classList.remove('fa-chevron-down');
      arrow.classList.add('fa-chevron-up');
    }
  }

  // Note: Visual indicators are now managed by manageSectionStates()
}

// Automatically expand active section
function expandActiveSection(stepNumber) {
  const sectionId = `step${stepNumber}-content`;
  const section = document.getElementById(sectionId);
  if (!section) return;

  console.log(`ğŸ“‚ Auto-expanding active step ${stepNumber}`);

  // Expand the section
  section.classList.remove('hidden');

  // Special handling for Step 3: ensure config-area is visible
  if (stepNumber === 3) {
    const configArea = document.getElementById('config-area');
    if (configArea && currentStatus && currentStatus.activeSheetName) {
      configArea.classList.remove('hidden');
      console.log(`ğŸ“‹ expandActiveSection: Config area shown for Step 3`);
    }
  }

  // Update toggle button state
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  if (toggleBtn) {
    toggleBtn.setAttribute('aria-expanded', 'true');
    const arrow = toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
    if (arrow) {
      arrow.classList.remove('fa-chevron-up');
      arrow.classList.add('fa-chevron-down');
    }
  }

  // Note: Visual indicators are now managed by manageSectionStates()
}

// Manage section states based on current step
function manageSectionStates(currentStep) {
  console.log(`ğŸ”„ Managing section states for step ${currentStep}`);

  // Determine if sections are truly completed based on setup status
  const isStepCompleted = (stepNumber) => {
    if (stepNumber === 1) {
      // Step 1 is completed if we have spreadsheet data
      return currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetId;
    } else if (stepNumber === 2) {
      // Step 2 is completed if we have active sheet
      return currentStatus && currentStatus.activeSheetName;
    } else if (stepNumber === 3) {
      // Step 3 is completed if app is published (use normalized state)
      return currentStatus && currentStatus._normalized && currentStatus._normalized.isPublished;
    }
    return false;
  };

  // Update all sections based on their true state
  for (let i = 1; i <= 3; i++) {
    const sectionContainer = document.getElementById(`step${i}-content`)?.closest('.glass-panel');
    if (!sectionContainer) continue;

    // Clear all state classes
    sectionContainer.classList.remove('section-completed', 'section-active', 'section-future', 'show-checkmark');

    const isCompleted = isStepCompleted(i);
    const isActive = i === currentStep;
    const isFuture = i > currentStep;

    if (isCompleted && i < currentStep) {
      // Truly completed sections get checkmark
      sectionContainer.classList.add('section-completed', 'show-checkmark');
      collapseCompletedSection(i);
      console.log(`âœ… Step ${i}: Completed with checkmark`);
    } else if (isActive) {
      // Current active section
      sectionContainer.classList.add('section-active');
      expandActiveSection(i);

      // Special handling for Step 3: ensure config-area is visible
      if (i === 3) {
        const configArea = document.getElementById('config-area');
        if (configArea && currentStatus && currentStatus.activeSheetName) {
          configArea.classList.remove('hidden');
          console.log(`ğŸ“‹ Step 3: Config area shown for sheet: ${currentStatus.activeSheetName}`);
        }
      }

      console.log(`ğŸ”„ Step ${i}: Active`);
    } else if (isFuture) {
      // Future sections
      sectionContainer.classList.add('section-future');
      console.log(`â³ Step ${i}: Future`);
    } else {
      // Completed but current step - no checkmark yet
      expandActiveSection(i);
      console.log(`ğŸ“‹ Step ${i}: Current (no checkmark)`);
    }
  }
}

// =============================================================================
// MODAL MANAGEMENT
// =============================================================================

// Show form configuration modal
function showFormConfigModal() {
  if (window.sharedModals) {
    window.sharedModals.showFormConfig();
    loadSavedClassChoices();
    manageFocusForModal('form-config-modal', true);
  } else {
    // Fallback for legacy support
    const modal = document.getElementById('form-config-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      loadSavedClassChoices();
      manageFocusForModal('form-config-modal', true);
    }
  }
}

// Hide form configuration modal
function hideFormConfigModal() {
  if (window.sharedModals) {
    window.sharedModals.hideModal('form-config-modal');
    manageFocusForModal('form-config-modal', false);
  } else {
    // Fallback for legacy support
    const modal = document.getElementById('form-config-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      manageFocusForModal('form-config-modal', false);
    }
  }
}

// Show privacy modal
function showPrivacyModal(onContinue) {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('privacy-modal', true);

    // Set up continue handler
    const continueBtn = document.getElementById('privacy-modal-continue');
    if (continueBtn && onContinue) {
      continueBtn.onclick = onContinue;
    }
  }
}

// Hide privacy modal
function hidePrivacyModal() {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('privacy-modal', false);
  }
}

// Show digital citizenship modal
function showDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('digital-citizenship-modal', true);
  }
}

// Hide digital citizenship modal
function hideDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('digital-citizenship-modal', false);
  }
}

// Show confirmation modal
function showConfirmationModal(title, message, onConfirm) {
  const modal = document.getElementById('confirmation-modal');
  const titleElement = document.getElementById('confirmation-title');
  const messageElement = document.getElementById('confirmation-message');
  const confirmBtn = document.getElementById('confirmation-confirm');

  if (modal && titleElement && messageElement && confirmBtn) {
    titleElement.textContent = title;
    messageElement.textContent = message;

    confirmBtn.onclick = function() {
      hideConfirmationModal();
      if (onConfirm) onConfirm();
    };

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('confirmation-modal', true);
  }
}

// Hide confirmation modal
function hideConfirmationModal() {
  const modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('confirmation-modal', false);
  }
}

// =============================================================================
// DYNAMIC CONTENT UPDATES
// =============================================================================

// Update dynamic content when board is active
function updateDynamicContent(status) {
  // Enable buttons that require active state
  const buttons = [
    'open-spreadsheet-btn',
    'open-form-btn'
  ];

  buttons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = false;
      button.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  });
}

// Update UI when no sheet is active
function updateUIForNoActiveSheet(status) {
  // Disable buttons that require active state
  const buttons = [
    'open-form-btn'
  ];

  buttons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = true;
      button.classList.add('opacity-50', 'cursor-not-allowed');
    }
  });
}

// Update existing user section
function updateExistingUserSection(status) {
  // Update any user-specific UI elements
  if (status.userInfo) {
    // Update user-specific elements here if needed
  }
}

// Update custom form info
function updateCustomFormInfo(status) {
  if (status.customFormInfo) {
    // Update form-related UI elements
    const formTitle = document.getElementById('form-title-display');
    const formQuestion = document.getElementById('form-question-display');

    if (formTitle) {
      formTitle.textContent = status.customFormInfo.title || 'ãƒ•ã‚©ãƒ¼ãƒ æœªä½œæˆ';
    }

    if (formQuestion) {
      formQuestion.textContent = status.customFormInfo.mainQuestion || '';
    }
  }
}

// Check for auto-publish dialog
function checkAutoPublishDialog(status) {
  // Implementation for auto-publish dialog if needed
  if (status.needsAutoPublish) {
    // Show auto-publish confirmation
  }
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize UI components
function initializeUI() {
  console.log('âœ… AdminPanel: UI components ready');

  // Load initial status
  loadStatus(true); // å¼·åˆ¶çš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¦æœ€æ–°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã‚’å–å¾—
}

// Load system status - OPTIMIZED with integrated API
function loadStatus(bypassCache = false) {
  console.group('ğŸ”„ loadStatus - Integrated API');
  console.log('ğŸš€ Loading system status with integrated API, bypassCache:', bypassCache);

  // Single API call to get all initial data
  runGasWithUserId('getInitialData')
    .then(response => {
      console.log('âœ… Integrated data loaded:', response);

      // Extract userId for compatibility
      if (response.userInfo && response.userInfo.userId) {
        userId = response.userInfo.userId;
        console.log('âœ… userId extracted from integrated response:', userId);
      }

      // Update UI with integrated response
      updateUIWithNewStatus(response);

      // If sheet details are included, apply them immediately
      if (response.sheetDetails && response.activeSheetName) {
        console.log('âœ… Sheet details included in integrated response, applying configuration');
        try {
          populateHeaderOptions(response.sheetDetails.allHeaders);
          console.log('âœ… Header options populated from integrated data');
          populateConfig(response.sheetDetails.guessedConfig);
          console.log('âœ… AI configuration applied from integrated data');
        } catch (configError) {
          console.error('Error applying sheet configuration from integrated data:', configError);
        }
      }

      console.log('âš¡ Performance: Single API call replaced 3-4 separate calls');
    })
    .catch(error => {
      console.error('âŒ Integrated API failed:', error);
      showMessage('ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    })
    .finally(() => {
      console.groupEnd();
    });
}

// =============================================================================
// DATA PREVIEW FUNCTIONALITY
// =============================================================================

// Handle sheet selection change for data preview
function handleSheetSelectionChange(event) {
  const newSelectedSheet = event.target.value;
  const previewSection = document.getElementById('data-preview-section');

  // Prevent redundant calls if the selected sheet hasn't actually changed
  if (newSelectedSheet === lastSelectedSheetName) {
    console.log('ğŸ“Š Sheet selection changed, but value is the same. Skipping redundant processing.');
    return;
  }

  console.log('ğŸ“Š Sheet selection changed:', {
    previousSheet: selectedSheet,
    newSelectedSheet: newSelectedSheet,
    hasPreviewSection: !!previewSection
  });

  // Update global selected sheet variable and last selected sheet
  selectedSheet = newSelectedSheet;
  lastSelectedSheetName = newSelectedSheet;

  if (newSelectedSheet && previewSection) {
    console.log('ğŸ“‹ Loading preview and config for sheet:', newSelectedSheet);
    previewSection.classList.remove('hidden');

    // Show loading state for preview
    const previewContent = document.getElementById('data-preview-content');
    if (previewContent) {
      previewContent.innerHTML = `
        <div class="animate-pulse">
          <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
          <div class="h-4 bg-gray-700 rounded w-1/2"></div>
        </div>
      `;
    }

    // Call getSheetDetails once and use its result for both preview and config
    if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
      console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      if (previewContent) previewContent.innerHTML = '<p class="text-red-400">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
      return;
    }

    // Call loadConfigForSelected which now handles getSheetDetails and populates UI
    loadConfigForSelected(newSelectedSheet, currentStatus.userInfo.spreadsheetId);

    // Update UI state (this might need to be moved inside the .then() block if it depends on details)
    updateUIForSelectedSheet();
  } else if (previewSection) {
    console.log('ğŸ“‹ Hiding preview section');
    previewSection.classList.add('hidden');
  }
}

// Load configuration for selected sheet - OPTIMIZED
function loadConfigForSelected(sheetName, spreadsheetId) {
  console.log('ğŸ“‹ Loading config for:', { selectedSheet: sheetName, spreadsheetId: spreadsheetId });

  if (!spreadsheetId || !sheetName) {
    console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚');
    return;
  }

  // Check if fresh save protection is active - skip cache if so
  const timeSinceFreshSave = Date.now() - (window.freshSaveTimestamp || 0);
  const isFreshSaveActive = timeSinceFreshSave < 30000; // 30 seconds

  // Check if we already have sheet details from integrated API
  if (!isFreshSaveActive && currentStatus && currentStatus.sheetDetails &&
      currentStatus.activeSheetName === sheetName) {
    console.log('âš¡ Using cached sheet details from integrated API');
    try {
      populateHeaderOptions(currentStatus.sheetDetails.allHeaders);
      console.log('âœ… Header options populated from cache');
      populateConfig(currentStatus.sheetDetails.guessedConfig);
      console.log('âœ… AI configuration applied from cache');
      return; // Early return - no API call needed
    } catch (error) {
      console.error('Error in cached config population:', error);
      // Fall through to API call if cache fails
    }
  }

  // Force fresh API call if fresh save protection is active or cache unavailable
  if (isFreshSaveActive) {
    console.log('ğŸ”„ Fresh save protection active - forcing API call for latest data');
  } else {
    console.log('ğŸ“ Making API call for sheet details:', sheetName);
  }

  runGasWithUserId('getSheetDetails', spreadsheetId, sheetName)
    .then(function(details) {
      console.log('âœ… Sheet details loaded via API:', details);
      try {
        populateHeaderOptions(details.allHeaders);
        console.log('âœ… Header options populated from API');
        populateConfig(details.guessedConfig);
        console.log('âœ… AI configuration applied from API');
      } catch (error) {
        console.error('Error in API config population sequence:', error);
        showMessage('è¨­å®šã®é©ç”¨ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
      }
    })
    .catch(function(error) {
      console.error('Failed to load sheet config via API:', error);
      showMessage('ã‚·ãƒ¼ãƒˆè¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
}

// Load data preview for selected sheet
function loadDataPreview(sheetName, details) {
  const previewContent = document.getElementById('data-preview-content');
  if (!previewContent) return;

  // Show loading state (if details are not yet available)
  if (!details) {
    previewContent.innerHTML = `
      <div class="animate-pulse">
        <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
        <div class="h-4 bg-gray-700 rounded w-1/2"></div>
      </div>
    `;
  }

  // If details are provided, use them directly
  if (details) {
    if (details && details.headers) {
      const headersList = details.headers.slice(0, 5); // First 5 headers
      const moreHeaders = details.headers.length > 5 ? `...ä»–${details.headers.length - 5}åˆ—` : '';

      previewContent.innerHTML = `
        <div class="text-sm">
          <div class="mb-2">
            <span class="text-gray-400">åˆ—æ•°:</span>
            <span class="text-white font-medium">${details.headers.length}åˆ—</span>
          </div>
          <div class="mb-2">
            <span class="text-gray-400">ä¸»è¦ãªåˆ—:</span>
            <div class="flex flex-wrap gap-1 mt-1">
              ${headersList.map(header => `
                <span class="px-2 py-1 bg-blue-500/20 text-blue-200 rounded text-xs">${header}</span>
              `).join('')}
              ${moreHeaders ? `<span class="text-gray-400 text-xs">${moreHeaders}</span>` : ''}
            </div>
          </div>
          <div class="text-xs text-gray-400 mt-2">
            ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’ç¢ºèªã—ã¦ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§åˆ—è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„
          </div>
        </div>
      `;
    } else {
      previewContent.innerHTML = '<p class="text-yellow-400">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>';
    }
  } else { // Fallback if details are not provided (should not happen after refactoring handleSheetSelectionChange)
    if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
      previewContent.innerHTML = '<p class="text-red-400">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
      return;
    }

    runGasWithUserId('getSheetDetails', currentStatus.userInfo.spreadsheetId, sheetName)
      .then(function(details) {
        if (details && details.headers) {
          const headersList = details.headers.slice(0, 5); // First 5 headers
          const moreHeaders = details.headers.length > 5 ? `...ä»–${details.headers.length - 5}åˆ—` : '';

          previewContent.innerHTML = `
            <div class="text-sm">
              <div class="mb-2">
                <span class="text-gray-400">åˆ—æ•°:</span>
                <span class="text-white font-medium">${details.headers.length}åˆ—</span>
              </div>
              <div class="mb-2">
                <span class="text-gray-400">ä¸»è¦ãªåˆ—:</span>
                <div class="flex flex-wrap gap-1 mt-1">
                  ${headersList.map(header => `
                    <span class="px-2 py-1 bg-blue-500/20 text-blue-200 rounded text-xs">${header}</span>
                  `).join('')}
                  ${moreHeaders ? `<span class="text-gray-400 text-xs">${moreHeaders}</span>` : ''}
                </div>
              </div>
              <div class="text-xs text-gray-400 mt-2">
                ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’ç¢ºèªã—ã¦ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§åˆ—è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„
              </div>
            </div>
          `;
        } else {
          previewContent.innerHTML = '<p class="text-yellow-400">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>';
        }
      })
      .catch(function(error) {
        console.error('Data preview error:', error);
        previewContent.innerHTML = '<p class="text-red-400">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
      });
  }
}

// =============================================================================
// SETUP STATUS HANDLING FUNCTIONS
// =============================================================================

/**
 * userInfoã‹ã‚‰setupStatusã‚’å®‰å…¨ã«å–å¾—
 * @param {Object} userInfo - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} setupStatus ('pending', 'completed', 'error')
 */
function getSetupStatusFromUserInfo(userInfo) {
  try {
    if (!userInfo || !userInfo.configJson) {
      return 'pending'; // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒãªã„å ´åˆã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†ã¨ã¿ãªã™
    }

    const config = typeof userInfo.configJson === 'string'
      ? JSON.parse(userInfo.configJson)
      : userInfo.configJson;

    // setupStatusãŒæ˜ç¤ºçš„ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
    if (config.setupStatus) {
      console.log('ğŸ”§ configJson setupStatus:', config.setupStatus);
      return config.setupStatus;
    }

    // setupStatusãŒãªã„å ´åˆã€ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰æ¨æ¸¬
    if (config.appPublished === true && config.formCreated === true) {
      return 'completed';
    }

    return 'pending';

  } catch (error) {
    console.warn('getSetupStatusFromUserInfo JSONè§£æã‚¨ãƒ©ãƒ¼:', error.message);
    return 'pending'; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†ã¨ã¿ãªã™
  }
}


/**
 * åˆæœŸè¡¨ç¤ºè¦ç´ ã‚’ã‚¯ãƒªã‚¢ã—ã¦é©åˆ‡ãªãƒ‰ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ
 */
function clearInitialDisplayElements() {
  // åˆæœŸè¡¨ç¤ºã‚’éè¡¨ç¤ºã«ã—ã¦ã€é©åˆ‡ãªãƒ‰ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ
  const initialContainer = document.getElementById('header-domain-initial');
  if (initialContainer) {
    initialContainer.style.display = 'none';
    console.log('âœ… åˆæœŸãƒ‰ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚’éè¡¨ç¤º');
  }

  // é©åˆ‡ãªãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
  showAppropriateHeaderStatus();

  // æ—¢å­˜ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã®ã¿å‰Šé™¤
  const existingGuides = [
    document.getElementById('setup-pending-guide'),
    document.querySelector('.setup-guide')
  ];

  existingGuides.forEach(guide => {
    if (guide) {
      guide.remove();
      console.log('âœ… æ—¢å­˜ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã‚’å‰Šé™¤');
    }
  });
}

/**
 * ãƒ˜ãƒƒãƒ€ãƒ¼ã«é©åˆ‡ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’è¨­å®š
 */
function showAppropriateHeaderStatus() {
  // ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è‡´è¡¨ç¤ºï¼ˆä»®ï¼‰ã‚’è¡¨ç¤º
  const domainMatch = document.getElementById('header-domain-match');
  const domainMismatch = document.getElementById('header-domain-mismatch');

  if (domainMatch && domainMismatch) {
    // ç¾åœ¨ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è‡´ã¨ã—ã¦è¡¨ç¤ºï¼ˆå®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ã¯åˆ¥é€”å®Ÿè£…ï¼‰
    domainMatch.style.display = 'block';
    domainMismatch.style.display = 'none';

    // ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’é©åˆ‡ã«è¨­å®š
    const domainText = document.getElementById('header-domain-match-text');
    if (domainText) {
      domainText.textContent = 'naha-okinawa.ed.jp';
    }

    console.log('âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è‡´è¡¨ç¤ºã‚’æœ‰åŠ¹åŒ–');
  }
}

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
 * @param {Object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function updateButtonStatesForSetup(status) {
  // ã‚ˆã‚Šç©ã‚„ã‹ãªUIåˆ¶å¾¡ï¼ˆå®Œå…¨ç„¡åŠ¹åŒ–ã§ã¯ãªãã€é©åˆ‡ãªã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ï¼‰

  // æœ€ä½é™ç„¡åŠ¹åŒ–ã™ã¹ãå…¬é–‹é–¢é€£ãƒœã‚¿ãƒ³ã®ã¿
  const criticalPublishButtons = [
    'save-publish-btn',
    'unpublish-board-btn'
  ];

  criticalPublishButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      // ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã®ã¿ç„¡åŠ¹åŒ–
      const hasSpreadsheet = status.userInfo && status.userInfo.spreadsheetId;
      const hasActiveSheet = status.activeSheetName;

      if (!hasSpreadsheet || !hasActiveSheet) {
        button.disabled = true;
        button.classList.add('opacity-75');
        button.title = 'å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã‚·ãƒ¼ãƒˆã‚’è¨­å®šã—ã¦ãã ã•ã„';
      } else {
        button.disabled = false;
        button.classList.remove('opacity-75');
        button.title = '';
      }
    }
  });

  console.log('âœ… ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’é©åˆ‡ã«æ›´æ–°ã—ã¾ã—ãŸ');
}


/**
 * åŸºæœ¬çš„ãªé™çš„UIè¦ç´ ã®ã¿æ›´æ–°
 * @param {Object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function updateBasicStaticUI(status) {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãªã©æœ€ä½é™ã®æƒ…å ±ã®ã¿æ›´æ–°
  if (status.userInfo) {
    // æ—¢å­˜ã®updateDatabaseInfoé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦é‡è¤‡ã‚’é¿ã‘ã‚‹
    updateDatabaseInfo(status);
  }
}

// Update system status display
function updateSystemStatusDisplay(status) {
  if (!status) return;

  // Update publish status
  const publishIndicator = document.getElementById('info-publish-indicator');
  const publishText = document.getElementById('info-publish-text');

  if (status.isPublished) {
    publishIndicator.className = 'w-2 h-2 rounded-full bg-green-400';
    publishText.textContent = 'å…¬é–‹ä¸­';
  } else {
    publishIndicator.className = 'w-2 h-2 rounded-full bg-gray-400';
    publishText.textContent = 'éå…¬é–‹';
  }

  // Update other status fields
  document.getElementById('info-published-sheet').textContent = status.sheetName || '-';
  document.getElementById('info-display-mode').textContent = status.displayMode || '-';
  document.getElementById('info-show-counts').textContent = status.showCounts ? 'è¡¨ç¤º' : 'éè¡¨ç¤º';
  document.getElementById('info-answer-count').textContent = status.answerCount || '0';
  document.getElementById('info-reaction-count').textContent = status.reactionCount || '0';

  // Enable resource buttons if URLs are available
  const spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
  const formBtn = document.getElementById('open-form-btn');
  const resourceBtn = document.getElementById('open-resource-btn');

  if (status.spreadsheetUrl) {
    if (spreadsheetBtn) {
      spreadsheetBtn.disabled = false;
      spreadsheetBtn.onclick = () => window.open(status.spreadsheetUrl, '_blank');
    }
  }

  if (status.formUrl) {
    if (formBtn) {
      formBtn.disabled = false;
      formBtn.onclick = () => window.open(status.formUrl, '_blank');
    }

    // Update form URL input field
    const formUrlInput = document.getElementById('form-url-input');
    if (formUrlInput) {
      formUrlInput.value = status.formUrl;
    }

    // Update form URL link
    const formUrlLink = document.getElementById('open-form-url-link');
    if (formUrlLink) {
      formUrlLink.href = status.formUrl;
    }
  }

  // Handle generic resource button in Step 1
  if (resourceBtn && (status.formUrl || status.spreadsheetUrl)) {
    resourceBtn.disabled = false;
    resourceBtn.onclick = () => {
      // Priority: Form first, then spreadsheet
      if (status.formUrl) {
        window.open(status.formUrl, '_blank');
      } else if (status.spreadsheetUrl) {
        window.open(status.spreadsheetUrl, '_blank');
      }
    };

    // Update button title based on available resources
    if (status.formUrl && status.spreadsheetUrl) {
      resourceBtn.title = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã (ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚‚åˆ©ç”¨å¯èƒ½)';
    } else if (status.formUrl) {
      resourceBtn.title = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
    } else if (status.spreadsheetUrl) {
      resourceBtn.title = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã';
    }
  }
}

// Navigate to specific step
function navigateToStep(step) {
  currentStep = step;

  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
    const stepNumber = index + 1;
    indicator.classList.toggle('completed', stepNumber < step);
    indicator.classList.toggle('active', stepNumber === step);
  });

  // Show/hide step content
  document.querySelectorAll('.step-content').forEach((content, index) => {
    const stepNumber = index + 1;
    content.classList.toggle('hidden', stepNumber !== step);
  });

  // Update progress bar
  const progressBar = document.querySelector('.progress-bar');
  if (progressBar) {
    progressBar.style.width = `${(step / 3) * 100}%`;
  }

  validateCurrentStep();
}

// Validate current step with setup status consideration
function validateCurrentStep() {
  const savePublishBtn = document.getElementById('save-publish-btn');
  if (!savePublishBtn) return;

  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ç¢ºèª
  const setupStatus = getSetupStatusFromGlobalStatus();

  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†æ™‚ã®æ®µéšçš„åˆ¶å¾¡
  if (setupStatus === 'pending') {
    enforceStepProgression();
  }

  let isValid = false;

  switch (currentStep) {
    case 1:
      isValid = selectedSheetId || selectedFormId;
      break;
    case 2:
      isValid = currentConfig && validateConfiguration();
      break;
    case 3:
      isValid = true;
      break;
  }

  savePublishBtn.disabled = !isValid;
}

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰å–å¾—
function getSetupStatusFromGlobalStatus() {
  try {
    if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
      const config = typeof currentStatus.userInfo.configJson === 'string'
        ? JSON.parse(currentStatus.userInfo.configJson)
        : currentStatus.userInfo.configJson;
      return config.setupStatus || 'pending';
    }
    return 'pending';
  } catch (error) {
    console.warn('getSetupStatusFromGlobalStatus ã‚¨ãƒ©ãƒ¼:', error);
    return 'pending';
  }
}

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†æ™‚ã®æ®µéšçš„åˆ¶å¾¡ã‚’å¼·åˆ¶
function enforceStepProgression() {
  const step1Completed = checkStep1Completion();
  const step2Completed = checkStep2Completion();

  // Step 2ã®åˆ¶å¾¡
  const step2Section = document.getElementById('sheet-selection-section');
  if (!step1Completed) {
    disableSection(step2Section, 'âš ï¸ å…ˆã«ãƒ‡ãƒ¼ã‚¿æº–å‚™ã‚’å®Œäº†ã—ã¦ãã ã•ã„');
  } else {
    enableSection(step2Section);
  }

  // Step 3ã®åˆ¶å¾¡
  const step3Section = document.getElementById('config-section');
  if (!step1Completed || !step2Completed) {
    disableSection(step3Section, 'âš ï¸ å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†ã—ã¦ãã ã•ã„');
  } else {
    enableSection(step3Section);
  }
}

// Step 1å®Œäº†ãƒã‚§ãƒƒã‚¯
function checkStep1Completion() {
  return !!(selectedSheetId || selectedFormId ||
            (currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetId));
}

// Step 2å®Œäº†ãƒã‚§ãƒƒã‚¯
function checkStep2Completion() {
  return !!(currentStatus && currentStatus.activeSheetName);
}

// ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
function disableSection(section, message) {
  if (!section) return;

  section.style.opacity = '0.5';
  section.style.pointerEvents = 'none';

  // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
  const existingWarning = section.querySelector('.step-warning');
  if (!existingWarning) {
    const warning = document.createElement('div');
    warning.className = 'step-warning bg-yellow-100 border border-yellow-300 rounded-lg p-3 mb-4 text-sm text-yellow-800';
    warning.innerHTML = `<span class="font-semibold">${message}</span>`;
    section.insertBefore(warning, section.firstChild);
  }
}

// ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–
function enableSection(section) {
  if (!section) return;

  section.style.opacity = '1';
  section.style.pointerEvents = 'auto';

  // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
  const warning = section.querySelector('.step-warning');
  if (warning) {
    warning.remove();
  }
}

// Validate current step with setup status consideration
function validateCurrentStep() {
  const savePublishBtn = document.getElementById('save-publish-btn');
  if (!savePublishBtn) return;

  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ç¢ºèª
  const setupStatus = getSetupStatusFromGlobalStatus();

  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†æ™‚ã®æ®µéšçš„åˆ¶å¾¡
  if (setupStatus === 'pending') {
    enforceStepProgression();
  }

  let isValid = false;

  switch (currentStep) {
    case 1:
      isValid = selectedSheetId || selectedFormId;
      break;
    case 2:
      isValid = currentConfig && validateConfiguration();
      break;
    case 3:
      isValid = true;
      break;
  }

  savePublishBtn.disabled = !isValid;
}

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰å–å¾—
function getSetupStatusFromGlobalStatus() {
  try {
    if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
      const config = typeof currentStatus.userInfo.configJson === 'string'
        ? JSON.parse(currentStatus.userInfo.configJson)
        : currentStatus.userInfo.configJson;
      return config.setupStatus || 'pending';
    }
    return 'pending';
  } catch (error) {
    console.warn('getSetupStatusFromGlobalStatus ã‚¨ãƒ©ãƒ¼:', error);
    return 'pending';
  }
}

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†æ™‚ã®æ®µéšçš„åˆ¶å¾¡ã‚’å¼·åˆ¶
function enforceStepProgression() {
  const step1Completed = checkStep1Completion();
  const step2Completed = checkStep2Completion();

  // Step 2ã®åˆ¶å¾¡
  const step2Section = document.getElementById('sheet-selection-section');
  if (!step1Completed) {
    disableSection(step2Section, 'âš ï¸ å…ˆã«ãƒ‡ãƒ¼ã‚¿æº–å‚™ã‚’å®Œäº†ã—ã¦ãã ã•ã„');
  } else {
    enableSection(step2Section);
  }

  // Step 3ã®åˆ¶å¾¡
  const step3Section = document.getElementById('config-section');
  if (!step1Completed || !step2Completed) {
    disableSection(step3Section, 'âš ï¸ å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†ã—ã¦ãã ã•ã„');
  } else {
    enableSection(step3Section);
  }
}

// Step 1å®Œäº†ãƒã‚§ãƒƒã‚¯
function checkStep1Completion() {
  return !!(selectedSheetId || selectedFormId ||
            (currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetId));
}

// Step 2å®Œäº†ãƒã‚§ãƒƒã‚¯
function checkStep2Completion() {
  return !!(currentStatus && currentStatus.activeSheetName);
}

// ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
function disableSection(section, message) {
  if (!section) return;

  section.style.opacity = '0.5';
  section.style.pointerEvents = 'none';

  // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
  const existingWarning = section.querySelector('.step-warning');
  if (!existingWarning) {
    const warning = document.createElement('div');
    warning.className = 'step-warning bg-yellow-100 border border-yellow-300 rounded-lg p-3 mb-4 text-sm text-yellow-800';
    warning.innerHTML = `<span class="font-semibold">${message}</span>`;
    section.insertBefore(warning, section.firstChild);
  }
}

// ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–
function enableSection(section) {
  if (!section) return;

  section.style.opacity = '1';
  section.style.pointerEvents = 'auto';

  // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
  const warning = section.querySelector('.step-warning');
  if (warning) {
    warning.remove();
  }
}

// Validate configuration
function validateConfiguration() {
  if (!currentConfig || !currentConfig.columnMappings) return false;

  const mappings = currentConfig.columnMappings;
  const hasContent = Object.values(mappings).includes('content');
  const hasAuthor = Object.values(mappings).includes('author');

  return hasContent && hasAuthor;
}

// Handle sheet selection
function handleSheetSelection(event) {
  selectedSheetId = event.target.value;
  selectedFormId = null; // Clear form selection

  if (selectedSheetId) {
    loadSheetColumns(selectedSheetId);
  }

  validateCurrentStep();
}

// Handle form selection
function handleFormSelection(event) {
  selectedFormId = event.target.value;
  selectedSheetId = null; // Clear sheet selection

  if (selectedFormId) {
    loadFormColumns(selectedFormId);
  }

  validateCurrentStep();
}

// Load sheet columns
function loadSheetColumns(sheetId) {
  if (typeof runGasWithUserId === 'function') {
    runGasWithUserId('getSheetColumns', sheetId)
      .then(columns => {
        displayColumnMapping(columns);
      })
      .catch(error => {
        console.error('Failed to load sheet columns:', error);
        showMessage('åˆ—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      });
  }
}

// Load form columns
function loadFormColumns(formId) {
  if (typeof runGasWithUserId === 'function') {
    runGasWithUserId('getFormColumns', formId)
      .then(columns => {
        displayColumnMapping(columns);
      })
      .catch(error => {
        console.error('Failed to load form columns:', error);
        showMessage('ãƒ•ã‚©ãƒ¼ãƒ é …ç›®ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      });
  }
}

// Display column mapping interface
function displayColumnMapping(columns) {
  const configPlaceholder = document.getElementById('config-placeholder');
  const configContent = document.getElementById('config-content');

  if (configPlaceholder) configPlaceholder.classList.add('hidden');
  if (configContent) configContent.classList.remove('hidden');

  const mappingContainer = document.getElementById('column-mappings');
  if (!mappingContainer) return;

  mappingContainer.innerHTML = '';

  columns.forEach((column, index) => {
    const mappingDiv = document.createElement('div');
    mappingDiv.className = 'column-mapping';
    mappingDiv.innerHTML = `
      <div>
        <label class="block text-sm font-medium text-gray-200 mb-2">
          ${column.name}
          ${column.required ? '<span class="text-red-400">*</span>' : ''}
        </label>
        <p class="text-xs text-gray-400">${column.description || ''}</p>
      </div>
      <div>
        <select class="form-control form-select column-mapping-select" data-column="${column.id}">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="content">å›ç­”å†…å®¹</option>
          <option value="author">å›ç­”è€…å</option>
          <option value="reaction">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³</option>
        </select>
      </div>
    `;
    mappingContainer.appendChild(mappingDiv);
  });
}

// Handle column mapping
function handleColumnMapping(select) {
  const columnId = select.dataset.column;
  const mappingType = select.value;
  const mappingDiv = select.closest('.column-mapping');

  // Update visual feedback
  mappingDiv.classList.remove('required', 'mapped');
  if (mappingType && mappingType !== 'ignore') {
    mappingDiv.classList.add('mapped');
  }

  // Update configuration
  if (!currentConfig) currentConfig = {};
  if (!currentConfig.columnMappings) currentConfig.columnMappings = {};
  currentConfig.columnMappings[columnId] = mappingType;

  validateCurrentStep();
}

// Handle toggle changes
function handleToggleChange(event) {
  const toggleName = event.target.name;
  const isChecked = event.target.checked;

  if (!currentConfig) currentConfig = {};
  currentConfig[toggleName] = isChecked;

  validateCurrentStep();
}

// Update system status display
function updateSystemStatusDisplay(status) {
  if (!status) return;

  // Update publish status
  const publishIndicator = document.getElementById('info-publish-indicator');
  const publishText = document.getElementById('info-publish-text');

  if (status.isPublished) {
    publishIndicator.className = 'w-2 h-2 rounded-full bg-green-400';
    publishText.textContent = 'å…¬é–‹ä¸­';
  } else {
    publishIndicator.className = 'w-2 h-2 rounded-full bg-gray-400';
    publishText.textContent = 'éå…¬é–‹';
  }

  // Update other status fields
  document.getElementById('info-published-sheet').textContent = status.sheetName || '-';
  document.getElementById('info-display-mode').textContent = status.displayMode || '-';
  document.getElementById('info-show-counts').textContent = status.showCounts ? 'è¡¨ç¤º' : 'éè¡¨ç¤º';
  document.getElementById('info-answer-count').textContent = status.answerCount || '0';
  document.getElementById('info-reaction-count').textContent = status.reactionCount || '0';

  // Enable resource buttons if URLs are available
  const spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
  const formBtn = document.getElementById('open-form-btn');
  const resourceBtn = document.getElementById('open-resource-btn');

  if (status.spreadsheetUrl) {
    if (spreadsheetBtn) {
      spreadsheetBtn.disabled = false;
      spreadsheetBtn.onclick = () => window.open(status.spreadsheetUrl, '_blank');
    }
  }

  if (status.formUrl) {
    if (formBtn) {
      formBtn.disabled = false;
      formBtn.onclick = () => window.open(status.formUrl, '_blank');
    }

    // Update form URL input field
    const formUrlInput = document.getElementById('form-url-input');
    if (formUrlInput) {
      formUrlInput.value = status.formUrl;
    }

    // Update form URL link
    const formUrlLink = document.getElementById('open-form-url-link');
    if (formUrlLink) {
      formUrlLink.href = status.formUrl;
    }
  }

  // Handle generic resource button in Step 1
  if (resourceBtn && (status.formUrl || status.spreadsheetUrl)) {
    resourceBtn.disabled = false;
    resourceBtn.onclick = () => {
      // Priority: Form first, then spreadsheet
      if (status.formUrl) {
        window.open(status.formUrl, '_blank');
      } else if (status.spreadsheetUrl) {
        window.open(status.spreadsheetUrl, '_blank');
      }
    };

    // Update button title based on available resources
    if (status.formUrl && status.spreadsheetUrl) {
      resourceBtn.title = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã (ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚‚åˆ©ç”¨å¯èƒ½)';
    } else if (status.formUrl) {
      resourceBtn.title = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
    } else if (status.spreadsheetUrl) {
      resourceBtn.title = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã';
    }
  }
}

// Initialize when DOM is ready
if (document.readyState !== 'loading') {
  setTimeout(initializeUI, 300);
} else {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeUI, 300);
  });
}
</script>
