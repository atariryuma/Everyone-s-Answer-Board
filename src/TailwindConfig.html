<script>
// TailwindCSS 設定 - モジュラー設計用最適化
window.tailwind = {
  config: {
    corePlugins: {
      preflight: true, // 有効化：適切なCSSリセットを提供
      container: false, // 無効化：カスタムコンテナクラスを使用
    },
    prefix: '',
    important: false,
    theme: {
      extend: {
        // デザイントークンとの連携
        colors: {
          'glass-primary': 'rgba(26, 27, 38, 0.65)',
          'glass-secondary': 'rgba(255, 255, 255, 0.08)',
          'glass-hover': 'rgba(255, 255, 255, 0.12)',
          'glass-active': 'rgba(255, 255, 255, 0.16)',
          'glass-disabled': 'rgba(255, 255, 255, 0.04)',
          'primary': '#06b6d4',
          'secondary': '#a855f7',
          'success': '#10b981',
          'error': '#ef4444',
          'warning': '#f59e0b',
          'info': '#3b82f6',
        },
        spacing: {
          'xs': '4px',
          'sm': '8px',
          'md': '16px',
          'lg': '24px',
          'xl': '32px',
          '2xl': '48px',
          '3xl': '64px',
        },
        fontSize: {
          'xs': '12px',
          'sm': '14px',
          'base': '16px',
          'lg': '18px',
          'xl': '20px',
          '2xl': '24px',
          '3xl': '30px',
          '4xl': '36px',
        },
        borderRadius: {
          'sm': '4px',
          'md': '8px',
          'lg': '12px',
          'xl': '16px',
          '2xl': '24px',
        },
        zIndex: {
          'base': '0',
          'raised': '1',
          'dropdown': '100',
          'sticky': '200',
          'modal': '1000',
          'tooltip': '1100',
          'overlay': '1200',
        },
        backdropBlur: {
          'glass': '20px',
          'glass-strong': '32px',
        },
        transitionDuration: {
          'fast': '150ms',
          'normal': '250ms',
          'slow': '350ms',
          'slower': '500ms',
        },
        transitionTimingFunction: {
          'standard': 'cubic-bezier(0.4, 0, 0.2, 1)',
          'in': 'cubic-bezier(0.4, 0, 1, 1)',
          'out': 'cubic-bezier(0, 0, 0.2, 1)',
          'in-out': 'cubic-bezier(0.4, 0, 0.6, 1)',
        }
      }
    }
  }
};
</script>

<style>
/* CSS レイヤー定義 - カスケード制御 */
@layer base, components, utilities, page-specific;

/* Tailwind CSS プリフライト上書き */
@layer base {
  /* デザイントークンの継承 */
  html {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Inter', sans-serif;
    line-height: 1.5;
    -webkit-text-size-adjust: 100%;
    -moz-tab-size: 4;
    tab-size: 4;
  }
  
  body {
    margin: 0;
    font-family: inherit;
    line-height: inherit;
  }
  
  /* グローバル要素のリセット */
  *,
  ::before,
  ::after {
    box-sizing: border-box;
    border-width: 0;
    border-style: solid;
    border-color: theme('borderColor.DEFAULT', currentColor);
  }
  
  /* フォーカス設定 */
  *:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
  }
}

/* コンポーネントレイヤー - 低特異性 */
@layer components {
  /* 基本的なコンポーネントスタイルのみ */
  .btn {
    @apply inline-flex items-center justify-center px-lg py-md text-sm font-semibold rounded-lg border transition-all duration-normal;
  }
  
  .form-control {
    @apply w-full px-lg py-md text-sm rounded-lg border transition-all duration-normal;
  }
  
  .glass-panel {
    @apply relative p-xl rounded-2xl border transition-all duration-normal;
  }
}

/* ユーティリティレイヤー - 最高特異性 */
@layer utilities {
  /* 重要なオーバーライド用 */
  .backdrop-blur-glass {
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }
  
  .backdrop-blur-glass-strong {
    backdrop-filter: blur(32px);
    -webkit-backdrop-filter: blur(32px);
  }
  
  .glass-shadow {
    box-shadow: 
      0 8px 32px rgba(0, 0, 0, 0.12),
      0 2px 8px rgba(0, 0, 0, 0.08),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }
  
  .glass-shadow-hover {
    box-shadow: 
      0 12px 40px rgba(0, 0, 0, 0.15),
      0 4px 12px rgba(0, 0, 0, 0.10),
      inset 0 1px 0 rgba(255, 255, 255, 0.15);
  }
}

/* ページ固有レイヤー - 最優先 */
@layer page-specific {
  /* ページ固有のスタイルをここに配置 */
  /* 例: .setup-page .specific-override { ... } */
}
</style>

<!-- TailwindCSS CDN - 開発環境用（本番環境では適切な最適化を検討） -->
<script src="https://cdn.tailwindcss.com" defer onerror="console.warn('TailwindCSS failed to load')"></script>

<!-- Legacy Layout Override - Replaced by Unified Layout System -->
<!-- This script has been consolidated into the unified layout system above -->

<!-- 統合レイアウトシステム - iframe対応 -->
<script>
// 統合レイアウト管理システム（iframe環境対応）
window.unifiedLayoutSystem = {
  initialized: false,
  repairAttempts: 0,
  maxRepairAttempts: 3,
  
  // メインの初期化関数
  init: function() {
    if (this.initialized) return;
    
    // 本番環境では詳細ログを制限
    const isDevelopment = window.location.hostname.includes('script.google.com') ||
                         window.location.search.includes('debug=true');
    
    if (isDevelopment) {
      console.log('🚀 [UNIFIED LAYOUT] System initialization...');
    }
    
    // iframe環境での即座の対応 - 統合システム内で処理
    this.initializeIframeSupport();
    
    // DOM準備完了後の処理
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => this.setupLayout());
    } else {
      this.setupLayout();
    }
    
    // TailwindCSS読み込み後の処理
    setTimeout(() => this.injectAdminStyles(), 150);
    
    this.initialized = true;
  },
  
  // レイアウトセットアップ
  setupLayout: function() {
    console.log('🔧 [UNIFIED LAYOUT] Setting up layout...');
    
    // body要素にレイアウトクラスを追加
    if (document.body) {
      document.body.classList.add('admin-grid-layout');
      
      // iframe環境の場合は追加のクラス
      if (window !== window.top) {
        document.body.classList.add('iframe-environment');
      }
    }
    
    // 少し遅らせてスタイルを注入
    setTimeout(() => this.injectAdminStyles(), 50);
  },
  
  // Admin Panel専用スタイルの注入
  injectAdminStyles: function() {
    // 既存のスタイルシートをチェック
    if (document.getElementById('unified-admin-layout')) {
      console.log('⚠️ [UNIFIED LAYOUT] Admin styles already injected');
      return;
    }
    
    console.log('💉 [UNIFIED LAYOUT] Injecting admin panel styles...');
    
    const unifiedStylesheet = document.createElement('style');
    unifiedStylesheet.id = 'unified-admin-layout';
    unifiedStylesheet.innerHTML = `
/* =============================================================================
   Unified Admin Layout System - 統合レイアウトシステム
   iframe環境とネイティブ環境の両方に対応
   ============================================================================= */

/* 基本的なAdmin Panel グリッドレイアウト */
body.admin-grid-layout .admin-responsive-grid,
.admin-responsive-grid {
  display: grid !important;
  grid-template-columns: minmax(0, 2fr) minmax(0, 1fr) !important;
  gap: 2rem !important;
  align-items: start !important;
  max-width: 84rem !important;
  margin: 0 auto !important;
  padding: 0 1rem !important;
  width: 100% !important;
  box-sizing: border-box !important;
  min-height: 0 !important;
}

/* パネルの基本設定 */
body.admin-grid-layout .admin-responsive-grid .left-panel,
body.admin-grid-layout .admin-responsive-grid .right-panel,
.admin-responsive-grid .left-panel,
.admin-responsive-grid .right-panel {
  min-width: 0 !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 1.5rem !important;
  flex: none !important;
  margin: 0 !important;
  box-sizing: border-box !important;
  width: 100% !important;
}

/* 左パネル */
body.admin-grid-layout .admin-responsive-grid .left-panel,
.admin-responsive-grid .left-panel {
  grid-column: 1 !important;
  min-width: 0 !important;
}

/* 右パネル */
body.admin-grid-layout .admin-responsive-grid .right-panel,
.admin-responsive-grid .right-panel {
  grid-column: 2 !important;
  position: sticky !important;
  top: 1.5rem !important;
  max-height: calc(100vh - 3rem) !important;
  overflow-y: auto !important;
  min-width: 0 !important;
}

/* iframe環境での追加強化 */
body.iframe-environment .admin-responsive-grid {
  isolation: isolate !important;
  contain: layout style paint !important;
}

/* モバイル対応 */
@media (max-width: 1024px) {
  body.admin-grid-layout .admin-responsive-grid,
  .admin-responsive-grid {
    grid-template-columns: 1fr !important;
    gap: 1.5rem !important;
    padding: 0 !important;
  }
  
  body.admin-grid-layout .admin-responsive-grid .left-panel,
  .admin-responsive-grid .left-panel {
    order: 2 !important;
    grid-column: auto !important;
  }
  
  body.admin-grid-layout .admin-responsive-grid .right-panel,
  .admin-responsive-grid .right-panel {
    order: 1 !important;
    grid-column: auto !important;
    position: static !important;
    max-height: none !important;
    overflow-y: visible !important;
  }
}

/* Tailwind上書き防止の追加保護 - 最強優先度 */
.tailwind-override-protection .admin-responsive-grid,
body.admin-grid-layout .tailwind-override-protection .admin-responsive-grid,
html body.admin-grid-layout .tailwind-override-protection .admin-responsive-grid {
  display: grid !important;
  grid-template-columns: minmax(0, 2fr) minmax(0, 1fr) !important;
  gap: 2rem !important;
  width: 100% !important;
  box-sizing: border-box !important;
}

/* 緊急修復クラス - 最高優先度 */
.admin-responsive-grid.emergency-2col,
body .admin-responsive-grid.emergency-2col,
html body .admin-responsive-grid.emergency-2col {
  display: grid !important;
  grid-template-columns: minmax(0, 2fr) minmax(0, 1fr) !important;
  gap: 2rem !important;
  align-items: start !important;
  max-width: 84rem !important;
  margin: 0 auto !important;
  padding: 0 1rem !important;
  width: 100% !important;
  box-sizing: border-box !important;
  contain: layout style !important;
  isolation: isolate !important;
}

/* パネル強制修復 */
.admin-responsive-grid.emergency-2col .left-panel,
body .admin-responsive-grid.emergency-2col .left-panel,
html body .admin-responsive-grid.emergency-2col .left-panel {
  grid-column: 1 !important;
  min-width: 0 !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 1.5rem !important;
  margin: 0 !important;
}

.admin-responsive-grid.emergency-2col .right-panel,
body .admin-responsive-grid.emergency-2col .right-panel,
html body .admin-responsive-grid.emergency-2col .right-panel {
  grid-column: 2 !important;
  min-width: 0 !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 1.5rem !important;
  margin: 0 !important;
  position: sticky !important;
  top: 1.5rem !important;
  max-height: calc(100vh - 3rem) !important;
  overflow-y: auto !important;
}

/* iframe専用強制修復 */
.iframe-force-admin-grid,
body.iframe-environment .iframe-force-admin-grid,
html body.iframe-environment .iframe-force-admin-grid {
  display: grid !important;
  grid-template-columns: minmax(0, 2fr) minmax(0, 1fr) !important;
  gap: 2rem !important;
  contain: layout style paint !important;
  isolation: isolate !important;
}

/* iframe環境での追加Flexコンテナ修復 */
.iframe-override-flex {
  display: flex !important;
  flex-direction: column !important;
}

.iframe-override-grid {
  display: grid !important;
}

/* CSS Grid直接操作による強制修復 */
@supports (display: grid) {
  .admin-responsive-grid.emergency-2col {
    grid-template-areas: "left right" !important;
  }
  
  .admin-responsive-grid.emergency-2col .left-panel {
    grid-area: left !important;
  }
  
  .admin-responsive-grid.emergency-2col .right-panel {
    grid-area: right !important;
  }
}

/* デバッグ用の視覚的確認 */
.debug-layout .admin-responsive-grid {
  outline: 2px solid #06b6d4 !important;
}

.debug-layout .left-panel {
  outline: 1px solid #10b981 !important;
}

.debug-layout .right-panel {
  outline: 1px solid #a855f7 !important;
}

/* アニメーション無効化による安定化 */
.admin-responsive-grid.emergency-2col * {
  transition: none !important;
  animation: none !important;
}
`;
    
    // 最高優先度で注入
    document.head.appendChild(unifiedStylesheet);
    
    // 注入後の検証
    setTimeout(() => this.verifyLayout(), 100);
  },
  
  // レイアウト検証（強化版）
  verifyLayout: function() {
    console.group('🔍 [UNIFIED LAYOUT] Layout Verification');
    
    const adminGrid = document.querySelector('.admin-responsive-grid');
    if (adminGrid) {
      const computedStyle = window.getComputedStyle(adminGrid);
      
      // より厳密な2カラムレイアウト検証
      const gridColumns = computedStyle.gridTemplateColumns;
      const isCorrectLayout = this.validateGridLayout(gridColumns);
      const isDesktopSize = window.innerWidth >= 1024;
      
      console.log('📐 Grid Status:');
      console.log('  ├─ Found:', '✅ YES');
      console.log('  ├─ Display:', computedStyle.display);
      console.log('  ├─ Columns:', gridColumns);
      console.log('  ├─ Gap:', computedStyle.gap);
      console.log('  ├─ Width:', computedStyle.width);
      console.log('  ├─ Desktop Size:', isDesktopSize ? '✅ YES' : '❌ NO');
      console.log('  └─ Layout Correct:', isCorrectLayout && isDesktopSize ? '✅ YES' : '❌ NO');
      
      // パネル状態の確認
      const leftPanel = adminGrid.querySelector('.left-panel');
      const rightPanel = adminGrid.querySelector('.right-panel');
      
      if (leftPanel && rightPanel) {
        console.log('📱 Panel Status:');
        console.log('  ├─ Left Width:', leftPanel.offsetWidth + 'px');
        console.log('  ├─ Right Width:', rightPanel.offsetWidth + 'px');
        console.log('  ├─ Left Grid Col:', window.getComputedStyle(leftPanel).gridColumn);
        console.log('  ├─ Right Grid Col:', window.getComputedStyle(rightPanel).gridColumn);
        console.log('  └─ Ratio:', leftPanel.offsetWidth && rightPanel.offsetWidth ? 
                   (leftPanel.offsetWidth / rightPanel.offsetWidth).toFixed(2) + ':1' : 'N/A');
      }
      
      // CSS クラス状態の確認
      console.log('🔧 CSS Class Status:');
      console.log('  ├─ Emergency 2col:', adminGrid.classList.contains('emergency-2col') ? '✅' : '❌');
      console.log('  ├─ Iframe Force:', adminGrid.classList.contains('iframe-force-admin-grid') ? '✅' : '❌');
      console.log('  ├─ Body Layout:', document.body.classList.contains('admin-grid-layout') ? '✅' : '❌');
      console.log('  └─ Override Protection:', document.body.classList.contains('tailwind-override-protection') ? '✅' : '❌');
      
      // 問題がある場合は緊急修復（デスクトップサイズの場合のみ）
      if ((!isCorrectLayout || !this.validatePanelPositions(leftPanel, rightPanel)) && 
          isDesktopSize && 
          this.repairAttempts < this.maxRepairAttempts) {
        console.warn(`⚠️ [UNIFIED LAYOUT] Layout issue detected, attempting emergency repair... (${this.repairAttempts + 1}/${this.maxRepairAttempts})`);
        this.repairAttempts++;
        this.emergencyRepair();
      } else if (!isCorrectLayout && isDesktopSize) {
        console.error('❌ [UNIFIED LAYOUT] Max repair attempts reached. Manual intervention required.');
        console.error('💡 [UNIFIED LAYOUT] Try: window.fixAdminLayout() or window.debugLayout(true)');
      } else if (!isDesktopSize) {
        console.log('📱 [UNIFIED LAYOUT] Mobile layout - validation skipped');
      } else {
        console.log('✅ [UNIFIED LAYOUT] Layout verification passed');
      }
    } else {
      console.log('❌ Admin grid not found');
    }
    
    console.groupEnd();
  },
  
  // グリッドレイアウト検証（厳密版）
  validateGridLayout: function(gridColumns) {
    if (!gridColumns) return false;
    
    // 様々な2fr 1frの形式を検証
    const validPatterns = [
      /minmax\(0(?:px)?,\s*2fr\)\s+minmax\(0(?:px)?,\s*1fr\)/,
      /2fr\s+1fr/,
      /2fr 1fr/,
      /(.*)\s*2fr\s+(.*)\s*1fr.*/,
      /.*2fr.*1fr.*/
    ];
    
    return validPatterns.some(pattern => pattern.test(gridColumns));
  },
  
  // パネル位置検証
  validatePanelPositions: function(leftPanel, rightPanel) {
    if (!leftPanel || !rightPanel) return false;
    
    const leftColumn = window.getComputedStyle(leftPanel).gridColumn;
    const rightColumn = window.getComputedStyle(rightPanel).gridColumn;
    
    // グリッドカラムが正しく設定されているかチェック
    const leftValid = leftColumn === '1' || leftColumn.startsWith('1 ');
    const rightValid = rightColumn === '2' || rightColumn.startsWith('2 ');
    
    return leftValid && rightValid;
  },
  
  // 緊急修復（無限ループ防止機能付き）
  emergencyRepair: function() {
    console.log(`🚨 [UNIFIED LAYOUT] Emergency repair initiated (attempt ${this.repairAttempts})`);
    
    const adminGrid = document.querySelector('.admin-responsive-grid');
    if (adminGrid) {
      // 複数の修復クラスを段階的に適用
      adminGrid.classList.add('emergency-2col');
      adminGrid.classList.add('iframe-force-admin-grid');
      
      // bodyに複数の保護クラスを追加
      document.body.classList.add('tailwind-override-protection');
      document.body.classList.add('admin-grid-layout');
      
      // iframe修復を統合システム内で実行
      this.applyIframeRepair();
      
      // CSS直接操作による強制修復
      this.forceDirectCSS(adminGrid);
      
      console.log('🔧 [UNIFIED LAYOUT] Emergency repair completed with multi-level protection');
      
      // 修復後に再検証（試行回数制限内の場合のみ）
      if (this.repairAttempts < this.maxRepairAttempts) {
        setTimeout(() => this.verifyLayout(), 700); // より長い遅延で安定化
      } else {
        console.log('🔧 [UNIFIED LAYOUT] Verification skipped to prevent infinite loop');
      }
    }
  },
  
  // CSS直接操作による強制修復
  forceDirectCSS: function(adminGrid) {
    console.log('🔧 [UNIFIED LAYOUT] Applying direct CSS manipulation');
    
    // CSS変数を直接設定
    adminGrid.style.setProperty('display', 'grid', 'important');
    adminGrid.style.setProperty('grid-template-columns', 'minmax(0, 2fr) minmax(0, 1fr)', 'important');
    adminGrid.style.setProperty('gap', '2rem', 'important');
    adminGrid.style.setProperty('align-items', 'start', 'important');
    adminGrid.style.setProperty('max-width', '84rem', 'important');
    adminGrid.style.setProperty('margin', '0 auto', 'important');
    adminGrid.style.setProperty('padding', '0 1rem', 'important');
    adminGrid.style.setProperty('width', '100%', 'important');
    adminGrid.style.setProperty('box-sizing', 'border-box', 'important');
    
    // パネルの強制修復
    const leftPanel = adminGrid.querySelector('.left-panel');
    const rightPanel = adminGrid.querySelector('.right-panel');
    
    if (leftPanel) {
      leftPanel.style.setProperty('grid-column', '1', 'important');
      leftPanel.style.setProperty('min-width', '0', 'important');
      leftPanel.style.setProperty('display', 'flex', 'important');
      leftPanel.style.setProperty('flex-direction', 'column', 'important');
      leftPanel.style.setProperty('gap', '1.5rem', 'important');
    }
    
    if (rightPanel) {
      rightPanel.style.setProperty('grid-column', '2', 'important');
      rightPanel.style.setProperty('min-width', '0', 'important');
      rightPanel.style.setProperty('display', 'flex', 'important');
      rightPanel.style.setProperty('flex-direction', 'column', 'important');
      rightPanel.style.setProperty('gap', '1.5rem', 'important');
      rightPanel.style.setProperty('position', 'sticky', 'important');
      rightPanel.style.setProperty('top', '1.5rem', 'important');
    }
    
    console.log('✅ [UNIFIED LAYOUT] Direct CSS manipulation applied');
  },
  
  // 手動修復用グローバル関数
  manualRepair: function() {
    console.log('🔧 [UNIFIED LAYOUT] Manual repair requested');
    // 手動修復時はカウンターをリセット
    this.repairAttempts = 0;
    this.emergencyRepair();
  },
  
  // システムリセット機能
  reset: function() {
    console.log('🔄 [UNIFIED LAYOUT] System reset');
    this.repairAttempts = 0;
    this.initialized = false;
  },
  
  // iframe対応の初期化（統合）
  initializeIframeSupport: function() {
    const isIframe = window !== window.top;
    const isGoogleAppsScript = window.location.hostname.includes('googleusercontent.com') || 
                               window.location.hostname.includes('script.google.com');
    
    if (isIframe || isGoogleAppsScript) {
      console.log('🔧 [UNIFIED LAYOUT] iframe environment detected, applying enhanced support');
      
      // body要素にiframe環境クラスを追加
      if (document.body) {
        document.body.classList.add('iframe-environment');
      } else {
        document.addEventListener('DOMContentLoaded', () => {
          document.body.classList.add('iframe-environment');
        });
      }
    }
  },
  
  // iframe修復の適用（統合）
  applyIframeRepair: function() {
    console.log('🔧 [UNIFIED LAYOUT] Applying iframe repair');
    
    // Admin gridの強制修復
    const adminGrid = document.querySelector('.admin-responsive-grid');
    if (adminGrid) {
      adminGrid.classList.add('iframe-force-admin-grid');
    }
    
    // 全てのflexコンテナを修復
    const flexContainers = document.querySelectorAll('.flex:not(.iframe-safe-flex)');
    flexContainers.forEach(el => {
      el.classList.add('iframe-override-flex');
    });
    
    // 全てのgridコンテナを修復
    const gridContainers = document.querySelectorAll('.grid:not(.iframe-safe-grid)');
    gridContainers.forEach(el => {
      el.classList.add('iframe-override-grid');
    });
  }
};

// グローバルアクセス用関数
window.fixAdminLayout = function() {
  window.unifiedLayoutSystem.manualRepair();
};

// デバッグモード切り替え（本番環境最適化）
window.debugLayout = function(enable = true) {
  // 本番環境ではデバッグを制限
  const isDevelopment = window.location.hostname === 'localhost' || 
                       window.location.hostname.includes('script.google.com') ||
                       window.location.search.includes('debug=true');
  
  if (!isDevelopment && enable) {
    console.warn('🔒 Debug mode is disabled in production environment');
    return;
  }
  
  if (enable) {
    document.body.classList.add('debug-layout');
    console.log('🐛 Layout debug mode enabled');
  } else {
    document.body.classList.remove('debug-layout');
    console.log('🐛 Layout debug mode disabled');
  }
};

// レイアウト監視
if (typeof ResizeObserver !== 'undefined') {
  const layoutObserver = new ResizeObserver(entries => {
    entries.forEach(entry => {
      if (entry.target.classList.contains('admin-responsive-grid')) {
        console.log('📐 [UNIFIED LAYOUT] Size change detected:', {
          width: entry.contentRect.width,
          height: entry.contentRect.height,
          timestamp: new Date().toLocaleTimeString()
        });
      }
    });
  });
  
  // 監視開始
  setTimeout(() => {
    const adminGrid = document.querySelector('.admin-responsive-grid');
    if (adminGrid) {
      layoutObserver.observe(adminGrid);
      console.log('👁️ [UNIFIED LAYOUT] Monitoring started');
    }
  }, 300);
}

// システム初期化
window.unifiedLayoutSystem.init();
</script>