<script>
/**
 * AdminPanel Enterprise Security Module
 * ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã®çµ±åˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
 */

'use strict';

// =============================================================================
// ENTERPRISE SECURITY CORE
// =============================================================================

/**
 * ä¼æ¥­ãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
 */
window.AdminPanelSecurity = (function() {
  'use strict';
  
  let securityContext = null;
  let monitoringInterval = null;
  
  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åˆæœŸåŒ–
   */
  function initializeSecurityContext() {
    const currentUrl = new URL(window.location.href);
    const urlUserId = currentUrl.searchParams.get('userId');
    
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼: userIdãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¿…é ˆæ€§ç¢ºèª
    if (!urlUserId) {
      handleSecurityViolation('MISSING_USERID_PARAMETER');
      return false;
    }
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿userIdã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ï¼ˆXSSé˜²æ­¢ï¼‰
    const userIdPattern = /^[a-zA-Z0-9\-_.@]+$/;
    if (!userIdPattern.test(urlUserId) || urlUserId.length > 255) {
      handleSecurityViolation('INVALID_USERID_FORMAT');
      return false;
    }
    
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®è¨­å®š
    securityContext = {
      urlUserId: urlUserId,
      sessionId: 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      initialized: Date.now(),
      securityLevel: 'ENTERPRISE',
      violations: [],
      lastValidation: Date.now()
    };
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ã®è¨­å®š
    window.SECURE_URL_USER_ID = urlUserId;
    window.MULTI_TENANT_CONTEXT = securityContext;
    
    console.log('âœ… AdminPanel Security: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆæœŸåŒ–å®Œäº†', {
      userId: urlUserId.substring(0, 8) + '...',
      sessionId: securityContext.sessionId,
      securityLevel: securityContext.securityLevel
    });
    
    return true;
  }
  
  /**
   * è¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®userIDæ•´åˆæ€§æ¤œè¨¼
   */
  function validateSecureUserId(context = 'unknown') {
    if (!securityContext) {
      console.error('ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒæœªåˆæœŸåŒ–', context);
      return null;
    }
    
    const urlUserId = securityContext.urlUserId;
    const frameworkUserId = window.userId; // adminPanel-framework.js.htmlã‹ã‚‰
    
    // ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: è¤‡æ•°ã‚½ãƒ¼ã‚¹ã§ã®æ•´åˆæ€§ç¢ºèª
    if (!urlUserId) {
      console.error('ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼: URL userIdãŒå–å¾—ã§ãã¾ã›ã‚“', context);
      recordSecurityViolation('URL_USERID_MISSING', context);
      return null;
    }
    
    if (frameworkUserId && frameworkUserId !== urlUserId) {
      console.error('ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼: userIdä¸æ•´åˆæ¤œå‡º', {
        context: context,
        urlUserId: urlUserId,
        frameworkUserId: frameworkUserId
      });
      recordSecurityViolation('USERID_INCONSISTENCY', { context, urlUserId, frameworkUserId });
      return null;
    }
    
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼: userIdãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå†ç¢ºèª
    const userIdPattern = /^[a-zA-Z0-9\-_.@]+$/;
    if (!userIdPattern.test(urlUserId) || urlUserId.length > 255) {
      console.error('ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼: userId ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé•å', urlUserId);
      recordSecurityViolation('USERID_FORMAT_VIOLATION', { context, urlUserId });
      return null;
    }
    
    // æœ€å¾Œã®æ¤œè¨¼æ™‚åˆ»ã‚’æ›´æ–°
    securityContext.lastValidation = Date.now();
    
    return urlUserId;
  }
  
  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é•åã®è¨˜éŒ²
   */
  function recordSecurityViolation(violationType, details = {}) {
    if (!securityContext) return;
    
    const violation = {
      type: violationType,
      timestamp: new Date().toISOString(),
      details: details,
      userAgent: navigator.userAgent,
      url: window.location.href
    };
    
    securityContext.violations.push(violation);
    
    // æœ€æ–°10ä»¶ã®ã¿ä¿æŒ
    if (securityContext.violations.length > 10) {
      securityContext.violations = securityContext.violations.slice(-10);
    }
    
    console.warn('ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é•åè¨˜éŒ²:', violation);
  }
  
  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é•åãƒãƒ³ãƒ‰ãƒ©ãƒ¼
   */
  function handleSecurityViolation(violationType, details = {}) {
    console.error('ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é•åæ¤œå‡º:', violationType, details);
    
    recordSecurityViolation(violationType, details);
    
    // é‡å¤§ãªé•åã®å ´åˆã¯ãƒšãƒ¼ã‚¸ã‚’ç„¡åŠ¹åŒ–
    const criticalViolations = [
      'MISSING_USERID_PARAMETER',
      'INVALID_USERID_FORMAT',
      'REPEATED_VALIDATION_FAILURES'
    ];
    
    if (criticalViolations.includes(violationType)) {
      document.body.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#1a1b26;color:#ef4444;text-align:center;font-family:system-ui">
          <div>
            <h1 style="margin-bottom:1rem">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼</h1>
            <p>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚<br>ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
            <p style="margin-top:1rem;font-size:0.8em;color:#888">ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${violationType}</p>
          </div>
        </div>
      `;
      return;
    }
    
    // ãã®ä»–ã®é•åã¯è­¦å‘Šã¨ã—ã¦è¨˜éŒ²
    console.warn('ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š: ç¶™ç¶šç›£è¦–ä¸­', violationType);
  }
  
  /**
   * ä¼æ¥­ãƒ¬ãƒ™ãƒ«ç›£æŸ»ãƒ­ã‚°
   */
  function auditApiCall(functionName, userId, args, context = {}) {
    if (securityContext?.securityLevel === 'ENTERPRISE') {
      console.log('ğŸ”’ APIç›£æŸ»ãƒ­ã‚°:', {
        function: functionName,
        userId: userId ? userId.substring(0, 8) + '...' : 'unknown',
        argsCount: args?.length || 0,
        sessionId: securityContext.sessionId,
        timestamp: new Date().toISOString(),
        context: context
      });
    }
  }
  
  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµ±è¨ˆã®å–å¾—
   */
  function getSecurityStats() {
    if (!securityContext) {
      return { error: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒæœªåˆæœŸåŒ–' };
    }
    
    return {
      sessionId: securityContext.sessionId,
      userId: securityContext.urlUserId ? securityContext.urlUserId.substring(0, 8) + '...' : 'unknown',
      violations: securityContext.violations.length,
      lastValidation: new Date(securityContext.lastValidation).toLocaleString(),
      uptime: Date.now() - securityContext.initialized,
      securityLevel: securityContext.securityLevel
    };
  }
  
  /**
   * å®šæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã®é–‹å§‹
   */
  function startPeriodicSecurityCheck() {
    if (monitoringInterval) {
      clearInterval(monitoringInterval);
    }
    
    monitoringInterval = setInterval(() => {
      const secureUserId = validateSecureUserId('periodic-check');
      if (!secureUserId) {
        console.error('ğŸš¨ å®šæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å¤±æ•—: userIDæ¤œè¨¼ã‚¨ãƒ©ãƒ¼');
        handleSecurityViolation('PERIODIC_CHECK_FAILED');
      }
    }, 30000); // 30ç§’ã”ã¨
    
    console.log('ğŸ”’ å®šæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯é–‹å§‹ (30ç§’é–“éš”)');
  }
  
  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã®åœæ­¢
   */
  function stopPeriodicSecurityCheck() {
    if (monitoringInterval) {
      clearInterval(monitoringInterval);
      monitoringInterval = null;
      console.log('ğŸ”’ å®šæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯åœæ­¢');
    }
  }
  
  // å…¬é–‹API
  return {
    init: initializeSecurityContext,
    validateUserId: validateSecureUserId,
    handleViolation: handleSecurityViolation,
    auditApiCall: auditApiCall,
    getStats: getSecurityStats,
    startMonitoring: startPeriodicSecurityCheck,
    stopMonitoring: stopPeriodicSecurityCheck
  };
})();

// =============================================================================
// SECURITY ENHANCED CACHE FUNCTIONS
// =============================================================================

/**
 * ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ã‚»ã‚­ãƒ¥ã‚¢ callWithCacheWithUserIdé–¢æ•°
 */
function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
  // å¾Œæ–¹äº’æ›æ€§: å¾“æ¥ã®userIdã‚’ãƒã‚§ãƒƒã‚¯
  const legacyUserId = window.userId; // adminPanel-framework.js.htmlã‹ã‚‰
  
  // ä¼æ¥­ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ãŒæœ‰åŠ¹ãªå ´åˆã¯å¼·åŒ–æ¤œè¨¼
  let finalUserId;
  if (window.AdminPanelSecurity && window.MULTI_TENANT_CONTEXT?.securityLevel === 'ENTERPRISE') {
    const secureUserId = window.AdminPanelSecurity.validateUserId(functionName);
    if (!secureUserId) {
      throw new Error('ã‚»ã‚­ãƒ¥ã‚¢ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    }
    finalUserId = secureUserId;
    
    // ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢å¯¾å¿œ: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«userIdã‚’å«ã‚ã‚‹
    const tenantSafeKey = `tenant_${secureUserId}_${cacheKey}`;
    
    // APIç›£æŸ»ãƒ­ã‚°
    window.AdminPanelSecurity.auditApiCall(functionName, secureUserId, args, { cacheKey: tenantSafeKey });
    
    return unifiedCache.getOrSet(tenantSafeKey, function() {
      console.log('âœ… ã‚»ã‚­ãƒ¥ã‚¢ callWithCacheWithUserId:', functionName, 'userId:', secureUserId.substring(0, 8) + '...');
      return gasOptimizer.call(functionName, secureUserId, ...args);
    }, ttl);
  } else {
    // å¾“æ¥ã®å‹•ä½œï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
    if (!legacyUserId) {
      console.error('âŒ  - No userId available for cached call:', functionName);
      throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    }
    finalUserId = legacyUserId;
    
    return unifiedCache.getOrSet(cacheKey, function() {
      console.log('âœ…  - callWithCacheWithUserId:', functionName, 'userId:', finalUserId);
      return gasOptimizer.call(functionName, finalUserId, ...args);
    }, ttl);
  }
}

// =============================================================================
// AUDIT LOGGING FUNCTIONS
// =============================================================================

/**
 * ä¼æ¥­ç›£æŸ»ãƒ­ã‚°é–¢æ•° (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨)
 */
function auditLog(action, details = {}) {
  if (window.MULTI_TENANT_CONTEXT?.securityLevel === 'ENTERPRISE') {
    console.log(`ğŸ”’ AUDIT: ${action}`, {
      action: action,
      details: details,
      userId: window.SECURE_URL_USER_ID?.substring(0, 8) + '...' || 'unknown',
      sessionId: window.MULTI_TENANT_CONTEXT?.sessionId || 'unknown',
      timestamp: new Date().toISOString()
    });
  }
}

/**
 * ãƒ†ãƒŠãƒ³ãƒˆã‚¢ã‚¯ã‚»ã‚¹ç›£æŸ»ãƒ­ã‚° (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨)
 */
function auditTenantAccess(operation, userId, allowed, details = {}) {
  auditLog('TENANT_ACCESS', {
    operation: operation,
    userId: userId?.substring(0, 8) + '...' || 'unknown',
    allowed: allowed,
    details: details
  });
}

// =============================================================================
// GLOBAL SECURITY INITIALIZATION
// =============================================================================

/**
 * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è‡ªå‹•åˆæœŸåŒ–
 */
(function autoInitializeSecurity() {
  'use strict';
  
  // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆæœŸåŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      initializeAdminPanelSecurity();
    });
  } else {
    initializeAdminPanelSecurity();
  }
  
  function initializeAdminPanelSecurity() {
    console.log('ğŸ”’ AdminPanel Security åˆæœŸåŒ–é–‹å§‹...');
    
    const success = window.AdminPanelSecurity.init();
    if (success) {
      window.AdminPanelSecurity.startMonitoring();
      console.log('âœ… AdminPanel Security åˆæœŸåŒ–å®Œäº†');
    } else {
      console.error('âŒ AdminPanel Security åˆæœŸåŒ–å¤±æ•—');
    }
  }
})();

console.log('ğŸ“¦ AdminPanel Security Module loaded');
</script>