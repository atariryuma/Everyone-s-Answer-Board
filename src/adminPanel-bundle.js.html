<script>

/**
 * Admin Panel Bundle - çµ±åˆã•ã‚ŒãŸAdminPanelã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 * 
 * ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç®¡ç†ãƒ‘ãƒãƒ«ã®å…¨JavaScriptã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’çµ±åˆã—ã¦ã„ã¾ã™ã€‚
 * èª­ã¿è¾¼ã¿é †åºã¨ä¾å­˜é–¢ä¿‚ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã«çµ±åˆã•ã‚Œã¾ã—ãŸã€‚
 */

// ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰é †åº:
// 1. adminPanel-framework.js.html
// 2. adminPanel-core.js.html  
// 3. adminPanel-api.js.html
// 4. adminPanel-ui.js.html
// 5. adminPanel-events.js.html
// 6. admin-consolidated.js.html
// 7. adminPanel-simple-history.js.html
// 8. adminPanel-simple-history-compat.js.html


// Unified Admin Panel Namespace and Management Classes
// Generated to address function interference issues and centralize state, events,
// asynchronous operations, and DOM handling.

window.AdminPanel = window.AdminPanel || {
  errors: {},
  ui: {},
  state: {
    current: null,
    selectedSheet: '',
    updateStatus(status) {
      this.current = status;
    }
  },
  // Initialization state tracking to prevent redundant calls
  initialization: {
    isInProgress: false,
    isCompleted: false,
    completedPhases: new Set(),
    startTime: null,
    lastLoadStatusCall: null,
    loadStatusCallCount: 0
  }
};

// -----------------------------------------------------------------------------
// State Manager
// -----------------------------------------------------------------------------
class AdminPanelStateManager {
  constructor() {
    this.state = {
      currentStatus: null,
      selectedSheet: '',
      isLoading: false,
      debugMode: false // DEBUG_MODEçŠ¶æ…‹ã‚’è¿½åŠ 
    };
    this.subscribers = new Map();
  }

  setState(key, value) {
    this.state[key] = value;
    this.notifySubscribers(key, value);
  }

  subscribe(key, callback) {
    if (!this.subscribers.has(key)) {
      this.subscribers.set(key, []);
    }
    this.subscribers.get(key).push(callback);
  }

  notifySubscribers(key, value) {
    const subs = this.subscribers.get(key) || [];
    subs.forEach((cb) => {
      try {
        cb(value);
      } catch (e) {
        console.warn('Subscriber callback failed', e);
      }
    });
  }
}

// -----------------------------------------------------------------------------
// Event Manager
// -----------------------------------------------------------------------------
class AdminPanelEventManager {
  constructor() {
    this.listeners = new Map();
  }

  addListener(element, event, handler, options = {}) {
    if (!element || !event || !handler) return;
    const key = `${element.id || 'anonymous'}-${event}`;
    if (this.listeners.has(key)) {
      console.warn(`Duplicate listener for ${key}`);
      return;
    }
    element.addEventListener(event, handler, options);
    this.listeners.set(key, { element, event, handler, options });
  }
}

// -----------------------------------------------------------------------------
// Async Manager
// -----------------------------------------------------------------------------
class AdminPanelAsyncManager {
  constructor() {
    this.runningOperations = new Map();
  }

  executeExclusive(operationId, operation) {
    if (this.runningOperations.has(operationId)) {
      return this.runningOperations.get(operationId);
    }
    const promise = Promise.resolve().then(operation);
    this.runningOperations.set(operationId, promise);
    return promise.then((result) => {
      this.runningOperations.delete(operationId);
      return result;
    }).catch((error) => {
      this.runningOperations.delete(operationId);
      throw error;
    });
  }
}

// -----------------------------------------------------------------------------
// DOM Manager
// -----------------------------------------------------------------------------
class AdminPanelDOMManager {
  constructor() {
    this.elementCache = new Map();
    this.operationQueue = [];
  }

  getElement(id) {
    if (!this.elementCache.has(id)) {
      this.elementCache.set(id, document.getElementById(id));
    }
    return this.elementCache.get(id);
  }

  queueOperation(operation) {
    this.operationQueue.push(operation);
    return new Promise((resolve) => {
      requestAnimationFrame(() => {
        const op = this.operationQueue.shift();
        resolve(op());
      });
    });
  }
}

// -----------------------------------------------------------------------------
// Core Business Logic Class
// -----------------------------------------------------------------------------
class AdminPanelCore {
  static validateConfig() {
    const requiredElements = ['opinionHeader', 'sheet-select'];
    const missingElements = [];
    
    requiredElements.forEach(id => {
      if (!document.getElementById(id)) {
        missingElements.push(id);
      }
    });
    
    if (missingElements.length > 0) {
      console.warn('Missing required elements:', missingElements);
      return false;
    }
    return true;
  }
  
  static showMessage(message, type = 'info', duration = 5000) {
    console.log(`[${type.toUpperCase()}] ${message}`);
    // Could be extended to show UI notifications
  }
  
  static checkFunctionAvailability(functionName) {
    const func = window[functionName];
    if (typeof func !== 'function') {
      console.warn(`âš ï¸ Function ${functionName} is not available`);
      return false;
    }
    return true;
  }
  
  static safeCallFunction(functionName, ...args) {
    try {
      if (!AdminPanelCore.checkFunctionAvailability(functionName)) {
        console.warn(`âš ï¸ Cannot call ${functionName} - function not available`);
        return null;
      }
      return window[functionName](...args);
    } catch (error) {
      console.error(`âŒ Error calling ${functionName}:`, error);
      return null;
    }
  }
}

// -----------------------------------------------------------------------------
// UI Management Class
// -----------------------------------------------------------------------------
class AdminPanelUI {
  static toggleSection(sectionId) {
    const section = window.AdminPanel.domManager.getElement(sectionId);
    const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
    
    if (!section) return;
    
    const isExpanded = section.classList.contains('expanded');
    section.classList.toggle('expanded', !isExpanded);
    section.classList.toggle('collapsed', isExpanded);
    
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', (!isExpanded).toString());
    }
  }
  
  static showFormConfigModal() {
    const modal = window.AdminPanel.domManager.getElement('form-config-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
  }
  
  static hideDigitalCitizenshipModal() {
    const modal = document.getElementById('digital-citizenship-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  }
  
  static hideConfirmationModal() {
    const modal = document.getElementById('confirmation-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  }
  
  static populateHeaderOptions(headers) {
    if (!headers || !Array.isArray(headers)) return;
    
    const opinionSelect = document.getElementById('opinionHeader');
    const nameColumnSelect = document.getElementById('name-column');
    
    if (opinionSelect) {
      opinionSelect.innerHTML = '<option value="">æ„è¦‹åˆ—ã‚’é¸æŠ</option>';
      headers.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        opinionSelect.appendChild(option);
      });
    }
    
    if (nameColumnSelect) {
      nameColumnSelect.innerHTML = '<option value="">åå‰åˆ—ã‚’é¸æŠï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>';
      headers.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        nameColumnSelect.appendChild(option);
      });
    }
  }
}

// -----------------------------------------------------------------------------
// API Communication Class
// -----------------------------------------------------------------------------
class AdminPanelAPI {
  static updateFormUrlDisplay(status = null) {
    try {
      const formUrlInput = window.AdminPanel.domManager.getElement('form-url');
      const viewFormBtn = window.AdminPanel.domManager.getElement('view-form-btn');
      
      if (!status && window.AdminPanel?.stateManager?.state?.currentStatus) {
        status = window.AdminPanel.stateManager.state.currentStatus;
      }
      
      if (status?.formUrl && formUrlInput) {
        formUrlInput.value = status.formUrl;
        if (viewFormBtn) {
          viewFormBtn.href = status.formUrl;
          viewFormBtn.classList.remove('hidden');
        }
      }
    } catch (error) {
      console.error('Error updating form URL display:', error);
    }
  }
}

// Instantiate managers and expose via namespace
window.AdminPanel.stateManager = new AdminPanelStateManager();
window.AdminPanel.eventManager = new AdminPanelEventManager();
window.AdminPanel.asyncManager = new AdminPanelAsyncManager();
window.AdminPanel.domManager = new AdminPanelDOMManager();

// Expose new classes
window.AdminPanel.Core = AdminPanelCore;
window.AdminPanel.UI = AdminPanelUI;
window.AdminPanel.API = AdminPanelAPI;

// Link legacy globals to state manager for compatibility
Object.defineProperties(window, {
  currentStatus: {
    get: () => window.AdminPanel.stateManager.state.currentStatus,
    set: (v) => window.AdminPanel.stateManager.setState('currentStatus', v)
  },
  selectedSheet: {
    get: () => window.AdminPanel.stateManager.state.selectedSheet,
    set: (v) => window.AdminPanel.stateManager.setState('selectedSheet', v)
  }
});

// Initialization functions

// Simple logging utility with conditional output based on DEBUG mode
// DEBUG_MODE is defined in constants.js.html

const adminLog = (level, ...args) => {
  // Only show errors and critical warnings - disable verbose logging
  switch (level) {
    case 'error':
      console.error('[AdminPanel]', ...args);
      break;
    case 'warn':
      // Only show warnings in debug mode
      if (window.DEBUG_MODE) console.warn('[AdminPanel]', ...args);
      break;
    case 'info':
    case 'debug':
    default:
      // All info/debug logs disabled for performance
      return;
  }
};

// Convenience functions for different log levels
const logError = (...args) => adminLog('error', ...args);
const logWarn = (...args) => adminLog('warn', ...args);
const logInfo = (...args) => adminLog('info', ...args);
const logDebug = (...args) => adminLog('debug', ...args);

// =============================================================================
// USER AUTHENTICATION INITIALIZATION
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å®‰å…¨ãªåˆæœŸåŒ–
let userId = '';

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å®‰å…¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
const initializeUserId = () => {
  console.group('ğŸ” Initializing UserId');
  logDebug('ğŸ“ About to call getCurrentUserStatus');
  
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler((response) => {
        logDebug('ğŸ“¥ getCurrentUserStatus response:', response);
        
        if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
          userId = response.userInfo.userId;
          logDebug('âœ… AdminPanel: User authenticated, userId:', userId);
          console.groupEnd();
          resolve(userId);
        } else {
          console.error('âŒ Failed to get userId from backend:', response);
          console.error('âŒ Expected: {status: "success", userInfo: {userId: "..."}}');
          console.groupEnd();
          reject(new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        }
      })
      .withFailureHandler((error) => {
        console.error('âŒ Backend error getting userId:', error);
        console.error('âŒ Error type:', typeof error);
        console.error('âŒ Error details:', error);
        console.groupEnd();
        reject(error);
      })
      .getCurrentUserStatus();
  });
}

// ãƒªãƒˆãƒ©ã‚¤ä»˜ããƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—
const initializeUserIdWithRetry = async (maxRetries = 3, delay = 1000) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await initializeUserId();
    } catch (error) {
      console.warn(`âš ï¸ UserId initialization failed (attempt ${i + 1}/${maxRetries}):`, error.message);
      if (i < maxRetries - 1) {
        console.log(`ğŸ”„ Retrying in ${delay}ms...`);
        await new Promise((resolve) => { setTimeout(resolve, delay); });
        delay = Math.min(delay * 1.5, 5000); // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆæœ€å¤§5ç§’ï¼‰
      } else {
        logError(error, 'All userId initialization attempts failed');
        throw error;
      }
    }
  }
};

// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ã®å®Œäº†ã‚’å¾…ã¤Promiseï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ä»˜ãï¼‰
const userIdPromise = initializeUserIdWithRetry();

// =============================================================================
// CORE INITIALIZATION FUNCTIONS
// =============================================================================

// Layout adjustment for responsive design
const adjustLayout = () => {
  const isMobile = window.innerWidth < 768;
  const body = document.body;
  
  if (isMobile) {
    body.classList.add('mobile-layout');
    body.classList.remove('desktop-layout');
  } else {
    body.classList.add('desktop-layout');
    body.classList.remove('mobile-layout');
  }
};

// Initialize core functionality
const initCore = () => {
  adjustLayout();
};

// Initialize message area
const initializeMessageArea = () => {
  let messageArea = document.getElementById('message-area');
  if (!messageArea) {
    // Create message area if it doesn't exist
    messageArea = document.createElement('div');
    messageArea.id = 'message-area';
    messageArea.className = 'fixed top-32 right-4 z-50 max-w-sm';
    document.body.appendChild(messageArea);
  }
};

// Initialize UI components
const initializeUI = () => {
  // UIåˆæœŸåŒ–ã®ã¿å®Ÿè¡Œã€loadStatusã¯ adminPanel-api.js ã§å‡¦ç†ã•ã‚Œã‚‹
};

// Initialize API functionality
const initializeAPI = () => {
  logDebug('ğŸ”§ APIåˆæœŸåŒ–é–‹å§‹');
  
  // Start background status updates with safe calling
  if (checkFunctionAvailability('startSystemStatusUpdate')) {
    safeCallFunction('startSystemStatusUpdate');
  } else {
    console.warn('âš ï¸ startSystemStatusUpdate not available - background updates disabled');
  }
  
  // Setup user activity tracking
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keypress', updateUserActivity);
  document.addEventListener('scroll', updateUserActivity);

  // åˆæœŸåŒ–æ™‚ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ­ãƒ¼ãƒ‰ - ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´ç‰ˆ
  logDebug('ğŸš€ åˆæœŸåŒ–æ™‚loadStatus(true)å‘¼ã³å‡ºã—ï¼ˆé…å»¶ã‚ã‚Šï¼‰');
  setTimeout(() => {
    if (checkFunctionAvailability('loadStatus')) {
      window.loadStatus(true);
    } else {
      console.warn('âš ï¸ loadStatus not available');
    }
  }, 500); // 500msé…å»¶ã§ã‚ˆã‚Šå®‰å…¨ãªåˆæœŸåŒ–
  
  logDebug('âœ… APIåˆæœŸåŒ–å®Œäº†');
};

// Update user activity timestamp for polling optimization
const updateUserActivity = () => {
  if (typeof lastUserActivity !== 'undefined') {
    lastUserActivity = Date.now();
  }
};

// Initialize event listeners
const initializeEventListeners = () => {
  
  // Use safe function calling with availability checks
  if (checkFunctionAvailability('setupEventListeners')) {
    safeCallFunction('setupEventListeners');
  } else {
    console.warn('âš ï¸ setupEventListeners function not available, attempting graceful degradation');
    
    // Basic fallback event listener setup
    if (checkFunctionAvailability('setupRealtimeValidation')) {
      safeCallFunction('setupRealtimeValidation');
    } else {
      console.warn('âš ï¸ setupRealtimeValidation not available - real-time validation disabled');
    }
  }
};

// Setup character counters
const setupCharacterCounters = () => {
  const questionTextarea = document.getElementById('custom-main-question');
  const questionCounter = document.getElementById('question-counter');

  if (questionTextarea && questionCounter) {
    questionTextarea.addEventListener('input', function() {
      const count = this.value.length;
      questionCounter.textContent = `${count}/500`;
      questionCounter.className = count > 450 ? 'text-xs text-red-400' : 'text-xs text-gray-500';
    });
  }
};

// Setup modal character counter observers
const setupModalCharacterCounters = () => {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŸã³ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const modal = document.getElementById('form-config-modal');
        if (modal && !modal.classList.contains('hidden')) {
          setTimeout(setupCharacterCounters, 100);
        }
      }
    });
  });
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç›£è¦–ã‚’é–‹å§‹
  const modal = document.getElementById('form-config-modal');
  if (modal) {
    observer.observe(modal, { attributes: true });
  }
};

// Navigate to specific step in admin panel
const navigateToStep = (step) => {
  if (typeof currentStep !== 'undefined') {
    currentStep = step;
  } else {
    // Define currentStep if not already defined
    window.currentStep = step;
  }
  
  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
    const stepNumber = index + 1;
    indicator.classList.toggle('completed', stepNumber < step);
    indicator.classList.toggle('active', stepNumber === step);
  });
  
  // Show/hide step content
  document.querySelectorAll('.step-content').forEach((content, index) => {
    const stepNumber = index + 1;
    content.classList.toggle('hidden', stepNumber !== step);
  });
  
  // Update progress bar
  const progressBar = document.querySelector('.progress-bar');
  if (progressBar) {
    progressBar.style.width = `${(step / 3) * 100}%`;
  }
  
  if (typeof validateCurrentStep === 'function') {
    validateCurrentStep();
  }
};

// Make navigateToStep globally available
window.navigateToStep = navigateToStep;

// Initialize main admin panel
function initializeAdminPanel(incomingUserId) {
  // userId is now managed globally by adminPanel-core.js
  if (typeof loadUserInfo === 'function') loadUserInfo();
  if (typeof loadSystemStatus === 'function') loadSystemStatus();
  if (typeof setupEventListeners === 'function') setupEventListeners();
  if (typeof setupRealtimeUpdates === 'function') setupRealtimeUpdates();
  if (typeof validateCurrentStep === 'function') validateCurrentStep();
}

// Make initializeAdminPanel globally available
window.initializeAdminPanel = initializeAdminPanel;

// Critical UI functions

// Toggle section visibility
// Legacy global function - redirects to class method
const toggleSection = (sectionId) => window.AdminPanel.UI.toggleSection(sectionId);

// Hide privacy modal
const hidePrivacyModal = () => {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('privacy-modal', false);
    }
  }
};

// Show form configuration modal
// Legacy global function - redirects to class method with enhanced functionality
const showFormConfigModal = () => {
  window.AdminPanel.UI.showFormConfigModal();
  // Additional legacy functionality
  if (typeof loadSavedClassChoices === 'function') {
    loadSavedClassChoices();
  }
  if (typeof manageFocusForModal === 'function') {
    manageFocusForModal('form-config-modal', true);
  }
};

// Enhanced updateUIWithNewStatus that works with both minimal and full implementations
function updateUIWithNewStatus(status) {
  if (!status) {
    console.warn('updateUIWithNewStatus: Invalid status received');
    return;
  }
  
  // Store for later use
  window.currentStatus = status;
  
  // Enhanced full implementation detection with multiple retries
  if (typeof window._fullUpdateUIWithNewStatus === 'function') {
    try {
      // æœ¬ç•ªç’°å¢ƒã§ã®ãƒ­ã‚°é‡ã‚’æ¸›ã‚‰ã™
      if (window.DEBUG_MODE || window.location.hostname === 'localhost') {
        console.log('updateUIWithNewStatus: Using full implementation');
      }
      return window._fullUpdateUIWithNewStatus(status);
    } catch (error) {
      console.warn('Full updateUIWithNewStatus failed, using fallback:', error);
      // Continue with minimal implementation below
    }
  } else {
    // Enhanced retry mechanism with multiple attempts
  const retryCount = 0;
  const maxRetries = 3;
  const retryDelays = [200, 500, 1000]; // Progressive delays
    
  const tryFullImplementation = function() {
      if (typeof window._fullUpdateUIWithNewStatus === 'function') {
        console.log(`updateUIWithNewStatus: Full implementation now available (retry ${retryCount + 1})`);
        try {
          window._fullUpdateUIWithNewStatus(status);
          return;
        } catch (error) {
          console.warn('Retried full updateUIWithNewStatus failed:', error);
        }
      }
      
      if (retryCount < maxRetries) {
        retryCount++;
        setTimeout(tryFullImplementation, retryDelays[retryCount - 1] || 1000);
      } else {
        console.log('updateUIWithNewStatus: Max retries exceeded, using minimal implementation only');
      }
    };
    
    // Start retry sequence
    setTimeout(tryFullImplementation, retryDelays[0]);
  }
  
  // Enhanced minimal implementation for comprehensive UI updates
  console.log('updateUIWithNewStatus: Using enhanced minimal implementation');
  
  // Update essential UI elements with comprehensive information
  try {
    // 1. Update publication status with indicators
    if (status._normalized && typeof status._normalized.isPublished !== 'undefined') {
  const publishStatus = status._normalized.isPublished ? 'å…¬é–‹ä¸­' : 'åœæ­¢ä¸­';
  const publishElement = document.getElementById('info-publish-text');
      if (publishElement) {
        publishElement.textContent = publishStatus;
      }
      
      // Update publish indicator
  const indicatorElement = document.getElementById('info-publish-indicator');
  const statusElement = document.getElementById('info-publish-status');
      if (status._normalized.isPublished) {
        if (statusElement) statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-green-600 text-white';
        if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-green-400';
      } else {
        if (statusElement) statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-gray-600 text-gray-300';
        if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      }
    }
    
    // 2. Update user information section
    if (status.userInfo) {
  const adminEmailEl = document.getElementById('info-admin-email');
  const userIdEl = document.getElementById('info-user-id');
      
      if (adminEmailEl && status.userInfo.adminEmail) {
        adminEmailEl.textContent = status.userInfo.adminEmail;
      }
      if (userIdEl && status.userInfo.userId) {
        userIdEl.textContent = status.userInfo.userId;
      }
      
      // Update spreadsheet access
      if (status.userInfo.spreadsheetUrl) {
  const spreadsheetBtn = document.getElementById('open-spreadsheet-btn-step2');
        if (spreadsheetBtn) {
          spreadsheetBtn.disabled = false;
          spreadsheetBtn.onclick = function() { window.open(status.userInfo.spreadsheetUrl, '_blank'); };
        }
      }
    }
    
    // 3. Update configuration display
    if (status.config || (status.userInfo && status.userInfo.configJson)) {
  const config = status.config;
      if (!config && status.userInfo.configJson) {
        try {
          config = typeof status.userInfo.configJson === 'string' 
            ? JSON.parse(status.userInfo.configJson) 
            : status.userInfo.configJson;
        } catch (e) {
          console.warn('Failed to parse configJson in minimal implementation');
        }
      }
      
      if (config) {
        // Update published sheet name
  const publishedSheetEl = document.getElementById('info-published-sheet');
        if (publishedSheetEl) {
          publishedSheetEl.textContent = config.publishedSheetName || status.activeSheetName || 'ãªã—';
        }
        
        // Update display mode
  const displayModeEl = document.getElementById('info-display-mode');
        if (displayModeEl) {
          displayModeEl.textContent = config.showNames ? 'åå‰è¡¨ç¤º' : 'åŒ¿åè¡¨ç¤º';
        }
        
        // Update show counts setting
  const showCountsEl = document.getElementById('info-show-counts');
        if (showCountsEl) {
          showCountsEl.textContent = config.showCounts ? 'è¡¨ç¤º' : 'éè¡¨ç¤º';
        }
      }
    }
    
    // 4. Update answer count if available
    if (status.answerCount !== undefined) {
  const answerCountElement = document.getElementById('answer-count');
      if (answerCountElement) {
        answerCountElement.textContent = status.answerCount || '0';
      }
    }
    
    // 5. Update active sheet information
    if (status.activeSheetName) {
  const sheetNameElements = document.querySelectorAll('.active-sheet-name');
      sheetNameElements.forEach(function(element) {
        element.textContent = status.activeSheetName;
      });
    }
    
    
  } catch (error) {
    console.error('Error in enhanced minimal updateUIWithNewStatus:', error);
  }
}

// Hide digital citizenship modal
function hideDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('digital-citizenship-modal', false);
    }
  }
}

// Hide confirmation modal
function hideConfirmationModal() {
  const modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (typeof manageFocusForModal === 'function') {
      manageFocusForModal('confirmation-modal', false);
    }
  }
}

// Unified showMessage function - uses SharedUtilities MessageManager
function showMessage(message, type = 'info', duration = 5000) {
  console.log(`[${type.toUpperCase()}] ${message}`);
  
  // Use SharedUtilities MessageManager if available
  if (window.sharedUtilities?.messages?.show) {
    return window.sharedUtilities.messages.show(message, type, duration);
  }
  
  // Fallback for cases where SharedUtilities is not loaded
  console.warn('âš ï¸ SharedUtilities MessageManager not available, using console fallback');
}

// =============================================================================
// VALIDATION FUNCTIONS - Moved from adminPanel-ui.js.html for early availability
// =============================================================================

// Validate configuration with fallback logic
function validateConfig() {
  // Try to use the full implementation if available
  if (typeof window._fullValidateConfig === 'function') {
    try {
      return window._fullValidateConfig();
    } catch (error) {
      console.warn('Full validateConfig failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential validation
  console.log('validateConfig: Using minimal implementation');
  
  try {
    // Check primary element first, then fallback to secondary element
  const opinionValueEl1 = document.getElementById('opinionHeader');
  const opinionValueEl2 = document.getElementById('reason-column');
  const opinionValue = (opinionValueEl1 && opinionValueEl1.value) || 
                        (opinionValueEl2 && opinionValueEl2.value) || '';
    
    return opinionValue && opinionValue.trim() !== '';
  } catch (error) {
    console.error('Error in minimal validateConfig:', error);
    return false;
  }
}

// Update configuration buttons state with fallback logic
function updateConfigButtons() {
  // Try to use the full implementation if available
  if (typeof window._fullUpdateConfigButtons === 'function') {
    try {
      return window._fullUpdateConfigButtons();
    } catch (error) {
      console.warn('Full updateConfigButtons failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential button updates
  console.log('updateConfigButtons: Using minimal implementation');
  
  try {
  const isValid = validateConfig();
  const saveBtn = document.getElementById('save-publish-btn');
    
    if (saveBtn) {
      saveBtn.disabled = !isValid;
      if (isValid) {
        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }
  } catch (error) {
    console.error('Error in minimal updateConfigButtons:', error);
  }
}

// =============================================================================
// FUNCTION AVAILABILITY MANAGEMENT
// =============================================================================

// Central function availability checker
function checkFunctionAvailability(functionName) {
  const isAvailable = typeof window[functionName] === 'function';
  if (!isAvailable) {
    console.warn(`âš ï¸ Function ${functionName} is not available`);
  }
  return isAvailable;
}

// Safe function caller with fallback handling
function safeCallFunction(functionName, ...args) {
  try {
    if (checkFunctionAvailability(functionName)) {
      return window[functionName](...args);
    } else {
      console.warn(`âš ï¸ Cannot call ${functionName} - function not available`);
      return null;
    }
  } catch (error) {
    console.error(`âŒ Error calling ${functionName}:`, error);
    return null;
  }
}

// Enhanced function registry with full implementation tracking
window.AdminPanel.functionRegistry = {
  available: new Set(),
  pending: new Set(),
  fullImplementations: new Set(),
  
  register(functionName) {
    if (typeof window[functionName] === 'function') {
      this.available.add(functionName);
      this.pending.delete(functionName);
    } else {
      this.pending.add(functionName);
      console.warn('âš ï¸ Function pending: ' + functionName);
    }
  },
  
  registerFullImplementation(functionName) {
  const fullFuncName = '_full' + functionName.charAt(0).toUpperCase() + functionName.slice(1);
    if (typeof window[fullFuncName] === 'function') {
      this.fullImplementations.add(functionName);
      // Verbose implementation logging disabled for performance
    }
  },
  
  hasFullImplementation(functionName) {
  const fullFuncName = '_full' + functionName.charAt(0).toUpperCase() + functionName.slice(1);
    return typeof window[fullFuncName] === 'function';
  },
  
  isAvailable(functionName) {
    return this.available.has(functionName);
  },
  
  // Enhanced full implementation detection
  checkForFullImplementations() {
  const functionsToCheck = [
      'updateUIWithNewStatus', 'populateHeaderOptions', 'populateConfig', 
      'updateFormUrlDisplay', 'validateConfig', 'updateConfigButtons'
    ];
    
  const foundCount = 0;
  const self = this;
    functionsToCheck.forEach(function(funcName) {
      if (self.hasFullImplementation(funcName)) {
        self.registerFullImplementation(funcName);
        foundCount++;
      }
    });
    
    // æœ¬ç•ªç’°å¢ƒã§ã®ãƒ­ã‚°é‡ã‚’æ¸›ã‚‰ã™
    if (window.DEBUG_MODE || window.location.hostname === 'localhost') {
      console.log(`ğŸ” Full implementations check: ${foundCount}/${functionsToCheck.length} available`);
    }
    return foundCount;
  },
  
  waitFor(functionName, timeout = 5000) {
    return new Promise(function(resolve, reject) {
      if (this.isAvailable(functionName)) {
        resolve(window[functionName]);
        return;
      }
      
  const startTime = Date.now();
  const checkInterval = setInterval(function() {
        if (this.isAvailable(functionName)) {
          clearInterval(checkInterval);
          resolve(window[functionName]);
        } else if (Date.now() - startTime > timeout) {
          clearInterval(checkInterval);
          reject(new Error(`Function ${functionName} not available after ${timeout}ms`));
        }
      }, 100);
    });
  }
};

// =============================================================================
// ADDITIONAL UI FUNCTIONS - Critical functions that were missing
// =============================================================================

// Update form URL display (minimal implementation)
function updateFormUrlDisplay(status = null) {
  // Try to use the full implementation if available
  if (typeof window._fullUpdateFormUrlDisplay === 'function') {
    try {
      return window._fullUpdateFormUrlDisplay(status);
    } catch (error) {
      console.warn('Full updateFormUrlDisplay failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential form URL updates
  console.log('updateFormUrlDisplay: Using minimal implementation');
  
  try {
  const formUrlInput = document.getElementById('form-url-input');
    if (!formUrlInput) return;
    
  const currentStatusToUse = status || window.currentStatus;
    if (!currentStatusToUse || !currentStatusToUse.userInfo) {
      console.warn('âš ï¸ updateFormUrlDisplay: statusæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
      return;
    }
    
    // Simple form URL extraction
  const formUrl = null;
    if (currentStatusToUse.userInfo.configJson) {
      try {
  const config = typeof currentStatusToUse.userInfo.configJson === 'string' 
          ? JSON.parse(currentStatusToUse.userInfo.configJson) 
          : currentStatusToUse.userInfo.configJson;
        formUrl = config.formUrl;
      } catch (e) {
        console.warn('Failed to parse configJson for form URL');
      }
    }
    
    if (formUrl) {
      formUrlInput.value = formUrl;
  const openFormLink = document.getElementById('open-form-url-link');
      if (openFormLink) {
        openFormLink.href = formUrl;
      }
    }
  } catch (error) {
    console.error('Error in minimal updateFormUrlDisplay:', error);
  }
}

// Populate header options (minimal implementation)
function populateHeaderOptions(headers) {
  // Try to use the full implementation if available
  if (typeof window._fullPopulateHeaderOptions === 'function') {
    try {
      return window._fullPopulateHeaderOptions(headers);
    } catch (error) {
      console.warn('Full populateHeaderOptions failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential header population
  console.log('populateHeaderOptions: Using minimal implementation');
  
  try {
    if (window.populateHeaderOptionsRunning) {
      return;
    }
    window.populateHeaderOptionsRunning = true;
    
  const selects = ['opinionHeader', 'reason-column', 'name-column', 'class-column'];
    
    selects.forEach(function(selectId) {
  const select = document.getElementById(selectId);
      if (select) {
  const currentValue = select.value;
        
        if (headers && headers.length > 0) {
          select.innerHTML = '<option value="">-- åˆ—ã‚’é¸æŠ --</option>';
          headers.forEach(function(header) {
            if (header && typeof header === 'string' && header.trim()) {
  const option = document.createElement('option');
              option.value = header;
              option.textContent = header;
              select.appendChild(option);
            }
          });
          select.disabled = false;
          if (currentValue) {
            select.value = currentValue;
          }
        } else {
          select.innerHTML = '<option value="">-- ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
          select.disabled = true;
        }
      }
    });
    
    setTimeout(function() {
      window.populateHeaderOptionsRunning = false;
    }, 100);
  } catch (error) {
    console.error('Error in minimal populateHeaderOptions:', error);
    window.populateHeaderOptionsRunning = false;
  }
}

// Make all critical functions globally available immediately
window.toggleSection = toggleSection;
window.hidePrivacyModal = hidePrivacyModal;
window.hideDigitalCitizenshipModal = hideDigitalCitizenshipModal;
window.hideConfirmationModal = hideConfirmationModal;
window.showFormConfigModal = showFormConfigModal;
window.showMessage = showMessage; // Unified with SharedUtilities MessageManager
window.updateUIWithNewStatus = updateUIWithNewStatus;
window.validateConfig = validateConfig;
window.updateConfigButtons = updateConfigButtons;
// Populate configuration (minimal implementation)
function populateConfig(cfg) {
  // å±¥æ­´å¾©å…ƒä¸­ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãŸã ã—ã€ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯é™¤ãï¼‰
  if ((window._historyRestoreInProgress || window._historyColumnSelections) && !window._draftModeActive) {
    console.log('ğŸ›¡ï¸ populateConfig: å±¥æ­´å¾©å…ƒä¸­ã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ');
    return;
  }
  
  // ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ­ã‚°å‡ºåŠ›
  if (window._draftModeActive) {
    console.log('ğŸ“ populateConfig: ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã§è¨­å®šã‚’åæ˜ ä¸­');
  }
  
  // Try to use the full implementation if available
  if (typeof window._fullPopulateConfig === 'function') {
    try {
      return window._fullPopulateConfig(cfg);
    } catch (error) {
      console.warn('Full populateConfig failed, using fallback:', error);
    }
  }
  
  // Minimal implementation for essential config population
  console.log('populateConfig: Using minimal implementation');
  
  try {
    if (!cfg) return;
    
    if (window.populateConfigRunning) {
      return;
    }
    window.populateConfigRunning = true;
    
  const mappings = {
      'opinionHeader': cfg.opinionHeader || cfg.opinionColumn,
      'reason-column': cfg.reasonColumn || cfg.reasonHeader,
      'name-column': cfg.nameColumn || cfg.nameHeader,
      'class-column': cfg.classColumn || cfg.classHeader,
      'show-names': cfg.showNames,
      'show-counts': cfg.showCounts
    };
    
    Object.keys(mappings).forEach(function(elementId) {
  const element = document.getElementById(elementId);
  const value = mappings[elementId];
      
      if (element && value !== undefined) {
        if (element.type === 'checkbox') {
          element.checked = Boolean(value);
        } else {
          element.value = value;
        }
      }
    });
    
    setTimeout(function() {
      window.populateConfigRunning = false;
    }, 100);
  } catch (error) {
    console.error('Error in minimal populateConfig:', error);
    window.populateConfigRunning = false;
  }
}

window.updateFormUrlDisplay = updateFormUrlDisplay;
window.populateHeaderOptions = populateHeaderOptions;
window.populateConfig = populateConfig;
window.checkFunctionAvailability = checkFunctionAvailability;
window.safeCallFunction = safeCallFunction;

// Register all critical functions
  const criticalFunctions = [
  'toggleSection', 'hidePrivacyModal', 'hideDigitalCitizenshipModal', 
  'hideConfirmationModal', 'showFormConfigModal', 'showMessage', 
  'updateUIWithNewStatus', 'validateConfig', 'updateConfigButtons', 
  'updateFormUrlDisplay', 'populateHeaderOptions', 'populateConfig',
  'navigateToStep', 'initializeAdminPanel'
];

criticalFunctions.forEach(function(funcName) {
  window.AdminPanel.functionRegistry.register(funcName);
});

// Full implementation monitoring with periodic checks
  const fullImplCheckCount = 0;
  const maxFullImplChecks = 10;

function checkFullImplementationsAvailability() {
  fullImplCheckCount++;
  const foundCount = window.AdminPanel.functionRegistry.checkForFullImplementations();
  
  if (foundCount > 0) {
    console.log(`ğŸ‰ Found ${foundCount} full implementations on attempt ${fullImplCheckCount}`);
    
    // Force retry of UI updates with full implementations now available
    if (window.currentStatus && foundCount >= 3) {
      console.log('ğŸ”„ Retrying UI updates with full implementations');
      setTimeout(function() {
        if (typeof window._fullUpdateUIWithNewStatus === 'function') {
          window._fullUpdateUIWithNewStatus(window.currentStatus);
        }
      }, 100);
    }
  } else if (fullImplCheckCount < maxFullImplChecks) {
    // Continue checking for full implementations
    setTimeout(checkFullImplementationsAvailability, 500);
  } else {
    console.warn('âš ï¸ Full implementations not found after maximum attempts');
  }
}

// Start monitoring for full implementations after a delay
setTimeout(checkFullImplementationsAvailability, 300);

// =============================================================================
// SYSTEM STATUS AND USER INTERACTION MANAGEMENT
// =============================================================================

// ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ç”¨ã®çŠ¶æ…‹ç®¡ç†
window.systemStatus = {
  initializationStarted: false,
  coreInitialized: false,
  apiInitialized: false,
  uiInitialized: false,
  eventsInitialized: false,
  initializationComplete: false,
  userDataSyncComplete: false,
  errors: [],
  lastActivity: Date.now()
};

// åˆæœŸåŒ–ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œé˜²æ­¢ - DOMæº–å‚™å®Œäº†å¾Œã«å®Ÿè¡Œ
if (document.body) {
  document.body.style.pointerEvents = 'none';
  console.log('ğŸ›¡ï¸ User interaction disabled during initialization');
} else {
  // DOMèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
  document.addEventListener('DOMContentLoaded', function() {
    if (document.body) {
      document.body.style.pointerEvents = 'none';
      console.log('ğŸ›¡ï¸ User interaction disabled during initialization (delayed)');
    }
  });
}

// ä¸»è¦ãªUIè¦ç´ ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹é–¢æ•°
function disableUserInteraction() {
  // DOMæº–å‚™å®Œäº†ãƒã‚§ãƒƒã‚¯
  if (!document || !document.body) {
    console.warn('âš ï¸ DOM not ready for disableUserInteraction');
    return;
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ç„¡åŠ¹åŒ–
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(function(element) {
    element.disabled = true;
    element.style.opacity = '0.6';
  });
  
  // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¦ç´ ã®ç„¡åŠ¹åŒ–
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(function(element) {
    element.style.pointerEvents = 'none';
    element.style.opacity = '0.6';
  });
  
  // bodyè¦ç´ ã®ç„¡åŠ¹åŒ–
  document.body.style.pointerEvents = 'none';
  
  console.log('ğŸ›¡ï¸ All interactive elements disabled');
}

// UIè¦ç´ ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹é–¢æ•°
function enableUserInteraction() {
  // DOMæº–å‚™å®Œäº†ãƒã‚§ãƒƒã‚¯
  if (!document || !document.body) {
    console.warn('âš ï¸ DOM not ready for enableUserInteraction');
    return;
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®æœ‰åŠ¹åŒ–
  const forms = document.querySelectorAll('form, input, button, select, textarea');
  forms.forEach(function(element) {
    element.disabled = false;
    element.style.opacity = '';
  });
  
  // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¦ç´ ã®æœ‰åŠ¹åŒ–
  const clickables = document.querySelectorAll('[onclick], .btn, .button');
  clickables.forEach(function(element) {
    element.style.pointerEvents = '';
    element.style.opacity = '';
  });
  
  // bodyè¦ç´ ã‚‚æœ‰åŠ¹åŒ–
  document.body.style.pointerEvents = 'auto';
  
  console.log('âœ… All interactive elements enabled');
}

// DOMèª­ã¿è¾¼ã¿å¾Œã«è¦ç´ ã‚’ç„¡åŠ¹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', disableUserInteraction);
} else {
  disableUserInteraction();
}

function updateSystemStatus(component, status, error = null) {
  window.systemStatus[component] = status;
  window.systemStatus.lastActivity = Date.now();
  if (error) {
    window.systemStatus.errors.push({ component, error: error.toString(), timestamp: Date.now() });
  }
  logDebug(`ğŸ“Š System Status: ${component} = ${status}`);
}

// å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†
function checkAndExpandAllSections() {
  try {
  const expandAllFlag = localStorage.getItem('expandAllSections');
    if (expandAllFlag === 'true') {
      logInfo('ğŸ“‚ å…¬é–‹åœæ­¢å¾Œã®ãŸã‚å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ã—ã¾ã™');
      
      // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ï¼ˆDOMè¦ç´ ã®æº–å‚™ã‚’å¾…ã¤ï¼‰
      setTimeout(function() {
  const sectionIds = ['step1-content', 'step2-content', 'step3-content'];
  const expandedCount = 0;
        
        sectionIds.forEach(function(sectionId) {
  const section = document.getElementById(sectionId);
          if (section) {
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å±•é–‹
            if (section.classList.contains('hidden')) {
              if (typeof toggleSection === 'function') {
                toggleSection(sectionId);
                expandedCount++;
                logDebug('âœ… ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹: ' + sectionId);
              }
            }
          }
        });
        
        if (expandedCount > 0) {
          logInfo('ğŸ“‚ ' + expandedCount + 'å€‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹ã—ã¾ã—ãŸ');
        }
        
        // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
        localStorage.removeItem('expandAllSections');
        logDebug('ğŸ§¹ å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      }, 500);
    }
  } catch (error) {
    logWarn('âš ï¸ å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// =============================================================================
// MASTER INITIALIZATION SYSTEM
// =============================================================================

function initializeAdminPanelMaster() {
  // ã‚·ãƒ³ãƒ—ãƒ«åŒ–: é‡è¤‡åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯ã‚’ç°¡ç´ åŒ–
  if (window.AdminPanel.initialization.isCompleted) {
    logDebug('âœ… AdminPanel already initialized');
    return;
  }
  
  window.AdminPanel.initialization.isInProgress = true;
  logInfo('ğŸš€ AdminPanel Master Initialization Started');
  
  // Phase 1: CoreåˆæœŸåŒ–
  try {
    initCore();
  } catch (error) {
    console.error('âŒ Core initialization failed:', error);
  }
  
  // å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹å‡¦ç†
  checkAndExpandAllSections();
  
  // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°è¦ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤ºï¼‰
  setTimeout(function() {
  const formJustCreated = sessionStorage.getItem('form_just_created');
    if (formJustCreated !== 'true') {
      // æ–°è¦ä½œæˆã§ã¯ãªã„å ´åˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
  const formUrlSection = document.getElementById('form-url-section');
      if (formUrlSection && !formUrlSection.classList.contains('hidden')) {
        formUrlSection.classList.add('hidden');
        logDebug('ğŸ“‹ æ—¢å­˜ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º');
      }
    }
  }, 100);
  
  // Phase 2: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¸¦åˆ—åˆæœŸåŒ– (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š)
  // é…å»¶ã‚’æœ€å°é™ã«æŠ‘åˆ¶ã—ã¦å³åº§ã«åˆæœŸåŒ–
  setTimeout(function() {
    logDebug('ğŸ”§ Phase 2: ä¸¦åˆ—ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–é–‹å§‹');
    
    // Statusç®¡ç†åˆæœŸåŒ–
    try {
      initializeMessageArea();
      logDebug('âœ… Status module initialized');
    } catch (error) {
      logError('âŒ Status module initialization failed:', error);
    }
    
    // APIé€šä¿¡åˆæœŸåŒ–
    try {
      logDebug('ğŸš€ API module initialization...');
      initializeAPI();
      logDebug('âœ… API module initialized');
    } catch (error) {
      console.error('âŒ API initialization failed:', error);
    }
    
    // UIåˆæœŸåŒ–
    try {
      initializeUI();
      logDebug('âœ… UI module initialized');
    } catch (error) {
      console.error('âŒ UI initialization failed:', error);
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†åˆæœŸåŒ–
    try {
      setupCharacterCounters();
      setupModalCharacterCounters();
      logDebug('âœ… Forms module initialized');
    } catch (error) {
      logError('âŒ Forms module initialization failed:', error);
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†åˆæœŸåŒ–ï¼ˆæœ€å¾Œã«å®Ÿè¡Œï¼‰
    setTimeout(function() {
      try {
        initializeEventListeners();
        logDebug('âœ… Events module initialized');
        logInfo('ğŸ‰ AdminPanel Master Initialization Complete');
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®åŒæœŸã¨æœ€çµ‚å‡¦ç†
        finalizeInitialization();
        
      } catch (error) {
        updateSystemStatus('eventsInitialized', false, error);
        console.error('âŒ Events initialization failed:', error);
        
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚æœ€çµ‚å‡¦ç†ã¯å®Ÿè¡Œ
        finalizeInitialization();
      }
    }, 100);
    
  }, 10);
}

// Finalize initialization and enable user interaction
async function finalizeInitialization() {
  setTimeout(function() {
    try {
      console.log('ğŸ”„ Final initialization steps...');
      
      // ã™ã¹ã¦ã®åŒæœŸãŒå®Œäº†ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
      if (window.unifiedLoading) {
        window.unifiedLoading.hide();
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥DOMæ“ä½œ
  const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.add('hidden');
        }
      }
      
      // UIè¦ç´ ã®æœ‰åŠ¹åŒ–
      enableUserInteraction();
      
      // Initialize and load history table after all initialization is complete
      try {
        console.log('ğŸ”„ Initializing HistoryManager...');
        if (window.HistoryManager) {
          window.HistoryManager.initialize();
          console.log('ğŸ”„ Loading history table after initialization...');
          window.HistoryManager.renderTable();
        } else {
          console.warn('âš ï¸ HistoryManager not available yet');
        }
      } catch (historyError) {
        console.warn('âš ï¸ History initialization/loading failed:', historyError);
      }
      
      // Draft recovery after initialization complete
      try {
        console.log('ğŸ”„ Checking for draft recovery...');
        if (typeof recoverDraftIfAvailable === 'function') {
          recoverDraftIfAvailable();
        }
      } catch (draftError) {
        console.warn('âš ï¸ Draft recovery failed:', draftError);
      }
      
      // è¿½åŠ ã®åˆæœŸåŒ–ã‚¿ã‚¹ã‚¯
      // ã‚¢ãƒ—ãƒªè¨­å®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
      const appSetupBtn = document.getElementById('app-setup-btn');
      if (appSetupBtn && typeof openAppSetupPage === 'function') {
        appSetupBtn.addEventListener('click', function(e) {
          e.preventDefault();
          openAppSetupPage();
        });
      }
      if (window.sharedModals) {
        window.sharedModals.loadAdminModals();
      }
      // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
      setTimeout(() => {
        if (typeof updateHistoryTable === 'function') updateHistoryTable();
      }, 100);
      
      // åˆæœŸåŒ–å®Œäº†
      window.AdminPanel.initialization.isInProgress = false;
      window.AdminPanel.initialization.isCompleted = true;
      logInfo('âœ… AdminPanel Master Initialization Completed');
      
    } catch (error) {
      console.error('âŒ Final sync error:', error);
      // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è§£é™¤
      if (window.unifiedLoading) {
        window.unifiedLoading.hide();
      }
      enableUserInteraction();
      
      // åˆæœŸåŒ–å®Œäº†ï¼ˆã‚¨ãƒ©ãƒ¼ã‚ã‚Šã§ã‚‚ï¼‰
      window.AdminPanel.initialization.isInProgress = false;
      window.AdminPanel.initialization.isCompleted = true;
      logWarn('âš ï¸ AdminPanel initialization completed with errors');
    }
  }, 500);
}

// å˜ä¸€DOMContentLoadedãƒãƒ³ãƒ‰ãƒ©ãƒ¼
if (document.readyState !== 'loading') {
  initializeAdminPanelMaster();
} else {
  document.addEventListener('DOMContentLoaded', initializeAdminPanelMaster);
}

// Update layout on resize
window.addEventListener('resize', function() {
  if (typeof debounce === 'function') {
    debounce(adjustLayout, 250, 'layout-resize')();
  } else {
    // Fallback without debounce
    adjustLayout();
  }
});

// Individual user access control is now handled in AppSetupPage.html

// History management system

/**
 * Unified History Manager - Simple, Error-Resilient, Single Responsibility
 */
window.HistoryManager = {
  // Constants
  STORAGE_KEY: 'answerBoardHistory',
  OLD_STORAGE_KEY: 'adminPanelHistory', // For migration
  MAX_ITEMS: 5,
  
  // Initialization state
  _initialized: false,
  
  /**
   * Initialize the History Manager
   */
  initialize() {
    try {
      if (this._initialized) {
        console.log('ğŸ”„ HistoryManager already initialized');
        return true;
      }
      
      console.log('ğŸš€ HistoryManager initializing...');
      
      // Migrate old data if exists
      this._migrateOldData();
      
      this._initialized = true;
      return true;
      
    } catch (error) {
      console.error('âŒ HistoryManager initialization failed:', error);
      return false;
    }
  },
  
  /**
   * Migrate data from old storage key to new key
   */
  _migrateOldData() {
    try {
  const oldData = localStorage.getItem(this.OLD_STORAGE_KEY);
  const newData = localStorage.getItem(this.STORAGE_KEY);
      
      if (oldData && !newData) {
        console.log('ğŸ”„ Migrating history data from old key...');
        localStorage.setItem(this.STORAGE_KEY, oldData);
        localStorage.removeItem(this.OLD_STORAGE_KEY);
      }
    } catch (error) {
      console.warn('âš ï¸ History data migration failed:', error);
    }
  },
  
  /**
   * Load history from localStorage with error handling
   */
  load() {
    try {
      console.log('ğŸ”„ Loading history from localStorage...');
  const data = localStorage.getItem(this.STORAGE_KEY);
  const parsed = data ? JSON.parse(data) : [];
  const validated = Array.isArray(parsed) ? parsed : [];
      console.log('âœ… Loaded ' + validated.length + ' history items');
      return validated;
    } catch (error) {
      console.error('âŒ Failed to load history:', error);
      return [];
    }
  },
  
  /**
   * Save history to localStorage with error handling
   */
  save(items) {
    try {
  const safeItems = Array.isArray(items) ? items : [];
  const limitedItems = safeItems.slice(0, this.MAX_ITEMS);
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(limitedItems));
      console.log('âœ… Saved ' + limitedItems.length + ' history items');
      return true;
    } catch (error) {
      console.error('âŒ Failed to save history:', error);
      return false;
    }
  },
  
  /**
   * Add new item to history
   */
  add(newItem) {
    try {
      if (!newItem || !newItem.id) {
        console.warn('âš ï¸ Invalid history item provided');
        return false;
      }
      
  const history = this.load();
      history.unshift(newItem);
      return this.save(history);
    } catch (error) {
      console.error('âŒ Failed to add history item:', error);
      return false;
    }
  },
  
  /**
   * Clear all history
   */
  clear() {
    try {
      localStorage.removeItem(this.STORAGE_KEY);
      localStorage.removeItem(this.OLD_STORAGE_KEY); // Clean old key too
      return true;
    } catch (error) {
      console.error('âŒ Failed to clear history:', error);
      return false;
    }
  },
  /**
   * Format date for created date column (æ—¥ä»˜ã®ã¿è¡¨ç¤º)
   */
  _formatCreatedDate(dateStr) {
    if (!dateStr) return 'æœªè¨­å®š';
    try {
  const date = new Date(dateStr);
      return date.toLocaleDateString('ja-JP', {
        month: '2-digit',
        day: '2-digit'
      }).replace(/\//g, '/');  // "08/12" å½¢å¼
    } catch {
      return dateStr;
    }
  },

  /**
   * Format date for published date column (å¹´2æ¡çœç•¥ + æ™‚é–“ä»˜ã)
   */
  _formatPublishedDate(dateStr) {
    if (!dateStr) return 'æœªè¨­å®š';
    try {
  const date = new Date(dateStr);
      return date.toLocaleString('ja-JP', {
        year: '2-digit',  // 25å¹´è¡¨ç¤º
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }).replace(/\//g, '/');  // "25/08/12 08:45" å½¢å¼
    } catch {
      return dateStr;
    }
  },

  /**
   * Format settings display with icons and clear meanings (showNames/showCounts based)
   */
  _formatSettingsDisplay(item) {
    // showNamesãƒ™ãƒ¼ã‚¹ã®åˆ¤å®šï¼ˆä¸‹ä½äº’æ›æ€§ã‚‚è€ƒæ…®ï¼‰
  const isShowNames = false;
    if (item.showNames !== undefined) {
      isShowNames = item.showNames;
    } else if (item.displayMode !== undefined) {
      // æ—§ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
      isShowNames = item.displayMode === 'named';
    }
    
  const displayPart = isShowNames ? 'ğŸ‘¥é€šå¸¸' : 'ğŸ­åŒ¿å';
  const countPart = item.showCounts ? 'ğŸ”¢è¡¨ç¤º' : 'ğŸš«éè¡¨ç¤º';
    return displayPart + '/' + countPart;
  },

  /**
   * Render history table in the UI
   */
  renderTable() {
    try {
      if (!this._initialized) {
        console.warn('âš ï¸ HistoryManager not initialized, initializing now...');
        if (!this.initialize()) {
          console.error('âŒ Cannot render table - initialization failed');
          return false;
        }
      }
      
      console.log('ğŸ”„ Rendering history table...');
  const tableBody = document.getElementById('history-table-body');
      
      if (!tableBody) {
        console.warn('âŒ History table body element not found');
        return false;
      }
      
      // Show loading state
      tableBody.innerHTML = `
        <tr>
          <td colspan="4" class="px-3 py-6 text-center text-gray-500 text-sm">
            <div class="flex flex-col items-center justify-center">
              <div class="spinner mb-3"></div>
              <div>å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
          </td>
        </tr>
      `;
      
      // Load and display history
  const history = this.load();
      tableBody.innerHTML = '';
      
      if (history.length === 0) {
        this._renderEmptyState(tableBody);
        return true;
      }
      
      // Render history items
  const successCount = 0;
      history.forEach(function(item, index) {
        try {
  const row = this._createHistoryTableRow(item, index);
          if (row) {
            tableBody.appendChild(row);
            successCount++;
          }
        } catch (error) {
          console.warn('âš ï¸ Failed to render history item:', error);
        }
      });
      
      return true;
      
    } catch (error) {
      console.error('âŒ Failed to render history table:', error);
      this._renderErrorState();
      return false;
    }
  },
  
  /**
   * Render empty state for history table
   */
  _renderEmptyState(tableBody) {
  const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = `
      <td colspan="4" class="px-3 py-8 text-center text-gray-500 text-sm">
        <div class="flex flex-col items-center">
          <div class="text-4xl mb-2">ğŸ“</div>
          <div class="font-medium mb-1">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
          <div class="text-xs text-gray-600">ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…¬é–‹ã™ã‚‹ã¨å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </td>
    `;
    tableBody.appendChild(emptyRow);
  },
  
  /**
   * Render error state for history table
   */
  _renderErrorState() {
  const tableBody = document.getElementById('history-table-body');
    if (tableBody) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="4" class="px-3 py-4 text-center text-red-500 text-sm">
            å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ
          </td>
        </tr>
      `;
    }
  },
  
  /**
   * Create a table row for a history item
   */
  _createHistoryTableRow(item, index) {
    try {
  const row = document.createElement('tr');
      
      // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä»•æ§˜ã«åˆã‚ã›ã¦ä¿®æ­£ï¼‰
  const createdDate = this._formatCreatedDate(item.createdDate);      // "08/12"
  const publishedDate = this._formatPublishedDate(item.publishedAt);  // "25/08/12 08:45"
      
      // å•é¡Œæ–‡å‡¦ç†
  const question = this._escapeHtml(item.questionText || 'æœªè¨­å®š');
  const truncated = question.length > 30 ? question.substring(0, 30) + '...' : question;
      
      // è¨­å®šè¡¨ç¤ºï¼ˆã‚¢ã‚¤ã‚³ãƒ³/æ„å‘³æ˜ç¢ºåŒ–ï¼‰
  const settingsDisplay = this._formatSettingsDisplay(item);
      
      // 4åˆ—HTMLç”Ÿæˆ
      row.innerHTML = `
        <td class="px-3 py-2 text-sm">${createdDate}</td>
        <td class="px-3 py-2 text-sm">${publishedDate}</td>
        <td class="px-3 py-2 text-sm" title="${question}">${truncated}</td>
        <td class="px-3 py-2 text-xs text-white">${settingsDisplay}</td>
      `;
      
      // è¡Œã‚¯ãƒªãƒƒã‚¯å¾©å…ƒæ©Ÿèƒ½ï¼ˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ä»˜ãï¼‰
      row.style.cursor = 'pointer';
      row.classList.add('hover:bg-gray-700', 'transition-colors');
      row.addEventListener('click', function() {
        this._showRestoreConfirmationModal(item);
      });
      
      return row;
    } catch (error) {
      console.error('âŒ Failed to create history table row:', error);
      return null;
    }
  },
  
  /**
   * Show restore confirmation modal
   */
  showRestoreModal(itemId) {
    try {
  const history = this.load();
  const item = history.find(function(h) { return h.id === itemId; });
      
      if (!item) {
        console.error('âŒ History item not found:', itemId);
        return;
      }
      
      if (typeof showMessage === 'function') {
        showMessage('ğŸ”„ è¨­å®šã‚’å¾©å…ƒä¸­...', 'info');
      }
      
      // Perform restoration
      this._restoreHistoryItem(item);
      
    } catch (error) {
      console.error('âŒ Failed to show restore modal:', error);
    }
  },

  /**
   * Show restore confirmation modal before actually restoring
   */
  _showRestoreConfirmationModal(item) {
    try {
      // é‡è¤‡å®Ÿè¡Œé˜²æ­¢
      if (this._isRestoreInProgress) {
        console.log('âš ï¸ Restore already in progress, ignoring duplicate request');
        return;
      }
      
      console.log('ğŸ”„ Showing restore confirmation modal for:', item.questionText);
      
      // å¾©å…ƒã™ã‚‹è¨­å®šã®è©³ç´°æƒ…å ±ã‚’æº–å‚™
  const formattedDate = this._formatCreatedDate(item.createdDate);
  const truncatedQuestion = item.questionText && item.questionText.length > 50 
        ? item.questionText.substring(0, 50) + '...' 
        : (item.questionText || 'æœªè¨­å®š');
      
      // ç¾åœ¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—
  const currentSpreadsheetId = window.currentStatus?.userInfo?.spreadsheetId || null;
  const targetSpreadsheetId = item.spreadsheetId || null;
  const hasSpreadsheetDifference = currentSpreadsheetId && targetSpreadsheetId && 
                                     currentSpreadsheetId !== targetSpreadsheetId;
      
      // æ‹¡å¼µã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ€ãƒ«HTMLã‚’ç”Ÿæˆ
      this._showEnhancedRestoreModal(item, {
        truncatedQuestion,
        formattedDate,
        hasSpreadsheetDifference,
        currentSpreadsheetId,
        targetSpreadsheetId
      });
      
    } catch (error) {
      console.error('âŒ Failed to show restore confirmation modal:', error);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å…ƒã®ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«
      this._showFallbackRestoreModal(item);
    }
  },

  /**
   * Show enhanced restore confirmation modal with detailed layout
   */
  _showEnhancedRestoreModal(item, details) {
  const modal = document.getElementById('confirmation-modal');
    if (!modal) {
      console.warn('âš ï¸ confirmation-modal not found, using fallback');
      this._showFallbackRestoreModal(item);
      return;
    }

    // ã‚«ã‚¹ã‚¿ãƒ HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ
  const modalContent = this._generateRestoreModalHTML(item, details);
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’ä¸€æ™‚çš„ã«ç½®ãæ›ãˆ
  const glassPanel = modal.querySelector('.glass-panel');
  const originalContent = glassPanel.innerHTML;
    glassPanel.innerHTML = modalContent;
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    modal.classList.remove('hidden');
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®š
  const confirmBtn = modal.querySelector('#restore-confirm-btn');
  const cancelBtn = modal.querySelector('#restore-cancel-btn');
    
  const cleanup = function() {
      // å…ƒã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«æˆ»ã™
      glassPanel.innerHTML = originalContent;
      modal.classList.add('hidden');
    };
    
    if (confirmBtn) {
      confirmBtn.onclick = function() {
        cleanup();
        console.log('âœ… User confirmed restoration');
        this._restoreHistoryItem(item);
      };
    }
    
    if (cancelBtn) {
      cancelBtn.onclick = function() {
        cleanup();
        console.log('âŒ User cancelled restoration');
      };
    }
  },

  /**
   * Generate HTML content for enhanced restore modal
   */
  _generateRestoreModalHTML(item, details) {
  const truncatedQuestion = details.truncatedQuestion;
  const formattedDate = details.formattedDate;
  const hasSpreadsheetDifference = details.hasSpreadsheetDifference;
  const currentSpreadsheetId = details.currentSpreadsheetId;
  const targetSpreadsheetId = details.targetSpreadsheetId;
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’ãƒã‚¹ã‚¯è¡¨ç¤ºç”¨ã«å¤‰æ›
  const maskSpreadsheetId = function(id) {
      if (!id || id.length < 8) return id || 'æœªè¨­å®š';
      return '...' + id.slice(-6);
    };
    
  const spreadsheetDiffSection = hasSpreadsheetDifference ? `
      <div class="bg-yellow-500/10 border border-yellow-400/30 rounded-lg p-4 mb-4">
        <h4 class="text-sm font-semibold text-yellow-400 mb-2 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h4a1 1 0 011 1v2h4a1 1 0 011 1v1a1 1 0 01-1 1H3a1 1 0 01-1-1V5a1 1 0 011-1h4zM7 8v8a2 2 0 002 2h2a2 2 0 002-2V8M7 8H5a2 2 0 00-2 2v6a2 2 0 002 2h2M13 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2"></path>
          </svg>
          ğŸ“ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå¤‰æ›´
        </h4>
        <div class="text-xs text-yellow-100 space-y-1">
          <div><span class="text-yellow-200 font-medium">ç¾åœ¨:</span> ${maskSpreadsheetId(currentSpreadsheetId)}</div>
          <div><span class="text-yellow-200 font-medium">å¾©å…ƒå¾Œ:</span> ${maskSpreadsheetId(targetSpreadsheetId)}</div>
        </div>
      </div>
    ` : '';
    
    return `
      <h3 class="text-xl font-bold text-orange-400 mb-4 flex items-center gap-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        ğŸ“‹ å±¥æ­´å¾©å…ƒã®ç¢ºèª
      </h3>
      <p class="text-gray-300 mb-4">
        ä»¥ä¸‹ã®è¨­å®šã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®è¨­å®šãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
      </p>
      
      <!-- å¾©å…ƒäºˆå®šã®è¨­å®šæƒ…å ± -->
      <div class="bg-orange-500/10 border border-orange-400/30 rounded-lg p-4 mb-4">
        <h4 class="text-sm font-semibold text-orange-400 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          ğŸ“ å¾©å…ƒäºˆå®šã®è¨­å®š
        </h4>
        <div class="space-y-2 text-xs text-orange-100">
          <div><span class="text-orange-200 font-medium">å•é¡Œæ–‡:</span> ${truncatedQuestion}</div>
          <div><span class="text-orange-200 font-medium">ã‚·ãƒ¼ãƒˆå:</span> ${item.sheetName || 'æœªè¨­å®š'}</div>
          <div><span class="text-orange-200 font-medium">ä½œæˆæ—¥:</span> ${formattedDate}</div>
        </div>
      </div>
      
      ${spreadsheetDiffSection}
      
      <!-- è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div class="bg-red-500/10 border border-red-400/30 rounded-lg p-3 mb-6">
        <p class="text-xs text-red-200 flex items-center gap-2">
          <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          ã“ã®æ“ä½œã«ã‚ˆã‚Šç¾åœ¨ã®æœªä¿å­˜ã®è¨­å®šå†…å®¹ãŒå¤‰æ›´ã•ã‚Œã¾ã™ã€‚
        </p>
      </div>
      
      <div class="flex justify-end gap-3">
        <button type="button" id="restore-cancel-btn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" id="restore-confirm-btn" class="btn btn-primary">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          å¾©å…ƒã™ã‚‹
        </button>
      </div>
    `;
  },

  /**
   * Fallback restore modal for compatibility
   */
  _showFallbackRestoreModal(item) {
  const formattedDate = this._formatCreatedDate(item.createdDate);
  const truncatedQuestion = item.questionText && item.questionText.length > 50 
      ? item.questionText.substring(0, 50) + '...' 
      : (item.questionText || 'æœªè¨­å®š');
    
  const title = 'å±¥æ­´å¾©å…ƒã®ç¢ºèª';
  const message = `ä»¥ä¸‹ã®è¨­å®šã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®è¨­å®šãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚

ğŸ“ å•é¡Œæ–‡: ${truncatedQuestion}
ğŸ“Š ã‚·ãƒ¼ãƒˆå: ${item.sheetName || 'æœªè¨­å®š'}  
ğŸ“… ä½œæˆæ—¥: ${formattedDate}

âš ï¸ ã“ã®æ“ä½œã«ã‚ˆã‚Šç¾åœ¨ã®è¨­å®šå†…å®¹ãŒå¤‰æ›´ã•ã‚Œã¾ã™ã€‚`;

    // SharedModalsã‚·ã‚¹ãƒ†ãƒ ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
    if (window.sharedModals && typeof window.sharedModals.showConfirmation === 'function') {
      console.log('âœ… Using sharedModals.showConfirmation fallback');
      window.sharedModals.showConfirmation(
        title,
        message,
        function() {
          console.log('âœ… User confirmed restoration');
          this._restoreHistoryItem(item);
        },
        function() {
          console.log('âŒ User cancelled restoration');
        }
      );
    } else if (typeof showConfirmationModal === 'function') {
      console.log('âœ… Using showConfirmationModal fallback');
      showConfirmationModal(
        title,
        message,
        function() {
          console.log('âœ… User confirmed restoration');
          this._restoreHistoryItem(item);
        }
      );
    } else {
      console.warn('âš ï¸ No confirmation modal system available, using browser confirm');
      if (confirm(title + '\n\n' + message.replace(/ğŸ“|ğŸ“Š|ğŸ“…|âš ï¸/g, ''))) {
        console.log('âœ… User confirmed restoration via browser confirm');
        this._restoreHistoryItem(item);
      } else {
        console.log('âŒ User cancelled restoration via browser confirm');
      }
    }
  },
  
  /**
   * Restore configuration from history item
   */
  async _restoreHistoryItem(item) {
    try {
      // é‡è¤‡å®Ÿè¡Œé˜²æ­¢
      if (this._isRestoreInProgress) {
        console.log('âš ï¸ Restore already in progress, skipping duplicate request');
        return;
      }
      
      this._isRestoreInProgress = true;
      
      console.log('ğŸ”„ Restoring history:', item.questionText);
      console.log('ğŸ“Š History item details:', {
        id: item.id,
        questionText: item.questionText,
        sheetName: item.sheetName,
        spreadsheetId: item.spreadsheetId,
        opinionHeader: item.opinionHeader,
        nameHeader: item.nameHeader
      });
      
      // AIåˆ—åˆ¤å®šã«ã‚ˆã‚‹ä¸Šæ›¸ãã‚’é˜²æ­¢ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰
      window._historyRestoreInProgress = true;
      window._draftModeActive = true;
      console.log('ğŸ›¡ï¸ AIåˆ—åˆ¤å®šã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰');
      
      // 1. ãƒ†ã‚­ã‚¹ãƒˆè¨­å®šå¾©å…ƒï¼ˆå®Ÿåœ¨ã™ã‚‹è¦ç´ IDã«ä¿®æ­£ï¼‰
      // å¿…é ˆ: å›ç­”ãƒ‡ãƒ¼ã‚¿åˆ—ï¼ˆopinionHeader ã‚»ãƒ¬ã‚¯ãƒˆï¼‰
      (function restoreOpinionHeader() {
  const value = item.opinionHeader || item.opinionColumn || item.questionText || '';
  const opinionSelect = document.getElementById('opinionHeader');
        if (opinionSelect && value) {
          opinionSelect.value = value;
          console.log('âœ… Opinion header restored: ' + value);
        }
      })();
      
      // å‚è€ƒ: åå‰åˆ—ã¯ name-column ã‚»ãƒ¬ã‚¯ãƒˆã‚’ä½¿ç”¨ï¼ˆname-headerè¦ç´ ã¯å­˜åœ¨ã—ãªã„ï¼‰
      if (item.nameHeader) {
  const nameSelectEl = document.getElementById('name-column');
        if (nameSelectEl) nameSelectEl.value = item.nameHeader;
      }
      
      // 1.5. åˆ—é¸æŠã®å¾©å…ƒï¼ˆå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ï¼‰- å¼·åŒ–ç‰ˆ
      console.log('ğŸ”„ Restoring column selections from history');
      
      // å¾©å…ƒã™ã‚‹åˆ—é¸æŠãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã—ã€ä¿è­·ç”¨ã«ä¿å­˜
  const columnSelections = {
        opinionHeader: item.opinionHeader || item.opinionColumn || item.questionText || '',
        nameColumn: item.nameHeader || item.nameColumn || '',
        classColumn: item.classColumn || '',
        reasonHeader: item.reasonHeader || ''
      };
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ã—ã¦AIæ¨å®šã«ã‚ˆã‚‹ä¸Šæ›¸ãã‚’é˜²ã
      window._historyColumnSelections = columnSelections;
      
      // DOMè¦ç´ ã¸ã®å€¤è¨­å®šã‚’é–¢æ•°åŒ–ã—ã¦ç¢ºå®Ÿã«å®Ÿè¡Œ
  const setSelectValue = function(elementId, value, description) {
        if (!value) return;
  const element = document.getElementById(elementId);
        if (element) {
          element.value = value;
          // change ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã—ã¦ã€UIã®æ›´æ–°ã‚’ãƒˆãƒªã‚¬ãƒ¼
          element.dispatchEvent(new Event('change', { bubbles: true }));
          console.log('âœ… ' + description + ' restored: ' + value);
        } else {
          console.warn('âš ï¸ Element not found: ' + elementId);
        }
      };
      
      // å„åˆ—ã®å¾©å…ƒã‚’å®Ÿè¡Œï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ï¼‰
      setSelectValue('opinionHeader', columnSelections.opinionHeader, 'Opinion header');
      setSelectValue('name-column', columnSelections.nameColumn, 'Name column');
      setSelectValue('class-column', columnSelections.classColumn, 'Class column');
      setSelectValue('reasonHeader', columnSelections.reasonHeader, 'Reason header');
      
      // 2. åå‰è¡¨ç¤ºè¨­å®šå¾©å…ƒï¼ˆshowNamesãƒ™ãƒ¼ã‚¹ï¼‰
  const showNamesCheckbox = document.getElementById('show-names');
      if (showNamesCheckbox) {
        if (item.showNames !== undefined) {
          showNamesCheckbox.checked = item.showNames;
        } else if (item.displayMode !== undefined) {
          // æ—§ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
          showNamesCheckbox.checked = (item.displayMode === 'named');
        }
      }
      
      // 3. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°è¡¨ç¤ºå¾©å…ƒ
  const showCountsCheckbox = document.getElementById('show-counts');
      if (showCountsCheckbox) {
        showCountsCheckbox.checked = (item.showCounts === true);
      }
      
      // 4. å®Œå…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¾©å…ƒï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ + ã‚·ãƒ¼ãƒˆï¼‰
      console.log('ğŸ” Restore conditions check:', {
        hasSpreadsheetId: !!item.spreadsheetId,
        hasSheetName: !!item.sheetName,
        spreadsheetId: item.spreadsheetId,
        sheetName: item.sheetName
      });
      
      if (item.spreadsheetId && item.sheetName) {
        console.log('âœ… Full project restore path selected');
        await this._restoreFullProject(item.spreadsheetId, item.sheetName);
      } else if (item.sheetName) {
        console.log('âœ… Sheet-only restore path selected');
        // ã‚·ãƒ¼ãƒˆã®ã¿å¾©å…ƒ
        await this._restoreSheetSelection(item.sheetName);
      } else {
        console.warn('âš ï¸ No valid restoration path found - missing sheet or spreadsheet info');
        console.warn('ğŸ”§ Attempting fallback: trying to find sheet by question text');
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å•é¡Œæ–‡ã‹ã‚‰ã‚·ãƒ¼ãƒˆåã‚’æ¨æ¸¬
  const fallbackSheetName = await this._findSheetByQuestionText(item.questionText);
        if (fallbackSheetName) {
          console.log('âœ… Fallback found sheet: ' + fallbackSheetName);
          await this._restoreSheetSelection(fallbackSheetName);
        } else {
          console.error('âŒ Fallback failed: unable to determine correct sheet');
        }
      }
      
      // 5. UIå®Œå…¨æ›´æ–°
      await this._refreshAfterRestore();
      
      // å¾©å…ƒå®Œäº†å¾Œã«å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆUIåæ˜ å®Œäº†ã‚’å¾…ã¤ï¼‰
      await new Promise(function(resolve) { setTimeout(resolve, 500); });
      
      // Success message with specific details
      if (typeof showMessage === 'function') {
  const sheetInfo = item.sheetName ? 'ã‚·ãƒ¼ãƒˆã€Œ' + item.sheetName + 'ã€' : 'è¨­å®š';
        showMessage('âœ… å±¥æ­´ã‹ã‚‰' + sheetInfo + 'ã‚’å¾©å…ƒã—ã¾ã—ãŸ', 'success');
      }
      console.log('âœ… Complete restore finished successfully');
      
    } catch (error) {
      console.error('âŒ History restore failed:', error);
      
      // Enhanced error handling with rollback capability
  const errorMessage = 'âŒ è¨­å®šå¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ';
  const shouldAttemptRollback = false;
      
      if (error.message?.includes('Unable to parse range') || error.message?.includes('Invalid range')) {
        errorMessage = 'âŒ ã‚·ãƒ¼ãƒˆåã®å½¢å¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†è€…ã«ã”é€£çµ¡ãã ã•ã„ã€‚';
      } else if (error.message?.includes('spreadsheet') || error.message?.includes('spreadsheetId')) {
        errorMessage = 'âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        shouldAttemptRollback = true;
      } else if (error.message?.includes('sheet') || error.message?.includes('sheetName')) {
        errorMessage = 'âŒ æŒ‡å®šã•ã‚ŒãŸã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
      } else if (error.message?.includes('verification failed')) {
        errorMessage = 'âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
        shouldAttemptRollback = true;
      }
      
      // Attempt rollback if appropriate
      if (shouldAttemptRollback) {
        try {
          console.log('ğŸ”„ Attempting rollback...');
          // Reload current status to restore previous state
          if (typeof loadStatus === 'function') {
            await loadStatus(true);
            console.log('âœ… Rollback completed');
            errorMessage += ' å‰ã®çŠ¶æ…‹ã«å¾©å…ƒã—ã¾ã—ãŸã€‚';
          }
        } catch (rollbackError) {
          console.warn('âš ï¸ Rollback failed:', rollbackError);
          errorMessage += ' æ‰‹å‹•ã§ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
        }
      }
      
      if (typeof showMessage === 'function') {
        showMessage(errorMessage, 'error');
      }
      
      // Log technical details for debugging but don't show to user
      console.error('Technical details:', {
        itemId: item.id,
        sheetName: item.sheetName,
        spreadsheetId: item.spreadsheetId,
        errorMessage: error.message,
        errorStack: error.stack
      });
    } finally {
      // é…å»¶ã—ã¦ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆUIæ›´æ–°ãŒå®Œå…¨ã«å®Œäº†ã™ã‚‹ã®ã‚’å¾…ã¤ï¼‰
      setTimeout(function() {
        // AIåˆ—åˆ¤å®šã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
        if (window._historyRestoreInProgress) {
          window._historyRestoreInProgress = false;
          console.log('ğŸ›¡ï¸ AIåˆ—åˆ¤å®šã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }
        
        // å±¥æ­´åˆ—é¸æŠä¿è­·ãƒ•ãƒ©ã‚°ã‚‚ã‚¯ãƒªã‚¢
        if (window._historyColumnSelections) {
          window._historyColumnSelections = null;
          console.log('ğŸ›¡ï¸ å±¥æ­´åˆ—é¸æŠä¿è­·ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }
        
        // ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®è¨­å®šåæ˜ ã‚’å®Ÿè¡Œ
        if (window._draftModeActive) {
          window.HistoryManager._applyDraftUIUpdates();
        }
      }, 1000); // 1ç§’å¾Œã«ã‚¯ãƒªã‚¢
      
      // é‡è¤‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
      this._isRestoreInProgress = false;
    }
  },

  /**
   * Find sheet by question text as fallback mechanism
   */
  async _findSheetByQuestionText(questionText) {
    try {
      console.log('ğŸ” Searching for sheet with question: "' + questionText + '"');
      
      // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰è¨­å®šæƒ…å ±ã‚’å–å¾—
      if (window.AdminPanel?.currentStatus?.configJson) {
  const configJson = window.AdminPanel.currentStatus.configJson;
        
        // å„ã‚·ãƒ¼ãƒˆè¨­å®šã‚’ç¢ºèª
        for (const [key, sheetConfig] of Object.entries(configJson)) {
          if (key.startsWith('sheet_') && sheetConfig.opinionHeader) {
            if (sheetConfig.opinionHeader === questionText) {
  const sheetName = sheetConfig.sheetName || key.replace('sheet_', '');
              console.log('âœ… Found matching sheet: ' + sheetName);
              return sheetName;
            }
          }
        }
      }
      
      console.warn('âš ï¸ No matching sheet found for question text');
      return null;
      
    } catch (error) {
      console.error('âŒ Error in _findSheetByQuestionText:', error);
      return null;
    }
  },

  /**
   * Sanitize sheet name for safe API usage
   */
  _sanitizeSheetName(sheetName) {
    if (!sheetName) return '';
    
    // Remove potentially problematic characters but preserve most Unicode
    // Keep: letters, numbers, spaces, basic punctuation
  const sanitized = sheetName
      .replace(/[^\w\s\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF-]/g, '') // Keep alphanumeric, spaces, and Japanese characters
      .trim();
    
    return sanitized;
  },

  /**
   * Restore full project (spreadsheet + sheet) from history
   */
  async _restoreFullProject(spreadsheetId, sheetName) {
    try {
      // ã‚·ãƒ¼ãƒˆåã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚º
  const sanitizedSheetName = this._sanitizeSheetName(sheetName);
      console.log('ğŸ”„ Restoring full project: ' + spreadsheetId + '/' + sheetName + ' (sanitized: ' + sanitizedSheetName + ')');
      
      // ç¾åœ¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’å–å¾—
  const getCurrentSpreadsheetId = function() {
        if (window.AdminPanel?.currentStatus?.userInfo?.spreadsheetId) {
          return window.AdminPanel.currentStatus.userInfo.spreadsheetId;
        }
        return null;
      };
      
  const currentSpreadsheetId = getCurrentSpreadsheetId();
      
      // ç•°ãªã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å ´åˆã®ã¿åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
      if (spreadsheetId !== currentSpreadsheetId) {
        console.log('ğŸ”„ Switching spreadsheet: ' + currentSpreadsheetId + ' â†’ ' + spreadsheetId);
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆã®é€šçŸ¥
        if (typeof showMessage === 'function') {
          showMessage('ğŸ”„ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ã¾ã™...', 'info', 3000);
        }
        
        // å®Ÿéš›ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆã‚’å®Ÿè¡Œ
        await this._performSpreadsheetSwitch(spreadsheetId);
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆå¾Œã®å®‰å®šåŒ–å¾…æ©Ÿ
        console.log('â³ Waiting for spreadsheet switch to stabilize...');
        await new Promise(function(resolve) { setTimeout(resolve, 1500); });
        
        // UIæ›´æ–°å®Œäº†ã‚’å¾…æ©Ÿã—ã¦ã‹ã‚‰ã‚·ãƒ¼ãƒˆé¸æŠå¾©å…ƒ
        console.log('ğŸ”„ Waiting for sheet options to include: ' + sanitizedSheetName);
  const sheetFound = await this._waitForSheetOptionsUpdate(sanitizedSheetName);
        if (!sheetFound) {
          console.warn('âš ï¸ Sheet ' + sanitizedSheetName + ' not found in options after waiting, proceeding with fallback');
        }
        
        // **CRITICAL**: Force correct the activeSheetName in loaded status
        console.log('ğŸ”§ Force correcting activeSheetName after spreadsheet switch');
        if (window.currentStatus) {
          window.currentStatus.activeSheetName = sanitizedSheetName;
        }
        if (window.AdminPanel?.currentStatus) {
          window.AdminPanel.currentStatus.activeSheetName = sanitizedSheetName;
        }
      }
      
      // ã‚·ãƒ¼ãƒˆé¸æŠå¾©å…ƒã¨å…¬é–‹æƒ…å ±æ›´æ–°ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚ŒãŸåå‰ã‚’ä½¿ç”¨ï¼‰
      await this._restoreSheetSelection(sanitizedSheetName);
      
      // ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã¯å…¬é–‹ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’æ›´æ–°ã—ãªã„
      if (!window._draftModeActive) {
        console.log('ğŸ”„ å…¬é–‹ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å¼·åˆ¶æ›´æ–°');
        await this._updatePublishedSheetInfo(sanitizedSheetName);
      } else {
        console.log('ğŸ“ ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰: å…¬é–‹ã‚·ãƒ¼ãƒˆæƒ…å ±ã®æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—');
      }
      
      console.log(`âœ… Full project restore completed`);
      
    } catch (error) {
      console.warn('âš ï¸ Full project restore failed:', error);
      if (typeof showMessage === 'function') {
        showMessage('âš ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¾©å…ƒã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'warning');
      }
    }
  },

  /**
   * Restore sheet selection from history
   */
  async _restoreSheetSelection(sheetName) {
    try {
      // ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚ŒãŸã‚·ãƒ¼ãƒˆåã‚’ä½¿ç”¨
  const sanitizedSheetName = this._sanitizeSheetName(sheetName);
      console.log('ğŸ”„ Restoring sheet selection: "' + sheetName + '" (sanitized: "' + sanitizedSheetName + '")');
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹æ›´æ–°ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚ŒãŸåå‰ã‚’ä½¿ç”¨ï¼‰
      window.AdminPanel.selectedSheet = sanitizedSheetName;
      if (window.AdminPanel.stateManager) {
        window.AdminPanel.stateManager.setState('selectedSheet', sanitizedSheetName);  
      }
      
      // ã‚·ãƒ¼ãƒˆé¸æŠUIæ›´æ–°
  const sheetSelect = document.getElementById('sheet-select');
      if (sheetSelect) {
        // Find the option that matches either the original or sanitized name
  const options = Array.from(sheetSelect.options);
  const matchingOption = options.find(function(option) { 
          return option.value === sheetName || option.value === sanitizedSheetName;
        });
        
        if (matchingOption && sheetSelect.value !== matchingOption.value) {
          sheetSelect.value = matchingOption.value;
          sheetSelect.dispatchEvent(new Event('change'));
          
          // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è¡¨ç¤ºã®å¼·åˆ¶æ›´æ–°
          if (typeof updateSheetSelectActiveIndicator === 'function') {
            updateSheetSelectActiveIndicator(matchingOption.value);
          }
          
          console.log('âœ… Sheet selection UI updated to: ' + matchingOption.value);
        } else if (!matchingOption) {
          console.warn('âš ï¸ Sheet "' + sheetName + '" not found in options. Available: ' + options.map(function(o) { return o.value; }).join(', '));
        }
      }
      
      console.log('âœ… Sheet restored: ' + sanitizedSheetName);
    } catch (error) {
      console.warn('âš ï¸ Sheet restore warning:', error);
    }
  },

  /**
   * Refresh UI after history restore with enhanced error handling
   */
  async _refreshAfterRestore() {
  const refreshSteps = [
      { name: 'ãƒ‡ãƒ¼ã‚¿å†èª­è¾¼', fn: function() { return typeof loadData === 'function' ? loadData() : Promise.resolve(); } }
      // åˆ—åˆ¤å®šæ›´æ–°ã¯å±¥æ­´å¾©å…ƒæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¾©å…ƒã—ãŸè¨­å®šå€¤ã‚’ä¿æŒã™ã‚‹ãŸã‚ï¼‰
    ];
    
    // Execute each step with individual error handling
    for (const step of refreshSteps) {
      try {
        console.log('ğŸ”„ Executing refresh step: ' + step.name);
        await step.fn();
        console.log('âœ… ' + step.name + ' completed');
      } catch (error) {
        console.warn('âš ï¸ ' + step.name + ' failed, continuing with next step:', error);
        // Continue with other steps even if one fails
      }
    }
    
    // å±¥æ­´å¾©å…ƒæ™‚ã¯åˆ—é¸æŠã‚’æ°¸ç¶šåŒ–ï¼ˆæœ€å°ä¿å­˜ï¼‰ - with enhanced retry logic
    if (window._historyRestoreInProgress) {
      try {
        // ãƒ˜ãƒƒãƒ€ãƒ¼æç”»ãƒ»é¸æŠåæ˜ å®Œäº†ã‚’å°‘ã—å¾…ã£ã¦ã‹ã‚‰ä¿å­˜
        await new Promise(function(resolve) { setTimeout(resolve, 600); }); // Increased wait time
        
  const sheetName = (window.AdminPanel && window.AdminPanel.selectedSheet) || (document.getElementById('sheet-select')?.value) || '';
  const spreadsheetId = (window.currentStatus && window.currentStatus.userInfo && window.currentStatus.userInfo.spreadsheetId) || null;
        
        if (sheetName && spreadsheetId && typeof buildConfigObject === 'function' && typeof runGasWithUserId === 'function') {
  const config = buildConfigObject();
          console.log('ğŸ”„ Saving restored configuration for sheet: ' + sheetName);
          
          // Save sheet configuration with retry
          await this._saveConfigWithRetry(spreadsheetId, sheetName, config);
          
          // Activate sheet with retry
          await this._activateSheetWithRetry(spreadsheetId, sheetName);
          
        } else {
          console.warn('âš ï¸ è‡ªå‹•ä¿å­˜ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¿…è¦æƒ…å ±ä¸è¶³ï¼‰:', { 
            sheetName, 
            hasSpreadsheetId: !!spreadsheetId,
            hasBuildConfigObject: typeof buildConfigObject === 'function',
            hasRunGasWithUserId: typeof runGasWithUserId === 'function'
          });
        }
      } catch (autoSaveErr) {
        console.warn('âš ï¸ è‡ªå‹•ä¿å­˜å‡¦ç†ã§è­¦å‘Š:', autoSaveErr?.message || autoSaveErr);
        // Show user-friendly message but don't block the restore process
        if (typeof showMessage === 'function') {
          showMessage('âš ï¸ è¨­å®šä¿å­˜ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€å¾©å…ƒã¯å®Œäº†ã—ã¾ã—ãŸ', 'warning');
        }
      }
    }

    console.log('âœ… UI refresh completed');
  },

  /**
   * Save configuration with retry mechanism
   */
  async _saveConfigWithRetry(spreadsheetId, sheetName, config, maxRetries = 2) {
    for (let i = 0; i <= maxRetries; i++) {
      try {
        await runGasWithUserId('saveSheetConfig', 'è¨­å®šä¿å­˜ä¸­...', spreadsheetId, sheetName, config);
        console.log('âœ… Configuration saved successfully for sheet: ' + sheetName);
        return;
      } catch (error) {
        console.warn('âŒ Save config attempt ' + (i + 1) + ' failed:', error);
        if (i === maxRetries) {
          throw error; // Re-throw on final attempt
        }
        await new Promise(function(resolve) { setTimeout(resolve, 1000 * (i + 1)); }); // Progressive delay
      }
    }
  },

  /**
   * Activate sheet with retry mechanism
   */
  async _activateSheetWithRetry(spreadsheetId, sheetName, maxRetries = 2) {
    for (let i = 0; i <= maxRetries; i++) {
      try {
        await runGasWithUserId('switchToSheet', false, spreadsheetId, sheetName);
        console.log('âœ… Sheet activated successfully: ' + sheetName);
        return;
      } catch (error) {
        console.warn('âŒ Activate sheet attempt ' + (i + 1) + ' failed:', error);
        if (i === maxRetries) {
          console.warn('âš ï¸ Failed to activate sheet after all retries, but continuing');
          return; // Don't throw for sheet activation failure
        }
        await new Promise(function(resolve) { setTimeout(resolve, 1000 * (i + 1)); }); // Progressive delay
      }
    }
  },

  /**
   * Perform actual spreadsheet switching
   */
  async _performSpreadsheetSwitch(targetSpreadsheetId) {
    try {
      // 1. Update user's active spreadsheet in database
      if (typeof runGasWithUserId === 'function') {
  const updateResult = await runGasWithUserId('updateUserAPI', false, {
          spreadsheetId: targetSpreadsheetId
        });
        
        if (updateResult && updateResult.status === 'success') {
          console.log('âœ… Spreadsheet switched successfully in database');
        } else {
          throw new Error('Database update failed: ' + (updateResult?.message || 'Unknown error'));
        }
      } else {
        throw new Error('runGasWithUserId function not available');
      }

      // 2. Clear caches to force reload with new spreadsheet
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      if (window.gasOptimizer && typeof window.gasOptimizer.clearCache === 'function') {
        window.gasOptimizer.clearCache();
      }

      // 3. Reload application state with new spreadsheet
      if (typeof loadStatus === 'function') {
        await loadStatus(true); // Force reload bypassing cache
        // Application state reloaded - verbose logging disabled
        
        // 4. Force update currentSpreadsheetUrl after state reload
        if (window.currentStatus?.userInfo?.spreadsheetUrl) {
          currentSpreadsheetUrl = window.currentStatus.userInfo.spreadsheetUrl;
          console.log('âœ… currentSpreadsheetUrl force updated after switch:', currentSpreadsheetUrl);
        } else {
          console.warn('âš ï¸ No spreadsheetUrl available in reloaded currentStatus');
        }
        
        // 5. **CRITICAL**: Verify spreadsheet consistency after loadStatus
        await this._verifySpreadsheetConsistency(targetSpreadsheetId);
        
      } else {
        console.warn('âš ï¸ loadStatus function not available for state reload');
      }

    } catch (error) {
      console.error('âŒ Spreadsheet switching failed:', error);
      if (typeof showMessage === 'function') {
        showMessage('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      }
      throw error; // Re-throw to be handled by caller
    }
  },

  /**
   * Verify spreadsheet consistency after restoration - ENHANCED
   * Ensures both client and server state are properly synchronized
   */
  async _verifySpreadsheetConsistency(targetSpreadsheetId) {
    try {
      console.log('ğŸ” Verifying spreadsheet consistency (enhanced):', {
        target: targetSpreadsheetId,
        checkingCurrentStatus: !!window.currentStatus?.userInfo
      });
      
      // Use current status first (already loaded via unified API)
  const currentSpreadsheetId = window.currentStatus?.userInfo?.spreadsheetId;
      
      if (currentSpreadsheetId !== targetSpreadsheetId) {
        console.warn('âš ï¸ Spreadsheet ID mismatch detected:', {
          expected: targetSpreadsheetId,
          actual: currentSpreadsheetId
        });
        
        // çµ±åˆçš„ãªä¸æ•´åˆä¿®æ­£å‡¦ç†
        await this._correctSpreadsheetIdInconsistency(targetSpreadsheetId, currentSpreadsheetId);
      } else {
        console.log('âœ… Spreadsheet consistency verified');
      }
      
    } catch (error) {
      console.warn('âš ï¸ Spreadsheet consistency verification failed:', error);
    }
  },

  /**
   * Wait for sheet options to be updated with target sheet
   */
  async _waitForSheetOptionsUpdate(targetSheetName, maxWaitTime = 3000) {
  const startTime = Date.now();
  const checkInterval = 100; // Check every 100ms
    
    return new Promise(function(resolve, reject) {
  const checkSheetOptions = function() {
  const select = document.getElementById('sheet-select');
        if (!select) {
          console.warn('âš ï¸ Sheet select element not found during wait');
          resolve(false);
          return;
        }
        
        // Check if target sheet is in options
  const options = Array.from(select.options);
  const hasTargetSheet = options.some(function(option) { return option.value === targetSheetName; });
        
        if (hasTargetSheet) {
          console.log('âœ… Target sheet found in options: ' + targetSheetName);
          resolve(true);
          return;
        }
        
        // Check timeout
  const elapsed = Date.now() - startTime;
        if (elapsed >= maxWaitTime) {
          console.warn('âš ï¸ Timeout waiting for sheet options update (' + elapsed + 'ms). Available: ' + options.map(function(o) { return o.value; }).join(', '));
          resolve(false); // Don't reject, allow fallback
          return;
        }
        
        // Continue checking
        setTimeout(checkSheetOptions, checkInterval);
      };
      
      // Start checking
      checkSheetOptions();
    });
  },
  
  /**
   * Generate unique history ID
   */
  generateId() {
    return Date.now().toString() + Math.random().toString(36).substr(2, 9);
  },
  
  /**
   * HTML escape utility
   */
  /**
   * Update published sheet information after restore
   */
  async _updatePublishedSheetInfo(sheetName) {
    try {
      console.log('ğŸ”„ Updating published sheet info to: ' + sheetName);
      
      // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å…¬é–‹ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’æ›´æ–°
      if (typeof runGasWithUserId === 'function') {
  const response = await runGasWithUserId('activateSheetSimple', false, sheetName);
        if (response && response.status === 'success') {
          console.log('âœ… Published sheet info updated on server: ' + sheetName);
        }
      }
      
      // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®çŠ¶æ…‹ã‚‚æ›´æ–°
      if (window.AdminPanel?.currentStatus) {
        window.AdminPanel.currentStatus.publishedSheetName = sheetName;
        window.AdminPanel.currentStatus.activeSheetName = sheetName;
        
        // config ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        if (!window.AdminPanel.currentStatus.config) {
          window.AdminPanel.currentStatus.config = {};
        }
        window.AdminPanel.currentStatus.config.publishedSheetName = sheetName;
      }
      
      // UIè¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰ - statusã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é©åˆ‡ã«æ¸¡ã™
      if (typeof updateTopicText === 'function') {
        try {
          // ã‚ˆã‚Šé©åˆ‡ãªstatusã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
  const statusForUpdate = window.currentStatus || window.AdminPanel?.currentStatus;
          if (statusForUpdate) {
            updateTopicText(statusForUpdate);
          } else {
            console.warn('âš ï¸ No valid status object available for updateTopicText');
          }
        } catch (error) {
          console.warn('âš ï¸ updateTopicText failed during published sheet info update:', error);
        }
      }
      
    } catch (error) {
      console.warn('âš ï¸ Failed to update published sheet info:', error);
    }
  },

  /**
   * ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®UIæ›´æ–°ã‚’é©ç”¨
   */
  _applyDraftUIUpdates() {
    try {
      console.log('ğŸ“ ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®UIæ›´æ–°ã‚’é©ç”¨ä¸­...');
      
      // å±¥æ­´å¾©å…ƒã®ä¿è­·ãƒ•ãƒ©ã‚°ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã—ã¦UIæ›´æ–°ã‚’å®Ÿè¡Œ
  const originalRestoreFlag = window._historyRestoreInProgress;
  const originalColumnSelections = window._historyColumnSelections;
      
      window._historyRestoreInProgress = false;
      window._historyColumnSelections = null;
      
      // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’èª­ã¿å–ã£ã¦è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
  const currentConfig = this._getDraftConfiguration();
      
      // populateConfigã‚’å‘¼ã³å‡ºã—ã¦UIæ›´æ–°
      if (typeof window._fullPopulateConfig === 'function') {
        window._fullPopulateConfig(currentConfig);
      } else if (typeof window.populateConfig === 'function') {
        window.populateConfig(currentConfig);
      }
      
      // ãƒ‰ãƒ©ãƒ•ãƒˆçŠ¶æ…‹ã®è¦–è¦šçš„ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
      this._showDraftModeIndicator();
      
      // ãƒ‰ãƒ©ãƒ•ãƒˆçŠ¶æ…‹ã‚’UIãƒœã‚¿ãƒ³ã«åæ˜ 
      this._updateDraftModeUI();
      
      // ãƒ•ãƒ©ã‚°ã‚’å…ƒã«æˆ»ã™
      window._historyRestoreInProgress = originalRestoreFlag;
      window._historyColumnSelections = originalColumnSelections;
      
      console.log('âœ… ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®UIæ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ');
      
    } catch (error) {
      console.error('âŒ ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰UIæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    }
  },
  
  /**
   * ç¾åœ¨ã®ãƒ‰ãƒ©ãƒ•ãƒˆè¨­å®šã‚’å–å¾—
   */
  _getDraftConfiguration() {
  const config = {};
    
    // å„ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã‹ã‚‰ç¾åœ¨ã®å€¤ã‚’å–å¾—
  const opinionHeaderEl = document.getElementById('opinionHeader');
    if (opinionHeaderEl) config.opinionHeader = opinionHeaderEl.value;
    
  const nameColumnEl = document.getElementById('name-column');
    if (nameColumnEl) config.nameColumn = nameColumnEl.value;
    
  const classColumnEl = document.getElementById('class-column');
    if (classColumnEl) config.classColumn = classColumnEl.value;
    
  const reasonHeaderEl = document.getElementById('reasonHeader');
    if (reasonHeaderEl) config.reasonHeader = reasonHeaderEl.value;
    
  const showNamesEl = document.getElementById('show-names');
    if (showNamesEl) config.showNames = showNamesEl.checked;
    
  const showCountsEl = document.getElementById('show-counts');
    if (showCountsEl) config.showCounts = showCountsEl.checked;
    
    return config;
  },
  
  /**
   * çµ±åˆã•ã‚ŒãŸãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è¡¨ç¤º
   */
  _showDraftModeIndicator() {
  const indicatorSection = document.getElementById('draft-mode-indicator-section');
    if (indicatorSection) {
      indicatorSection.classList.remove('hidden');
      console.log('âœ… çµ±åˆãƒ‰ãƒ©ãƒ•ãƒˆã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
    }
    
    // ãƒ‰ãƒ©ãƒ•ãƒˆæ©Ÿèƒ½ãƒ˜ãƒ«ãƒ—ã‚‚è¡¨ç¤º
  const helpSection = document.getElementById('draft-help-section');
    if (helpSection) {
      helpSection.classList.remove('hidden');
      console.log('ğŸ’¡ ãƒ‰ãƒ©ãƒ•ãƒˆãƒ˜ãƒ«ãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
    }
  },
  
  /**
   * ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®éè¡¨ç¤º
   */
  _hideDraftModeIndicator() {
  const indicatorSection = document.getElementById('draft-mode-indicator-section');
    if (indicatorSection) {
      indicatorSection.classList.add('hidden');
      console.log('âœ… çµ±åˆãƒ‰ãƒ©ãƒ•ãƒˆã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
    }
    
    // ãƒ‰ãƒ©ãƒ•ãƒˆæ©Ÿèƒ½ãƒ˜ãƒ«ãƒ—ã‚‚éè¡¨ç¤º
  const helpSection = document.getElementById('draft-help-section');
    if (helpSection) {
      helpSection.classList.add('hidden');
      console.log('ğŸ’¡ ãƒ‰ãƒ©ãƒ•ãƒˆãƒ˜ãƒ«ãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
    }
    
    // ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰UIã‚’é€šå¸¸ã«æˆ»ã™
    this._updateDraftModeUI(false);
  },
  
  /**
   * ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ã«åˆã‚ã›ã¦UIã‚’æ›´æ–°
   */
  _updateDraftModeUI(isDraftMode = null) {
    if (isDraftMode === null) {
      isDraftMode = window._draftModeActive;
    }
    
  const saveButton = document.getElementById('save-publish-btn');
  const saveButtonText = document.getElementById('save-publish-text');
    
    if (saveButton && saveButtonText) {
      if (isDraftMode) {
        saveButtonText.textContent = 'ãƒ‰ãƒ©ãƒ•ãƒˆã‚’ä¿å­˜ã—ã¦å…¬é–‹';
        saveButton.className = saveButton.className.replace('btn-primary', 'btn-warning');
        console.log('ğŸ“ UIã‚’ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´');
      } else {
        saveButtonText.textContent = 'è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹';
        saveButton.className = saveButton.className.replace('btn-warning', 'btn-primary');
        console.log('âœ… UIã‚’é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´');
      }
    }
  },

  /**
   * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDä¸æ•´åˆã®çµ±åˆçš„ä¿®æ­£å‡¦ç†
   */
  async _correctSpreadsheetIdInconsistency(targetSpreadsheetId, currentSpreadsheetId) {
    try {
      console.log('ğŸ”§ çµ±åˆçš„ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDä¿®æ­£ã‚’é–‹å§‹');
      
      // 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã®ä¿®æ­£
      if (window.currentStatus?.userInfo) {
        console.log('ğŸ”§ Correcting currentStatus with target spreadsheet ID');
        window.currentStatus.userInfo.spreadsheetId = targetSpreadsheetId;
        
        // Also update spreadsheet URL if available
        if (window.currentStatus.userInfo.spreadsheetUrl) {
  const correctedUrl = window.currentStatus.userInfo.spreadsheetUrl.replace(
            /\/spreadsheets\/d\/[a-zA-Z0-9-_]+/,
            '/spreadsheets/d/' + targetSpreadsheetId
          );
          window.currentStatus.userInfo.spreadsheetUrl = correctedUrl;
          console.log('ğŸ”— Spreadsheet URL also corrected');
        }
      }
      
      // 2. AdminPanelçŠ¶æ…‹ã®ä¿®æ­£
      if (window.AdminPanel?.currentStatus?.userInfo) {
        console.log('ğŸ”§ Correcting AdminPanel.currentStatus');
        window.AdminPanel.currentStatus.userInfo.spreadsheetId = targetSpreadsheetId;
      }
      
      // 3. UIè¦ç´ ã®ä¿®æ­£
  const spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
      if (spreadsheetBtn) {
  const correctedUrl = 'https://docs.google.com/spreadsheets/d/' + targetSpreadsheetId + '/edit';
        spreadsheetBtn.href = correctedUrl;
        console.log('ğŸ”— Spreadsheet button URL updated');
      }
      
      // 4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
      if (typeof clearAllSpreadsheetCache === 'function') {
        await clearAllSpreadsheetCache();
        console.log('ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†');
      }
      
      console.log('âœ… çµ±åˆçš„ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDä¿®æ­£ãŒå®Œäº†');
      
    } catch (error) {
      console.error('âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDä¿®æ­£ã‚¨ãƒ©ãƒ¼:', error);
    }
  },

  _escapeHtml(text) {
  const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
};

// History manager integration
window.AdminPanel.historyManager = {
  loadSimpleHistoryTable: function() { return window.HistoryManager.renderTable(); },
  restoreFromSimpleHistory: function(item) { return window.HistoryManager._restoreHistoryItem(item); }
};

//# sourceURL=adminPanel-framework.js.html


// =============================================================================
// ADMIN PANEL CORE UTILITIES & DOM OPERATIONS
// =============================================================================

// =============================================================================
// LOGGING UTILITIES - Standardized logging with levels
// =============================================================================

// Simple logging utility with conditional output based on DEBUG mode  
// DEBUG_MODE is defined in constants.js.html

// adminLog and logging functions are defined in adminPanel-framework.js.html

// Logging functions are defined in adminPanel-framework.js.html

// =============================================================================
// ENHANCED MESSAGE SYSTEM FOR SETUP FLOW
// =============================================================================
// Message handling is now centralized in AdminPanel.ui.showMessage defined in
// adminPanel-framework.js.html. The previous inline implementation has been
// removed to avoid duplication.

// =============================================================================
// UNIFIED MANAGEMENT SYSTEM API - çµ±ä¸€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ API
// =============================================================================

/**
 * çµ±ä¸€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - å…¨ç®¡ç†ã‚¯ãƒ©ã‚¹ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 */
window.unifiedManagement = {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç† (CacheManager)
  cache: {
    get: (key, valueFn, options) => typeof cacheManager !== 'undefined' ? cacheManager.get(key, valueFn, options) : (valueFn ? valueFn() : null),
    remove: (key) => typeof cacheManager !== 'undefined' ? cacheManager.remove(key) : null,
    clearAll: () => typeof cacheManager !== 'undefined' ? cacheManager.clearAll() : null,
    clearFrontend: (options) => typeof cacheManager !== 'undefined' ? cacheManager.clearAllFrontendCaches(options) : Promise.resolve({ success: false }),
    clearSpecific: (type) => typeof cacheManager !== 'undefined' ? cacheManager.clearSpecificCache(type) : Promise.resolve({ success: false }),
    diagnose: () => typeof cacheManager !== 'undefined' ? cacheManager.diagnoseFrontendCache() : { available: false },
    getHealth: () => typeof cacheManager !== 'undefined' ? cacheManager.getHealth() : { status: 'unavailable' }
  },

  // ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡ (TimingManager)
  timing: {
    delay: (ms, id) => typeof TimingManager !== 'undefined' ? TimingManager.delay(ms, id) : new Promise(resolve => setTimeout(resolve, ms)),
    sequence: (operations, intervalMs, sequenceId) => typeof TimingManager !== 'undefined' ? TimingManager.sequence(operations, intervalMs, sequenceId) : Promise.resolve([]),
    parallel: (operations, concurrency) => typeof TimingManager !== 'undefined' ? TimingManager.parallel(operations, concurrency) : Promise.all(operations.map(op => op())),
    progressSequence: (steps, onProgress, stepDelay) => typeof TimingManager !== 'undefined' ? TimingManager.progressSequence(steps, onProgress, stepDelay) : Promise.resolve([]),
    debounce: (func, key, delay) => typeof TimingManager !== 'undefined' ? TimingManager.debounce(func, key, delay) : func,
    throttle: (func, key, delay) => typeof TimingManager !== 'undefined' ? TimingManager.throttle(func, key, delay) : func,
    clearTiming: (key) => typeof TimingManager !== 'undefined' ? TimingManager.clearTiming(key) : null,
    clearAllTiming: () => typeof TimingManager !== 'undefined' ? TimingManager.clearAllTiming() : null
  },

  // ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œåˆ¶å¾¡ (FlowExecutionManager)
  flow: {
    execute: (flowId, operation, options) => typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.executeWithLock(flowId, operation, options) : operation(),
    executeWithLoading: (flowId, operation, options) => typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.executeWithLoadingSync(flowId, operation, options) : operation(),
    cancel: (flowId) => typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.cancelFlow(flowId) : null,
    cancelAll: () => typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.cancelAllFlows() : null,
    diagnose: () => typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.diagnoseExecution() : { activeFlows: [], pendingOperations: 0 }
  },

  // UIç®¡ç† (UnifiedLoadingManager)
  ui: {
    showLoading: (message, options) => window.unifiedLoading && window.unifiedLoading.showSimple(message, options),
    showProgress: (message, step, percentage) => window.unifiedLoading && window.unifiedLoading.showAdminProgress(message, step, percentage),
    hideLoading: () => window.unifiedLoading && window.unifiedLoading.hide(),
    setLoading: (isLoading, message, step, percentage) => window.setLoading(isLoading, message, step, percentage)
  },

  // ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­
  diagnose: () => ({
    cache: typeof cacheManager !== 'undefined' ? cacheManager.diagnoseFrontendCache() : { available: false },
    flow: typeof flowExecutionManager !== 'undefined' ? flowExecutionManager.diagnoseExecution() : { activeFlows: [], pendingOperations: 0 },
    timing: {
      activeTimers: typeof timingManager !== 'undefined' ? timingManager.activeTimers.size : 0,
      debounceTimers: typeof timingManager !== 'undefined' ? ((timingManager.debounceTimers && timingManager.debounceTimers.size) || 0) : 0,
      throttleTimers: typeof timingManager !== 'undefined' ? ((timingManager.throttleTimers && timingManager.throttleTimers.size) || 0) : 0
    },
    timestamp: Date.now()
  })
};

// ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›æ€§ã®ãŸã‚ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
  const debounce = function(func, delay, key) {
  if (typeof TimingManager !== 'undefined') {
    return TimingManager.debounce(func, key || 'default', delay);
  } else if (window.sharedUtilities && window.sharedUtilities.debounce) {
    window.sharedUtilities.debounce.debounce(func, key || 'default', delay);
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
    let timeouts = window._debounceTimeouts || (window._debounceTimeouts = {});
    return function(...args) {
      const timeoutKey = key || 'default';
      clearTimeout(timeouts[timeoutKey]);
      timeouts[timeoutKey] = setTimeout(() => func.apply(this, args), delay);
    };
  }
};

// Enhanced debounce system for admin panel operations
window.AdminPanel.debounce = {
  timers: new Map(),
  
  // Specialized debounce for loadStatus operations
  loadStatus: function(func, delay = 250) {
    const key = 'loadStatus';
    if (this.timers.has(key)) {
      clearTimeout(this.timers.get(key));
    }
    
    const timer = setTimeout(() => {
      this.timers.delete(key);
      logDebug('ğŸ¯ Executing debounced loadStatus');
      func();
    }, delay);
    
    this.timers.set(key, timer);
    logDebug(`â³ Debouncing loadStatus for ${delay}ms`);
  },
  
  // General purpose debounce for UI operations
  uiOperation: function(func, key, delay = 100) {
    const fullKey = `ui-${key}`;
    if (this.timers.has(fullKey)) {
      clearTimeout(this.timers.get(fullKey));
    }
    
    const timer = setTimeout(() => {
      this.timers.delete(fullKey);
      func();
    }, delay);
    
    this.timers.set(fullKey, timer);
  },
  
  // Clear specific debounce timer
  clear: function(key) {
    if (this.timers.has(key)) {
      clearTimeout(this.timers.get(key));
      this.timers.delete(key);
    }
  },
  
  // Clear all debounce timers
  clearAll: function() {
    this.timers.forEach(timer => clearTimeout(timer));
    this.timers.clear();
    logDebug('ğŸ§¹ All debounce timers cleared');
  }
};

// =============================================================================
// DOM UTILITY FUNCTIONS - Use SharedUtilities
// =============================================================================

// Backward compatibility functions using SharedUtilities
const dom = window.sharedUtilities.dom;
const createSafeElement = dom.createSafeElement.bind(dom);
const getCachedElement = dom.getCachedElement.bind(dom);
const safeGetElement = getCachedElement;
const setButtonState = dom.setButtonState.bind(dom);
const setSafeTextContent = dom.setSafeTextContent.bind(dom);
const toggleClass = dom.toggleClass.bind(dom);
const addSafeEventListener = dom.addSafeEventListener.bind(dom);
const removeSafeEventListener = dom.removeSafeEventListener.bind(dom);
const clearElementCache = dom.clearElementCache.bind(dom);
const cacheElements = dom.cacheElements.bind(dom);

// =============================================================================
// EVENT HANDLER UTILITIES - Consolidated patterns
// =============================================================================

// Utility for setting up multiple event listeners efficiently
function setupMultipleListeners(elementHandlerMap) {
  Object.keys(elementHandlerMap).forEach((elementId) => {
    const element = elementId.startsWith('#') ? 
      document.querySelector(elementId) : 
      (elements[elementId] || getCachedElement(elementId));
    
    if (element) {
      const handlers = elementHandlerMap[elementId];
      if (Array.isArray(handlers)) {
        handlers.forEach((handler) => {
          addSafeEventListener(element, handler.event, handler.callback, handler.options);
        });
      } else {
        addSafeEventListener(element, handlers.event, handlers.callback, handlers.options);
      }
    }
  });
}

// Utility for setting up click handlers with confirmation
function setupConfirmationHandler(elementId, confirmTitle, confirmMessage, callback) {
  const element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', (e) => {
      e.preventDefault();
      showConfirmationModal(
        confirmTitle,
        confirmMessage,
        callback
      );
    });
  }
}

// Utility for setting up handlers with privacy consent
function setupPrivacyHandler(elementId, callback) {
  const element = elements[elementId] || getCachedElement(elementId);
  if (element) {
    addSafeEventListener(element, 'click', (e) => {
      e.preventDefault();
      showPrivacyModal(() => {
        hidePrivacyModal();
        callback();
      });
    });
  }
}

// Utility for delegated event handling (useful for dynamic content)
function setupDelegatedHandler(parentElement, selector, event, callback) {
  if (typeof parentElement === 'string') {
    parentElement = getCachedElement(parentElement);
  }
  
  if (parentElement) {
    addSafeEventListener(parentElement, event, (e) => {
      const target = e.target.closest(selector);
      if (target) {
        callback.call(target, e);
      }
    });
  }
}

// =============================================================================
// STATE MANAGEMENT
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯ adminPanel-framework.js.html ã§ç®¡ç†

// Operation mutex system to prevent concurrent operations
window.AdminPanel.operationMutex = {
  activeOperations: new Set(),
  
  // Check if operation is already running
  isRunning: function(operationId) {
    return this.activeOperations.has(operationId);
  },
  
  // Start tracking an operation
  start: function(operationId) {
    if (this.activeOperations.has(operationId)) {
      logWarn(`âš ï¸ Operation ${operationId} already running`);
      return false;
    }
    this.activeOperations.add(operationId);
    logDebug(`ğŸ”’ Starting operation: ${operationId}`);
    return true;
  },
  
  // End tracking an operation
  end: function(operationId) {
    this.activeOperations.delete(operationId);
    logDebug(`ğŸ”“ Completed operation: ${operationId}`);
  },
  
  // Get all active operations
  getActive: function() {
    return Array.from(this.activeOperations);
  }
};

// User initialization is now handled in adminPanel-framework.js.html
let currentActiveSheet = '';
let webAppUrl = '';
let currentSpreadsheetUrl = '';

// Global variables from adminPanel.js.html
let currentStep = 1;
let selectedSheetId = null;
let selectedFormId = null;
let availableSheets = [];
let availableForms = [];
let currentConfig = null;

// Admin panel initialization is now handled in adminPanel-framework.js.html

// =============================================================================
// LEGACY UTILITIES (for backward compatibility)
// =============================================================================

// Safe text content setter
function safeSetText(elementId, text) {
  logDebug('safeSetText called:', { elementId, text, textType: typeof text });
  
  const element = typeof elementId === 'string' ? getCachedElement(elementId) : elementId;
  logDebug('safeSetText element found:', !!element);
  
  if (element) {
    setSafeTextContent(element, text || '');
    logDebug(`safeSetText completed for: ${elementId} with text: ${text || ''}`);
  } else {
    logWarn('safeSetText: Element not found:', elementId);
  }
}

// =============================================================================
// LAYOUT AND VIEWPORT UTILITIES
// =============================================================================

// Layout adjustment is defined in adminPanel-framework.js.html

// AdminPanel no longer overrides global setLoading
// Uses unified loading system with admin-specific configurations


// =============================================================================
// INITIALIZATION
// =============================================================================

// Initialize layout on load
// Core initialization is now handled in adminPanel-framework.js.html

// Section expansion is now handled in adminPanel-framework.js.html

// System status and user interaction management is now handled in adminPanel-framework.js.html

// Master initialization system is now handled in adminPanel-framework.js.html

//# sourceURL=adminPanel-core.js.html


// =============================================================================
// ADMIN PANEL API COMMUNICATIONS & BACKEND CALLS
// =============================================================================

// =============================================================================
// CACHE MANAGER STUB - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
// =============================================================================

/**
 * ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚¹ã‚¿ãƒ–
 * ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®cacheManagerãŒå‚ç…§ã•ã‚Œã‚‹å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
 */
window.cacheManager = window.cacheManager || {
  /**
   * ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
   * @returns {Promise} ã‚¯ãƒªã‚¢çµæœ
   */
  clearAllFrontendCaches() {
    return new Promise((resolve) => {
      try {
        // localStorage ã®ã‚¯ãƒªã‚¢ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        const keysToPreserve = ['userId', 'adminEmail', 'debugMode'];
        const preservedData = {};
        
        keysToPreserve.forEach(key => {
          if (localStorage.getItem(key)) {
            preservedData[key] = localStorage.getItem(key);
          }
        });
        
        // ä¸€æ™‚çš„ã«ã‚¯ãƒªã‚¢
        localStorage.clear();
        
        // ä¿å­˜ã™ã¹ããƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
        Object.keys(preservedData).forEach(key => {
          localStorage.setItem(key, preservedData[key]);
        });
        
        // sessionStorageã‚‚ã‚¯ãƒªã‚¢
        sessionStorage.clear();
        
        console.log('âœ… Frontend caches cleared successfully');
        resolve({ success: true, message: 'Frontend caches cleared' });
      } catch (error) {
        console.warn('âš ï¸ Cache clear failed:', error);
        resolve({ success: false, error: error.message });
      }
    });
  },
  
  /**
   * ç‰¹å®šã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–
   * @param {Array} patterns - ç„¡åŠ¹åŒ–ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
   */
  invalidate(patterns) {
    console.log('Cache invalidation requested for patterns:', patterns);
    // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã¯å®Ÿè£…ä¸è¦ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§å‡¦ç†ï¼‰
    return Promise.resolve();
  },
  
  /**
   * ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
   * @param {string} spreadsheetId - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
   */
  invalidateSheetData(spreadsheetId) {
    console.log('Sheet data cache invalidation requested for:', spreadsheetId);
    // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã¯å®Ÿè£…ä¸è¦ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§å‡¦ç†ï¼‰
    return Promise.resolve();
  }
};

// =============================================================================
// UNIFIED FLOW EXECUTION MANAGER - çµ±ä¸€å®Ÿè¡Œåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ 
// =============================================================================

/**
 * ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œåˆ¶å¾¡ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ - é‡è¤‡å®Ÿè¡Œãƒ»ç«¶åˆçŠ¶æ…‹ã‚’é˜²æ­¢
 */
class FlowExecutionManager {
  constructor() {
    this.activeFlows = new Set();
    this.pendingOperations = new Map();
    this.executionQueue = new Map();
    this.debugMode = window.DEBUG_MODE || false;
  }

  /**
   * æ’ä»–å®Ÿè¡Œåˆ¶å¾¡ä»˜ãã§ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ
   * @param {string} flowId - ãƒ•ãƒ­ãƒ¼è­˜åˆ¥å­
   * @param {Function} operation - å®Ÿè¡Œã™ã‚‹æ“ä½œ
   * @param {Object} options - å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³
   * @returns {Promise} å®Ÿè¡Œçµæœ
   */
  executeWithLock(flowId, operation, options = {}) {
    const timeout = options.timeout || SYSTEM_CONSTANTS.TIMEOUTS.DEFAULT_FLOW_TIMEOUT;
    const allowQueue = options.allowQueue || false;

    // æ—¢ã«å®Ÿè¡Œä¸­ã®å ´åˆã®å‡¦ç†
    if (this.activeFlows.has(flowId)) {
      if (this.pendingOperations.has(flowId)) {
        if (this.debugMode) {
          logDebug(`ğŸ”’ Flow ${flowId} already in progress, returning existing promise`);
        }
        return this.pendingOperations.get(flowId);
      }
      
      if (!allowQueue) {
        throw new Error(`Flow ${flowId} is already in progress and queueing is disabled`);
      }
      
      // ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
      if (this.debugMode) {
        logDebug(`â³ Flow ${flowId} queued for execution`);
      }
      return this.queueOperation(flowId, operation, timeout);
    }

    // æ–°è¦å®Ÿè¡Œ
    return this.executeOperation(flowId, operation, timeout);
  }

  /**
   * æ“ä½œã‚’å®Ÿè¡Œï¼ˆæ”¹è‰¯ç‰ˆ - AbortControllerå¯¾å¿œï¼‰
   */
  executeOperation(flowId, operation, timeout) {
  const self = this;
    self.activeFlows.add(flowId);
    
    if (self.debugMode) {
      console.log('ğŸš€ Starting flow execution: ' + flowId);
    }

    // AbortControllerã‚’ä½¿ç”¨ã—ãŸé©åˆ‡ãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡
  const abortController = new AbortController();
  const timeoutId = null;
    
    try {
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
      timeoutId = setTimeout(function() {
        console.warn('â° Flow ' + flowId + ' timeout after ' + timeout + 'ms - aborting operation');
        abortController.abort();
      }, timeout);

      // æ“ä½œå®Ÿè¡Œï¼ˆAbortSignalã‚’æ¸¡ã™ï¼‰
  const operationPromise = Promise.resolve(operation(abortController.signal));
      self.pendingOperations.set(flowId, operationPromise);

      return operationPromise.then(function(result) {
        // æ­£å¸¸å®Œäº†æ™‚ã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
        if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }
        
        return result;
      }).catch(function(error) {
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
        if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }

        // AbortErrorã®å ´åˆã¯ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (error.name === 'AbortError' || abortController.signal.aborted) {
  const timeoutError = new Error('Flow ' + flowId + ' was aborted due to timeout (' + timeout + 'ms)');
          timeoutError.name = 'TimeoutError';
          timeoutError.flowId = flowId;
          timeoutError.timeout = timeout;
          console.error('âŒ Flow ' + flowId + ' aborted due to timeout');
          throw timeoutError;
        }

        console.error('âŒ Flow ' + flowId + ' failed:', error);
        throw error;
      }).then(function(result) {
        // ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if (timeoutId) {
          clearTimeout(timeoutId);
        }
        
        self.activeFlows.delete(flowId);
        self.pendingOperations.delete(flowId);
        
        // ã‚­ãƒ¥ãƒ¼ã•ã‚ŒãŸæ“ä½œã‚’å®Ÿè¡Œ
        self.processQueue(flowId);
        
        return result;
      });
    } catch (error) {
      // ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
      
      self.activeFlows.delete(flowId);
      self.pendingOperations.delete(flowId);
      
      // ã‚­ãƒ¥ãƒ¼ã•ã‚ŒãŸæ“ä½œã‚’å®Ÿè¡Œ
      self.processQueue(flowId);
      
      throw error;
    }
};

  /**
   * æ“ä½œã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
   */
  queueOperation(flowId, operation, timeout) {
  const self = this;
    return new Promise(function(resolve, reject) {
      if (!self.executionQueue.has(flowId)) {
        self.executionQueue.set(flowId, []);
      }
      
      self.executionQueue.get(flowId).push({
        operation: operation,
        timeout: timeout,
        resolve: resolve,
        reject: reject
      });
    });
};

  /**
   * ã‚­ãƒ¥ãƒ¼ã•ã‚ŒãŸæ“ä½œã‚’å‡¦ç†
   */
  processQueue(flowId) {
    const self = this;
    const queue = self.executionQueue.get(flowId);
    if (!queue || queue.length === 0) return;

    const next = queue.shift();
    if (queue.length === 0) {
      self.executionQueue.delete(flowId);
    }

    try {
  const resultPromise = self.executeOperation(flowId, next.operation, next.timeout);
      resultPromise.then(function(result) {
        next.resolve(result);
      }).catch(function(error) {
        next.reject(error);
      });
    } catch (error) {
      next.reject(error);
    }
};

  /**
   * æŒ‡å®šãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡ŒçŠ¶æ…‹ã‚’ç¢ºèª
   */
  isFlowActive(flowId) {
    return this.activeFlows.has(flowId);
  }

  /**
   * å…¨ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ­ãƒ¼ã‚’å–å¾—
   */
  getActiveFlows() {
    return Array.from(this.activeFlows);
  }

  /**
   * ç·Šæ€¥åœæ­¢: å…¨ãƒ•ãƒ­ãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
   */
  cancelAllFlows() {
    console.warn('ğŸš¨ Emergency stop: Cancelling all active flows');
    this.activeFlows.clear();
    this.pendingOperations.clear();
    this.executionQueue.clear();
};

/**
 * å®Ÿè¡ŒçŠ¶æ…‹ã®è¨ºæ–­
 * @returns {Object} è¨ºæ–­çµæœ
 */
  diagnoseExecution() {
    const self = this;
    return {
      activeFlows: Array.from(self.activeFlows),
      pendingOperations: self.pendingOperations.size,
      queuedOperations: Array.from(self.executionQueue.keys()).map(function(flowId) {
        return {
          flowId: flowId,
          queueLength: self.executionQueue.get(flowId).length
        };
      }),
      totalActiveFlows: self.activeFlows.size,
      timestamp: Date.now()
    };
};

  /**
   * LoadingManagerã¨ã®é€£æº - çµ±ä¸€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¶å¾¡
   * @param {string} flowId - ãƒ•ãƒ­ãƒ¼ID
   * @param {string} message - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   * @param {boolean} isActive - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
   */
  updateLoadingState(flowId, message, isActive) {
    try {
      // UnifiedLoadingManagerãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
      if (typeof window !== 'undefined' && window.unifiedLoading) {
        if (isActive) {
          window.unifiedLoading.showSimple(message || 'å®Ÿè¡Œä¸­: ' + flowId);
        } else {
          window.unifiedLoading.hide();
        }
      }
      
      // SharedUtilitiesã®LoadingManagerãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
      if (typeof window !== 'undefined' && window.sharedUtilities && window.sharedUtilities.loading) {
        window.sharedUtilities.loading.setLoading(flowId, isActive, message);
      }

    } catch (error) {
      console.warn('âš ï¸ Failed to update loading state:', error);
    }
};

  /**
   * å¼·åŒ–ã•ã‚ŒãŸexecuteWithLock - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é€£æºç‰ˆ
   * @param {string} flowId - ãƒ•ãƒ­ãƒ¼ID
   * @param {Function} operation - å®Ÿè¡Œã™ã‚‹æ“ä½œ
   * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
   * @returns {Promise} å®Ÿè¡Œçµæœ
   */
  executeWithLoadingSync(flowId, operation, options) {
    const self = this;
    options = options || {};
    const timeout = options.timeout || 30000;
    const loadingMessage = options.loadingMessage || null;
    const showLoading = options.showLoading !== undefined ? options.showLoading : true;
    const onProgress = options.onProgress || null;
    const priority = options.priority || 0;
    const retries = options.retries || 0;

    try {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹
      if (showLoading) {
        self.updateLoadingState(flowId, loadingMessage || 'å‡¦ç†ä¸­: ' + flowId, true);
      }

      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ä»˜ãã§å®Ÿè¡Œ
  const executionPromise = self.executeWithLock(flowId, function() {
        return new Promise(function(resolve, reject) {
          try {
            if (onProgress) {
              onProgress(0, 'starting', 'å®Ÿè¡Œé–‹å§‹');
            }
            
  const operationPromise = Promise.resolve(operation());
            operationPromise.then(function(operationResult) {
              if (onProgress) {
                onProgress(100, 'completed', 'å®Ÿè¡Œå®Œäº†');
              }
              
              resolve(operationResult);
            }).catch(reject);
          } catch (error) {
            reject(error);
          }
        });
      }, { timeout: timeout, priority: priority, retries: retries });

      return executionPromise.catch(function(error) {
        if (onProgress) {
          onProgress(-1, 'error', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
        throw error;
      }).then(function(result) {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†
        if (showLoading) {
          setTimeout(function() {
            self.updateLoadingState(flowId, null, false);
          }, 500); // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éš ã™
        }
        return result;
      }).catch(function(error) {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ï¼‰
        if (showLoading) {
          setTimeout(function() {
            self.updateLoadingState(flowId, null, false);
          }, 500);
        }
        throw error;
      });

    } catch (error) {
      if (onProgress) {
        onProgress(-1, 'error', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†ï¼ˆåŒæœŸã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ï¼‰
      if (showLoading) {
        setTimeout(function() {
          self.updateLoadingState(flowId, null, false);
        }, 500);
      }
      throw error;
    }
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
const flowExecutionManager = new FlowExecutionManager();

// =============================================================================
// TIMING MANAGER - éåŒæœŸå‡¦ç†çµ±ä¸€åŒ–ã‚·ã‚¹ãƒ†ãƒ 
// =============================================================================

/**
 * ã‚¿ã‚¤ãƒŸãƒ³ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - setTimeout/setIntervalã®ä»£æ›¿
 */
function TimingManager() {
  this.activeTimers = new Map();
  this.debugMode = window.DEBUG_MODE || false;
}

/**
 * é…å»¶å®Ÿè¡Œï¼ˆsetTimeoutã®ä»£æ›¿ï¼‰
 * @param {number} ms - é…å»¶ãƒŸãƒªç§’
 * @param {string} id - ã‚¿ã‚¤ãƒãƒ¼IDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @returns {Promise} å®Œäº†Promise
 */
TimingManager.delay = function(ms, id) {
    id = id || null;
    if (id && timingManager.activeTimers.has(id)) {
      timingManager.activeTimers.get(id).cancel();
    }

    return new Promise(function(resolve, reject) {
  const timer = setTimeout(function() {
        if (id) timingManager.activeTimers.delete(id);
        resolve();
      }, ms);

      if (id) {
        timingManager.activeTimers.set(id, {
          timer: timer,
          cancel: function() {
            clearTimeout(timer);
            timingManager.activeTimers.delete(id);
            reject(new Error('Timer ' + id + ' was cancelled'));
          }
        });
      }
    });
};

/**
 * é †æ¬¡å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ ï¼ˆè¤‡æ•°ã®setTimeoutã®ä»£æ›¿ï¼‰
 * @param {Array} operations - å®Ÿè¡Œã™ã‚‹æ“ä½œã®é…åˆ—
 * @param {number} intervalMs - å„æ“ä½œé–“ã®é–“éš”
 * @param {string} sequenceId - ã‚·ãƒ¼ã‚±ãƒ³ã‚¹IDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @returns {Promise} å®Œäº†Promise
 */
TimingManager.sequence = function(operations, intervalMs, sequenceId) {
    intervalMs = intervalMs || 100;
    sequenceId = sequenceId || null;
  const results = [];
    
    function processNextOperation(index) {
      if (index >= operations.length) {
        return Promise.resolve(results);
      }
      
  const operation = operations[index];
      
      try {
        let operationPromise;
        if (typeof operation === 'function') {
          operationPromise = Promise.resolve(operation());
        } else {
          operationPromise = Promise.resolve(operation);
        }
        
        return operationPromise.then(function(result) {
          results.push(result);
          
          // æœ€å¾Œã®æ“ä½œã§ãªã„å ´åˆã¯é–“éš”ã‚’è¨­ã‘ã‚‹
          if (index < operations.length - 1) {
  const delayId = sequenceId ? sequenceId + '_delay_' + index : null;
            return TimingManager.delay(intervalMs, delayId).then(function() {
              return processNextOperation(index + 1);
            });
          } else {
            return processNextOperation(index + 1);
          }
        }).catch(function(error) {
          console.error('Sequence operation ' + index + ' failed:', error);
          throw error;
        });
      } catch (error) {
        console.error('Sequence operation ' + index + ' failed:', error);
        return Promise.reject(error);
      }
    }
    
    return processNextOperation(0);
};

/**
 * ä¸¦åˆ—å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ ï¼ˆåˆ¶å¾¡ã•ã‚ŒãŸä¸¦åˆ—æ€§ï¼‰
 * @param {Array} operations - å®Ÿè¡Œã™ã‚‹æ“ä½œã®é…åˆ—
 * @param {number} concurrency - åŒæ™‚å®Ÿè¡Œæ•°
 * @returns {Promise} å®Œäº†Promise
 */
TimingManager.parallel = function(operations, concurrency) {
    concurrency = concurrency || 3;
  const results = [];
  const executing = [];
    
    function processOperations(index) {
      if (index >= operations.length) {
        return Promise.all(results);
      }
      
  const operation = operations[index];
  const promise = Promise.resolve(operation()).then(function(result) {
  const executeIndex = executing.indexOf(promise);
        if (executeIndex !== -1) {
          executing.splice(executeIndex, 1);
        }
        return result;
      });
      
      results.push(promise);
      executing.push(promise);
      
      if (executing.length >= concurrency) {
        return Promise.race(executing).then(function() {
          return processOperations(index + 1);
        });
      } else {
        return processOperations(index + 1);
      }
    }
    
    return processOperations(0);
};

/**
 * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ç”¨ï¼‰
 * @param {Array} steps - ã‚¹ãƒ†ãƒƒãƒ—ã®é…åˆ—
 * @param {Function} onProgress - ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
 * @param {number} stepDelay - ã‚¹ãƒ†ãƒƒãƒ—é–“é…å»¶
 * @returns {Promise} å®Œäº†Promise
 */
TimingManager.progressSequence = function(steps, onProgress, stepDelay) {
    stepDelay = stepDelay || 1000;
  const results = [];
    
    function processStep(index) {
      if (index >= steps.length) {
        return Promise.resolve(results);
      }
      
  const step = steps[index];
      
      try {
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹é–‹å§‹é€šçŸ¥
        if (onProgress) {
          onProgress(index, 'active', step.text || 'Step ' + (index + 1), step.detail || 'å®Ÿè¡Œä¸­...');
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ
        let operationPromise;
        if (typeof step.operation === 'function') {
          operationPromise = Promise.resolve(step.operation());
        } else {
          operationPromise = Promise.resolve(undefined);
        }
        
        return operationPromise.then(function(result) {
          // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹å®Œäº†é€šçŸ¥
          if (onProgress) {
            onProgress(index, 'completed', step.text || 'Step ' + (index + 1), step.completedText || 'âœ… å®Œäº†');
          }
          
          results.push(result);
          
          // æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§ãªã„å ´åˆã¯é…å»¶
          if (index < steps.length - 1) {
            return TimingManager.delay(stepDelay).then(function() {
              return processStep(index + 1);
            });
          } else {
            return processStep(index + 1);
          }
        }).catch(function(error) {
          // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¨ãƒ©ãƒ¼é€šçŸ¥
          if (onProgress) {
            onProgress(index, 'error', step.text || 'Step ' + (index + 1), 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
          }
          throw error;
        });
        
      } catch (error) {
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¨ãƒ©ãƒ¼é€šçŸ¥
        if (onProgress) {
          onProgress(index, 'error', step.text || 'Step ' + (index + 1), 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
        return Promise.reject(error);
      }
    }
    
    return processStep(0);
};

/**
 * ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
 * @param {string} id - ã‚¿ã‚¤ãƒãƒ¼ID
 */
TimingManager.cancelTimer = function(id) {
    if (timingManager.activeTimers.has(id)) {
      timingManager.activeTimers.get(id).cancel();
    }
};

/**
 * å…¨ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
 */
TimingManager.cancelAllTimers = function() {
    timingManager.activeTimers.forEach(function(timer, id) {
      timer.cancel();
    });
    timingManager.activeTimers.clear();
};

  // =============================================================================
  // DEBOUNCE & THROTTLE INTEGRATION - SharedUtilitiesçµ±åˆ
  // =============================================================================

/**
 * Debounceé–¢æ•° - é€£ç¶šå®Ÿè¡Œã‚’é˜²æ­¢
 * @param {Function} func - å®Ÿè¡Œã™ã‚‹é–¢æ•°
 * @param {string} key - ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã‚­ãƒ¼
 * @param {number} delay - é…å»¶æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
 * @returns {Function} ãƒ‡ãƒã‚¦ãƒ³ã‚¹åŒ–ã•ã‚ŒãŸé–¢æ•°
 */
TimingManager.debounce = function(func, key, delay) {
    delay = delay || 1000;
    if (!timingManager.debounceTimers) {
      timingManager.debounceTimers = new Map();
    }

    return function() {
  const args = Array.prototype.slice.call(arguments);
  const context = this;
      
      if (timingManager.debounceTimers.has(key)) {
        clearTimeout(timingManager.debounceTimers.get(key));
      }

  const timeoutId = setTimeout(function() {
        func.apply(context, args);
        timingManager.debounceTimers.delete(key);
      }, delay);

      timingManager.debounceTimers.set(key, timeoutId);
    };
};

/**
 * Throttleé–¢æ•° - å®Ÿè¡Œé »åº¦ã‚’åˆ¶é™
 * @param {Function} func - å®Ÿè¡Œã™ã‚‹é–¢æ•°
 * @param {string} key - ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã‚­ãƒ¼
 * @param {number} delay - å®Ÿè¡Œé–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰
 * @returns {Function} ã‚¹ãƒ­ãƒƒãƒˆãƒ«åŒ–ã•ã‚ŒãŸé–¢æ•°
 */
TimingManager.throttle = function(func, key, delay) {
    delay = delay || 100;
    if (!timingManager.throttleTimers) {
      timingManager.throttleTimers = new Map();
    }
    if (!timingManager.lastExecution) {
      timingManager.lastExecution = new Map();
    }

    return function() {
  const args = Array.prototype.slice.call(arguments);
  const context = this;
  const now = Date.now();
  const lastRun = timingManager.lastExecution.get(key) || 0;

      if (now - lastRun >= delay) {
        func.apply(context, args);
        timingManager.lastExecution.set(key, now);
      } else if (!timingManager.throttleTimers.has(key)) {
  const timeoutId = setTimeout(function() {
          func.apply(context, args);
          timingManager.lastExecution.set(key, Date.now());
          timingManager.throttleTimers.delete(key);
        }, delay - (now - lastRun));
        timingManager.throttleTimers.set(key, timeoutId);
      }
    };
};

/**
 * ç‰¹å®šã‚­ãƒ¼ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹/ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã‚’ã‚¯ãƒªã‚¢
 * @param {string} key - ã‚¯ãƒªã‚¢ã™ã‚‹ã‚­ãƒ¼
 */
TimingManager.clearTiming = function(key) {
    if (timingManager.debounceTimers && timingManager.debounceTimers.has(key)) {
      clearTimeout(timingManager.debounceTimers.get(key));
      timingManager.debounceTimers.delete(key);
    }
    if (timingManager.throttleTimers && timingManager.throttleTimers.has(key)) {
      clearTimeout(timingManager.throttleTimers.get(key));
      timingManager.throttleTimers.delete(key);
    }
    if (timingManager.lastExecution) {
      timingManager.lastExecution.delete(key);
    }
};

/**
 * å…¨ãƒ‡ãƒã‚¦ãƒ³ã‚¹/ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã‚’ã‚¯ãƒªã‚¢
 */
TimingManager.clearAllTiming = function() {
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (timingManager.debounceTimers) {
      timingManager.debounceTimers.forEach(function(timer) {
        clearTimeout(timer);
      });
      timingManager.debounceTimers.clear();
    }
    // ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (timingManager.throttleTimers) {
      timingManager.throttleTimers.forEach(function(timer) {
        clearTimeout(timer);
      });
      timingManager.throttleTimers.clear();
    }
    // å®Ÿè¡Œå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
    if (timingManager.lastExecution) {
      timingManager.lastExecution.clear();
    }
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
const timingManager = new TimingManager();

// TimingManagerã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
window.TimingManager = TimingManager;

// Global timing utilities
window.debounce = TimingManager.debounce;
window.throttle = TimingManager.throttle;

// =============================================================================
// UNIFIED CACHE CONTROLLER - çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
// =============================================================================

/**
 * çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç«¶åˆã‚’é˜²æ­¢
 */
// UnifiedCacheControlleræ©Ÿèƒ½ã¯CacheManagerã«çµ±åˆã•ã‚Œã¾ã—ãŸ
// cache.gsã®cacheManager.clearAllFrontendCaches()ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„

// çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¶å¾¡ã¯cache.gsã®cacheManagerã§ç®¡ç†ã•ã‚Œã¾ã™

// =============================================================================
// UI UPDATE BATCHER - çµ±ä¸€UIæ›´æ–°ã‚·ã‚¹ãƒ†ãƒ 
// =============================================================================

/**
 * UIæ›´æ–°ãƒãƒƒãƒãƒ£ãƒ¼ - UIæ›´æ–°ã®é‡è¤‡ã‚’é˜²ãåŠ¹ç‡åŒ–
 */
class UIUpdateBatcher {
  constructor() {
    this.pendingUpdates = [];
    this.batchTimeout = null;
    this.isProcessing = false;
    this.batchDelay = 100; // ãƒãƒƒãƒå‡¦ç†ã®é…å»¶ï¼ˆmsï¼‰
    this.debugMode = window.DEBUG_MODE || false;
  }

/**
 * UIæ›´æ–°ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
 * @param {Function} updateFn - æ›´æ–°é–¢æ•°
 * @param {string} updateId - æ›´æ–°IDï¼ˆé‡è¤‡æ’é™¤ç”¨ï¼‰
 * @param {number} priority - å„ªå…ˆåº¦ï¼ˆé«˜ã„ã»ã©å…ˆã«å®Ÿè¡Œï¼‰
   */
  queueUpdate(updateFn, updateId, priority) {
    updateId = updateId || null;
    priority = priority || 0;
    
    // é‡è¤‡æ’é™¤: åŒã˜IDã®æ›´æ–°ãŒã‚ã‚Œã°ç½®ãæ›ãˆ
    if (updateId) {
  const existingIndex = this.pendingUpdates.findIndex(function(update) {
        return update.id === updateId;
      });
      if (existingIndex !== -1) {
        this.pendingUpdates[existingIndex] = { 
          fn: updateFn, 
          id: updateId, 
          priority: priority, 
          timestamp: Date.now() 
        };
        return;
      }
    }

    // æ–°è¦è¿½åŠ 
    this.pendingUpdates.push({
      fn: updateFn,
      id: updateId || 'update_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      priority: priority,
      timestamp: Date.now()
    });

    if (this.debugMode) {
      console.log('â• UI update queued: ' + (updateId || 'anonymous') + ', queue size: ' + this.pendingUpdates.length);
    }

    this.scheduleBatch();
};

/**
 * ãƒãƒƒãƒå‡¦ç†ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
 */
  scheduleBatch() {
    const self = this;
    if (self.batchTimeout || self.isProcessing) return;

    self.batchTimeout = setTimeout(() => {
      self.processBatch();
    }, self.batchDelay);
};

/**
 * ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè¡Œ
 */
  processBatch() {
  const self = this;
    if (self.isProcessing || self.pendingUpdates.length === 0) return;

    self.isProcessing = true;
    self.batchTimeout = null;

    try {
      // å„ªå…ˆåº¦é †ã§ã‚½ãƒ¼ãƒˆï¼ˆé«˜ã„é †ï¼‰
  const sortedUpdates = self.pendingUpdates.slice().sort(function(a, b) {
        if (b.priority !== a.priority) return b.priority - a.priority;
        return a.timestamp - b.timestamp; // åŒã˜å„ªå…ˆåº¦ãªã‚‰å¤ã„é †
      });

      self.pendingUpdates = [];

      if (self.debugMode) {
        console.log('ğŸ¯ Processing UI update batch: ' + sortedUpdates.length + ' updates');
      }

      // é †æ¬¡å®Ÿè¡Œï¼ˆä¸¦åˆ—å®Ÿè¡Œã ã¨ç«¶åˆã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
      function processNextUpdate(index) {
        if (index >= sortedUpdates.length) {
          if (self.debugMode) {
            console.log('ğŸ‰ UI update batch completed: ' + sortedUpdates.length + ' updates processed');
          }
          
          self.isProcessing = false;
          
          // å‡¦ç†ä¸­ã«æ–°ã—ã„æ›´æ–°ãŒè¿½åŠ ã•ã‚Œã¦ã„ãŸã‚‰å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
          if (self.pendingUpdates.length > 0) {
            self.scheduleBatch();
          }
          return;
        }
        
  const update = sortedUpdates[index];
        try {
  const updatePromise = Promise.resolve(update.fn());
          updatePromise.then(function() {
            // å„æ›´æ–°é–“ã«çŸ­ã„é–“éš”ã‚’è¨­ã‘ã‚‹
            return TimingManager.delay(10);
          }).then(function() {
            processNextUpdate(index + 1);
          }).catch(function(error) {
            console.error('âŒ UI update failed: ' + update.id, error);
            TimingManager.delay(10).then(function() {
              processNextUpdate(index + 1);
            });
          });
        } catch (error) {
          console.error('âŒ UI update failed: ' + update.id, error);
          TimingManager.delay(10).then(function() {
            processNextUpdate(index + 1);
          });
        }
      }
      
      processNextUpdate(0);
      
    } catch (error) {
      console.error('âŒ UI update batch processing failed:', error);
      self.isProcessing = false;
      
      // å‡¦ç†ä¸­ã«æ–°ã—ã„æ›´æ–°ãŒè¿½åŠ ã•ã‚Œã¦ã„ãŸã‚‰å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      if (self.pendingUpdates.length > 0) {
        self.scheduleBatch();
      }
    }
};

/**
 * å³åº§ã«ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè¡Œ
 */
  flushUpdates() {
    if (this.batchTimeout) {
      clearTimeout(this.batchTimeout);
      this.batchTimeout = null;
    }
    
    this.processBatch();
};

/**
 * å¾…æ©Ÿä¸­ã®æ›´æ–°ã‚’ã‚¯ãƒªã‚¢
 */
  clearPendingUpdates() {
    this.pendingUpdates = [];
    if (this.batchTimeout) {
      clearTimeout(this.batchTimeout);
      this.batchTimeout = null;
    }
    
    if (this.debugMode) {
      console.log('ğŸ§¹ Pending UI updates cleared');
    }
};

/**
 * ãƒãƒƒãƒãƒ£ãƒ¼ã®çŠ¶æ…‹ã‚’å–å¾—
 */
  getStatus() {
    return {
      pendingUpdates: this.pendingUpdates.length,
      isProcessing: this.isProcessing,
      batchScheduled: !!this.batchTimeout
    };
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«UIæ›´æ–°ãƒãƒƒãƒãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
const uiUpdateBatcher = new UIUpdateBatcher();

// =============================================================================
// BACKEND FUNCTION WRAPPERS
// =============================================================================

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ: æ–°ã—ã„runGasWithUserIdé–¢æ•° - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ã
function runGasWithUserId(functionName, loadingMessage = 'å‡¦ç†ä¸­...', ...args) {
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãŒå¿…è¦ãªå ´åˆã¯ callWithLoading ã‚’ä½¿ç”¨
  if (loadingMessage && loadingMessage !== false) {
    // userIdãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–ã‚’å¾…ã¤
    if (!userId) {
      return userIdPromise.then(() => {
        if (!userId) {
          logError('No userId available for:', functionName);
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ãã§userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ  - Admin Panel uses overlay loading
        return sharedUtilities.gas.callWithLoading(functionName, loadingMessage, 'overlay', userId, ...args);
      }).catch((error) => {
        logError('Error in runGasWithUserId (after userIdPromise):', error);
        throw error;
      });
    }
    
    // userIdãŒæ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ã - Admin Panel uses overlay loading
    return sharedUtilities.gas.callWithLoading(functionName, loadingMessage, 'overlay', userId, ...args).catch((error) => {
      logError('Error in runGasWithUserId (direct call with loading):', error);
      throw error;
    });
  }
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸è¦ã®å ´åˆï¼ˆloadingMessage = falseï¼‰ã¯å¾“æ¥é€šã‚Š
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        logError('No userId available for:', functionName);
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }
      
      // userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ 
      return gasOptimizer.call(functionName, userId, ...args);
    }).catch((error) => {
      logError('userIdPromise rejected:', error);
      throw error;
    });
  }
  
  // userIdã‚’ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦è¿½åŠ 
  return gasOptimizer.call(functionName, userId, ...args);
}

// callWithCache é–¢æ•° - èª­ã¿å–ã‚Šå°‚ç”¨æ“ä½œç”¨
function callWithCache(functionName, cacheKey, ttl, ...args) {
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, ...args);
  }, ttl);
}

// runGasWithUserId with cache support
function callWithCacheWithUserId(functionName, cacheKey, ttl, ...args) {
  if (!userId) {
    return userIdPromise.then(() => {
      if (!userId) {
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
      return unifiedCache.getOrSet(cacheKey, function() {
        return gasOptimizer.call(functionName, userId, ...args);
      }, ttl);
    });
  }
  
  return unifiedCache.getOrSet(cacheKey, function() {
    return gasOptimizer.call(functionName, userId, ...args);
  }, ttl);
}

// =============================================================================
// STATUS AND DATA LOADING
// =============================================================================

// Load system status - OPTIMIZED with integrated API
// AIåˆ—åˆ¤å®šçµæœã¨configJsonã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
const processCache = {
  aiColumnMapping: {
    data: null,
    headersHash: null,
    timestamp: null,
    ttl: 300000 // 5åˆ†é–“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  },
  configNormalization: {
    data: null,
    dataHash: null,
    timestamp: null,
    ttl: 60000 // 1åˆ†é–“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  }
};

// ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆé–¢æ•°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function generateSimpleHash(data) {
  return JSON.stringify(data).split('').reduce((a, b) => {
    a = ((a << 5) - a) + b.charCodeAt(0);
    return a & a;
  }, 0);
}

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯
function isCacheValid(cacheEntry) {
  if (!cacheEntry.data || !cacheEntry.timestamp) return false;
  return (Date.now() - cacheEntry.timestamp) < cacheEntry.ttl;
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«é–¢æ•°ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å…¬é–‹ï¼ˆä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ï¼‰
window.processCache = processCache;
window.generateSimpleHash = generateSimpleHash;
window.isCacheValid = isCacheValid;

// loadStatuså®Ÿè¡Œç®¡ç†
let loadStatusInProgress = null;
let loadStatusQueue = [];

function loadStatus(bypassCache = false) {
  const operationId = 'loadStatus';
  
  // Check operation mutex to prevent concurrent calls
  if (!bypassCache && window.AdminPanel && window.AdminPanel.operationMutex) {
    if (window.AdminPanel.operationMutex.isRunning(operationId)) {
      logDebug('ğŸš« loadStatus already running, returning existing promise');
      return loadStatusInProgress || Promise.resolve(currentStatus);
    }
  }
  
  // æ—¢ã«å®Ÿè¡Œä¸­ã®å ´åˆã¯åŒã˜Promiseã‚’è¿”ã™ï¼ˆå¼·åŒ–ç‰ˆï¼‰
  if (loadStatusInProgress && !bypassCache) {
    logDebug('ğŸ”„ Reusing existing loadStatus promise');
    return loadStatusInProgress;
  }

  // Start operation mutex tracking
  if (window.AdminPanel && window.AdminPanel.operationMutex) {
    window.AdminPanel.operationMutex.start(operationId);
  }

  console.group('ğŸ”„ loadStatus - ä¸€å…ƒç®¡ç†ç‰ˆ');
  console.log('ğŸš€ Loading system status, bypassCache:', bypassCache);

  // æ–°ã—ã„å®Ÿè¡Œã‚’é–‹å§‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿæ§‹ä»˜ãï¼‰
  loadStatusInProgress = userIdPromise.then(() => {
    if (!userId) {
      console.error('âŒ userId is not available after userIdPromise resolution in loadStatus!');
      showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
      console.groupEnd();
      throw new Error('userId is not available');
    }
  }).catch(error => {
    console.error('âŒ Error resolving userIdPromise in loadStatus:', error);
    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥èªè¨¼ã‚’å†è©¦è¡Œ
    console.warn('âš ï¸ Attempting direct authentication as fallback...');
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(response => {
          console.log('ğŸ”„ Fallback authentication response:', response);
          if (response && response.status === 'success' && response.userInfo && response.userInfo.userId) {
            userId = response.userInfo.userId;
            console.log('âœ… Fallback authentication successful, userId:', userId);
            resolve(userId);
          } else {
            console.error('âŒ Fallback authentication also failed:', response);
            reject(new Error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èªè¨¼ã‚‚å¤±æ•—ã—ã¾ã—ãŸ'));
          }
        })
        .withFailureHandler(reject)
        .getCurrentUserStatus();
    });
  }).then(() => {
    if (!userId) {
      console.error('âŒ userId still not available after fallback');
      throw new Error('userId is not available after fallback');
    }

    console.log('ğŸŒ Calling getInitialData with userId:', userId, 'bypassCache:', bypassCache);

    // å±¥æ­´å¾©å…ƒæ™‚ãªã©ã®å¼·åˆ¶æ›´æ–°ç”¨ãƒ•ãƒ©ã‚°
    const forceRefresh = bypassCache && window._historyRestoreInProgress;
    const targetSheetParam = forceRefresh ? 'BYPASS_CACHE' : null;

    // runGasWithUserId ã‚’ä½¿ç”¨ã—ã¦ getInitialData ã‚’å‘¼ã³å‡ºã™
    return runGasWithUserId('getInitialData', 'ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...', targetSheetParam, false)
      .then(response => {
        console.log('ğŸš€ getInitialData response received:', {
          response: response,
          hasUserInfo: !!response?.userInfo,
          userInfoKeys: response?.userInfo ? Object.keys(response.userInfo) : [],
          adminEmail: response?.userInfo?.adminEmail,
          userId: response?.userInfo?.userId
        });
        logDebug('âœ… Integrated data loaded:', response);
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
        if (!response || response.status === 'error') {
          const errorMsg = response ? response.message : 'ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç„¡åŠ¹ãªå¿œç­”ã‚’å—ä¿¡ã—ã¾ã—ãŸ';
          logError('getInitialData returned error:', errorMsg);
          throw new Error(errorMsg);
        }
        
        // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
        if (!response.userInfo) {
          logError('userInfo missing in response:', response);
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }

        // Update UI with integrated response
        updateUIWithNewStatus(response);

        // If sheet details are included, apply them immediately
        if (response.sheetDetails && response.activeSheetName) {
          logDebug('âœ… Sheet details included in integrated response, applying configuration');
          try {
            populateHeaderOptions(response.sheetDetails.allHeaders);
            logDebug('âœ… Header options populated from integrated data');
            populateConfig(response.sheetDetails.guessedConfig);
            logDebug('âœ… AI configuration applied from integrated data');
          } catch (configError) {
            console.error('Error applying sheet configuration from integrated data:', configError);
          }
        }

        logInfo('âš¡ Performance: Single API call replaced 3-4 separate calls');
        return response; // Promiseãƒã‚§ãƒ¼ãƒ³ã‚’ç¶­æŒã™ã‚‹ãŸã‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
      })
      .catch(error => {
        console.error('âŒ Integrated API failed:', error);
        showMessage('ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        throw error; // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
      })
      .finally(() => {
        console.groupEnd();
        // å®Ÿè¡ŒçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        loadStatusInProgress = null;
        
        // End operation mutex tracking
        if (window.AdminPanel && window.AdminPanel.operationMutex) {
          window.AdminPanel.operationMutex.end(operationId);
        }
      });
  }).catch(error => {
    console.error('âŒ Error resolving userIdPromise in loadStatus:', error);
    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    console.groupEnd();
    // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å®Ÿè¡ŒçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    loadStatusInProgress = null;
    
    // End operation mutex tracking on error
    if (window.AdminPanel && window.AdminPanel.operationMutex) {
      window.AdminPanel.operationMutex.end(operationId);
    }
    
    throw error;
  });

  return loadStatusInProgress;
}

// Load sheet configuration for selected sheet with retry mechanism
function loadConfigForSelected(sheetNameOverride = null, spreadsheetIdOverride = null, retryCount = 0, maxRetries = 3, forceLoad = false) {
  // å±¥æ­´å¾©å…ƒä¸­ã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¼·åˆ¶èª­ã¿è¾¼ã¿ãƒ•ãƒ©ã‚°ãŒã‚ã‚‹å ´åˆã¯é™¤ãï¼‰
  if ((window._historyRestoreInProgress || window._historyColumnSelections) && !forceLoad) {
    console.log('ğŸ›¡ï¸ loadConfigForSelected: å±¥æ­´å¾©å…ƒä¸­ã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ');
    return Promise.resolve({ success: false, message: 'Skipped during history restore' });
  }
  
  const targetSheet = sheetNameOverride || selectedSheet;
  if (!targetSheet) {
    logWarn('No sheet selected for config loading');
    return Promise.reject(new Error('No sheet selected for config loading'));
  }
  
  const targetSpreadsheetId = spreadsheetIdOverride || (currentStatus?.userInfo?.spreadsheetId);
  if (!targetSpreadsheetId) {
    logError('Missing required data for loadConfigForSelected');
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return Promise.reject(new Error('Missing required data for loadConfigForSelected'));
  }
  
  // Sanitize sheet name for API call (already sanitized from caller, but double-check)
  const sanitizedSheetName = targetSheet.replace(/[^\w\s\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF-]/g, '').trim();
  
  console.log('ğŸ”„ Loading config for sheet: "' + targetSheet + '" (sanitized: "' + sanitizedSheetName + '"), attempt ' + (retryCount + 1) + '/' + (maxRetries + 1));
  
  return runGasWithUserId('getSheetDetails', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...', targetSpreadsheetId, sanitizedSheetName)
    .then(handleSheetDetailsSuccess)
    .catch(error => {
      console.warn('âŒ loadConfigForSelected attempt ' + (retryCount + 1) + ' failed:', error);
      
      // Check if this is a sheet parsing error and we have retries left
      if (retryCount < maxRetries && (
        error.message?.includes('Unable to parse range') ||
        error.message?.includes('ç¯„å›²ã‚’è§£æã§ãã¾ã›ã‚“') ||
        error.message?.includes('Invalid range')
      )) {
        const retryDelay = Math.min(1000 * Math.pow(2, retryCount), 5000); // Exponential backoff, max 5s
        console.log('â³ Retrying in ' + retryDelay + 'ms...');
        
        return new Promise(resolve => setTimeout(resolve, retryDelay))
          .then(() => loadConfigForSelected(sheetNameOverride, spreadsheetIdOverride, retryCount + 1, maxRetries));
      }
      
      // If no more retries or different error, use original error handler
      return handleSheetDetailsError(error);
    });
}

// Handle successful sheet details loading
function handleSheetDetailsSuccess(details) {
  if (details && details.allHeaders) {
    populateHeaderOptions(details.allHeaders);
    
    // Show config area and hide placeholder
    const configArea = document.getElementById('config-area');
    const configPlaceholder = document.getElementById('config-placeholder');
    
    if (configArea) {
      configArea.classList.remove('hidden');
    }
    
    if (configPlaceholder) {
      configPlaceholder.classList.add('hidden');
    }
    
    if (details.guessedConfig) {
      // å±¥æ­´å¾©å…ƒä¸­ã¯AIåˆ—åˆ¤å®šã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¼·åˆ¶èª­ã¿è¾¼ã¿æ™‚ã‚‚å«ã‚€ï¼‰
      if (window._historyRestoreInProgress || window._historyColumnSelections || forceLoad) {
        if (forceLoad) {
          console.log('ğŸ”„ å¼·åˆ¶èª­ã¿è¾¼ã¿æ™‚: AIåˆ—åˆ¤å®šã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å±¥æ­´è¨­å®šã‚’å„ªå…ˆ');
        } else {
          console.log('ğŸ›¡ï¸ å±¥æ­´å¾©å…ƒä¸­ã®ãŸã‚ã€AIåˆ—åˆ¤å®šã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ');
        }
        console.log('ğŸ” Skip flags:', {
          historyRestoreInProgress: window._historyRestoreInProgress,
          historyColumnSelections: !!window._historyColumnSelections,
          forceLoad: forceLoad
        });
      } else {
        // DOMã®æ›´æ–°ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰populateConfigã‚’å‘¼ã³å‡ºã™
        setTimeout(() => {
          // é…å»¶å®Ÿè¡Œæ™‚ã«ã‚‚å†åº¦ãƒã‚§ãƒƒã‚¯
          if (window._historyRestoreInProgress || window._historyColumnSelections) {
            console.log('ğŸ›¡ï¸ é…å»¶å®Ÿè¡Œæ™‚: å±¥æ­´å¾©å…ƒä¸­ã®ãŸã‚ã€AIåˆ—åˆ¤å®šã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ');
            return;
          }
          populateConfig(details.guessedConfig);
          
          // Enhanced auto-detection success message with specifics
          const detectedColumns = [];
          if (details.guessedConfig.opinionColumn) detectedColumns.push('å›ç­”åˆ—: ' + details.guessedConfig.opinionColumn);
          if (details.guessedConfig.nameColumn) detectedColumns.push('åå‰åˆ—: ' + details.guessedConfig.nameColumn);
          if (details.guessedConfig.classColumn) detectedColumns.push('ã‚¯ãƒ©ã‚¹åˆ—: ' + details.guessedConfig.classColumn);
          
          const message = detectedColumns.length > 0 
            ? ('ğŸ¤– AIåˆ—åˆ¤å®šãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼æ¤œå‡ºã•ã‚ŒãŸåˆ—: ' + detectedColumns.join(', ') + 'ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚')
            : 'ğŸ¤– AIåˆ—åˆ¤å®šãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          
          showMessage(message, 'success');
        }, 0);
      }
    }
    
    // æˆåŠŸæ™‚ã®æˆ»ã‚Šå€¤ã‚’è¿”ã™
    return {
      success: true,
      headers: details.allHeaders,
      guessedConfig: details.guessedConfig || null,
      message: 'ã‚·ãƒ¼ãƒˆè¨­å®šã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ'
    };
  } else {
    logWarn('No headers in sheet details:', details);
    showMessage('ã‚·ãƒ¼ãƒˆã®è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'warning');
    
    // ã‚¨ãƒ©ãƒ¼æ™‚ã®æˆ»ã‚Šå€¤ã‚’è¿”ã™
    return {
      success: false,
      error: 'ã‚·ãƒ¼ãƒˆã®è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ',
      details: details
    };
  }
}

// Handle sheet details loading error
function handleSheetDetailsError(error) {
  logError('Sheet details failed:', error);
  handleError(error, 'loadConfigForSelected', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
}

// =============================================================================
// AI COLUMN DETECTION
// =============================================================================

// Run AI-powered header guessing
function runHeaderGuessing() {
  if (!selectedSheet) {
    showMessage('ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  // Update button state to show AI is working
  const reguessBtn = document.getElementById('reguess-headers-btn');
  if (reguessBtn) {
    const originalContent = reguessBtn.innerHTML;
    reguessBtn.disabled = true;
    reguessBtn.innerHTML = `
      <span class="relative z-10 flex items-center gap-1">
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <span class="text-xs font-bold">AIåˆ†æä¸­</span>
      </span>
    `;
    
    // Restore button after completion
    const restoreButton = () => {
      reguessBtn.disabled = false;
      reguessBtn.innerHTML = originalContent;
    };
    
    // Show start notification
    showMessage('ğŸ¤– é«˜ç²¾åº¦AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...', 'info');
    
    runGasWithUserId('getSheetDetails', 'AIæ­è¼‰é«˜ç²¾åº¦åˆ—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãŒåˆ†æä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
      .then(function(details) {
        if (!details || !details.guessedConfig) {
          restoreButton();
          showMessage('âŒ AIåˆ—åˆ¤å®šãŒå¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'warning');
          return;
        }
        
        const configToUse = {
          ...details.guessedConfig,
          sheetName: selectedSheet
        };
        
        setTimeout(() => {
          populateConfig(configToUse);
          restoreButton();
          
          // Enhanced completion notification with analysis details
          const detectedColumns = [];
          if (configToUse.opinionColumn) detectedColumns.push('ğŸ’¬ å›ç­”åˆ—: ' + configToUse.opinionColumn);
          if (configToUse.nameColumn) detectedColumns.push('ğŸ‘¤ åå‰åˆ—: ' + configToUse.nameColumn);
          if (configToUse.classColumn) detectedColumns.push('ğŸ« ã‚¯ãƒ©ã‚¹åˆ—: ' + configToUse.classColumn);
          if (configToUse.reasonColumn) detectedColumns.push('ğŸ’­ ç†ç”±åˆ—: ' + configToUse.reasonColumn);
          
          const message = detectedColumns.length > 0 
            ? ('ğŸ‰ é«˜ç²¾åº¦AIåˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\næ¤œå‡ºã•ã‚ŒãŸåˆ—:\n' + detectedColumns.join('\n') + '\n\nè¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹ã—ã¦ãã ã•ã„ã€‚')
            : 'ğŸ‰ é«˜ç²¾åº¦AIåˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹ã—ã¦ãã ã•ã„ã€‚';
          
          showMessage(message, 'success');
          
          // âœ¨ é‡è¦: AIåˆ¤å®šå®Œäº†å¾Œã®å‡¦ç†
          setTimeout(() => {
            console.log('ğŸš€ AIåˆ¤å®šå®Œäº† - å¾Œå‡¦ç†ã‚’é–‹å§‹');
            
            // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦å¿…è¦ãªå ´åˆã®ã¿å®Ÿè¡Œ
            if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
              const config = typeof currentStatus.userInfo.configJson === 'string' 
                ? JSON.parse(currentStatus.userInfo.configJson) 
                : currentStatus.userInfo.configJson;
              
              if (config.setupStatus === 'pending' || !config.formCreated) {
                console.log('ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†çŠ¶æ…‹ã‚’æ¤œå‡º - å‡¦ç†ã‚’å®Ÿè¡Œ');
                completeAIDetectionProcess();
              } else {
              }
            } else {
              console.log('ğŸ”§ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ãŒä¸æ˜ - å¿µã®ãŸã‚å‡¦ç†ã‚’å®Ÿè¡Œ');
              completeAIDetectionProcess();
            }
          }, 1000);
        }, 100);
      })
      .catch(function(error) {
        restoreButton();
        console.error('AI column detection error:', error);
        
        // Enhanced error message with specific guidance
        let errorMessage = 'âŒ é«˜ç²¾åº¦AIåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n';
        if ((error && error.message && error.message.includes('permission')) || (error && error.message && error.message.includes('æ¨©é™'))) {
          errorMessage += 'ğŸ“‹ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        } else if ((error && error.message && error.message.includes('network')) || (error && error.message && error.message.includes('timeout'))) {
          errorMessage += 'ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
        } else {
          errorMessage += 'âš™ï¸ æ‰‹å‹•ã§åˆ—ã‚’è¨­å®šã™ã‚‹ã‹ã€å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        }
        
        errorMessage += '\n\nğŸ’¡ å•é¡ŒãŒç¶šãå ´åˆã¯ã€ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
        
        showMessage(errorMessage, 'error');
      });
  }
}

// âœ¨ AIåˆ¤å®šå®Œäº†å¾Œã®è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å‡¦ç†
function completeAIDetectionProcess() {
  try {
    console.log('ğŸ”§ AIåˆ¤å®šå®Œäº† - è¨­å®šä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œä¸­...');
    
    // 1. è¨­å®šæ¤œè¨¼
    if (!validateConfig()) {
      console.warn('âš ï¸ AIåˆ¤å®šçµæœã®è¨­å®šãŒä¸å®Œå…¨ - æ‰‹å‹•è¨­å®šãŒå¿…è¦');
      showMessage('AIåˆ¤å®šçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚è¨­å®šã«ä¸å‚™ãŒã‚ã‚Šã¾ã™ã€‚', 'warning');
      return;
    }
    
    // 2. ãƒ•ã‚©ãƒ¼ãƒ URLæ¤œå‡ºãƒ»ä½œæˆã®å®Ÿè¡Œ
    
    runGasWithUserId('detectFormUrlFromSpreadsheet', 'ãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet)
      .then(result => {
        console.log('ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºçµæœå—ä¿¡');
        
        if (result && result.success && result.formUrl) {
          
          // 3. è¨­å®šã®è‡ªå‹•ä¿å­˜ã¨å®Œäº†çŠ¶æ…‹ã¸ã®æ›´æ–°
          const config = buildConfigObject();
          config.formUrl = result.formUrl;
          config.formCreated = true;
          config.setupStatus = 'completed';
          
          console.log('ğŸ’¾ AIåˆ¤å®šå®Œäº†å¾Œã®è¨­å®šã‚’è‡ªå‹•ä¿å­˜ä¸­...', config);
          
          // Save draft to session storage when AI prediction is completed
          const draftData = {
            questionText: config.opinionHeader || config.opinionColumn || 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰',
            sheetName: selectedSheet,
            config: config,
            displayMode: (function() { const el = document.getElementById('anonymous-mode'); return el && el.checked ? 'anonymous' : 'named'; })(),
            countDisplay: 'show' // Default, could be configured based on UI settings
          };
          
          saveDraftToSession(draftData);
          console.log('ğŸ“ ä¸‹æ›¸ãã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¾ã—ãŸ:', draftData.questionText);
          
          return runGasWithUserId('saveSheetConfig', 'è¨­å®šä¿å­˜ä¸­...', currentStatus.userInfo.spreadsheetId, selectedSheet, config);
        } else {
          throw new Error('ãƒ•ã‚©ãƒ¼ãƒ URLã®æ¤œå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .then(saveResult => {
        if (saveResult && saveResult.success) {
          showMessage('ğŸ‰ AIåˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹ã—ã¦ãã ã•ã„ã€‚', 'success');
          
          // 4. UIçŠ¶æ…‹ã®æ›´æ–°
          if (typeof loadSystemStatus === 'function') {
            loadSystemStatus();
          }
          
          // 5. ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºã®æ›´æ–°
          if (typeof navigateToStep === 'function') {
            navigateToStep(2); // ã‚¹ãƒ†ãƒƒãƒ—2ï¼ˆAIåˆ—åˆ†æå®Œäº†ï¼‰ã«é€²ã‚€
          }

          // 6. æ‰‹å‹•å…¬é–‹ã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆè‡ªå‹•å…¬é–‹ã¯å‰Šé™¤ï¼‰

        } else {
          throw new Error((saveResult && saveResult.message) || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ AIåˆ¤å®šå®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('âš ï¸ AIåˆ¤å®šå¾Œã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '\næ‰‹å‹•ã§ã€Œä¿å­˜ãƒ»å…¬é–‹ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', 'warning');
      });
      
  } catch (error) {
    console.error('âŒ completeAIDetectionProcess è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:', error);
    showMessage('AIåˆ¤å®šå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
  }
}

// âœ¨ è¨­å®šåˆæœŸåŒ–çµ±ä¸€æ©Ÿèƒ½
// å®Ÿè¡ŒçŠ¶æ…‹ã®ç®¡ç†
let initializationInProgress = false;
let lastInitializationTime = 0;
const INITIALIZATION_COOLDOWN = 30000; // 30ç§’ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³

/**
 * çµ±ä¸€è¨­å®šåˆæœŸåŒ–æ©Ÿèƒ½
 * è‡ªå‹•è¨ºæ–­â†’è»½å¾®ä¿®å¾©â†’å¿…è¦ã«å¿œã˜ã¦å®Œå…¨ãƒªã‚»ãƒƒãƒˆã®æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
 */
function initializeUserSettings() {
  return new Promise((resolve, reject) => {
    try {
      // é‡è¤‡å®Ÿè¡Œé˜²æ­¢ãƒã‚§ãƒƒã‚¯
      const now = Date.now();
      if (initializationInProgress) {
        resolve({ 
          success: false, 
          message: 'è¨­å®šåˆæœŸåŒ–ãŒæ—¢ã«å®Ÿè¡Œä¸­ã§ã™', 
          skipped: true, 
          reason: 'already_running' 
        });
        return;
      }
      
      // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒã‚§ãƒƒã‚¯
      if (now - lastInitializationTime < INITIALIZATION_COOLDOWN) {
        const remainingTime = Math.ceil((INITIALIZATION_COOLDOWN - (now - lastInitializationTime)) / 1000);
        resolve({ 
          success: false, 
          message: 'ã‚ã¨' + remainingTime + 'ç§’å¾Œã«å®Ÿè¡Œå¯èƒ½ã§ã™', 
          skipped: true, 
          reason: 'cooldown', 
          remainingTime 
        });
        return;
      }
      
      initializationInProgress = true;
      lastInitializationTime = now;
      
      console.log('ğŸ”„ è¨­å®šåˆæœŸåŒ–ã‚’é–‹å§‹...');
      
      // ãƒ•ã‚§ãƒ¼ã‚º1: è‡ªå‹•è¨ºæ–­
      performSystemDiagnostic()
        .then(diagnosticResult => {
          if (diagnosticResult.severity === 'none') {
            // å•é¡Œãªã—
            initializationInProgress = false;
            resolve({
              success: true,
              phase: 'diagnostic',
              message: 'âœ… è¨­å®šã«å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ',
              issues: [],
              fixes: []
            });
          } else if (diagnosticResult.severity === 'minor') {
            // è»½å¾®ãªå•é¡Œ - è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ
            return performAutoRepair();
          } else {
            // é‡å¤§ãªå•é¡Œ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸æŠã‚’å§”ã­ã‚‹
            initializationInProgress = false;
            resolve({
              success: false,
              phase: 'needs_confirmation',
              message: 'é‡å¤§ãªè¨­å®šå•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚å®Œå…¨ãªåˆæœŸåŒ–ãŒå¿…è¦ã§ã™ã€‚',
              severity: diagnosticResult.severity,
              issues: diagnosticResult.issues,
              requiresFullReset: true
            });
          }
        })
        .then(repairResult => {
          if (repairResult) {
            initializationInProgress = false;
            resolve({
              success: true,
              phase: 'auto_repair',
              message: 'ğŸ”§ ' + (repairResult.fixes?.length || 0) + 'ä»¶ã®å•é¡Œã‚’è‡ªå‹•ä¿®å¾©ã—ã¾ã—ãŸ',
              issues: repairResult.issues || [],
              fixes: repairResult.fixes || []
            });
          }
        })
        .catch(error => {
          initializationInProgress = false;
          reject(new Error('è¨­å®šåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message));
        });
        
    } catch (error) {
      initializationInProgress = false;
      reject(error);
    }
  });
}

/**
 * UIä»˜ãè¨­å®šåˆæœŸåŒ–å®Ÿè¡Œé–¢æ•°
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºã‚’å«ã‚€
 */
function initializeUserSettingsWithUI() {
  const button = document.getElementById('initialize-settings-btn');
  const originalHTML = button ? button.innerHTML : '';
  
  // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ã€Œå‡¦ç†ä¸­ã€ã«å¤‰æ›´
  if (button) {
    button.disabled = true;
    button.innerHTML = `
      <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      è¨ºæ–­ä¸­...
    `;
  }
  
  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
  showMessage('ğŸ” ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...', 'info');
  
  initializeUserSettings()
    .then(result => {
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
      if (button) {
        button.disabled = false;
        button.innerHTML = originalHTML;
      }
      
      if (result.success) {
        // æˆåŠŸæ™‚ã®å‡¦ç†
        if (result.phase === 'diagnostic') {
          showMessage(result.message, 'success');
        } else if (result.phase === 'auto_repair') {
          showMessage(result.message, 'success');
          if (result.fixes.length > 0) {
            console.log('ğŸ”§ ä¿®å¾©ã•ã‚ŒãŸå•é¡Œ:', result.fixes);
          }
        }
      } else {
        // ç¢ºèªãŒå¿…è¦ãªå ´åˆ
        if (result.requiresFullReset) {
          const issuesList = result.issues.map(issue => 'â€¢ ' + issue).join('\n');
          
          showConfirmationModal(
            'è¨­å®šã®å®Œå…¨åˆæœŸåŒ–ãŒå¿…è¦ã§ã™',
            'ä»¥ä¸‹ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:\n\n' + issuesList + '\n\nè¨­å®šã‚’å®Œå…¨ã«åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ï¼‰',
            () => {
              // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºèªã—ãŸå ´åˆã€å®Œå…¨ãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œ
              performFullReset()
                .then(resetResult => {
                  if (resetResult.success) {
                    showMessage('âœ… è¨­å®šãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ', 'success');
                    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°çŠ¶æ…‹ã‚’åæ˜ 
                    setTimeout(() => location.reload(), 1500);
                  } else {
                    showMessage('âŒ è¨­å®šåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                  }
                })
                .catch(error => {
                  console.error('Full reset failed:', error);
                  showMessage('âŒ è¨­å®šåˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                });
            }
          );
        } else {
          showMessage(result.message, 'warning');
        }
      }
    })
    .catch(error => {
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
      if (button) {
        button.disabled = false;
        button.innerHTML = originalHTML;
      }
      
      console.error('Settings initialization failed:', error);
      showMessage('âŒ è¨­å®šåˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    });
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ï¼ˆå•é¡Œã®é‡è¦åº¦ã‚’åˆ¤å®šï¼‰
 */
function performSystemDiagnostic() {
  return new Promise((resolve) => {
    try {
      if (!currentStatus || !currentStatus.userInfo) {
        resolve({ severity: 'critical', issues: ['ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'] });
        return;
      }
      
      const config = typeof currentStatus.userInfo.configJson === 'string' 
        ? JSON.parse(currentStatus.userInfo.configJson) 
        : currentStatus.userInfo.configJson;
        
      const issues = [];
      let maxSeverity = 'none';
      
      // è»½å¾®ãªå•é¡Œã®æ¤œå‡º
      const minorIssues = detectMinorIssues(config);
      if (minorIssues.length > 0) {
        issues.push(...minorIssues);
        maxSeverity = 'minor';
      }
      
      // é‡å¤§ãªå•é¡Œã®æ¤œå‡º
      const criticalIssues = detectCriticalIssues(config);
      if (criticalIssues.length > 0) {
        issues.push(...criticalIssues);
        maxSeverity = 'critical';
      }
      
      resolve({
        severity: maxSeverity,
        issues: issues
      });
      
    } catch (error) {
      resolve({ 
        severity: 'critical', 
        issues: ['è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ' + error.message] 
      });
    }
  });
}

/**
 * è»½å¾®ãªå•é¡Œã®æ¤œå‡º
 */
function detectMinorIssues(config) {
  const issues = [];
  
  // æ—¢å­˜ã®ä¿®å¾©ãƒ«ãƒ¼ãƒ«ã‹ã‚‰è»½å¾®ãªã‚‚ã®ã‚’æŠ½å‡º
  if (config.formUrl && config.formUrl.trim() && !config.formCreated) {
    issues.push('ãƒ•ã‚©ãƒ¼ãƒ URLãŒå­˜åœ¨ã™ã‚‹ãŒä½œæˆãƒ•ãƒ©ã‚°ãŒfalse');
  }
  
  if (config.formCreated && config.setupStatus !== 'completed') {
    issues.push('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ¸ˆã¿ã ãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ãŒæœªå®Œäº†');
  }
  
  if (config.appPublished && config.setupStatus === 'pending') {
    issues.push('å…¬é–‹æ¸ˆã¿ã ãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ãŒpending');
  }
  
  if (currentStatus.sheetDetails?.guessedConfig?.opinionHeader && config.setupStatus === 'pending') {
    issues.push('AIåˆ—åˆ¤å®šå®Œäº†æ¸ˆã¿ã ãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ãŒpending');
  }
  
  return issues;
}

/**
 * é‡å¤§ãªå•é¡Œã®æ¤œå‡º
 */
function detectCriticalIssues(config) {
  const issues = [];
  
  // è¨­å®šãŒå®Œå…¨ã«ç ´æã—ã¦ã„ã‚‹å ´åˆ
  if (!config || typeof config !== 'object') {
    issues.push('è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã¾ã™');
  }
  
  // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ¬ è½ã—ã¦ã„ã‚‹å ´åˆ
  if (config && !config.hasOwnProperty('setupStatus')) {
    issues.push('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹æƒ…å ±ãŒæ¬ è½ã—ã¦ã„ã¾ã™');
  }
  
  return issues;
}

/**
 * è‡ªå‹•ä¿®å¾©ã®å®Ÿè¡Œ
 */
function performAutoRepair() {
  return new Promise((resolve, reject) => {
    // æ—¢å­˜ã®repairSetupStateInconsistencies()ã®æ ¸å¿ƒéƒ¨åˆ†ã‚’ä½¿ç”¨
    repairSetupStateInconsistencies()
      .then(result => resolve(result))
      .catch(error => reject(error));
  });
}

/**
 * å®Œå…¨ãƒªã‚»ãƒƒãƒˆã®å®Ÿè¡Œï¼ˆç¢ºèªæ¸ˆã¿ï¼‰
 */
function performFullReset() {
  return new Promise((resolve, reject) => {
    runGasWithUserId('resetConfigJson', 'è¨­å®šã‚’å®Œå…¨åˆæœŸåŒ–ä¸­...')
      .then(result => {
        if (result.success) {
          resolve({
            success: true,
            phase: 'full_reset',
            message: 'âœ… è¨­å®šã‚’å®Œå…¨ã«åˆæœŸåŒ–ã—ã¾ã—ãŸ',
            resetAt: result.resetAt
          });
        } else {
          reject(new Error(result.message || 'å®Œå…¨åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        }
      })
      .catch(error => reject(error));
  });
}

// âœ¨ ãƒ¬ã‚¬ã‚·ãƒ¼è¨ºæ–­ãƒ»ä¿®å¾©æ©Ÿèƒ½ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹å­˜ï¼‰
// è¨ºæ–­å®Ÿè¡ŒçŠ¶æ…‹ã®ç®¡ç†
let diagnosticInProgress = false;
let lastDiagnosticTime = 0;
const DIAGNOSTIC_COOLDOWN = 30000; // 30ç§’ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³

function repairSetupStateInconsistencies() {
  return new Promise((resolve, reject) => {
    try {
      // é‡è¤‡å®Ÿè¡Œé˜²æ­¢ãƒã‚§ãƒƒã‚¯
      const now = Date.now();
      if (diagnosticInProgress) {
        resolve({ issues: [], fixes: [], skipped: true, reason: 'already_running' });
        return;
      }
      
      // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒã‚§ãƒƒã‚¯
      if (now - lastDiagnosticTime < DIAGNOSTIC_COOLDOWN) {
        const remainingTime = Math.ceil((DIAGNOSTIC_COOLDOWN - (now - lastDiagnosticTime)) / 1000);
        console.log('â³ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã§ã™ã€‚ã‚ã¨' + remainingTime + 'ç§’å¾Œã«å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚');
        resolve({ issues: [], fixes: [], skipped: true, reason: 'cooldown', remainingTime });
        return;
      }
      
      diagnosticInProgress = true;
      lastDiagnosticTime = now;
      console.log('ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã®è¨ºæ–­ãƒ»ä¿®å¾©ã‚’é–‹å§‹...');
      
      if (!currentStatus || !currentStatus.userInfo) {
        diagnosticInProgress = false;
        reject(new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'));
        return;
      }
      
      const config = typeof currentStatus.userInfo.configJson === 'string' 
        ? JSON.parse(currentStatus.userInfo.configJson) 
        : currentStatus.userInfo.configJson;
        
      const issues = [];
      const fixes = [];
      
      // 1. ãƒ•ã‚©ãƒ¼ãƒ URL vs formCreated ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (config.formUrl && config.formUrl.trim() && !config.formCreated) {
        issues.push('ãƒ•ã‚©ãƒ¼ãƒ URLãŒå­˜åœ¨ã™ã‚‹ãŒ formCreated=false');
        config.formCreated = true;
        fixes.push('formCreated ã‚’ true ã«ä¿®æ­£');
      }
      
      // 2. formCreated vs setupStatus ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (config.formCreated && config.setupStatus !== 'completed') {
        issues.push('ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆæ¸ˆã¿ã ãŒ setupStatus != completed');
        config.setupStatus = 'completed';
        fixes.push('setupStatus ã‚’ completed ã«ä¿®æ­£');
      }
      
      // 3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¨activeSheetNameã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (currentStatus.userInfo.spreadsheetId && !currentStatus.activeSheetName && selectedSheet) {
        issues.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹ãŒ activeSheetName ãŒæœªè¨­å®š');
        // ã“ã‚Œã¯configã§ã¯ãªãstatusã®å•é¡Œãªã®ã§ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ä¿®æ­£ãŒå¿…è¦
        fixes.push('activeSheetName ã®æ›´æ–°ãŒå¿…è¦ï¼ˆè¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ï¼‰');
      }
      
      // 4. å…¬é–‹çŠ¶æ…‹ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆpublishedSheetName vs appPublishedï¼‰
      if (config.publishedSheetName && !config.appPublished) {
        issues.push('å…¬é–‹ã‚·ãƒ¼ãƒˆåãŒå­˜åœ¨ã™ã‚‹ãŒ appPublished=false');
        // ã“ã‚Œã¯æ…é‡ã«åˆ¤æ–­ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€è­¦å‘Šã®ã¿
        fixes.push('æ³¨æ„: å…¬é–‹çŠ¶æ…‹ã®ç¢ºèªãŒå¿…è¦');
      }
      
      // 5. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: appPublished=true ã ãŒ setupStatus='pending' ã®å ´åˆï¼ˆå…¬é–‹æ¸ˆã¿ä¸æ•´åˆï¼‰
      if (config.appPublished && config.setupStatus === 'pending') {
        issues.push('å…¬é–‹æ¸ˆã¿ã ãŒ setupStatus=pending');
        config.setupStatus = 'completed';
        fixes.push('setupStatus ã‚’ completed ã«ä¿®æ­£ï¼ˆæ—¢ã«å…¬é–‹æ¸ˆã¿ã®ãŸã‚ï¼‰');
      }
      
      // 6. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: å…¬é–‹URLãŒå­˜åœ¨ã™ã‚‹ãŒ formCreated=false ã®å ´åˆ
      if (currentStatus.viewUrl && currentStatus.viewUrl.trim() && !config.formCreated) {
        issues.push('å…¬é–‹URLãŒå­˜åœ¨ã™ã‚‹ãŒ formCreated=false');
        config.formCreated = true;
        fixes.push('formCreated ã‚’ true ã«ä¿®æ­£ï¼ˆå…¬é–‹URLå­˜åœ¨ã®ãŸã‚ï¼‰');
      }
      
      // 7. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: isPublished=true ã ãŒ setupStatus='pending' ã®å ´åˆï¼ˆã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ä¸æ•´åˆï¼‰
      if (currentStatus.isPublished && config.setupStatus === 'pending') {
        issues.push('ã‚·ã‚¹ãƒ†ãƒ ã§å…¬é–‹æ¸ˆã¿åˆ¤å®šã ãŒ setupStatus=pending');
        config.setupStatus = 'completed';
        fixes.push('setupStatus ã‚’ completed ã«ä¿®æ­£ï¼ˆå…¬é–‹çŠ¶æ…‹ç¢ºèªæ¸ˆã¿ï¼‰');
      }
      
      // 8. ğŸ”§ æ–°ãƒ«ãƒ¼ãƒ«: AIåˆ¤å®šçµæœãŒå­˜åœ¨ã™ã‚‹ãŒsetupStatus='pending'ã®å ´åˆï¼ˆAIå®Œäº†å¾Œã®çŠ¶æ…‹æ›´æ–°æ¼ã‚Œï¼‰
      if (currentStatus.sheetDetails && currentStatus.sheetDetails.guessedConfig && 
          currentStatus.sheetDetails.guessedConfig.opinionHeader && 
          config.setupStatus === 'pending') {
        issues.push('AIåˆ—åˆ¤å®šå®Œäº†æ¸ˆã¿ã ãŒ setupStatus=pending');
        config.setupStatus = 'completed';
        config.formCreated = true; // AIåˆ¤å®šå®Œäº†æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚‚æº–å‚™å®Œäº†ã¨ã¿ãªã™
        fixes.push('AIåˆ¤å®šå®Œäº†ã«åŸºã¥ã„ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã‚’å®Œäº†ã«æ›´æ–°');
      }
      
      
      if (fixes.length === 0) {
        diagnosticInProgress = false;
        resolve({
          success: true,
          message: 'âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ã«å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ',
          issues: [],
          fixes: []
        });
        return;
      }
      
      // ä¿®æ­£ã•ã‚ŒãŸè¨­å®šã‚’ä¿å­˜
      console.log('ğŸ’¾ ä¿®æ­£ã•ã‚ŒãŸè¨­å®šã‚’ä¿å­˜ä¸­...', config);

        runGasWithUserId('syncConfigurationState', 'è¨­å®šä¿®å¾©ä¸­...', config, 'repair')
        .then(saveResult => {
          if (saveResult && saveResult.success) {
            
            // UIçŠ¶æ…‹ã®æ›´æ–°
            if (typeof loadSystemStatus === 'function') {
              loadSystemStatus();
            }
            
            diagnosticInProgress = false;
            resolve({
              success: true,
              message: 'ğŸ”§ ' + fixes.length + 'ä»¶ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å•é¡Œã‚’ä¿®å¾©ã—ã¾ã—ãŸ',
              issues,
              fixes
            });
          } else {
            diagnosticInProgress = false;
            reject(new Error((saveResult && saveResult.message) || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'));
          }
        })
        .catch(saveError => {
          diagnosticInProgress = false;
          reject(new Error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + saveError.message));
        });
        
    } catch (error) {
      console.error('âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ä¿®å¾©ã§ã‚¨ãƒ©ãƒ¼:', error);
      diagnosticInProgress = false;
      reject(error);
    }
  });
}

// Note: runSetupRepair function has been replaced by initializeUserSettingsWithUI

// =============================================================================
// SAVE AND PUBLISH OPERATIONS
// =============================================================================

// Save configuration and publish board - æœ€é©åŒ–ç‰ˆï¼ˆé€²æ—è¡¨ç¤ºä»˜ãï¼‰
function saveAndPublish() {
  if (!validateConfig()) {
    showMessage('å¿…é ˆé …ç›®ï¼ˆå›ç­”ãƒ‡ãƒ¼ã‚¿åˆ—ï¼‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  // é€²æ—è¡¨ç¤ºé–‹å§‹ - æ—¢å­˜ã®isSaveInProgressãƒ•ãƒ©ã‚°ã‚’æ´»ç”¨
  if (isSaveInProgress) {
    showMessage('âš ï¸ ä»–ã®ä¿å­˜å‡¦ç†ãŒå®Ÿè¡Œä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  // ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã¯ã€å…¬é–‹å‰ã«å®Ÿéš›ã®å…¬é–‹æƒ…å ±ã‚’æ›´æ–°
  if (window._draftModeActive) {
    console.log('ğŸ“ ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰å…¬é–‹ã¸ç§»è¡Œä¸­...');
    
    // ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
    window._draftModeActive = false;
    
    // ãƒ‰ãƒ©ãƒ•ãƒˆã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
    if (window.HistoryManager && typeof window.HistoryManager._hideDraftModeIndicator === 'function') {
      window.HistoryManager._hideDraftModeIndicator();
    }
    
    console.log('âœ… ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚å…¬é–‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚');
  }
  
  // é€²æ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿è¡¨ç¤º
  showMessage('ğŸ”„ è¨­å®šã‚’ä¿å­˜ã—ã¦ã„ã¾ã™...ï¼ˆæ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰', 'info');
  
  // UIã‹ã‚‰configã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
  const config = buildConfigObject();
  
  // è‡ªå‹•åœæ­¢è¨­å®šã‚’æº–å‚™
  const autoStopSettings = {
    enabled: true,
    minutes: 360 // 6æ™‚é–“ = 360åˆ†ï¼ˆconfig.gsã¨çµ±ä¸€ï¼‰
  };
  
  // Check for privacy-sensitive settings and show warning if enabled
  const showNamesEl = document.getElementById('show-names');
  const showNames = (showNamesEl && showNamesEl.checked) || false;
  const showCountsEl = document.getElementById('show-counts');
  const showCounts = (showCountsEl && showCountsEl.checked) || false;
  
  if (showNames || showCounts) {
    // Show privacy warning modal first
    if (window.sharedModals) {
      const privacySettings = [];
      if (showNames) privacySettings.push('åå‰è¡¨ç¤º');
      if (showCounts) privacySettings.push('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°è¡¨ç¤º');
      
      console.log('âš ï¸ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è­¦å‘Š: ' + privacySettings.join('ãƒ»') + 'ãŒæœ‰åŠ¹ã§ã™');
      
      window.sharedModals.showPrivacyWarning(
        // onConfirm - show publish modal after privacy confirmation
        () => {
          showPublishModalAfterChecks(config, autoStopSettings);
        },
        // onCancel - user wants to review settings
        () => {
          console.log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šã®è¦‹ç›´ã—ã‚’é¸æŠ');
          showMessage('è¨­å®šã‚’è¦‹ç›´ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'info');
        }
      );
      return;
    }
  }
  
  // If no privacy concerns, show publish modal directly
  showPublishModalAfterChecks(config, autoStopSettings);
}

// å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒã‚§ãƒƒã‚¯å¾Œï¼‰
function showPublishModalAfterChecks(config, autoStopSettings) {
  if (window.sharedModals && typeof window.sharedModals.showPublish === 'function') {
    window.sharedModals.showPublish(
      // å…¬é–‹å®Ÿè¡Œæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      () => {
        console.log('ğŸ“¤ å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å…¬é–‹ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        proceedWithSaveAndPublish(config);
      },
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      () => {
        console.log('âŒ å…¬é–‹ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      },
      // è‡ªå‹•åœæ­¢è¨­å®š
      autoStopSettings
    );
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ç›´æ¥å®Ÿè¡Œ
    console.warn('âš ï¸ å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ç›´æ¥å®Ÿè¡Œã—ã¾ã™ã€‚');
    proceedWithSaveAndPublish(config);
  }
}

// Proceed with the actual save and publish operation
function proceedWithSaveAndPublish(config) {

  // Set save protection flags to prevent interference
  isSaveInProgress = true;
  freshSaveTimestamp = Date.now();
  window.freshSaveTimestamp = freshSaveTimestamp;
  
  runGasWithUserId('saveAndPublish', 'è¨­å®šã‚’ä¿å­˜ã—ã€ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™...', selectedSheet, config)
    .then(function(result) {
      isSaveInProgress = false;
      
      // Check if result has data (from integrated API) or legacy success status
      if (result && (result.userInfo || result.status === 'success')) {
        showMessage('âœ… è¨­å®šãŒä¿å­˜ã•ã‚Œã€ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
        
        // å±¥æ­´ã«ä¿å­˜ï¼ˆå…¬é–‹æ™‚ï¼‰- ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ
        if (typeof addToSimpleHistory === 'function') {
          const questionText = config.opinionHeader || config.opinionColumn || 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå•é¡Œæ–‡';
          const historyItem = {
            questionText: questionText,
            displayMode: document.getElementById('show-names')?.checked ? 'NAMED' : 'ANONYMOUS',
            configData: result.userInfo?.configJson ? JSON.parse(result.userInfo.configJson) : {}
          };
          addToSimpleHistory(historyItem);
        }
        
        // ãƒœãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã«å³åº§æ›´æ–°ã‚’é€šçŸ¥
        try {
          // ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆã‚ã‚Œã°ï¼‰
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'BOARD_PUBLISHED',
              sheetName: selectedSheet,
              timestamp: Date.now()
            }, '*');
            logInfo('ãƒœãƒ¼ãƒ‰å…¬é–‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€ä¿¡');
          }
          
          // åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä»–ã®ã‚¿ãƒ–ã«ã‚‚é€šçŸ¥
          if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('board-updates');
            channel.postMessage({
              type: 'BOARD_PUBLISHED',
              sheetName: selectedSheet,
              timestamp: Date.now()
            });
            channel.close();
            logInfo('ãƒœãƒ¼ãƒ‰å…¬é–‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’BroadcastChannelã§é€ä¿¡');
          }
        } catch (broadcastError) {
          console.warn('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°é€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼:', broadcastError);
        }
        
        // 6æ™‚é–“è‡ªå‹•åœæ­¢ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        setTimeout(() => {
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ç¢ºå®Ÿã«éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
          if (window.unifiedLoadingManager) {
            window.unifiedLoadingManager.setLoading(false);
          }
          
          // å…¬é–‹å®Œäº†ç¢ºèªã¨URLç”Ÿæˆå¾Œã«è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          setTimeout(() => {
            // å…¬é–‹çŠ¶æ…‹ã¨URLç”Ÿæˆã®ç¢ºèª
            if (result && (result.publishedAt || result.userInfo)) {
              const publishResult = {
                publishedAt: result.publishedAt || new Date().toISOString(),
                autoStopMinutes: result.autoStopMinutes || 360,
                boardUrl: result.boardUrl || result.viewUrl || '',
                status: 'success',
                ...result
              };
              
              console.log('ğŸ“Š é€šå¸¸å…¬é–‹å®Œäº†ãƒ‡ãƒ¼ã‚¿ç¢ºèªå®Œäº†');
              
              if (window.sharedModals && typeof window.sharedModals.showAutoStopConfirmation === 'function') {
                window.sharedModals.showAutoStopConfirmation(publishResult);
              } else {
                console.warn('âš ï¸ è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              }
            } else {
              console.warn('âš ï¸ é€šå¸¸å…¬é–‹çµæœãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã®ãŸã‚ã€è‡ªå‹•åœæ­¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™:', result);
            }
          }, 800); // URLç”Ÿæˆå¾…ã¡ã®ãŸã‚å°‘ã—é•·ã‚ã«è¨­å®š
        }, 2000); // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¾Œã«è¡¨ç¤º
        
        // Use fresh data from save response if available
        if (result.userInfo && result._meta) {
          logInfo('Using fresh data from save response');
          updateUIWithNewStatus(result);
        } else {
          // Only force refresh if no fresh data available
          logInfo('No fresh data in response, forcing refresh');
          loadStatus(true).then(() => {
            // ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œã‚’æ›´æ–°
            const currentStep = currentStatus && currentStatus.setupStep ? currentStatus.setupStep : 1;
            updateStepIndicators(currentStep);
            manageSectionStates(currentStep);
          });
        }
      } else {
        logError('Save failed:', result);
        showMessage(result.message || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        isSaveInProgress = false;
      }
    })
    .catch(function(error) {
      logError('saveAndPublish error:', error);
      isSaveInProgress = false;
      
      // çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆã‚¨ãƒ©ãƒ¼å¾Œï¼‰
      cacheManager.clearAllFrontendCaches().catch(clearError => {
        console.warn('Cache clear after error failed:', clearError);
      });
      
      loadStatus(true).then(() => {
        // ã‚¨ãƒ©ãƒ¼å¾Œã‚‚ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œã‚’æ›´æ–°
        const currentStep = currentStatus && currentStatus.setupStep ? currentStatus.setupStep : 1;
        updateStepIndicators(currentStep);
        manageSectionStates(currentStep);
      });
      handleError(error, 'saveAndPublish', 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸã€‚');
    });
}

/**
 * å…¬é–‹åœæ­¢æ™‚ã®å¼·åŒ–ã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥é–¢é€£ã®ã‚¢ã‚¯ã‚»ã‚¹å•é¡Œã‚’é˜²ããŸã‚ã€ã‚ã‚‰ã‚†ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
 */
async function clearAllCachesForUnpublish() {
  console.log('ğŸ§¹ å…¬é–‹åœæ­¢æ™‚ã®åŒ…æ‹¬çš„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†ã‚’é–‹å§‹');
  
  try {
    // 1. æ—¢å­˜ã®å®‰å®šã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ–¹å¼
    // çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
      window.unifiedCache.clear();
    }
    
    // GASæœ€é©åŒ–ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    if (window.gasOptimizer && typeof window.gasOptimizer.clearCache === 'function') {
      window.gasOptimizer.clearCache();
    }
    
    // SharedUtilitiesã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    if (window.sharedUtilities && window.sharedUtilities.cache && typeof window.sharedUtilities.cache.clear === 'function') {
      window.sharedUtilities.cache.clear();
    }
    
    // DOMè¦ç´ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    if (window.sharedUtilities && window.sharedUtilities.dom && typeof window.sharedUtilities.dom.clearElementCache === 'function') {
      window.sharedUtilities.dom.clearElementCache();
    }
    
    // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆStudyQuesté–¢é€£ã®ã¿ã€å±¥æ­´ä¿è­·ï¼‰
    try {
      const localStorageKeys = Object.keys(localStorage);
      const historyKeys = ['answerBoardHistory', 'adminPanelHistory']; // å±¥æ­´ä¿è­·ã‚­ãƒ¼
      
      const studyQuestKeys = localStorageKeys.filter(key => 
        (key.includes('studyquest') || 
         key.includes('board') || 
         key.includes('sheet') ||
         key.includes('admin') ||
         key.includes('publication') ||
         key.includes('answer')) &&
        !historyKeys.includes(key) // å±¥æ­´ã‚­ãƒ¼ã¯é™¤å¤–
      );
      
      studyQuestKeys.forEach(key => {
        localStorage.removeItem(key);
      });
      
      console.log('âœ… Cache cleared while preserving history keys:', historyKeys);
      
    } catch (e) {
      console.warn('âš ï¸ localStorage clear warning:', e);
    }
    
    // 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚¯ãƒªã‚¢
    try {
      if (window.sessionStorage) {
        const sessionKeys = Object.keys(sessionStorage);
        const studyQuestSessionKeys = sessionKeys.filter(key => 
          key.includes('studyquest') || 
          key.includes('board') || 
          key.includes('admin')
        );
        
        studyQuestSessionKeys.forEach(key => {
          sessionStorage.removeItem(key);
        });
        
      }
    } catch (e) {
      console.warn('âš ï¸ sessionStorage clear warning:', e);
    }
    
    // 4. BroadcastChannelé€šçŸ¥ï¼ˆä»–ã®ã‚¿ãƒ–ã«å…¬é–‹åœæ­¢ã‚’é€šçŸ¥ï¼‰
    try {
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('board-updates');
        channel.postMessage({
          type: 'BOARD_UNPUBLISHED',
          timestamp: Date.now(),
          userId: window.userId || 'unknown'
        });
        channel.close();
      }
    } catch (e) {
      console.warn('âš ï¸ BroadcastChannel notification warning:', e);
    }
    
    // 5. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®æ¡ä»¶ä»˜ãã‚¯ãƒªã‚¢ï¼ˆå…¬é–‹åœæ­¢æ™‚ã®ã¿ï¼‰
    try {
      console.log('ğŸ”§ Conditional global variable clear for unpublish');
      
      // currentSpreadsheetUrlã®ã‚¯ãƒªã‚¢ï¼ˆå…¬é–‹åœæ­¢æ™‚ã®ã¿ï¼‰
      if (typeof currentSpreadsheetUrl !== 'undefined') {
        const oldUrl = currentSpreadsheetUrl;
        currentSpreadsheetUrl = '';
        console.log('âœ… currentSpreadsheetUrl cleared for unpublish:', oldUrl);
      }
      
      // window.currentStatusã®ã‚¯ãƒªã‚¢ï¼ˆå…¬é–‹åœæ­¢æ™‚ã®ã¿ï¼‰
      if (window.currentStatus) {
        window.currentStatus = null;
        console.log('âœ… window.currentStatus cleared for unpublish');
      }
      
      // ãã®ä»–ã®URLé–¢é€£ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ã‚¯ãƒªã‚¢
      if (typeof webAppUrl !== 'undefined') {
        webAppUrl = '';
        console.log('âœ… webAppUrl cleared');
      }
      
      if (typeof currentActiveSheet !== 'undefined') {
        currentActiveSheet = '';
        console.log('âœ… currentActiveSheet cleared');
      }
      
    } catch (e) {
      console.warn('âš ï¸ Global variables clear warning:', e);
    }
    
    // 6. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã®ãŸã‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
    try {
      localStorage.setItem('lastUnpublishTime', Date.now().toString());
      localStorage.setItem('cacheInvalidationToken', Math.random().toString(36));
    } catch (e) {
      console.warn('âš ï¸ Cache invalidation token update warning:', e);
    }
    
    
  } catch (error) {
    console.error('âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã¯ç¶™ç¶š
  }
}

// Unpublish board
function unpublishBoard() {
    return runGasWithUserId('unpublishBoard', 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ä¸­...')
      .then(async function(response) {
        logDebug('å…¬é–‹åœæ­¢ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);

        // æœ€é©åŒ–ã•ã‚ŒãŸçŠ¶æ…‹ã‚¯ãƒªã‚¢é †åºï¼š
        // 1. ã¾ãšã‚µãƒ¼ãƒãƒ¼å´ã®å…¬é–‹åœæ­¢å‡¦ç†ãŒæˆåŠŸã—ãŸã“ã¨ã‚’ç¢ºèª
        console.log('âœ… ã‚µãƒ¼ãƒãƒ¼å´å…¬é–‹åœæ­¢å®Œäº†ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¯ãƒªã‚¢é–‹å§‹');
        
        // 2. å¼·åŒ–ã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†ï¼ˆéåŒæœŸã§ç¢ºå®Ÿã«å®Ÿè¡Œï¼‰
        try {
          await clearAllCachesForUnpublish();
          console.log('âœ… åŒ…æ‹¬çš„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†');
        } catch (clearError) {
          console.warn('âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼:', clearError);
          // ã‚¯ãƒªã‚¢å¤±æ•—ã§ã‚‚å‡¦ç†ã¯ç¶™ç¶š
        }

        // 3. UIçŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆï¼ˆã‚«ãƒ©ãƒ é¸æŠç­‰ï¼‰
        try {
          resetColumnSelections();
          console.log('âœ… ã‚«ãƒ©ãƒ é¸æŠãƒªã‚»ãƒƒãƒˆå®Œäº†');
        } catch (resetError) {
          console.warn('âš ï¸ ã‚«ãƒ©ãƒ é¸æŠãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', resetError);
        }

        // 4. çŸ­ã„é…å»¶ã§DOMçŠ¶æ…‹ã‚’å®‰å®šåŒ–
        await new Promise(resolve => setTimeout(resolve, 100));

        // å…¬é–‹åœæ­¢å‡¦ç†ãŒæˆåŠŸã—ãŸã“ã¨ã‚’è¿”ã™
        return Promise.resolve(response);
      })
      .catch(function(error) {
        handleError(error, 'unpublishBoard', 'ãƒœãƒ¼ãƒ‰ã®å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼ã—ã¦å‘¼ã³å‡ºã—å…ƒã§ã‚­ãƒ£ãƒƒãƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        return Promise.reject(error);
      });
  }

  // ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ä¿å­˜é–¢æ•°ï¼ˆå…¬é–‹æ™‚ï¼‰
  async function saveHistoryOnPublish(publishResponse, config) {
    try {
      const userInfo = publishResponse.userInfo || {};
      
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆæ—¥ã‚’å–å¾—
      let createdDate = null;
      if (userInfo.spreadsheetId) {
        try {
          const createdDateResponse = await runGasWithUserId('getSpreadsheetCreatedDateAPI', false);
          if (createdDateResponse && createdDateResponse.status === 'success') {
            createdDate = createdDateResponse.createdDate;
          }
        } catch (error) {
          console.warn('âš ï¸ ä½œæˆæ—¥å–å¾—å¤±æ•—:', error);
        }
      }
      
      // ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªä½œæˆ
      await createSimpleHistoryEntry(publishResponse, config, userInfo, createdDate);
      
      logDebug('âœ… ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ä¿å­˜å®Œäº†ï¼ˆå…¬é–‹æ™‚ï¼‰');
    } catch (error) {
      logWarn('âš ï¸ å…¬é–‹æ™‚ã®å±¥æ­´ä¿å­˜ã«å¤±æ•—:', error);
    }
  }
  
  /**
   * ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªä½œæˆ
   * @param {Object} publishResponse - å…¬é–‹APIå¿œç­”
   * @param {Object} config - ãƒ•ã‚©ãƒ¼ãƒ è¨­å®š
   * @param {Object} userInfo - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
   * @param {string} createdDate - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆæ—¥
   */
  async function createSimpleHistoryEntry(publishResponse, config, userInfo, createdDate) {
    try {
      // ç¾åœ¨ã®UIçŠ¶æ…‹ã‹ã‚‰è¨­å®šå–å¾—ï¼ˆshowNamesãƒ™ãƒ¼ã‚¹ï¼‰
      const getShowNames = () => {
        const showNamesCheckbox = document.getElementById('show-names');
        return (showNamesCheckbox && showNamesCheckbox.checked) || false;
      };
      
      const getShowCounts = () => {
        const showCountsCheckbox = document.getElementById('show-counts');
        return (showCountsCheckbox && showCountsCheckbox.checked) || false;
      };
      
      // å•é¡Œæ–‡ã‚’è¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
      const questionText = config.opinionHeader ||
                          config.opinionColumn ||
                          userInfo.customFormInfo?.mainQuestion ||
                          'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå•é¡Œæ–‡';
      
      // ã‚·ãƒ³ãƒ—ãƒ«ãªå±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ æ§‹é€ 
      // å±¥æ­´ä¿å­˜å‰ã®è©³ç´°ãƒ­ã‚°
      console.log('ğŸ“ Creating history item with:', {
        questionText: questionText,
        selectedSheet: selectedSheet,
        activeSheetName: publishResponse.activeSheetName,
        spreadsheetId: userInfo.spreadsheetId,
        finalSheetName: publishResponse.activeSheetName || selectedSheet || ''
      });
      
      const historyItem = {
        id: generateHistoryId(),
        createdDate: createdDate,
        publishedAt: publishResponse.publishedAt || new Date().toISOString(),
        questionText: questionText,
        setupType: getSetupType(),
        
        // å¾©å…ƒç”¨ã®æœ€å°ãƒ‡ãƒ¼ã‚¿ï¼ˆshowNames/showCountsãƒ™ãƒ¼ã‚¹ï¼‰
        opinionHeader: config.opinionHeader || '',
        nameHeader: config.nameHeader || 'åå‰',
        showNames: getShowNames(),      // UIçŠ¶æ…‹ã‚’ç›´æ¥ä¿å­˜
        showCounts: getShowCounts(),    // UIçŠ¶æ…‹ã‚’ç›´æ¥ä¿å­˜
        
        // å¾©å…ƒç”¨ã®ã‚·ãƒ¼ãƒˆæƒ…å ±
        sheetName: publishResponse.activeSheetName || selectedSheet || '',
        spreadsheetId: userInfo.spreadsheetId || ''
      };
      
      // å±¥æ­´ã«è¿½åŠ ï¼ˆ5ä»¶åˆ¶é™ï¼‰
      addToSimpleHistory(historyItem);
      
      console.log('âœ… Simple history entry created:', historyItem.questionText);
      
    } catch (error) {
      console.error('âŒ Simple history entry creation failed:', error);
    }
  }
  
  /**
   * ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ã«è¿½åŠ ï¼ˆ5ä»¶åˆ¶é™ï¼‰
   * @param {Object} newItem - æ–°ã—ã„å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ 
   */
  function addToSimpleHistory(newItem) {
    try {
      if (window.HistoryManager) {
        // Use new unified HistoryManager
        const success = window.HistoryManager.add(newItem);
        if (success) {
          console.log('âœ… History saved using HistoryManager');
          // Update UI table
          window.HistoryManager.renderTable();
        } else {
          console.warn('âš ï¸ Failed to save history using HistoryManager');
        }
      } else {
        // Fallback to legacy method
        console.warn('âš ï¸ HistoryManager not available, using legacy method');
        const history = getHistoryFromStorage();
        
        // å…ˆé ­ã«è¿½åŠ 
        history.unshift(newItem);
        
        // 5ä»¶ã«åˆ¶é™
        const limitedHistory = history.slice(0, 5);
        
        // ä¿å­˜
        saveHistoryToStorage(limitedHistory);
        
        console.log('âœ… History saved with ' + limitedHistory.length + ' items (max 5)');
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        if (typeof loadSimpleHistoryTable === 'function') {
          loadSimpleHistoryTable();
        }
      }
      
    } catch (error) {
      console.error('âŒ Failed to add to simple history:', error);
    }
  }
  
  /**
   * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã®å–å¾—
   * @returns {string} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—
   */
  function getSetupType() {
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‹ã‚‰åˆ¤å®š
    if (sessionStorage.getItem('quickStartActive')) {
      return 'quickstart';
    }
    return 'custom';
  }
  
  /**
   * å±¥æ­´IDç”Ÿæˆ
   * @returns {string} ä¸€æ„ã®ID
   */
  function generateHistoryId() {
    return 'history_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }
  
  // å¤ã„è¤‡é›‘ãªcreateConsolidatedHistoryEntryé–¢æ•°ã¯å‰Šé™¤æ¸ˆã¿
  
  /**
   * Create history entry for QuickStart completion
   * @param {Object} quickStartResult - QuickStart completion result
   */
  function createQuickStartHistoryEntry(quickStartResult) {
    try {
      logDebug('Creating QuickStart history entry:', quickStartResult);
      
      // Extract question text from QuickStart config with better fallback
      const questionText = (quickStartResult.config && quickStartResult.config.opinionHeader) ||
                          (quickStartResult.config && quickStartResult.config.opinionColumn) ||
                          (quickStartResult.config && quickStartResult.config.reasonHeader) ||
                          (quickStartResult.config && quickStartResult.config.nameHeader) ||
                          'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå•é¡Œæ–‡';
      
      console.log('ğŸ“ QuickStart question text extracted:', questionText);
      
      // Use completion time as both creation and publication time for QuickStart
      const completedAt = quickStartResult.completedAt || new Date().toISOString();
      const publishedAt = (quickStartResult.publishResult && quickStartResult.publishResult.publishedAt) || completedAt;
      
      // Create simplified QuickStart history entry
      const historyItem = {
        id: generateHistoryId(),
        createdDate: completedAt, // QuickStart creates and publishes simultaneously
        publishedAt: publishedAt,
        questionText: questionText,
        setupType: 'quickstart',
        opinionHeader: (quickStartResult.config && quickStartResult.config.opinionHeader) || '',
        nameHeader: (quickStartResult.config && quickStartResult.config.nameHeader) || 'åå‰',
        showNames: false,   // QuickStartãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: åå‰è¡¨ç¤ºOFFï¼ˆåŒ¿åï¼‰
        showCounts: false,  // QuickStartãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°è¡¨ç¤ºOFF
        sheetName: quickStartResult.sheetName || quickStartResult.publishedSheetName || '',
        spreadsheetId: quickStartResult.spreadsheetId || ''
      };
      
      addToSimpleHistory(historyItem);
      
      // Update UI - handled by addToSimpleHistory function
      // No need for additional UI update call here
      
      logDebug('QuickStart simple history entry created successfully:', {
        id: historyItem.id,
        questionText: historyItem.questionText,
        createdDate: historyItem.createdDate,
        publishedAt: historyItem.publishedAt,
        setupType: historyItem.setupType
      });
      
    } catch (error) {
      logError('Failed to create QuickStart history entry:', error);
    }
  }

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®šã™ã‚‹è£œåŠ©é–¢æ•°
function determineSetupType(config, userInfo) {
  if (userInfo.customFormInfo) {
    return 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—';
  } else if (config.isQuickStart || config.setupType === 'quickstart') {
    return 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ';
  } else if (config.isExternalResource) {
    return 'å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹';
  } else {
    return 'unknown';
  }
}

// Reset column selection dropdowns to default state
function resetColumnSelections() {
  
  const columnSelects = [
    'opinion-column-select',
    'name-column-select', 
    'reason-column-select',
    'class-column-select',
    'timestamp-column-select'
  ];
  
  columnSelects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.value = ''; // Reset to empty value
    }
  });
  
  // Also reset any display checkboxes
  const checkboxes = ['show-names', 'show-counts'];
  checkboxes.forEach(checkboxId => {
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) {
      checkbox.checked = false;
    }
  });
}

// =============================================================================
// FORM MANAGEMENT
// =============================================================================

// Load saved class choices
function loadSavedClassChoices() {
    runGasWithUserId('getSavedClassChoices', 'ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’èª­ã¿è¾¼ã¿ä¸­...')
        .then(function(result) {
            if (result.status === 'success' && result.classChoices) {
                const classChoicesTextarea = document.getElementById('class-choices');
                if (classChoicesTextarea) {
                    classChoicesTextarea.value = result.classChoices.join('\n');
                }
            }
        })
        .catch(function(error) {
            console.warn('ä¿å­˜ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error.message);
            showMessage('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        });
}

// Create form with custom configuration
/**
 * QuickStartã¨åŒã˜å½¢å¼ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã€‚
 * @returns {string} ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã€‚
 */
function generateQuickstartFormTitle() {
  const now = new Date();
  const formatter = new Intl.DateTimeFormat('ja-JP', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
    timeZone: 'Asia/Tokyo'
  });
  const formatted = formatter.format(now);
  const [datePart, timePart] = formatted.split(' ');
  const [year, month, day] = datePart.split('/');
  return 'ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰ ' + year + 'å¹´' + month + 'æœˆ' + day + 'æ—¥ ' + timePart;
}

function createFormWithConfig() {
  const questionTextarea = document.getElementById('custom-main-question');
  const questionTypeSelect = document.getElementById('main-question-type');
  const questionChoicesTextarea = document.getElementById('main-question-choices');
  const classChoicesTextarea = document.getElementById('class-choices');
  const includeOthersOption = document.getElementById('include-others-option').checked;
  const enableClassSelection = document.getElementById('enable-class-selection').checked;
  
  if (!questionTextarea || !questionTypeSelect) {
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã«å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  const question = questionTextarea.value.trim();
  const questionType = questionTypeSelect.value; // å›ç­”æ–¹æ³•ã‚’å–å¾—
  const questionChoicesText = questionChoicesTextarea ? questionChoicesTextarea.value.trim() : '';
  const classChoicesText = enableClassSelection && classChoicesTextarea ? classChoicesTextarea.value.trim() : '';
  
  if (!question) {
    showMessage('å•é¡Œæ–‡ã¯å¿…é ˆã§ã™ã€‚', 'warning');
    return;
  }
  
  // é¸æŠè‚¢ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯é¸æŠè‚¢ãŒå¿…è¦
  if ((questionType === 'choice' || questionType === 'multiple') && !questionChoicesText) {
    showMessage('é¸æŠè‚¢ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯é¸æŠè‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  // é¸æŠè‚¢ã‚’é…åˆ—ã«å¤‰æ›
  const questionChoices = questionChoicesText ? 
    questionChoicesText.split('\n').map(choice => choice.trim()).filter(choice => choice.length > 0) : [];
  
  // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’é…åˆ—ã«å¤‰æ›  
  const classChoices = classChoicesText ? 
    classChoicesText.split('\n').map(choice => choice.trim()).filter(choice => choice.length > 0) : [];
  
  const config = {
    mainQuestion: question,
    responseType: questionType, // å›ç­”æ–¹æ³•ã‚’è¿½åŠ 
    questionChoices: questionChoices, // ãƒ¡ã‚¤ãƒ³è³ªå•ã®é¸æŠè‚¢
    classChoices: classChoices,
    includeOthers: includeOthersOption,
    enableClass: enableClassSelection && classChoices.length > 0,
    formTitle: generateQuickstartFormTitle(),
  };
  
  console.log('ğŸ“‹ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šæº–å‚™å®Œäº†');
  
  hideFormConfigModal();
  
  // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨é€²æ—è¡¨ç¤ºã‚’é–‹å§‹
  // Use the new unified custom setup system
  console.log('ğŸ¨ çµ±åˆã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹');
  
  // userEmailã¯ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‹ã‚‰å–å¾—
  if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.adminEmail) {
    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }
  
  // Call the new unified custom setup handler - this replaces the old createCustomFormUI flow
  handleCustomSetup(config);
  
  // ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
  saveClassChoicesToDatabase(classChoices);
}


// Save class choices to database
function saveClassChoicesToDatabase(classChoices) {
    runGasWithUserId('saveClassChoices', classChoices)
        .catch(function(error) {
            console.warn('ã‚¯ãƒ©ã‚¹é¸æŠè‚¢ã®ä¿å­˜ã«å¤±æ•—:', error.message);
        });
}

// =============================================================================
// RESOURCE MANAGEMENT
// =============================================================================

// Add spreadsheet resource
function addResource() {
  const urlInput = document.getElementById('resource-url-input');
  if (!urlInput) {
    showMessage('URLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
    return;
  }
  
  const url = urlInput.value.trim();
  if (!url) {
    showMessage('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }

  // URLã®ç¨®é¡ã‚’åˆ¤å®šï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã¿å¯¾å¿œï¼‰
  let resourceType = 'spreadsheet';
  let backendFunction = 'addSpreadsheetUrl';
  
  if (!url.includes('docs.google.com/spreadsheets/')) {
    showMessage('Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  const resourceTypeText = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ';

  runGasWithUserId(backendFunction, resourceTypeText + 'ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™...', url)
    .then(function(result) {
      if (result.status === 'success') {
        showMessage(result.message, 'success');
        urlInput.value = ''; // Clear input
        
        // ãƒ‡ãƒã‚¦ãƒ³ã‚¹åˆ¶å¾¡ã«ã‚ˆã‚‹å®‰å…¨ãªçŠ¶æ…‹æ›´æ–°
        if (window.AdminPanel && window.AdminPanel.debounce) {
          window.AdminPanel.debounce.loadStatus(() => loadStatus(true), 200);
        } else {
          loadStatus(true); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        }
      } else {
        showMessage(result.message || (resourceTypeText + 'ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'), 'error');
      }
    })
    .catch(function(error) {
      handleError(error, 'addResource', resourceTypeText + 'ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    });
}

// =============================================================================
// EXTERNAL LINKS AND NAVIGATION
// =============================================================================

// Copy board URL to clipboard
function copyBoardUrl(buttonElement) {
  const urlInput = document.getElementById('board-url');
  if (!urlInput) {
    console.error('board-url input element not found.');
    return;
  }

  const urlToCopy = urlInput.value;

  if (!urlToCopy) {
    showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
    return;
  }

  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(urlToCopy).then(() => {
        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>ã‚³ãƒ”ãƒ¼å®Œäº†!';
        buttonElement.disabled = true;
        setTimeout(() => {
          buttonElement.innerHTML = originalText;
          buttonElement.disabled = false;
        }, 2000);
      }).catch((error) => {
        console.error('Clipboard API failed:', error);
        // Fallback to manual copy message
        const messageElement = document.createElement('span');
        messageElement.textContent = ' (æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)';
        messageElement.style.color = 'orange';
        buttonElement.parentNode.insertBefore(messageElement, buttonElement.nextSibling);
        setTimeout(() => messageElement.remove(), SYSTEM_CONSTANTS.TIMEOUTS.ERROR_DISPLAY_DURATION);
      });
    } else {
      // Fallback for browsers that don't support Clipboard API
      urlInput.select();
      urlInput.setSelectionRange(0, 99999); // For mobile devices
      document.execCommand('copy');
      showMessage('URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success'); // Fallback uses showMessage
    }
  } catch (err) {
    console.error('copyBoardUrl error:', err);
    showMessage('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'warning'); // Fallback uses showMessage
  }
}

// Copy form URL to clipboard
function copyFormUrl() {
  const urlInput = document.getElementById('form-url-input');
  if (urlInput && urlInput.value) {
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      // Try modern clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(urlInput.value).then(() => {
          showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
        }).catch(() => {
          // Fallback to execCommand
          document.execCommand('copy');
          showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
        });
      } else {
        document.execCommand('copy');
        showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼', 'success');
      }
    } catch (err) {
      showMessage('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'warning');
    }
  } else {
    showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
  }
}

// Open database spreadsheet - æ”¹å–„ç‰ˆï¼ˆè¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰URLå–å¾—ï¼‰
function openDatabaseSpreadsheet() {
  console.log('ğŸ“Š openDatabaseSpreadsheet: URLå–å¾—ã‚’é–‹å§‹');
  
  // è¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’å–å¾—
  let spreadsheetUrl = null;
  
  // 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰
  if (currentSpreadsheetUrl) {
    spreadsheetUrl = currentSpreadsheetUrl;
    console.log('âœ… URL from global variable:', spreadsheetUrl);
  }
  
  // 2. ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  if (!spreadsheetUrl && window.currentStatus && window.currentStatus.userInfo) {
    spreadsheetUrl = window.currentStatus.userInfo.spreadsheetUrl;
    console.log('ğŸ“‹ URL from currentStatus:', spreadsheetUrl || 'none');
  }
  
  // 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰ï¼ˆè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  if (!spreadsheetUrl && window.lastStatusCache && window.lastStatusCache.userInfo) {
    spreadsheetUrl = window.lastStatusCache.userInfo.spreadsheetUrl;
    console.log('ğŸ”„ URL from lastStatusCache:', spreadsheetUrl || 'none');
  }
  
  // 4. getActiveResourceUrlsé–¢æ•°ã‚’ä½¿ç”¨ï¼ˆæœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  if (!spreadsheetUrl && typeof getActiveResourceUrls === 'function') {
    const status = window.currentStatus || window.lastStatusCache;
    if (status) {
      const resourceUrls = getActiveResourceUrls(status);
      spreadsheetUrl = resourceUrls.spreadsheet;
      console.log('ğŸ” URL from getActiveResourceUrls:', spreadsheetUrl || 'none');
    }
  }
  
  // 5. æœ€çµ‚æ‰‹æ®µï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çŠ¶æ…‹å–å¾—
  if (!spreadsheetUrl && typeof loadStatus === 'function') {
    console.log('ğŸ”„ Attempting real-time status fetch as last resort');
    try {
      // åŒæœŸçš„ã«çŠ¶æ…‹ã‚’å–å¾—ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰
      const button = event.target;
      if (button) button.disabled = true;
      
      loadStatus(true).then(status => {
        if (status && status.userInfo && status.userInfo.spreadsheetUrl) {
          console.log('âœ… Got URL from real-time fetch:', status.userInfo.spreadsheetUrl);
          window.open(status.userInfo.spreadsheetUrl, '_blank');
        } else {
          console.warn('âŒ Real-time fetch also failed');
          showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'warning');
        }
        if (button) button.disabled = false;
      }).catch(error => {
        console.error('âŒ Real-time status fetch failed:', error);
        showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'warning');
        if (button) button.disabled = false;
      });
      
      return; // éåŒæœŸå‡¦ç†ãªã®ã§æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
    } catch (error) {
      console.error('âŒ Real-time fetch setup failed:', error);
    }
  }
  
  if (spreadsheetUrl) {
    console.log('ğŸš€ Opening spreadsheet:', spreadsheetUrl);
    window.open(spreadsheetUrl, '_blank');
  } else {
    console.warn('âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'warning');
  }
}

// Open form
function openForm() {
  console.log('ğŸ”— openForm function called');
  
  // ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡è¦–
  const formBtn = document.getElementById('open-form-btn');
  if (formBtn && formBtn.disabled) {
    console.log('âš ï¸ Form button is disabled, ignoring click');
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ã‹ã‚‰ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'warning');
    return;
  }
  
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ URLã‚’å–å¾—ã™ã‚‹å„ªå…ˆé †ä½ã‚’è¨­å®š
  let formUrl = null;
  
  // 1. configJsonã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰
  if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
    try {
      const configJson = typeof currentStatus.userInfo.configJson === 'string' 
        ? JSON.parse(currentStatus.userInfo.configJson) 
        : currentStatus.userInfo.configJson;
      
      if (configJson && configJson.formUrl) {
        formUrl = configJson.formUrl;
        logDebug('âœ… FormURLå–å¾—: configJsonã‹ã‚‰ç›´æ¥å–å¾—æˆåŠŸ');
      }
    } catch (error) {
      logWarn('âš ï¸ configJsonã®è§£æã§ã‚¨ãƒ©ãƒ¼:', error);
    }
  }
  
  // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®formUrlã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  if (!formUrl && currentStatus && currentStatus.userInfo && currentStatus.userInfo.formUrl) {
    formUrl = currentStatus.userInfo.formUrl;
    logDebug('ğŸ“‹ FormURLå–å¾—: userInfo.formUrlã‹ã‚‰å–å¾—');
  }
  
  // 3. ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‹ã‚‰å–å¾—ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
  if (!formUrl && currentStatus && currentStatus.customFormInfo && currentStatus.customFormInfo.formUrl) {
    formUrl = currentStatus.customFormInfo.formUrl;
    logDebug('ğŸ“„ FormURLå–å¾—: customFormInfo.formUrlã‹ã‚‰å–å¾—');
  }
  
  if (formUrl) {
    window.open(formUrl, '_blank');
  } else {
    showMessage('ãƒ•ã‚©ãƒ¼ãƒ ã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'warning');
  }
}

/** @type {string} */
let appSetupUrl = '';

/**
 * ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã®URLã‚’å–å¾—ã—ã¦ä¿å­˜ã™ã‚‹ã€‚
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å„ªå…ˆã—ã¦é«˜é€ŸåŒ–ã€‚
 * @returns {void}
 */
function fetchAppSetupUrl() {
  // localStorage ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å…ˆã«ãƒã‚§ãƒƒã‚¯
  const cachedUrls = localStorage.getItem('userUrls_' + userId);
  const cacheTime = localStorage.getItem('userUrls_time_' + userId);
  const CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  
  if (cachedUrls && cacheTime && (Date.now() - parseInt(cacheTime)) < CACHE_DURATION) {
    try {
      const urls = JSON.parse(cachedUrls);
      if (urls && urls.setupUrl) {
        appSetupUrl = urls.setupUrl;
        // URL cache hit - verbose logging disabled
        return;
      }
    } catch (e) {
      console.warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:', e);
    }
  }
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç„¡åŠ¹ãªå ´åˆã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
  google.script.run
    .withSuccessHandler((urls) => {
      if (urls && urls.setupUrl) {
        appSetupUrl = urls.setupUrl;
        // localStorage ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
        try {
          localStorage.setItem('userUrls_' + userId, JSON.stringify(urls));
          localStorage.setItem('userUrls_time_' + userId, Date.now().toString());
          console.log('âœ… URLs cached to localStorage for future use');
        } catch (e) {
          console.warn('URLã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        }
      } else {
        console.error('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸URLã®å–å¾—ã«å¤±æ•—:', urls);
      }
    })
    .withFailureHandler((error) => {
      console.error('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸URLã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    })
    .generateUserUrls(userId);
}

/**
 * ã‚¢ãƒ—ãƒªè¨­å®šç®¡ç†ãƒšãƒ¼ã‚¸ã‚’é–‹ãã€‚
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨ã—ã¦é«˜é€Ÿé·ç§»ã€‚
 * @returns {void}
 */
function openAppSetupPage() {
  const setupButton = document.querySelector('[onclick="openAppSetupPage()"]');
  const originalText = setupButton ? setupButton.textContent : '';

  if (setupButton) {
    setupButton.disabled = true;
    setupButton.style.opacity = '0.6';
    setupButton.style.pointerEvents = 'none';
    const span = setupButton.querySelector('span');
    if (span) {
      span.textContent = 'ç§»å‹•ä¸­...';
    }
  }

  const restoreButton = () => {
    if (setupButton) {
      setupButton.disabled = false;
      setupButton.style.opacity = '';
      setupButton.style.pointerEvents = '';
      const span = setupButton.querySelector('span');
      if (span) {
        span.textContent = originalText || 'ã‚¢ãƒ—ãƒªè¨­å®šç®¡ç†';
      }
    }
  };

  // URLãŒæœªå–å¾—ã®å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å†è©¦è¡Œ
  if (!appSetupUrl) {
    const cachedUrls = localStorage.getItem('userUrls_' + userId);
    const cacheTime = localStorage.getItem('userUrls_time_' + userId);
    const CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    
    if (cachedUrls && cacheTime && (Date.now() - parseInt(cacheTime)) < CACHE_DURATION) {
      try {
        const urls = JSON.parse(cachedUrls);
        if (urls && urls.setupUrl) {
          appSetupUrl = urls.setupUrl;
          console.log('âœ… Emergency cache recovery successful');
        }
      } catch (e) {
        console.warn('ç·Šæ€¥ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©æ—§å¤±æ•—:', e);
      }
    }
    
    if (!appSetupUrl) {
      restoreButton();
      showMessage('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã®URLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
      return;
    }
  }

  try {
    // Cache busting ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é«˜é€ŸåŒ–
    const urlWithCache = appSetupUrl.includes('?') 
      ? (appSetupUrl + '&t=' + Date.now()) 
      : (appSetupUrl + '?t=' + Date.now());
    window.open(urlWithCache, '_top');
  } catch (error) {
    console.error('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ã®é·ç§»ã«å¤±æ•—:', error);
    restoreButton();
    showMessage('ã‚¢ãƒ—ãƒªè¨­å®šãƒšãƒ¼ã‚¸ã¸ã®ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
  }
}

// ãƒ•ã‚§ãƒ¼ã‚º2æœ€é©åŒ–: ç®¡ç†ãƒ‘ãƒãƒ«åˆæœŸåŒ–ã®ä¸¦åˆ—å‡¦ç†
userIdPromise.then(async () => {
  // ä¸¦åˆ—å®Ÿè¡Œã‚¿ã‚¹ã‚¯ç¾¤
  const initTasks = [];
  
  // Task 1: ã‚¢ãƒ—ãƒªè¨­å®šURLå–å¾—
  const appSetupUrlTask = new Promise((resolve, reject) => {
    fetchAppSetupUrl();
    // fetchAppSetupUrl ã¯å³åº§ã«æˆ»ã‚‹ãŒã€å®Ÿéš›ã®å–å¾—ã¯éåŒæœŸãªã®ã§å°‘ã—å¾…ã¤
    setTimeout(() => resolve('appSetupUrl initiated'), 100);
  });
  initTasks.push(appSetupUrlTask);
  
  // Task 2: çµ±åˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ æ´»ç”¨ï¼‰
  const cacheInitTask = new Promise((resolve) => {
    if (typeof unifiedCacheManager !== 'undefined') {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’ä¸¦åˆ—å®Ÿè¡Œ
      console.log('ğŸ—‘ï¸ Cache cleanup in parallel...');
      resolve('cacheManager ready');
    } else {
      resolve('cacheManager not available');
    }
  });
  initTasks.push(cacheInitTask);
  
  // Task 3: ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è»½é‡ãƒã‚§ãƒƒã‚¯ï¼ˆãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
  const statusCheckTask = new Promise((resolve) => {
    // è»½é‡ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’éåŒæœŸã§å®Ÿè¡Œ
    if (typeof window.sharedUtilities !== 'undefined' && window.sharedUtilities.gas) {
      console.log('ğŸ” Lightweight status check in parallel...');
      setTimeout(() => resolve('status check initiated'), 50);
    } else {
      resolve('status check not available');
    }
  });
  initTasks.push(statusCheckTask);
  
  try {
    const startTime = performance.now();
    const results = await Promise.allSettled(initTasks);
    const totalTime = performance.now() - startTime;
    
    console.log('âš¡ Admin panel parallel initialization completed in ' + Math.round(totalTime) + 'ms:', {
      appSetupUrl: results[0].status,
      cacheInit: results[1].status, 
      statusCheck: results[2].status,
      totalTimeMs: Math.round(totalTime)
    });
    
    // é«˜é€ŸåŒ–åŠ¹æœã®æ¸¬å®š
    if (totalTime < 200) {
      console.log('ğŸš€ Ultra-fast admin panel init: ' + Math.round(totalTime) + 'ms');
    }
    
  } catch (error) {
    console.warn('âš ï¸ Admin panel parallel init warning:', error);
    // æ—¢å­˜ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œã¯ç¶­æŒ
  }
});



// =============================================================================
// POLLING AND REAL-TIME UPDATES
// =============================================================================

// System status polling variables
let lastUserActivity = Date.now();
let currentPollInterval = 5 * 60 * 1000; // é–‹å§‹ã¯5åˆ†é–“éš”
let statusPollTimer = null;

// Fresh save management to prevent interference
let freshSaveTimestamp = 0;
let isSaveInProgress = false;
const FRESH_SAVE_PROTECTION_DURATION = 30000; // 30 seconds

// Make freshSaveTimestamp globally accessible
window.freshSaveTimestamp = freshSaveTimestamp;

// =============================================================================
// CONFIG VERIFICATION MECHANISM
// =============================================================================

/**
 * è¨­å®šä¿å­˜å¾Œã®æ¤œè¨¼æ©Ÿèƒ½
 * ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§è¨­å®šã—ãŸå†…å®¹ãŒæ­£ã—ãä¿å­˜ãƒ»åæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
 */
async function verifyConfigAfterSave(expectedSheetName, expectedConfig) {
  try {
    
    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å†å–å¾—
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const verificationStatus = await runGasWithUserId('getAppConfig', 'è¨­å®šåæ˜ ã‚’ç¢ºèªä¸­...');
    
    if (verificationStatus && verificationStatus.userInfo) {
      const configJson = JSON.parse(verificationStatus.userInfo.configJson || '{}');
      const sheetKey = 'sheet_' + (expectedSheetName || '');
      const savedConfig = configJson[sheetKey];
      
      
      // åŸºæœ¬çš„ãªæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      const isConsistent = (
        savedConfig &&
        savedConfig.guessedConfig &&
        expectedConfig.opinionHeader &&
        savedConfig.guessedConfig.opinionHeader === expectedConfig.opinionHeader
      );
      
      if (isConsistent) {
        return { success: true, message: 'è¨­å®šãŒæ­£å¸¸ã«åæ˜ ã•ã‚Œã¾ã—ãŸ' };
      } else {
        console.warn('âš ï¸ è¨­å®šåæ˜ ç¢ºèª: è¨­å®šã«ä¸æ•´åˆãŒã‚ã‚Šã¾ã™');
        
        // è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œ
        console.log('ğŸ”§ è¨­å®šä¸æ•´åˆã‚’æ¤œå‡º - è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œä¸­...');
        await runGasWithUserId('saveSheetConfig', 'è¨­å®šã‚’ä¿®å¾©ä¸­...',
          currentStatus.userInfo.spreadsheetId, expectedSheetName, expectedConfig, { batchMode: true });
        
        return { success: false, message: 'è¨­å®šä¸æ•´åˆã‚’æ¤œå‡ºã—ã€ä¿®å¾©ã‚’è©¦è¡Œã—ã¾ã—ãŸ', repaired: true };
      }
    }
    
    return { success: false, message: 'è¨­å®šç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' };
    
  } catch (error) {
    console.error('âŒ è¨­å®šåæ˜ ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
    return { success: false, message: 'è¨­å®šç¢ºèªå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message };
  }
}

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªï¼ˆQuickStartãƒ»Custom Setupå…±é€šï¼‰
 * @param {string} flowType - 'quickstart' ã¾ãŸã¯ 'custom'
 * @param {string} sheetName - å¯¾è±¡ã‚·ãƒ¼ãƒˆå
 * @returns {Object} å®Œäº†ç¢ºèªçµæœ
 */
async function verifySetupFlowCompletion(flowType, sheetName) {
  try {
    console.log('ğŸ¯ ' + flowType + 'ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªé–‹å§‹:', sheetName);
    
    // è¨­å®šãŒå®‰å®šã™ã‚‹ã¾ã§å°‘ã—å¾…ã¤
    await new Promise(resolve => setTimeout(resolve, 3000));
    
    const completionStatus = await runGasWithUserId('getAppConfig', 'ãƒ•ãƒ­ãƒ¼å®Œäº†çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');
    
    if (!completionStatus || !completionStatus.userInfo) {
      console.error('âŒ ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèª: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—å¤±æ•—');
      return { success: false, message: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' };
    }
    
    const configJson = JSON.parse(completionStatus.userInfo.configJson || '{}');
    const issues = [];
    
    // å¿…é ˆå®Œäº†çŠ¶æ…‹ã®ç¢ºèª
    
    // 1. setupStatus='completed' ç¢ºèª
    if (configJson.setupStatus !== 'completed') {
      issues.push('âŒ setupStatus: "' + configJson.setupStatus + '" â†’ "completed"ãŒå¿…è¦');
    }
    
    // 2. appPublished=true ç¢ºèª  
    if (configJson.appPublished !== true) {
      issues.push('âŒ appPublished: ' + configJson.appPublished + ' â†’ trueãŒå¿…è¦');
    }
    
    // 3. formCreated=true ç¢ºèª
    if (configJson.formCreated !== true) {
      issues.push('âŒ formCreated: ' + configJson.formCreated + ' â†’ trueãŒå¿…è¦');
    }
    
    // 4. å…¬é–‹æƒ…å ±ã®ç¢ºèªã¨è‡ªå‹•ä¿®æ­£
    if (!configJson.publishedSheetName) {
      issues.push('âŒ publishedSheetNameæœªè¨­å®š â†’ "' + sheetName + '"ãŒå¿…è¦');
    } else if (configJson.publishedSheetName !== sheetName) {
      issues.push('âŒ publishedSheetNameä¸ä¸€è‡´: "' + configJson.publishedSheetName + '" â†’ "' + sheetName + '"');
      
      // è‡ªå‹•ä¿®æ­£æ©Ÿèƒ½: ã‚·ãƒ¼ãƒˆåä¸æ•´åˆã®ä¿®æ­£ã‚’è©¦è¡Œ
      try {
        console.log('ğŸ”§ ã‚·ãƒ¼ãƒˆåä¸æ•´åˆã‚’è‡ªå‹•ä¿®æ­£ã—ã¾ã™:', {
          current: configJson.publishedSheetName,
          expected: sheetName
        });
        
        // è¨­å®šã‚’æ›´æ–°ã—ã¦ã‚·ãƒ¼ãƒˆåã‚’åŒæœŸ
        configJson.publishedSheetName = sheetName;
        
        // ã‚µãƒ¼ãƒãƒ¼ã«ä¿®æ­£ã•ã‚ŒãŸè¨­å®šã‚’ä¿å­˜
        const updateResult = await runGasWithUserId('saveConfigUnified', 'è¨­å®šã‚’è‡ªå‹•ä¿®æ­£ä¸­...', {
          configJson: JSON.stringify(configJson)
        });
        
        if (updateResult.status === 'success') {
          console.log('âœ… ã‚·ãƒ¼ãƒˆåè‡ªå‹•ä¿®æ­£å®Œäº†:', sheetName);
          // issuesé…åˆ—ã‹ã‚‰è©²å½“ã®ã‚¨ãƒ©ãƒ¼ã‚’å‰Šé™¤
          const issueIndex = issues.findIndex(issue => issue.includes('publishedSheetNameä¸ä¸€è‡´'));
          if (issueIndex >= 0) {
            issues.splice(issueIndex, 1);
            console.log('ğŸ¯ ä¿®æ­£ã«ã‚ˆã‚Šæœªå®Œäº†é …ç›®ã‚’è§£æ±ºã—ã¾ã—ãŸ');
          }
        } else {
          console.error('âŒ ã‚·ãƒ¼ãƒˆåè‡ªå‹•ä¿®æ­£å¤±æ•—:', updateResult.message);
        }
      } catch (autoFixError) {
        console.error('âŒ ã‚·ãƒ¼ãƒˆåè‡ªå‹•ä¿®æ­£ã‚¨ãƒ©ãƒ¼:', autoFixError);
      }
    }
    
    // 4. publishedSpreadsheetIdã®ç¢ºèªï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œï¼‰
    if (!configJson.publishedSpreadsheetId) {
      // completionStatusã‹ã‚‰spreadsheetIdã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      if (completionStatus.userInfo && completionStatus.userInfo.spreadsheetId) {
        console.log('ğŸ”§ publishedSpreadsheetIdã‚’userInfo.spreadsheetIdã§è£œå®Œ: ' + completionStatus.userInfo.spreadsheetId);
        // ã“ã®å€¤ã¯å¾Œã§åŒæœŸä¿®æ­£ã§è¨­å®šã•ã‚Œã‚‹
      } else {
        issues.push('âŒ publishedSpreadsheetIdæœªè¨­å®š');
      }
    }
    
    // 5. ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šã®ç¢ºèªï¼ˆã‚ˆã‚ŠæŸ”è»Ÿãªåˆ¤å®šï¼‰
    const sheetKey = 'sheet_' + (sheetName || '');
    const sheetConfig = configJson[sheetKey];
    const hasSheetConfig = !!(sheetConfig && (sheetConfig.guessedConfig || sheetConfig.opinionHeader));
    
    if (!hasSheetConfig) {
      // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ­ãƒ¼ã§è¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯è­¦å‘Šã«æ ¼ä¸‹ã’
      if (flowType === 'custom' && configJson.setupStatus === 'completed') {
        console.warn('âš ï¸ ã‚·ãƒ¼ãƒˆè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ãŒã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ­ãƒ¼å®Œäº†ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—: ' + sheetKey);
      } else {
        issues.push('âŒ ã‚·ãƒ¼ãƒˆè¨­å®šæœªä¿å­˜: ' + sheetKey);
      }
    }
    
    if (issues.length === 0) {
      return {
        success: true,
        message: flowType + 'ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ',
        details: {
          setupStatus: configJson.setupStatus,
          appPublished: configJson.appPublished,
          formCreated: configJson.formCreated,
          publishedSheetName: configJson.publishedSheetName,
          hasSheetConfig: !!(sheetConfig && sheetConfig.guessedConfig)
        }
      };
    } else {
      console.warn('âš ï¸ ' + flowType + 'ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèª: æœªå®Œäº†é …ç›®ãŒã‚ã‚Šã¾ã™', issues);
      return {
        success: false,
        message: flowType + 'ãƒ•ãƒ­ãƒ¼ã«æœªå®Œäº†é …ç›®ãŒã‚ã‚Šã¾ã™',
        issues: issues,
        details: {
          setupStatus: configJson.setupStatus,
          appPublished: configJson.appPublished,
          formCreated: configJson.formCreated,
          publishedSheetName: configJson.publishedSheetName,
          hasSheetConfig: !!(sheetConfig && sheetConfig.guessedConfig)
        }
      };
    }
    
  } catch (error) {
    console.error('âŒ ' + flowType + 'ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
    return { 
      success: false, 
      message: 'ãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message 
    };
  }
}

/**
 * è¨­å®šåŒæœŸãƒ¡ã‚«ãƒ‹ã‚ºãƒ å¼·åŒ– - ãƒ•ãƒ­ãƒ¼å®Œäº†çŠ¶æ…‹ã¨ã®æ•´åˆæ€§ã‚’ä¿ã¤
 * @param {string} flowType - 'quickstart' ã¾ãŸã¯ 'custom'
 * @param {Object} expectedState - æœŸå¾…ã•ã‚Œã‚‹è¨­å®šçŠ¶æ…‹
 * @returns {Promise<Object>} åŒæœŸçµæœ
 */
async function enhanceConfigSynchronization(flowType, expectedState) {
  try {
    
    // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
    const currentStatus = await runGasWithUserId('getAppConfig', 'è¨­å®šåŒæœŸã®ãŸã‚æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ä¸­...');
    
    if (!currentStatus || !currentStatus.userInfo) {
      throw new Error('è¨­å®šåŒæœŸ: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—å¤±æ•—');
    }
    
    const configJson = JSON.parse(currentStatus.userInfo.configJson || '{}');
    const synchronizationIssues = [];
    const appliedFixes = [];
    
    // 1. å¿…é ˆè¨­å®šçŠ¶æ…‹ã®ç¢ºèªã¨ä¿®æ­£
    const requiredStates = {
      setupStatus: 'completed',
      appPublished: true,
      formCreated: true,
      publishedSheetName: expectedState.sheetName,
      publishedSpreadsheetId: expectedState.spreadsheetId || currentStatus.userInfo.spreadsheetId
    };
    
    let needsSync = false;
    const updatedConfig = { ...configJson };
    
    for (const [key, expectedValue] of Object.entries(requiredStates)) {
      if (configJson[key] !== expectedValue) {
        synchronizationIssues.push(key + ': "' + configJson[key] + '" â†’ "' + expectedValue + '"');
        updatedConfig[key] = expectedValue;
        needsSync = true;
      }
    }
    
    // 2. ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šã®åŒæœŸç¢ºèª
    if (expectedState.sheetName && expectedState.config) {
      const sheetKey = 'sheet_' + (expectedState.sheetName || '');
      const currentSheetConfig = configJson[sheetKey];
      
      
      if (!currentSheetConfig || !currentSheetConfig.guessedConfig) {
        synchronizationIssues.push('ã‚·ãƒ¼ãƒˆè¨­å®šæœªä¿å­˜: ' + sheetKey);
        updatedConfig[sheetKey] = {
          guessedConfig: expectedState.config,
          lastUpdated: new Date().toISOString(),
          flowType: flowType
        };
        needsSync = true;
        console.log('ğŸ“ ' + flowType + 'ãƒ•ãƒ­ãƒ¼: ã‚·ãƒ¼ãƒˆè¨­å®šã‚’ä½œæˆ ' + sheetKey);
      }
    }
    
    // 3. è¨­å®šã®åŒæœŸé©ç”¨ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰
    if (needsSync) {
      console.log('ğŸ”§ ' + flowType + 'ãƒ•ãƒ­ãƒ¼: è¨­å®šä¸æ•´åˆã‚’æ¤œå‡º - åŒæœŸä¿®æ­£ã‚’å®Ÿè¡Œ', synchronizationIssues);
      
      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«åŒæœŸä¿®æ­£ã‚’ä¾é ¼ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é †åºä¿®æ­£ï¼‰
      const syncResult = await runGasWithUserId('syncConfigurationState', 'è¨­å®šåŒæœŸã‚’å®Ÿè¡Œä¸­...', 
        updatedConfig, 'repair');
      
      if (syncResult && syncResult.success) {
        appliedFixes.push(...synchronizationIssues);
        
        // çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã§æœ€æ–°çŠ¶æ…‹ã‚’åæ˜ 
        try {
          await cacheManager.clearAllFrontendCaches();
        } catch (clearError) {
          console.warn('Cache clear failed during sync:', clearError);
        }
        
        return {
          success: true,
          synchronized: true,
          appliedFixes: appliedFixes,
          message: flowType + 'ãƒ•ãƒ­ãƒ¼ã®è¨­å®šåŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ'
        };
      } else {
        console.warn('âš ï¸ ' + flowType + 'ãƒ•ãƒ­ãƒ¼: è¨­å®šåŒæœŸä¿®æ­£ã«å¤±æ•—', syncResult);
        return {
          success: false,
          synchronized: false,
          issues: synchronizationIssues,
          syncResult: syncResult,
          message: 'è¨­å®šåŒæœŸä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ',
          details: {
            errors: (syncResult && syncResult.errors) || [],
            systemError: syncResult && syncResult.systemError,
            context: syncResult && syncResult.context
          }
        };
      }
    } else {
      return {
        success: true,
        synchronized: false,
        message: flowType + 'ãƒ•ãƒ­ãƒ¼ã®è¨­å®šã¯æ—¢ã«æ­£ã—ãåŒæœŸã•ã‚Œã¦ã„ã¾ã™'
      };
    }
    
  } catch (error) {
    console.error('âŒ ' + flowType + 'ãƒ•ãƒ­ãƒ¼è¨­å®šåŒæœŸã‚¨ãƒ©ãƒ¼:', error);
    return {
      success: false,
      synchronized: false,
      error: error.message,
      message: 'è¨­å®šåŒæœŸå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message
    };
  }
}

/**
 * çµ±åˆçš„ãªè¨­å®šæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ - è¤‡æ•°ãƒ•ãƒ­ãƒ¼ã«å¯¾å¿œ
 * @param {Object} status - ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
 * @returns {Object} æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯çµæœ
 */
function performIntegratedConfigConsistencyCheck(status) {
  if (!status || !status.userInfo) {
    return { consistent: false, issues: ['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™'] };
  }
  
  try {
    const configJson = JSON.parse(status.userInfo.configJson || '{}');
    const issues = [];
    const recommendations = [];
    
    // 1. åŸºæœ¬çš„ãªè¨­å®šæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    const basicChecks = [
      {
        condition: configJson.setupStatus === 'completed',
        issue: 'setupStatusãŒcompletedã§ã¯ã‚ã‚Šã¾ã›ã‚“',
        recommendation: 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼ã‚’å®Œäº†ã—ã¦ãã ã•ã„'
      },
      {
        condition: configJson.formCreated === true,
        issue: 'formCreatedãŒtrueã§ã¯ã‚ã‚Šã¾ã›ã‚“',
        recommendation: 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'
      },
      {
        condition: !!configJson.publishedSheetName,
        issue: 'publishedSheetNameãŒæœªè¨­å®šã§ã™',
        recommendation: 'ã‚·ãƒ¼ãƒˆé¸æŠã‚’ç¢ºèªã—ã¦ãã ã•ã„'
      },
      {
        condition: !!configJson.publishedSpreadsheetId,
        issue: 'publishedSpreadsheetIdãŒæœªè¨­å®šã§ã™',
        recommendation: 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„'
      }
    ];
    
    basicChecks.forEach(check => {
      if (!check.condition) {
        issues.push(check.issue);
        recommendations.push(check.recommendation);
      }
    });
    
    // 2. å…¬é–‹çŠ¶æ…‹ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    if (configJson.appPublished === true) {
      if (configJson.setupStatus !== 'completed') {
        issues.push('å…¬é–‹çŠ¶æ…‹ãªã®ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæœªå®Œäº†ã§ã™');
        recommendations.push('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã™ã‚‹ã‹ã€å…¬é–‹ã‚’åœæ­¢ã—ã¦ãã ã•ã„');
      }
      if (!configJson.formCreated) {
        issues.push('å…¬é–‹çŠ¶æ…‹ãªã®ã«ãƒ•ã‚©ãƒ¼ãƒ ãŒæœªä½œæˆã§ã™');
        recommendations.push('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã‹ã€å…¬é–‹ã‚’åœæ­¢ã—ã¦ãã ã•ã„');
      }
    }
    
    // 3. ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    if (configJson.publishedSheetName) {
      const sheetKey = 'sheet_' + (configJson.publishedSheetName || '');
      const sheetConfig = configJson[sheetKey];
      
      if (!sheetConfig || !sheetConfig.guessedConfig) {
        issues.push('ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šãŒæœªä¿å­˜ã§ã™: ' + configJson.publishedSheetName);
        recommendations.push('åˆ—è¨­å®šã‚’ç¢ºèªãƒ»ä¿å­˜ã—ã¦ãã ã•ã„');
      }
    }
    
    const isConsistent = issues.length === 0;
    
    return {
      consistent: isConsistent,
      issues: issues,
      recommendations: recommendations,
      severity: issues.length > 3 ? 'high' : issues.length > 1 ? 'medium' : 'low',
      summary: isConsistent ? 'è¨­å®šã¯æ•´åˆæ€§ãŒä¿ãŸã‚Œã¦ã„ã¾ã™' : (issues.length + 'ä»¶ã®æ•´åˆæ€§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ')
    };
    
  } catch (error) {
    console.error('è¨­å®šæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
    return {
      consistent: false,
      issues: ['è¨­å®šè§£æã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'],
      recommendations: ['è¨­å®šã‚’å†ç¢ºèªã—ã¦ãã ã•ã„'],
      error: error.message
    };
  }
}

// Get optimal polling interval based on user activity
function getOptimalPollInterval() {
  const timeSinceActivity = Date.now() - lastUserActivity;
  
  if (timeSinceActivity < 2 * 60 * 1000) { // 2åˆ†ä»¥å†…
    return 30 * 1000; // 30ç§’é–“éš”
  } else if (timeSinceActivity < 10 * 60 * 1000) { // 10åˆ†ä»¥å†…
    return 2 * 60 * 1000; // 2åˆ†é–“éš”
  } else {
    return 10 * 60 * 1000; // 10åˆ†é–“éš”
  }
}

// Restart status polling with new interval
function restartStatusPolling() {
  if (statusPollTimer) {
    clearInterval(statusPollTimer);
  }
  currentPollInterval = getOptimalPollInterval();
  startSystemStatusUpdate();
}

// Start system status update polling
function startSystemStatusUpdate() {
  statusPollTimer = setInterval(function() {
    // UIãŒéè¡¨ç¤ºã®æ™‚ã¯æ›´æ–°ã—ãªã„
    if (document.hidden) return;
    
    // Skip background updates if save operation is in progress or recently completed
    if (isSaveInProgress) {
      logDebug('Skipping background update: save in progress');
      return;
    }
    
    const timeSinceFreshSave = Date.now() - freshSaveTimestamp;
    if (timeSinceFreshSave < FRESH_SAVE_PROTECTION_DURATION) {
      logDebug('Skipping background update: fresh save protection active');
      return;
    }
    
    // ç¾åœ¨ã®ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´
    const optimalInterval = getOptimalPollInterval();
    if (Math.abs(currentPollInterval - optimalInterval) > 30000) { // 30ç§’ä»¥ä¸Šã®å·®
      restartStatusPolling();
      return;
    }
    
    // çµ±ä¸€APIã‚’åˆ©ç”¨ã—ã¦è»½é‡ãƒ¢ãƒ¼ãƒ‰ã§æ›´æ–°ï¼ˆgetInitialDataãƒ™ãƒ¼ã‚¹ï¼‰
    runGasWithUserId('getInitialData', false, false) // ç¬¬3å¼•æ•°ã¯lightweightMode
      .then(function(status) {
        // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿UIã‚’æ›´æ–°
        if (JSON.stringify(status) !== JSON.stringify(currentStatus)) {
          updateUIWithNewStatus(status);
        }
      })
      .catch(function(error) {
        logWarn('Background status update failed:', error);
      });
  }, currentPollInterval);
}

// =============================================================================
// CONFIG MANAGEMENT
// =============================================================================

// Reset configJson to initial values
function resetConfigJson() {
  // å±é™ºæ“ä½œã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  const confirmMessage = `âš ï¸ è¨­å®šãƒªã‚»ãƒƒãƒˆã®ç¢ºèª

ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®è¨­å®šãŒåˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼š
â€¢ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šï¼ˆè³ªå•æ–‡ã€å›ç­”æ–¹æ³•ãªã©ï¼‰
â€¢ è¡¨ç¤ºè¨­å®šï¼ˆåŒ¿åè¡¨ç¤ºã€é›†è¨ˆè¡¨ç¤ºãªã©ï¼‰
â€¢ ã‚·ãƒ¼ãƒˆè¨­å®šï¼ˆå›ç­”é€£æºãªã©ï¼‰

â€» ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚„ãƒ•ã‚©ãƒ¼ãƒ è‡ªä½“ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ãŒã€
ã€€ è¨­å®šã®å†æ§‹ç¯‰ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

æœ¬å½“ã«è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`;

  if (!confirm(confirmMessage)) {
    return;
  }
  
  const button = document.getElementById('reset-config-btn');
  const originalHTML = button ? button.innerHTML : '';
  
  try {
    if (button) {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
      button.disabled = true;
      button.innerHTML = `
        <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        ãƒªã‚»ãƒƒãƒˆä¸­...
      `;
    }
    
    logInfo('ğŸ”„ ConfigJsonãƒªã‚»ãƒƒãƒˆé–‹å§‹');
    
    runGasWithUserId('resetConfigJson', 'è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆä¸­...')
      .then(function(result) {
        if (result.success) {
          showMessage('âœ… è¨­å®šã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å¤‰æ›´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'success');
          logInfo('âœ… ConfigJsonãƒªã‚»ãƒƒãƒˆå®Œäº†');
          
          // UIã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          setTimeout(() => {
            runGasWithUserId('getInitialData', 'ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...')
              .then(function(updatedStatus) {
                updateUIWithNewStatus(updatedStatus);
                logInfo('ğŸ”„ ãƒªã‚»ãƒƒãƒˆå¾Œã®UIæ›´æ–°å®Œäº†');
              })
              .catch(function(error) {
                logWarn('âš ï¸ ãƒªã‚»ãƒƒãƒˆå¾Œã®UIæ›´æ–°ã§ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('è¨­å®šã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸãŒã€è¡¨ç¤ºã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'warning');
              });
          }, 1000);
        } else {
          throw new Error(result.message || 'è¨­å®šãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(function(error) {
        logError('âŒ ConfigJsonãƒªã‚»ãƒƒãƒˆã§ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('è¨­å®šãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error), 'error');
      })
      .finally(() => {
        if (button) {
          // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
          button.disabled = false;
          button.innerHTML = originalHTML;
        }
      });
      
  } catch (error) {
    logError('âŒ ConfigJsonãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
    showMessage('è¨­å®šãƒªã‚»ãƒƒãƒˆã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    if (button) {
      button.disabled = false;
      button.innerHTML = originalHTML;
    }
  }
}

// =============================================================================
// QUICKSTART FUNCTIONALITY
// =============================================================================

// QuickStart progress management (Simplified 2-step)
const quickStartSteps = [
  { id: 1, text: 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ', detail: 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è‡ªå‹•ä½œæˆä¸­...' },
  { id: 2, text: 'ãƒœãƒ¼ãƒ‰è¨­å®šã¨è‡ªå‹•å…¬é–‹', detail: 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è¨­å®šã¨è‡ªå‹•å…¬é–‹ã‚’å®Ÿè¡Œä¸­...' }
];

// Custom setup progress management
// Custom Setup step definitions (7 steps for comprehensive setup) - ç‹¬ç«‹ç‰ˆ
const customSetupSteps = [
  { id: 1, text: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®æ¤œè¨¼', detail: 'å…¥åŠ›å†…å®¹ã‚’æ¤œè¨¼ä¸­...', maxTime: 12 },
  { id: 2, text: 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', detail: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ§‹ç¯‰ä¸­...', maxTime: 20 },
  { id: 3, text: 'AIåˆ—åˆ¤å®šã®å®Ÿè¡Œ', detail: 'AIãŒåˆ—ã‚’åˆ†æä¸­...', maxTime: 25 },
  { id: 4, text: 'è¨­å®šã®ä¿å­˜', detail: 'åˆ¤å®šçµæœã‚’ä¿å­˜ä¸­...', maxTime: 8 },
  { id: 5, text: 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢', detail: 'ã‚·ã‚¹ãƒ†ãƒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°ä¸­...', maxTime: 8 },
  { id: 6, text: 'å®Œäº†å‡¦ç†', detail: 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†æº–å‚™ä¸­...', maxTime: 5 }
];

// Show QuickStart progress bar
function showQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.remove('hidden');
    resetProgressSteps();
  }
}

// Hide QuickStart progress bar
function hideQuickStartProgress() {
  const progressContainer = document.getElementById('quickstart-progress');
  if (progressContainer) {
    progressContainer.classList.add('hidden');
  }
}

// Reset all progress steps to initial state
function resetProgressSteps() {
  quickStartSteps.forEach(step => {
    updateProgressStep(step.id, 'waiting', step.text, 'å¾…æ©Ÿä¸­...');
  });
  updateOverallProgress(0, 'åˆæœŸåŒ–ä¸­...');
}

// Update individual progress step
function updateProgressStep(stepId, status, text, detail) {
  const stepElement = document.getElementById('progress-step-' + stepId);
  const dotElement = document.getElementById('progress-step-' + stepId + '-dot');
  const textElement = document.getElementById('progress-step-' + stepId + '-text');
  const detailElement = document.getElementById('progress-step-' + stepId + '-detail');
  
  if (!stepElement || !dotElement || !textElement || !detailElement) return;
  
  // Update text and detail
  textElement.textContent = text;
  detailElement.textContent = detail;
  
  // Update visual state based on status
  switch (status) {
    case 'waiting':
      dotElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      textElement.className = 'text-sm text-gray-300';
      detailElement.className = 'text-xs text-gray-500';
      break;
    case 'active':
      dotElement.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse';
      textElement.className = 'text-sm text-emerald-300 font-medium';
      detailElement.className = 'text-xs text-emerald-400';
      break;
    case 'completed':
      dotElement.className = 'w-2 h-2 rounded-full bg-green-400';
      textElement.className = 'text-sm text-green-300 font-medium';
      detailElement.className = 'text-xs text-green-400';
      break;
    case 'error':
      dotElement.className = 'w-2 h-2 rounded-full bg-red-400';
      textElement.className = 'text-sm text-red-300 font-medium';
      detailElement.className = 'text-xs text-red-400';
      break;
  }
}

// Update overall progress bar
function updateOverallProgress(percentage, statusMessage) {
  const progressBar = document.getElementById('progress-bar');
  const progressPercentage = document.getElementById('progress-percentage');
  const progressStatus = document.getElementById('progress-status');
  
  if (progressBar) {
    progressBar.style.width = percentage + '%';
  }
  
  if (progressPercentage) {
    progressPercentage.textContent = percentage + '%';
  }
  
  if (progressStatus) {
    progressStatus.textContent = statusMessage;
  }
}

// Simulate QuickStart progress with enhanced backend synchronization
function simulateQuickStartProgress() {
  console.log('ğŸš€ Starting simplified QuickStart progress simulation (2 steps)');
  
  // 2-Step Simplified QuickStart Progress
  updateProgressStep(1, 'active', 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ', 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è‡ªå‹•ä½œæˆä¸­...');
  updateOverallProgress(10, 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...', 2.5);
  
  // æ®µéšçš„ã«é€²æ—ã‚’æ›´æ–°ï¼ˆ2ã‚¹ãƒ†ãƒƒãƒ—æ§‹æˆï¼‰
  setTimeout(() => {
    updateOverallProgress(30, 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆä¸­...', 2);
    
    setTimeout(() => {
      updateOverallProgress(60, 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆå®Œäº†', 1.5);
      updateProgressStep(1, 'completed', 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
      updateProgressStep(2, 'active', 'ãƒœãƒ¼ãƒ‰è¨­å®šã¨è‡ªå‹•å…¬é–‹', 'å›ç­”ãƒœãƒ¼ãƒ‰ã®è¨­å®šã¨è‡ªå‹•å…¬é–‹ã‚’å®Ÿè¡Œä¸­...');
      
      setTimeout(() => {
        updateOverallProgress(80, 'ãƒœãƒ¼ãƒ‰è¨­å®šé©ç”¨ä¸­...', 1);
        
        setTimeout(() => {
          updateOverallProgress(95, 'è‡ªå‹•å…¬é–‹æº–å‚™ä¸­...', 0.5);
          
          setTimeout(() => {
            // æœ€çµ‚å®Œäº†çŠ¶æ…‹ã¯ executeQuickStartProcess ã®æˆåŠŸãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§è¨­å®šã•ã‚Œã‚‹
          }, 500);
        }, 800);
      }, 1000);
    }, 1500);
  }, 1000);
  
  // Optional folder creation check (non-blocking - doesn't affect main progress)
  runGasWithUserId('createUserFolder', false)
    .then(function(folderResult) {
    })
    .catch(function(error) {
      console.warn('âš ï¸ QuickStart folder creation check failed, but continuing:', error);
    });
}

// Simulate Custom Form progress (for custom form creation)
function simulateCustomFormProgressWithFolderCheck() {
  // Step 1: Real folder creation/check
  updateProgressStep(1, 'active', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’æº–å‚™ä¸­...');
  updateOverallProgress(5, 'ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
  
  // Actually call the folder creation API to sync with real backend progress
  runGasWithUserId('createUserFolder', 'ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªãƒ»ä½œæˆä¸­...')
    .then(function(folderResult) {
      updateProgressStep(1, 'completed', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
      updateProgressStep(2, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã§ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...');
      updateOverallProgress(25, 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
      
      // Step 2: Custom form/spreadsheet creation
      setTimeout(() => {
        updateProgressStep(2, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
        updateProgressStep(3, 'active', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨ä¸­...');
        updateOverallProgress(50, 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’é©ç”¨ã—ã¦ã„ã¾ã™...');
        
        // Step 3: Custom configuration
        setTimeout(() => {
          updateProgressStep(3, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'âœ… ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ');
          updateProgressStep(4, 'active', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æœ€é©åŒ–ä¸­...');
          updateOverallProgress(75, 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™...');
          
          // Step 4: Sheet optimization
          setTimeout(() => {
            updateProgressStep(4, 'completed', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'âœ… ã‚·ãƒ¼ãƒˆæ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ');
            updateProgressStep(5, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'ãƒ•ã‚©ãƒ¼ãƒ æº–å‚™ã‚’å®Œäº†ä¸­...');
            updateOverallProgress(90, 'æœ€çµ‚æº–å‚™ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
            
            // Step 5: Final preparation
            setTimeout(() => {
              updateProgressStep(5, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ');
              updateProgressStep(6, 'active', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
              updateOverallProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
              
              setTimeout(() => {
                updateProgressStep(6, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
              }, 500);
            }, 1000);
          }, 1500);
        }, 1000);
      }, 2000);
    })
    .catch(function(error) {
      console.warn('âš ï¸ Custom form folder creation failed, continuing with fallback:', error);
      updateProgressStep(1, 'error', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ', 'âš ï¸ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒå‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™');
      showMessage('ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆã«è­¦å‘ŠãŒã‚ã‚Šã¾ã—ãŸãŒã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚’ç¶šè¡Œã—ã¾ã™ã€‚', 'warning');
      
      // Continue with fallback timing even if folder creation fails
      setTimeout(() => {
        updateProgressStep(2, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã§ãƒ‡ãƒ¼ã‚¿åé›†ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ä¸­...');
        updateOverallProgress(25, 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
        
        setTimeout(() => {
          updateProgressStep(2, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
          updateProgressStep(3, 'active', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨ä¸­...');
          updateOverallProgress(50, 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’é©ç”¨ã—ã¦ã„ã¾ã™...');
          
          setTimeout(() => {
            updateProgressStep(3, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨', 'âœ… ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ');
            updateProgressStep(4, 'active', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æœ€é©åŒ–ä¸­...');
            updateOverallProgress(75, 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™...');
            
            setTimeout(() => {
              updateProgressStep(4, 'completed', 'ã‚·ãƒ¼ãƒˆæ§‹é€ ã®æœ€é©åŒ–', 'âœ… ã‚·ãƒ¼ãƒˆæ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ');
              updateProgressStep(5, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'ãƒ•ã‚©ãƒ¼ãƒ æº–å‚™ã‚’å®Œäº†ä¸­...');
              updateOverallProgress(90, 'æœ€çµ‚æº–å‚™ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...');
              
              setTimeout(() => {
                updateProgressStep(5, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†', 'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ');
                updateProgressStep(6, 'active', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'åˆ©ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
                updateOverallProgress(100, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                
                setTimeout(() => {
                  updateProgressStep(6, 'completed', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼');
                }, 500);
              }, 1000);
            }, 1500);
          }, 1000);
        }, 2000);
      }, 1000);
    });
}

// =============================================================================
// CUSTOM SETUP FUNCTIONALITY - Unified Automation
// =============================================================================

// Show Custom Setup progress bar (ç‹¬ç«‹ç‰ˆ)
function showCustomSetupProgress() {
  const progressContainer = document.getElementById('customsetup-progress'); // ç‹¬ç«‹ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨
  if (progressContainer) {
    progressContainer.classList.remove('hidden');
    resetCustomSetupProgressSteps();
  }
}

// Hide Custom Setup progress bar (ç‹¬ç«‹ç‰ˆ)
function hideCustomSetupProgress() {
  const progressContainer = document.getElementById('customsetup-progress'); // ç‹¬ç«‹ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨
  if (progressContainer) {
    progressContainer.classList.add('hidden');
  }
}

// Reset Custom Setup progress steps (ç‹¬ç«‹ç‰ˆ)
function resetCustomSetupProgressSteps() {
  customSetupSteps.forEach(step => {
    updateCustomProgressStep(step.id, 'waiting', step.text, 'å¾…æ©Ÿä¸­...');
  });
  updateCustomOverallProgress(0, 'åˆæœŸåŒ–ä¸­...', calculateTotalEstimatedTime());
}

// CustomSetupå°‚ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°é–¢æ•°
function updateCustomProgressStep(stepId, status, text, detail) {
  const stepElement = document.getElementById('custom-progress-step-' + stepId);
  const dotElement = document.getElementById('custom-progress-step-' + stepId + '-dot');
  const textElement = document.getElementById('custom-progress-step-' + stepId + '-text');
  const detailElement = document.getElementById('custom-progress-step-' + stepId + '-detail');
  const timeElement = document.getElementById('custom-progress-step-' + stepId + '-time');
  
  if (!stepElement || !dotElement || !textElement || !detailElement) return;
  
  // Update text and detail
  textElement.textContent = text;
  detailElement.textContent = detail;
  
  // Update visual state based on status
  switch (status) {
    case 'waiting':
      dotElement.className = 'w-3 h-3 rounded-full bg-gray-500 transition-all duration-300';
      textElement.className = 'text-sm font-medium text-gray-300';
      detailElement.className = 'text-xs text-gray-500 mt-1';
      if (timeElement) timeElement.classList.add('opacity-0');
      break;
    case 'active':
      dotElement.className = 'w-3 h-3 rounded-full bg-purple-400 animate-pulse transition-all duration-300';
      textElement.className = 'text-sm font-medium text-purple-300';
      detailElement.className = 'text-xs text-purple-400 mt-1';
      if (timeElement) timeElement.classList.remove('opacity-0');
      break;
    case 'completed':
      dotElement.className = 'w-3 h-3 rounded-full bg-green-400 transition-all duration-300';
      textElement.className = 'text-sm font-medium text-green-300';
      detailElement.className = 'text-xs text-green-400 mt-1';
      if (timeElement) timeElement.classList.add('opacity-0');
      break;
    case 'error':
      dotElement.className = 'w-3 h-3 rounded-full bg-red-400 transition-all duration-300';
      textElement.className = 'text-sm font-medium text-red-300';
      detailElement.className = 'text-xs text-red-400 mt-1';
      if (timeElement) timeElement.classList.add('opacity-0');
      break;
  }
}

// CustomSetupå°‚ç”¨ã®å…¨ä½“ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°é–¢æ•°
function updateCustomOverallProgress(percentage, statusMessage, estimatedTimeRemaining = null) {
  const progressBar = document.getElementById('custom-progress-bar');
  const progressPercentage = document.getElementById('custom-progress-percentage');
  const progressStatus = document.getElementById('custom-progress-status');
  const progressEta = document.getElementById('custom-progress-eta');
  
  if (progressBar) {
    progressBar.style.width = Math.min(percentage, 100) + '%';
  }
  
  if (progressPercentage) {
    progressPercentage.textContent = Math.round(percentage) + '%';
  }
  
  if (progressStatus) {
    progressStatus.textContent = statusMessage;
  }
  
  if (progressEta && estimatedTimeRemaining !== null) {
    const minutes = Math.ceil(estimatedTimeRemaining / 60);
    progressEta.textContent = 'æ¨å®šæ®‹ã‚Šæ™‚é–“: ' + minutes + 'åˆ†';
  }
}

// æ¨å®šæ®‹ã‚Šæ™‚é–“ã‚’è¨ˆç®—
function calculateTotalEstimatedTime() {
  return customSetupSteps.reduce((total, step) => total + (step.maxTime || SYSTEM_CONSTANTS.CUSTOM_SETUP.STEP_TIMES.CONFIG_SAVE), 0);
}

// CustomSetupå°‚ç”¨ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
function setupCustomSetupCancelHandler() {
  const cancelBtn = document.getElementById('customsetup-cancel-btn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function() {
      if (confirm(SYSTEM_CONSTANTS.CUSTOM_SETUP.CANCEL_CONFIRMATION_MESSAGE)) {
        hideCustomSetupProgress();
        showMessage('âš ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸ', 'warning');
        // TODO: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ã®ä¸­æ–­ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
      }
    });
  }
}

// Simulate Custom Setup progress with real backend synchronization (ç‹¬ç«‹ç‰ˆ)
async function simulateCustomSetupProgress() {
  console.log('ğŸ¨ Starting enhanced Custom Setup progress simulation (ç‹¬ç«‹ç‰ˆ TimingManager)');
  
  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setupCustomSetupCancelHandler();
  
  let currentStep = 0;
  let startTime = Date.now();
  
  for (const step of customSetupSteps) {
    currentStep++;
    
    // ã‚¹ãƒ†ãƒƒãƒ—é–‹å§‹
    updateCustomProgressStep(step.id, 'active', step.text, step.detail);
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¨ˆç®—ï¼ˆå„ã‚¹ãƒ†ãƒƒãƒ—ã¯å…¨ä½“ã®1/7ï¼‰
    const baseProgress = ((currentStep - 1) / customSetupSteps.length) * 100;
    const nextProgress = (currentStep / customSetupSteps.length) * 100;
    
    // æ®µéšçš„ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°ï¼ˆæ”¹å–„ç‰ˆï¼‰
    const stepDuration = (step.maxTime || SYSTEM_CONSTANTS.CUSTOM_SETUP.STEP_TIMES.CONFIG_SAVE) * 1000; // ç§’ã‚’ãƒŸãƒªç§’ã«å¤‰æ›
    const updateInterval = Math.min(stepDuration / 15, SYSTEM_CONSTANTS.CUSTOM_SETUP.PROGRESS_UPDATE_INTERVAL); // ã‚ˆã‚Šé »ç¹ãªæ›´æ–°ï¼ˆ15åˆ†å‰²ï¼‰
    
    let elapsed = 0;
    let lastProgressUpdate = 0;
    
    while (elapsed < stepDuration) {
      await TimingManager.delay(updateInterval);
      elapsed += updateInterval;
      
      // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—å†…ã§ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ï¼ˆã‚¹ãƒ ãƒ¼ã‚ºãªã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
      const rawStepProgress = elapsed / stepDuration;
      const stepProgress = Math.min(rawStepProgress * rawStepProgress * (3 - 2 * rawStepProgress), 1); // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ãƒ†ãƒƒãƒ—é–¢æ•°
      const currentProgress = baseProgress + (nextProgress - baseProgress) * stepProgress;
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãŒå®Ÿéš›ã«å¤‰åŒ–ã—ãŸæ™‚ã®ã¿æ›´æ–°ï¼ˆç„¡é§„ãªæ›´æ–°ã‚’é˜²ãï¼‰
      if (Math.abs(currentProgress - lastProgressUpdate) >= 0.5) {
        // æ®‹ã‚Šæ™‚é–“è¨ˆç®—ï¼ˆæ”¹å–„ç‰ˆï¼‰
        const totalElapsed = (Date.now() - startTime) / 1000;
        const totalEstimated = calculateTotalEstimatedTime();
        const progressRatio = currentProgress / 100;
        const estimatedTotalTime = progressRatio > 0.1 ? totalElapsed / progressRatio : totalEstimated;
        const remainingTime = Math.max(estimatedTotalTime - totalElapsed, 0);
        
        // è©³ç´°ãªã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã‚’è¿½åŠ 
        const detailWithProgress = step.detail + ' (' + Math.round(stepProgress * 100) + '%)';
        updateCustomOverallProgress(currentProgress, detailWithProgress, remainingTime);
        lastProgressUpdate = currentProgress;
      }
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†
    updateCustomProgressStep(step.id, 'completed', step.text, 'âœ… ' + step.text + 'å®Œäº†');
    updateCustomOverallProgress(nextProgress, step.text + 'å®Œäº†');
    
    // çŸ­ã„å®Œäº†è¡¨ç¤ºå¾…æ©Ÿ
    await TimingManager.delay(SYSTEM_CONSTANTS.UI.ANIMATION_DURATION);
  }
  
}

/**
 * ç°¡ç´ åŒ–ã•ã‚ŒãŸçŠ¶æ…‹æ›´æ–°é–¢æ•°
 * è¤‡é›‘ãªçµ±åˆå‡¦ç†ã‚’é¿ã‘ã€æœ€å°é™ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã¨ç›´æ¥çš„ãªloadStatuså‘¼ã³å‡ºã—
 */
async function simpleStatusRefresh() {
  
  try {
    // æœ€å°é™ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆã‚¨ãƒ©ãƒ¼è€æ€§ï¼‰
    if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
      window.unifiedCache.clear();
    }
    
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹åˆ¶å¾¡ã«ã‚ˆã‚‹å®‰å…¨ãªçŠ¶æ…‹æ›´æ–°
    if (window.AdminPanel && window.AdminPanel.debounce) {
      return new Promise((resolve) => {
        window.AdminPanel.debounce.loadStatus(async () => {
          try {
            const status = await loadStatus(true);
            resolve(status);
          } catch (error) {
            console.warn('âš ï¸ ãƒ‡ãƒã‚¦ãƒ³ã‚¹loadStatus ã‚¨ãƒ©ãƒ¼:', error);
            resolve(null);
          }
        }, 250);
      });
    } else {
      const status = await loadStatus(true);
      return status;
    }
    
  } catch (error) {
    console.warn('âš ï¸ ç°¡ç´ åŒ–çŠ¶æ…‹åŒæœŸã§ã‚¨ãƒ©ãƒ¼:', error);
    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚loadStatusã‚’è©¦è¡Œ
    try {
      return await loadStatus(true);
    } catch (fallbackError) {
      console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯loadStatusã‚‚å¤±æ•—:', fallbackError);
      throw fallbackError;
    }
  }
}

/**
 * ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ãƒãƒ¼ãƒªãƒ³ã‚°é–¢æ•°
 * ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿæ™‚ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ã®å®Œäº†ã‚’ç¢ºèª
 */
async function startBackendCompletionPolling() {
  const maxAttempts = 20; // æœ€å¤§2åˆ†é–“ï¼ˆ6ç§’Ã—20å›ï¼‰
  
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      
      // 6ç§’å¾…æ©Ÿ
      await new Promise(resolve => setTimeout(resolve, 6000));
      
      // çŠ¶æ…‹ç¢ºèª
      const status = await simpleStatusRefresh();
      
      // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ã®ç¢ºèª
      if (status && (status.setupStep >= 3 || (status.systemStatus && status.systemStatus.setupStatus === 'completed'))) {
        
        // æˆåŠŸå‡¦ç†
        updateProgressStep(6, 'completed', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 'ğŸ‰ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        showMessage('âœ… ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸï¼AIåˆ—åˆ¤å®šã‚’é–‹å§‹ã—ã¾ã™ã€‚', 'success');
        
        // UIæ›´æ–°
        updateUIAfterCustomSetup(status);
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹éè¡¨ç¤º
        setTimeout(() => {
          hideCustomSetupProgress();
        }, 3000);
        
        return;
      }
      
      // é€²è¡ŒçŠ¶æ³è¡¨ç¤ºæ›´æ–°
      updateProgressStep(6, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¶™ç¶šä¸­', 'â³ å‡¦ç†ç¢ºèªä¸­... (' + attempt + '/' + maxAttempts + ')');
      
    } catch (error) {
      console.warn('âš ï¸ ãƒãƒ¼ãƒªãƒ³ã‚°è©¦è¡Œ ' + attempt + ' ã§ã‚¨ãƒ©ãƒ¼:', error);
    }
  }
  
  // æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ãŸå ´åˆ
  console.warn('âš ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ãƒãƒ¼ãƒªãƒ³ã‚°æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸ');
  updateProgressStep(6, 'error', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ä¸æ˜', 'âš ï¸ å‡¦ç†çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ');
  showMessage('âš ï¸ å‡¦ç†çŠ¶æ…‹ã®ç¢ºèªãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'warning');
  
  setTimeout(() => {
    hideCustomSetupProgress();
  }, 5000);
}

/**
 * ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æˆåŠŸå¾Œã®UIæ›´æ–°
 */
function updateUIAfterCustomSetup(status) {
  console.log('ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æˆåŠŸå¾Œã®UIæ›´æ–°');
  
  try {
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆè¨­å®š
    if (status.activeSheetName) {
      const select = document.getElementById('sheet-select');
      if (select) {
        select.value = status.activeSheetName;
        selectedSheet = status.activeSheetName;
        lastSelectedSheetName = status.activeSheetName;
      }
    }
    
    // ãã®ä»–ã®UIæ›´æ–°é–¢æ•°ãŒã‚ã‚Œã°å‘¼ã³å‡ºã—
    if (typeof updateSheetSelectActiveIndicator === 'function' && status.activeSheetName) {
      updateSheetSelectActiveIndicator(status.activeSheetName);
    }
    
    if (typeof updateUIForSelectedSheet === 'function') {
      updateUIForSelectedSheet();
    }
    
  } catch (error) {
    console.warn('âš ï¸ UIæ›´æ–°ã§ã‚¨ãƒ©ãƒ¼:', error);
  }
}

/**
 * QuickStartç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ãƒãƒ¼ãƒªãƒ³ã‚°é–¢æ•°
 * ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿæ™‚ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ã®å®Œäº†ã‚’ç¢ºèª
 */
async function startQuickStartPolling(quickstartBtn, quickstartText) {
  const maxAttempts = 20; // æœ€å¤§2åˆ†é–“ï¼ˆ6ç§’Ã—20å›ï¼‰
  
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      
      // 6ç§’å¾…æ©Ÿ
      await new Promise(resolve => setTimeout(resolve, 6000));
      
      // çŠ¶æ…‹ç¢ºèª
      const status = await simpleStatusRefresh();
      
      // QuickStartå®Œäº†ã®ç¢ºèªï¼ˆãƒ•ã‚©ãƒ¼ãƒ ä½œæˆçŠ¶æ…‹ã‚„ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ã‚’ç¢ºèªï¼‰
      if (status && (status.setupStep >= 3 || (status.systemStatus && status.systemStatus.setupStatus === 'completed') || status.formUrl)) {
        
        // æˆåŠŸå‡¦ç†
        updateProgressStep(6, 'completed', 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†', 'ğŸ‰ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        showMessage('âœ… ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†å®Œäº†ï¼‰', 'success');
        
        // UIæ›´æ–°
        updateUIAfterQuickStart(status, quickstartBtn, quickstartText);
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹éè¡¨ç¤º
        setTimeout(() => {
          hideQuickStartProgress();
        }, 3000);
        
        return true; // æˆåŠŸã§çµ‚äº†
      }
      
    } catch (error) {
      console.warn('âš ï¸ QuickStartãƒãƒ¼ãƒªãƒ³ã‚°è©¦è¡Œ ' + attempt + ' ã§ã‚¨ãƒ©ãƒ¼:', error);
    }
  }
  
  // æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ãŸå ´åˆ
  console.warn('âš ï¸ QuickStartãƒãƒ¼ãƒªãƒ³ã‚°: æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸ');
  updateProgressStep(6, 'error', 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆç¢ºèªå¤±æ•—', 'å‡¦ç†ã®å®Œäº†ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ');
  showMessage('âš ï¸ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®å®Œäº†ç¢ºèªã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚å¾Œã§ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'warning');
  
  // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ
  if (quickstartBtn && quickstartText) {
    quickstartBtn.disabled = false;
    quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
  }
  
  setTimeout(() => {
    hideQuickStartProgress();
  }, 5000);
  
  return false;
}

/**
 * QuickStartæˆåŠŸå¾Œã®UIæ›´æ–°
 */
function updateUIAfterQuickStart(status, quickstartBtn, quickstartText) {
  console.log('ğŸš€ QuickStartæˆåŠŸå¾Œã®UIæ›´æ–°');
  
  try {
    // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
    if (quickstartBtn && quickstartText) {
      quickstartBtn.disabled = false;
      quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†';
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    sessionStorage.setItem('form_just_created', 'true');
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆè¨­å®šï¼ˆã‚ã‚Œã°ï¼‰
    if (status.activeSheetName) {
      const select = document.getElementById('sheet-select');
      if (select) {
        select.value = status.activeSheetName;
        selectedSheet = status.activeSheetName;
        lastSelectedSheetName = status.activeSheetName;
      }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ URLè¡¨ç¤ºã®æ›´æ–°
    if (typeof updateFormUrlDisplay === 'function') {
      updateFormUrlDisplay();
    }
    
    // ãã®ä»–ã®UIæ›´æ–°é–¢æ•°ãŒã‚ã‚Œã°å‘¼ã³å‡ºã—
    if (typeof updateSheetSelectActiveIndicator === 'function' && status.activeSheetName) {
      updateSheetSelectActiveIndicator(status.activeSheetName);
    }
    
    if (typeof updateUIForSelectedSheet === 'function') {
      updateUIForSelectedSheet();
    }
    
    // å…¬é–‹åœæ­¢ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    if (typeof updateUnpublishButton === 'function') {
      updateUnpublishButton(status);
    }
    
  } catch (error) {
    console.warn('âš ï¸ QuickStart UIæ›´æ–°ã§ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// Handle unified custom setup
async function handleCustomSetup(config) {
  const flowId = 'customSetup';
  
  return await flowExecutionManager.executeWithLock(flowId, async () => {
    console.log('ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹ï¼ˆçµ±ä¸€ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ç‰ˆï¼‰');
    
    // Phase 0: æ—¢å­˜çŠ¶æ…‹ã®ä¿è­·ãƒã‚§ãƒƒã‚¯
    let existingFlowProtection = null;
    try {
      if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
        const existingConfig = JSON.parse(currentStatus.userInfo.configJson);
        
        // QuickStartã¾ãŸã¯å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ãŒæ—¢ã«å®Ÿè¡Œæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        const isExistingQuickStart = !!(
          (existingConfig.isQuickStart || existingConfig.setupType === 'quickstart') ||
          (existingConfig.setupStatus === 'completed' && existingConfig.formCreated === true && 
           (existingConfig.completedAt || existingConfig.publishedAt))
        );
        
        const isExistingExternalResource = !!(
          existingConfig.isExternalResource ||
          (currentStatus.userInfo.customFormInfo && 
           currentStatus.userInfo.customFormInfo.isExternalResource)
        );
        
        if (isExistingQuickStart || isExistingExternalResource) {
          existingFlowProtection = {
            flowType: isExistingQuickStart ? 'QuickStart' : 'ExternalResource',
            preservePublished: existingConfig.appPublished,
            originalConfig: {...existingConfig}
          };
          console.log('ğŸ›¡ï¸ æ—¢å­˜ãƒ•ãƒ­ãƒ¼ä¿è­·è¨­å®š:', existingFlowProtection);
        }
      }
    } catch (protectionError) {
      console.warn('âš ï¸ æ—¢å­˜çŠ¶æ…‹ä¿è­·ãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼:', protectionError);
    }
  
  try {
    // Phase 1: ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºé–‹å§‹
    showCustomSetupProgress();
    
    // 2ã‚¹ãƒ†ãƒƒãƒ—ã®ç°¡ç´ åŒ–ã•ã‚ŒãŸé€²æ—è¡¨ç¤º
    updateCustomOverallProgress(10, 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...', 4);
    updateCustomProgressStep(1, 'active', 'ãƒ‡ãƒ¼ã‚¿æº–å‚™ã¨ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ', 'Googleãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ§‹ç¯‰ä¸­...');
    
    await TimingManager.delay(500); // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    updateCustomOverallProgress(20, 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆä¸­...', 3);
    
    // Phase 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†å®Ÿè¡Œ  
    const result = await runGasWithUserId('customSetup', false, config);
    
    if (!result || result.status !== 'success') {
      throw new Error((result && result.message) || 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ãŒå¤±æ•—ã—ã¾ã—ãŸ');
    }
    
    
    // 2ã‚¹ãƒ†ãƒƒãƒ—é€²æ—ã‚’æ®µéšçš„ã«æ›´æ–°
    updateCustomOverallProgress(60, 'ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆå®Œäº†', 2);
    updateCustomProgressStep(1, 'completed', 'ãƒ‡ãƒ¼ã‚¿æº–å‚™ã¨ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ', 'âœ… ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
    updateCustomProgressStep(2, 'active', 'AIã«ã‚ˆã‚‹åˆ—åˆ†æ', 'AIãŒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—ã‚’åˆ†æã—ã€æœ€é©ãªè¨­å®šã‚’ææ¡ˆä¸­...');
    
    await TimingManager.delay(1000);
    updateCustomOverallProgress(90, 'AIåˆ—åˆ†æå®Œäº†', 1);
    updateCustomProgressStep(2, 'completed', 'AIã«ã‚ˆã‚‹åˆ—åˆ†æ', 'âœ… AIåˆ—åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸ');
    
    await TimingManager.delay(500);
    updateCustomOverallProgress(100, 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†');
    console.log('ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆæ‰‹å‹•å…¬é–‹å¾…æ©Ÿï¼‰');
    
    // Phase 3: ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯æ‰‹å‹•å…¬é–‹å‰æã®ãŸã‚ã€è‡ªå‹•å…¬é–‹çŠ¶æ…‹ä¿®æ­£ã¯å®Ÿè¡Œã—ãªã„
    console.log('â„¹ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº† - æ‰‹å‹•å…¬é–‹å¾…æ©Ÿä¸­ï¼ˆè‡ªå‹•å…¬é–‹çŠ¶æ…‹ä¿®æ­£ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰');
    
    // Phase 4: å˜ä¸€ã®æœ€çµ‚åŒæœŸï¼ˆã™ã¹ã¦ã®ä¸¦è¡Œå‡¦ç†ã‚’çµ±åˆï¼‰
    
    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†çµæœã®è©³ç´°ãƒ­ã‚°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    console.log('ğŸ“Š ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çµæœè©³ç´°:', {
      status: result.status,
      formId: result.formId,
      formUrl: result.formUrl,
      editFormUrl: result.editFormUrl,
      spreadsheetId: result.spreadsheetId,
      spreadsheetUrl: result.spreadsheetUrl,
      sheetName: result.sheetName,
      folderId: result.folderId,
      folderUrl: result.folderUrl,
      autoPublished: result.autoPublished,
      success: result.success
    });
    
    // æ—¢å­˜ã®å®‰å®šã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ–¹å¼
    try {
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      
      if (window.sharedUtilities && window.sharedUtilities.cache && typeof window.sharedUtilities.cache.clear === 'function') {
        window.sharedUtilities.cache.clear();
      }
    } catch (cacheError) {
      console.warn('âš ï¸ Cache clear warning during final sync:', cacheError);
    }
    
    // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆç°¡ç´ åŒ–ç‰ˆï¼‰
    const freshStatus = await simpleStatusRefresh();
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¾Œã¯æ‰‹å‹•å…¬é–‹å‰æã®ãŸã‚ã€å…¬é–‹çŠ¶æ…‹ã‚’å¼·åˆ¶çš„ã«éå…¬é–‹ã«è¨­å®š
    // ãŸã ã—ã€QuickStartå®Œäº†æ™‚ã¯è‡ªå‹•å…¬é–‹ãŒå‰æãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
    if (freshStatus && freshStatus.userInfo && freshStatus.userInfo.configJson) {
      try {
        const config = JSON.parse(freshStatus.userInfo.configJson);
        
        // æ”¹å–„ã•ã‚ŒãŸãƒ•ãƒ­ãƒ¼åˆ¤å®š: ã‚ˆã‚ŠæŸ”è»Ÿã§åŒ…æ‹¬çš„ãªåˆ¤å®šæ¡ä»¶
        const isQuickStartFlow = !!(
          (config.isQuickStart || config.setupType === 'quickstart') ||
          (config.setupStatus === 'completed' && config.formCreated === true && 
           (config.completedAt || config.publishedAt)) // ã„ãšã‚Œã‹ãŒå­˜åœ¨ã™ã‚Œã°ååˆ†
        );
        
        const isExternalResourceFlow = !!(
          config.isExternalResource || 
          (freshStatus.userInfo && freshStatus.userInfo.customFormInfo && 
           freshStatus.userInfo.customFormInfo.isExternalResource)
        );
        
        // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®åˆ¤å®šï¼ˆæ˜ç¤ºçš„ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ­ãƒ¼ã‹ã©ã†ã‹ï¼‰
        const isCustomSetupFlow = !!(
          !isQuickStartFlow && !isExternalResourceFlow &&
          freshStatus.userInfo && freshStatus.userInfo.customFormInfo &&
          !freshStatus.userInfo.customFormInfo.isExternalResource
        );
        
        // æ—¢å­˜ãƒ•ãƒ­ãƒ¼ä¿è­·ã®é©ç”¨
        const shouldProtectExistingFlow = existingFlowProtection && (
          (existingFlowProtection.flowType === 'QuickStart' && isQuickStartFlow) ||
          (existingFlowProtection.flowType === 'ExternalResource' && isExternalResourceFlow)
        );
        
        console.log('ğŸ” ãƒ•ãƒ­ãƒ¼åˆ¤å®šçµæœ:', {
          isQuickStart: isQuickStartFlow,
          isExternalResource: isExternalResourceFlow,
          isCustomSetup: isCustomSetupFlow,
          appPublished: config.appPublished,
          protectedFlow: shouldProtectExistingFlow ? existingFlowProtection.flowType : null
        });
        
        // ãƒ•ãƒ­ãƒ¼åˆ¥ã®å…¬é–‹çŠ¶æ…‹å‡¦ç†
        if (shouldProtectExistingFlow) {
          console.log('ğŸ›¡ï¸ æ—¢å­˜ãƒ•ãƒ­ãƒ¼ä¿è­·ã‚’é©ç”¨:', existingFlowProtection.flowType);
          
          // æ—¢å­˜è¨­å®šã®é‡è¦éƒ¨åˆ†ã‚’å¾©å…ƒ
          config.appPublished = existingFlowProtection.preservePublished;
          if (existingFlowProtection.originalConfig.isQuickStart) {
            config.isQuickStart = existingFlowProtection.originalConfig.isQuickStart;
          }
          if (existingFlowProtection.originalConfig.isExternalResource) {
            config.isExternalResource = existingFlowProtection.originalConfig.isExternalResource;
          }
          if (existingFlowProtection.originalConfig.setupType) {
            config.setupType = existingFlowProtection.originalConfig.setupType;
          }
          
          freshStatus.userInfo.configJson = JSON.stringify(config);
          freshStatus.appPublished = config.appPublished;
          freshStatus.isPublished = config.appPublished;
          if (freshStatus._normalized) {
            freshStatus._normalized.isPublished = config.appPublished;
          }
          
          console.log('âœ… æ—¢å­˜ãƒ•ãƒ­ãƒ¼è¨­å®šã‚’ä¿è­·ãƒ»å¾©å…ƒã—ã¾ã—ãŸ');
          
        } else if (config.appPublished === true && isCustomSetupFlow) {
          console.log('âš ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¾Œã«è‡ªå‹•å…¬é–‹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ - æ‰‹å‹•å…¬é–‹å‰æã«ä¿®æ­£');
          config.appPublished = false;
          freshStatus.userInfo.configJson = JSON.stringify(config);
          freshStatus.appPublished = false;
          freshStatus.isPublished = false;
          if (freshStatus._normalized) {
            freshStatus._normalized.isPublished = false;
          }
        } else if (isQuickStartFlow) {
          console.log('âœ… QuickStartãƒ•ãƒ­ãƒ¼ã®è‡ªå‹•å…¬é–‹çŠ¶æ…‹ã‚’ç¶­æŒ:', {
            appPublished: config.appPublished,
            setupStatus: config.setupStatus,
            formCreated: config.formCreated
          });
        } else if (isExternalResourceFlow) {
          console.log('âœ… å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ãƒ­ãƒ¼ã®çŠ¶æ…‹ã‚’ç¶­æŒ:', {
            appPublished: config.appPublished,
            isExternalResource: config.isExternalResource
          });
        }
      } catch (configError) {
        console.warn('âš ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¾Œã®è¨­å®šè§£æã‚¨ãƒ©ãƒ¼:', configError);
      }
    }
    
    // Phase 5: UIå®Œå…¨æ›´æ–°ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆè¨­å®šã‚’å«ã‚€ï¼‰
    if (freshStatus && freshStatus.activeSheetName) {
      
      // ã‚·ãƒ¼ãƒˆé¸æŠUIã®ç›´æ¥æ›´æ–°
      const select = document.getElementById('sheet-select');
      if (select) {
        select.value = freshStatus.activeSheetName;
        selectedSheet = freshStatus.activeSheetName;
        lastSelectedSheetName = freshStatus.activeSheetName;
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤ºæ›´æ–°
        if (typeof updateSheetSelectActiveIndicator === 'function') {
          updateSheetSelectActiveIndicator(freshStatus.activeSheetName);
        }
        
        // UIçŠ¶æ…‹åŒæœŸ
        if (typeof updateUIForSelectedSheet === 'function') {
          updateUIForSelectedSheet();
        }
        
      }
    } else {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚·ãƒ¼ãƒˆåã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
      const defaultSheetName = 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1';
      console.log('â„¹ï¸ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒä¸å®Œå…¨ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒ¼ãƒˆåã‚’ä½¿ç”¨:', defaultSheetName);
      
      const select = document.getElementById('sheet-select');
      if (select && select.options.length > 0) {
        // æœ‰åŠ¹ãªå€¤ã‚’æŒã¤æœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¢ã™
        let selectedOption = null;
        for (let i = 0; i < select.options.length; i++) {
          const option = select.options[i];
          if (option.value && option.value.trim() !== '' && option.value !== 'undefined') {
            selectedOption = option;
            break;
          }
        }
        
        // æœ‰åŠ¹ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
        if (!selectedOption) {
          selectedOption = { value: defaultSheetName, text: defaultSheetName };
          console.log('â„¹ï¸ æœ‰åŠ¹ãªã‚·ãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨:', defaultSheetName);
        }
        
        select.value = selectedOption.value;
        selectedSheet = selectedOption.value;
        lastSelectedSheetName = selectedOption.value;
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤ºæ›´æ–°
        if (typeof updateSheetSelectActiveIndicator === 'function') {
          updateSheetSelectActiveIndicator(selectedOption.value);
        }
        
        // UIçŠ¶æ…‹åŒæœŸ
        if (typeof updateUIForSelectedSheet === 'function') {
          updateUIForSelectedSheet();
        }
        
      } else {
        // ã‚·ãƒ¼ãƒˆé¸æŠUIãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
        selectedSheet = defaultSheetName;
        lastSelectedSheetName = defaultSheetName;
        console.log('â„¹ï¸ ã‚·ãƒ¼ãƒˆé¸æŠUIãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š:', defaultSheetName);
      }
    }
    
    // Phase 6: ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã®ç¢ºå®Ÿãªè¡¨ç¤º
    console.log('ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’UIã«åæ˜ ä¸­...');
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æˆåŠŸã‚’ç®¡ç†ãƒ‘ãƒãƒ«ã«åæ˜ 
    if (result.formUrl) {
      console.log('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ URLç¢ºèª:', result.formUrl);
      
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯ã®è¡¨ç¤ºæ›´æ–°ï¼ˆè¤‡æ•°ã®æ–¹æ³•ã§æ›´æ–°ï¼‰
      const formLinkElements = document.querySelectorAll('[data-form-url], .form-url-link, #form-link');
      formLinkElements.forEach(element => {
        element.href = result.formUrl;
        element.textContent = 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
        element.style.display = 'inline-block';
      });
      
      // ãƒ•ã‚©ãƒ¼ãƒ URLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ›´æ–°
      const formUrlInput = document.getElementById('form-url-input');
      if (formUrlInput) {
        formUrlInput.value = result.formUrl;
      }
    }
    
    if (result.spreadsheetUrl) {
      console.log('ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLç¢ºèª:', result.spreadsheetUrl);
      
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒªãƒ³ã‚¯ã®è¡¨ç¤ºæ›´æ–°
      const spreadsheetLinkElements = document.querySelectorAll('[data-spreadsheet-url], .spreadsheet-url-link, #spreadsheet-link');
      spreadsheetLinkElements.forEach(element => {
        element.href = result.spreadsheetUrl;
        element.textContent = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã';
        element.style.display = 'inline-block';
      });
      
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ›´æ–°
      const spreadsheetUrlInput = document.getElementById('spreadsheet-url-input');
      if (spreadsheetUrlInput) {
        spreadsheetUrlInput.value = result.spreadsheetUrl;
      }
    }
    
    if (result.folderUrl) {
      console.log('ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€URLç¢ºèª:', result.folderUrl);
      
      // ãƒ•ã‚©ãƒ«ãƒ€ãƒªãƒ³ã‚¯æ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ
    }
    
    // ç®¡ç†ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹è¡¨ç¤ºã‚’æ›´æ–°
    const statusDisplay = document.querySelector('.status-display, #setup-status');
    if (statusDisplay) {
      statusDisplay.textContent = 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†';
      statusDisplay.className = 'status-display setup-completed';
    }
    
    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒãƒƒã‚¸ã®è¡¨ç¤º
    const setupBadge = document.querySelector('.setup-badge, #setup-completion-badge');
    if (setupBadge) {
      setupBadge.textContent = 'âœ… ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†';
      setupBadge.style.display = 'inline-block';
      setupBadge.className = 'setup-badge completed';
    }
    
    // Phase 7: ç®¡ç†ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹æ›´æ–°ã¨URLè¡¨ç¤º
    console.log('ğŸ›ï¸ ç®¡ç†ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°ä¸­...');
    
    // å›ç­”ãƒœãƒ¼ãƒ‰URLç”Ÿæˆã¨è¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
    if (result.autoPublished) {
      let boardUrl = null;
      
      // 1. freshStatusã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
      if (freshStatus && (freshStatus.viewUrl || (freshStatus.webAppUrl && freshStatus.userId))) {
        boardUrl = freshStatus.viewUrl || (freshStatus.webAppUrl + '?mode=view&userId=' + freshStatus.userId);
        console.log('ğŸ”— å›ç­”ãƒœãƒ¼ãƒ‰URLç”Ÿæˆ (freshStatus):', boardUrl);
      }
      
      // 2. freshStatusãŒä¸å®Œå…¨ãªå ´åˆã€currentStatusã‹ã‚‰æ§‹ç¯‰
      if (!boardUrl && typeof currentStatus !== 'undefined' && currentStatus) {
        const webAppUrl = currentStatus.webAppUrl || (currentStatus.appUrls && currentStatus.appUrls.webAppUrl);
        const userId = currentStatus.userId || (currentStatus.userInfo && currentStatus.userInfo.userId);
        if (webAppUrl && userId) {
          boardUrl = webAppUrl + '?mode=view&userId=' + userId;
          console.log('ğŸ”— å›ç­”ãƒœãƒ¼ãƒ‰URLç”Ÿæˆ (currentStatus):', boardUrl);
        }
      }
      
      // 3. æœ€çµ‚çš„ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå›ºå®šURLãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      if (!boardUrl) {
        // Apps Scriptã®Webã‚¢ãƒ—ãƒªURLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
        const fallbackUrl = 'https://script.google.com/a/naha-okinawa.ed.jp/macros/s/AKfycbyq0CohJCpwb8KYJQrba4pWhvtss5HD2nKDPMuzPBX2EOftIAI2UbtjjyEn4N52TCzX/exec';
        const userId = 'b3b2fba8-6565-4cd3-96e9-c47ea6660a80'; // ãƒ­ã‚°ã‹ã‚‰å–å¾—ã—ãŸuserId
        boardUrl = fallbackUrl + '?mode=view&userId=' + userId;
        console.log('ğŸ”— å›ç­”ãƒœãƒ¼ãƒ‰URLç”Ÿæˆ (fallback):', boardUrl);
      }
      
      if (boardUrl) {
        // Board URLè¡¨ç¤ºã®æ›´æ–°
        const boardUrlInput = document.getElementById('board-url');
        if (boardUrlInput) {
          boardUrlInput.value = boardUrl;
        }
        
        // View board linkã®æ›´æ–°
        const viewLink = document.getElementById('view-board-link');
        if (viewLink) {
          viewLink.href = boardUrl;
          viewLink.style.display = 'inline-block';
        }
        
        // Footer guidanceæ›´æ–°
        if (typeof updateFooterAndGuidance === 'function') {
          updateFooterAndGuidance();
        }
      } else {
        console.warn('âš ï¸ å›ç­”ãƒœãƒ¼ãƒ‰URLã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    // Form sectionçŠ¶æ…‹ã®æ›´æ–°
    console.log('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹æ›´æ–°ä¸­...');
    const formSection = document.querySelector('.form-section');
    if (formSection) {
      formSection.classList.add('setup-completed');
    }
    
    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è©³ç´°æƒ…å ±ã‚’å«ã‚ã‚‹
    const successDetails = [
      'âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ',
      'âœ… AIåˆ—åˆ¤å®šã‚’è‡ªå‹•å®Ÿè¡Œ',
      'âœ… è¨­å®šã‚’è‡ªå‹•ä¿å­˜ãƒ»é©ç”¨'
    ];
    
    if (result.autoPublished) {
      successDetails.push('âœ… å›ç­”ãƒœãƒ¼ãƒ‰ã‚’è‡ªå‹•å…¬é–‹');
    }
    
    const successMessage = 'ğŸ‰ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹ã—ã¦ãã ã•ã„ã€‚';
    showMessage(successMessage, 'success');
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹éè¡¨ç¤º
    setTimeout(() => {
      hideCustomSetupProgress();
      // è¿½åŠ ã®çŠ¶æ…‹åæ˜ ç¢ºèª
    }, 2000);
    
  } catch (error) {
      console.error('âŒ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
      
      // é€²æ—è¡¨ç¤ºã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      updateCustomOverallProgress(0, 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      updateCustomProgressStep(7, 'error', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¤±æ•—', 'âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      
      // è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
      console.error('âŒ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è©³ç´°ã‚¨ãƒ©ãƒ¼:', {
        message: error.message,
        stack: error.stack,
        timestamp: new Date().toISOString()
      });
      
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†
      if (error.message && error.message.includes('timed out')) {
        console.log('â³ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ¤œå‡º - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹');
        updateCustomProgressStep(7, 'active', 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¶™ç¶šä¸­', 'â³ å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™...');
        
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ã‚’å¾…ã¤ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ï¼ˆå®Ÿè£…ãŒã‚ã‚Œã°ï¼‰
        if (typeof startBackendCompletionPolling === 'function') {
          startBackendCompletionPolling();
        }
        return; // ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ãšã«çµ‚äº†
      }
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
      let userFriendlyMessage;
      if (error.message.includes('Permission denied') || error.message.includes('æ¨©é™')) {
        userFriendlyMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: Googleãƒ‰ãƒ©ã‚¤ãƒ–ã¾ãŸã¯ãƒ•ã‚©ãƒ¼ãƒ ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
      } else if (error.message.includes('Network') || error.message.includes('network')) {
        userFriendlyMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
      } else if (error.message.includes('AppsScript is not defined') || error.message.includes('getWebAppUrl')) {
        userFriendlyMessage = 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„';
      } else if (error.message.includes('ã‚·ãƒ¼ãƒˆåãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“')) {
        userFriendlyMessage = 'ã‚·ãƒ¼ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒ¼ãƒˆåã§ç¶™ç¶šå‡¦ç†ã—ã¾ã™';
        console.log('â„¹ï¸ ã‚·ãƒ¼ãƒˆåã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã—ã¦ç¶™ç¶šå‡¦ç†');
      } else {
        userFriendlyMessage = 'ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
      }
      
      // è»½å¾®ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è­¦å‘Šãƒ¬ãƒ™ãƒ«ã§è¡¨ç¤º
      const isMinorError = error.message.includes('AppsScript is not defined') || 
                          error.message.includes('ã‚·ãƒ¼ãƒˆåãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      
      if (isMinorError) {
        showMessage(userFriendlyMessage, 'warning');
        console.log('â„¹ï¸ è»½å¾®ãªã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å‡¦ç†:', error.message);
      } else {
        showMessage(userFriendlyMessage, 'error');
      }
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹éè¡¨ç¤º
      setTimeout(() => {
        hideCustomSetupProgress();
      }, 3000);
      
      throw error;
    }
  });
}

// Handle quick start setup
async function handleQuickStart() {
  const flowId = 'quickStart';
  
  return await flowExecutionManager.executeWithLock(flowId, async () => {
    const quickstartBtn = document.getElementById('quickstart-btn');
    const quickstartText = document.getElementById('quickstart-text');
    
    if (!quickstartBtn || !quickstartText) {
      throw new Error('QuickStart elements not found');
    }

    console.log('ğŸš€ QuickStartå®Ÿè¡Œé–‹å§‹ï¼ˆçµ±ä¸€ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ç‰ˆï¼‰');

  // ç¾åœ¨ã®å…¬é–‹çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦é©åˆ‡ãªå‡¦ç†ã‚’å®Ÿè¡Œ
  const isCurrentlyPublished = currentStatus && 
                               currentStatus._normalized && 
                               currentStatus._normalized.isPublished;
  
  console.log('ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œ: å…¬é–‹çŠ¶æ…‹=' + isCurrentlyPublished);

  if (isCurrentlyPublished) {
    // å…¬é–‹ä¸­ã®å ´åˆ: ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    if (window.sharedModals && typeof window.sharedModals.showQuickStartStopConfirmation === 'function') {
      window.sharedModals.showQuickStartStopConfirmation(
        () => {
          // åœæ­¢ã—ã¦æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
          executeStopAndQuickStart(quickstartBtn, quickstartText);
        },
        () => {
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®å‡¦ç†
          console.log('âŒ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
          resetQuickStartButton(quickstartBtn, quickstartText);
        }
      );
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ¨™æº–confirm
      const confirmMessage = 'ç¾åœ¨å…¬é–‹ä¸­ã®å›ç­”ãƒœãƒ¼ãƒ‰ã‚’åœæ­¢ã—ã¦ã€æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nâ€¢ æ—¢å­˜ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™\nâ€¢ æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ\nâ€¢ é«˜ç²¾åº¦AIåˆ—åˆ¤å®šã‚’å®Ÿè¡Œ\nâ€¢ ä½œæˆå®Œäº†å¾Œã«è‡ªå‹•ã§å†å…¬é–‹';
      
      if (confirm(confirmMessage)) {
        executeStopAndQuickStart(quickstartBtn, quickstartText);
      } else {
        resetQuickStartButton(quickstartBtn, quickstartText);
      }
    }
    } else {
      // éå…¬é–‹ã®å ´åˆ: ç›´æ¥ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œï¼ˆè‡ªå‹•å…¬é–‹ãƒ•ãƒ©ã‚°ä»˜ãï¼‰
      console.log('ğŸ“ ç¾åœ¨éå…¬é–‹ã®ãŸã‚ã€ç›´æ¥ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆè‡ªå‹•å…¬é–‹ï¼‰');
      return await executeQuickStartProcess(quickstartBtn, quickstartText, true); // autoPublish = true
    }
  });
}


// å…¬é–‹åœæ­¢ã¨ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®çµ±åˆå‡¦ç†
function executeStopAndQuickStart(quickstartBtn, quickstartText) {
  console.log('ğŸ›‘ğŸ“‹ å…¬é–‹åœæ­¢â†’ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®çµ±åˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™');
  
  // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
  quickstartBtn.disabled = true;
  quickstartText.textContent = 'å…¬é–‹åœæ­¢ä¸­...';
  
  // 1. ã¾ãšå…¬é–‹åœæ­¢å‡¦ç†ã‚’å®Ÿè¡Œ
  if (typeof unpublishBoard === 'function') {
    showMessage('ç¾åœ¨ã®å›ç­”ãƒœãƒ¼ãƒ‰ã‚’åœæ­¢ã—ã¦ã„ã¾ã™...', 'info');
    
    unpublishBoard()
      .then(function(stopResult) {
        showMessage('âœ… å…¬é–‹åœæ­¢ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™...', 'success');

        // Immediately update footer to reflect unpublished state
        if (typeof updateFooterAndGuidance === 'function') {
          updateFooterAndGuidance(stopResult);
        }
        window.lastStatusCache = stopResult;

        // å…¬é–‹åœæ­¢ãŒå®Œäº†ã—ãŸã‚‰ã€å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’å®Ÿè¡Œ
        setTimeout(() => {
          quickstartText.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...';
          console.log('ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆè‡ªå‹•å…¬é–‹ãƒ¢ãƒ¼ãƒ‰ï¼‰');
          
          // 2. ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œï¼ˆè‡ªå‹•å…¬é–‹ãƒ•ãƒ©ã‚°ä»˜ãï¼‰
          executeQuickStartProcess(quickstartBtn, quickstartText, true);
        }, 1000);
      })
      .catch(function(stopError) {
        console.error('âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ:', stopError);
        let errorMessage = 'âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        
        // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ã¦ã‚ˆã‚Šå…·ä½“çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (stopError.message && stopError.message.includes('customFormInfo')) {
          errorMessage = 'âŒ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        } else if (stopError.message && stopError.message.includes('è¨±å¯ã•ã‚Œã¦ã„ãªã„')) {
          errorMessage = 'âŒ ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ¨©é™ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
        } else if (stopError.message && stopError.message.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯')) {
          errorMessage = 'âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        }
        
        showMessage(errorMessage, 'error');
        resetQuickStartButton(quickstartBtn, quickstartText);
      });
  } else {
    console.error('âŒ unpublishBoard function not found');
    showMessage('âŒ å…¬é–‹åœæ­¢æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    resetQuickStartButton(quickstartBtn, quickstartText);
  }
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
function resetQuickStartButton(quickstartBtn, quickstartText) {
  if (quickstartBtn && quickstartText) {
    quickstartBtn.disabled = false;
    quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
  }
  
  // å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚‚ã‚¯ãƒªã‚¢
  isQuickStartInProgress = false;
  console.log('ğŸ”“ QuickStartãƒªã‚»ãƒƒãƒˆ - å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢');
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã®å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œ
function executeQuickStartProcess(quickstartBtn, quickstartText, autoPublish = false) {
  // Update button state
  quickstartBtn.disabled = true;
  quickstartText.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...';
  
  // Show progress bar and start simulation
  showQuickStartProgress();
  simulateQuickStartProgress();
  
  // Show loading message optimized for QuickStart
  // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆä¸­ã¯å°‚ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€æ±ç”¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯è¡¨ç¤ºã—ãªã„
  
  runGasWithUserId('quickStartSetup', false)
    .then(function(result) {
      if (result && result.status === 'success') {
        console.log('ğŸ‰ QuickStartãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†å®Œäº†:', result);
        
        // Save QuickStart history entry - ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ
        if (result.setupComplete && typeof addToSimpleHistory === 'function') {
          try {
            const historyItem = {
              questionText: result.userInfo?.customFormInfo?.mainQuestion || 'QuickStartè¨­å®š',
              displayMode: 'NAMED',
              configData: result.userInfo?.configJson ? JSON.parse(result.userInfo.configJson) : {}
            };
            addToSimpleHistory(historyItem);
            console.log('ğŸ“ QuickStartå±¥æ­´ä¿å­˜å®Œäº†ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰');
          } catch (error) {
            console.error('âŒ QuickStartå±¥æ­´ä¿å­˜ã«å¤±æ•—:', error);
          }
        }
        
        // Enhanced completion notification with detailed backend response
        updateOverallProgress(100, result.autoPublished ? 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†ï¼ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼' : 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†ï¼');
        updateProgressStep(2, 'completed', 'ãƒœãƒ¼ãƒ‰è¨­å®šã¨è‡ªå‹•å…¬é–‹', 'ğŸ‰ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        
        // Enhanced message display based on actual backend results
        const publishStatus = result.autoPublished ? 'å…¬é–‹ã•ã‚Œã¾ã—ãŸ' : 'ä½œæˆã•ã‚Œã¾ã—ãŸ';
        let detailMessage;
        
        if (result.autoPublished) {
          detailMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ãŒè‡ªå‹•ä½œæˆãƒ»å…¬é–‹ã•ã‚Œã¾ã—ãŸï¼ã™ãã«åˆ©ç”¨ã§ãã¾ã™ã€‚';
        } else {
          // Check if there's a specific reason for auto-publish failure
          const publishError = result.publishResult && result.publishResult.error;
          const manualInstructions = result.publishResult && result.publishResult.manualPublishInstructions;
          
          detailMessage = 'ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚';
          if (publishError) {
            detailMessage += 'è‡ªå‹•å…¬é–‹ã«å¤±æ•—ã—ãŸãŸã‚ï¼ˆ' + publishError + 'ï¼‰ã€';
          }
          if (manualInstructions) {
            detailMessage += manualInstructions;
          } else {
            detailMessage += 'ç®¡ç†ãƒ‘ãƒãƒ«ã‹ã‚‰æ‰‹å‹•ã§å…¬é–‹ã—ã¦ãã ã•ã„ã€‚';
          }
        }
        
        showMessage('ğŸ‰ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼' + detailMessage, 'success');
        
        // Update progress step with auto-publish status
        updateProgressStep(5, 'completed', 'å›ç­”ãƒœãƒ¼ãƒ‰ä½œæˆå®Œäº†', 'ğŸ“ è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹ã—ã¦ãã ã•ã„');
        
        // QuickStartæˆåŠŸå®Œäº† - å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
        isQuickStartInProgress = false;
        console.log('ğŸ”“ QuickStartæˆåŠŸå®Œäº† - å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢');
        
        // Log detailed completion status
        console.log('ğŸ“Š QuickStartå®Œäº†è©³ç´°:', {
          setupComplete: result.setupComplete,
          autoPublished: result.autoPublished,
          publishResult: result.publishResult,
          completedSteps: result.completedSteps,
          completedAt: result.completedAt
        });
        
        // Log auto-publish specific information if available
        if (result.publishResult) {
          console.log('ğŸŒ è‡ªå‹•å…¬é–‹çµæœè©³ç´°:', {
            success: result.publishResult.success,
            published: result.publishResult.published,
            publishedAt: result.publishResult.publishedAt,
            error: result.publishResult.error,
            manualInstructions: result.publishResult.manualPublishInstructions
          });
        }
        
        // Update status after quick start
        if (result.updatedConfig) {
          const newStatus = { ...currentStatus, ...result.updatedConfig, userInfo: { ...currentStatus.userInfo, configJson: JSON.stringify(result.updatedConfig) } };
          updateUIWithNewStatus(newStatus);
        } else {
          // å®‰å®šã—ãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å†èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‰Šé™¤ï¼‰
          simpleStatusRefresh();
        }
        
        // QuickStartãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªï¼ˆåŒ…æ‹¬çš„ãªå®Œäº†çŠ¶æ…‹æ¤œè¨¼ï¼‰
        setTimeout(async () => {
          try {
            const sheetName = result.sheetName || result.publishedSheetName || 'unknown_sheet';
            const completionResult = await verifySetupFlowCompletion('quickstart', sheetName);
            
            if (completionResult.success) {
              console.log('ğŸ‰ QuickStartãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèª: å…¨è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™', completionResult.details);
              
              // æˆåŠŸæ™‚ã¯è¿½åŠ å‡¦ç†ä¸è¦ï¼ˆç°¡ç´ åŒ–ï¼‰
            } else {
              console.warn('âš ï¸ QuickStartãƒ•ãƒ­ãƒ¼: æœªå®Œäº†é …ç›®ãŒã‚ã‚Šã¾ã™', completionResult.issues);
              // ç°¡ç´ åŒ–: è¿½åŠ ã®åŒæœŸå‡¦ç†ã¯å®Ÿè¡Œã—ãªã„
            }
          } catch (verificationError) {
            console.error('âŒ QuickStartãƒ•ãƒ­ãƒ¼å®Œäº†ç¢ºèªã‚¨ãƒ©ãƒ¼:', verificationError);
          }
        }, 2000);
        
        // å…¬é–‹æ™‚ã¯å±¥æ­´ä¿å­˜ã‚’è¡Œã‚ãªã„ï¼ˆå…¬é–‹åœæ­¢æ™‚ã«ä¿å­˜ã™ã‚‹ãŸã‚ï¼‰
        logDebug('QuickStart completed - history will be saved on unpublish');
        
        // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        sessionStorage.setItem('form_just_created', 'true');
        
        // QuickStartå®Œäº†æ™‚ã®çµ±åˆUIæ›´æ–°å‡¦ç†ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        setTimeout(() => {
          console.log('ğŸ”„ QuickStartå®Œäº†: çµ±åˆUIæ›´æ–°ã‚’é–‹å§‹');
          
          // æœ€é‡è¦: ãƒ‡ãƒã‚¦ãƒ³ã‚¹åˆ¶å¾¡ã«ã‚ˆã‚‹å®‰å…¨ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
          console.log('ğŸš€ Loading system status with debounce control');
          if (window.AdminPanel && window.AdminPanel.debounce) {
            window.AdminPanel.debounce.loadStatus(() => {
              loadStatus(true).then(() => {
                console.log('âœ… QuickStartå®Œäº†å¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å®Œäº†ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹åˆ¶å¾¡ï¼‰');
            
            // ã™ã¹ã¦ã®UIæ›´æ–°ã‚’1å›ã®å‡¦ç†ã§ã¾ã¨ã‚ã¦å®Ÿè¡Œ
            updateFormUrlDisplay();
            
            // äºˆå®šçµ‚äº†æ™‚é–“ã®è¡¨ç¤ºã‚’æ›´æ–°
            const scheduledEndTimeElement = document.getElementById('scheduled-end-time');
            if (scheduledEndTimeElement && window.lastStatusCache && window.lastStatusCache.config) {
              updateScheduledEndTime(window.lastStatusCache.config, scheduledEndTimeElement);
            }
            
            // å…¬é–‹åœæ­¢ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            if (typeof updateUnpublishButton === 'function' && window.lastStatusCache) {
              updateUnpublishButton(window.lastStatusCache);
            }
            
            // ãƒ•ãƒƒã‚¿ãƒ¼è¡¨ç¤ºã®æœ€çµ‚æ›´æ–°ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹æ©Ÿèƒ½ã«ã‚ˆã‚Šæœ€é©åŒ–æ¸ˆã¿ï¼‰
            if (window.updateFooterAndGuidance && typeof window.updateFooterAndGuidance === 'function') {
              window.updateFooterAndGuidance(window.lastStatusCache || result);
            }
              }).catch(error => {
                console.error('âŒ QuickStartå®Œäº†å¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ã§ã‚‚UIæ›´æ–°ã¯å®Ÿè¡Œ
                updateFormUrlDisplay();
              });
            }, 300); // ãƒ‡ãƒã‚¦ãƒ³ã‚¹é…å»¶
          } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ©Ÿèƒ½ãŒãªã„å ´åˆ
            loadStatus(true).then(() => {
              console.log('âœ… QuickStartå®Œäº†å¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å®Œäº†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰');
              updateFormUrlDisplay();
            }).catch(error => {
              console.error('âŒ QuickStartå®Œäº†å¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰:', error);
            });
          }
          
        }, 1200); // å°‘ã—é…å»¶ã‚’å¢—ã‚„ã—ã¦ä»–ã®å‡¦ç†ã®å®Œäº†ã‚’å¾…ã¤
        
        // å›ç­”ãƒœãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†ã‚’é€šçŸ¥ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯æ›´æ–°ç”¨ï¼‰
        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'FORM_CREATED',
              formUrl: result.formUrl,
              timestamp: Date.now()
            }, '*');
          }
          
          if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('board-updates');
            channel.postMessage({
              type: 'FORM_CREATED',
              formUrl: result.formUrl,
              timestamp: Date.now()
            });
            channel.close();
          }
        } catch (notifyError) {
          console.warn('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆé€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼:', notifyError);
        }
        
        // Reset button state
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†';
        
        // è‡ªå‹•å…¬é–‹ã®å ´åˆã®ã¿è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        if (autoPublish) {
          console.log('ğŸš€ è‡ªå‹•å…¬é–‹ãŒæœ‰åŠ¹ãªãŸã‚ã€è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™');
          
          setTimeout(() => {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            if (window.unifiedLoadingManager) {
              window.unifiedLoadingManager.setLoading(false);
            }
            
            // URLç”Ÿæˆç¢ºèªã¨ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’å®Ÿè¡Œ
            const enhancedResult = {
              ...result,
              url: (result && result.url) || '',
              autoStopMinutes: (result && result.autoStopMinutes) || 360,
              autoStopTime: (result && result.autoStopTime) || '',
              publicationData: {
                isPublished: (result && result.success) || false,
                hasValidUrl: !!(result && result.url && result.url.length > 0),
                timestamp: new Date().toISOString()
              }
            };
            
            console.log('ğŸ“Š QuickStartå…¬é–‹ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼:', {
              autoPublish: autoPublish,
              hasResult: !!result,
              hasUrl: !!(result && result.url && result.url.length > 0),
              enhancedResult: enhancedResult
            });
            
            // è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆæ¤œè¨¼æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã§ï¼‰
            setTimeout(() => {
              if (window.sharedModals && typeof window.sharedModals.showAutoStopConfirmation === 'function') {
                window.sharedModals.showAutoStopConfirmation(enhancedResult);
              } else {
                console.warn('âš ï¸ è‡ªå‹•åœæ­¢ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              }
            }, 800);
          }, 2000);
        } else {
          console.log('â„¹ï¸ è‡ªå‹•å…¬é–‹ãŒç„¡åŠ¹ã®ãŸã‚ã€è‡ªå‹•åœæ­¢ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
        }
        
        // Hide progress bar after delay and reset button
        setTimeout(() => {
          hideQuickStartProgress();
          quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
          quickstartBtn.disabled = false;
        }, 5000);
      } else {
        logWarn('QuickStart returned error result:', result);
        
        // Show error in progress
        updateProgressStep(6, 'error', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', (result && result.message) || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        updateOverallProgress(0, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        let errorMessage = (result && result.message) || 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        if (errorMessage.includes('permission') || errorMessage.includes('æ¨©é™') || 
            errorMessage.includes('Drive') || errorMessage.includes('Sheets')) {
          errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Google Drive ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ãªã„å ´åˆã€æ¨©é™ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
        }
        
        showMessage(errorMessage, 'error');
        
        quickstartBtn.disabled = false;
        quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
        
        // Hide progress bar after delay
        setTimeout(() => {
          hideQuickStartProgress();
        }, 3000);
      }
    })
    .catch(function(error) {
      logError('QuickStart error:', error);
      
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã®ç‰¹åˆ¥å‡¦ç†ï¼ˆCustomSetupãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨ï¼‰
      if (error.toString().includes('timeout') || error.toString().includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
        console.log('â³ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ¤œå‡º - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹');
        updateProgressStep(6, 'active', 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆç¶™ç¶šä¸­', 'â³ å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™...');
        showMessage('â³ å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å‡¦ç†ã‚’ç¶™ç¶šä¸­ã§ã™...', 'info');
        
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†ã‚’å¾…ã¤ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        startQuickStartPolling(quickstartBtn, quickstartText);
        return; // ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ãšã«çµ‚äº†
      }
      
      // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯å¾“æ¥é€šã‚Š
      updateProgressStep(6, 'error', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      updateOverallProgress(0, 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      
      // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      if (error.toString().includes('permission') || error.toString().includes('æ¨©é™') || 
          error.toString().includes('Drive') || error.toString().includes('Sheets')) {
        errorMessage = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Google Drive ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ãªã„å ´åˆã€æ¨©é™ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
      }
      
      if (typeof handleError === 'function') {
        handleError(error, 'handleQuickStart', errorMessage);
      } else {
        showMessage(errorMessage, 'error');
      }
      
      quickstartBtn.disabled = false;
      quickstartText.textContent = 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é–‹å§‹';
      
      // QuickStartã‚¨ãƒ©ãƒ¼å®Œäº† - å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
      isQuickStartInProgress = false;
      console.log('ğŸ”“ QuickStartã‚¨ãƒ©ãƒ¼å®Œäº† - å¤šé‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢');
      
      // Hide progress bar after delay
      setTimeout(() => {
        hideQuickStartProgress();
      }, 3000);
    });
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// API initialization is now handled in adminPanel-framework.js.html

// =============================================================================
// MISSING FUNCTIONS RESTORATION
// =============================================================================

// Debounced wrapper for loadStatus to prevent rapid successive calls
function debouncedLoadStatus(bypassCache = false) {
  if (window.AdminPanel && window.AdminPanel.debounce) {
    window.AdminPanel.debounce.loadStatus(() => {
      loadStatus(bypassCache);
    });
  } else {
    // Fallback without debouncing
    loadStatus(bypassCache);
  }
}

// Wrapper for loadStatus to maintain compatibility
function loadSystemStatus(bypassCache = false) {
  // Use debounced version unless bypassCache is true (urgent calls)
  if (bypassCache) {
    loadStatus(bypassCache);
  } else {
    debouncedLoadStatus(bypassCache);
  }
}

// Basic loadUserInfo implementation
function loadUserInfo() {
  logDebug('ğŸ“‹ loadUserInfo called - delegating to debounced loadStatus');
  debouncedLoadStatus();
}

// Update answer count function
function updateAnswerCount() {
  if (!currentStatus || !currentStatus._normalized || !currentStatus._normalized.isPublished) {
    return;
  }
  
  const answerCountElement = document.getElementById('answer-count');
  if (answerCountElement && currentStatus.answerCount !== undefined) {
    answerCountElement.textContent = currentStatus.answerCount || '0';
  }
}

// Setup real-time updates
function setupRealtimeUpdates() {
  // Update system status every 30 seconds
  setInterval(loadSystemStatus, 30000);
  
  // Update answer count every 10 seconds when published
  setInterval(() => {
    const publishText = document.getElementById('info-publish-text');
    if (publishText && publishText.textContent === 'å…¬é–‹ä¸­') {
      updateAnswerCount();
    }
  }, 10000);
}

// Initialize when DOM is ready
// åˆæœŸåŒ–ã¯ adminPanel-core.js ã®çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ã§ç®¡ç†ã•ã‚Œã¾ã™

//# sourceURL=adminPanel-api.js.html


let lastSelectedSheetName = null; // To prevent redundant sheet selection change events

// === ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã•ã‚ŒãŸUIæ›´æ–°ã‚·ã‚¹ãƒ†ãƒ  ===
// è¤‡é›‘ãªåˆ¶å¾¡æ©Ÿæ§‹ã‚’é™¤å»ã—ã€å¿…è¦æœ€å°é™ã®å¤‰æ•°ã®ã¿ä¿æŒ
// æ³¨æ„: window.currentStatus ã¯ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯åˆ¥åã‚’ä½¿ç”¨

// =============================================================================
// EARLY FUNCTION DEFINITIONS (Critical functions that must be available immediately)
// =============================================================================

// Define critical functions early and register them globally
if (typeof window !== 'undefined') {
  // Placeholder functions that will be properly defined later
  // All critical functions are now defined in adminPanel-framework.js.html which loads first
  // Keeping only functions not moved to framework
  window.hideFormConfigModal = window.hideFormConfigModal || function() { logWarn('hideFormConfigModal not yet loaded'); };
  window.showPrivacyModal = window.showPrivacyModal || function() { logWarn('showPrivacyModal not yet loaded'); };
}


// =============================================================================
// ADMIN PANEL UI UPDATES & DISPLAY CONTROL
// =============================================================================

// =============================================================================
// UTILITY FUNCTIONS
// =============================================================================

// å¼·åŒ–ã•ã‚ŒãŸå…¬é–‹çŠ¶æ…‹åˆ¤å®š - ãƒªã‚½ãƒ¼ã‚¹æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ä»˜ã
function getPublicationState(status) {
  if (!status) {
    return { isPublished: false, reason: 'No status data' };
  }
  
  // Check multiple possible publication indicators in priority order
  let isPublished = false;
  let reason = '';
  
  let confidence = 'high';
  let validationDetails = {};

  // è¨­å®šãƒ‡ãƒ¼ã‚¿ã®è§£æ
  let config = null;
  if (status.userInfo && status.userInfo.configJson) {
    try {
      config = JSON.parse(status.userInfo.configJson);
    } catch (e) {
      logWarn('Failed to parse configJson:', e);
      return { isPublished: false, reason: 'configJsonè§£æã‚¨ãƒ©ãƒ¼', confidence: 'low' };
    }
  }

  // 1. åŸºæœ¬çš„ãªå…¬é–‹ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯
  const appPublishedFromStatus = status.appPublished;
  const appPublishedFromConfig = config ? config.appPublished : undefined;
  
  // 2. å®Ÿéš›ã®å…¬é–‹ãƒªã‚½ãƒ¼ã‚¹ã®å­˜åœ¨ç¢ºèª
  const hasFormUrl = !!(config && config.formUrl);
  const hasPublishedSheet = !!(config && config.publishedSheetName);
  const hasPublishedSpreadsheet = !!(config && config.publishedSpreadsheetId);
  const setupCompleted = !!(config && config.setupStatus === 'completed');
  const formCreated = !!(config && config.formCreated);
  
  validationDetails = {
    appPublishedFromStatus,
    appPublishedFromConfig,
    hasFormUrl,
    hasPublishedSheet,
    hasPublishedSpreadsheet,
    setupCompleted,
    formCreated
  };

  // 3. å…¬é–‹çŠ¶æ…‹ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè¤‡æ•°ã®æ¡ä»¶ã‚’ç·åˆçš„ã«è©•ä¾¡ï¼‰
  if (appPublishedFromStatus === true) {
    // status.appPublished ãŒæ˜ç¤ºçš„ã« true ã®å ´åˆ
    if (hasFormUrl && hasPublishedSheet && setupCompleted) {
      isPublished = true;
      reason = 'status.appPublished=true (ãƒªã‚½ãƒ¼ã‚¹ç¢ºèªæ¸ˆã¿)';
      confidence = 'high';
    } else {
      // appPublished=true ã ãŒå¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ãŒä¸è¶³
      isPublished = true;
      reason = 'status.appPublished=true (ãƒªã‚½ãƒ¼ã‚¹ä¸å®Œå…¨)';
      confidence = 'medium';
    }
  } else if (appPublishedFromStatus === false) {
    isPublished = false;
    reason = 'status.appPublished=false (æ˜ç¤ºçš„éå…¬é–‹)';
  } else if (appPublishedFromConfig === true) {
    // configJson ã‹ã‚‰åˆ¤å®š
    if (hasFormUrl && hasPublishedSheet && setupCompleted) {
      isPublished = true;
      reason = 'configJson.appPublished=true (ãƒªã‚½ãƒ¼ã‚¹ç¢ºèªæ¸ˆã¿)';
      confidence = 'high';
    } else {
      isPublished = true;
      reason = 'configJson.appPublished=true (ãƒªã‚½ãƒ¼ã‚¹ä¸å®Œå…¨)';
      confidence = 'medium';
    }
  } else if (hasFormUrl && hasPublishedSheet && setupCompleted && formCreated) {
    // ãƒ•ãƒ©ã‚°ã¯false/æœªå®šç¾©ã ãŒã€å®Ÿéš›ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼ˆQuickStartç›´å¾Œãªã©ï¼‰
    isPublished = true;
    reason = 'ãƒªã‚½ãƒ¼ã‚¹å­˜åœ¨ã«ã‚ˆã‚‹åˆ¤å®š (ãƒ•ãƒ©ã‚°æœªæ›´æ–°)';
    confidence = 'medium';
  } else {
    isPublished = false;
    reason = appPublishedFromConfig === false ? 'configJson.appPublished=false' : 'å…¬é–‹æƒ…å ±ãªã—';
  }
  
  // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
  if (typeof shouldEnableDebugMode === 'function' && shouldEnableDebugMode()) {
    console.log('ğŸ” Enhanced Publication check:', {
      result: isPublished,
      reason,
      confidence,
      validation: validationDetails
    });
  } else if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
    console.log('ğŸ” Enhanced Publication check:', {
      result: isPublished,
      reason,
      confidence,
      validation: validationDetails
    });
  }
  
  return { 
    isPublished, 
    reason,
    confidence,
    validationDetails
  };
}

// Generate viewUrl with comprehensive fallback logic
function generateViewUrl(status, userId) {
  // 1. Use existing viewUrl if available
  let viewUrl = status.appUrls && status.appUrls.viewUrl;
  if (viewUrl) {
    return viewUrl;
  }
  
  // 2. Generate from appUrls.webApp with userId
  if (status.appUrls && status.appUrls.webApp && userId) {
    return `${status.appUrls.webApp}?userId=${encodeURIComponent(userId)}&mode=view`;
  }
  
  // 3. Generate from status.webAppUrl with userId
  if (status.webAppUrl && userId) {
    return `${status.webAppUrl}?userId=${encodeURIComponent(userId)}&mode=view`;
  }
  
  // 4. Simple fallback without userId
  if (status.appUrls && status.appUrls.webApp) {
    return status.appUrls.webApp + '?mode=view';
  }
  
  logWarn('Could not generate viewUrl');
  return null;
}

/**
 * è¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰å…¬é–‹çŠ¶æ…‹ã‚’ç¢ºå®Ÿã«åˆ¤å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 * @param {object} status - ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {boolean} - å…¬é–‹çŠ¶æ…‹
 */
function determinePublicationStatus(status) {
  if (!status) return false;
  
  // 1. _normalizedã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ï¼ˆæœ€å„ªå…ˆï¼‰
  if (status._normalized && typeof status._normalized.isPublished === 'boolean') {
    console.log('ğŸ“Š Publication status from _normalized:', status._normalized.isPublished);
    return status._normalized.isPublished;
  }
  
  // 2. statusç›´ä¸‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ï¼ˆ_normalizedæœªç”Ÿæˆæ™‚ã®å„ªå…ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  if (typeof status.isPublished === 'boolean') {
    console.log('ğŸ” Publication status from status.isPublished:', status.isPublished);
    return status.isPublished;
  }
  
  if (status.config && typeof status.config.isPublished === 'boolean') {
    console.log('ğŸ” Publication status from status.config.isPublished:', status.config.isPublished);
    return status.config.isPublished;
  }
  
  if (typeof status.appPublished === 'boolean') {
    console.log('ğŸ” Publication status from status.appPublished:', status.appPublished);
    return status.appPublished;
  }
  
  // 3. configJsonã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆã‚ˆã‚Šä¿¡é ¼æ€§ã®ä½ã„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  if (status.userInfo && status.userInfo.configJson) {
    try {
      const config = typeof status.userInfo.configJson === 'string' 
        ? JSON.parse(status.userInfo.configJson) 
        : status.userInfo.configJson;
      if (typeof config.appPublished === 'boolean') {
        console.log('ğŸ“‹ Publication status from configJson (fallback):', config.appPublished);
        return config.appPublished;
      }
    } catch (e) {
      console.warn('âš ï¸ configJson parse failed in publication check:', e);
    }
  }
  
  // 4. æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ä¸æ˜æ™‚ã¯ false
  console.log('â“ Publication status unknown, defaulting to false');
  return false;
}

// =============================================================================
// MAIN UI UPDATE FUNCTIONS
// =============================================================================

// Update UI with new status data
// Full implementation of updateUIWithNewStatus for later use
function _fullUpdateUIWithNewStatus(status) {
  console.log('ğŸ”§ Simple UI Update called with status:', status);
  
  // æœ€å°é™ã®æ¤œè¨¼ã®ã¿
  if (!status || !status.userInfo) {
    console.warn('âŒ Invalid status: missing userInfo');
    return;
  }
  
  // æ”¹å–„ã•ã‚ŒãŸå…¬é–‹çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯: æ–°è¦ä½œæˆãƒ»æ›´æ–°æ™‚ã®ä¾‹å¤–å‡¦ç†ã‚’å«ã‚€
  const isPublished = determinePublicationStatus(status);
  
  // éå…¬é–‹ã§ã‚‚ä»¥ä¸‹ã®å ´åˆã¯UIæ›´æ–°ã‚’å®Ÿè¡Œ
  const allowUpdateReasons = [
    status.userInfo.configJson && status.userInfo.configJson.includes('formCreated'), // æ–°è¦ä½œæˆå®Œäº†æ™‚
    status.userInfo.configJson && status.userInfo.configJson.includes('setupStatus'), // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­
    status.setupStep && status.setupStep >= 1, // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é€²è¡Œä¸­
    status._meta && status._meta.source === 'quickstart', // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ
    status._meta && status._meta.source === 'customSetup', // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    status.userInfo.spreadsheetUrl && status.userInfo.spreadsheetUrl.length > 0 // URLå­˜åœ¨æ™‚
  ];
  
  const shouldUpdate = isPublished || allowUpdateReasons.some(reason => reason);
  
  if (!shouldUpdate) {
    console.log('ğŸš« UI update skipped: board not published and no update reasons');
    return;
  }
  
  console.log('âœ… UI update proceeding:', { isPublished, hasUpdateReasons: allowUpdateReasons.some(r => r) });
  
  try {
    // === ç›´æ¥çš„ãªUIæ›´æ–°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ ===
    console.log('ğŸ¯ Starting direct UI updates...');
    
    // åŸºæœ¬æƒ…å ±ã®æ›´æ–°
    const adminEmail = status.userInfo.adminEmail || '-';
    const userId = status.userInfo.userId || '-';
    
    console.log('ğŸ“ Updating basic info:', { adminEmail, userId });
    
    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ›´æ–°
    const emailElement = document.getElementById('info-admin-email');
    if (emailElement) {
      emailElement.textContent = adminEmail;
      console.log('âœ… Email updated:', adminEmail);
    } else {
      console.warn('âš ï¸ Email element not found');
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æ›´æ–°
    const userIdElement = document.getElementById('info-user-id');
    if (userIdElement) {
      userIdElement.textContent = userId;
      console.log('âœ… User ID updated:', userId);
    } else {
      console.warn('âš ï¸ User ID element not found');
    }
    
    // å…¬é–‹çŠ¶æ…‹ã®æ›´æ–°
    const config = JSON.parse(status.userInfo.configJson || '{}');
    const isPublished = config.appPublished || false;
    const publishText = isPublished ? 'å…¬é–‹ä¸­' : 'åœæ­¢ä¸­';
    
    console.log('ğŸ“Š Updating publish status:', { isPublished, publishText });
    
    const publishTextElement = document.getElementById('info-publish-text');
    if (publishTextElement) {
      publishTextElement.textContent = publishText;
      console.log('âœ… Publish text updated:', publishText);
    }
    
    // å…¬é–‹çŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    const publishIndicator = document.getElementById('info-publish-indicator');
    if (publishIndicator) {
      publishIndicator.className = isPublished 
        ? 'w-2 h-2 rounded-full bg-green-400' 
        : 'w-2 h-2 rounded-full bg-gray-400';
      console.log('âœ… Publish indicator updated');
    }
    
    // å…¬é–‹ã‚·ãƒ¼ãƒˆåã®æ›´æ–°
    const publishedSheet = config.publishedSheetName || status.activeSheetName || 'ãªã—';
    const sheetElement = document.getElementById('info-published-sheet');
    if (sheetElement) {
      sheetElement.textContent = publishedSheet;
      console.log('âœ… Published sheet updated:', publishedSheet);
    }
    
    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®æ›´æ–°
    const displayMode = config.displayMode === 'named' ? 'å®Ÿåè¡¨ç¤º' : 
                       config.displayMode === 'anonymous' ? 'åŒ¿åè¡¨ç¤º' : 'åŒ¿åè¡¨ç¤º';
    const displayModeElement = document.getElementById('info-display-mode');
    if (displayModeElement) {
      displayModeElement.textContent = displayMode;
      console.log('âœ… Display mode updated:', displayMode);
    } else {
      console.warn('âš ï¸ Display mode element not found');
    }
    
    // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã®æ›´æ–°
    const showCounts = config.showCounts === true ? 'è¡¨ç¤º' : 'éè¡¨ç¤º';
    const showCountsElement = document.getElementById('info-show-counts');
    if (showCountsElement) {
      showCountsElement.textContent = showCounts;
      console.log('âœ… Show counts updated:', showCounts);
    } else {
      console.warn('âš ï¸ Show counts element not found');
    }
    
    // ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã®æ›´æ–°
    console.log('ğŸŒ Updating domain display...');
    clearInitialDisplayElements();
    
    // ã‚·ãƒ¼ãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®æ›´æ–°
    console.log('ğŸ“‹ Updating sheet dropdown...');
    const sheetsData = status.sheetNames || status.allSheets || [];
    if (sheetsData.length > 0) {
      populateSheetSelect(sheetsData, status.activeSheetName);
      console.log('âœ… Sheet dropdown updated with', sheetsData.length, 'sheets');
    } else {
      console.log('âš ï¸ No sheet data available for dropdown');
    }
    
    // ãƒ•ãƒƒã‚¿ãƒ¼è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿æº–å‚™
    console.log('ğŸ”§ Preparing footer data...');
    const publicationState = getPublicationState(status);
    const viewUrl = generateViewUrl(status, status.userInfo.userId);
    status._normalized = {
      isPublished: publicationState.isPublished,
      publishReason: publicationState.reason,
      viewUrl: viewUrl,
      hasValidViewUrl: !!viewUrl
    };
    console.log('âœ… Footer data prepared:', {
      isPublished: publicationState.isPublished,
      hasViewUrl: !!viewUrl,
      reason: publicationState.reason
    });
    
    // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿å­˜ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ï¼‰
    window.currentStatus = status;
    
    // å…¬é–‹åœæ­¢ãƒœã‚¿ãƒ³ã®æ›´æ–°
    console.log('ğŸš« Updating unpublish button...');
    updateUnpublishButton(status);
    
    // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®æ›´æ–°
    console.log('ğŸ“Š Updating step indicators...');
    const currentStep = status.setupStep || 1;
    updateStepIndicators(currentStep, status);
    
    // å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ã®æ›´æ–°
    console.log('ğŸ¦¶ Updating footer...');
    updateFooterAndGuidance(status);
    
    console.log('ğŸ‰ Simple UI update completed successfully');
    
  } catch (error) {
    console.error('âŒ Simple UI update failed:', error);
  }
}

// Make the full implementation available for the framework version
if (typeof window !== 'undefined') {
  window._fullUpdateUIWithNewStatus = _fullUpdateUIWithNewStatus;
}

// === æ—§è¤‡é›‘ã‚·ã‚¹ãƒ†ãƒ ã¯å‰Šé™¤æ¸ˆã¿ - ã‚·ãƒ³ãƒ—ãƒ«åŒ–å®Œäº† ===

// Generate hash for status comparison to detect duplicates
function generateStatusHash(status) {
  try {
    const keyData = {
      userId: (status.userInfo && status.userInfo.userId) || null,
      activeSheet: status.activeSheetName || null,
      setupStep: status.setupStep || null,
      appPublished: status.appPublished || null,
      timestamp: Math.floor(Date.now() / 1000) // Round to seconds to allow minor timing differences
    };
    
    return JSON.stringify(keyData);
  } catch (error) {
    logWarn('Failed to generate status hash:', error);
    return Math.random().toString(); // Fallback to prevent duplicate blocking on error
  }
}

// =============================================================================
// HELPER FUNCTIONS FOR UI UPDATES
// =============================================================================

// Update unpublish button state
function updateUnpublishButton(status) {
  const unpublishBtn = document.getElementById('unpublish-board-btn');
  if (!unpublishBtn) return;

  // Use same strict logic as footer: both normalized and explicit checks
  const isPublished = (status._normalized && status._normalized.isPublished) || false;
  let explicitAppPublished = status.appPublished === true;
  
  if (!explicitAppPublished && status.userInfo && status.userInfo.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      explicitAppPublished = config.appPublished === true;
    } catch (configError) {
      console.warn('âŒ Failed to parse configJson for unpublish button check:', configError);
      explicitAppPublished = false;
    }
  }
  
  const finalIsPublished = isPublished && explicitAppPublished;

  if (finalIsPublished) {
    unpublishBtn.classList.remove('hidden');
  } else {
    unpublishBtn.classList.add('hidden');
  }
}

// Update spreadsheet access button state
function updateSpreadsheetButton() {
  const btn = document.getElementById('open-spreadsheet-btn-step2');
  if (!btn) return;
  
  if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetUrl) {
    btn.disabled = false;
    btn.onclick = function() {
      window.open(currentStatus.userInfo.spreadsheetUrl, '_blank');
    };
    logDebug('âœ… Spreadsheet button enabled with URL:', currentStatus.userInfo.spreadsheetUrl);
  } else {
    btn.disabled = true;
    btn.onclick = null;
    logDebug('âš ï¸ Spreadsheet button disabled - no URL available');
  }
}

// Update static UI elements
function updateStaticUI(status) {
  console.log('ğŸ”§ updateStaticUI called with status:', {
    hasStatus: !!status,
    hasUserInfo: !!status?.userInfo
  });
  
  // Update database info panel
  updateDatabaseInfo(status);
  
  // Update existing user section
  updateExistingUserSection(status);
  
  // Populate sheet selection - fix property name mismatch
  logDebug('ğŸ” Debug: Checking sheet data properties', {
    allSheets: status.allSheets,
    sheetNames: status.sheetNames,
    activeSheetName: status.activeSheetName
  });
  
  const sheetsData = status.sheetNames || status.allSheets || [];
  populateSheetSelect(sheetsData, status.activeSheetName);
  
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆã®ç¢ºå®Ÿãªåæ˜ ï¼ˆå¼·åŒ–ï¼‰
  if (status.activeSheetName) {
    setTimeout(() => {
      const select = document.getElementById('sheet-select');
      if (select && select.value !== status.activeSheetName) {
        console.log('ğŸ”„ Force updating active sheet selection:', status.activeSheetName);
        updateActiveSheetUI(status.activeSheetName);
      }
    }, 100);
  }
  
  // Update custom form info
  updateCustomFormInfo(status);
  
  // Check for auto-publish dialog
  checkAutoPublishDialog(status);
}

// =============================================================================
// DATABASE INFO PANEL UPDATES
// =============================================================================

function updateDatabaseInfo(status) {
  console.log('ğŸ”§ updateDatabaseInfo called with:', {
    status: !!status,
    userInfo: !!status?.userInfo,
    adminEmail: status?.userInfo?.adminEmail,
    userId: status?.userInfo?.userId,
    configJson: status?.userInfo?.configJson
  });
  
  if (!status || !status.userInfo) {
    console.warn('System info update failed: No user info available');
    return;
  }

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’è¨­å®šï¼ˆãƒ‡ãƒãƒƒã‚°å¼·åŒ–ç‰ˆï¼‰
  console.log('ğŸ”§ Setting currentSpreadsheetUrl:', {
    fromUserInfo: status.userInfo.spreadsheetUrl || 'none',
    currentGlobal: currentSpreadsheetUrl || 'none',
    shouldUpdate: !!status.userInfo.spreadsheetUrl
  });
  
  if (status.userInfo.spreadsheetUrl) {
    currentSpreadsheetUrl = status.userInfo.spreadsheetUrl;
    console.log('âœ… currentSpreadsheetUrl updated:', currentSpreadsheetUrl);
    
    // å³åº§ã«æ¤œè¨¼
    if (currentSpreadsheetUrl !== status.userInfo.spreadsheetUrl) {
      console.error('âŒ URLè¨­å®šã«å¤±æ•—:', { expected: status.userInfo.spreadsheetUrl, actual: currentSpreadsheetUrl });
    }
  } else if (status.userInfo.spreadsheetUrl === '') {
    // æ˜ç¤ºçš„ãªç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ã‚¯ãƒªã‚¢
    currentSpreadsheetUrl = '';
    console.log('ğŸ—‘ï¸ currentSpreadsheetUrl cleared (explicit empty string)');
  } else {
    console.log('âš ï¸ No spreadsheetUrl in userInfo, keeping current value:', currentSpreadsheetUrl || 'none');
  }
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®æœ€çµ‚ç¢ºèª
  setTimeout(() => {
    console.log('ğŸ” Final currentSpreadsheetUrl verification:', currentSpreadsheetUrl || 'still empty');
  }, 100);

  const cfg = status.config || {};

  // åŸºæœ¬æƒ…å ±ã®æ›´æ–°
  console.log('ğŸ”§ Setting basic info with safeSetText:', {
    adminEmail: status.userInfo.adminEmail,
    userId: status.userInfo.userId,
    publishedSheet: cfg.publishedSheetName || status.publishedSheetName || 'ãªã—'
  });
  
  safeSetText('info-admin-email', status.userInfo.adminEmail);
  safeSetText('info-user-id', status.userInfo.userId);
  safeSetText('info-published-sheet', cfg.publishedSheetName || status.publishedSheetName || 'ãªã—');
  

  // å…¬é–‹çŠ¶æ…‹ã®è¡¨ç¤ºã‚’æ›´æ–°
  const isPublished = cfg.isPublished !== undefined
    ? cfg.isPublished
    : status.appPublished || status.isPublished || (status.activeSheetName && (cfg.publishedSheetName || status.publishedSheetName));
  updatePublicationStatusUI(isPublished);

  // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®æ›´æ–°
  const displayModeFlag = cfg.showNames !== undefined ? cfg.showNames : status.showNames;
  const displayMode = displayModeFlag ? 'åå‰è¡¨ç¤º' : 'åŒ¿åè¡¨ç¤º';
  safeSetText('info-display-mode', displayMode);

  // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã®æ›´æ–°
  const showCountsFlag = cfg.showCounts !== undefined
    ? cfg.showCounts
    : (status.showCounts !== undefined ? status.showCounts : false);
  const showCounts = showCountsFlag ? 'è¡¨ç¤º' : 'éè¡¨ç¤º';
  safeSetText('info-show-counts', showCounts);

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹åŒæœŸ
  syncCheckboxStates(status);
}

// Update publication status UI
function updatePublicationStatusUI(isPublished) {
  const statusElement = safeGetElement('info-publish-status');
  const indicatorElement = safeGetElement('info-publish-indicator');
  const textElement = safeGetElement('info-publish-text');
  
  if (statusElement) {
    if (isPublished) {
      statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-green-600 text-white';
      if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-green-400';
      if (textElement) textElement.textContent = 'å…¬é–‹ä¸­';
    } else {
      statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-gray-600 text-gray-300';
      if (indicatorElement) indicatorElement.className = 'w-2 h-2 rounded-full bg-gray-400';
      if (textElement) textElement.textContent = 'éå…¬é–‹';
    }
  }
}

// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åŒæœŸã™ã‚‹é–¢æ•°
function syncCheckboxStates(status) {
  // Priority: Database config (configJson) > status properties > defaults
  let showNames = false;
  let showCounts = false;
  
  // 1. Prefer status.config if available
  if (status.config) {
    if (status.config.showNames !== undefined) showNames = status.config.showNames;
    if (status.config.showCounts !== undefined) showCounts = status.config.showCounts;
  } else if (status.userInfo && status.userInfo.configJson) {
    // 2. Fallback to raw configJson
    try {
      const config = JSON.parse(status.userInfo.configJson);
      if (config.showNames !== undefined) showNames = config.showNames;
      if (config.showCounts !== undefined) showCounts = config.showCounts;
    } catch (e) {
      logWarn('Failed to parse configJson, using status properties');
      if (status.showNames !== undefined) showNames = status.showNames;
      if (status.showCounts !== undefined) showCounts = status.showCounts;
    }
  } else {
    // 3. Use status properties as last resort
    if (status.showNames !== undefined) showNames = status.showNames;
    if (status.showCounts !== undefined) showCounts = status.showCounts;
  }

  // Update checkbox elements
  const showNamesCheckbox = safeGetElement('show-names');
  const showCountsCheckbox = safeGetElement('show-counts');
  
  if (showNamesCheckbox) {
    showNamesCheckbox.checked = showNames;
  }
  
  if (showCountsCheckbox) {
    showCountsCheckbox.checked = showCounts;
  }
}

// =============================================================================
// SHEET SELECTION AND CONFIGURATION
// =============================================================================

// Populate sheet selection dropdown
function populateSheetSelect(sheetNames, activeSheetName) {
  const select = document.getElementById('sheet-select');
  if (!select) {
    logWarn('Sheet select element not found');
    return;
  }

  logDebug('ğŸ“‹ Populating sheet select with data:', {
    sheetNames: sheetNames,
    activeSheetName: activeSheetName,
    dataType: typeof sheetNames,
    isArray: Array.isArray(sheetNames)
  });

  // Clear existing options
  select.innerHTML = '<option value="">-- ã‚·ãƒ¼ãƒˆã‚’é¸æŠ --</option>';
  
  if (sheetNames && sheetNames.length > 0) {
    logDebug('âœ… Adding sheets to dropdown:', sheetNames.length);
    
    sheetNames.forEach((sheet, index) => {
      const option = document.createElement('option');
      
      // Handle both object and string formats
      let sheetName;
      if (typeof sheet === 'object' && sheet.name) {
        sheetName = sheet.name;
        option.value = sheet.name;
        logDebug('ğŸ“„ Sheet ' + (index + 1) + ': ' + sheet.name + ' (ID: ' + sheet.id + ')');
      } else if (typeof sheet === 'string') {
        sheetName = sheet;
        option.value = sheet;
        logDebug('ğŸ“„ Sheet ' + (index + 1) + ': ' + sheet);
      } else {
        console.warn('âš ï¸ Unknown sheet format:', sheet);
        return;
      }
      
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆã®è¡¨ç¤ºã‚’æ”¹å–„
      if (sheetName === activeSheetName) {
        option.textContent = sheetName + ' (ã‚¢ã‚¯ãƒ†ã‚£ãƒ–)';
        option.style.fontWeight = 'bold';
        option.style.color = '#10b981'; // ç·‘è‰²ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚’è¡¨ç¤º
        option.className = 'active-sheet-option';
        logDebug('âœ… Active sheet marked: ' + sheetName);
      } else {
        option.textContent = sheetName;
      }
      
      select.appendChild(option);
    });
    select.disabled = false;
    logDebug('âœ… Sheet dropdown populated successfully');
  } else {
    // åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ã¯æ­£å¸¸ãªã®ã§debugãƒ¬ãƒ™ãƒ«ã«å¤‰æ›´
    if (window.DEBUG_MODE || window.location.hostname === 'localhost') {
      console.warn('âš ï¸ No sheets available:', sheetNames);
    }
    select.innerHTML = '<option value="">åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
    select.disabled = true;
  }
  
  // Set active sheet if available (å¼·åŒ–ã•ã‚ŒãŸé¸æŠãƒ­ã‚¸ãƒƒã‚¯)
  if (activeSheetName) {
    // ã‚·ãƒ¼ãƒˆåã®æ­£è¦åŒ–ã‚’è€ƒæ…®ã—ãŸé¸æŠå‡¦ç†
    const normalizedActiveSheet = activeSheetName.trim();
    
    // æ­£ç¢ºãªä¸€è‡´ã‚’ç¢ºèª
    const availableOptions = Array.from(select.options);
    const matchingOption = availableOptions.find(option => option.value === normalizedActiveSheet);
    
    if (matchingOption) {
      select.value = normalizedActiveSheet;
      selectedSheet = normalizedActiveSheet;
      lastSelectedSheetName = normalizedActiveSheet;
      logDebug('âœ… Active sheet set successfully:', normalizedActiveSheet);
    } else {
      // å¼·åŒ–ã•ã‚ŒãŸã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
      logDebug('ğŸ” Active sheet not found in options, attempting intelligent fallback:', {
        activeSheetName: normalizedActiveSheet,
        availableOptions: availableOptions.map(opt => opt.value)
      });
      
      let fallbackSheet = null;
      
      // 1. å®Œå…¨ä¸€è‡´ã‚’å†è©¦è¡Œï¼ˆæ­£è¦åŒ–å¾Œï¼‰
      const exactMatch = availableOptions.find(option => 
        _normalizeSheetName(option.value) === _normalizeSheetName(normalizedActiveSheet)
      );
      
      if (exactMatch) {
        fallbackSheet = exactMatch.value;
        console.log('âœ… Found exact match after normalization:', fallbackSheet);
      } else {
        // 2. éƒ¨åˆ†ä¸€è‡´ã‚’è©¦è¡Œï¼ˆå±¥æ­´å¾©å…ƒã§å½¹ç«‹ã¤ï¼‰
        const partialMatch = availableOptions.find(option => 
          option.value && normalizedActiveSheet && 
          (option.value.includes(normalizedActiveSheet) || normalizedActiveSheet.includes(option.value))
        );
        
        if (partialMatch) {
          fallbackSheet = partialMatch.value;
          console.log('âœ… Found partial match:', fallbackSheet);
        } else if (availableOptions.length > 1) {
          // 3. æœ€åˆã®æœ‰åŠ¹ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
          fallbackSheet = availableOptions[1].value;
          console.log('âœ… Using first available option:', fallbackSheet);
        }
      }
      
      if (fallbackSheet) {
        select.value = fallbackSheet;
        selectedSheet = fallbackSheet;
        lastSelectedSheetName = fallbackSheet;
        logDebug('ğŸ”„ Fallback to sheet:', fallbackSheet);
      }
    }
    
    // é¸æŠçŠ¶æ…‹ã‚’ç¢ºèª
    if (select.value) {
      logDebug('âœ… Final sheet selection confirmed:', select.value);
    } else {
      console.error('âŒ Sheet selection failed - no sheet selected');
    }
  }
  
  // Add change event listener for data preview
  select.removeEventListener('change', handleSheetSelectionChange);
  select.addEventListener('change', handleSheetSelectionChange);
  
  // Update UI for selected sheet and enable spreadsheet button
  updateUIForSelectedSheet();
  updateSpreadsheetButton();
}

// Populate header options for configuration
// Full implementation of populateHeaderOptions (framework has minimal version)
function _fullPopulateHeaderOptions(headers) {
  // Throttle function calls to prevent spam
  if (window.populateHeaderOptionsRunning) {
    return;
  }
  window.populateHeaderOptionsRunning = true;
  
  const selects = [
    'opinionHeader',      // Main required field
    'reason-column',     // Optional details field (reason column)
    'name-column', 
    'class-column'
  ];
  
  selects.forEach(selectId => {
    const select = document.getElementById(selectId);
    
    if (select) {
      // Store current value
      const currentValue = select.value;
      
      // Clear and repopulate with appropriate placeholder
      if (headers && headers.length > 0) {
        select.innerHTML = '<option value="">-- åˆ—ã‚’é¸æŠ --</option>';
        select.disabled = false;
      } else {
        select.innerHTML = '<option value="">-- ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
        select.disabled = true;
      }
      
      const excludedHeaders = [
        'ãªã‚‹ã»ã©ï¼',
        'ã„ã„ã­ï¼',
        'ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ï¼',
        'ãƒã‚¤ãƒ©ã‚¤ãƒˆ',
        'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', // ãƒ•ã‚©ãƒ¼ãƒ ã§è‡ªå‹•åé›†ã•ã‚Œã‚‹ãŸã‚ã€ãƒãƒƒãƒ”ãƒ³ã‚°å¯¾è±¡ã‹ã‚‰é™¤å¤–
        'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—' // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ã«ã‚ˆã‚Šé™¤å¤–
      ];

      const filteredHeaders = headers.filter(header => !excludedHeaders.includes(header));

      filteredHeaders.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      
      // Restore previous value if still valid
      if (currentValue && headers.includes(currentValue)) {
        select.value = currentValue;
      }
    }
  });
  
  // Reset throttle after a delay
  setTimeout(() => {
    window.populateHeaderOptionsRunning = false;
  }, 100);
}

// Populate configuration with guessed values
// Full implementation of populateConfig (framework has minimal version)
function _fullPopulateConfig(cfg) {
  if (!cfg) return;
  
  // å±¥æ­´å¾©å…ƒä¸­ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãŸã ã—ã€ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯é™¤ãï¼‰
  if ((window._historyRestoreInProgress || window._historyColumnSelections) && !window._draftModeActive) {
    console.log('ğŸ›¡ï¸ _fullPopulateConfig: å±¥æ­´å¾©å…ƒä¸­ã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ');
    return;
  }
  
  // ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ­ã‚°å‡ºåŠ›
  if (window._draftModeActive) {
    console.log('ğŸ“ _fullPopulateConfig: ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã§è¨­å®šã‚’åæ˜ ä¸­');
  }
  
  // Throttle function calls to prevent spam
  if (window.populateConfigRunning) {
    return;
  }
  window.populateConfigRunning = true;
  
  const mappings = {
    // Main opinion dropdown (primary target)
    'opinionHeader': cfg.opinionHeader || cfg.opinionColumn,
    
    // Detail configuration dropdowns (secondary targets with property name fixes)
    'reason-column': cfg.reasonColumn || cfg.reasonHeader,
    'name-column': cfg.nameColumn || cfg.nameHeader,
    'class-column': cfg.classColumn || cfg.classHeader,
    'show-names': cfg.showNames,
    'show-counts': cfg.showCounts
  };
  
  Object.keys(mappings).forEach(elementId => {
    const element = document.getElementById(elementId);
    const value = mappings[elementId];
    
    if (element && value !== undefined) {
      if (element.type === 'checkbox') {
        element.checked = Boolean(value);
      } else {
        element.value = value;
      }
    }
  });
  
  // Reset throttle after a delay
  setTimeout(() => {
    window.populateConfigRunning = false;
  }, 100);
  
  updateConfigButtons();
}

// Clear configuration fields
function clearConfigFields() {
  const fieldIds = [
    'opinionHeader',      // Main required field
    'reason-column',
    'name-column',
    'class-column'
  ];
  
  fieldIds.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.value = '';
    }
  });
  
  updateConfigButtons();
}

// Build configuration object from form
function buildConfigObject() {
  // Get values from primary elements (with fallback to secondary elements)
  const opinionHeaderEl = document.getElementById('opinionHeader');
  const reasonColumnEl = document.getElementById('reason-column');
  const nameColumnEl = document.getElementById('name-column');
  const classColumnEl = document.getElementById('class-column');
  const showNamesEl = document.getElementById('show-names');
  const showCountsEl = document.getElementById('show-counts');
  
  const opinionValue = (opinionHeaderEl ? opinionHeaderEl.value : '') || 
                      (reasonColumnEl ? reasonColumnEl.value : '') || '';
  const nameValue = nameColumnEl ? nameColumnEl.value : '';
  const classValue = classColumnEl ? classColumnEl.value : '';
  const showNames = showNamesEl ? showNamesEl.checked : false;
  const showCounts = showCountsEl ? showCountsEl.checked : false;
  
  return {
    sheetName: selectedSheet,
    // Use property names that match backend expectations (opinionHeader format)
    opinionHeader: opinionValue,
    nameHeader: nameValue,
    classHeader: classValue,
    reasonHeader: (document.getElementById('reason-column') && document.getElementById('reason-column').value) || '',
    // Column values
    opinionColumn: opinionValue,
    nameColumn: nameValue,
    classColumn: classValue,
    showNames: showNames,
    showCounts: showCounts
  };
}

// Full implementation of validateConfig (framework has minimal version)
function _fullValidateConfig() {
  // Check primary element first, then fallback to secondary element
  const opinionHeaderEl = document.getElementById('opinionHeader');
  const reasonColumnEl = document.getElementById('reason-column');
  const opinionValue = (opinionHeaderEl ? opinionHeaderEl.value : '') || 
                      (reasonColumnEl ? reasonColumnEl.value : '') || '';
  
  return opinionValue && opinionValue.trim() !== '';
}

// Full implementation of updateConfigButtons (framework has minimal version)
function _fullUpdateConfigButtons() {
  const isValid = (typeof _fullValidateConfig === 'function') ? _fullValidateConfig() : validateConfig();
  const saveBtn = document.getElementById('save-publish-btn');
  
  if (saveBtn) {
    saveBtn.disabled = !isValid;
    if (isValid) {
      saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }
}

// Make full implementations globally available for framework fallback
window._fullValidateConfig = _fullValidateConfig;
window._fullUpdateConfigButtons = _fullUpdateConfigButtons;
window._fullUpdateFormUrlDisplay = _fullUpdateFormUrlDisplay;
window._fullPopulateHeaderOptions = _fullPopulateHeaderOptions;
window._fullPopulateConfig = _fullPopulateConfig;

// =============================================================================
// STEP INDICATORS AND GUIDANCE
// =============================================================================

// çµ±ä¸€ã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—å®Œäº†ãƒã‚§ãƒƒã‚¯ - å…¬é–‹çŠ¶æ…‹å„ªå…ˆåˆ¤å®šå¯¾å¿œç‰ˆ
function getStepCompletionFromConfig(status) {
  if (!(status && status.userInfo && status.userInfo.configJson)) {
    return { step1: false, step2: false, step3: false, isPublished: false };
  }

  try {
    const config = typeof status.userInfo.configJson === 'string' 
      ? JSON.parse(status.userInfo.configJson) 
      : status.userInfo.configJson;

    // å…¬é–‹çŠ¶æ…‹ã®å„ªå…ˆãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã«é–¢ä¿‚ãªãå…¬é–‹æ¸ˆã¿ãªã‚‰å…¨ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†ï¼‰
    const publicationState = getPublicationState(status);
    if (publicationState.isPublished) {
      return {
        step1: true,
        step2: true,
        step3: true,
        isPublished: true
      };
    }

    // é€šå¸¸ã®ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†åˆ¤å®š
    // Step 1: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã®å­˜åœ¨ç¢ºèª
    const step1Complete = !!(status.userInfo.spreadsheetId);
    
    // Step 2: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†çŠ¶æ…‹ã®ç¢ºèª
    const step2Complete = config.setupStatus === 'completed' && 
                          config.formCreated === true && 
                          config.formUrl && config.formUrl.trim();
    
    // Step 3: å…¬é–‹çŠ¶æ…‹ã®ç¢ºèª
    const step3Complete = config.appPublished === true;
    
    return {
      step1: step1Complete,
      step2: step2Complete,
      step3: step3Complete,
      isPublished: step3Complete
    };
  } catch (error) {
    console.warn('âŒ configJsonã®è§£æã«å¤±æ•—:', error);
    return { step1: false, step2: false, step3: false, isPublished: false };
  }
}

// Update step indicators - æœ€é©åŒ–ç‰ˆï¼ˆãƒãƒƒãƒDOMæ›´æ–°ï¼‰
function updateStepIndicators(currentStep, status = null) {
  const steps = [
    document.getElementById('step-1-indicator'),
    document.getElementById('step-2-indicator'),
    document.getElementById('step-3-indicator')
  ];

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ã‹ã‚‰å®Ÿéš›ã®å®Œäº†çŠ¶æ³ã‚’å–å¾—
  const completion = getStepCompletionFromConfig(status);
  logDebug('ğŸ“Š Step completion from database:', completion);

  // DOMæ›´æ–°ã‚’ãƒãƒƒãƒåŒ–ã™ã‚‹ãŸã‚ã®è¨­å®šé…åˆ—ã‚’ä½œæˆ
  const updates = [];
  
  steps.forEach((step, index) => {
    if (!step) return;
    
    const stepNumber = index + 1;
    const circle = step.querySelector('div');
    const text = step.querySelector('span');

    // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’å‰Šé™¤ï¼ˆæœ€é©åŒ–ï¼‰
    const existingBadge = step.querySelector('.publication-badge');
    if (existingBadge) {
      existingBadge.remove();
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ã«åŸºã¥ãå®Œäº†åˆ¤å®š
    const isStepComplete = completion['step' + stepNumber];
    
    // æ›´æ–°æƒ…å ±ã‚’é…åˆ—ã«è¿½åŠ ï¼ˆå®Ÿéš›ã®DOMæ›´æ–°ã¯å¾Œã§ä¸€æ‹¬å®Ÿè¡Œï¼‰
    updates.push({
      circle,
      text,
      stepNumber,
      isStepComplete,
      isCurrentStep: stepNumber === currentStep
    });
  });
  
  // ãƒãƒƒãƒDOMæ›´æ–°å®Ÿè¡Œï¼ˆãƒªãƒ•ãƒ­ãƒ¼ã‚’æœ€å°åŒ–ï¼‰
  requestAnimationFrame(() => {
    executeBatchStepUpdates(updates);
    // é€²è¡ŒçŠ¶æ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›´æ–°ï¼ˆåŒã˜ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ å†…ã§å®Ÿè¡Œï¼‰
    updateProgressMessage(currentStep, status, completion);
  });
}

// ãƒãƒƒãƒDOMæ›´æ–°ã®å®Ÿè¡Œï¼ˆæœ€é©åŒ–ã•ã‚ŒãŸDOMæ“ä½œï¼‰
function executeBatchStepUpdates(updates) {
  const styleConfigs = {
    completed: {
      circleClass: 'w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all',
      circleContent: 'âœ“',
      textClasses: { remove: ['text-gray-500', 'text-cyan-400'], add: ['text-green-400', 'font-medium'] }
    },
    current: {
      circleClass: 'w-6 h-6 bg-cyan-500 text-white rounded-full flex items-center justify-center font-bold text-xs transition-all ring-2 ring-cyan-400 ring-offset-2 ring-offset-gray-900 animate-pulse',
      textClasses: { remove: ['text-gray-500', 'text-green-400'], add: ['text-cyan-400', 'font-bold'] }
    },
    pending: {
      circleClass: 'w-6 h-6 bg-gray-700 text-gray-500 rounded-full flex items-center justify-center font-bold text-xs transition-all border border-gray-600',
      textClasses: { remove: ['text-white', 'text-green-400', 'text-cyan-400', 'font-bold', 'font-medium'], add: ['text-gray-500'] }
    }
  };

  updates.forEach(({ circle, text, stepNumber, isStepComplete, isCurrentStep }) => {
    let config;
    
    if (isStepComplete) {
      config = styleConfigs.completed;
    } else if (isCurrentStep) {
      config = styleConfigs.current;
    } else {
      config = styleConfigs.pending;
    }

    // Circleè¦ç´ ã®æ›´æ–°
    if (circle) {
      circle.className = config.circleClass;
      circle.innerHTML = config.circleContent || stepNumber;
    }

    // Textè¦ç´ ã®æ›´æ–°ï¼ˆã‚¯ãƒ©ã‚¹æ“ä½œã®æœ€é©åŒ–ï¼‰
    if (text && config.textClasses) {
      if (config.textClasses.remove && config.textClasses.remove.length > 0) {
        for (const className of config.textClasses.remove) {
          text.classList.remove(className);
        }
      }
      if (config.textClasses.add && config.textClasses.add.length > 0) {
        for (const className of config.textClasses.add) {
          text.classList.add(className);
        }
      }
    }
  });
}

function updateProgressMessage(currentStep, status = null, completion = null) {
  const messageElement = document.getElementById('progress-message');
  if (!messageElement) return;
  
  // completionãŒæ¸¡ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å–å¾—
  if (!completion) {
    completion = getStepCompletionFromConfig(status);
  }
  
  // æ”¹å–„ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
  const messageData = getEnhancedProgressMessage(currentStep, completion, status);
  
  messageElement.textContent = messageData.message;
  messageElement.className = `text-sm ${messageData.colorClass} font-medium transition-colors duration-300`;
}

// å¼·åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
function getEnhancedProgressMessage(currentStep, completion, status) {
  const messageConfigs = {
    1: {
      completed: {
        message: 'âœ… ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†ï¼šãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒåˆ©ç”¨å¯èƒ½ã§ã™',
        colorClass: 'text-green-400'
      },
      inProgress: {
        message: 'ğŸ“‹ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆè‡ªå‹•ï¼‰ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’é¸æŠ',
        colorClass: 'text-cyan-400'
      }
    },
    2: {
      completed: {
        message: 'âœ… ã‚·ãƒ¼ãƒˆè¨­å®šå®Œäº†ï¼šå›ç­”ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºæº–å‚™ãŒã§ãã¾ã—ãŸ',
        colorClass: 'text-green-400'  
      },
      inProgress: {
        message: 'âš™ï¸ ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ã€è¡¨ç¤ºã™ã‚‹åˆ—ï¼ˆè³ªå•ãƒ»å›ç­”ãªã©ï¼‰ã‚’è¨­å®šã—ã¦ãã ã•ã„',
        colorClass: 'text-yellow-400'
      }
    },
    3: {
      published: {
        message: 'ğŸ‰ ãƒœãƒ¼ãƒ‰å…¬é–‹ä¸­ï¼šå‚åŠ è€…ãŒå›ç­”ã‚’æŠ•ç¨¿ãƒ»é–²è¦§ã§ãã¾ã™',
        colorClass: 'text-green-400'
      },
      readyToPublish: {
        message: 'ğŸš€ å…¬é–‹æº–å‚™å®Œäº†ï¼šã€Œãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã€ã§å‚åŠ è€…ã«å…±æœ‰ã—ã¾ã—ã‚‡ã†',
        colorClass: 'text-purple-400'
      },
      needsConfiguration: {
        message: 'ğŸ”§ åˆ—è¨­å®šã‚’å®Œäº†ã—ã¦ã‹ã‚‰å…¬é–‹ã—ã¦ãã ã•ã„',
        colorClass: 'text-orange-400'
      }
    }
  };
  
  // ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®çŠ¶æ…‹åˆ¤å®šã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é¸æŠ
  switch (currentStep) {
    case 1:
      return completion.step1 ? 
        messageConfigs[1].completed : 
        messageConfigs[1].inProgress;
        
    case 2:
      return completion.step2 ? 
        messageConfigs[2].completed : 
        messageConfigs[2].inProgress;
        
    case 3:
      if (completion.isPublished) {
        return messageConfigs[3].published;
      } else if (completion.step2) {
        return messageConfigs[3].readyToPublish;
      } else {
        return messageConfigs[3].needsConfiguration;
      }
      
    default:
      return {
        message: 'ğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼šStudyQuestã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ï¼',
        colorClass: 'text-green-400'
      };
  }
}

// ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ©Ÿèƒ½ç”¨ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç®¡ç†
let footerUpdateTimeout = null;

// Update footer and guidance text (with debounce)
function updateFooterAndGuidance(status) {
  // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼šçŸ­æ™‚é–“ã®é€£ç¶šå‘¼ã³å‡ºã—ã‚’åˆ¶å¾¡
  clearTimeout(footerUpdateTimeout);
  footerUpdateTimeout = setTimeout(() => {
    updateFooterAndGuidanceImmediate(status);
  }, 150); // 150msé…å»¶
}

// å®Ÿéš›ã®ãƒ•ãƒƒã‚¿ãƒ¼æ›´æ–°å‡¦ç†
function updateFooterAndGuidanceImmediate(status) {
  console.group('ğŸ¦¶ updateFooterAndGuidance');
  
  // ã‚ˆã‚Šç¢ºå®Ÿãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºä¿: ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã¨ãƒãƒ¼ã‚¸
  const effectiveStatus = status || window.currentStatus;
  if (!effectiveStatus) {
    console.warn('âŒ No status available for footer update');
    console.groupEnd();
    return;
  }
  
  // å¼•æ•°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è©³ç´°ç¢ºèªï¼ˆå¼·åŒ–ç‰ˆï¼‰
  console.log('ğŸ” Footer update with status:', {
    hasStatus: !!effectiveStatus,
    isPublished: effectiveStatus?.isPublished,
    configIsPublished: effectiveStatus?.config?.isPublished,
    appPublished: effectiveStatus?.appPublished,
    normalizedIsPublished: effectiveStatus?._normalized?.isPublished,
    configJson: effectiveStatus?.userInfo?.configJson ? 'exists' : 'missing',
    statusSource: status ? 'provided' : 'global fallback'
  });
  
  const footer = document.getElementById('admin-footer');
  const guidanceText = document.getElementById('guidance-text');
  
  if (!footer || !guidanceText) {
    console.warn('âŒ Footer or guidance elements not found');
    console.groupEnd();
    return;
  }

  // æ”¹å–„ã•ã‚ŒãŸå…¬é–‹çŠ¶æ…‹åˆ¤å®š: çµ±ä¸€é–¢æ•°ä½¿ç”¨ + ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
  const finalIsPublished = determinePublicationStatus(effectiveStatus);
  const viewUrl = (effectiveStatus._normalized && effectiveStatus._normalized.viewUrl) || 
                  (effectiveStatus.appUrls && effectiveStatus.appUrls.viewUrl) ||
                  generateViewUrl(effectiveStatus);
  
  // ç°¡æ½”ãªãƒ­ã‚°å‡ºåŠ›
  console.log(`ğŸ” Publication check: ${finalIsPublished ? 'å…¬é–‹ä¸­' : 'éå…¬é–‹'}`, {
    hasViewUrl: !!viewUrl,
    source: status._normalized ? '_normalized' : 'fallback'
  });

  // Show footer if published (with strict validation)
  if (finalIsPublished) {
    footer.classList.remove('hidden');
    
    // Update board URL using our generated viewUrl (if available)
    const boardUrlInput = document.getElementById('board-url');
    const viewBoardLink = document.getElementById('view-board-link');
    
    if (boardUrlInput) {
      boardUrlInput.value = viewUrl || 'URLç”Ÿæˆä¸­...';
      console.log('ğŸ“ Board URL input updated:', viewUrl || 'URL generation pending');
    }
    if (viewBoardLink && viewUrl) {
      viewBoardLink.href = viewUrl;
      console.log('ğŸ”— View board link updated:', viewUrl);
    } else if (viewBoardLink) {
      viewBoardLink.removeAttribute('href');
      console.log('ğŸ”— View board link cleared - no URL available');
    }
    
    // Update topic text
    updateTopicText(status);
    
    guidanceText.textContent = 'å›ç­”ãƒœãƒ¼ãƒ‰ã¯ç¾åœ¨å…¬é–‹ä¸­ã§ã™ã€‚';
  } else {
    footer.classList.add('hidden');
    console.log('âŒ Footer hidden - board not published');
    
    // Update guidance based on setup step
    updateGuidanceForStep(status.setupStep || 1, guidanceText);
  }
  
  console.groupEnd();
  
  // è‡ªå‹•åœæ­¢é€šçŸ¥ã®è¡¨ç¤ºãƒã‚§ãƒƒã‚¯
  checkAndShowAutoStopNotification(status);
  
  adjustLayout();
}

// Update UI for selected sheet
function updateUIForSelectedSheet() {
  const hasSelection = selectedSheet && selectedSheet.trim() !== '';
  
  // Update step indicators based on server-provided setupStep
  const currentStep = currentStatus.setupStep || 1;
  updateStepIndicators(currentStep);
  
  // Enable/disable configuration section
  const configSection = document.getElementById('config-section');
  if (configSection) {
    if (hasSelection) {
      configSection.classList.remove('opacity-50', 'pointer-events-none');
      
      // é˜²å¾¡çš„ãƒ­ã‚¸ãƒƒã‚¯: config-areaãŒç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
  const configArea = document.getElementById('config-area');
      if (configArea) {
        configArea.classList.remove('hidden');
        console.log('ğŸ›¡ï¸ updateUIForSelectedSheet: Config area shown defensively');
      }
    } else {
      configSection.classList.add('opacity-50', 'pointer-events-none');
    }
  }
  
  // Update guidance text
  const guidanceText = document.getElementById('guidance-text');
  if (guidanceText) {
    if (hasSelection) {
      guidanceText.textContent = 'ã‚¹ãƒ†ãƒƒãƒ—3: åˆ—ã‚’è¨­å®šã—ã¦ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¾ã—ã‚‡ã†';
    } else {
      guidanceText.textContent = 'ã‚¹ãƒ†ãƒƒãƒ—2: è¡¨ç¤ºã—ãŸã„ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
    }
  }

  // Toggle placeholder visibility
  const configPlaceholder = document.getElementById('config-placeholder');
  if (configPlaceholder) {
    if (hasSelection) {
      configPlaceholder.classList.add('hidden');
    } else {
      configPlaceholder.classList.remove('hidden');
    }
  }
}

// Update topic text in footer
function updateTopicText(status) {
  const topicTextElement = document.getElementById('current-topic-text');
  const scheduledEndTimeElement = document.getElementById('scheduled-end-time');
  
  if (!topicTextElement) return;

  let topic = 'ï¼ˆå•é¡Œæ–‡æœªè¨­å®šï¼‰';
  
  // SAFE: è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å®‰å…¨ãªå–å¾—
  let cfg = {};
  
  // statusã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
  if (!status) {
    console.warn('âš ï¸ updateTopicText: status is null or undefined');
    topicTextElement.textContent = topic;
    return;
  }
  
  // status.configãŒå­˜åœ¨ã—ã€ã‹ã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã®ã¿ä½¿ç”¨
  if (status.config && typeof status.config === 'object') {
    cfg = {...status.config};
  }
  
  console.log('ğŸ” updateTopicText: status:', status);
  
  // userInfo.configJsonã‹ã‚‰ã‚‚æƒ…å ±ã‚’å–å¾—ï¼ˆå®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯å¼·åŒ–ï¼‰
  if (status.userInfo && status.userInfo.configJson) {
    try {
      const fullConfig = JSON.parse(status.userInfo.configJson);
      if (fullConfig && typeof fullConfig === 'object') {
        cfg = {...cfg, ...fullConfig};
        console.log('ğŸ“‹ updateTopicText: merged config:', cfg);
      } else {
        console.warn('âš ï¸ Parsed configJson is not a valid object:', fullConfig);
      }
    } catch (e) {
      console.warn('âš ï¸ Failed to parse userInfo.configJson:', e);
    }
  }
  
  // publishedSheetNameã«åŸºã¥ã„ã¦sheet-specific configã‚’å–å¾—ï¼ˆå®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯å¼·åŒ–ï¼‰
  if (status.userInfo && cfg && cfg.publishedSheetName) {
    try {
      const sheetConfigKey = `sheet_${cfg.publishedSheetName}`;
      if (cfg[sheetConfigKey] && typeof cfg[sheetConfigKey] === 'object' && cfg[sheetConfigKey].opinionHeader) {
        topic = cfg[sheetConfigKey].opinionHeader;
        console.log(`âœ… Topic found from sheet config (${sheetConfigKey}):`, topic);
      } else {
        console.warn(`âš ï¸ No opinion header found in sheet config: ${sheetConfigKey}`, cfg[sheetConfigKey]);
      }
    } catch (e) {
      console.warn('âš ï¸ Error accessing sheet config:', e);
    }
  }

  // å„ªå…ˆé †ä½: customFormInfo > ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®š > ä¸€èˆ¬è¨­å®š
  if (!topic && status.customFormInfo && status.customFormInfo.mainQuestion) {
    topic = status.customFormInfo.mainQuestion;
    console.log('âœ… Topic from customFormInfo:', topic);
  } else if (!topic && cfg.opinionHeader) {
    topic = cfg.opinionHeader;
    console.log('âœ… Topic from cfg.opinionHeader:', topic);
  }
  
  if (!topic) {
    const sheetName = cfg.publishedSheetName || status.publishedSheetName;
    console.log('ğŸ” Looking for topic in sheet config, sheetName:', sheetName);
    
    if (sheetName && sheetName !== 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1') {
      if (status.userInfo && status.userInfo.configJson) {
        try {
          const fullCfg = JSON.parse(status.userInfo.configJson);
          const sheetCfg = fullCfg['sheet_' + (sheetName || '')] || {};
          console.log('ğŸ“‹ Sheet config found:', sheetCfg);
          
          // guessedConfigå†…ã®opinionHeaderã‚’å„ªå…ˆ
          if (sheetCfg.guessedConfig && sheetCfg.guessedConfig.opinionHeader) {
            topic = sheetCfg.guessedConfig.opinionHeader;
            console.log('âœ… Topic from guessedConfig:', topic);
          } else if (sheetCfg.opinionHeader) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ã®opinionHeader
            topic = sheetCfg.opinionHeader;
            console.log('âœ… Topic from direct opinionHeader:', topic);
          } else {
            console.warn('âš ï¸ No opinion header found in sheet config, trying alternatives');
            // Try alternative headers
            const alternativeHeaders = ['reasonHeader', 'nameHeader', 'classHeader'];
            for (const header of alternativeHeaders) {
              if (sheetCfg.guessedConfig && sheetCfg.guessedConfig[header]) {
                topic = sheetCfg.guessedConfig[header];
                console.log(`âœ… Topic from alternative header (${header}):`, topic);
                break;
              } else if (sheetCfg[header]) {
                topic = sheetCfg[header];
                console.log(`âœ… Topic from direct alternative header (${header}):`, topic);
                break;
              }
            }
            // ã‚·ãƒ¼ãƒˆåã§ã¯ãªãã€é©åˆ‡ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            topic = 'ï¼ˆè³ªå•æ–‡ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰';
          }
        } catch (e) {
          // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆç›´å¾Œã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ”¹å–„
          if (sheetName && fullCfg['sheet_' + (sheetName || '')] && fullCfg['sheet_' + (sheetName || '')].flowType === 'quickstart') {
            // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè³ªå•æ–‡ã‚’è¡¨ç¤º
            topic = 'ã‚ãªãŸã®è€ƒãˆã‚„æ°—ã¥ã„ãŸã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„';
          } else {
            topic = 'ï¼ˆè³ªå•æ–‡ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰';
          }
        }
      } else {
        // ã‚·ãƒ¼ãƒˆåã‚’ãã®ã¾ã¾è¡¨ç¤ºã›ãšã€é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        topic = 'ï¼ˆè³ªå•æ–‡ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰';
      }
    }
  }

  topicTextElement.textContent = topic;
  
  // äºˆå®šçµ‚äº†æ—¥æ™‚ã®æ›´æ–°
  if (scheduledEndTimeElement) {
    updateScheduledEndTime(cfg, scheduledEndTimeElement);
  }
}

// äºˆå®šçµ‚äº†æ—¥æ™‚ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateScheduledEndTime(config, element) {
  // è¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰ scheduledEndAt ã‚’å–å¾—ã‚’è©¦è¡Œ
  const scheduledEndAt = config.scheduledEndAt || 
                         config.scheduledEndTime ||
                         (window.lastStatusCache && window.lastStatusCache.config && window.lastStatusCache.config.scheduledEndAt) ||
                         (window.lastStatusCache && window.lastStatusCache.config && window.lastStatusCache.config.scheduledEndTime);
  
  // scheduledEndAtãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€publishedAt + autoStopMinutesã‹ã‚‰è¨ˆç®—
  let finalScheduledEndTime = scheduledEndAt;
  
  if (!finalScheduledEndTime && config.publishedAt && config.autoStopMinutes) {
    const publishedTime = new Date(config.publishedAt);
    const autoStopMs = config.autoStopMinutes * 60 * 1000;
    finalScheduledEndTime = new Date(publishedTime.getTime() + autoStopMs).toISOString();
    console.log('ğŸ• çµ‚äº†äºˆå®šæ™‚åˆ»ã‚’è¨ˆç®—ã—ã¾ã—ãŸ:', finalScheduledEndTime);
  }
  
  if (finalScheduledEndTime) {
    try {
      const endDate = new Date(finalScheduledEndTime);
      const formattedTime = endDate.toLocaleString('ja-JP', {
        year: '2-digit',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // ç¾åœ¨æ™‚åˆ»ã¨ã®æ¯”è¼ƒ
      const now = new Date();
      const isOverdue = endDate < now;
      const timeRemaining = endDate.getTime() - now.getTime();
      const oneHourMs = 60 * 60 * 1000; // 1æ™‚é–“ã®ãƒŸãƒªç§’
      
      if (isOverdue) {
        element.textContent = `${formattedTime} (æœŸé™åˆ‡ã‚Œ)`;
        element.className = 'text-xs font-medium text-red-400';
      } else if (timeRemaining <= oneHourMs) {
        // 1æ™‚é–“ä»¥å†…ã®å ´åˆã¯è­¦å‘Šè¡¨ç¤º
        const minutesRemaining = Math.floor(timeRemaining / (60 * 1000));
        element.textContent = `${formattedTime} (æ®‹ã‚Š${minutesRemaining}åˆ†)`;
        element.className = 'text-xs font-medium text-red-400 animate-pulse';
        console.log('âš ï¸ æœŸé™ã¾ã§1æ™‚é–“ä»¥å†…ã§ã™:', minutesRemaining + 'åˆ†');
      } else {
        element.textContent = formattedTime;
        element.className = 'text-xs font-medium text-orange-400';
      }
    } catch (e) {
      element.textContent = 'è¨­å®šã‚¨ãƒ©ãƒ¼';
      element.className = 'text-xs font-medium text-gray-400';
    }
  } else {
    element.textContent = 'æœªè¨­å®š';
    element.className = 'text-xs font-medium text-gray-400';
  }
}

// Update guidance text for specific step
function updateGuidanceForStep(step, guidanceElement) {
  const messages = {
    1: 'ã‚¹ãƒ†ãƒƒãƒ—1: ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã¾ãŸã¯æ—¢å­˜ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚',
    2: 'ã‚¹ãƒ†ãƒƒãƒ—2: è¡¨ç¤ºã—ãŸã„ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚',
    3: 'ã‚¹ãƒ†ãƒƒãƒ—3: åˆ—ã‚’è¨­å®šã—ã¦ãƒœãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¾ã—ã‚‡ã†'
  };
  
  // å…¬é–‹çµ‚äº†å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—1ã§ã¯ã€æ˜ç¢ºã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å†é–‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
  if (step === 1) {
    guidanceElement.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¦ãã ã•ã„';
  } else {
    guidanceElement.textContent = messages[step] || 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¦ãã ã•ã„';
  }
}

// è‡ªå‹•åœæ­¢é€šçŸ¥ã®è¡¨ç¤ºãƒã‚§ãƒƒã‚¯
function checkAndShowAutoStopNotification(status) {
  const notificationElement = document.getElementById('auto-stop-notification');
  const autoStoppedTimeElement = document.getElementById('auto-stopped-time');
  
  if (!notificationElement || !autoStoppedTimeElement) return;
  
  const config = status.config || {};
  
  // è‡ªå‹•åœæ­¢ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿é€šçŸ¥ã‚’è¡¨ç¤º
  if (config.autoStoppedAt && config.autoStopReason === 'scheduled_timeout') {
    console.log('ğŸ”” è‡ªå‹•åœæ­¢é€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã™:', config.autoStoppedAt);
    
    // åœæ­¢æ™‚åˆ»ã‚’è¡¨ç¤º
    try {
      const stoppedDate = new Date(config.autoStoppedAt);
      const formattedTime = stoppedDate.toLocaleString('ja-JP', {
        year: '2-digit',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      autoStoppedTimeElement.textContent = formattedTime;
    } catch (e) {
      autoStoppedTimeElement.textContent = 'æ™‚åˆ»ä¸æ˜';
    }
    
    // é€šçŸ¥ã‚’è¡¨ç¤º
    notificationElement.classList.remove('hidden');
    
    // å†å…¬é–‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    const republishBtn = document.getElementById('republish-after-auto-stop-btn');
    if (republishBtn) {
      // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
      republishBtn.replaceWith(republishBtn.cloneNode(true));
      
      // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const newRepublishBtn = document.getElementById('republish-after-auto-stop-btn');
      newRepublishBtn.addEventListener('click', function() {
        // Step 3ã«ç§»å‹•ã—ã¦å†å…¬é–‹ã‚’ä¿ƒã™
        const step3Section = document.getElementById('step3-content');
        if (step3Section) {
          step3Section.classList.remove('hidden');
          step3Section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // é€šçŸ¥ã‚’éè¡¨ç¤º
        notificationElement.classList.add('hidden');
        
        showMessage('è¡¨ç¤ºè¨­å®šã‚’ç¢ºèªã—ã¦å†å…¬é–‹ã—ã¦ãã ã•ã„', 'info');
      });
    }
  } else {
    // è‡ªå‹•åœæ­¢ã•ã‚Œã¦ã„ãªã„å ´åˆã¯é€šçŸ¥ã‚’éè¡¨ç¤º
    notificationElement.classList.add('hidden');
  }
}

// =============================================================================
// SECTION TOGGLE FUNCTIONALITY
// =============================================================================

// Toggle section expansion/collapse
// toggleSection function is now defined in adminPanel-framework.js.html

// Automatically collapse completed sections
function collapseCompletedSection(stepNumber) {
  const sectionId = `step${stepNumber}-content`;
  const section = document.getElementById(sectionId);
  if (!section) return;
  
  console.log(`ğŸ“ Auto-collapsing completed step ${stepNumber}`);
  
  // Collapse the section
  section.classList.add('hidden');
  
  // Update toggle button state
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  if (toggleBtn) {
    toggleBtn.setAttribute('aria-expanded', 'false');
    const arrow = toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
    if (arrow) {
      arrow.classList.remove('fa-chevron-down');
      arrow.classList.add('fa-chevron-up');
    }
  }
  
  // Note: Visual indicators are now managed by manageSectionStates()
}

// Automatically expand active section
function expandActiveSection(stepNumber) {
  const sectionId = `step${stepNumber}-content`;
  const section = document.getElementById(sectionId);
  if (!section) return;
  
  console.log(`ğŸ“‚ Auto-expanding active step ${stepNumber}`);
  
  // Expand the section
  section.classList.remove('hidden');
  
  // Special handling for Step 3: ensure config-area is visible
  if (stepNumber === 3) {
    const configArea = document.getElementById('config-area');
    if (configArea && currentStatus && currentStatus.activeSheetName) {
      configArea.classList.remove('hidden');
      console.log(`ğŸ“‹ expandActiveSection: Config area shown for Step 3`);
    }
  }
  
  // Update toggle button state
  const toggleBtn = document.querySelector(`[onclick*="${sectionId}"]`);
  if (toggleBtn) {
    toggleBtn.setAttribute('aria-expanded', 'true');
    const arrow = toggleBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
    if (arrow) {
      arrow.classList.remove('fa-chevron-up');
      arrow.classList.add('fa-chevron-down');
    }
  }
  
  // Note: Visual indicators are now managed by manageSectionStates()
}

// Manage section states based on current step (simplified - no visual effects)
function manageSectionStates(currentStep) {
  console.log(`ğŸ”„ Managing section states for step ${currentStep}`);
  
  // ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡
  for (let i = 1; i <= 3; i++) {
    const sectionId = `step${i}-content`;
    const section = document.getElementById(sectionId);
    
    if (i === currentStep) {
      // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—: å±•é–‹ã—ã¦æœ‰åŠ¹åŒ–
      expandActiveSection(i);
      
      // Step 3ã®ç‰¹åˆ¥å‡¦ç†: config-areaã®è¡¨ç¤º
      if (i === 3) {
        const configArea = document.getElementById('config-area');
        if (configArea && currentStatus && currentStatus.activeSheetName) {
          configArea.classList.remove('hidden');
          console.log(`ğŸ“‹ Step 3: Config area shown for sheet: ${currentStatus.activeSheetName}`);
        }
      }
      
      console.log(`ğŸ”„ Step ${i}: Active (current step)`);
    } else if (i < currentStep) {
      // å®Œäº†æ¸ˆã¿ã‚¹ãƒ†ãƒƒãƒ—: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã ãŒã€å±•é–‹ã¯ä»»æ„
      if (section) {
        section.classList.add('opacity-90'); // å®Œäº†ã—ãŸçŠ¶æ…‹ã‚’è¦–è¦šçš„ã«ç¤ºã™
      }
      console.log(`âœ… Step ${i}: Completed (accessible)`);
    } else {
      // æœªæ¥ã®ã‚¹ãƒ†ãƒƒãƒ—: Step 1ã®å ´åˆã¯pendingçŠ¶æ…‹ã§ã‚‚å…¨ã¦é–²è¦§å¯èƒ½
      if (currentStep === 1) {
        // Step 1ã§ã¯å…¨ã‚¹ãƒ†ãƒƒãƒ—ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆãƒ‡ãƒ¼ã‚¿ç¢ºèªã®ãŸã‚ï¼‰
        if (section) {
          section.classList.add('opacity-75'); // æœªæ¥ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦è»½ãè¡¨ç¤º
        }
        console.log(`â­ï¸ Step ${i}: Available for preview`);
      } else {
        // Step 2ä»¥é™ã§ã¯é †æ¬¡é–‹æ”¾
        if (section) {
          section.classList.add('opacity-50'); // æœªæ¥ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦è¡¨ç¤º
        }
        console.log(`â­ï¸ Step ${i}: Future step (available)`);
      }
    }
  }
}

// =============================================================================
// MODAL MANAGEMENT
// =============================================================================

// Show form configuration modal
// showFormConfigModal function is now defined in adminPanel-framework.js.html

// Hide form configuration modal
function hideFormConfigModal() {
  if (window.sharedModals) {
    window.sharedModals.hideModal('form-config-modal');
    manageFocusForModal('form-config-modal', false);
  } else {
    // Fallback for legacy support
    const modal = document.getElementById('form-config-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      manageFocusForModal('form-config-modal', false);
    }
  }
}

// Override placeholder with actual function
if (typeof window !== 'undefined') {
  window.hideFormConfigModal = hideFormConfigModal;
}

// Show privacy modal
function showPrivacyModal(onContinue) {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('privacy-modal', true);
    
    // Set up continue handler
    const continueBtn = document.getElementById('privacy-modal-continue');
    if (continueBtn && onContinue) {
      continueBtn.onclick = onContinue;
    }
  }
}

// Override placeholder with actual function
if (typeof window !== 'undefined') {
  window.showPrivacyModal = showPrivacyModal;
}

// Hide privacy modal
// hidePrivacyModal function is now defined in adminPanel-framework.js.html

// Show digital citizenship modal
function showDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('digital-citizenship-modal', true);
  }
}

// Hide digital citizenship modal
function hideDigitalCitizenshipModal() {
  const modal = document.getElementById('digital-citizenship-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('digital-citizenship-modal', false);
  }
}

// Show confirmation modal
function showConfirmationModal(title, message, onConfirm) {
  const modal = document.getElementById('confirmation-modal');
  const titleElement = document.getElementById('modal-title');
  const messageElement = document.getElementById('modal-message');
  const confirmBtn = document.getElementById('modal-confirm-btn');
  const cancelBtn = document.getElementById('modal-cancel-btn');
  
  console.log('ğŸ” showConfirmationModal: è¦ç´ æ¤œç´¢å®Œäº†');
  
  if (modal && titleElement && messageElement && confirmBtn) {
    titleElement.textContent = title;
    messageElement.textContent = message;
    
    // ç¢ºèªãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    confirmBtn.onclick = function() {
      console.log('âœ… ç¢ºèªãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      hideConfirmationModal();
      if (onConfirm) {
        try {
          onConfirm();
        } catch (error) {
          console.error('âŒ ç¢ºèªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
        }
      }
    };
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    if (cancelBtn) {
      cancelBtn.onclick = function() {
        console.log('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
        hideConfirmationModal();
      };
    }
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    manageFocusForModal('confirmation-modal', true);
    console.log('âœ… ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
  } else {
    console.error('âŒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    if (window.confirm(`${title}\n\n${message}`)) {
      if (onConfirm) {
        try {
          onConfirm();
        } catch (error) {
          console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¢ºèªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
        }
      }
    }
  }
}

// Hide confirmation modal
function hideConfirmationModal() {
  const modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    manageFocusForModal('confirmation-modal', false);
  }
}

// =============================================================================
// DYNAMIC CONTENT UPDATES
// =============================================================================

// Update dynamic content when board is active
function updateDynamicContent(status) {
  // Enable buttons that require active state
  const buttons = [
    'open-spreadsheet-btn'
  ];
  
  buttons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = false;
      button.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  });
}

// Update UI when no sheet is active
function updateUIForNoActiveSheet(status) {
  // Disable buttons that require active state
  const buttons = [
    // No form buttons to disable since we only support spreadsheets
  ];
  
  buttons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = true;
      button.classList.add('opacity-50', 'cursor-not-allowed');
    }
  });
}

// Update existing user section
function updateExistingUserSection(status) {
  // Update any user-specific UI elements
  if (status.userInfo) {
    // Update user-specific elements here if needed
  }
}

// Update custom form info
function updateCustomFormInfo(status) {
  if (status.customFormInfo) {
    // Update form-related UI elements
    const formTitle = document.getElementById('form-title-display');
    const formQuestion = document.getElementById('form-question-display');
    
    if (formTitle) {
      formTitle.textContent = status.customFormInfo.title || 'ãƒ•ã‚©ãƒ¼ãƒ æœªä½œæˆ';
    }
    
    if (formQuestion) {
      formQuestion.textContent = status.customFormInfo.mainQuestion || '';
    }
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ URLè¡¨ç¤ºã®æ›´æ–°ï¼ˆconfigJsonã‹ã‚‰ç¢ºå®Ÿã«å–å¾—ï¼‰
  updateFormUrlDisplay(status);
}

// ãƒ•ã‚©ãƒ¼ãƒ URLè¡¨ç¤ºã‚’ç¢ºå®Ÿã«æ›´æ–°
// Full implementation of updateFormUrlDisplay (framework has minimal version)
function _fullUpdateFormUrlDisplay(status = null) {
  const formUrlInput = document.getElementById('form-url-input');
  const formUrlSection = document.getElementById('form-url-section');
  const openFormLink = document.getElementById('open-form-url-link');

  if (!formUrlInput) return;

  // ç¾åœ¨ã®statusã®æœ€é©åŒ–ã•ã‚ŒãŸå–å¾—
  const currentStatusToUse = status || currentStatus;
  if (!currentStatusToUse || !currentStatusToUse.userInfo) {
    logWarn('âš ï¸ updateFormUrlDisplay: statusæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
    return;
  }

  // æ–°ã—ã„çµ±ä¸€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ URLã‚’å–å¾—
  const resourceUrls = getActiveResourceUrls(currentStatusToUse);
  const formUrl = resourceUrls.form;

  // UIæ›´æ–°ã®æœ€é©åŒ–
  if (formUrl) {
    updateFormUrlElements(formUrlInput, openFormLink, formUrl);
    handleFormUrlSectionVisibility(formUrlSection);
    logDebug('ğŸ”— FormURL UIæ›´æ–°å®Œäº†:', formUrl);
  } else {
    clearFormUrlElements(formUrlInput, formUrlSection);
    logDebug('ğŸ“­ FormURLæœªè¨­å®šã®ãŸã‚UIéè¡¨ç¤º');
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ URLè¦ç´ æ›´æ–°ã®æœ€é©åŒ–
function updateFormUrlElements(input, link, url) {
  input.value = url;
  if (link) {
    link.href = url;
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ URLè¦ç´ ã‚¯ãƒªã‚¢ã®æœ€é©åŒ–
function clearFormUrlElements(input, section) {
  input.value = '';
  if (section) {
    section.classList.add('hidden');
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ URLã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ¶å¾¡ã®æœ€é©åŒ–
function handleFormUrlSectionVisibility(section) {
  if (!section) return;
  
  const formJustCreated = sessionStorage.getItem('form_just_created');
  if (formJustCreated === 'true') {
    section.classList.remove('hidden');
    logDebug('ğŸ†• æ–°è¦ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º');
    
    // ãƒ•ãƒ©ã‚°ã‚¯ãƒªã‚¢ã®æœ€é©åŒ–ï¼ˆã‚¿ã‚¤ãƒãƒ¼å‡¦ç†ï¼‰
    setTimeout(() => {
      sessionStorage.removeItem('form_just_created');
      logDebug('ğŸ§¹ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ•ãƒ©ã‚°ã‚¯ãƒªã‚¢');
    }, 10000);
  } else {
    section.classList.add('hidden');
  }
}

// Check for auto-publish dialog
function checkAutoPublishDialog(status) {
  // Implementation for auto-publish dialog if needed
  if (status.needsAutoPublish) {
    // Show auto-publish confirmation
  }
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// UI initialization is now handled in adminPanel-framework.js.html

// =============================================================================
// SHEET SELECTION FUNCTIONALITY  
// =============================================================================

// ã‚·ãƒ¼ãƒˆé¸æŠå‡¦ç†ä¸­ãƒ•ãƒ©ã‚°ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
let sheetSelectionInProgress = false;

// Handle sheet selection change (æœ€é©åŒ–ç‰ˆ)
async function handleSheetSelectionChange(event) {
  const newSelectedSheet = event.target.value;

  // é‡è¤‡å®Ÿè¡Œé˜²æ­¢
  if (sheetSelectionInProgress) {
    console.log('ğŸ“Š Sheet selection already in progress, skipping...');
    return;
  }

  // Prevent redundant calls if the selected sheet hasn't actually changed
  if (newSelectedSheet === lastSelectedSheetName) {
    console.log('ğŸ“Š Sheet selection unchanged, skipping redundant processing.');
    return;
  }
  
  sheetSelectionInProgress = true;
  console.log('ğŸ“Š Sheet selection changed: ' + newSelectedSheet);
  
  try {
    // Update global selected sheet variable and last selected sheet
    selectedSheet = newSelectedSheet;
    lastSelectedSheetName = newSelectedSheet;
    
    if (newSelectedSheet) {
      console.log('ğŸ“‹ Loading config for sheet:', newSelectedSheet);

      // å±¥æ­´å¾©å…ƒä¸­ã¯ç‰¹åˆ¥ãªå‡¦ç†ã‚’å®Ÿè¡Œ
      if (window._historyRestoreInProgress || window._historyColumnSelections) {
        console.log('ğŸ”„ å±¥æ­´å¾©å…ƒä¸­: å°‚ç”¨ã®è¨­å®šèª­ã¿è¾¼ã¿å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™');
        await _loadConfigForHistoryRestore(newSelectedSheet);
        updateUIForSelectedSheet();
        return;
      }

      // åŸºæœ¬æ¤œè¨¼
      if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
        console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // ã‚·ãƒ¼ãƒˆåã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã—ã¦ã‹ã‚‰APIå‘¼ã³å‡ºã—
      const sanitizedSheetName = newSelectedSheet.replace(/[^\w\s\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF-]/g, '').trim();
      console.log(`ğŸ”„ Sanitized sheet name: "${newSelectedSheet}" â†’ "${sanitizedSheetName}"`);

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆã®åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åˆ—é¸æŠã‚’æ›´æ–°
      const effectiveId = _resolveSpreadsheetIdForApi(currentStatus);
      loadConfigForSelected(sanitizedSheetName, effectiveId)
        .then(result => {
          console.log('âœ… ã‚·ãƒ¼ãƒˆè¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:', result);
          updateUIForSelectedSheet();
        })
        .catch(error => {
          console.error('âŒ ã‚·ãƒ¼ãƒˆè¨­å®šèª­ã¿è¾¼ã¿å¤±æ•—:', error);
          showMessage('ã‚·ãƒ¼ãƒˆã®è¨­å®šèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          updateUIForSelectedSheet();
        })
        .finally(() => {
          // å‡¦ç†ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
          sheetSelectionInProgress = false;
        });
        
      // å³åº§ã«ã‚·ãƒ¼ãƒˆã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
      activateSelectedSheet(newSelectedSheet);
    } else {
      // ã‚·ãƒ¼ãƒˆé¸æŠãŒè§£é™¤ã•ã‚ŒãŸå ´åˆ
      clearColumnSelections();
      updateUIForSelectedSheet();
    }
  } catch (error) {
    console.error('âŒ Sheet selection error:', error);
  } finally {
    // å‡¦ç†ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç¢ºå®Ÿã«ï¼‰
    sheetSelectionInProgress = false;
  }
}

// ã‚·ãƒ¼ãƒˆã‚’å³åº§ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã™ã‚‹é–¢æ•°
/**
 * ã‚·ãƒ¼ãƒˆã‚’å³åº§ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã—ã€UIä¸Šã®é¸æŠçŠ¶æ…‹ã‚‚åŒæœŸã™ã‚‹
 * @param {string} sheetName - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ã‚·ãƒ¼ãƒˆå
 */
function activateSelectedSheet(sheetName) {
  if (!sheetName || !currentStatus || !currentStatus.userInfo) {
    console.warn('âš ï¸ ã‚·ãƒ¼ãƒˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã«å¿…è¦ãªæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
    return;
  }

  console.log(`ğŸ¯ ã‚·ãƒ¼ãƒˆã‚’å³åº§ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–: ${sheetName}`);
  
  // ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆã‚’è¨­å®š
  runGasWithUserId('setActiveSheet', 'ã‚·ãƒ¼ãƒˆã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ä¸­...', sheetName)
    .then(response => {
      console.log('âœ… ã‚·ãƒ¼ãƒˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–å®Œäº†:', response);
      
      // currentStatusã‚’æ›´æ–°
      if (currentStatus.userInfo.configJson) {
        try {
          const config = JSON.parse(currentStatus.userInfo.configJson);
          config.publishedSheetName = sheetName;
          currentStatus.userInfo.configJson = JSON.stringify(config);
          currentStatus.activeSheetName = sheetName;
          
          // UIä¸Šã®ã‚·ãƒ¼ãƒˆé¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
          updateActiveSheetUI(sheetName);
          
          console.log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹æ›´æ–°å®Œäº†');
        } catch (e) {
          console.warn('âš ï¸ configJsonæ›´æ–°ã«å¤±æ•—:', e);
        }
      }
    })
    .catch(error => {
      console.error('âŒ ã‚·ãƒ¼ãƒˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–å¤±æ•—:', error);
      showMessage('ã‚·ãƒ¼ãƒˆã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
    });
}

// ã‚·ãƒ¼ãƒˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤ºã‚’æ›´æ–°
function updateSheetSelectActiveIndicator(activeSheetName) {
  const select = document.getElementById('sheet-select');
  if (!select) return;
  
  // å…¨ã¦ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤ºã‚’å‰Šé™¤
  Array.from(select.options).forEach(option => {
    if (option.value && option.textContent.includes(' (ã‚¢ã‚¯ãƒ†ã‚£ãƒ–)')) {
      option.textContent = option.value;
      option.style.fontWeight = 'normal';
      option.style.color = '';
      option.className = '';
    }
  });
  
  // æ–°ã—ã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆã«è¡¨ç¤ºã‚’è¿½åŠ 
  const activeOption = Array.from(select.options).find(option => option.value === activeSheetName);
  if (activeOption) {
    activeOption.textContent = `${activeSheetName} (ã‚¢ã‚¯ãƒ†ã‚£ãƒ–)`;
    activeOption.style.fontWeight = 'bold';
    activeOption.style.color = '#10b981';
    activeOption.className = 'active-sheet-option';
  }
}

// é‡è¤‡UIæ›´æ–°é˜²æ­¢ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
let lastUIUpdateSheet = null;
let uiUpdateCount = 0;

// æ–°ã—ã„é–¢æ•°: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆUIæ›´æ–°
function updateActiveSheetUI(sheetName) {
  // é‡è¤‡é˜²æ­¢: åŒã˜ã‚·ãƒ¼ãƒˆã«å¯¾ã™ã‚‹é€£ç¶šæ›´æ–°ã‚’åˆ¶é™
  if (lastUIUpdateSheet === sheetName && uiUpdateCount >= 2) {
    return; // é‡è¤‡æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—
  }
  
  if (lastUIUpdateSheet !== sheetName) {
    uiUpdateCount = 0; // æ–°ã—ã„ã‚·ãƒ¼ãƒˆã®å ´åˆã¯ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
  }
  
  console.log('ğŸ”„ updateActiveSheetUI called with:', sheetName);
  
  const select = document.getElementById('sheet-select');
  if (!select) {
    console.warn('âš ï¸ Sheet select element not found');
    return;
  }
  
  // ã‚·ãƒ¼ãƒˆé¸æŠã‚’æ›´æ–°
  if (sheetName && select.value !== sheetName) {
    const normalizedSheetName = sheetName.trim();
    const availableOptions = Array.from(select.options);
    const matchingOption = availableOptions.find(option => option.value === normalizedSheetName);
    
    if (matchingOption) {
      select.value = normalizedSheetName;
      selectedSheet = normalizedSheetName;
      lastSelectedSheetName = normalizedSheetName;
      lastUIUpdateSheet = normalizedSheetName;
      uiUpdateCount++;
      console.log('âœ… Active sheet UI updated:', normalizedSheetName);
      
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤ºã‚‚æ›´æ–°
      updateSheetSelectActiveIndicator(normalizedSheetName);
      
      // UIçŠ¶æ…‹ã‚‚æ›´æ–°
      updateUIForSelectedSheet();
    } else {
      console.warn('âš ï¸ Sheet not found in select options:', normalizedSheetName);
    }
  }
}

// æ–°ã—ã„é–¢æ•°: ã‚·ãƒ¼ãƒˆé¸æŠã®å†åŒæœŸ
function refreshSheetSelection() {
  console.log('ğŸ”„ refreshSheetSelection called');
  
  // ç¾åœ¨ã®çŠ¶æ…‹ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—
  if (window.currentStatus && window.currentStatus.activeSheetName) {
    updateActiveSheetUI(window.currentStatus.activeSheetName);
  } else if (selectedSheet) {
    updateActiveSheetUI(selectedSheet);
  }
}

// åˆ—é¸æŠã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
function clearColumnSelections() {
  console.log('ğŸ§¹ åˆ—é¸æŠã‚’ã‚¯ãƒªã‚¢');
  
  const columnSelects = [
    'opinion-column',
    'name-column', 
    'reason-column',
    'class-column',
    'timestamp-column'
  ];
  
  columnSelects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.innerHTML = '<option value="">-- ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      select.disabled = true;
    }
  });
}

// Load configuration for selected sheet - OPTIMIZED
// åŠ¹ç‡çš„ã«APIç”¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’è§£æ±º
function _resolveSpreadsheetIdForApi(status) {
  try {
    const st = status || window.currentStatus || {};
    // æœ€å„ªå…ˆ: userInfo.spreadsheetIdï¼ˆç›´è¿‘ã®åˆ‡æ›¿ã‚’åæ˜ ï¼‰
    if (st.userInfo && st.userInfo.spreadsheetId) return st.userInfo.spreadsheetId;
    // æ¬¡ç‚¹: configJson.publishedSpreadsheetId
    if (st.configJson && st.configJson.publishedSpreadsheetId) return st.configJson.publishedSpreadsheetId;
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: URLã‹ã‚‰æŠ½å‡º
    const url = (st.userInfo && st.userInfo.spreadsheetUrl) || (st.appUrls && st.appUrls.spreadsheetUrl) || null;
    if (url) {
      const m = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
      if (m && m[1]) return m[1];
    }
  } catch (e) {
    console.warn('âš ï¸ _resolveSpreadsheetIdForApi failed:', e.message);
  }
  return null;
}

// ä»£æ›¿å€™è£œã®IDï¼ˆuserInfoã¨configJsonã‚’å…¥ã‚Œæ›¿ãˆï¼‰
function _resolveAltSpreadsheetId(status, primaryId) {
  const st = status || window.currentStatus || {};
  const cand1 = st.configJson && st.configJson.publishedSpreadsheetId;
  const cand2 = st.userInfo && st.userInfo.spreadsheetId;
  if (cand1 && cand1 !== primaryId) return cand1;
  if (cand2 && cand2 !== primaryId) return cand2;
  return null;
}

function loadConfigForSelected(sheetName, spreadsheetId, retryCount = 0, maxRetries = 3) {
  console.log('ğŸ“‹ Loading config for: ' + sheetName);

  // è¶³ã‚Šãªã„å ´åˆã¯ãã®å ´ã§è§£æ±º
  if (!spreadsheetId) {
    spreadsheetId = _resolveSpreadsheetIdForApi(window.currentStatus);
  }

  if (!spreadsheetId || !sheetName) {
    console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚');
    return Promise.reject(new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™'));
  }

  return new Promise((resolve, reject) => {

  // Check if fresh save protection is active - skip cache if so
  const timeSinceFreshSave = Date.now() - (window.freshSaveTimestamp || 0);
  const isFreshSaveActive = timeSinceFreshSave < 30000; // 30 seconds
  
    // Check if we already have sheet details from integrated API
    if (!isFreshSaveActive && currentStatus && currentStatus.sheetDetails && 
        currentStatus.activeSheetName === sheetName && currentStatus.sheetDetails.allHeaders && currentStatus.sheetDetails.allHeaders.length > 0) {
      console.log('âš¡ Using cached sheet details from integrated API');
      try {
        populateHeaderOptions(currentStatus.sheetDetails.allHeaders);
        console.log('âœ… Header options populated from cache');
        populateConfig(currentStatus.sheetDetails.guessedConfig);
        console.log('âœ… AI configuration applied from cache');
        resolve({ source: 'cache', headers: currentStatus.sheetDetails.allHeaders, config: currentStatus.sheetDetails.guessedConfig });
        return; // Early return - no API call needed
      } catch (error) {
        console.error('Error in cached config population:', error);
        // Fall through to API call if cache fails
      }
    }

  // Force fresh API call if fresh save protection is active or cache unavailable
  if (isFreshSaveActive) {
    console.log('ğŸ”„ Fresh save protection active - forcing API call for latest data');
  } else {
    console.log('ğŸ“ Making API call for sheet details:', sheetName);
  }
  
    runGasWithUserId('getSheetDetails', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—ä¸­...', spreadsheetId, sheetName)
      .then(function(details) {
        // Sheet details loaded - verbose logging disabled
        
        // If headers are empty, and we have retries left, try again after a delay
        if (details && (!details.allHeaders || details.allHeaders.length === 0) && retryCount < maxRetries) {
          console.warn(`âš ï¸ No headers found for ${sheetName}. Retrying in 2 seconds... (Attempt ${retryCount + 1}/${maxRetries})`);
          showMessage(`ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å†å–å¾—ä¸­... (${retryCount + 1}/${maxRetries})`, 'info');
          setTimeout(() => {
            loadConfigForSelected(sheetName, spreadsheetId, retryCount + 1, maxRetries)
              .then(resolve)
              .catch(reject);
          }, 2000); // Retry after 2 seconds
          return;
        }

        try {
          // 1) ãƒ˜ãƒƒãƒ€ãƒ¼ä¸€è¦§ã‚’UIã¸åæ˜ 
          populateHeaderOptions(details.allHeaders);
          console.log('âœ… Header options populated from API');

          // 2) å±¥æ­´å¾©å…ƒä¸­ã¯AIæ¨å®šã®ä¸Šæ›¸ãã‚’é¿ã‘ã‚‹ï¼ˆåˆ—é¸æŠã‚’å†é©ç”¨ï¼‰
          if (window._historyRestoreInProgress) {
            console.log('ğŸ›¡ï¸ å±¥æ­´å¾©å…ƒä¸­: AIæ¨å®šã®é©ç”¨ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€å±¥æ­´ã®åˆ—é¸æŠã‚’å†é©ç”¨ã—ã¾ã™');
            const sel = window._historyColumnSelections || {};
            const applyIf = (id, val) => {
              if (!val) return;
              const el = document.getElementById(id);
              if (el) el.value = val;
            };
            applyIf('opinionHeader', sel.opinionColumn);
            applyIf('name-column', sel.nameColumn);
            applyIf('class-column', sel.classColumn);
            applyIf('reason-column', sel.reasonColumn);
            // ä¸€åº¦é©ç”¨ã—ãŸã‚‰ã‚¯ãƒªã‚¢
            window._historyColumnSelections = null;
          } else {
            // é€šå¸¸æ™‚ã¯AIæ¨å®šã‚’é©ç”¨
            populateConfig(details.guessedConfig);
            console.log('âœ… AI configuration applied from API');
          }
          if (retryCount > 0) {
            showMessage('âœ… ã‚·ãƒ¼ãƒˆæƒ…å ±ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼', 'success');
          }
          resolve({ source: 'api', headers: details.allHeaders, config: details.guessedConfig });
        } catch (error) {
          console.error('Error in API config population sequence:', error);
          showMessage('è¨­å®šã®é©ç”¨ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          reject(error);
        }
      })
      .catch(function(error) {
        console.error('Failed to load sheet config via API:', error);
        
        // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
        let errorMessage = 'ã‚·ãƒ¼ãƒˆè¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
        
        if (error && error.message) {
          if (error.message.includes('ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
            errorMessage = `æŒ‡å®šã•ã‚ŒãŸã‚·ãƒ¼ãƒˆ "${sheetName}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`;
          } else if (error.message.includes('ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
            errorMessage = `ã‚·ãƒ¼ãƒˆ "${sheetName}" ã®1è¡Œç›®ã«ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`;
          } else if (error.message.includes('ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™')) {
            errorMessage = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
          } else if (error.message.includes('SheetsService')) {
            errorMessage = 'Google Sheets APIã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
          } else {
            errorMessage = `ã‚¨ãƒ©ãƒ¼ã®è©³ç´°: ${error.message}`;
          }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è©¦è¡Œ: spreadsheetIdã‚’çœç•¥ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã®æ—¢å®šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼‰
        const maybeNotFound = error && (error.message.includes('ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“') || error.message.includes('Unable to parse range'));
        if (maybeNotFound && spreadsheetId && retryCount === 0) {
          // ä»£æ›¿ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã§å†è©¦è¡Œï¼ˆã‚µãƒ¼ãƒãƒ¼å´ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ä¾å­˜ã—ãªã„ï¼‰
          const altId = _resolveAltSpreadsheetId(window.currentStatus, spreadsheetId);
          if (altId) {
            console.warn('âš ï¸ Fallback: Retrying getSheetDetails with alt spreadsheetId');
            return runGasWithUserId('getSheetDetails', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å†å–å¾—ä¸­...', altId, sheetName)
              .then(details => {
                try {
                  populateHeaderOptions(details.allHeaders);
                  console.log('âœ… Header options populated from fallback API');
                  if (window._historyRestoreInProgress) {
                    const sel = window._historyColumnSelections || {};
                    const applyIf = (id, val) => {
                      if (!val) return;
                      const el = document.getElementById(id);
                      if (el) el.value = val;
                    };
                    applyIf('opinionHeader', sel.opinionColumn);
                    applyIf('name-column', sel.nameColumn);
                    applyIf('class-column', sel.classColumn);
                    applyIf('reason-column', sel.reasonColumn);
                    window._historyColumnSelections = null;
                  } else {
                    populateConfig(details.guessedConfig);
                    console.log('âœ… AI configuration applied from fallback API');
                  }
                  resolve({ source: 'api-fallback', headers: details.allHeaders, config: details.guessedConfig });
                } catch (err2) {
                  console.error('Error in fallback config population sequence:', err2);
                  showMessage('è¨­å®šã®é©ç”¨ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                  reject(err2);
                }
              })
              .catch(err2 => {
                console.warn('Fallback getSheetDetails also failed:', err2);
                showMessage(errorMessage, 'error');
                // After fallback failure, proceed with normal retry handling below
                // Intentionally no return here to fall through to retry logic
              });
          }
          // altIdãŒãªã‘ã‚Œã°å¾“æ¥ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚µãƒ¼ãƒå´æ—¢å®šï¼‰
          console.warn('âš ï¸ Fallback: Retrying getSheetDetails without spreadsheetId');
          return runGasWithUserId('getSheetDetails', 'ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å†å–å¾—ä¸­...', null, sheetName)
              .then(details => {
                try {
                  populateHeaderOptions(details.allHeaders);
                  console.log('âœ… Header options populated from fallback API');
                if (window._historyRestoreInProgress) {
                  const sel = window._historyColumnSelections || {};
                  const applyIf = (id, val) => {
                    if (!val) return;
                    const el = document.getElementById(id);
                    if (el) el.value = val;
                  };
                  applyIf('opinionHeader', sel.opinionColumn);
                  applyIf('name-column', sel.nameColumn);
                  applyIf('class-column', sel.classColumn);
                  applyIf('reason-column', sel.reasonColumn);
                  window._historyColumnSelections = null;
                } else {
                  populateConfig(details.guessedConfig);
                  console.log('âœ… AI configuration applied from fallback API');
                }
                resolve({ source: 'api-fallback', headers: details.allHeaders, config: details.guessedConfig });
              } catch (err2) {
                console.error('Error in fallback config population sequence:', err2);
                showMessage('è¨­å®šã®é©ç”¨ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                reject(err2);
              }
            })
            .catch(err2 => {
              console.warn('Fallback getSheetDetails also failed:', err2);
              showMessage(errorMessage, 'error');
              // After fallback failure, proceed with normal retry handling below
              // Intentionally no return here to fall through to retry logic
            });
        }

        showMessage(errorMessage, 'error');
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒªãƒˆãƒ©ã‚¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›
        if (retryCount < maxRetries) {
          setTimeout(() => {
            const retryButton = document.createElement('button');
            retryButton.textContent = 'å†è©¦è¡Œ';
            retryButton.className = 'ml-2 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600';
            retryButton.onclick = () => {
              retryButton.remove();
              loadConfigForSelected(sheetName, spreadsheetId, retryCount + 1, maxRetries)
                .then(resolve)
                .catch(reject);
            };
            
            const messageElement = document.querySelector('.message');
            if (messageElement) {
              messageElement.appendChild(retryButton);
            }
          }, 1000);
        } else {
          reject(error);
        }
      });
  }); // Promiseçµ‚äº†
}


// =============================================================================
// SETUP STATUS HANDLING FUNCTIONS
// =============================================================================

/**
 * userInfoã‹ã‚‰setupStatusã‚’å®‰å…¨ã«å–å¾—
 * @param {Object} userInfo - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} setupStatus ('pending', 'completed', 'error')
 */
function getSetupStatusFromUserInfo(userInfo) {
  try {
    if (!userInfo || !userInfo.configJson) {
      return 'pending'; // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒãªã„å ´åˆã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†ã¨ã¿ãªã™
    }

    const config = typeof userInfo.configJson === 'string'
      ? JSON.parse(userInfo.configJson)
      : userInfo.configJson;

    // setupStatusãŒæ˜ç¤ºçš„ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
    if (config.setupStatus) {
      console.log('ğŸ”§ configJson setupStatus:', config.setupStatus);
      return config.setupStatus;
    }
    
    // setupStatusãŒãªã„å ´åˆã€ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰æ¨æ¸¬ï¼ˆå¾ªç’°å‚ç…§å›é¿ï¼‰
    // Note: ã“ã®æ¨æ¸¬ãƒ­ã‚¸ãƒƒã‚¯ã¯å¾ªç’°å‚ç…§ã‚’é¿ã‘ã‚‹ãŸã‚ã€formUrlãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´
    if (config.formCreated === true && config.formUrl && config.formUrl.trim()) {
      return 'completed';
    }
    
    return 'pending';
    
  } catch (error) {
    console.warn('getSetupStatusFromUserInfo JSONè§£æã‚¨ãƒ©ãƒ¼:', error.message);
    return 'pending'; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†ã¨ã¿ãªã™
  }
}


/**
 * åˆæœŸè¡¨ç¤ºè¦ç´ ã‚’ã‚¯ãƒªã‚¢ã—ã¦é©åˆ‡ãªãƒ‰ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ
 */
function clearInitialDisplayElements() {
  // åˆæœŸè¡¨ç¤ºã‚’éè¡¨ç¤ºã«ã—ã¦ã€é©åˆ‡ãªãƒ‰ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ
  const initialContainer = document.getElementById('header-domain-initial');
  if (initialContainer) {
    initialContainer.style.display = 'none';
    console.log('âœ… åˆæœŸãƒ‰ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚’éè¡¨ç¤º');
  }
  
  // é©åˆ‡ãªãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
  showAppropriateHeaderStatus();
  
  // æ—¢å­˜ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã®ã¿å‰Šé™¤
  const existingGuides = [
    document.getElementById('setup-pending-guide'),
    document.querySelector('.setup-guide')
  ];
  
  existingGuides.forEach(guide => {
    if (guide) {
      guide.remove();
      console.log('âœ… æ—¢å­˜ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã‚’å‰Šé™¤');
    }
  });
}

/**
 * ãƒ˜ãƒƒãƒ€ãƒ¼ã«é©åˆ‡ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’è¨­å®š
 */
function showAppropriateHeaderStatus() {
  // ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è‡´è¡¨ç¤ºï¼ˆä»®ï¼‰ã‚’è¡¨ç¤º
  const domainMatch = document.getElementById('header-domain-match');
  const domainMismatch = document.getElementById('header-domain-mismatch');
  
  if (domainMatch && domainMismatch) {
    // ç¾åœ¨ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è‡´ã¨ã—ã¦è¡¨ç¤ºï¼ˆå®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ã¯åˆ¥é€”å®Ÿè£…ï¼‰
    domainMatch.style.display = 'block';
    domainMismatch.style.display = 'none';
    
    // ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’é©åˆ‡ã«è¨­å®š
    const domainText = document.getElementById('header-domain-match-text');
    if (domainText) {
      domainText.textContent = 'naha-okinawa.ed.jp'; // cspell:disable-line
    }
    
    console.log('âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è‡´è¡¨ç¤ºã‚’æœ‰åŠ¹åŒ–');
  }
}

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
 * @param {Object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function updateButtonStatesForSetup(status) {
  // ã‚ˆã‚Šç©ã‚„ã‹ãªUIåˆ¶å¾¡ï¼ˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç„¡åŠ¹åŒ–ã§ã¯ãªãã€é©åˆ‡ãªã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ï¼‰

  // æœ€ä½é™ç„¡åŠ¹åŒ–ã™ã¹ãå…¬é–‹é–¢é€£ãƒœã‚¿ãƒ³ã®ã¿
  const criticalPublishButtons = [
    'save-publish-btn',
    'unpublish-board-btn'
  ];
  
  criticalPublishButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      // ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã®ã¿ç„¡åŠ¹åŒ–
      const hasSpreadsheet = status.userInfo && status.userInfo.spreadsheetId;
      const hasActiveSheet = status.activeSheetName;
      
      if (!hasSpreadsheet || !hasActiveSheet) {
        button.disabled = true;
        button.classList.add('opacity-75');
        button.title = 'å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã‚·ãƒ¼ãƒˆã‚’è¨­å®šã—ã¦ãã ã•ã„';
      } else {
        button.disabled = false;
        button.classList.remove('opacity-75');
        button.title = '';
      }
    }
  });
  
  console.log('âœ… ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’é©åˆ‡ã«æ›´æ–°ã—ã¾ã—ãŸ');
}


/**
 * åŸºæœ¬çš„ãªé™çš„UIè¦ç´ ã®ã¿æ›´æ–°
 * @param {Object} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function updateBasicStaticUI(status) {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãªã©æœ€ä½é™ã®æƒ…å ±ã®ã¿æ›´æ–°
  if (status.userInfo) {
    // æ—¢å­˜ã®updateDatabaseInfoé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦é‡è¤‡ã‚’é¿ã‘ã‚‹
    updateDatabaseInfo(status);
  }
}

// Update system status display
/**
 * ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹URLã‚’å–å¾—ã—ã€çµ±ä¸€ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦è¿”ã™ã€‚
 * @param {object} status - æœ€æ–°ã®ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {object} - å„ãƒªã‚½ãƒ¼ã‚¹ã®URLã‚’æ ¼ç´ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function getActiveResourceUrls(status) {
  const urls = {
    spreadsheet: null,
    folder: null,
    form: null,
    editForm: null
  };

  if (!status || !status.userInfo) {
    return urls; // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒãªã‘ã‚Œã°ç©ºã®URLã‚’è¿”ã™
  }

  // 1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã®å–å¾—ï¼ˆè¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰ç¢ºä¿ï¼‰
  urls.spreadsheet = status.userInfo.spreadsheetUrl || 
                     status.appUrls?.spreadsheetUrl ||
                     (typeof currentSpreadsheetUrl !== 'undefined' ? currentSpreadsheetUrl : null);
  
  console.log('ğŸ“Š Spreadsheet URL determination:', {
    fromUserInfo: status.userInfo.spreadsheetUrl || 'none',
    fromAppUrls: status.appUrls?.spreadsheetUrl || 'none', 
    fromGlobal: (typeof currentSpreadsheetUrl !== 'undefined' ? currentSpreadsheetUrl : 'none'),
    final: urls.spreadsheet
  });

  // 2. configJsonã®è§£æ (ä¸€åº¦ã ã‘å®Ÿè¡Œ)
  let config = {};
  if (status.userInfo.configJson) {
    try {
      config = typeof status.userInfo.configJson === 'string' 
        ? JSON.parse(status.userInfo.configJson) 
        : status.userInfo.configJson;
    } catch (e) {
      console.warn("configJsonã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }
  }

  // 3. ãƒ•ã‚©ãƒ«ãƒ€URLã®å–å¾— (configJsonã‹ã‚‰ã€ã¾ãŸã¯folderId ã‹ã‚‰æ§‹ç¯‰)
  urls.folder = config.folderUrl || null;
  
  // ãƒ•ã‚©ãƒ«ãƒ€URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€folderIdã‹ã‚‰æ§‹ç¯‰ã‚’è©¦è¡Œ
  if (!urls.folder && config.folderId) {
    const safeFolderId = String(config.folderId || '');
    urls.folder = 'https://drive.google.com/drive/folders/' + safeFolderId;
    console.log('ğŸ“ Folder URL constructed from folderId:', urls.folder);
  }

  // 4. ãƒ•ã‚©ãƒ¼ãƒ URLã®å–å¾— (configJsonã‹ã‚‰ã€å…¬é–‹ã‚·ãƒ¼ãƒˆã‚’å„ªå…ˆ)
  const publishedSheetName = config.publishedSheetName;
  if (publishedSheetName) {
    const sheetConfig = config['sheet_' + String(publishedSheetName || '')];
    if (sheetConfig) {
      urls.form = sheetConfig.formUrl || urls.form;
      urls.editForm = sheetConfig.editFormUrl || urls.editForm;
    }
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: è¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ URLå–å¾—
  if (!urls.form) {
    urls.form = config.formUrl || 
                status.userInfo.formUrl ||
                status.appUrls?.formUrl ||
                null;
  }
  
  if (!urls.editForm) {
    urls.editForm = config.editFormUrl || 
                    status.userInfo.editFormUrl ||
                    status.appUrls?.editFormUrl ||
                    (urls.form ? urls.form.replace('/viewform', '/edit') : null);
  }
  
  console.log('ğŸ“‹ Form URL determination:', {
    form: urls.form || 'none',
    editForm: urls.editForm || 'none',
    fromConfig: !!config.formUrl,
    fromUserInfo: !!status.userInfo.formUrl,
    fromAppUrls: !!status.appUrls?.formUrl
  });

  return urls;
}

/**
 * ã‚·ãƒ¼ãƒˆåã®æ­£è¦åŒ–å‡¦ç†
 */
function _normalizeSheetName(sheetName) {
  if (!sheetName) return '';
  
  return sheetName
    .trim()
    .replace(/\s+/g, ' ')  // è¤‡æ•°ã®ç©ºç™½ã‚’1ã¤ã«
    .replace(/[\u3000]/g, ' ')  // å…¨è§’ç©ºç™½ã‚’åŠè§’ã«
    .toLowerCase();
}

/**
 * å±¥æ­´å¾©å…ƒæ™‚å°‚ç”¨ã®è¨­å®šèª­ã¿è¾¼ã¿å‡¦ç†
 */
async function _loadConfigForHistoryRestore(sheetName) {
  try {
    console.log('ğŸ“ å±¥æ­´å¾©å…ƒç”¨è¨­å®šèª­ã¿è¾¼ã¿é–‹å§‹:', sheetName);
    
    // å±¥æ­´å¾©å…ƒãƒ•ãƒ©ã‚°ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã—ã¦è¨­å®šèª­ã¿è¾¼ã¿
    const originalRestoreFlag = window._historyRestoreInProgress;
    const originalColumnSelections = window._historyColumnSelections;
    
    window._historyRestoreInProgress = false;
    window._historyColumnSelections = null;
    
    // è¨­å®šèª­ã¿è¾¼ã¿å®Ÿè¡Œï¼ˆå¼·åˆ¶èª­ã¿è¾¼ã¿ãƒ•ãƒ©ã‚°ä»˜ãï¼‰
    const result = await loadConfigForSelected(sheetName, null, 0, 3, true);
    
    // ãƒ•ãƒ©ã‚°ã‚’å…ƒã«æˆ»ã™
    window._historyRestoreInProgress = originalRestoreFlag;
    window._historyColumnSelections = originalColumnSelections;
    
    console.log('âœ… å±¥æ­´å¾©å…ƒç”¨è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:', result);
    
    // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®åˆ—è¨­å®šã‚’å†é©ç”¨
    if (window._historyColumnSelections) {
      console.log('ğŸ”„ å±¥æ­´ã®åˆ—è¨­å®šã‚’å†é©ç”¨ä¸­...');
      _applyHistoryColumnSettings(window._historyColumnSelections);
    }
    
  } catch (error) {
    console.error('âŒ å±¥æ­´å¾©å…ƒç”¨è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
  }
}

/**
 * å±¥æ­´ã®åˆ—è¨­å®šã‚’DOMã«å†é©ç”¨
 */
function _applyHistoryColumnSettings(columnSelections) {
  try {
    // DOMè¦ç´ ã¸ã®å€¤è¨­å®š
    if (columnSelections.opinionHeader) {
      const opinionEl = document.getElementById('opinionHeader');
      if (opinionEl) {
        opinionEl.value = columnSelections.opinionHeader;
        console.log('âœ… Opinion header reapplied:', columnSelections.opinionHeader);
      }
    }
    
    if (columnSelections.nameColumn) {
      const nameEl = document.getElementById('name-column');
      if (nameEl) {
        nameEl.value = columnSelections.nameColumn;
        console.log('âœ… Name column reapplied:', columnSelections.nameColumn);
      }
    }
    
    if (columnSelections.classColumn) {
      const classEl = document.getElementById('class-column');
      if (classEl) {
        classEl.value = columnSelections.classColumn;
        console.log('âœ… Class column reapplied:', columnSelections.classColumn);
      }
    }
    
    if (columnSelections.reasonHeader) {
      const reasonEl = document.getElementById('reasonHeader');
      if (reasonEl) {
        reasonEl.value = columnSelections.reasonHeader;
        console.log('âœ… Reason header reapplied:', columnSelections.reasonHeader);
      }
    }
    
  } catch (error) {
    console.error('âŒ å±¥æ­´åˆ—è¨­å®šå†é©ç”¨ã‚¨ãƒ©ãƒ¼:', error);
  }
}

function updateSystemStatusDisplay(status) {
  if (!status) return;

  // ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹URLã‚’ä¸€æ‹¬å–å¾—
  const resourceUrls = getActiveResourceUrls(status);

  // Update publish status
  const publishIndicator = document.getElementById('info-publish-indicator');
  const publishText = document.getElementById('info-publish-text');

  if (status.isPublished) {
    publishIndicator.className = 'w-2 h-2 rounded-full bg-green-400';
    publishText.textContent = 'å…¬é–‹ä¸­';
  } else {
    publishIndicator.className = 'w-2 h-2 rounded-full bg-gray-400';
    publishText.textContent = 'éå…¬é–‹';
  }

  // Update other status fields
  document.getElementById('info-published-sheet').textContent = status.sheetName || '-';
  document.getElementById('info-display-mode').textContent = status.displayMode || '-';
  document.getElementById('info-show-counts').textContent = status.showCounts ? 'è¡¨ç¤º' : 'éè¡¨ç¤º';

  // Enable resource buttons if URLs are available
  const spreadsheetBtn = document.getElementById('open-spreadsheet-btn');
  if (spreadsheetBtn) {
    spreadsheetBtn.disabled = !resourceUrls.spreadsheet;
    if (resourceUrls.spreadsheet) {
      spreadsheetBtn.onclick = () => window.open(resourceUrls.spreadsheet, '_blank');
      spreadsheetBtn.title = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã';
    } else {
      spreadsheetBtn.title = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLãŒæœªè¨­å®šã§ã™';
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
  const formBtn = document.getElementById('open-form-btn');
  if (formBtn) {
    formBtn.disabled = false;
    formBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    if (resourceUrls.form) {
      formBtn.onclick = () => window.open(resourceUrls.form, '_blank');
      formBtn.title = 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';
    } else {
      formBtn.onclick = () => showMessage('ãƒ•ã‚©ãƒ¼ãƒ URLãŒæœªè¨­å®šã§ã™ã€‚ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'warning');
      formBtn.title = 'ãƒ•ã‚©ãƒ¼ãƒ URLãŒæœªè¨­å®šã§ã™ã€‚ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚';
    }
  }

  // Handle generic resource button in Step 1 (any resource)
  const resourceBtn = document.getElementById('add-resource-btn');
  if (resourceBtn) {
    const anyResourceUrl = resourceUrls.spreadsheet || resourceUrls.folder || resourceUrls.form || resourceUrls.editForm;
    resourceBtn.disabled = false;
    if (anyResourceUrl) {
      resourceBtn.onclick = () => window.open(anyResourceUrl, '_blank');
      resourceBtn.title = 'ãƒªã‚½ãƒ¼ã‚¹ã‚’é–‹ã';
    } else {
      resourceBtn.onclick = () => showMessage('ãƒªã‚½ãƒ¼ã‚¹URLãŒæœªè¨­å®šã§ã™', 'warning');
      resourceBtn.title = 'ãƒªã‚½ãƒ¼ã‚¹URLãŒæœªè¨­å®šã§ã™';
    }
  }

  // Handle new resource buttons
  console.log('resourceUrls:', resourceUrls); // Gemini Debug
  updateNewResourceButtons(resourceUrls);
}

// Navigate to specific step
// navigateToStep function is now defined in adminPanel-framework.js.html


// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰å–å¾—




// Validate configuration
function validateConfiguration() {
  if (!currentConfig || !currentConfig.columnMappings) return false;
  
  const mappings = currentConfig.columnMappings;
  const hasContent = Object.values(mappings).includes('content');
  const hasAuthor = Object.values(mappings).includes('author');
  
  return hasContent && hasAuthor;
}


// =============================================================================
// HISTORY MANAGEMENT FUNCTIONS
// =============================================================================

// å±¥æ­´ç®¡ç†ã®å®šæ•°
// HISTORY_STORAGE_KEY and MAX_HISTORY_ITEMS are defined in adminPanel-simple-history.js.html

/**
 * å›ç­”ãƒœãƒ¼ãƒ‰ã®å±¥æ­´ã‚’ä¿å­˜
 * @param {Object} historyItem - ä¿å­˜ã™ã‚‹å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ 
 */
function saveToHistory(historyItem) {
  try {
    if (!historyItem || !historyItem.questionText) {
      logWarn('Invalid history item, skipping save');
      return;
    }

    const history = getHistoryFromStorage();
    
    // AIåˆ—åˆ¤å®šçµæœã‚’å«ã‚€æ‹¡å¼µã•ã‚ŒãŸå±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
    const newItem = {
      id: generateHistoryId(),
      timestamp: new Date().toISOString(),
      publishedAt: historyItem.publishedAt || new Date().toISOString(),
      publishedEndAt: historyItem.publishedEndAt || null,
      // æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: çµ‚äº†é–¢é€£
      endTime: historyItem.endTime || null, // å®Ÿéš›ã®çµ‚äº†æ—¥æ™‚ï¼ˆçµ‚äº†æ™‚ã«è¨˜éŒ²ï¼‰
      scheduledEndTime: historyItem.scheduledEndTime || null, // äºˆå®šçµ‚äº†æ—¥æ™‚
      questionText: historyItem.questionText,
      sheetName: historyItem.sheetName || '',
      answerCount: historyItem.answerCount || 0,
      reactionCount: historyItem.reactionCount || 0,
      config: historyItem.config || {},
      formUrl: historyItem.formUrl || '',
      spreadsheetUrl: historyItem.spreadsheetUrl || '',
      setupType: historyItem.setupType || 'unknown', // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã‚’è­˜åˆ¥
      isActive: historyItem.isActive || false, // ç¾åœ¨å…¬é–‹ä¸­ã‹ã©ã†ã‹
      displayMode: historyItem.displayMode || 'named',
      countDisplay: historyItem.countDisplay || 'show',
      status: historyItem.status || 'published',
      
      // AIåˆ—åˆ¤å®šçµæœã®ä¿å­˜ï¼ˆå¾©å…ƒæ™‚ã«å¿…è¦ï¼‰
      sheetDetails: {
        allHeaders: (currentStatus && currentStatus.sheetDetails && currentStatus.sheetDetails.allHeaders) || [],
        guessedConfig: (currentStatus && currentStatus.sheetDetails && currentStatus.sheetDetails.guessedConfig) || {},
        existingConfig: (currentStatus && currentStatus.sheetDetails && currentStatus.sheetDetails.existingConfig) || {}
      },
      
      // å¾©å…ƒã«å¿…è¦ãªè¿½åŠ æƒ…å ±
      activeSheetName: (currentStatus && currentStatus.activeSheetName) || historyItem.sheetName,
      spreadsheetId: (currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetId) || '',
      
      // ä¿å­˜æ™‚ç‚¹ã§ã®è¨­å®šå®Œäº†çŠ¶æ…‹
      configurationComplete: !!(currentStatus && currentStatus.sheetDetails && currentStatus.sheetDetails.guessedConfig && currentStatus.sheetDetails.guessedConfig.opinionHeader),
      
      // Simple format for quick display
      format: (() => {
        const cfg = historyItem.config || (currentStatus && currentStatus.sheetDetails && currentStatus.sheetDetails.guessedConfig) || {};
        if (cfg.multipleChoice || cfg.allowMultipleAnswers || (cfg.formElements && cfg.formElements.some(e => e.type === 'checkbox'))) return 'multi';
        if (cfg.singleChoice || cfg.choices || cfg.options || (cfg.formElements && cfg.formElements.some(e => e.type === 'radio' || e.type === 'select'))) return 'select';
        return 'text';
      })()
    };
    
    history.unshift(newItem);
    
    // æœ€å¤§æ•°ã‚’è¶…ãˆãŸå ´åˆã¯éå»ã®ã‚‚ã®ã‚’å‰Šé™¤
    if (history.length > MAX_HISTORY_ITEMS) {
      history.splice(MAX_HISTORY_ITEMS);
    }
    
    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
    logDebug('Enhanced history saved:', newItem);
    
    // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã«åŒæœŸï¼ˆéåŒæœŸã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
    syncHistoryToServer(newItem).then(result => {
      if (result.status === 'error') {
        logWarn('Server sync failed after retries:', result.message);
        // ã‚µãƒ¼ãƒãƒ¼åŒæœŸå¤±æ•—ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if (typeof showMessage === 'function' && result.retryCount > 2) {
          showMessage('âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã¸ã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ãƒ­ãƒ¼ã‚«ãƒ«ã«ã¯ä¿å­˜ã•ã‚Œã¾ã—ãŸ', 'warning');
        }
      } else {
        logDebug('Server sync completed successfully');
      }
    }).catch(error => {
      logError('Unexpected error in server sync:', error);
    });
    
    // UI ã‚’æ›´æ–°
    if (window.AdminPanel?.historyManager?.loadSimpleHistoryTable) {
      window.AdminPanel.historyManager.loadSimpleHistoryTable();
    } else {
      console.warn('âš ï¸ History manager not available for UI update');
    }
    
  } catch (error) {
    logWarn('Failed to save history:', error);
  }
}

/**
 * å±¥æ­´ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã«åŒæœŸ
 * @param {Object} historyItem - åŒæœŸã™ã‚‹å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ 
 */
async function syncHistoryToServer(historyItem, retryCount = 0) {
  const MAX_RETRIES = 1; // 2â†’1ã«å‰Šæ¸›ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
  
  try {
    if (!historyItem || !historyItem.id) {
      logWarn('Invalid history item for server sync:', historyItem);
      return { status: 'error', message: 'Invalid history item' };
    }
    
    logDebug('Syncing history to server (attempt ' + (retryCount + 1) + '):', historyItem.questionText);
    
    // è»½é‡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ã‚µãƒ¼ãƒãƒ¼åŒæœŸã‚’å®Ÿè¡Œ  
    const timeoutPromise = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('Server sync timeout')), 15000); // 30sâ†’15sã«çŸ­ç¸®
    });
    
    // é€ä¿¡ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’è»½é‡åŒ–ï¼ˆã‚µãƒ¼ãƒå´ã§ã•ã‚‰ã«ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰
    const compact = {
      id: historyItem.id,
      questionText: (historyItem.questionText || '').slice(0, 140),
      sheetName: historyItem.sheetName || '',
      publishedAt: historyItem.publishedAt || new Date().toISOString(),
      endTime: historyItem.endTime || null,
      scheduledEndTime: historyItem.scheduledEndTime || null,
      isActive: !!historyItem.isActive,
      // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¯ãƒ†ã‚­ã‚¹ãƒˆã§ç°¡ç´ åŒ–
      displayMode: historyItem.displayMode || (historyItem.config && historyItem.config.displayMode) || 'named',
      status: historyItem.status || 'published',
      spreadsheetId: (currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetId) || '',
      answerCount: historyItem.answerCount || 0,
      reactionCount: historyItem.reactionCount || 0,
      setupType: historyItem.setupType || 'custom',
      // ç°¡æ˜“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆ/é¸æŠ/è¤‡æ•°ï¼‰
      format: (function deriveFormat() {
        const cfg = historyItem.config || (historyItem.sheetDetails && historyItem.sheetDetails.guessedConfig) || {};
        if (cfg.multipleChoice || cfg.allowMultipleAnswers || (cfg.formElements && cfg.formElements.some(e => e.type === 'checkbox'))) return 'multi';
        if (cfg.singleChoice || cfg.choices || cfg.options || (cfg.formElements && cfg.formElements.some(e => e.type === 'radio' || e.type === 'select'))) return 'select';
        return 'text';
      })()
    };
    const syncPromise = runGasWithUserId('saveHistoryToSheetAPI', false, compact);
    const response = await Promise.race([syncPromise, timeoutPromise]);
    
    if (response && response.status === 'success') {
      logDebug('History synced to server successfully');
      return { status: 'success', message: 'Server sync completed' };
    } else {
      const errorMsg = (response && response.message) || 'Unknown server error';
      logWarn('Server history sync failed:', errorMsg);
      
      // ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
      if (retryCount < MAX_RETRIES) {
        logDebug('Retrying server sync in 2 seconds...');
        await new Promise(resolve => setTimeout(resolve, 2000));
        return await syncHistoryToServer(historyItem, retryCount + 1);
      }
      
      return { status: 'error', message: errorMsg, retryCount: retryCount + 1 };
    }
  } catch (error) {
    const errorMsg = error.message || 'Server sync failed';
    logWarn('Failed to sync history to server:', errorMsg);
    
    // ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
    if (retryCount < MAX_RETRIES && !errorMsg.includes('timeout')) {
      logDebug('Retrying server sync due to error in 2 seconds...');
      await new Promise(resolve => setTimeout(resolve, 2000));
      return await syncHistoryToServer(historyItem, retryCount + 1);
    }
    
    return { status: 'error', message: errorMsg, retryCount: retryCount + 1 };
  }
}

/**
 * å±¥æ­´ã‚’ localStorage ã‹ã‚‰å–å¾—
 * @returns {Array} å±¥æ­´é…åˆ—
 */
function getHistoryFromStorage() {
  try {
    const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
    return historyJson ? JSON.parse(historyJson) : [];
  } catch (error) {
    logWarn('Failed to parse history from storage:', error);
    return [];
  }
}

/**
 * å±¥æ­´ã‚’ localStorage ã«ä¿å­˜
 * @param {Array} historyArray ä¿å­˜ã™ã‚‹å±¥æ­´é…åˆ—
 */
function saveHistoryToStorage(historyArray) {
  try {
    const safe = Array.isArray(historyArray) ? historyArray : [];
    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(safe));
  } catch (error) {
    logWarn('Failed to save history to storage:', error);
  }
}

/**
 * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å±¥æ­´ã‚’çµ±åˆ
 * @returns {Promise<Array>} çµ±åˆã•ã‚ŒãŸå±¥æ­´é…åˆ—
 */
async function getMergedHistory() {
  try {
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ï¼ˆæ¤œè¨¼ä»˜ãï¼‰
    let localHistory = [];
    try {
      localHistory = getHistoryFromStorage();
      if (!Array.isArray(localHistory)) {
        logWarn('Local history is not an array, resetting to empty');
        localHistory = [];
      }
    } catch (localError) {
      logWarn('Failed to load local history:', localError);
      localHistory = [];
    }
    
    // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰å–å¾—ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
    let serverHistory = [];
    try {
      logDebug('Loading server history...');
      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Server history timeout')), 8000); // 15sâ†’8sã«çŸ­ç¸®
      });
      
      const historyPromise = runGasWithUserId('getHistoryFromServerAPI', false);
      const response = await Promise.race([historyPromise, timeoutPromise]);
      
      if (response && response.status === 'success') {
        if (Array.isArray(response.historyArray)) {
          serverHistory = response.historyArray.filter(item => item && item.id); // è»½é‡æ¤œè¨¼
          if (serverHistory.length > 0) logDebug('Server history loaded:', serverHistory.length, 'items');
        } else {
          logWarn('Server response historyArray is not an array');
        }
      } else {
        logWarn('Server history response failed:', (response && response.message) || 'Unknown error');
      }
    } catch (serverError) {
      if (serverError.message.includes('timeout')) {
        logWarn('Server history request timed out, using local only');
      } else {
        logWarn('Failed to load server history:', serverError.message);
      }
    }
    
    // æ”¹å–„ã•ã‚ŒãŸçµ±åˆå‡¦ç†ï¼šformIdåŸºæº–ã§é‡è¤‡æ’é™¤ã—ã€è©³ç´°æƒ…å ±ã‚’ä¿æŒ
    const mergedMap = new Map(); // formId -> merged item
    const idMap = new Map(); // id -> merged item (for final deduplication)
    let totalItems = 0;
    
    // Helper function to merge two history items
    const mergeHistoryItems = (existing, newItem, source) => {
      if (!existing) return {...newItem, source};
      
      // Prefer server data for basic info, but preserve local sheetDetails
      const merged = {...newItem, source};
      
      // Preserve detailed local information if available
      if (existing.sheetDetails && (!merged.sheetDetails || Object.keys(existing.sheetDetails).length > Object.keys(merged.sheetDetails || {}).length)) {
        merged.sheetDetails = existing.sheetDetails;
        logDebug('Preserved local sheetDetails for formId:', newItem.formId);
      }
      
      // Preserve format information if available
      if (existing.format && !merged.format) {
        merged.format = existing.format;
      }
      
      return merged;
    };
    
    // First pass: collect all items by formId
    [...localHistory, ...serverHistory].forEach((item, index) => {
      if (!item || !item.id) return;
      
      const isLocal = index < localHistory.length;
      const source = isLocal ? 'local' : 'server';
      
      // Use formId for primary deduplication, fallback to id
      const key = item.formId || item.id;
      const existing = mergedMap.get(key);
      
      if (existing) {
        // Merge with existing item
        const merged = mergeHistoryItems(existing, item, source);
        mergedMap.set(key, merged);
        logDebug(`Merged duplicate formId: ${key} (${source})`);
      } else {
        // New item
        mergedMap.set(key, {...item, source});
      }
      totalItems++;
    });
    
    // Second pass: final deduplication by ID (in case formId wasn't unique enough)
    mergedMap.forEach((item) => {
      if (idMap.has(item.id)) {
        const existing = idMap.get(item.id);
        const merged = mergeHistoryItems(existing, item, item.source);
        idMap.set(item.id, merged);
        logDebug(`Final deduplication for ID: ${item.id}`);
      } else {
        idMap.set(item.id, item);
      }
    });
    
    // è»½é‡ã‚½ãƒ¼ãƒˆï¼ˆæœ€çµ‚çš„ã«idMapã‹ã‚‰ã‚½ãƒ¼ãƒˆï¼‰
    const mergedArray = Array.from(idMap.values()).sort((a, b) => {
      const aTime = new Date(a.timestamp || a.publishedAt || a.createdAt || 0).getTime();
      const bTime = new Date(b.timestamp || b.publishedAt || b.createdAt || 0).getTime();
      return bTime - aTime; // é™é †
    });
    
    if (mergedArray.length > 0) {
      logDebug(`History merged: ${mergedArray.length} items (${localHistory.length} local, ${serverHistory.length} server)`);
    }
    
    return mergedArray;
  } catch (error) {
    logError('Critical error in getMergedHistory:', error);
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼ˆã•ã‚‰ã«å®‰å…¨ã«ï¼‰
    try {
      const fallbackHistory = getHistoryFromStorage();
      logDebug('Using fallback local history:', fallbackHistory.length, 'items');
      return Array.isArray(fallbackHistory) ? fallbackHistory : [];
    } catch (fallbackError) {
      logError('Even fallback failed:', fallbackError);
      return [];
    }
  }
}

/**
 * å±¥æ­´ç”¨ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ç”Ÿæˆ
 * @returns {string} ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
 */
function generateHistoryId() {
  return `history_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

/**
 * Draft session storage management functions
 */

// Draft session storage key
const DRAFT_SESSION_KEY = 'answerboard_draft_state'; // cspell:disable-line

/**
 * Save draft state to session storage
 * @param {Object} draftData - Draft form data
 */
function saveDraftToSession(draftData) {
  try {
    if (!draftData || !draftData.questionText) {
      logWarn('Invalid draft data, skipping session save');
      return;
    }

    // Create unique form identifier
    const formId = `${(currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetId) || 'unknown'}_${draftData.sheetName || selectedSheet || 'unknown'}`;
    
    const draftState = {
      formId,
      createdAt: new Date().toISOString(),
      questionText: draftData.questionText,
      sheetName: draftData.sheetName || selectedSheet,
      config: draftData.config || {},
      displayMode: draftData.displayMode || 'named', // named or anonymous
      countDisplay: draftData.countDisplay || 'show', // show or hide
      
      // AI column prediction results for recovery
      sheetDetails: {
        allHeaders: (currentStatus && currentStatus.sheetDetails && currentStatus.sheetDetails.allHeaders) || [],
        guessedConfig: (currentStatus && currentStatus.sheetDetails && currentStatus.sheetDetails.guessedConfig) || {},
        existingConfig: (currentStatus && currentStatus.sheetDetails && currentStatus.sheetDetails.existingConfig) || {}
      },
      
      // Form configuration state
      spreadsheetId: (currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetId) || '',
      configurationComplete: !!(currentStatus && currentStatus.sheetDetails && currentStatus.sheetDetails.guessedConfig && currentStatus.sheetDetails.guessedConfig.opinionHeader),
      
      // Timestamp for draft management
      lastUpdated: new Date().toISOString()
    };
    
    sessionStorage.setItem(DRAFT_SESSION_KEY, JSON.stringify(draftState));
    logDebug('Draft saved to session storage:', draftState.questionText);
    
  } catch (error) {
    logWarn('Failed to save draft to session:', error);
  }
}

/**
 * Get draft state from session storage
 * @returns {Object|null} Draft state or null if not found
 */
function getDraftFromSession() {
  try {
    const draftJson = sessionStorage.getItem(DRAFT_SESSION_KEY);
    if (!draftJson) return null;
    
    const draftState = JSON.parse(draftJson);
    logDebug('Draft loaded from session storage:', draftState.questionText);
    return draftState;
    
  } catch (error) {
    logWarn('Failed to load draft from session:', error);
    return null;
  }
}

/**
 * Clear draft from session storage
 */
function clearDraftFromSession() {
  try {
    sessionStorage.removeItem(DRAFT_SESSION_KEY);
    logDebug('Draft cleared from session storage');
  } catch (error) {
    logWarn('Failed to clear draft from session:', error);
  }
}

/**
 * Check if draft exists in session storage
 * @returns {boolean} True if draft exists
 */
function hasDraftInSession() {
  try {
    return !!sessionStorage.getItem(DRAFT_SESSION_KEY);
  } catch (error) {
    logWarn('Failed to check draft in session:', error);
    return false;
  }
}

/**
 * Recover draft state from session storage on page load
 * @returns {Promise<boolean>} True if draft was recovered successfully
 */
async function recoverDraftFromSession() {
  try {
    const draftState = getDraftFromSession();
    if (!draftState) {
      logDebug('No draft found in session storage');
      return false;
    }
    
    logDebug('Attempting to recover draft from session:', draftState.questionText);
    
    // Show recovery notification
    showMessage('ä¸‹æ›¸ãã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 'info');
    
    // Restore basic form state
    if (draftState.sheetName) {
      selectedSheet = draftState.sheetName;
      const sheetSelect = document.getElementById('sheet-select');
      if (sheetSelect) {
        sheetSelect.value = draftState.sheetName;
      }
    }
    
    // Restore spreadsheet ID if available
    if (draftState.spreadsheetId && currentStatus && currentStatus.userInfo) {
      currentStatus.userInfo.spreadsheetId = draftState.spreadsheetId;
    }
    
    // Restore sheet details and AI prediction results
    if (draftState.sheetDetails && currentStatus) {
      if (!currentStatus.sheetDetails) {
        currentStatus.sheetDetails = {};
      }
      
      currentStatus.sheetDetails.allHeaders = draftState.sheetDetails.allHeaders || [];
      currentStatus.sheetDetails.guessedConfig = draftState.sheetDetails.guessedConfig || {};
      currentStatus.sheetDetails.existingConfig = draftState.sheetDetails.existingConfig || {};
    }
    
    // Restore question text
    const questionInput = document.getElementById('question-input');
    if (questionInput && draftState.questionText) {
      questionInput.value = draftState.questionText;
    }
    
    // Restore display mode settings
    const anonymousCheckbox = document.getElementById('anonymous-mode');
    if (anonymousCheckbox) {
      anonymousCheckbox.checked = draftState.displayMode === 'anonymous';
    }
    
    // Update UI to reflect recovered state
    if (draftState.configurationComplete) {
      // Show that AI column prediction is completed
      const currentStep = document.querySelector('[data-step="4"]');
      if (currentStep) {
        updateStepProgress(4, currentStatus);
      }
    }
    
    // Update any config panels if they exist
    if (draftState.config && Object.keys(draftState.config).length > 0) {
      updateConfigPanelUI(draftState.config);
    }
    
    // Show success message
    const ageMinutes = Math.floor((new Date() - new Date(draftState.createdAt)) / (1000 * 60));
    const ageText = ageMinutes < 1 ? 'ç›´å‰' : `${ageMinutes}åˆ†å‰`;
    showMessage(`ä¸‹æ›¸ãã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${ageText}ã«ä½œæˆï¼‰`, 'success');
    
    logDebug('Draft recovered successfully from session storage');
    return true;
    
  } catch (error) {
    logError('Failed to recover draft from session:', error);
    showMessage('ä¸‹æ›¸ãã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    return false;
  }
}

/**
 * Update config panel UI with recovered settings
 * @param {Object} config - Configuration object
 */
function updateConfigPanelUI(config) {
  try {
    // Update opinion header if available
    if (config.opinionHeader) {
      const opinionSelect = document.getElementById('opinion-header-select');
      if (opinionSelect) {
        opinionSelect.value = config.opinionHeader;
      }
    }
    
    // Update name header if available
    if (config.nameHeader) {
      const nameSelect = document.getElementById('name-header-select');
      if (nameSelect) {
        nameSelect.value = config.nameHeader;
      }
    }
    
    // Update reaction settings if available
    if (config.allowReactions !== undefined) {
      const reactionCheckbox = document.getElementById('allow-reactions');
      if (reactionCheckbox) {
        reactionCheckbox.checked = !!config.allowReactions;
      }
    }
    
    logDebug('Config panel UI updated with recovered settings');
    
  } catch (error) {
    logWarn('Failed to update config panel UI:', error);
  }
}

// æ—§æ¥ã®ã‚«ãƒ¼ãƒ‰å½¢å¼ã®å±¥æ­´è¡¨ç¤ºã¯å‰Šé™¤ - ç°¡å˜ãªãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã®ã¿ä½¿ç”¨

/**
 * ç°¡å˜ãªå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤ºï¼ˆæ–°å®Ÿè£…ï¼‰
 */


/**
 * Enhanced history restoration preview modal
 * @param {Object} item - History item to preview
 */
function showHistoryRestorationPreview(item) {
  try {
    console.log('ğŸ” Showing history restoration preview:', item);
    
    // Extract preview information
    const question = item.questionText || item.sheetName || 'ã“ã®å±¥æ­´';
    const truncated = question.length > 50 ? (question.substring(0, 50) + '...') : question;
    const published = item.publishedAt ? new Date(item.publishedAt).toLocaleString('ja-JP') : 'æœªè¨­å®š';
    const status = item.isActive ? 'å…¬é–‹ä¸­' : 'çµ‚äº†';
    const statusIcon = item.isActive ? 'ğŸŒ' : 'â¹ï¸';
    
    // Get configuration preview
    const configPreview = getConfigurationPreview(item);
    const headerPreview = getHeaderPreview(item);
    
    // Build detailed message
    const detailsHtml = `
      <div class="space-y-4">
        <div class="bg-gray-800/50 rounded-lg p-3">
          <h4 class="text-sm font-semibold text-cyan-400 mb-2">ğŸ“‹ å¾©å…ƒã•ã‚Œã‚‹è¨­å®šå†…å®¹</h4>
          <div class="text-xs text-gray-300 space-y-1">
            <div><span class="text-gray-400">è³ªå•:</span> ${truncated}</div>
            <div><span class="text-gray-400">å…¬é–‹æ—¥æ™‚:</span> ${published}</div>
            <div><span class="text-gray-400">çŠ¶æ…‹:</span> ${statusIcon} ${status}</div>
          </div>
        </div>
        
        ${configPreview ? `
        <div class="bg-blue-900/20 rounded-lg p-3">
          <h4 class="text-sm font-semibold text-blue-400 mb-2">âš™ï¸ åˆ—è¨­å®š</h4>
          <div class="text-xs text-gray-300">${configPreview}</div>
        </div>
        ` : ''}
        
        ${headerPreview ? `
        <div class="bg-green-900/20 rounded-lg p-3">
          <h4 class="text-sm font-semibold text-green-400 mb-2">ğŸ“Š åˆ©ç”¨å¯èƒ½ãƒ˜ãƒƒãƒ€ãƒ¼</h4>
          <div class="text-xs text-gray-300">${headerPreview}</div>
        </div>
        ` : ''}
        
        <div class="bg-yellow-900/20 border border-yellow-600/30 rounded-lg p-3">
          <p class="text-xs text-yellow-200">
            âš ï¸ ã“ã®æ“ä½œã«ã‚ˆã‚Šã€ç¾åœ¨ã®æœªä¿å­˜ã®è¨­å®šã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
          </p>
        </div>
      </div>
    `;
    
    // Show enhanced confirmation modal
    if (typeof window.showConfirmationModal === 'function') {
      // Create a custom modal for detailed preview
      showDetailedHistoryModal(truncated, detailsHtml, () => {
        console.log('âœ… User confirmed history restoration');
        selectHistoryItem(item.id);
      });
    } else {
      // Fallback to basic confirmation
      const basicMessage = `ã€Œ${truncated}ã€ã®è¨­å®šã‚’å¾©å…ƒã—ã¾ã™ã€‚\n\nå…¬é–‹æ—¥æ™‚: ${published}\nçŠ¶æ…‹: ${status}\n\nç¾åœ¨ã®æœªä¿å­˜ã®è¨­å®šã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`;
      if (confirm(basicMessage)) {
        selectHistoryItem(item.id);
      }
    }
    
  } catch (error) {
    console.error('âŒ History preview failed:', error);
    // Fallback to direct restoration
    selectHistoryItem(item.id);
  }
}

/**
 * Get configuration preview text
 * @param {Object} item - History item
 * @returns {string} Configuration preview HTML
 */
function getConfigurationPreview(item) {
  try {
    const config = item.configSnapshot || item.config || {};
    const settings = [];
    
    if (config.opinionHeader) settings.push(`æ„è¦‹æ¬„: ${config.opinionHeader}`);
    if (config.nameHeader) settings.push(`åå‰æ¬„: ${config.nameHeader}`);
    if (config.classHeader) settings.push(`ã‚¯ãƒ©ã‚¹æ¬„: ${config.classHeader}`);
    if (config.reasonHeader) settings.push(`ç†ç”±æ¬„: ${config.reasonHeader}`);
    
    // Display settings
    if (config.showNames !== undefined) settings.push(`åå‰è¡¨ç¤º: ${config.showNames ? 'ON' : 'OFF'}`);
    if (config.showCounts !== undefined) settings.push(`ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º: ${config.showCounts ? 'ON' : 'OFF'}`);
    
    return settings.length > 0 ? settings.join('<br>') : 'è¨­å®šæƒ…å ±ãªã—';
  } catch (error) {
    console.warn('Config preview failed:', error);
    return 'è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼';
  }
}

/**
 * Get header preview text
 * @param {Object} item - History item
 * @returns {string} Header preview HTML
 */
function getHeaderPreview(item) {
  try {
    const headers = item.headerSnapshot?.allHeaders || item.sheetDetails?.allHeaders || [];
    if (headers.length === 0) return null;
    
    const displayHeaders = headers.slice(0, 5).join(', ');
    const remaining = headers.length > 5 ? ` (+${headers.length - 5}å€‹)` : '';
    
    return `${displayHeaders}${remaining}`;
  } catch (error) {
    console.warn('Header preview failed:', error);
    return null;
  }
}

/**
 * Show detailed history restoration modal
 * @param {string} title - Modal title
 * @param {string} contentHtml - HTML content
 * @param {Function} onConfirm - Confirmation callback
 */
function showDetailedHistoryModal(title, contentHtml, onConfirm) {
  // Use existing confirmation modal but with enhanced content
  const modal = document.getElementById('confirmation-modal');
  const titleElement = document.getElementById('modal-title');
  const messageElement = document.getElementById('modal-message');
  const confirmBtn = document.getElementById('modal-confirm-btn');
  const cancelBtn = document.getElementById('modal-cancel-btn');
  
  if (modal && titleElement && messageElement && confirmBtn && cancelBtn) {
    titleElement.textContent = 'å±¥æ­´è¨­å®šã®å¾©å…ƒ';
    messageElement.innerHTML = contentHtml;
    confirmBtn.textContent = 'å¾©å…ƒã™ã‚‹';
    
    // Set up event handlers
    const handleConfirm = () => {
      modal.classList.add('hidden');
      onConfirm();
      cleanup();
    };
    
    const handleCancel = () => {
      modal.classList.add('hidden');
      cleanup();
    };
    
    const cleanup = () => {
      confirmBtn.removeEventListener('click', handleConfirm);
      cancelBtn.removeEventListener('click', handleCancel);
    };
    
    confirmBtn.addEventListener('click', handleConfirm);
    cancelBtn.addEventListener('click', handleCancel);
    
    // Show modal
    modal.classList.remove('hidden');
  } else {
    console.warn('âš ï¸ Modal elements not found, using fallback');
    if (confirm(`å±¥æ­´è¨­å®šã€Œ${title}ã€ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ`)) {
      onConfirm();
    }
  }
}

/**
 * ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ æ­£è¦åŒ– - æ–°ã—ã„ç°¡ç´ ãªå½¢å¼ã«çµ±ä¸€
 * @param {Object} rawItem - ç”Ÿã®å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ 
 * @returns {Object} æ­£è¦åŒ–ã•ã‚ŒãŸå±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ 
 */
function normalizeHistoryItem(rawItem) {
  try {
    console.log('ğŸ”„ Normalizing history item to simple format:', rawItem);
    
    // ã‚·ãƒ³ãƒ—ãƒ«ãªæ–°å½¢å¼æ§‹é€ ã«å¤‰æ›
    const normalizedItem = {
      id: rawItem.id,
      createdDate: rawItem.createdDate || null, // å¾Œã§è¿½åŠ äºˆå®š
      publishedAt: rawItem.publishedAt || rawItem.timestamp,
      questionText: rawItem.questionText || 
                   rawItem.config?.opinionHeader ||
                   rawItem.configSnapshot?.opinionHeader ||
                   'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè³ªå•',
      setupType: rawItem.setupType || 'unknown',
      
      // æœ€å°é™ã®å¾©å…ƒãƒ‡ãƒ¼ã‚¿
      opinionHeader: rawItem.config?.opinionHeader || 
                    rawItem.configSnapshot?.opinionHeader || 
                    rawItem.questionText || '',
      nameHeader: rawItem.config?.nameHeader || 
                 rawItem.configSnapshot?.nameHeader || 
                 'åå‰',
      displayMode: normalizeDisplayMode(rawItem.displayMode || 
                                      rawItem.config?.displayMode ||
                                      rawItem.configSnapshot?.displayMode),
      
      // å¾©å…ƒç”¨ãƒ‡ãƒ¼ã‚¿
      sheetName: rawItem.sheetName || '',
      spreadsheetId: rawItem.spreadsheetId || ''
    };
    
    console.log('âœ… Item normalized to simple format:', normalizedItem);
    return normalizedItem;
    
  } catch (error) {
    console.error('âŒ Simple history normalization failed:', error);
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€å°é™ã®æ§‹é€ ã‚’è¿”ã™
    return {
      id: rawItem.id || generateHistoryId(),
      createdDate: null,
      publishedAt: rawItem.publishedAt || rawItem.timestamp || new Date().toISOString(),
      questionText: rawItem.questionText || 'ä¸æ˜',
      setupType: rawItem.setupType || 'unknown',
      opinionHeader: '',
      nameHeader: 'åå‰',
      displayMode: 'named',
      sheetName: rawItem.sheetName || '',
      spreadsheetId: rawItem.spreadsheetId || ''
    };
  }
}

/**
 * ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * @param {Object} item - æ­£è¦åŒ–æ¸ˆã¿å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ 
 * @returns {boolean} æœ‰åŠ¹ã‹ã©ã†ã‹
 */
function validateSimpleHistoryItem(item) {
  return item && item.id && item.publishedAt;
}

/**
 * ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´é¸æŠå‡¦ç†
 * @param {string} historyId - å±¥æ­´ID
 */
async function selectHistoryItem(historyId) {
  try {
    // å±¥æ­´ã‚’æ¤œç´¢
    const mergedHistory = await getMergedHistory();
    const rawItem = mergedHistory.find(h => h.id === historyId);
    
    if (!rawItem) {
      showMessage('å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
      return;
    }
    
    // ã‚·ãƒ³ãƒ—ãƒ«æ­£è¦åŒ–
    const item = normalizeHistoryItem(rawItem);
    console.log('ğŸ“ Simple normalized history item:', item);
    
    // åŸºæœ¬ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!validateSimpleHistoryItem(item)) {
      showMessage('å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™', 'error');
      return;
    }
    
    // ã‚·ãƒ³ãƒ—ãƒ«ãªå¾©å…ƒç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    showHistoryRestorationPreview(
      'å±¥æ­´å¾©å…ƒã®ç¢ºèª',
      item,
      // ç¢ºèªå¾Œã®å¾©å…ƒå®Ÿè¡Œ
      async () => {
        console.log('âœ… User confirmed simple history restoration');
        if (window.AdminPanel?.historyManager?.restoreFromSimpleHistory) {
          await window.AdminPanel.historyManager.restoreFromSimpleHistory(item);
        } else {
          console.error('âŒ History manager not available for restoration');
          showMessage('å±¥æ­´å¾©å…ƒæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
        }
      },
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®å‡¦ç†
      () => {
        console.log('âŒ History restoration cancelled');
      }
    );
    
  } catch (error) {
    console.error('âŒ Simple history selection failed:', error);
    showMessage('å±¥æ­´é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

/**
 * ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ã‹ã‚‰ã®å¾©å…ƒå®Ÿè¡Œ
 * @param {Object} item - æ­£è¦åŒ–æ¸ˆã¿å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ 
 */

/**
 * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
 * @param {string} text - ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
 * @returns {string} ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// æ—§æ¥ã®è¤‡é›‘ãªå±¥æ­´ç®¡ç†é–¢æ•°ç¾¤ã¯å‰Šé™¤ - selectHistoryItem()ã«ã‚ˆã‚‹è‡ªå‹•ãƒ•ãƒ­ãƒ¼ã®ã¿ä½¿ç”¨

// =============================================================================
// CONFIG JSON æ­£è¦åŒ–ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ 
// =============================================================================

/**
 * configJsonã®æ•´åˆæ€§ã‚’ç¢ºä¿ã—ã€çŸ›ç›¾ã—ãŸçŠ¶æ…‹ã‚’ä¿®å¾©ã™ã‚‹
 * @param {Object} config - ä¿®å¾©å¯¾è±¡ã®config
 * @param {Object} userInfo - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
 * @return {Object} æ­£è¦åŒ–ã•ã‚ŒãŸconfig
 */
function normalizeConfigJson(config, userInfo) {
  if (!config || typeof config !== 'object') {
    console.warn('âš ï¸ normalizeConfigJson: ç„¡åŠ¹ãªconfigã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ');
    return config;
  }
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜ãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡å‡¦ç†ã‚’é˜²æ­¢ï¼‰
  if (window.processCache && window.generateSimpleHash && window.isCacheValid) {
    const configHash = window.generateSimpleHash(config);
    const cacheEntry = window.processCache.configNormalization;
    
    if (window.isCacheValid(cacheEntry) && cacheEntry.dataHash === configHash) {
      console.log('ğŸš€ configJsonæ­£è¦åŒ–: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰çµæœã‚’å–å¾—');
      return cacheEntry.data;
    }
  }
  
  // æœ¬ç•ªç’°å¢ƒã§ã¯è©³ç´°ãƒ­ã‚°ã‚’å‰Šæ¸›
  if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
    console.log('ğŸ”§ configJsonæ­£è¦åŒ–é–‹å§‹:', {
      setupStatus: config.setupStatus,
      setupStep: config.setupStep,
      appPublished: config.appPublished,
      publishedSheetName: config.publishedSheetName
    });
  }
  
  // Step 1: publishedSheetNameä¿®å¾©
  config = fixPublishedSheetName(config);
  
  // Step 2: setupStepå†è¨ˆç®—ï¼ˆçµ±ä¸€é–¢æ•°ä½¿ç”¨ï¼‰
  // Note: setupStepã¯è¨ˆç®—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ã—ã¦å¸¸ã«å‹•çš„ã«ç®—å‡ºã•ã‚Œã€configJsonã«ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“
  
  // Step 3: ã‚°ãƒ­ãƒ¼ãƒãƒ«åˆ—è¨­å®šåŒæœŸ
  config = syncGlobalColumnSettings(config);
  
  // Step 4: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è£œå®Œ
  config = ensureRequiredFields(config);
  
  // Step 5: å†—é•·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‰Šé™¤
  config = removeRedundantFields(config);
  
  // æœ¬ç•ªç’°å¢ƒã§ã¯è©³ç´°ãƒ­ã‚°ã‚’å‰Šæ¸›
  if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
    console.log('âœ… configJsonæ­£è¦åŒ–å®Œäº†:', {
      setupStatus: config.setupStatus,
      appPublished: config.appPublished,
      publishedSheetName: config.publishedSheetName
    });
  }
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
  if (window.processCache && window.generateSimpleHash) {
    const configHash = window.generateSimpleHash(config);
    const cacheEntry = window.processCache.configNormalization;
    cacheEntry.data = config;
    cacheEntry.dataHash = configHash;
    cacheEntry.timestamp = Date.now();
  }
  
  return config;
}

/**
 * å†—é•·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‰Šé™¤ï¼ˆãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§å‘ä¸Šï¼‰
 * @param {Object} config - å¯¾è±¡config
 * @return {Object} ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚ŒãŸconfig
 */
function removeRedundantFields(config) {
  const cleanConfig = Object.assign({}, config);
  
  // setupStepã¯è¨ˆç®—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ãŸã‚ã€ä¿å­˜æ¸ˆã¿ã®å€¤ã‚’å‰Šé™¤
  delete cleanConfig.setupStep;
  
  console.log('ğŸ§¹ å†—é•·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤: setupStep');
  
  return cleanConfig;
}

/**
 * ConfigJsonã®æ•´åˆæ€§æ¤œè¨¼æ©Ÿèƒ½ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å°‚ç”¨ï¼‰
 * @param {Object} config - æ¤œè¨¼å¯¾è±¡ã®config
 * @param {Object} userInfo - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
 */
function validateConfigJsonIntegrity(config, userInfo) {
  if (!config || !userInfo) {
    console.warn('âš ï¸ æ•´åˆæ€§æ¤œè¨¼: ç„¡åŠ¹ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿');
    return;
  }
  
  const setupStatus = config.setupStatus || 'pending';
  const formCreated = !!config.formCreated;
  const appPublished = !!config.appPublished;
  const hasFormUrl = !!(config.formUrl && config.formUrl.trim());
  const hasPublishedSheet = !!(config.publishedSheetName && config.publishedSheetName.trim());
  const hasSpreadsheet = !!(userInfo.spreadsheetId && userInfo.spreadsheetId.trim());
  
  console.group('ğŸ” ConfigJsonæ•´åˆæ€§æ¤œè¨¼');
  
  // åŸºæœ¬çŠ¶æ…‹ã®è¡¨ç¤º
  console.log('ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹:', {
    setupStatus,
    formCreated,
    appPublished,
    hasFormUrl,
    hasPublishedSheet,
    hasSpreadsheet
  });
  
  // é‡è¦ãªä¸æ•´åˆã‚’æ¤œå‡º
  const issues = [];
  
  if (setupStatus === 'completed' && !formCreated) {
    issues.push('âŒ setupStatus=completedãªã®ã«formCreated=false');
  }
  
  if (formCreated && !hasFormUrl) {
    issues.push('âŒ formCreated=trueãªã®ã«formUrlãŒæœªè¨­å®š');
  }
  
  if (appPublished && !hasPublishedSheet) {
    issues.push('âŒ appPublished=trueãªã®ã«publishedSheetNameãŒæœªè¨­å®š');
  }
  
  if (!hasSpreadsheet && (setupStatus === 'completed' || formCreated || appPublished)) {
    issues.push('âŒ ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æœªè¨­å®šãªã®ã«é«˜åº¦ãªè¨­å®šãŒæœ‰åŠ¹');
  }
  
  // setupStepãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã®è­¦å‘Š
  if (config.setupStep !== undefined) {
    issues.push('âš ï¸ setupStepãŒconfigJsonã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ï¼ˆå†—é•·ï¼‰');
  }
  
  // çµæœè¡¨ç¤º
  if (issues.length === 0) {
    console.log('âœ… æ•´åˆæ€§æ¤œè¨¼å®Œäº†: å•é¡Œãªã—');
  } else {
    console.warn('âš ï¸ æ•´åˆæ€§å•é¡Œæ¤œå‡º:', issues);
  }
  
  console.groupEnd();
}

/**
 * publishedSheetNameä¿®å¾©é–¢æ•°
 * @param {Object} config - ä¿®å¾©å¯¾è±¡ã®config
 * @return {Object} ä¿®å¾©ã•ã‚ŒãŸconfig
 */
function fixPublishedSheetName(config) {
  // publishedSheetNameãŒ'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1'ã®ã‚ˆã†ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåã®å ´åˆã‚‚ä¿®å¾©å¯¾è±¡
  const isDefaultSheetName = config.publishedSheetName === 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1' || 
                            config.publishedSheetName && config.publishedSheetName.startsWith('ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”');
                            
  if ((!config.publishedSheetName || 
       config.publishedSheetName.trim() === '' || 
       isDefaultSheetName) && 
      config.publishedSpreadsheetId) {
    
    // AIåˆ—åˆ¤å®šçµæœã‹ã‚‰è³ªå•æ–‡ã‚’å–å¾—ã‚’è©¦è¡Œ
    if (currentStatus && currentStatus.sheetDetails && currentStatus.sheetDetails.guessedConfig && currentStatus.sheetDetails.guessedConfig.opinionHeader) {
      const questionText = currentStatus.sheetDetails.guessedConfig.opinionHeader;
      config.publishedSheetName = questionText;
      
      if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
        console.log('ğŸ”§ publishedSheetNameä¿®å¾© (AIåˆ—åˆ¤å®šçµæœä½¿ç”¨):', {
          å…ƒã®åå‰: config.publishedSheetName,
          æ–°ã—ã„åå‰: questionText
        });
      }
      return config;
    }
    
    // AIåˆ—åˆ¤å®šçµæœãŒç„¡ã„å ´åˆã¯å¾“æ¥ã®sheet_ã‚­ãƒ¼æ¤œç´¢
    const sheetKeys = Object.keys(config).filter(key => key.startsWith('sheet_'));
    
    if (sheetKeys.length > 0) {
      // æœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚·ãƒ¼ãƒˆåã‚’ä½¿ç”¨
      const detectedSheetName = sheetKeys[0].replace('sheet_', '');
      config.publishedSheetName = detectedSheetName;
      
      if (typeof DEBUG_MODE !== 'undefined' && DEBUG_MODE) {
        console.log('ğŸ”§ publishedSheetNameä¿®å¾© (ã‚·ãƒ¼ãƒˆã‚­ãƒ¼ä½¿ç”¨):', {
          æ¤œå‡ºã•ã‚ŒãŸã‚·ãƒ¼ãƒˆå: detectedSheetName,
          åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒˆè¨­å®š: sheetKeys
        });
      }
    }
  }
  
  return config;
}





/**
 * ã‚°ãƒ­ãƒ¼ãƒãƒ«åˆ—è¨­å®šã‚’æœ€æ–°ã®ã‚·ãƒ¼ãƒˆè¨­å®šã¨åŒæœŸ
 * @param {Object} config - åŒæœŸå¯¾è±¡ã®config
 * @return {Object} åŒæœŸã•ã‚ŒãŸconfig
 */
function syncGlobalColumnSettings(config) {
  if (!config.publishedSheetName) {
    return config; // ã‚·ãƒ¼ãƒˆåãŒä¸æ˜ãªå ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  }
  
  const sheetConfigKey = 'sheet_' + String(config.publishedSheetName || '');
  const sheetConfig = config[sheetConfigKey];
  
  if (sheetConfig && typeof sheetConfig === 'object') {
    // ã‚·ãƒ¼ãƒˆå›ºæœ‰è¨­å®šã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã«åŒæœŸ
    config.opinionHeader = sheetConfig.opinionHeader || config.opinionHeader || '';
    config.nameHeader = sheetConfig.nameHeader || config.nameHeader || '';
    config.reasonHeader = sheetConfig.reasonHeader || config.reasonHeader || '';
    config.classHeader = sheetConfig.classHeader || config.classHeader || '';
    config.timestampHeader = sheetConfig.timestampHeader || config.timestampHeader || '';
    
    // ãƒ•ã‚©ãƒ¼ãƒ URLåŒæœŸ - ã‚·ãƒ¼ãƒˆå›ºæœ‰ã®formUrlã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã«åŒæœŸ
    if (sheetConfig.formUrl) {
      config.formUrl = sheetConfig.formUrl;
      console.log('ğŸ”— ãƒ•ã‚©ãƒ¼ãƒ URLåŒæœŸ:', {
        sheetName: config.publishedSheetName,
        formUrl: config.formUrl
      });
    }
    
    console.log('ğŸ”§ ã‚°ãƒ­ãƒ¼ãƒãƒ«åˆ—è¨­å®šåŒæœŸå®Œäº†:', {
      sheetName: config.publishedSheetName,
      mainQuestion: config.opinionHeader,
      nameColumn: config.nameHeader
    });
  }
  
  return config;
}

/**
 * å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è£œå®Œ
 * @param {Object} config - è£œå®Œå¯¾è±¡ã®config
 * @return {Object} è£œå®Œã•ã‚ŒãŸconfig
 */
function ensureRequiredFields(config) {
  console.log('ğŸ”§ ensureRequiredFields called with:', typeof config);
  
  // Ensure config is a valid object
  if (!config || typeof config !== 'object') {
    config = {};
  }
  
  // å€‹åˆ¥è¨­å®šï¼ˆæœ€ã‚‚å®‰å…¨ãªæ–¹æ³•ï¼‰
  if (config.showNames === undefined) config.showNames = false;
  if (config.showCounts === undefined) config.showCounts = false;
  if (config.highlightMode === undefined) config.highlightMode = false;
  if (config.displayMode === undefined) config.displayMode = 'named';
  if (config.countDisplay === undefined) config.countDisplay = 'show';
  if (config.autoStopEnabled === undefined) config.autoStopEnabled = true;
  if (config.autoStopMinutes === undefined) config.autoStopMinutes = 360;
  
  console.log('âœ… ensureRequiredFields completed');
  return config;
}


/**
 * å…¬é–‹æ¸ˆã¿çŠ¶æ…‹ç”¨configJsonä¿®å¾©é–¢æ•°
 * @param {Object} config - ä¿®å¾©å¯¾è±¡ã®config
 * @return {Object} ä¿®å¾©ã•ã‚ŒãŸconfig
 */
function fixConfigForPublishedState(config) {
  const fixedConfig = Object.assign({}, config);
  
  // å…¬é–‹æ¸ˆã¿çŠ¶æ…‹ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿®å¾©
  if (fixedConfig.setupStatus !== 'completed') {
    console.log('ğŸ”§ setupStatus fixed from pending to completed');
    fixedConfig.setupStatus = 'completed';
  }
  
  if (!fixedConfig.formCreated) {
    console.log('ğŸ”§ formCreated status fixed from false to true');
    fixedConfig.formCreated = true;
  }
  
  if (!fixedConfig.appPublished) {
    console.log('ğŸ”§ appPublished status fixed from false to true');
    fixedConfig.appPublished = true;
  }
  
  // Form URL temporary setting (if actual form URL is unknown)
  if (!fixedConfig.formUrl || fixedConfig.formUrl.trim() === '') {
    console.log('ğŸ”§ formUrl temporary setting for published state maintenance');
    fixedConfig.formUrl = 'https://docs.google.com/temp-form-url'; // Temporary license URL
  }
  
  return fixedConfig;
}


// ç°¡å˜ãªå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–ã¯ initializeAdminPanel ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«å¤‰æ›´
// DOMContentLoaded ã¯å‰Šé™¤ - framework.js.htmlã§çµ±ä¸€ç®¡ç†

// Draft recovery utility function
function recoverDraftIfAvailable() {
  // Check for and recover draft from session storage
  if (typeof hasDraftInSession === 'function' && hasDraftInSession()) {
    if (typeof recoverDraftFromSession === 'function') {
      recoverDraftFromSession().catch(error => {
        console.warn('âš ï¸ Draft recovery failed:', error);
      });
    }
  }
}

// æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
function formatDateTime(date) {
  try {
    const options = {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      timeZone: 'Asia/Tokyo'
    };
    // Google Apps Script compatible date formatting
    return date.toLocaleDateString('ja-JP', options).replace(/\//g, '-');
  } catch (error) {
    console.warn('âš ï¸ Date formatting failed:', error);
    return date.toISOString().split('T')[0] + ' ' + date.toISOString().split('T')[1].substring(0, 5);
  }
}

// ãƒªã‚½ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•° (ãƒ•ã‚©ãƒ«ãƒ€æ©Ÿèƒ½ã¯å‰Šé™¤æ¸ˆã¿)
function updateNewResourceButtons(resourceUrls) {
  // ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ•ã‚©ãƒ«ãƒ€æ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ
  console.log('ğŸ“Š Resource URLs updated:', resourceUrls);
}

// åˆæœŸåŒ–ã¯ adminPanel-core.js ã®çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ã§ç®¡ç†ã•ã‚Œã¾ã™

// Explicitly register full implementations when this file loads
if (window.AdminPanel && window.AdminPanel.functionRegistry) {
  console.log('ğŸ”§ Registering full implementations from adminPanel-ui.js.html');
  const fullImplFunctions = [
    'updateUIWithNewStatus', 'populateHeaderOptions', 'populateConfig', 
    'updateFormUrlDisplay', 'validateConfig', 'updateConfigButtons'
  ];
  
  fullImplFunctions.forEach(funcName => {
    window.AdminPanel.functionRegistry.registerFullImplementation(funcName);
  });
  
  // Immediately check for full implementations after registration
  setTimeout(() => {
    const foundCount = window.AdminPanel.functionRegistry.checkForFullImplementations();
    console.log(`âœ… Full implementation registration complete: ${foundCount}/6 functions available`);
  }, 50);
} else {
  console.warn('âš ï¸ AdminPanel.functionRegistry not available for full implementation registration');
}

//# sourceURL=adminPanel-ui.js.html


// =============================================================================
// ADMIN PANEL EVENT LISTENERS & UI INTERACTIONS
// =============================================================================

// DOM Elements Cache
let elements = {};

// Event handler state tracking to prevent duplicate attachments
const eventHandlersAttached = {
  setupEventListeners: false,
  formConfigModal: false,
  resourceHandlers: false,
  accountManagement: false,
  externalLinks: false,
  modalHandlers: false,
  realtimeValidation: false
};

// å±¥æ­´ç®¡ç†ç”¨å®šæ•° - adminPanel-ui.js.htmlã§å®šç¾©æ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯å‚ç…§ã®ã¿
// const HISTORY_STORAGE_KEY = 'answerBoardHistory'; // é‡è¤‡å®£è¨€ã‚’å›é¿

// =============================================================================
// MAIN EVENT LISTENERS SETUP
// =============================================================================

function setupEventListeners() {
  // Prevent duplicate event handler attachment
  if (eventHandlersAttached.setupEventListeners) {
    logWarn('AdminPanel: Event handlers already attached, skipping duplicate setup');
    return;
  }
  
  eventHandlersAttached.setupEventListeners = true;
  
  // Cache frequently used elements (with safety check)
  if (typeof getCachedElement === 'function') {
    elements = {
      'sheet-select': getCachedElement('sheet-select'),
      'save-publish-btn': getCachedElement('save-publish-btn'),
      'unpublish-board-btn': getCachedElement('unpublish-board-btn'),
      'delete-account-btn': getCachedElement('delete-account-btn'),
      'open-spreadsheet-btn': getCachedElement('open-spreadsheet-btn'),
      'open-form-btn': getCachedElement('open-form-btn'),
      'clear-history-btn': getCachedElement('clear-history-btn')
    };
  } else {
    console.warn('getCachedElement not available, using fallback');
    elements = {
      'sheet-select': document.getElementById('sheet-select'),
      'save-publish-btn': document.getElementById('save-publish-btn'),
      'unpublish-board-btn': document.getElementById('unpublish-board-btn'),
      'delete-account-btn': document.getElementById('delete-account-btn'),
      'open-spreadsheet-btn': document.getElementById('open-spreadsheet-btn'),
      'open-form-btn': document.getElementById('open-form-btn'),
      'clear-history-btn': document.getElementById('clear-history-btn')
    };
  }
  
  
  // AI column detection button
  const reguessBtn = document.getElementById('reguess-headers-btn');
  if (reguessBtn) {
    reguessBtn.addEventListener('click', runHeaderGuessing);
  }
  
  // Save and publish button
  if (elements['save-publish-btn']) {
    elements['save-publish-btn'].addEventListener('click', () => {
      if (!selectedSheet) {
        showMessage('ã¾ãšã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');
        return;
      }
      saveAndPublish();
    });
  }
  
  // Unpublish button
  if (elements['unpublish-board-btn']) {
    elements['unpublish-board-btn'].addEventListener('click', () => {
      showStopConfirmationModal(
        'å…¬é–‹åœæ­¢ã®ç¢ºèª',
        'å›ç­”ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ',
        () => {
          unpublishBoard()
            .then((unpublishResult) => {
              logInfo('å…¬é–‹åœæ­¢å®Œäº†:', unpublishResult);
              
              // unpublishBoard()å†…ã§æ—¢ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€
              // ã“ã“ã§ã¯é‡è¤‡å‡¦ç†ã‚’é¿ã‘ã¦ã€çŠ¶æ…‹åŒæœŸã«é›†ä¸­
              logInfo('å…¬é–‹åœæ­¢å¾Œã®çŠ¶æ…‹åŒæœŸã‚’é–‹å§‹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ¸ˆã¿ï¼‰');
              
              // æ”¹å–„ã•ã‚ŒãŸéåŒæœŸå‡¦ç†å®Œäº†å¾…æ©Ÿ
              return new Promise(async (resolve) => {
                try {
                  // Step 1: DOMçŠ¶æ…‹ã®å®‰å®šåŒ–å¾…æ©Ÿï¼ˆçŸ­ç¸®ï¼‰
                  await new Promise(r => setTimeout(r, 300));
                  
                  // Step 2: çŠ¶æ…‹å†èª­ã¿è¾¼ã¿ï¼ˆå¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼‰
                  await loadStatus(true);
                  logInfo('å…¬é–‹åœæ­¢å¾Œã®çŠ¶æ…‹æ›´æ–°å®Œäº†');
                  
                  // Step 3: æœ€çµ‚çš„ãªUIçŠ¶æ…‹ç¢ºèª
                  await new Promise(r => setTimeout(r, 100));
                  
                  resolve(unpublishResult);
                } catch (error) {
                  logWarn('çŠ¶æ…‹åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                  resolve(unpublishResult); // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œ
                }
              });
            })
            .then(function() {
              logInfo('å…¬é–‹åœæ­¢å¾Œã®å®Œå…¨ãƒªã‚»ãƒƒãƒˆUIæ›´æ–°é–‹å§‹');
              
              // ã‚¹ãƒ†ãƒƒãƒ—1ã«æˆ»ã™ãŸã‚ã®UIæ›´æ–°
              if (typeof updateStepIndicators === 'function') {
                console.log('ğŸ¯ updateStepIndicatorså®Ÿè¡Œä¸­: ã‚¹ãƒ†ãƒƒãƒ—1ã«å®Œå…¨ãƒªã‚»ãƒƒãƒˆ');
                updateStepIndicators(1, null);
              } else {
                console.warn('âš ï¸ updateStepIndicatorsé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              }
              
              if (typeof updateGuidanceForStep === 'function') {
                const guidanceText = document.getElementById('guidance-text');
                if (guidanceText) {
                  console.log('ğŸ¯ updateGuidanceForStepå®Ÿè¡Œä¸­: ã‚¹ãƒ†ãƒƒãƒ—1ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹');
                  updateGuidanceForStep(1, guidanceText);
                } else {
                  console.warn('âš ï¸ guidance-textè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
              } else {
                console.warn('âš ï¸ updateGuidanceForStepé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              }
              
              // ãƒ•ã‚©ãƒ¼ãƒ é–¢é€£è¦ç´ ã®åˆæœŸåŒ–
              try {
                console.log('ğŸ§¹ ãƒ•ã‚©ãƒ¼ãƒ é–¢é€£UIè¦ç´ ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ');
                
                // ã‚·ãƒ¼ãƒˆé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ã‚¯ãƒªã‚¢
                const sheetSelect = document.getElementById('sheet-select');
                if (sheetSelect) {
                  sheetSelect.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                  sheetSelect.selectedIndex = 0;
                  console.log('âœ… ã‚·ãƒ¼ãƒˆé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ');
                }
                
                // åˆ—è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                const columnSelects = ['opinion-column', 'name-column', 'reason-column', 'class-column'];
                columnSelects.forEach(selectId => {
                  const selectElement = document.getElementById(selectId);
                  if (selectElement) {
                    selectElement.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                    selectElement.selectedIndex = 0;
                  }
                });
                console.log('âœ… åˆ—è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ');
                
                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–
                const checkboxes = ['show-names', 'show-counts'];
                checkboxes.forEach(checkboxId => {
                  const checkbox = document.getElementById(checkboxId);
                  if (checkbox) {
                    checkbox.checked = false;
                  }
                });
                console.log('âœ… è¡¨ç¤ºè¨­å®šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ');
                
              } catch (resetError) {
                console.warn('âš ï¸ UIè¦ç´ ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', resetError);
              }
              
              console.log('âœ… å…¬é–‹åœæ­¢å¾Œã®å®Œå…¨ãƒªã‚»ãƒƒãƒˆUIæ›´æ–°å®Œäº†');
              showMessage('å›ç­”ãƒœãƒ¼ãƒ‰ã¯éå…¬é–‹ã«ãªã‚Šã€è¨­å®šã¯åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚', 'success');
            })
            .catch(function(error) {
              console.error('âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
              let errorMessage = 'âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
              
              // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ã¦ã‚ˆã‚Šå…·ä½“çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
              if (error.message && error.message.includes('customFormInfo')) {
                errorMessage = 'âŒ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
              } else if (error.message && error.message.includes('è¨±å¯ã•ã‚Œã¦ã„ãªã„')) {
                errorMessage = 'âŒ ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ¨©é™ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
              } else if (error.message && error.message.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯')) {
                errorMessage = 'âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
              }
              
              showMessage(errorMessage, 'error');
            });
        }
      );
    });
  }
  
  // Clear history button - ç›´æ¥å–å¾—ã§ç¢ºå®Ÿã«å‡¦ç†
  const clearHistoryBtn = document.getElementById('clear-history-btn');
  if (clearHistoryBtn) {
    clearHistoryBtn.addEventListener('click', () => {
      console.log('ğŸ—‘ï¸ å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      
        if (typeof showConfirmationModal === 'function') {
          showHistoryClearConfirmationModal(
            'å±¥æ­´å‰Šé™¤ã®ç¢ºèª',
            'ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚',
            async function() {
              
              try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                showMessage('ğŸ”„ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™...', 'info');
                
                // ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
                if (typeof clearSimpleHistory === 'function') {
                  clearSimpleHistory();
                  showMessage('âœ… å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                } else {
                  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥localStorageæ“ä½œ
                  localStorage.removeItem(HISTORY_STORAGE_KEY || 'answerBoardHistory');
                  if (typeof updateHistoryTable === 'function') {
                    updateHistoryTable();
                  }
                  showMessage('âœ… å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                }
                
              } catch (error) {
                console.error('âŒ å±¥æ­´ã‚¯ãƒªã‚¢ã«å¤±æ•—:', error);
                showMessage('âŒ å±¥æ­´ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
              }
            }
          );
        } else {
          console.error('âŒ showConfirmationModalé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ç¢ºèª
          if (confirm('ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
            (async () => {
              try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                showMessage('ğŸ”„ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™...', 'info');
                
                // ã‚·ãƒ³ãƒ—ãƒ«å±¥æ­´ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                if (typeof clearSimpleHistory === 'function') {
                  clearSimpleHistory();
                  showMessage('âœ… å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                } else {
                  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥localStorageæ“ä½œ
                  localStorage.removeItem(HISTORY_STORAGE_KEY || 'answerBoardHistory');
                  if (typeof updateHistoryTable === 'function') {
                    updateHistoryTable();
                  }
                  showMessage('âœ… å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                }
                
              } catch (error) {
                console.error('âŒ å±¥æ­´ã‚¯ãƒªã‚¢ã«å¤±æ•—:', error);
                showMessage('âŒ å±¥æ­´ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
              }
            })();
          }
        }
    });
  } else {
    console.error('âŒ clear-history-btnãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  const quickstartBtn = document.getElementById('quickstart-btn');
  if (quickstartBtn) {
    quickstartBtn.addEventListener('click', function() {
      if (typeof handleQuickStart === 'function') {
        handleQuickStart();
      } else {
        console.error('handleQuickStart function not found');
        showMessage('ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'warning');
      }
    });
  }

  // Create board button
  const createBoardBtn = document.getElementById('create-board-btn');
  if (createBoardBtn) {
    createBoardBtn.addEventListener('click', function() {
      // å…¬é–‹çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      if (currentStatus && currentStatus._normalized && currentStatus._normalized.isPublished) {
        // å…¬é–‹ä¸­ã®å ´åˆã€é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        window.sharedModals.showCustomSetupSelection(
          (selectedOption) => {
            if (selectedOption === 'stop') {
              // åœæ­¢ã—ã¦ä½œæˆã‚’é¸æŠ
              proceedWithCustomFormCreation(true);
            } else if (selectedOption === 'continue') {
              // ç¶™ç¶šã—ãªãŒã‚‰ä½œæˆã‚’é¸æŠ
              proceedWithCustomFormCreation(false);
            }
          },
          () => {
            console.log('âŒ ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
          }
        );
      } else {
        // å…¬é–‹ã—ã¦ã„ãªã„å ´åˆã€ç›´æ¥ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        proceedWithCustomFormCreation(false);
      }
    });
  }

  // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚’é€²è¡Œ
  function proceedWithCustomFormCreation(shouldStop) {
    if (shouldStop) {
      
      // å®Ÿéš›ã«å…¬é–‹åœæ­¢å‡¦ç†ã‚’å®Ÿè¡Œ
      if (typeof unpublishBoard === 'function') {
        console.log('ğŸ›‘ å…¬é–‹åœæ­¢å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...');
        
        // å…¬é–‹åœæ­¢ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        showStopConfirmationModal(
          'å…¬é–‹åœæ­¢ã®ç¢ºèª',
          'ç¾åœ¨å…¬é–‹ä¸­ã®ãƒœãƒ¼ãƒ‰ã‚’åœæ­¢ã—ã¦ã‹ã‚‰ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
          function() {
            // ç¢ºèªå¾Œã€å®Ÿéš›ã«åœæ­¢å‡¦ç†ã‚’å®Ÿè¡Œ
            executeStopAndCreateForm();
          },
          function() {
            console.log('âŒ å…¬é–‹åœæ­¢ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
          }
        );
      } else {
        console.error('unpublishBoard function not found');
        showMessage('å…¬é–‹åœæ­¢æ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'warning');
      }
    } else {
      
      // ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ã¯å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
      try {
        localStorage.setItem('expandAllSections', 'true');
      } catch (e) {
        console.warn('âš ï¸ localStorageè¨­å®šã«å¤±æ•—:', e);
      }
      
      // ç¶™ç¶šã®å ´åˆã¯ç›´æ¥ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      showFormConfigModalSafely();
    }
  }

  // å…¬é–‹åœæ­¢â†’ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã®å®Ÿè¡Œ
  function executeStopAndCreateForm() {

    // unpublishBoardé–¢æ•°ã‚’å‘¼ã³å‡ºã—
    unpublishBoard()
      .then(function(response) {
        // Use debounced loadStatus to prevent rapid successive calls
        if (window.AdminPanel && window.AdminPanel.debounce) {
          window.AdminPanel.debounce.loadStatus(() => loadStatus(true), 300);
          return Promise.resolve(response);
        } else {
          return loadStatus(true).then(() => response);
        }
      })
      .then(function(response) {
        // å…¬é–‹åœæ­¢ãŒç¢ºå®Ÿã«å®Œäº†ã—ãŸæ—¨ã‚’è¡¨ç¤º
        showMessage('âœ… å…¬é–‹åœæ­¢ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã§ãã¾ã™ã€‚', 'success');

        // å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆå…¬é–‹åœæ­¢å¾Œã®ç®¡ç†ãƒ‘ãƒãƒ«è¡¨ç¤ºæ”¹å–„ï¼‰
        try {
          localStorage.setItem('expandAllSections', 'true');
          console.log('ğŸ“‚ å…¬é–‹åœæ­¢å¾Œã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ã¾ã—ãŸ');
        } catch (e) {
          console.warn('âš ï¸ localStorageè¨­å®šã«å¤±æ•—:', e);
        }

        // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        setTimeout(function() {
          console.log('ğŸ¨ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™');
          showFormConfigModalSafely();
        }, 1500); // 1.5ç§’å¾Œã«è¡¨ç¤ºï¼ˆUIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ™‚é–“ã‚’ç¢ºä¿ï¼‰
      })
      .catch(function(error) {
        console.error('âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        let errorMessage = 'âŒ å…¬é–‹åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        
        // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ã¦ã‚ˆã‚Šå…·ä½“çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (error.message && error.message.includes('customFormInfo')) {
          errorMessage = 'âŒ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        } else if (error.message && error.message.includes('è¨±å¯ã•ã‚Œã¦ã„ãªã„')) {
          errorMessage = 'âŒ ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ¨©é™ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
        } else if (error.message && error.message.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯')) {
          errorMessage = 'âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        }
        
        showMessage(errorMessage, 'error');
      });
  }

  // å®‰å…¨ãªãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  function showFormConfigModalSafely() {
    if (typeof showFormConfigModal === 'function') {
      showFormConfigModal();
    } else {
      console.error('showFormConfigModal function not found');
      showMessage('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'warning');
    }
  }

  // Create additional form button
  const createAdditionalFormBtn = document.getElementById('create-additional-form-btn');
  if (createAdditionalFormBtn) {
    createAdditionalFormBtn.addEventListener('click', function() {
      if (!currentStatus || !currentStatus.userInfo || !currentStatus.userInfo.spreadsheetId) {
        showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
        return;
      }
      showFormConfigModal();
    });
  }
  
  // Form configuration modal handlers
  setupFormConfigModalHandlers();
  
  // Resource management
  setupResourceHandlers();
  
  // Account management
  setupAccountManagementHandlers();
  
  // External links
  setupExternalLinkHandlers();
  
  // Modal handlers
  setupModalHandlers();
  
  // Real-time validation
  setupRealtimeValidation();
  
}

// =============================================================================
// FORM CONFIGURATION MODAL HANDLERS
// =============================================================================

function setupFormConfigModalHandlers() {
  if (eventHandlersAttached.formConfigModal) {
    logDebug('Form config modal handlers already attached');
    return;
  }
  eventHandlersAttached.formConfigModal = true;
  
  const formConfigClose = document.getElementById('form-config-close');
  const formConfigCancel = document.getElementById('form-config-cancel');
  const formConfigCreate = document.getElementById('form-config-create');
  
  if (formConfigClose) {
    formConfigClose.addEventListener('click', function() {
      if (typeof hideFormConfigModal === 'function') {
        hideFormConfigModal();
      } else {
        console.warn('hideFormConfigModal not available');
      }
    });
  }
  
  if (formConfigCancel) {
    formConfigCancel.addEventListener('click', function() {
      if (typeof hideFormConfigModal === 'function') {
        hideFormConfigModal();
      } else {
        console.warn('hideFormConfigModal not available');
      }
    });
  }
  
  if (formConfigCreate) {
    formConfigCreate.addEventListener('click', createFormWithConfig);
  }
}

// =============================================================================
// RESOURCE MANAGEMENT HANDLERS
// =============================================================================

function setupResourceHandlers() {
  if (eventHandlersAttached.resourceHandlers) {
    logDebug('Resource handlers already attached');
    return;
  }
  eventHandlersAttached.resourceHandlers = true;
  
  const addResourceBtn = document.getElementById('add-resource-btn');
  const resourceUrlInput = document.getElementById('resource-url-input');
  const initializeSettingsBtn = document.getElementById('initialize-settings-btn');
  
  if (addResourceBtn) {
    addResourceBtn.addEventListener('click', addResource);
  }
  
  if (resourceUrlInput) {
    resourceUrlInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addResource();
      }
    });
  }
  
  if (initializeSettingsBtn) {
    initializeSettingsBtn.addEventListener('click', initializeUserSettingsWithUI);
  }
}

// =============================================================================
// ACCOUNT MANAGEMENT HANDLERS
// =============================================================================

function setupAccountManagementHandlers() {
  if (eventHandlersAttached.accountManagement) {
    logDebug('Account management handlers already attached');
    return;
  }
  eventHandlersAttached.accountManagement = true;
  
  // Delete account handler - é˜²å¾¡çš„å®Ÿè£…
  const deleteBtn = elements['delete-account-btn'] || getCachedElement('delete-account-btn');
  if (deleteBtn) {
    // é‡è¤‡ç™»éŒ²é˜²æ­¢ã®ãŸã‚ãƒ•ãƒ©ã‚°ã§ç®¡ç†
    if (!deleteBtn._deleteListenerAttached) {
      deleteBtn.addEventListener('click', handleDeleteRequest);
      deleteBtn._deleteListenerAttached = true;
      if (window.DEBUG_MODE || window.location.hostname === 'localhost') {
        console.log('Delete account button event listener attached successfully');
      }
    }
  } else {
    console.warn('Delete account button not found');
  }
  
  // Switch account handlers
  const switchAccountBtns = document.querySelectorAll('[onclick*="switchToAnotherAccount"]');
  switchAccountBtns.forEach((btn) => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      switchToAnotherAccount();
    });
  });
}

// =============================================================================
// EXTERNAL LINK HANDLERS
// =============================================================================

function setupExternalLinkHandlers() {
  if (eventHandlersAttached.externalLinks) {
    logDebug('External link handlers already attached');
    return;
  }
  eventHandlersAttached.externalLinks = true;
  
  // Open spreadsheet
  if (elements['open-spreadsheet-btn']) {
    elements['open-spreadsheet-btn'].addEventListener('click', openDatabaseSpreadsheet);
  }
  
  // Open form
  if (elements['open-form-btn']) {
    elements['open-form-btn'].addEventListener('click', openForm);
  }
  
  // Digital citizenship
  const digitalCitizenshipBtn = document.getElementById('digital-citizenship-btn');
  if (digitalCitizenshipBtn) {
    digitalCitizenshipBtn.addEventListener('click', showDigitalCitizenshipModal);
  }
  
  // Copy board URL
  const copyUrlBtn = document.getElementById('copy-url-btn');
  if (copyUrlBtn) {
    copyUrlBtn.addEventListener('click', copyBoardUrl);
  }
  
  // Copy form URL
  const copyFormUrlBtn = document.getElementById('copy-form-url-btn');
  if (copyFormUrlBtn) {
    copyFormUrlBtn.addEventListener('click', copyFormUrl);
  }
}

// =============================================================================
// MODAL HANDLERS
// =============================================================================

function setupModalHandlers() {
  if (eventHandlersAttached.modalHandlers) {
    logDebug('Modal handlers already attached');
    return;
  }
  eventHandlersAttached.modalHandlers = true;
  
  // Privacy modal
  const privacyClose = document.getElementById('privacy-modal-close');
  const privacyCancel = document.getElementById('privacy-modal-cancel');
  
  if (privacyClose) {
    privacyClose.addEventListener('click', hidePrivacyModal);
  }
  
  if (privacyCancel) {
    privacyCancel.addEventListener('click', hidePrivacyModal);
  }
  
  // Digital citizenship modal
  const dcClose = document.getElementById('digital-citizenship-close');
  if (dcClose) {
    dcClose.addEventListener('click', hideDigitalCitizenshipModal);
  }
  
  // Confirmation modal
  const confirmClose = document.getElementById('confirmation-modal-close');
  const confirmCancel = document.getElementById('confirmation-modal-cancel');
  
  if (confirmClose) {
    confirmClose.addEventListener('click', hideConfirmationModal);
  }
  
  if (confirmCancel) {
    confirmCancel.addEventListener('click', hideConfirmationModal);
  }
  
  // Close modals on backdrop click
  setupBackdropClickHandlers();
}

// =============================================================================
// BACKDROP CLICK HANDLERS
// =============================================================================

function setupBackdropClickHandlers() {
  const modals = [
    'form-config-modal',
    'privacy-modal',
    'digital-citizenship-modal',
    'confirmation-modal'
  ];
  
  modals.forEach((modalId) => {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          // Close modal when clicking backdrop
          switch(modalId) {
            case 'form-config-modal':
              if (typeof hideFormConfigModal === 'function') {
                hideFormConfigModal();
              }
              break;
            case 'privacy-modal':
              hidePrivacyModal();
              break;
            case 'digital-citizenship-modal':
              hideDigitalCitizenshipModal();
              break;
            case 'confirmation-modal':
              hideConfirmationModal();
              break;
          }
        }
      });
    }
  });
}

// =============================================================================
// REAL-TIME VALIDATION
// =============================================================================

function setupRealtimeValidation() {
  if (eventHandlersAttached.realtimeValidation) {
    logDebug('Realtime validation handlers already attached');
    return;
  }
  eventHandlersAttached.realtimeValidation = true;
  
  // Opinion column validation
  const opinionSelect = document.getElementById('opinion-column');
  if (opinionSelect) {
    opinionSelect.addEventListener('change', updateConfigButtons);
  }
  
  // Show names checkbox
  const showNamesCheckbox = document.getElementById('show-names');
  if (showNamesCheckbox) {
    showNamesCheckbox.addEventListener('change', updateConfigButtons);
  }
  
  // Show counts checkbox
  const showCountsCheckbox = document.getElementById('show-counts');
  if (showCountsCheckbox) {
    showCountsCheckbox.addEventListener('change', updateConfigButtons);
  }
  
  // Name column validation
  const nameSelect = document.getElementById('name-column');
  if (nameSelect) {
    nameSelect.addEventListener('change', function() {
  const showNamesCheckbox = document.getElementById('show-names');
      if (showNamesCheckbox && this.value) {
        showNamesCheckbox.disabled = false;
      } else if (showNamesCheckbox) {
        showNamesCheckbox.disabled = true;
        showNamesCheckbox.checked = false;
      }
      updateConfigButtons();
    });
  }
}

// =============================================================================
// SPECIFIC EVENT HANDLERS
// =============================================================================

// Handle delete account request
function handleDeleteRequest() {
  window.sharedModals.showConfirmation(
    'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã®ç¢ºèª',
    'æœ¬å½“ã«ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ãšã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ã€‚',
    function() {
      runGasWithUserId('deleteCurrentUserAccount', 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã„ã¾ã™...')
        .then(function(response) {
          showMessage(response.message || 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚', 'success');
          
          // å®Œå…¨ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Ÿè¡Œ
          try {
            if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
              window.unifiedCache.clear();
            }
            if (window.gasOptimizer && typeof window.gasOptimizer.clearCache === 'function') {
              window.gasOptimizer.clearCache();
            }
            if (window.localStorage) {
              // å±¥æ­´ã‚­ãƒ¼ã‚’ä¿è­·ã™ã‚‹é¸æŠçš„ã‚¯ãƒªã‚¢
              const historyKeys = ['answerBoardHistory', 'adminPanelHistory'];
              const allKeys = Object.keys(localStorage);
              
              allKeys.forEach(key => {
                if (!historyKeys.includes(key)) {
                  try {
                    localStorage.removeItem(key);
                  } catch (e) {
                    console.warn('âš ï¸ Failed to remove localStorage key:', key);
                  }
                }
              });
              
            }
            if (window.sessionStorage) {
              window.sessionStorage.clear();
            }
          } catch (clearError) {
            console.warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', clearError);
          }
          
          // å¼·åˆ¶çš„ãªãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
          setTimeout(function() {
            // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            runGasWithUserId('resetUserAuthentication')
              .then(function(loginUrl) {
                console.log('ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ:', loginUrl);
                window.location.href = loginUrl || window.location.origin + window.location.pathname;
              })
              .catch(function(error) {
                console.warn('ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒšãƒ¼ã‚¸ã‚’å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                window.location.href = window.location.origin + window.location.pathname;
              });
          }, 1500);
        })
        .catch(function(error) {
          handleError(error, 'deleteAccount', 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        });
    }
  );
}

/**
 * Show history clear confirmation modal with appropriate button text
 * @param {string} title - Modal title
 * @param {string} message - Modal message
 * @param {Function} onConfirm - Confirmation callback
 */
function showHistoryClearConfirmationModal(title, message, onConfirm) {
  const modal = document.getElementById('confirmation-modal');
  const titleElement = document.getElementById('modal-title');
  const messageElement = document.getElementById('modal-message');
  const confirmBtn = document.getElementById('modal-confirm-btn');
  const cancelBtn = document.getElementById('modal-cancel-btn');
  
  if (modal && titleElement && messageElement && confirmBtn && cancelBtn) {
    titleElement.textContent = title;
    messageElement.textContent = message;
    confirmBtn.textContent = 'å‰Šé™¤ã™ã‚‹';
    cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    
    // Set up event handlers
    const handleConfirm = () => {
      modal.classList.add('hidden');
      onConfirm();
      cleanup();
    };
    
    const handleCancel = () => {
      modal.classList.add('hidden');
      cleanup();
    };
    
    const cleanup = () => {
      confirmBtn.removeEventListener('click', handleConfirm);
      cancelBtn.removeEventListener('click', handleCancel);
    };
    
    confirmBtn.addEventListener('click', handleConfirm);
    cancelBtn.addEventListener('click', handleCancel);
    
    // Show modal
    modal.classList.remove('hidden');
  } else {
    console.warn('âš ï¸ Modal elements not found, using fallback');
    if (confirm(`${title}\n\n${message}`)) {
      onConfirm();
    }
  }
}

/**
 * Show stop/unpublish confirmation modal with appropriate button text
 * @param {string} title - Modal title
 * @param {string} message - Modal message
 * @param {Function} onConfirm - Confirmation callback
 */
function showStopConfirmationModal(title, message, onConfirm) {
  const modal = document.getElementById('confirmation-modal');
  const titleElement = document.getElementById('modal-title');
  const messageElement = document.getElementById('modal-message');
  const confirmBtn = document.getElementById('modal-confirm-btn');
  const cancelBtn = document.getElementById('modal-cancel-btn');
  
  if (modal && titleElement && messageElement && confirmBtn && cancelBtn) {
    titleElement.textContent = title;
    messageElement.textContent = message;
    confirmBtn.textContent = 'åœæ­¢ã™ã‚‹';
    cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    
    // Set up event handlers
    const handleConfirm = () => {
      modal.classList.add('hidden');
      onConfirm();
      cleanup();
    };
    
    const handleCancel = () => {
      modal.classList.add('hidden');
      cleanup();
    };
    
    const cleanup = () => {
      confirmBtn.removeEventListener('click', handleConfirm);
      cancelBtn.removeEventListener('click', handleCancel);
    };
    
    confirmBtn.addEventListener('click', handleConfirm);
    cancelBtn.addEventListener('click', handleCancel);
    
    // Show modal
    modal.classList.remove('hidden');
  } else {
    console.warn('âš ï¸ Modal elements not found, using fallback');
    if (confirm(`${title}\n\n${message}`)) {
      onConfirm();
    }
  }
}

// Switch to another account
function switchToAnotherAccount() {
  showConfirmationModal(
    'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ',
    'åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚',
    function() {
      sharedUtilities.gas.callWithLoading('resetUserAuthentication', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™...', 'overlay')
        .then(function(result) {
          console.log('Session cleanup result:', result);
          window.location.href = 'https://accounts.google.com/logout';
        })
        .catch(function(error) {
          console.error('Session cleanup failed:', error);
          alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãã ã•ã„ã€‚');
          window.location.href = 'https://accounts.google.com/logout';
        });
    }
  );
}

// updateUIForSelectedSheet function moved to adminPanel-ui.js.html to resolve loading order issues

// =============================================================================
// KEYBOARD SHORTCUTS
// =============================================================================

// Setup keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + S for save and publish
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    if (selectedSheet && elements['save-publish-btn'] && !elements['save-publish-btn'].disabled) {
      saveAndPublish();
    }
  }
  
  // Escape to close modals
  if (e.key === 'Escape') {
  const openModals = document.querySelectorAll('.modal:not(.hidden)');
    if (openModals.length > 0) {
  const lastModal = openModals[openModals.length - 1];
  const modalId = lastModal.id;
      
      switch(modalId) {
        case 'form-config-modal':
          if (typeof hideFormConfigModal === 'function') {
            hideFormConfigModal();
          }
          break;
        case 'privacy-modal':
          hidePrivacyModal();
          break;
        case 'digital-citizenship-modal':
          hideDigitalCitizenshipModal();
          break;
        case 'confirmation-modal':
          hideConfirmationModal();
          break;
      }
    }
  }
});


// =============================================================================
// ACCESSIBILITY ENHANCEMENTS
// =============================================================================

// Focus management for modals
function manageFocusForModal(modalId, show) {
  const modal = document.getElementById(modalId);
  if (!modal) return;
  
  if (show) {
    // Store currently focused element
    modal.setAttribute('data-previous-focus', (document.activeElement && document.activeElement.id) || '');
    
    // Focus first interactive element in modal
  const firstFocusable = modal.querySelector('button, input, textarea, select, [tabindex]:not([tabindex="-1"])');
    if (firstFocusable) {
      firstFocusable.focus();
    }
  } else {
    // Restore focus to previous element
  const previousFocusId = modal.getAttribute('data-previous-focus');
    if (previousFocusId) {
  const previousElement = document.getElementById(previousFocusId);
      if (previousElement) {
        previousElement.focus();
      }
    }
  }
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Event listener initialization is now handled in adminPanel-framework.js.html

//# sourceURL=adminPanel-events.js.html


// =============================================================================
// CONSOLIDATED ADMIN PANEL CORE FUNCTIONALITY
// =============================================================================
// This file consolidates adminPanel.js.html and adminPanel-core.js.html
// to reduce redundancy and improve maintainability

// =============================================================================
// UNIFIED MANAGEMENT SYSTEM API - çµ±ä¸€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ API
// =============================================================================

/**
 * çµ±ä¸€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - å…¨ç®¡ç†ã‚¯ãƒ©ã‚¹ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 */
window.unifiedManagement = {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç† (CacheManager)
  cache: {
    get(key, valueFn, options) {
      return typeof cacheManager !== 'undefined' ? cacheManager.get(key, valueFn, options) : (valueFn ? valueFn() : null);
    },
    remove(key) {
      return typeof cacheManager !== 'undefined' ? cacheManager.remove(key) : null;
    },
    clearAll() {
      return typeof cacheManager !== 'undefined' ? cacheManager.clearAll() : null;
    },
    clearFrontend(options) {
      return typeof cacheManager !== 'undefined' ? cacheManager.clearAllFrontendCaches(options) : Promise.resolve({ success: false });
    },
    clearSpecific(type) {
      return typeof cacheManager !== 'undefined' ? cacheManager.clearSpecificCache(type) : Promise.resolve({ success: false });
    },
    diagnose() {
      return typeof cacheManager !== 'undefined' ? cacheManager.diagnoseFrontendCache() : { available: false };
    },
    getHealth() {
      return typeof cacheManager !== 'undefined' ? cacheManager.getHealth() : { status: 'unavailable' };
    }
  },

  // ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡ (TimingManager)  
  timing: {
    delay(ms, id) {
      return typeof TimingManager !== 'undefined' ? TimingManager.delay(ms, id) : new Promise((resolve) => {
        setTimeout(resolve, ms);
      });
    },
    sequence(operations, intervalMs, sequenceId) {
      return typeof TimingManager !== 'undefined' ? TimingManager.sequence(operations, intervalMs, sequenceId) : Promise.resolve([]);
    },
    parallel(operations, concurrency) {
      return typeof TimingManager !== 'undefined' ? TimingManager.parallel(operations, concurrency) : Promise.all(operations.map((op) => op()));
    },
    debounce(func, key, delay) {
      return typeof TimingManager !== 'undefined' ? TimingManager.debounce(func, key, delay) : func;
    },
    throttle(func, key, delay) {
      return typeof TimingManager !== 'undefined' ? TimingManager.throttle(func, key, delay) : func;
    }
  },

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¶å¾¡
  loading: {
    show(options) {
      if (typeof UnifiedLoadingManager !== 'undefined') {
        return UnifiedLoadingManager.showLoading(options);
      }
      return { success: false };
    },
    hide(options) {
      if (typeof UnifiedLoadingManager !== 'undefined') {
        return UnifiedLoadingManager.hideLoading(options);
      }
      return { success: false };
    },
    update(progress, message) {
      if (typeof UnifiedLoadingManager !== 'undefined') {
        return UnifiedLoadingManager.updateProgress(progress, message);
      }
      return { success: false };
    }
  }
};

// =============================================================================
// STEP VALIDATION AND MANAGEMENT
// =============================================================================

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰å–å¾—
 */
const getSetupStatusFromGlobalStatus = () => {
  try {
    if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
      const config = typeof currentStatus.userInfo.configJson === 'string' 
        ? JSON.parse(currentStatus.userInfo.configJson) 
        : currentStatus.userInfo.configJson;
      return config.setupStatus || 'pending';
    }
    return 'pending';
  } catch (error) {
    logWarn('getSetupStatusFromGlobalStatus ã‚¨ãƒ©ãƒ¼:', error);
    return 'pending';
  }
}

/**
 * ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ¤œè¨¼ã—ã€UIçŠ¶æ…‹ã‚’æ›´æ–°
 */
function validateCurrentStep() {
  const savePublishBtn = document.getElementById('save-publish-btn');
  if (!savePublishBtn) return;
  
  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ç¢ºèª
  const setupStatus = getSetupStatusFromGlobalStatus();
  
  const isValid = false;
  
  // currentStepãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
  if (typeof currentStep === 'undefined') {
    console.warn('currentStep is not defined, defaulting to 1');
    currentStep = 1;
  }
  
  switch (currentStep) {
    case 1:
      isValid = (typeof selectedSheetId !== 'undefined' && selectedSheetId) || 
                (typeof selectedFormId !== 'undefined' && selectedFormId);
      break;
    case 2:
      // Step 2 validation: check for both config validation AND setup completion
  const configValid = (typeof currentConfig !== 'undefined' && currentConfig) && 
                       (typeof validateConfiguration === 'function' ? validateConfiguration() : true);
  const step2Complete = typeof checkStep2Completion === 'function' ? checkStep2Completion() : false;
      isValid = configValid || step2Complete;
      logDebug('Step 2 validation: configValid=' + configValid + ', step2Complete=' + step2Complete + ', isValid=' + isValid);
      break;
    case 3:
      isValid = true;
      break;
    default:
      isValid = false;
  }
  
  savePublishBtn.disabled = !isValid;
}

/**
 * Step 2ã®å®Œäº†çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
 */
function checkStep2Completion() {
  try {
    // åŸºæœ¬çš„ãªè¨­å®šé …ç›®ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
  const hasValidConfig = currentConfig && 
                        typeof currentConfig === 'object' && 
                        Object.keys(currentConfig).length > 0;
    
    // UIè¦ç´ ã®çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯  
  const hasFormSelection = document.querySelector('input[name="form-option"]:checked');
  const hasSheetSelection = document.getElementById('sheet-select') && 
                           document.getElementById('sheet-select').value;
    
    return hasValidConfig || hasFormSelection || hasSheetSelection;
  } catch (error) {
    logWarn('checkStep2Completion ã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}

/**
 * è¨­å®šã®å¦¥å½“æ€§ã‚’æ¤œè¨¼
 */
function validateConfiguration() {
  try {
    if (!currentConfig || typeof currentConfig !== 'object') {
      return false;
    }
    
    // åŸºæœ¬çš„ãªå¿…é ˆé …ç›®ã®ãƒã‚§ãƒƒã‚¯
  const requiredFields = ['timestampHeader', 'opinionHeader'];
    for (let i = 0; i < requiredFields.length; i++) {
  const field = requiredFields[i];
      if (!currentConfig[field]) {
        logDebug('Missing required field: ' + field);
        return false;
      }
    }
    
    return true;
  } catch (error) {
    logWarn('validateConfiguration ã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}

// =============================================================================
// UI HELPER FUNCTIONS
// =============================================================================

// safeGetElement function already defined at line 3023

/**
 * å®‰å…¨ãªã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
 */
function safeAddEventListener(element, event, handler) {
  if (!element) return false;
  
  try {
    element.addEventListener(event, handler);
    return true;
  } catch (error) {
    console.warn('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²ã«å¤±æ•—:', event, error);
    return false;
  }
}

/**
 * è¦ç´ ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’å®‰å…¨ã«åˆ‡ã‚Šæ›¿ãˆ
 */
function safeToggleVisibility(selector, isVisible) {
  const element = safeGetElement(selector);
  if (!element) return false;
  
  try {
    if (isVisible) {
      element.style.display = '';
      element.classList.remove('hidden');
    } else {
      element.style.display = 'none';
      element.classList.add('hidden');
    }
    return true;
  } catch (error) {
    console.warn('è¦ç´ ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—:', selector, error);
    return false;
  }
}

// =============================================================================
// INITIALIZATION
// =============================================================================

/**
 * çµ±åˆã‚³ã‚¢æ©Ÿèƒ½ã®åˆæœŸåŒ–
 */
function initializeAdminCore() {
  console.log('ğŸ”§ Admin Core initializing...');
  
  try {
    // åŸºæœ¬çš„ãªUIçŠ¶æ…‹ã®åˆæœŸåŒ–
    if (typeof validateCurrentStep === 'function') {
      validateCurrentStep();
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¨­å®š
    window.addEventListener('error', function(event) {
      if (event.error && event.error.message) {
        logError('Global error caught:', event.error.message);
      }
    });
    
    // Promiseã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('unhandledrejection', function(event) {
      logError('Unhandled promise rejection:', event.reason);
      event.preventDefault(); // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’é˜²ã
    });
    
    console.log('âœ… Admin Core initialized successfully');
    return true;
  } catch (error) {
    console.error('âŒ Admin Core initialization failed:', error);
    return false;
  }
}

// DOMæº–å‚™å®Œäº†å¾Œã«åˆæœŸåŒ–å®Ÿè¡Œ
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeAdminCore);
} else {
  initializeAdminCore();
}

// =============================================================================
// LEGACY COMPATIBILITY
// =============================================================================

// æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ã€ä¸»è¦ãªé–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é…ç½®
window.validateCurrentStep = validateCurrentStep;
window.getSetupStatusFromGlobalStatus = getSetupStatusFromGlobalStatus;
window.checkStep2Completion = checkStep2Completion;
window.validateConfiguration = validateConfiguration;
window.safeGetElement = safeGetElement;
window.safeAddEventListener = safeAddEventListener;
window.safeToggleVisibility = safeToggleVisibility;


/**
 * ç°¡æ˜“å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
 * ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
 */

// å±¥æ­´ç®¡ç†å®šæ•°
const HISTORY_STORAGE_KEY = 'answerBoardHistory';
const MAX_HISTORY_ITEMS = 5;

/**
 * ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å±¥æ­´ã‚’å–å¾—
 * @returns {Array} å±¥æ­´é…åˆ—
 */
function getSimpleHistory() {
  try {
    const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
    return historyJson ? JSON.parse(historyJson) : [];
  } catch (error) {
    logWarn('å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
    return [];
  }
}

/**
 * å±¥æ­´ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
 * @param {Array} historyArray å±¥æ­´é…åˆ—
 */
function saveSimpleHistory(historyArray) {
  try {
    const safeHistory = Array.isArray(historyArray) ? historyArray : [];
    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(safeHistory));
    logDebug('å±¥æ­´ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', safeHistory.length, 'ä»¶');
  } catch (error) {
    logWarn('å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—:', error);
  }
}

/**
 * æ–°ã—ã„å±¥æ­´é …ç›®ã‚’è¿½åŠ 
 * @param {Object} historyItem å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ 
 */
function addToSimpleHistory(historyItem) {
  try {
    if (!historyItem || !historyItem.questionText) {
      logWarn('ç„¡åŠ¹ãªå±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã§ã™');
      return;
    }

    const history = getSimpleHistory();
    const newItem = {
      id: 'history_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      questionText: historyItem.questionText,
      publishedAt: new Date().toISOString(),
      displayMode: historyItem.displayMode || 'NAMED',
      configData: historyItem.configData || {} // configJsonã¨ã—ã¦ä¿å­˜ã•ã‚Œã‚‹å®Ÿéš›ã®è¨­å®šãƒ‡ãƒ¼ã‚¿
    };

    // å…ˆé ­ã«è¿½åŠ 
    history.unshift(newItem);

    // æœ€å¤§ä»¶æ•°ã‚’è¶…ãˆãŸå ´åˆã¯å‰Šé™¤
    if (history.length > MAX_HISTORY_ITEMS) {
      history.splice(MAX_HISTORY_ITEMS);
    }

    saveSimpleHistory(history);
    updateHistoryTable();
    
    logDebug('å±¥æ­´ã«è¿½åŠ ã—ã¾ã—ãŸ:', newItem);
  } catch (error) {
    logError(error, 'addToSimpleHistory', ERROR_SEVERITY.MEDIUM, ERROR_CATEGORIES.USER_INPUT);
  }
}

/**
 * å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
 */
function clearSimpleHistory() {
  try {
    localStorage.removeItem(HISTORY_STORAGE_KEY);
    updateHistoryTable();
    logDebug('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
  } catch (error) {
    logWarn('å±¥æ­´ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—:', error);
  }
}

/**
 * å±¥æ­´ã‹ã‚‰å¾©å…ƒã™ã‚‹ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
 * @param {string} historyId å±¥æ­´ID
 */
async function restoreFromSimpleHistory(historyId) {
  try {
    const history = getSimpleHistory();
    const selectedItem = history.find(item => item.id === historyId);
    
    if (!selectedItem) {
      showMessage('é¸æŠã•ã‚ŒãŸå±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    const confirmed = confirm('ã€Œ' + selectedItem.questionText + 'ã€ã®è¨­å®šã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\nç¾åœ¨ã®è¨­å®šã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚');
    if (!confirmed) return;

    // è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
    const userId = getUserId();
    if (!userId) {
      showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“', 'error');
      return;
    }

    // configDataã‚’configJsonã¨ã—ã¦ä¿å­˜
    const result = await runGasWithUserId('updateUserConfig', selectedItem.configData);
    
    if (result && result.success) {
      showMessage('å±¥æ­´ã‹ã‚‰è¨­å®šã‚’å¾©å…ƒã—ã¾ã—ãŸ', 'success');
      
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿
      if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
        window.unifiedCache.clear();
      }
      
      // ç®¡ç†ç”»é¢ã‚’å†èª­ã¿è¾¼ã¿
      setTimeout(() => {
        location.reload();
      }, 1000);
      
    } else {
      showMessage('è¨­å®šã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
    
  } catch (error) {
    logError(error, 'restoreFromSimpleHistory', ERROR_SEVERITY.HIGH, ERROR_CATEGORIES.USER_INPUT);
    showMessage('å±¥æ­´ã®å¾©å…ƒä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
  }
}

/**
 * å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
 */
function updateHistoryTable() {
  try {
    const historyTableBody = document.getElementById('history-table-body');
    if (!historyTableBody) return;

    const history = getSimpleHistory();
    
    if (history.length === 0) {
      historyTableBody.innerHTML = '<tr><td colspan="3" class="text-gray-500 text-center py-4">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }

    historyTableBody.innerHTML = history.map(item => {
      const publishedDate = new Date(item.publishedAt).toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      return `
        <tr class="hover:bg-gray-50">
          <td class="py-2 px-3 text-sm">${escapeHtml(item.questionText)}</td>
          <td class="py-2 px-3 text-xs text-gray-500">${publishedDate}</td>
          <td class="py-2 px-3 text-right">
            <button onclick="restoreFromSimpleHistory('${item.id}')" 
                    class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 rounded border border-blue-300 hover:bg-blue-50">
              å¾©å…ƒ
            </button>
          </td>
        </tr>
      `;
    }).join('');
    
  } catch (error) {
    logWarn('å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°ã«å¤±æ•—:', error);
  }
}

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã¯SharedUtilities.htmlã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™

// åˆæœŸåŒ–æ™‚ã«å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
// History table update moved to main DOMContentLoaded handler

// =============================================================================
// äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ - è¤‡é›‘ãªå±¥æ­´ã‚·ã‚¹ãƒ†ãƒ ã¨ã®äº’æ›æ€§ã‚’ç¶­æŒ
// =============================================================================

// äº’æ›æ€§é–¢æ•°: loadSimpleHistoryTable
if (typeof loadSimpleHistoryTable === 'undefined') {
  window.loadSimpleHistoryTable = function() {
    if (typeof updateHistoryTable === 'function') {
      updateHistoryTable();
    } else {
      console.warn('âš ï¸ updateHistoryTableé–¢æ•°ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
    }
  };
}

// äº’æ›æ€§é–¢æ•°: getHistoryFromStorageï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ï¼‰
if (typeof getHistoryFromStorage === 'undefined') {
  window.getHistoryFromStorage = function() {
    return getSimpleHistory();
  };
}

// äº’æ›æ€§é–¢æ•°: saveHistoryToStorageï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ï¼‰
if (typeof saveHistoryToStorage === 'undefined') {
  window.saveHistoryToStorage = function(historyArray) {
    saveSimpleHistory(historyArray);
  };
}

// äº’æ›æ€§é–¢æ•°: saveToHistoryï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ï¼‰
if (typeof saveToHistory === 'undefined') {
  window.saveToHistory = function(historyItem) {
    addToSimpleHistory(historyItem);
  };
}

// HistoryManager ã®äº’æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼
if (!window.HistoryManager) {
  window.HistoryManager = {
    renderTable: function() {
      if (typeof updateHistoryTable === 'function') {
        updateHistoryTable();
      }
      return true;
    },
    addToHistory: function(item) {
      if (typeof addToSimpleHistory === 'function') {
        addToSimpleHistory(item);
      }
    },
    _initialized: true
  };
}

console.log('âœ… å±¥æ­´ã‚·ã‚¹ãƒ†ãƒ ï¼ˆäº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼å«ã‚€ï¼‰åˆæœŸåŒ–å®Œäº†');


/**
 * @fileoverview Admin Panel Simple History Compatibility Layer
 * äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ« - å°†æ¥ã®å±¥æ­´æ©Ÿèƒ½æ‹¡å¼µç”¨
 * 
 * ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ AdminPanel.html ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã¾ã™ãŒã€
 * ç¾åœ¨ã¯ç©ºã®å®Ÿè£…ã¨ã—ã¦æ©Ÿèƒ½ã—ã¦ã„ã¾ã™ã€‚
 * å°†æ¥çš„ã«å±¥æ­´æ©Ÿèƒ½ã®äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¿…è¦ã«ãªã£ãŸå ´åˆã«
 * ã“ã“ã«å®Ÿè£…ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
 */

(function() {
  'use strict';
  
  // å±¥æ­´ã‚·ã‚¹ãƒ†ãƒ ã®äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
  if (typeof window.HistoryManager === 'undefined') {
    console.log('HistoryManager not found, compatibility layer ready for future implementation');
  } else {
    console.log('HistoryManager detected, compatibility layer active');
    
    // å°†æ¥ã®äº’æ›æ€§å®Ÿè£…ç”¨ã®ãƒ•ãƒƒã‚¯
    try {
      if (window.HistoryManager && window.HistoryManager.prototype && 
          typeof window.HistoryManager.prototype.init === 'function') {
        const originalInit = window.HistoryManager.prototype.init;
        window.HistoryManager.prototype.init = function() {
          console.log('HistoryManager init intercepted by compatibility layer');
          return originalInit.apply(this, arguments);
        };
      } else {
        console.log('HistoryManager.prototype.init not available, skipping hook');
      }
    } catch (error) {
      console.warn('Error setting up HistoryManager compatibility hook:', error.message);
    }
  }
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«äº’æ›æ€§ãƒ•ãƒ©ã‚°
  window.HISTORY_COMPAT_LAYER_LOADED = true;
  
})();
</script>


// =============================================================================
// ADMIN PANEL HTML INTEGRATION - Extracted JavaScript Sections
// =============================================================================

// Section 1: Initialization and Utility Functions
// Simple initialization system for GAS environment
window.onerror = function(message, source, lineno, colno, error) { 
  // Suppress specific syntax errors that don't affect functionality
  if (message && message.includes('Unexpected end of input')) {
    return true; // Suppress this specific error
  }
  return true; // Suppress all errors for stability
};
window.onunhandledrejection = function() { return true; };

// Debug mode setting
const __DEBUG_MODE_RAW__ = '<?= escapeJavaScript(shouldEnableDebugMode()) ?>';
window.DEBUG_MODE = (__DEBUG_MODE_RAW__ === 'true' || __DEBUG_MODE_RAW__ === true);

// Minimal log suppression for production
if (!window.DEBUG_MODE) {
  const originalLog = console.log;
  console.log = function(...args) {
    const msg = args.join(' ');
    if (msg.match(/[âœ…ğŸ”§ğŸ›¡ï¸ğŸ”ğŸ‰ğŸ“ğŸ”ğŸš€ğŸ”„]/)) return; // Suppress emoji logs
    if (msg.includes('loaded successfully') || msg.includes('initialized')) return;
    originalLog.apply(console, args);
  };
}

// =============================================================================
// UTILITY FUNCTIONS - Core UI Interactions
// =============================================================================
// Duplicate toggleSection function removed - using class method instead

function copyBoardUrl(button) {
  const urlInput = document.getElementById('board-url');
  if (!urlInput || !urlInput.value) {
    logError('Board URL not found or empty');
    return;
  }
  
  urlInput.select();
  urlInput.setSelectionRange(0, 99999); // For mobile
  
  try {
    document.execCommand('copy');
    // Visual feedback
    const originalText = button.innerHTML;
    button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
    setTimeout(() => {
      button.innerHTML = originalText;
    }, 1500);
    logInfo('âœ… URL copied to clipboard');
  } catch (err) {
    logError('Failed to copy URL:', err);
  }
}

function showSecurityInfo() {
  if (window.sharedModals && window.sharedModals.showSecurityModal) {
    window.sharedModals.showSecurityModal();
  } else {
    logInfo('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±: naha-okinawa.ed.jp ãƒ‰ãƒ¡ã‚¤ãƒ³å°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ');
  }
}

function showGoogleIntegrationInfo() {
  if (window.sharedModals && window.sharedModals.showGoogleIntegrationModal) {
    window.sharedModals.showGoogleIntegrationModal();
  } else {
    logInfo('Googleé€£æº: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨ãƒ•ã‚©ãƒ¼ãƒ ã®è‡ªå‹•ä½œæˆãƒ»ç®¡ç†');
  }
}

window.adminPanel = window.adminPanel || {};
window.adminPanel.logoutAndRedirect = function() {
  if (confirm('ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
    const webAppUrl = getWebAppUrl?.() || ScriptApp?.getService()?.getUrl() || window.location.origin;
    window.location.href = webAppUrl + '?mode=login';
  }
};

// Legacy function stubs for compatibility
window.openAppSetupPage = window.openAppSetupPage || function() { 
  logInfo('ã‚¢ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™');
};
window.runHeaderGuessing = function() {
  logInfo('ğŸ¤– AIåˆ—åˆ¤å®šã‚’å®Ÿè¡Œä¸­...');
  AdminPanel_callGAS('autoMapHeaders', window.AdminPanel.currentUserId, window.AdminPanel.currentSpreadsheetId, document.getElementById('sheet-select').value)
    .then(response => {
      if (response && response.success) {
        logInfo('âœ… AIåˆ¤å®šå®Œäº†: åˆ—è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        populateColumnSelects(response.headers);
      } else {
        logError('AIåˆ¤å®šã«å¤±æ•—ã—ã¾ã—ãŸ:', response?.message);
      }
    })
    .catch(error => logError('AIåˆ¤å®šã‚¨ãƒ©ãƒ¼:', error));
};
window.addResource = function() { 
  logInfo('ãƒªã‚½ãƒ¼ã‚¹è¿½åŠ æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™');
};
window.initializeUserSettingsWithUI = window.initializeUserSettingsWithUI || function() { 
  console.warn('initializeUserSettingsWithUI function not yet loaded'); 
};

// Section 2: System Admin and Core Functions
const __IS_SYSTEM_ADMIN_RAW__ = '<?= escapeJavaScript(typeof isDeployUser !== "undefined" ? isDeployUser : "false") ?>';
const __IS_SYSTEM_ADMIN__ = __IS_SYSTEM_ADMIN_RAW__ === 'true' || __IS_SYSTEM_ADMIN_RAW__ === true;
window.isSystemAdmin = __IS_SYSTEM_ADMIN__;

// AdminPanel namespace already initialized at the top of file - removing duplicate

// Section 3: Modal Initialization
// ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆæœŸåŒ–
// Modal initialization and app setup moved to main initialization

</script>
