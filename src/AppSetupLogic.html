<script>
/* =============================================================================
   StudyQuest - App Setup Page Logic
   Extracted from AppSetupPage.html for better maintainability
   Handles app configuration, user management, and deletion logs
   ============================================================================= */

// =============================================================================
// APP SETUP STATE MANAGEMENT
// =============================================================================

let currentUserInfo = null;
let setupInProgress = false;
let userManagementVisible = false;
let currentUserList = [];
let userToDelete = null;

// =============================================================================
// APP STATUS MANAGEMENT
// =============================================================================

/**
 * Load and display current app status
 */
function loadCurrentStatus() {
  if (window.sharedUtilities && window.sharedUtilities.gas) {
    window.sharedUtilities.gas.call(
      'getCurrentUserStatus',
      function(result) {
        if (result.status === 'success') {
          currentUserInfo = result.userInfo;
          updateStatusDisplay(result.userInfo);
          enableControls();
        } else {
          if (window.sharedUtilities.message) {
            window.sharedUtilities.message.show(`ステータス取得に失敗しました: ${result.message}`, 'error');
          }
        }
      },
      function(error) {
        if (window.sharedUtilities.message) {
          window.sharedUtilities.message.show(`ステータス取得エラー: ${error.message || error}`, 'error');
        }
      },
      [__USER_ID__],
      'ステータス取得'
    );
  } else {
    // Fallback to direct GAS call
    google.script.run
      .withSuccessHandler((result) => {
        if (result.status === 'success') {
          currentUserInfo = result.userInfo;
          updateStatusDisplay(result.userInfo);
          enableControls();
        } else {
          showMessage(`ステータス取得に失敗しました: ${result.message}`, 'error');
        }
      })
      .withFailureHandler((error) => {
        showMessage(`ステータス取得エラー: ${error.message || error}`, 'error');
      })
      .getCurrentUserStatus(__USER_ID__);
  }
}

/**
 * Update status display with user information
 * @param {Object} userInfo - User information object
 */
function updateStatusDisplay(userInfo) {
  const isActive = userInfo.isActive === true || String(userInfo.isActive).toLowerCase() === 'true';
  
  if (window.sharedUtilities && window.sharedUtilities.dom) {
    const statusHtml = isActive 
      ? '<span class="bg-green-600 text-green-100 px-3 py-1 rounded-full">🟢 アクティブ</span>'
      : '<span class="bg-red-600 text-red-100 px-3 py-1 rounded-full">🔴 非アクティブ</span>';
    
    window.sharedUtilities.dom.updateSafely('current-status', statusHtml, 'html');
    window.sharedUtilities.dom.updateSafely('current-admin', userInfo.adminEmail || '不明', 'text');
    
    const lastUpdated = userInfo.lastAccessedAt 
      ? new Date(userInfo.lastAccessedAt).toLocaleString('ja-JP')
      : '不明';
    window.sharedUtilities.dom.updateSafely('last-updated', lastUpdated, 'text');
  } else {
    // Fallback for direct DOM manipulation
    const statusElement = document.getElementById('current-status');
    const adminElement = document.getElementById('current-admin');
    const lastUpdatedElement = document.getElementById('last-updated');

    if (statusElement) {
      statusElement.innerHTML = isActive 
        ? '<span class="bg-green-600 text-green-100 px-3 py-1 rounded-full">🟢 アクティブ</span>'
        : '<span class="bg-red-600 text-red-100 px-3 py-1 rounded-full">🔴 非アクティブ</span>';
    }

    if (adminElement) adminElement.textContent = userInfo.adminEmail || '不明';
    if (lastUpdatedElement) {
      lastUpdatedElement.textContent = userInfo.lastAccessedAt 
        ? new Date(userInfo.lastAccessedAt).toLocaleString('ja-JP')
        : '不明';
    }
  }

  // Set toggle state
  const toggleElement = document.getElementById('isActiveToggle');
  if (toggleElement) toggleElement.checked = isActive;
}

/**
 * Enable control elements and setup event handlers
 */
function enableControls() {
  const toggleElement = document.getElementById('isActiveToggle');
  const updateBtn = document.getElementById('updateStatusBtn');
  
  if (toggleElement) toggleElement.disabled = false;
  if (updateBtn) updateBtn.disabled = false;

  // Setup toggle change event handler
  if (toggleElement) {
    toggleElement.addEventListener('change', function() {
      const newStatus = this.checked;
      const confirmMessage = newStatus 
        ? 'アプリを有効化しますか？ユーザーがアクセスできるようになります。'
        : 'アプリを無効化しますか？ユーザーのアクセスが制限されます。';
      
      if (confirm(confirmMessage)) {
        updateIsActiveStatus(newStatus);
      } else {
        // Cancel - revert toggle
        this.checked = !newStatus;
      }
    });
  }
}

/**
 * Update isActive status via server call
 * @param {boolean} isActive - New active status
 */
function updateIsActiveStatus(isActive) {
  if (setupInProgress) return;
  setupInProgress = true;

  const updateBtn = document.getElementById('updateStatusBtn');
  const updateText = document.getElementById('update-text');
  const updateSpinner = document.getElementById('update-spinner');
  
  try {
    // Update button state
    if (updateBtn) updateBtn.disabled = true;
    if (updateText) updateText.style.display = 'none';
    if (updateSpinner) updateSpinner.classList.remove('hidden');
    
    const message = isActive ? 'アプリを有効化中...' : 'アプリを無効化中...';
    if (window.sharedUtilities && window.sharedUtilities.message) {
      window.sharedUtilities.message.show(message, 'info');
    } else {
      showMessage(message, 'info');
    }
    
    if (window.sharedUtilities && window.sharedUtilities.gas) {
      window.sharedUtilities.gas.call(
        'updateIsActiveStatus',
        function(result) {
          if (result.status === 'success') {
            if (window.sharedUtilities.message) {
              window.sharedUtilities.message.show(`✅ ${result.message}`, 'success');
            }
            // Reload status
            loadCurrentStatus();
          } else {
            if (window.sharedUtilities.message) {
              window.sharedUtilities.message.show(`❌ ${result.message}`, 'error');
            }
          }
        },
        function(error) {
          console.error('Update error:', error);
          if (window.sharedUtilities.message) {
            window.sharedUtilities.message.show(`❌ 更新に失敗しました: ${error.message || error}`, 'error');
          }
        },
        [__USER_ID__, isActive],
        'ステータス更新'
      );
    } else {
      // Fallback to direct GAS call
      google.script.run
        .withSuccessHandler((result) => {
          if (result.status === 'success') {
            showMessage(`✅ ${result.message}`, 'success');
            loadCurrentStatus();
          } else {
            showMessage(`❌ ${result.message}`, 'error');
          }
        })
        .withFailureHandler((error) => {
          console.error('Update error:', error);
          showMessage(`❌ 更新に失敗しました: ${error.message || error}`, 'error');
        })
        .updateIsActiveStatus(__USER_ID__, isActive);
    }
        
  } catch (error) {
    if (window.sharedUtilities && window.sharedUtilities.message) {
      window.sharedUtilities.message.show(`❌ ${error.message}`, 'error');
    } else {
      showMessage(`❌ ${error.message}`, 'error');
    }
  } finally {
    // Reset button state
    setTimeout(() => {
      if (updateBtn) updateBtn.disabled = false;
      if (updateText) updateText.style.display = 'inline';
      if (updateSpinner) updateSpinner.classList.add('hidden');
      setupInProgress = false;
    }, 1000);
  }
}

// =============================================================================
// USER MANAGEMENT FUNCTIONS
// =============================================================================

/**
 * Toggle user management section visibility
 */
function toggleUserManagement() {
  const container = document.getElementById('user-list-container');
  const btn = document.getElementById('manage-users-btn');
  
  if (userManagementVisible) {
    if (container) container.classList.add('hidden');
    if (btn) btn.textContent = '👥 ユーザー管理を開く';
    userManagementVisible = false;
  } else {
    if (container) container.classList.remove('hidden');
    if (btn) btn.textContent = '👥 ユーザー管理を閉じる';
    userManagementVisible = true;
    loadUserList();
  }
}

/**
 * Load and display user list
 */
function loadUserList() {
  const loadingDiv = document.getElementById('user-loading');
  const contentDiv = document.getElementById('user-table-content');
  
  if (loadingDiv) loadingDiv.classList.remove('hidden');
  if (contentDiv) contentDiv.classList.add('hidden');
  
  if (window.sharedUtilities && window.sharedUtilities.gas) {
    window.sharedUtilities.gas.call(
      'getAllUsersForAdminForUI',
      function(result) {
        if (result.status === 'success') {
          currentUserList = result.users;
          displayUserList(result.users);
        } else {
          if (window.sharedUtilities.message) {
            window.sharedUtilities.message.show(`ユーザー一覧の取得に失敗しました: ${result.message}`, 'error');
          }
        }
        if (loadingDiv) loadingDiv.classList.add('hidden');
      },
      function(error) {
        if (window.sharedUtilities.message) {
          window.sharedUtilities.message.show(`エラー: ${error.message || error}`, 'error');
        }
        if (loadingDiv) loadingDiv.classList.add('hidden');
      },
      [__USER_ID__],
      'ユーザー一覧取得'
    );
  } else {
    // Fallback to direct GAS call
    google.script.run
      .withSuccessHandler((result) => {
        if (result.status === 'success') {
          currentUserList = result.users;
          displayUserList(result.users);
        } else {
          showMessage(`ユーザー一覧の取得に失敗しました: ${result.message}`, 'error');
        }
        if (loadingDiv) loadingDiv.classList.add('hidden');
      })
      .withFailureHandler((error) => {
        showMessage(`エラー: ${error.message || error}`, 'error');
        if (loadingDiv) loadingDiv.classList.add('hidden');
      })
      .getAllUsersForAdminForUI(__USER_ID__);
  }
}

/**
 * Display user list in table format
 * @param {Array} users - Array of user objects
 */
function displayUserList(users) {
  const tableBody = document.getElementById('user-table-body');
  const contentDiv = document.getElementById('user-table-content');
  
  if (!tableBody) return;
  
  if (users.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="5" class="px-4 py-8 text-center text-gray-400">
          登録ユーザーが見つかりません
        </td>
      </tr>
    `;
  } else {
    tableBody.innerHTML = users.map(user => {
      const isActive = user.isActive === true || String(user.isActive).toLowerCase() === 'true';
      const statusBadge = isActive 
        ? '<span class="px-2 py-1 bg-green-600 text-green-100 rounded-full text-xs">アクティブ</span>'
        : '<span class="px-2 py-1 bg-red-600 text-red-100 rounded-full text-xs">非アクティブ</span>';
      
      const lastAccess = user.lastAccessedAt 
        ? new Date(user.lastAccessedAt).toLocaleDateString('ja-JP')
        : '不明';
      
      const registrationDate = user.createdAt 
        ? new Date(user.createdAt).toLocaleDateString('ja-JP')
        : '不明';
      
      return `
        <tr class="hover:bg-gray-700/50">
          <td class="px-4 py-3 text-sm text-white">${user.adminEmail}</td>
          <td class="px-4 py-3 text-sm text-gray-300">${registrationDate}</td>
          <td class="px-4 py-3">${statusBadge}</td>
          <td class="px-4 py-3 text-sm text-gray-300">${lastAccess}</td>
          <td class="px-4 py-3 text-center">
            <button 
              onclick="showDeleteConfirmation('${user.userId}', '${user.adminEmail}')"
              class="btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
              削除
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }
  
  if (contentDiv) contentDiv.classList.remove('hidden');
}

/**
 * Show user deletion confirmation modal
 * @param {string} userId - User ID to delete
 * @param {string} userEmail - User email for display
 */
function showDeleteConfirmation(userId, userEmail) {
  userToDelete = { userId, userEmail };
  
  if (window.sharedUtilities && window.sharedUtilities.dom) {
    window.sharedUtilities.dom.updateSafely('delete-user-email', userEmail, 'text');
    window.sharedUtilities.dom.updateSafely('delete-user-id', `ID: ${userId}`, 'text');
    window.sharedUtilities.dom.updateSafely('deletion-reason', '', 'value');
  } else {
    const emailEl = document.getElementById('delete-user-email');
    const idEl = document.getElementById('delete-user-id');
    const reasonEl = document.getElementById('deletion-reason');
    
    if (emailEl) emailEl.textContent = userEmail;
    if (idEl) idEl.textContent = `ID: ${userId}`;
    if (reasonEl) reasonEl.value = '';
  }
  
  const modal = document.getElementById('delete-modal');
  if (modal) modal.classList.remove('hidden');
}

/**
 * Cancel user deletion
 */
function cancelDeletion() {
  userToDelete = null;
  const modal = document.getElementById('delete-modal');
  if (modal) modal.classList.add('hidden');
}

/**
 * Confirm and execute user deletion
 */
function confirmDeletion() {
  if (!userToDelete) return;
  
  const reasonEl = document.getElementById('deletion-reason');
  const reason = reasonEl ? reasonEl.value.trim() : '';
  
  if (!reason) {
    if (window.sharedUtilities && window.sharedUtilities.message) {
      window.sharedUtilities.message.show('削除理由を入力してください', 'warning');
    } else {
      showMessage('削除理由を入力してください', 'warning');
    }
    return;
  }
  
  const confirmBtn = document.getElementById('confirm-delete-btn');
  if (confirmBtn) {
    confirmBtn.disabled = true;
    confirmBtn.textContent = '削除中...';
  }
  
  if (window.sharedUtilities && window.sharedUtilities.gas) {
    window.sharedUtilities.gas.call(
      'deleteUserAccountByAdminForUI',
      function(result) {
        if (result.status === 'success') {
          if (window.sharedUtilities.message) {
            window.sharedUtilities.message.show(`✅ ${result.message}`, 'success');
          }
          cancelDeletion();
          loadUserList(); // Reload user list
        } else {
          if (window.sharedUtilities.message) {
            window.sharedUtilities.message.show(`❌ ${result.message}`, 'error');
          }
        }
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.textContent = '削除実行';
        }
      },
      function(error) {
        if (window.sharedUtilities.message) {
          window.sharedUtilities.message.show(`❌ 削除に失敗しました: ${error.message || error}`, 'error');
        }
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.textContent = '削除実行';
        }
      },
      [__USER_ID__, userToDelete.userId, reason],
      'ユーザー削除'
    );
  } else {
    // Fallback to direct GAS call
    google.script.run
      .withSuccessHandler((result) => {
        if (result.status === 'success') {
          showMessage(`✅ ${result.message}`, 'success');
          cancelDeletion();
          loadUserList();
        } else {
          showMessage(`❌ ${result.message}`, 'error');
        }
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.textContent = '削除実行';
        }
      })
      .withFailureHandler((error) => {
        showMessage(`❌ 削除に失敗しました: ${error.message || error}`, 'error');
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.textContent = '削除実行';
        }
      })
      .deleteUserAccountByAdminForUI(__USER_ID__, userToDelete.userId, reason);
  }
}

// =============================================================================
// DELETION LOGS MANAGEMENT
// =============================================================================

/**
 * View deletion logs in modal
 */
function viewDeletionLogs() {
  const modal = document.getElementById('logs-modal');
  const loadingDiv = document.getElementById('logs-loading');
  const contentDiv = document.getElementById('logs-table-content');
  
  if (modal) modal.classList.remove('hidden');
  if (loadingDiv) loadingDiv.classList.remove('hidden');
  if (contentDiv) contentDiv.classList.add('hidden');
  
  if (window.sharedUtilities && window.sharedUtilities.gas) {
    window.sharedUtilities.gas.call(
      'getDeletionLogsForUI',
      function(result) {
        if (result.status === 'success') {
          displayDeletionLogs(result.logs);
        } else {
          if (window.sharedUtilities.message) {
            window.sharedUtilities.message.show(`ログの取得に失敗しました: ${result.message}`, 'error');
          }
        }
        if (loadingDiv) loadingDiv.classList.add('hidden');
      },
      function(error) {
        if (window.sharedUtilities.message) {
          window.sharedUtilities.message.show(`エラー: ${error.message || error}`, 'error');
        }
        if (loadingDiv) loadingDiv.classList.add('hidden');
      },
      [__USER_ID__],
      '削除ログ取得'
    );
  } else {
    // Fallback to direct GAS call
    google.script.run
      .withSuccessHandler((result) => {
        if (result.status === 'success') {
          displayDeletionLogs(result.logs);
        } else {
          showMessage(`ログの取得に失敗しました: ${result.message}`, 'error');
        }
        if (loadingDiv) loadingDiv.classList.add('hidden');
      })
      .withFailureHandler((error) => {
        showMessage(`エラー: ${error.message || error}`, 'error');
        if (loadingDiv) loadingDiv.classList.add('hidden');
      })
      .getDeletionLogsForUI(__USER_ID__);
  }
}

/**
 * Display deletion logs in table format
 * @param {Array} logs - Array of deletion log objects
 */
function displayDeletionLogs(logs) {
  const tableBody = document.getElementById('logs-table-body');
  const contentDiv = document.getElementById('logs-table-content');
  
  if (!tableBody) return;
  
  if (logs.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="5" class="px-4 py-8 text-center text-gray-400">
          削除ログが見つかりません
        </td>
      </tr>
    `;
  } else {
    tableBody.innerHTML = logs.map(log => {
      const deleteDate = new Date(log.timestamp).toLocaleString('ja-JP');
      const typeColor = log.deleteType === 'admin' ? 'text-red-400' : 'text-blue-400';
      const typeText = log.deleteType === 'admin' ? '管理者削除' : '自己削除';
      
      return `
        <tr class="hover:bg-gray-700/50">
          <td class="px-4 py-3 text-sm text-gray-300">${deleteDate}</td>
          <td class="px-4 py-3 text-sm text-white">${log.executorEmail}</td>
          <td class="px-4 py-3 text-sm text-cyan-400">${log.targetEmail}</td>
          <td class="px-4 py-3 text-sm text-gray-300">${log.reason || '理由なし'}</td>
          <td class="px-4 py-3 text-sm ${typeColor}">${typeText}</td>
        </tr>
      `;
    }).join('');
  }
  
  if (contentDiv) contentDiv.classList.remove('hidden');
}

/**
 * Close deletion logs modal
 */
function closeDeletionLogs() {
  const modal = document.getElementById('logs-modal');
  if (modal) modal.classList.add('hidden');
}

// =============================================================================
// NAVIGATION FUNCTIONS
// =============================================================================

/**
 * Navigate back to admin panel
 */
function goBackToAdminPanel() {
  if (window.sharedUtilities && window.sharedUtilities.gas) {
    window.sharedUtilities.gas.call(
      'getWebAppUrlCached',
      function(webAppUrl) {
        const targetUrl = webAppUrl + '?mode=admin&userId=' + __USER_ID__;
        
        if (window.sharedUtilities.navigation) {
          window.sharedUtilities.navigation.safeNavigate(targetUrl, {
            fallbackMessage: '管理パネルに移動中...',
            method: 'auto'
          });
        }
      },
      function(error) {
        console.error('WebApp URL取得エラー:', error);
        // Fallback: use current URL
        const currentUrl = window.location.href.split('?')[0];
        const targetUrl = currentUrl + '?mode=admin&userId=' + __USER_ID__;
        
        if (window.sharedUtilities && window.sharedUtilities.navigation) {
          window.sharedUtilities.navigation.safeNavigate(targetUrl, {
            fallbackMessage: '管理パネルに移動中...',
            method: 'auto'
          });
        }
      },
      [],
      'URL取得'
    );
  } else {
    // Fallback to direct GAS call
    google.script.run
      .withSuccessHandler((webAppUrl) => {
        const targetUrl = webAppUrl + '?mode=admin&userId=' + __USER_ID__;
        
        if (window.sharedUtilities && window.sharedUtilities.navigation) {
          window.sharedUtilities.navigation.safeNavigate(targetUrl, {
            fallbackMessage: '管理パネルに移動中...',
            method: 'auto'
          });
        } else {
          // Legacy navigation
          try {
            window.location.href = targetUrl;
          } catch (e) {
            window.open(targetUrl, '_blank');
          }
        }
      })
      .withFailureHandler((error) => {
        console.error('WebApp URL取得エラー:', error);
        const currentUrl = window.location.href.split('?')[0];
        const targetUrl = currentUrl + '?mode=admin&userId=' + __USER_ID__;
        
        if (window.sharedUtilities && window.sharedUtilities.navigation) {
          window.sharedUtilities.navigation.safeNavigate(targetUrl, {
            fallbackMessage: '管理パネルに移動中...',
            method: 'auto'
          });
        } else {
          try {
            window.location.href = targetUrl;
          } catch (e) {
            window.open(targetUrl, '_blank');
          }
        }
      })
      .getWebAppUrlCached();
  }
}

// =============================================================================
// BACKWARD COMPATIBILITY FUNCTIONS
// =============================================================================

/**
 * Legacy message display function for backward compatibility
 * @param {string} message - Message to display
 * @param {string} type - Message type
 */
function showMessage(message, type = 'info') {
  if (window.sharedUtilities && window.sharedUtilities.message) {
    window.sharedUtilities.message.show(message, type);
    return;
  }
  
  // Fallback for legacy support
  const messageArea = document.getElementById('message-area');
  if (!messageArea) return;
  
  const colors = {
    success: 'bg-green-600/20 border-green-500/50 text-green-100',
    error: 'bg-red-600/20 border-red-500/50 text-red-100',
    warning: 'bg-yellow-600/20 border-yellow-500/50 text-yellow-100',
    info: 'bg-blue-600/20 border-blue-500/50 text-blue-100'
  };
  
  const icons = {
    success: '✅',
    error: '❌',
    warning: '⚠️',
    info: 'ℹ️'
  };
  
  messageArea.innerHTML = `
    <div class="message show glass-panel rounded-lg p-4 border ${colors[type]}">
      <div class="flex items-center">
        <div class="mr-3">${icons[type]}</div>
        <div class="flex-1">${message}</div>
        <button onclick="this.closest('.message').style.display='none'" class="ml-4 text-gray-400 hover:text-white">✕</button>
      </div>
    </div>
  `;
}

// =============================================================================
// INITIALIZATION
// =============================================================================

/**
 * Initialize app setup page functionality
 */
function initializeAppSetupPage() {
  console.log('🔧 Initializing App Setup Page Logic...');
  
  // Load current status on page load
  loadCurrentStatus();
  
  console.log('✅ App Setup Page Logic initialized');
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeAppSetupPage);
} else {
  initializeAppSetupPage();
}

// =============================================================================
// EXPORT TO GLOBAL SCOPE
// =============================================================================

// Export app setup utilities to global scope
window.appSetupUtilities = {
  state: {
    currentUserInfo: () => currentUserInfo,
    setupInProgress: () => setupInProgress,
    userManagementVisible: () => userManagementVisible
  },
  status: {
    load: loadCurrentStatus,
    update: updateStatusDisplay,
    updateActive: updateIsActiveStatus
  },
  users: {
    toggle: toggleUserManagement,
    load: loadUserList,
    display: displayUserList,
    showDelete: showDeleteConfirmation,
    cancelDelete: cancelDeletion,
    confirmDelete: confirmDeletion
  },
  logs: {
    view: viewDeletionLogs,
    display: displayDeletionLogs,
    close: closeDeletionLogs
  },
  navigation: {
    goBackToAdminPanel: goBackToAdminPanel
  },
  legacy: {
    showMessage: showMessage
  }
};

</script>