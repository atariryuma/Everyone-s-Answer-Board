<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <base target="_top" />
    <title>ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰ - ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ä¸­</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Optimized Permissions Policy - essential permissions only -->
    <!-- Shared Security Headers -->
    <?!= include('SharedSecurityHeaders'); ?>

    <!-- TailwindCSS Optimized Loading - highest priority, no warnings -->
    <script>
      // Complete TailwindCSS warning suppression and early configuration
      window.__TAILWIND_DISABLE_TOUCH__ = true;
      window.tailwind = {
        config: {
          corePlugins: { preflight: false },
          important: true,
        },
      };

      // Suppress TailwindCSS production warnings immediately
      const originalWarn = console.warn;
      console.warn = function (...args) {
        const message = args.join(' ');
        if (
          message.includes('cdn.tailwindcss.com should not be used in production') ||
          message.includes('cdnjs.cloudflare.com') ||
          message.includes('tailwind') ||
          message.includes('TailwindCSS')
        ) {
          return; // Completely suppress
        }
        originalWarn.apply(console, args);
      };
    </script>
    <!-- Shared TailwindCSS Configuration -->
    <?!= include('SharedTailwindConfig'); ?>

    <!-- Shared Styles and Utilities -->
    <?!= include('UnifiedStyles.css'); ?>
    <style>
      .pulse-slow {
        animation: pulse 2s infinite;
      }
      .fade-in {
        animation: fadeIn 0.8s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .restriction-notice {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
        border: 1px solid rgba(239, 68, 68, 0.3);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
      }
      .scenario-message {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1) 0%,
          rgba(37, 99, 235, 0.1) 100%
        );
        border: 1px solid rgba(59, 130, 246, 0.3);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
      }
    </style>
  </head>
  <body style="background: var(--brand-background); color: var(--brand-text);" class="font-sans min-h-screen flex items-center justify-center">
    <!-- Notification Container for unified notification system -->
    <div id="notification-container" class="fixed top-4 right-4 z-[10000] space-y-2"></div>
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <div class="text-center fade-in">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div class="glass-panel rounded-2xl p-8 shadow-2xl mb-8">
          <div class="mb-6">
            <div
              class="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-r from-red-500/20 to-orange-500/20 flex items-center justify-center border-2 border-red-400/30 pulse-slow"
            >
              <span id="restriction-warning-icon" class="text-red-400"></span>
            </div>
            <h1 class="text-3xl font-bold mb-2 text-red-300">ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™</h1>
            <p class="text-gray-400 text-lg">ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“</p>
          </div>

          <? if (typeof userEmail !== 'undefined' && userEmail) { ?>
          <div class="mb-6 p-3 bg-gray-700/50 rounded-lg">
            <p class="text-sm text-gray-300">
              ãƒ¦ãƒ¼ã‚¶ãƒ¼: <span class="text-cyan-400 font-medium"><?= userEmail ?></span>
            </p>
          </div>
          <? } ?>

          <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ± -->
          <div class="grid md:grid-cols-2 gap-4 mb-8">
            <div class="bg-gray-700/30 rounded-lg p-4">
              <div class="flex items-center gap-2 mb-2">
                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                <span class="text-sm font-medium">ã‚¢ã‚¯ã‚»ã‚¹çŠ¶æ…‹</span>
              </div>
              <p class="text-gray-400 text-sm">åˆ¶é™ä¸­ï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ï¼‰</p>
            </div>
            <div class="bg-gray-700/30 rounded-lg p-4">
              <div class="flex items-center gap-2 mb-2">
                <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                <span class="text-sm font-medium">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</span>
              </div>
              <p class="text-gray-400 text-sm">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ä¸­</p>
            </div>
          </div>
        </div>

        <!-- ã‚·ãƒŠãƒªã‚ªåˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="scenario-message rounded-2xl p-6 mb-6">
          <h2 class="text-xl font-bold mb-4 text-blue-300 flex items-center justify-center gap-2">
            <span id="info-icon" class="text-blue-300"></span>
            ã”æ¡ˆå†…
          </h2>

          <div class="space-y-4 text-left">
            <!-- ä¸€æ™‚çš„ãªåœæ­¢ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ -->
            <div class="bg-gray-700/30 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-yellow-300 mb-2">ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹</h3>
              <p class="text-gray-300 text-sm">
                ã‚·ã‚¹ãƒ†ãƒ ã®æ”¹å–„ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ãŸã‚ã€ä¸€æ™‚çš„ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã—ã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                é€šå¸¸ã¯çŸ­æ™‚é–“ã§å¾©æ—§ã„ãŸã—ã¾ã™ã€‚
              </p>
            </div>

            <!-- ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– -->
            <div class="bg-gray-700/30 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-purple-300 mb-2">ğŸ“¦ ã‚·ã‚¹ãƒ†ãƒ çµ‚äº†</h3>
              <p class="text-gray-300 text-sm">
                ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯é‹ç”¨æœŸé–“ãŒçµ‚äº†ã—ã€ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚Œã¾ã—ãŸã€‚
                æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ã®æ¡ˆå†…ã«ã¤ã„ã¦ã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
              </p>
            </div>

            <!-- é•åå¯¾å¿œ -->
            <div class="bg-gray-700/30 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-red-300 mb-2">âš ï¸ åˆ©ç”¨è¦ç´„é•å</h3>
              <p class="text-gray-300 text-sm">
                åˆ©ç”¨è¦ç´„ã«é•åã™ã‚‹è¡Œç‚ºãŒç¢ºèªã•ã‚ŒãŸãŸã‚ã€ä¸€æ™‚çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ã¦ã„ã¾ã™ã€‚
                è©³ç´°ã«ã¤ã„ã¦ã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
              </p>
            </div>

            <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç®¡ç† -->
            <div class="bg-gray-700/30 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-cyan-300 mb-2">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®šä¸­</h3>
              <p class="text-gray-300 text-sm">
                æ–°ã—ã„æ©Ÿèƒ½ã®è¿½åŠ ã‚„ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®å¤‰æ›´ä½œæ¥­ä¸­ã®ãŸã‚ã€ä¸€æ™‚çš„ã«åˆ©ç”¨ã‚’åœæ­¢ã—ã¦ã„ã¾ã™ã€‚
                è¨­å®šå®Œäº†å¾Œã€è‡ªå‹•çš„ã«åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
              </p>
            </div>
          </div>
        </div>

        <!-- ç®¡ç†è€…å‘ã‘æƒ…å ± -->
        <? if (typeof isAdministrator !== 'undefined' && isAdministrator) { ?>
        <div class="restriction-notice rounded-2xl p-6">
          <h3
            class="text-lg font-semibold text-orange-300 mb-3 flex items-center justify-center gap-2"
          >
            <span id="admin-lock-icon" class="text-orange-300"></span>
            ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…æƒ…å ±
          </h3>
          <div class="bg-gray-700/50 rounded-lg p-4">
            <p class="text-sm text-gray-300 mb-3">
              ã‚ãªãŸã¯ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
            </p>
            <div class="text-center">
              <a
                href="#"
                id="app-setup-link"
                class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-semibold rounded-xl transition-all transform hover:scale-105 shadow-lg"
              >
                <span id="settings-gear-icon"></span>
                ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã¸
              </a>
            </div>
          </div>
        </div>
        <? } ?>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼æƒ…å ± -->
        <div class="mt-8 text-center">
          <p class="text-xs text-gray-500">
            ã¿ã‚“ãªã®å›ç­”ãƒœãƒ¼ãƒ‰ <? if (typeof timestamp !== 'undefined' && timestamp) { ?>
            <br />ç¢ºèªæ™‚åˆ»: <?= timestamp ?> <? } ?>
          </p>
        </div>
      </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
    <div id="message-area" class="fixed top-20 right-4 z-50" aria-live="polite" role="status"></div>

    <!-- GASæ¨å¥¨: JavaScriptèª­ã¿è¾¼ã¿ã¯</body>ç›´å‰ã«é›†ç´„ -->
    <?!= include('SharedUtilities'); ?>
    <?!= include('SharedErrorHandling'); ?>

    <script>
      // ğŸ¯ çµ±ä¸€ã‚¢ã‚¤ã‚³ãƒ³ã‚·ã‚¹ãƒ†ãƒ  - ã‚¢ã‚¤ã‚³ãƒ³é…ç½®
      function initializeAccessRestrictedIcons() {
        if (typeof window.IconLibrary !== 'undefined') {
          // åˆ¶é™è­¦å‘Šã‚¢ã‚¤ã‚³ãƒ³
          const restrictionWarningIcon = document.getElementById('restriction-warning-icon');
          if (restrictionWarningIcon) {
            restrictionWarningIcon.innerHTML = window.IconLibrary.get('alert-triangle', {size: 'w-12 h-12'});
          }

          // æƒ…å ±ã‚¢ã‚¤ã‚³ãƒ³
          const infoIcon = document.getElementById('info-icon');
          if (infoIcon) {
            infoIcon.innerHTML = window.IconLibrary.get('info', {size: 'w-6 h-6'});
          }

          // ç®¡ç†è€…ãƒ­ãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³
          const adminLockIcon = document.getElementById('admin-lock-icon');
          if (adminLockIcon) {
            adminLockIcon.innerHTML = window.IconLibrary.get('lock', {size: 'w-5 h-5'});
          }

          // è¨­å®šæ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³
          const settingsGearIcon = document.getElementById('settings-gear-icon');
          if (settingsGearIcon) {
            settingsGearIcon.innerHTML = window.IconLibrary.get('settings', {size: 'w-5 h-5'});
          }
        }
      }

      // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã¨IconLibraryèª­ã¿è¾¼ã¿å®Œäº†å¾Œã®ä¸¡æ–¹ã§åˆæœŸåŒ–
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeAccessRestrictedIcons);
      } else {
        initializeAccessRestrictedIcons();
      }

      // CLAUDE.md V8 compliant: requestIdleCallback for icon initialization
      requestIdleCallback(initializeAccessRestrictedIcons, { timeout: 100 });

      // ã‚¢ãƒ—ãƒªè¨­å®šãƒªãƒ³ã‚¯ã®å‹•çš„URLç”Ÿæˆï¼ˆæœ¬ç•ªURLã‚’å–å¾—ã—ã¦ç”Ÿæˆï¼‰
      document.addEventListener('DOMContentLoaded', function() {
        const appSetupLink = document.getElementById('app-setup-link');
        if (!appSetupLink) return;

        // Web ã‚¢ãƒ—ãƒªã®æœ¬ç•ªURLã‚’å–å¾—ï¼ˆwindow.location ç”±æ¥ã®é–‹ç™ºURLã‚’å›é¿ï¼‰
        google.script.run
          .withSuccessHandler(function(webAppUrl) {
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦URLã‚’æ§‹ç¯‰
            google.script.run
              .withSuccessHandler(function(userInfo) {
                const userId = (userInfo && userInfo.userId) ? userInfo.userId : '';
                const targetUrl = `${webAppUrl}?mode=appSetup${userId ? '&userId=' + userId : ''}`;
                appSetupLink.href = targetUrl;
              })
              .withFailureHandler(function(error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—å¤±æ•—:', error);
                if (window.notifications) {
                  window.notifications.warning('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 7000);
                }
                appSetupLink.href = `${webAppUrl}?mode=appSetup`;
              })
              .getUser('full');
          })
          .withFailureHandler(function(error) {
            console.error('WebApp URLå–å¾—å¤±æ•—:', error);
            if (window.notifications) {
              window.notifications.error('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 7000);
            }
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç¾åœ¨URLã‹ã‚‰ã‚¯ã‚¨ãƒªé™¤å»ã—ã¦ç”Ÿæˆ
            const baseUrl = window.location.href.split('?')[0];
            appSetupLink.href = `${baseUrl}?mode=appSetup`;
          })
          .getWebAppUrl();
      });
    </script>
  </body>
</html>
