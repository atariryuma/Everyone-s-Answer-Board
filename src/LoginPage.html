<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <title>みんなの回答ボード ログイン</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <?!= include('UnifiedStyles'); ?>
  <?!= include('SharedUtilities'); ?>
  <?!= include('SharedModals'); ?>
  <style>
  /* LoginPage specific styles */
  </style>
</head>
<body class="bg-[#1a1b26] text-gray-200 font-sans min-h-screen flex items-center justify-center p-4">
  <div class="login-card glass-panel p-6 w-full max-w-md">
    <div class="account-info mb-6">
      <p class="text-sm text-gray-400 mb-2">ログイン中のアカウント</p>
      <p class="user-email font-semibold text-white" id="user-email-display">-</p>
      <div id="domain-status-badge" class="mt-3 hidden"></div>
    </div>

    <div class="space-y-4">
      <button id="login-btn" class="btn btn-primary w-full text-base" disabled>
        ログイン
      </button>
      <div class="other-actions text-xs text-center">
        <a href="#" id="switch-account-link" class="footer-link">別のアカウントでログイン</a>
      </div>
    </div>

    <div class="mt-8 text-center text-xs">
      <a href="#" id="security-modal-trigger" class="footer-link">セキュリティ仕様について</a>
    </div>
  </div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    initializeLoginPage();
  });

  let googleAccountsClient;

  function initializeLoginPage() {
    setLoading(true, 'Google\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u60c5\u5831\u3092\u78ba\u8a8d\u3057\u3066\u3044\u307e\u3059...');
    const interval = setInterval(() => {
      if (typeof google !== 'undefined' && google.accounts) {
        clearInterval(interval);
        googleAccountsClient = google.accounts.oauth2.initTokenClient({
          client_id: '<?= GOOGLE_CLIENT_ID ?>',
          scope: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
          callback: handleCredentialResponse,
        });
        getServerSideInfo();
      }
    }, 100);
  }

  function getServerSideInfo() {
    google.script.run
      .withSuccessHandler(serverInfo => {
        const token = gapi.client.getToken();
        if (token) {
          updateUserInfo(token.access_token, serverInfo);
        } else {
          requestUserLogin();
        }
      })
      .withFailureHandler(handleError)
      .getSystemDomainInfo();
  }

  function updateUserInfo(accessToken, serverInfo) {
    fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${accessToken}`)
      .then(res => res.json())
      .then(userInfo => {
        document.getElementById('user-email-display').textContent = userInfo.email;
        const userDomain = userInfo.email.split('@')[1];
        const isAdminDomain = userDomain === serverInfo.adminDomain;
        displayDomainStatus(isAdminDomain, serverInfo.adminDomain);
        document.getElementById('login-btn').disabled = false;
        setLoading(false);
      })
      .catch(error => handleError(error));
  }

  function displayDomainStatus(isMatch, adminDomain) {
    const badgeEl = document.getElementById('domain-status-badge');
    let badgeHTML = '';
    if (isMatch) {
      badgeHTML = `
        <div class="domain-badge match">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
          <span>${adminDomain} ドメインに所属</span>
        </div>
      `;
    } else {
      badgeHTML = `
        <div class="domain-badge mismatch">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>
          <span>管理ドメイン(${adminDomain})と不一致</span>
        </div>
      `;
    }
    badgeEl.innerHTML = badgeHTML;
    badgeEl.classList.remove('hidden');
  }

  function requestUserLogin() {
    googleAccountsClient.requestAccessToken({ prompt: 'consent' });
  }

  function handleCredentialResponse(response) {
    if (response.error) {
      handleError(response);
      return;
    }
    getServerSideInfo();
  }

  document.getElementById('switch-account-link').addEventListener('click', e => {
    e.preventDefault();
    if (googleAccountsClient) {
      googleAccountsClient.requestAccessToken({ prompt: 'select_account' });
    }
  });
  </script>
</body>
</html>
