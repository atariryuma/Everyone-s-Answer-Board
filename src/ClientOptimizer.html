<script>
  /**
   * @fileoverview ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰æœ€é©åŒ–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   * GAS HTML Serviceç”¨ã®æœ€é©åŒ–ã•ã‚ŒãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–¢æ•°ç¾¤
   */

  class GASOptimizer {
    constructor() {
      this.cache = new Map();
      this.loadingStates = new Map();
      this.concurrentLimit = 10;
      this.activeCalls = 0;
      this.callQueue = [];
    }

    /**
     * PromiseåŒ–ã•ã‚ŒãŸgoogle.script.runå‘¼ã³å‡ºã—
     * @param {string} functionName - å‘¼ã³å‡ºã™é–¢æ•°å
     * @param {...any} args - é–¢æ•°ã®å¼•æ•°
     * @returns {Promise} çµæœã®Promise
     */
    async call(functionName, ...args) {
      return new Promise((resolve, reject) => {
        // åŒæ™‚å®Ÿè¡Œåˆ¶é™ã®ç¢ºèª
        if (this.activeCalls >= this.concurrentLimit) {
          this.callQueue.push(() => this.executeCall(functionName, args, resolve, reject));
          return;
        }

        this.executeCall(functionName, args, resolve, reject);
      });
    }

    /**
     * å®Ÿéš›ã®é–¢æ•°å‘¼ã³å‡ºã—å®Ÿè¡Œ
     */
    executeCall(functionName, args, resolve, reject) {
      this.activeCalls++;

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†
      this.setLoadingState(functionName, true);

      // GAS function call validation
      if (
        typeof google === 'undefined' ||
        !google.script ||
        !google.script.run ||
        typeof google.script.run[functionName] !== 'function'
      ) {
        throw new Error(`GAS function '${functionName}' is not available`);
      }

      google.script.run
        .withSuccessHandler((result) => {
          this.activeCalls--;
          this.setLoadingState(functionName, false);
          resolve(result);
          this.processQueue();
        })
        .withFailureHandler((error) => {
          this.activeCalls--;
          this.setLoadingState(functionName, false);
          console.error(`GAS Function Error [${functionName}]:`, error);
          reject(this.enhanceError(error, functionName));
          this.processQueue();
        })
        [functionName](...args);
    }

    /**
     * ã‚­ãƒ¥ãƒ¼ã®å‡¦ç†
     */
    processQueue() {
      if (this.callQueue.length > 0 && this.activeCalls < this.concurrentLimit) {
        const nextCall = this.callQueue.shift();
        nextCall();
      }
    }

    /**
     * ã‚¨ãƒ©ãƒ¼æƒ…å ±ã®æ‹¡å¼µ
     */
    enhanceError(error, functionName) {
      return {
        ...error,
        function: functionName,
        timestamp: new Date().toISOString(),
        userMessage: this.getUserFriendlyErrorMessage(error.message),
      };
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    getUserFriendlyErrorMessage(originalMessage) {
      const errorMap = {
        'Exception: èªè¨¼ã‚¨ãƒ©ãƒ¼':
          'ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæœŸé™åˆ‡ã‚Œã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        'Exception: ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ID':
          'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚',
        'Exception: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹':
          'ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        ScriptError: 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚',
      };

      for (const [key, message] of Object.entries(errorMap)) {
        if (originalMessage && originalMessage.includes(key)) {
          return message;
        }
      }

      return 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
    }

    /**
     * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†
     */
    setLoadingState(functionName, isLoading) {
      this.loadingStates.set(functionName, isLoading);
      this.updateGlobalLoadingIndicator();
    }

    /**
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®æ›´æ–°
     */
    updateGlobalLoadingIndicator() {
      const hasActiveLoading = Array.from(this.loadingStates.values()).some((state) => state);
      document.body.classList.toggle('gas-loading', hasActiveLoading);
    }

    /**
     * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãã®é–¢æ•°å‘¼ã³å‡ºã—
     */
    async callWithCache(functionName, args, ttl = 5 * 60 * 1000) {
      const cacheKey = `${functionName}_${JSON.stringify(args)}`;
      const cached = this.cache.get(cacheKey);

      if (cached && Date.now() - cached.timestamp < ttl) {
        return cached.data;
      }

      const result = await this.call(functionName, ...args);
      this.cache.set(cacheKey, {
        data: result,
        timestamp: Date.now(),
      });

      return result;
    }

    /**
     * ãƒãƒƒãƒå‡¦ç†å¯¾å¿œã®é–¢æ•°å‘¼ã³å‡ºã—
     */
    async batchCall(calls) {
      const promises = calls.map(({ functionName, args }) =>
        this.call(functionName, ...args).catch((error) => ({ error, functionName }))
      );

      return Promise.all(promises);
    }

    /**
     * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢
     */
    clearCache() {
      this.cache.clear();
    }

    /**
     * çµ±è¨ˆæƒ…å ±ã®å–å¾—
     */
    getStats() {
      return {
        activeCalls: this.activeCalls,
        queueLength: this.callQueue.length,
        cacheSize: this.cache.size,
        loadingStates: Object.fromEntries(this.loadingStates),
      };
    }
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
  window.gasOptimizer = new GASOptimizer();

  /**
   * ä¾¿åˆ©ãªé–¢æ•°ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
   */
  window.gasCall = (functionName, ...args) => window.gasOptimizer.call(functionName, ...args);
  window.gasCacheCall = (functionName, args, ttl) =>
    window.gasOptimizer.callWithCache(functionName, args, ttl);

  /**
   * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã®æœ€é©åŒ–
   */
  class MessageManager {
    constructor() {
      this.messageContainer = null;
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.init());
      } else {
        this.init();
      }
    }

    init() {
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã®ä½œæˆ
      if (!document.getElementById('gas-message-container')) {
        const container = document.createElement('div');
        container.id = 'gas-message-container';
        container.className = 'fixed top-4 right-4 z-50 space-y-2';
        document.body.appendChild(container);
        this.messageContainer = container;
      }
    }

    show(message, type = 'info', duration = 5000) {
      const messageEl = document.createElement('div');
      messageEl.className = `
      p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full
      ${this.getTypeClasses(type)}
    `;
      messageEl.innerHTML = `
      <div class="flex items-center space-x-2">
        <div class="flex-shrink-0">
          ${this.getIcon(type)}
        </div>
        <div class="flex-1 text-sm font-medium">${message}</div>
        <button type="button" onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
          ${typeof window.IconLibrary !== 'undefined' ? window.IconLibrary.get('x', {size: 'w-4 h-4'}) : '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/></svg>'}
        </button>
      </div>
    `;

      this.messageContainer.appendChild(messageEl);

      // CLAUDE.md V8 compliant: requestIdleCallback for message animation
      requestIdleCallback(() => {
        messageEl.classList.remove('translate-x-full');
      }, { timeout: 10 });

      // CLAUDE.md V8 compliant: Promise-based auto-removal
      if (duration > 0) {
        const createPromiseDelay = (ms) => new Promise(resolve => {
          const start = Date.now();
          const check = () => (Date.now() - start >= ms) ? resolve() : Promise.resolve().then(check);
          check();
        });

        createPromiseDelay(duration).then(() => {
          if (messageEl.parentElement) {
            messageEl.classList.add('translate-x-full', 'opacity-0');
            // Use CSS transition event instead of setTimeout
            messageEl.addEventListener('transitionend', () => messageEl.remove(), { once: true });
          }
        });
      }

      return messageEl;
    }

    getTypeClasses(type) {
      const classes = {
        info: 'bg-blue-500 text-white',
        success: 'bg-green-500 text-white',
        warning: 'bg-yellow-500 text-black',
        error: 'bg-red-500 text-white',
      };
      return classes[type] || classes.info;
    }

    getIcon(type) {
      // ğŸ¯ çµ±ä¸€ã‚¢ã‚¤ã‚³ãƒ³ã‚·ã‚¹ãƒ†ãƒ  - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ã‚¤ã‚³ãƒ³ã®çµ±ä¸€
      if (typeof window.IconLibrary !== 'undefined') {
        const iconMap = {
          info: 'info',
          success: 'check-circle',
          warning: 'alert-triangle',
          error: 'x-circle'
        };
        const iconName = iconMap[type] || 'info';
        return window.IconLibrary.get(iconName, {size: 'w-5 h-5'});
      }

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šIconLibraryãŒåˆ©ç”¨ã§ããªã„å ´åˆ
      const fallbackIcons = {
        info: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0zm-7-4a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM9 9a1 1 0 0 0 0 2v3a1 1 0 001 1h1a1 1 0 1 0 0-2v-3a1 1 0 00-1-1H9z"/></svg>',
        success: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 0 1 0 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>',
        warning: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"/></svg>',
        error: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0zM7 8a1 1 0 012 0v4a1 1 0 1 1-2 0V8zM12 8a1 1 0 1 1 2 0v4a1 1 0 1 1-2 0V8z"/></svg>',
      };
      return fallbackIcons[type] || fallbackIcons.info;
    }
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
  window.messageManager = new MessageManager();
  window.showMessage = (message, type, duration) =>
    window.messageManager.show(message, type, duration);

  /**
   * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®CSS
   */
  const loadingCSS = `
<style>
.gas-loading {
  cursor: wait;
}

.gas-loading * {
  pointer-events: none;
}

.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(139, 233, 253, 0.3);
  border-top: 2px solid var(--brand-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

</style>
`;

  // CSSã‚’æ³¨å…¥
  document.head.insertAdjacentHTML('beforeend', loadingCSS);

  // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
  if (
    window.location.hostname === 'localhost' ||
    window.location.hostname.includes('script.google.com')
  ) {
    window.gasDebug = () => console.log('GAS Optimizer Stats:', window.gasOptimizer.getStats());
  }
</script>
