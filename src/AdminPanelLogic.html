<script>
/* =============================================================================
   StudyQuest - Admin Panel Logic
   Extracted from AdminPanel.html for better maintainability
   Handles all admin-specific functionality and business logic
   ============================================================================= */

// =============================================================================
// APPLICATION STATE MANAGEMENT
// =============================================================================

// Application state object
const appState = {
  userId: '',
  selectedSheet: '',
  currentActiveSheet: '',
  webAppUrl: '',
  currentSpreadsheetUrl: '',
  currentStatus: null,
  isLoading: false
};

// Get user ID safely from template or meta tag
(function() {
  try {
    const templateUserId = '<?= typeof userId !== "undefined" ? userId : "" ?>';
    if (templateUserId && templateUserId.trim() !== '') {
      appState.userId = templateUserId;
      console.log('âœ… appState.userId from template:', appState.userId);
    } else {
      const userIdMeta = document.querySelector('meta[name="user-id"]');
      if (userIdMeta && userIdMeta.content) {
        appState.userId = userIdMeta.content;
        console.log('âœ… appState.userId from meta:', appState.userId);
      }
    }

    if (!appState.userId) {
      console.error('âŒ appState.userId not found in template or meta');
    }
  } catch (e) {
    console.error('âŒ appState.userId initialization error:', e);
    appState.userId = '';
  }
})();

// =============================================================================
// ADMIN ERROR HANDLING SYSTEM
// =============================================================================

/**
 * Translate technical error messages to user-friendly Japanese messages
 * @param {string} errorMsg - Original error message
 * @param {string} context - Error context
 * @returns {string} User-friendly error message
 */
function translateErrorMessage(errorMsg, context) {
  if (!errorMsg || typeof errorMsg !== 'string') {
    return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
  }

  const lowerMsg = errorMsg.toLowerCase();
  
  // Spreadsheet related errors
  if (lowerMsg.includes('ç¯„å›²ã®åˆ—æ•°ã«ã¯') || lowerMsg.includes('range')) {
    return `ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ã¦ã€1è¡Œç›®ã«ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆåˆ—åï¼‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
  }
  
  if (lowerMsg.includes('ã‚·ãƒ¼ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—') || lowerMsg.includes('sheet')) {
    return `ğŸ“‹ ã‚·ãƒ¼ãƒˆã®æƒ…å ±ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒæ­£ã—ãå…±æœ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
â€¢ ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
â€¢ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ`;
  }
  
  // Permission related errors
  if (lowerMsg.includes('permission') || lowerMsg.includes('æ¨©é™') || lowerMsg.includes('access denied')) {
    return `ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’ç¢ºèª
â€¢ ç·¨é›†æ¨©é™ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
â€¢ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ã¿ã‚‹`;
  }
  
  // Network related errors
  if (lowerMsg.includes('network') || lowerMsg.includes('timeout') || lowerMsg.includes('fetch')) {
    return `ğŸŒ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã®å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèª
â€¢ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
â€¢ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿`;
  }
  
  // Form related errors
  if (lowerMsg.includes('form') && lowerMsg.includes('not found')) {
    return `ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
â€¢ ãƒ•ã‚©ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
â€¢ æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ`;
  }
  
  // Validation related errors
  if (lowerMsg.includes('validation') || lowerMsg.includes('invalid')) {
    return `âš ï¸ å…¥åŠ›å†…å®¹ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ å¿…é ˆé …ç›®ãŒã™ã¹ã¦å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
â€¢ å…¥åŠ›å½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèª
â€¢ ç‰¹æ®Šæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèª`;
  }
  
  // Authentication related errors
  if (lowerMsg.includes('authentication') || lowerMsg.includes('login') || lowerMsg.includes('unauthorized')) {
    return `ğŸ” èªè¨¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
â€¢ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
â€¢ å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã‚‹`;
  }
  
  // Server related errors
  if (lowerMsg.includes('server error') || lowerMsg.includes('500') || lowerMsg.includes('503')) {
    return `âš¡ ã‚·ã‚¹ãƒ†ãƒ ãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ æ•°åˆ†å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
â€¢ å•é¡ŒãŒç¶šãå ´åˆã¯ç®¡ç†è€…ã«é€£çµ¡`;
  }
  
  // Configuration related errors
  if (context && context.includes('config') || lowerMsg.includes('configuration')) {
    return `âš™ï¸ è¨­å®šã®ä¿å­˜ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ã™ã¹ã¦ã®å¿…é ˆé …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
â€¢ è¨­å®šå†…å®¹ã«å•é¡ŒãŒãªã„ã‹ç¢ºèª
â€¢ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ`;
  }
  
  // Other common errors
  if (lowerMsg.includes('failed') || lowerMsg.includes('error')) {
    return `âŒ æ“ä½œãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
â€¢ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
â€¢ å•é¡ŒãŒç¶šãå ´åˆã¯åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’è©¦ã™`;
  }
  
  // Fallback
  return `âš ï¸ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š
â€¢ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
â€¢ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
â€¢ å•é¡ŒãŒç¶šãå ´åˆã¯ã‚µãƒãƒ¼ãƒˆã«ãŠå•ã„åˆã‚ã›ãã ã•ã„`;
}

/**
 * Centralized error handling for admin panel
 * @param {Error} error - Error object
 * @param {string} context - Context description
 * @param {string} userMessage - Custom user message
 */
function handleAdminError(error, context, userMessage) {
  const errorMsg = error && error.message ? error.message : String(error);
  console.error('[' + (context || 'Admin') + '] Error:', errorMsg);
  
  const displayMessage = userMessage || translateErrorMessage(errorMsg, context);
  
  // Use shared utilities for message display
  if (window.sharedUtilities && window.sharedUtilities.message) {
    window.sharedUtilities.message.show(displayMessage, 'error');
  } else {
    showMessage(displayMessage, 'error');
  }
  
  return false;
}

// =============================================================================
// LOADING STATE MANAGEMENT
// =============================================================================

/**
 * Set loading state with message
 * @param {boolean} isLoading - Loading state
 * @param {string} message - Loading message
 */
function setAdminLoading(isLoading, message = '') {
  const loader = document.getElementById('loading-overlay');
  const loaderMessage = document.getElementById('loading-message');
  
  if (!loader) return;

  if (isLoading) {
    if (loaderMessage) loaderMessage.textContent = message;
    loader.classList.remove('hidden');
    loader.style.pointerEvents = 'auto'; // ã‚¯ãƒªãƒƒã‚¯ã‚’å¦¨ã’ã‚‹
  } else {
    loader.classList.add('hidden');
    loader.style.pointerEvents = 'none'; // ã‚¯ãƒªãƒƒã‚¯ã‚’è¨±å¯
  }
}

/**
 * Progress bar system for multi-step operations
 * @param {number} currentStep - Current step number
 * @param {number} totalSteps - Total number of steps
 * @param {string} message - Progress message
 */
function showProgressStep(currentStep, totalSteps, message) {
  let progressContainer = document.getElementById('progress-container');
  
  if (!progressContainer) {
    progressContainer = document.createElement('div');
    progressContainer.id = 'progress-container';
    progressContainer.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    progressContainer.innerHTML = `
      <div class="glass-panel p-6 max-w-md w-full mx-4">
        <div class="text-center mb-4">
          <h3 class="text-lg font-semibold text-white">ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆé€²è¡Œä¸­</h3>
        </div>
        <div class="mb-4">
          <div class="bg-gray-700 rounded-full h-3 overflow-hidden">
            <div id="progress-bar" class="bg-gradient-to-r from-cyan-500 to-purple-500 h-full transition-all duration-500 ease-out" style="width: 0%"></div>
          </div>
        </div>
        <div class="text-center">
          <p id="progress-message" class="text-sm text-gray-300"></p>
          <p class="text-xs text-gray-400 mt-2">
            ã‚¹ãƒ†ãƒƒãƒ— <span id="progress-current">1</span> / <span id="progress-total">5</span>
          </p>
        </div>
      </div>
    `;
    document.body.appendChild(progressContainer);
  }
  
  const progressBar = document.getElementById('progress-bar');
  const progressMessage = document.getElementById('progress-message');
  const progressCurrent = document.getElementById('progress-current');
  const progressTotal = document.getElementById('progress-total');
  
  if (progressBar) {
    const percentage = (currentStep / totalSteps) * 100;
    progressBar.style.width = percentage + '%';
  }
  
  if (progressMessage) progressMessage.textContent = message;
  if (progressCurrent) progressCurrent.textContent = currentStep;
  if (progressTotal) progressTotal.textContent = totalSteps;
  
  progressContainer.classList.remove('hidden');
}

/**
 * Hide progress bar
 */
function hideProgressBar() {
  const progressContainer = document.getElementById('progress-container');
  if (progressContainer) {
    progressContainer.classList.add('hidden');
    setTimeout(() => {
      if (progressContainer.parentNode) {
        progressContainer.parentNode.removeChild(progressContainer);
      }
    }, 500);
  }
}

// =============================================================================
// MODAL MANAGEMENT SYSTEM
// =============================================================================

/**
 * Show confirmation modal with custom title and message
 * @param {string} title - Modal title
 * @param {string} message - Modal message
 * @param {Function} onConfirm - Callback on confirmation
 */
function showConfirmationModal(title, message, onConfirm) {
  const modal = document.getElementById('confirmation-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalMessage = document.getElementById('modal-message');
  
  if (modalTitle) modalTitle.textContent = title;
  if (modalMessage) modalMessage.textContent = message;
  
  if (!modal) {
    console.error('ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  const confirmBtn = document.getElementById('modal-confirm-btn');
  const cancelBtn = document.getElementById('modal-cancel-btn');

  const confirmHandler = function() {
    onConfirm();
    hideConfirmationModal();
    confirmBtn.removeEventListener('click', confirmHandler);
    cancelBtn.removeEventListener('click', cancelHandler);
  };

  const cancelHandler = function() {
    hideConfirmationModal();
    confirmBtn.removeEventListener('click', confirmHandler);
    cancelBtn.removeEventListener('click', cancelHandler);
  };

  confirmBtn.addEventListener('click', confirmHandler);
  cancelBtn.addEventListener('click', cancelHandler);
}

/**
 * Hide confirmation modal
 */
function hideConfirmationModal() {
  const modal = document.getElementById('confirmation-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
}

/**
 * Show privacy modal before sensitive operations
 * @param {Function} onContinue - Callback on continue
 */
function showPrivacyModal(onContinue) {
  const modal = document.getElementById('privacy-modal');
  if (!modal) {
    console.error('ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  
  modal.classList.remove('hidden');
  
  const continueBtn = document.getElementById('privacy-modal-continue');
  const cancelBtn = document.getElementById('privacy-modal-cancel');
  
  if (continueBtn) {
    const newContinueBtn = continueBtn.cloneNode(true);
    continueBtn.parentNode.replaceChild(newContinueBtn, continueBtn);
    newContinueBtn.addEventListener('click', function() {
      hidePrivacyModal();
      if (onContinue) onContinue();
    });
  }
  
  if (cancelBtn) {
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', hidePrivacyModal);
  }
  
  const escapeHandler = function(e) {
    if (e.key === 'Escape') {
      hidePrivacyModal();
      document.removeEventListener('keydown', escapeHandler);
    }
  };
  document.addEventListener('keydown', escapeHandler);
}

/**
 * Hide privacy modal
 */
function hidePrivacyModal() {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

// =============================================================================
// ADMIN UTILITY FUNCTIONS
// =============================================================================

/**
 * Safely set text content of an element
 * @param {string} elementId - Element ID
 * @param {string} value - Value to set
 * @param {string} prefix - Optional prefix
 */
function safeSetAdminText(elementId, value, prefix = '') {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = value ? prefix + value : '-';
    console.log(`âœ… Updated ${elementId}:`, element.textContent);
  } else {
    console.warn(`âŒ Element not found: ${elementId}`);
  }
}

/**
 * Update publication status UI
 * @param {boolean} isPublished - Publication status
 */
function updatePublicationStatusUI(isPublished) {
  const statusIndicator = document.getElementById('info-publish-indicator');
  const statusText = document.getElementById('info-publish-text');
  const unpublishBtn = document.getElementById('unpublish-board-btn');
  const savePublishBtn = document.getElementById('save-publish-btn');
  
  if (statusIndicator && statusText) {
    if (isPublished) {
      statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
      statusText.textContent = 'å…¬é–‹ä¸­';
      statusText.className = 'text-green-400';
    } else {
      statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
      statusText.textContent = 'éå…¬é–‹';
      statusText.className = 'text-red-400';
    }
  }
  
  if (unpublishBtn) {
    unpublishBtn.style.display = isPublished ? 'inline-flex' : 'none';
  }
  
  if (savePublishBtn) {
    const text = isPublished ? 'è¨­å®šã‚’æ›´æ–°' : 'è¨­å®šä¿å­˜ãƒ»å…¬é–‹';
    savePublishBtn.textContent = text;
  }

  const adminFooter = document.getElementById('admin-footer');
  if (adminFooter) {
    adminFooter.style.display = isPublished ? 'block' : 'none';
  }
}

/**
 * Toggle progressive disclosure sections
 * @param {string} sectionId - Section ID to toggle
 */
function toggleAdminSection(sectionId) {
  const section = document.getElementById(sectionId);
  const icon = document.getElementById(sectionId.replace('content', 'icon'));
  
  if (!section) return;
  
  const isExpanded = section.classList.contains('expanded');
  
  if (isExpanded) {
    section.classList.remove('expanded');
    section.classList.add('collapsed');
    if (icon) {
      if (sectionId === 'step1-content') {
        icon.style.transform = 'rotate(0deg)';
      } else if (sectionId === 'step2-content' || sectionId === 'step3-content') {
        icon.style.transform = 'rotate(90deg)';
      }
    }
  } else {
    section.classList.remove('collapsed');
    section.classList.add('expanded');
    if (icon) {
      if (sectionId === 'step1-content') {
        icon.style.transform = 'rotate(180deg)';
      } else if (sectionId === 'step2-content' || sectionId === 'step3-content') {
        icon.style.transform = 'rotate(0deg)';
      }
    }
  }
}

// =============================================================================
// ADMIN PANEL SPECIFIC FUNCTIONS
// =============================================================================

/**
 * Update database info panel with status data
 * @param {Object} status - Status object from server
 */
function updateDatabaseInfo(status) {
  console.log('ğŸ”§ updateDatabaseInfo called with status:', status);
  
  if (!status || !status.userInfo) {
    console.warn('ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’æ›´æ–°ã§ãã¾ã›ã‚“ã§ã—ãŸ: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', status);
    return;
  }

  console.log('âœ… User info found, updating system panel:', status.userInfo);

  // Set spreadsheet URL
  if (status.userInfo.spreadsheetUrl) {
    appState.currentSpreadsheetUrl = status.userInfo.spreadsheetUrl;
    console.log('âœ… currentSpreadsheetUrl set to:', appState.currentSpreadsheetUrl);
  }

  // Update existing fields
  safeSetAdminText('info-admin-email', status.userInfo.adminEmail);
  safeSetAdminText('info-user-id', status.userInfo.userId);
  
  // Published sheet name
  let publishedSheetName = status.publishedSheetName || status.activeSheetName;
  if (!publishedSheetName && status.userInfo && status.userInfo.configJson) {
    try {
      const config = JSON.parse(status.userInfo.configJson);
      publishedSheetName = config.publishedSheetName;
    } catch (e) {
      console.warn('ConfigJSON parse error in published sheet name:', e);
    }
  }
  safeSetAdminText('info-published-sheet', publishedSheetName || 'ãªã—');
  safeSetAdminText('info-answer-count', status.answerCount || '0');
  safeSetAdminText('info-reaction-count', status.totalReactions || '0');

  // Update publication status
  const isPublished = status && (
    status.isPublished || 
    status.appPublished || 
    (status.publishedSheetName && status.publishedSheetName !== 'ãªã—')
  );
  updatePublicationStatusUI(isPublished);

  // Display mode
  const displayMode = status.showNames ? 'åå‰è¡¨ç¤º' : 'åŒ¿åè¡¨ç¤º';
  safeSetAdminText('info-display-mode', displayMode);

  // Count display
  const showCounts = status.showCounts !== undefined ? (status.showCounts ? 'è¡¨ç¤º' : 'éè¡¨ç¤º') : 'è¡¨ç¤º';
  safeSetAdminText('info-show-counts', showCounts);
  
  // Update button states
  updateAdminButtonStates(status);
}

/**
 * Update admin button states based on status
 * @param {Object} status - Status object
 */
function updateAdminButtonStates(status) {
  const openSpreadsheetBtns = document.querySelectorAll('#open-spreadsheet-btn, #open-spreadsheet-btn-step2');
  const openFormBtn = document.getElementById('open-form-btn');
  const openLinkedFormBtn = document.getElementById('open-linked-form-btn');
  
  openSpreadsheetBtns.forEach(btn => {
    if (btn) {
      const hasSpreadsheetUrl = status.userInfo && status.userInfo.spreadsheetUrl;
      btn.disabled = !hasSpreadsheetUrl;
      btn.title = hasSpreadsheetUrl ? 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã' : 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
    }
  });
  
  if (openFormBtn) {
    const formUrl = status.formUrl || (status.userInfo && status.userInfo.formUrl);
    const hasFormUrl = formUrl && formUrl.trim() !== "";
    openFormBtn.disabled = !hasFormUrl;
    openFormBtn.title = hasFormUrl ? 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã' : 'ãƒ•ã‚©ãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
  }

  if (openLinkedFormBtn) {
    const hasFormUrl = status.formUrl && status.formUrl.trim() !== '';
    openLinkedFormBtn.disabled = !hasFormUrl;
    openLinkedFormBtn.title = hasFormUrl ? 'é€£æºã—ã¦ã„ã‚‹Googleãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ãã¾ã™' : 'é€£æºã—ã¦ã„ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
  }
}

/**
 * Handle account deletion request with double confirmation
 */
function handleDeleteRequest() {
  showPrivacyModal(function() {
    showConfirmationModal(
      'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å®Œå…¨å‰Šé™¤',
      'æœ¬å½“ã«ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ãšã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ã€‚',
      function() {
        setAdminLoading(true, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã„ã¾ã™...');
        
        if (window.sharedUtilities && window.sharedUtilities.gas) {
          window.sharedUtilities.gas.call(
            'deleteCurrentUserAccount',
            function(response) {
              setAdminLoading(false);
              if (window.sharedUtilities.message) {
                window.sharedUtilities.message.show(response, 'success');
              }
              setTimeout(function() {
                if (window.sharedUtilities.navigation) {
                  window.sharedUtilities.navigation.safeNavigate('?page=LoginPage', {
                    fallbackMessage: 'ç™»éŒ²ãƒšãƒ¼ã‚¸ã«ç§»å‹•ä¸­...',
                    method: 'auto'
                  });
                } else {
                  window.location.href = '?page=LoginPage';
                }
              }, 2000);
            },
            function(error) {
              setAdminLoading(false);
              handleAdminError(error, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤');
            },
            [appState.userId],
            'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤'
          );
        }
      }
    );
  });
}

/**
 * Admin system flow display for debugging
 */
function showAdminSystemFlow() {
  const DEBUG_MODE = <?= typeof DEBUG_MODE !== 'undefined' ? DEBUG_MODE : false ?>;
  if (!DEBUG_MODE) return;
  
  console.group('ğŸ”„ StudyQuest ç®¡ç†ãƒ‘ãƒãƒ« ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼');
  console.log('ğŸ“‹ Phase 1: ç®¡ç†ãƒ‘ãƒãƒ«åˆæœŸåŒ–');
  console.log('  â”œâ”€ ç®¡ç†è€…æ¨©é™ç¢ºèª');
  console.log('  â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—');
  console.log('  â”œâ”€ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶š');
  console.log('  â””â”€ UIè¦ç´ åˆæœŸåŒ–');
  
  console.log('ğŸ¨ Phase 2: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹ç¯‰');
  console.log('  â”œâ”€ å·¦ãƒ‘ãƒãƒ«ï¼ˆãƒ¡ã‚¤ãƒ³æ“ä½œï¼‰');
  console.log('  â”œâ”€ å³ãƒ‘ãƒãƒ«ï¼ˆã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ï¼‰');
  console.log('  â”œâ”€ ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆå…¬é–‹URLè¡¨ç¤ºï¼‰');
  console.log('  â””â”€ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ');
  
  console.log('ğŸ“¡ Phase 3: ãƒ‡ãƒ¼ã‚¿é€£æº');
  console.log('  â”œâ”€ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—');
  console.log('  â”œâ”€ ã‚·ãƒ¼ãƒˆä¸€è¦§å–å¾—');
  console.log('  â”œâ”€ åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼è‡ªå‹•åˆ¤å®š');
  console.log('  â””â”€ å…¬é–‹çŠ¶æ…‹ç¢ºèª');
  
  console.log('ğŸ—ï¸ Phase 4: è¨­å®šUIæ§‹ç¯‰');
  console.log('  â”œâ”€ ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼');
  console.log('  â”œâ”€ ã‚·ãƒ¼ãƒˆé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³');
  console.log('  â”œâ”€ åˆ—è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ');
  console.log('  â””â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º');
  
  console.log('âš¡ Phase 5: ç®¡ç†æ©Ÿèƒ½');
  console.log('  â”œâ”€ ãƒœãƒ¼ãƒ‰ä½œæˆãƒ»å…¬é–‹');
  console.log('  â”œâ”€ è¨­å®šå¤‰æ›´');
  console.log('  â”œâ”€ URLã‚³ãƒ”ãƒ¼æ©Ÿèƒ½');
  console.log('  â””â”€ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°');
  
  console.log('ğŸ”§ Phase 6: æœ€é©åŒ–ãƒ»ç›£è¦–');
  console.log('  â”œâ”€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†');
  console.log('  â”œâ”€ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°');
  console.log('  â”œâ”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–');
  console.log('  â””â”€ ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›');
  
  console.groupEnd();
  
  console.group('ğŸ“Š ç®¡ç†ãƒ‘ãƒãƒ«ç¾åœ¨çŠ¶æ…‹');
  console.log('DOMçŠ¶æ…‹:', document.readyState);
  console.log('CSSèª­ã¿è¾¼ã¿:', document.styleSheets.length + ' stylesheets');
  console.log('GASç’°å¢ƒ:', typeof google !== 'undefined' ? 'Available' : 'Not Available');
  console.log('ç®¡ç†è€…çŠ¶æ…‹:', typeof appState.currentStatus !== 'undefined' && appState.currentStatus ? 'Authenticated' : 'Unknown');
  console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL:', typeof appState.currentSpreadsheetUrl !== 'undefined' ? (appState.currentSpreadsheetUrl ? 'Set' : 'Not Set') : 'Unknown');
  console.groupEnd();
}

// =============================================================================
// CACHE MANAGEMENT SYSTEM
// =============================================================================

/**
 * Frontend cache manager for admin panel
 */
class AdminCacheManager {
  constructor() {
    this.caches = new Map();
    this.defaultTTL = 30000; // 30 seconds
    this.dependencies = new Map();
    this._initializeDependencies();
  }
  
  _initializeDependencies() {
    this.dependencies.set('user_data_change', ['status', 'userInfo', 'formUrls']);
    this.dependencies.set('form_creation', ['status', 'formUrls', 'sheetDetails']);
    this.dependencies.set('config_change', ['status', 'sheetDetails']);
  }
  
  get(key, defaultValue = null) {
    const cached = this.caches.get(key);
    if (!cached) return defaultValue;
    
    const now = Date.now();
    if (now - cached.timestamp > cached.ttl) {
      this.caches.delete(key);
      console.log(`ğŸ“Š [Cache] Expired and removed: ${key}`);
      return defaultValue;
    }
    
    console.log(`ğŸ“Š [Cache] Hit: ${key}`);
    return cached.value;
  }
  
  set(key, value, ttl = this.defaultTTL) {
    this.caches.set(key, {
      value: value,
      timestamp: Date.now(),
      ttl: ttl
    });
    console.log(`ğŸ“Š [Cache] Set: ${key} (TTL: ${ttl}ms)`);
  }
  
  invalidate(key) {
    this.caches.delete(key);
    console.log(`ğŸ“Š [Cache] Invalidated: ${key}`);
  }
  
  invalidateDependents(changeType) {
    const dependents = this.dependencies.get(changeType) || [];
    dependents.forEach(key => this.invalidate(key));
    console.log(`ğŸ“Š [Cache] Invalidated dependents of ${changeType}:`, dependents);
  }
  
  clear() {
    this.caches.clear();
    console.log('ğŸ“Š [Cache] Cleared all caches');
  }
}

// Global cache manager instance
window.adminCacheManager = new AdminCacheManager();

// =============================================================================
// INITIALIZATION
// =============================================================================

/**
 * Initialize admin panel specific functionality
 */
function initializeAdminPanel() {
  console.log('ğŸ”§ Initializing Admin Panel Logic...');
  
  // Show system flow for debugging
  showAdminSystemFlow();
  
  // Set up global error handler for admin panel
  window.addEventListener('error', (event) => {
    console.error('Admin Panel Global Error:', event.error);
    if (window.sharedUtilities && window.sharedUtilities.message) {
      window.sharedUtilities.message.show('ç®¡ç†ãƒ‘ãƒãƒ«ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
  });
  
  console.log('âœ… Admin Panel Logic initialized');
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeAdminPanel);
} else {
  initializeAdminPanel();
}

// =============================================================================
// EXPORT TO GLOBAL SCOPE
// =============================================================================

// Export admin utilities to global scope for easy access
window.adminUtilities = {
  state: appState,
  error: {
    handle: handleAdminError,
    translate: translateErrorMessage
  },
  loading: {
    set: setAdminLoading,
    showProgress: showProgressStep,
    hideProgress: hideProgressBar
  },
  modal: {
    showConfirmation: showConfirmationModal,
    hideConfirmation: hideConfirmationModal,
    showPrivacy: showPrivacyModal,
    hidePrivacy: hidePrivacyModal
  },
  ui: {
    setText: safeSetAdminText,
    updatePublicationStatus: updatePublicationStatusUI,
    updateDatabaseInfo: updateDatabaseInfo,
    toggleSection: toggleAdminSection
  },
  cache: window.adminCacheManager,
  actions: {
    handleDeleteRequest: handleDeleteRequest
  }
};

</script>