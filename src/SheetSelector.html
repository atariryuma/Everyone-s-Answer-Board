<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.tailwindcss.com/tailwind.min.css" rel="stylesheet">
    <style>
      body { font-family: sans-serif; }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
  </head>
  <body class="p-4 bg-gray-100">
    <div id="app">
      <h2 class="text-xl font-bold mb-4 text-gray-800">管理パネル</h2>

      <!-- Current Status -->
      <div class="mb-6 p-4 rounded-lg bg-white shadow-md">
        <h3 class="font-semibold text-gray-700 mb-2">現在の状態</h3>
        <p id="status-text" class="text-gray-600">状態を読み込み中...</p>
      </div>

      <!-- Sheet Information -->
      <div class="mb-6">
        <h3 class="font-semibold text-gray-700 mb-3">利用可能なシート</h3>
        <div id="sheet-list" class="flex flex-col gap-2 rounded-lg bg-white p-2 shadow-md max-h-48 overflow-y-auto">
          <p class="text-gray-500 p-2">シートを読み込み中...</p>
        </div>
      </div>

      <!-- Actions -->
      <div>
        <h3 class="font-semibold text-gray-700 mb-3">アプリを開く</h3>
        <div class="flex flex-col gap-3">
          
          <button 
            id="open-app-btn" 
            class="w-full text-white font-bold py-2 px-4 rounded-lg bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition disabled:bg-green-300 disabled:cursor-not-allowed"
            aria-describedby="open-app-help"
            disabled>
            <span id="open-app-icon" class="inline-block mr-2">🚀</span>
            アプリを開く
          </button>
          <div id="open-app-help" class="text-xs text-gray-500 hidden">
            公開中のアプリを新しいタブで開きます
          </div>
          
          <button 
            id="open-admin-btn" 
            class="w-full text-white font-bold py-2 px-4 rounded-lg bg-purple-500 hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-opacity-75 transition disabled:bg-purple-300 disabled:cursor-not-allowed"
            aria-describedby="open-admin-help"
            disabled>
            <span id="open-admin-icon" class="inline-block mr-2">👨‍💼</span>
            管理者として開く
          </button>
          <div id="open-admin-help" class="text-xs text-gray-500 hidden">
            管理者権限でアプリを開きます（登録済み管理者のみ）
          </div>
        </div>
      </div>
      
      <div id="message-area" class="mt-4 text-center text-sm h-5"></div>

    </div>

    <script>
      const elements = {
        statusText: document.getElementById('status-text'),
        sheetList: document.getElementById('sheet-list'),
        openAppBtn: document.getElementById('open-app-btn'),
        openAdminBtn: document.getElementById('open-admin-btn'),
        messageArea: document.getElementById('message-area')
      };

      let selectedSheet = null;

      document.addEventListener('DOMContentLoaded', () => {
        loadInitialState();
        elements.openAppBtn.addEventListener('click', openApp);
        elements.openAdminBtn.addEventListener('click', openAdminApp);
      });

      function loadInitialState() {
        setLoading(true, "状態を更新中...");
        google.script.run
          .withSuccessHandler(updateUI)
          .withFailureHandler(showError)
          .getAdminSettings();
      }

      function updateUI(status) {
        selectedSheet = status.activeSheetName;
        
        // Update status display with enhanced accessibility
        const hasDeployId = status.deployId && status.deployId.trim() !== '';
        
        elements.statusText.innerHTML = `<span class="font-bold text-blue-700">管理パネル</span> - ${status.currentUserEmail}`;
        elements.statusText.setAttribute('aria-label', `管理パネル。現在のユーザー: ${status.currentUserEmail}`);
        
        // Buttons availability based on deploy ID
        elements.openAppBtn.disabled = !hasDeployId;
        elements.openAdminBtn.disabled = !hasDeployId || !status.isUserAdmin;
        
        if (hasDeployId) {
          elements.openAppBtn.setAttribute('aria-label', '生徒用アプリを開く');
          document.getElementById('open-app-help').classList.remove('hidden');
          
          if (status.isUserAdmin) {
            elements.openAdminBtn.setAttribute('aria-label', '管理者用アプリを開く');
            document.getElementById('open-admin-help').classList.remove('hidden');
          } else {
            elements.openAdminBtn.removeAttribute('aria-label');
            document.getElementById('open-admin-help').classList.add('hidden');
          }
        } else {
          elements.openAppBtn.removeAttribute('aria-label');
          elements.openAdminBtn.removeAttribute('aria-label');
          document.getElementById('open-app-help').classList.add('hidden');
          document.getElementById('open-admin-help').classList.add('hidden');
        }
        
        elements.sheetList.innerHTML = '';
        if (status.allSheets && status.allSheets.length > 0) {
          status.allSheets.forEach(name => {
            const div = document.createElement('div');
            div.className = 'p-2 rounded-md bg-gray-50 border border-gray-200';
            div.textContent = name;
            elements.sheetList.appendChild(div);
          });
        } else {
          elements.sheetList.innerHTML = '<p class="text-gray-600 p-2">表示できるシートがありません。</p>';
        }

        setLoading(false);
      }

      function openApp() {
        google.script.run
          .withSuccessHandler(() => {
            showMessage('生徒用アプリを開いています...', 'blue');
          })
          .withFailureHandler(showError)
          .openPublishedApp();
      }

      function openAdminApp() {
        google.script.run
          .withSuccessHandler((url) => {
            if (url) {
              window.open(url, '_blank');
              showMessage('管理者用アプリを開いています...', 'blue');
            } else {
              showMessage('管理者用URLの生成に失敗しました。', 'red');
            }
          })
          .withFailureHandler(showError)
          .generateAdminUrl();
      }


      function showMessage(msg, color = 'red') {
        const colorClasses = { red: 'text-red-600', green: 'text-green-600', blue: 'text-blue-600' };
        elements.messageArea.className = `mt-4 text-center text-sm h-5 ${colorClasses[color]}`;
        elements.messageArea.textContent = msg;
      }
      
      function showError(error) {
        showMessage(error.message, 'red');
        setLoading(false);
      }

      /**
       * Escape HTML to prevent XSS
       * @param {string} str - String to escape
       * @returns {string} Escaped string
       */
      function escapeHtml(str) {
        if (typeof str !== 'string') return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      /**
       * Show loading state with improved accessibility
       * @param {boolean} isLoading - Loading state
       * @param {string} msg - Loading message
       */
      function setLoading(isLoading, msg = "") {
        elements.openAppBtn.disabled = isLoading;
        elements.openAdminBtn.disabled = isLoading;
        
        // Update ARIA attributes for screen readers
        elements.openAppBtn.setAttribute('aria-busy', isLoading.toString());
        elements.openAdminBtn.setAttribute('aria-busy', isLoading.toString());
        
        if (isLoading) {
          showMessage(msg, 'blue');
          // Add loading icons
          document.getElementById('open-app-icon').textContent = '⏳';
          document.getElementById('open-admin-icon').textContent = '⏳';
        } else {
          // Restore original icons
          document.getElementById('open-app-icon').textContent = '🚀';
          document.getElementById('open-admin-icon').textContent = '👨‍💼';
        }
      }
    </script>
  </body>
</html>
