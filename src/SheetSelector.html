<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.tailwindcss.com/tailwind.min.css" rel="stylesheet">
    <style>
      body { font-family: sans-serif; }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
  </head>
  <body class="p-4 bg-gray-100">
    <div id="app">
      <h2 class="text-xl font-bold mb-4 text-gray-800">管理パネル</h2>

      <!-- Current Status -->
      <div class="mb-6 p-4 rounded-lg bg-white shadow-md">
        <h3 class="font-semibold text-gray-700 mb-2">現在の状態</h3>
        <p id="status-text" class="text-gray-600">状態を読み込み中...</p>
      </div>

      <!-- Sheet Selection -->
      <div class="mb-6">
        <h3 class="font-semibold text-gray-700 mb-3">1. 公開するシートを選択</h3>
        <div id="sheet-list" class="flex flex-col gap-2 rounded-lg bg-white p-2 shadow-md max-h-48 overflow-y-auto">
          <p class="text-gray-500 p-2">シートを読み込み中...</p>
        </div>
      </div>

      <!-- Display Mode -->
      <div class="mb-6">
        <h4 class="font-semibold text-gray-700 mb-3">表示設定</h4>
        <div class="bg-white p-3 rounded-lg shadow-md flex flex-col gap-2">
          <div>
            <input type="radio" id="mode-anonymous" name="displayMode" value="anonymous" checked>
            <label for="mode-anonymous" class="ml-1">匿名で表示（生徒間の画面では名前を非表示）</label>
          </div>
          <div>
            <input type="radio" id="mode-named" name="displayMode" value="named">
            <label for="mode-named" class="ml-1">名前を表示（全ての画面で名前を表示）</label>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div>
        <h3 class="font-semibold text-gray-700 mb-3">2. 操作を選択</h3>
        <div class="flex flex-col gap-3">
          <button id="publish-btn" class="w-full text-white font-bold py-2 px-4 rounded-lg bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition disabled:bg-blue-300">
            選択したシートを公開
          </button>
          <button id="unpublish-btn" class="w-full text-white font-bold py-2 px-4 rounded-lg bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 transition disabled:bg-red-300">
            公開を終了する
          </button>
        </div>
      </div>
      
      <div id="message-area" class="mt-4 text-center text-sm h-5"></div>
      <div class="mt-6 text-right">
        <a id="open-admin" href="#" target="_blank" class="text-blue-600 underline">管理者として開く</a>
      </div>

    </div>

    <script>
      const elements = {
        statusText: document.getElementById('status-text'),
        sheetList: document.getElementById('sheet-list'),
        publishBtn: document.getElementById('publish-btn'),
        unpublishBtn: document.getElementById('unpublish-btn'),
        messageArea: document.getElementById('message-area'),
        modeAnonymous: document.getElementById('mode-anonymous'),
        modeNamed: document.getElementById('mode-named'),
        openAdmin: document.getElementById('open-admin')
      };

      let selectedSheet = null;
      let displayMode = 'anonymous';

      document.addEventListener('DOMContentLoaded', () => {
        loadInitialState();
        elements.publishBtn.addEventListener('click', publish);
        elements.unpublishBtn.addEventListener('click', unpublish);
        elements.modeNamed.addEventListener('click', () => {
          if (!confirm('注意：生徒の心理的安全性を考慮し、通常は匿名表示を推奨します。本当に名前を表示しますか？')) {
            elements.modeAnonymous.checked = true;
            displayMode = 'anonymous';
          } else {
            displayMode = 'named';
          }
        });
        elements.modeAnonymous.addEventListener('click', () => {
          displayMode = 'anonymous';
        });
        google.script.run.withSuccessHandler(url => {
          if (url) {
            elements.openAdmin.href = url + '?admin=1';
          }
        }).getWebAppUrl();
      });

      function loadInitialState() {
        setLoading(true, "状態を更新中...");
        google.script.run
          .withSuccessHandler(updateUI)
          .withFailureHandler(showError)
          .getAdminSettings();
      }

      function updateUI(status) {
        selectedSheet = status.activeSheetName;
        displayMode = status.displayMode || 'anonymous';
        if (displayMode === 'named') {
          elements.modeNamed.checked = true;
        } else {
          elements.modeAnonymous.checked = true;
        }
        
        if (status.isPublished && status.activeSheetName) {
          elements.statusText.innerHTML = `公開中: <span class="font-bold text-green-700">${status.activeSheetName}</span>`;
          elements.unpublishBtn.disabled = false;
        } else {
          elements.statusText.textContent = '現在、アプリは非公開です。';
          elements.unpublishBtn.disabled = true;
        }
        
        elements.sheetList.innerHTML = '';
        if (status.allSheets && status.allSheets.length > 0) {
          status.allSheets.forEach(name => {
            const label = document.createElement('label');
            label.className = 'flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer';
            
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'sheet';
            radio.value = name;
            radio.className = 'mr-3 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500';
            if (name === status.activeSheetName) {
              radio.checked = true;
            }
            radio.onchange = () => {
              selectedSheet = name;
              elements.publishBtn.disabled = false;
            };

            label.appendChild(radio);
            label.appendChild(document.createTextNode(name));
            elements.sheetList.appendChild(label);
          });
        } else {
          elements.sheetList.innerHTML = '<p class="text-gray-600 p-2">表示できるシートがありません。</p>';
        }

        elements.publishBtn.disabled = !selectedSheet || (status.isPublished && selectedSheet === status.activeSheetName);
        setLoading(false);
      }


      function publish() {
        if (!selectedSheet) {
          showMessage('公開するシートを選択してください。', 'red');
          return;
        }
        setLoading(true, "公開処理中...");
        google.script.run
          .withSuccessHandler(() => {
            google.script.run
              .withSuccessHandler((msg) => {
                showMessage(msg, 'green');
                loadInitialState();
              })
              .withFailureHandler(showError)
              .publishApp(selectedSheet);
          })
          .withFailureHandler(showError)
          .saveDisplayMode(displayMode);
      }

      function unpublish() {
        setLoading(true, "非公開処理中...");
        google.script.run
          .withSuccessHandler((msg) => {
            showMessage(msg, 'green');
            loadInitialState();
          })
          .withFailureHandler(showError)
          .unpublishApp();
      }

      function setLoading(isLoading, msg = "") {
        elements.publishBtn.disabled = isLoading;
        elements.unpublishBtn.disabled = isLoading;
        if (isLoading) {
            showMessage(msg, 'blue');
        }
      }

      function showMessage(msg, color = 'red') {
        const colorClasses = { red: 'text-red-600', green: 'text-green-600', blue: 'text-blue-600' };
        elements.messageArea.className = `mt-4 text-center text-sm h-5 ${colorClasses[color]}`;
        elements.messageArea.textContent = msg;
      }
      
      function showError(error) {
        showMessage(error.message, 'red');
        setLoading(false);
      }
    </script>
  </body>
</html>

