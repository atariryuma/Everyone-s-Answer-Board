/**
 * @fileoverview èªè¨¼ç®¡ç† - JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨æœ€é©åŒ–
 * GASäº’æ›ã®é–¢æ•°ãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…
 */

/**




/**
 * ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã‚’å‡¦ç†ã—ã€é©åˆ‡ãªãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
 * æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®šã‚’ä¿è­·ã—ã¤ã¤ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
 * @param {string} userEmail ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @returns {HtmlOutput} è¡¨ç¤ºã™ã‚‹HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„
 */
function processLoginFlow(userEmail) {
  try {
    if (!userEmail) {
      throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }

    // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
    const userInfo = DB.findUserByEmail(userEmail);

    // 2. æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‡¦ç†
    if (userInfo) {
      // 2a. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ
      if (isTrue(userInfo.isActive)) {
        console.log('processLoginFlow: æ—¢å­˜ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼:', userEmail);

        // æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ™‚åˆ»ã‚’æ›´æ–°ï¼ˆè¨­å®šã¯ä¿è­·ï¼‰
        updateUserLastAccess(userInfo.userId);

        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª¿æ•´
        const setupStatus = getSetupStatusFromConfig(userInfo.configJson);
        let welcomeMessage = 'ç®¡ç†ãƒ‘ãƒãƒ«ã¸ã‚ˆã†ã“ã';

        if (setupStatus === 'pending') {
          welcomeMessage = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ç¶šè¡Œã—ã¦ãã ã•ã„';
        } else if (setupStatus === 'completed') {
          welcomeMessage = 'ãŠã‹ãˆã‚Šãªã•ã„ï¼';
        }

        const adminUrl = buildUserAdminUrl(userInfo.userId);
        return createSecureRedirect(adminUrl, welcomeMessage);
      }
      // 2b. éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ
      else {
        console.warn('processLoginFlow: æ—¢å­˜ã ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¦ãƒ¼ã‚¶ãƒ¼:', userEmail);
        return showErrorPage(
          'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒç„¡åŠ¹ã§ã™',
          'ã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç¾åœ¨ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚'
        );
      }
    }
    // 3. æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‡¦ç†
    else {
      console.log('processLoginFlow: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²é–‹å§‹:', userEmail);

      // 3a. æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ï¼ˆåˆæœŸè¨­å®šã§pendingçŠ¶æ…‹ï¼‰
      const initialConfig = {
        setupStatus: 'pending',
        createdAt: new Date().toISOString(),
        formCreated: false,
        appPublished: false,
      };

      const newUser = {
        userId: Utilities.getUuid(),
        adminEmail: userEmail,
        createdAt: new Date().toISOString(),
        isActive: true, // å³æ™‚æœ‰åŠ¹åŒ–
        configJson: JSON.stringify(initialConfig),
        spreadsheetId: '',
        spreadsheetUrl: '',
        lastAccessedAt: new Date().toISOString(),
      };

      // 3b. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä½œæˆ
      DB.createUser(newUser);
      // ConfigurationManagerã§åˆæœŸè¨­å®šã‚’ä½œæˆ
      App.getConfig().initializeUserConfig(newUser.tenantId, userEmail);
      
      if (!waitForUserRecord(newUser.tenantId, 3000, 500)) {
        console.warn('processLoginFlow: user not found after create:', newUser.tenantId);
      }
      console.log('processLoginFlow: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå®Œäº†:', newUser.tenantId);

      // 3c. æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç®¡ç†ãƒ‘ãƒãƒ«ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      const adminUrl = buildUserAdminUrl(newUser.tenantId);
      return createSecureRedirect(adminUrl, 'ã‚ˆã†ã“ãï¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¦ãã ã•ã„');
    }
  } catch (error) {
    // æ§‹é€ åŒ–ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å‡ºåŠ›
    const errorInfo = {
      timestamp: new Date().toISOString(),
      function: 'processLoginFlow',
      userEmail: userEmail || 'unknown',
      errorType: error.name || 'UnknownError',
      message: error.message,
      stack: error.stack,
      severity: 'high', // ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã¯é«˜é‡è¦åº¦
    };
    console.error('ğŸš¨ processLoginFlow é‡å¤§ã‚¨ãƒ©ãƒ¼:', JSON.stringify(errorInfo, null, 2));

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const userMessage = error.message.includes('ãƒ¦ãƒ¼ã‚¶ãƒ¼')
      ? error.message
      : 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';

    return showErrorPage('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼', userMessage, error);
  }
}
