<script>
function UnifiedCache() {
  this.cache = new Map();
}

UnifiedCache.prototype.set = function(key, value, ttl) {
  if (ttl === undefined) ttl = 300000;
  this.cache.set(key, { value: value, expiry: Date.now() + ttl });
};

UnifiedCache.prototype.get = function(key) {
  const entry = this.cache.get(key);
  if (!entry) return undefined;
  if (entry.expiry && Date.now() > entry.expiry) {
    this.cache.delete(key);
    return undefined;
  }
  return entry.value;
};

UnifiedCache.prototype.delete = function(key) {
  this.cache.delete(key);
};

UnifiedCache.prototype.clear = function() {
  this.cache.clear();
};

UnifiedCache.prototype.getOrSet = function(key, fn, ttl) {
  if (ttl === undefined) ttl = 300000;
  const existing = this.get(key);
  if (existing !== undefined) {
    return Promise.resolve(existing);
  }
  const result = fn();
  if (result && typeof result.then === 'function') {
    const self = this;
    return result.then(function(value) {
      self.set(key, value, ttl);
      return value;
    });
  } else {
    this.set(key, result, ttl);
    return Promise.resolve(result);
  }
};
</script>
