<script>
/**
 * AdminPanel Security Monitoring UI Module
 * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºæ©Ÿèƒ½
 */

'use strict';

// =============================================================================
// SECURITY MONITORING UI
// =============================================================================

window.AdminPanelMonitoring = (function() {
  'use strict';
  
  let monitoringTimer = null;
  let isMonitorVisible = false;
  
  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–UIã®æ›´æ–°
   */
  function updateSecurityMonitor() {
    const monitorTenant = document.getElementById('monitor-tenant');
    const monitorSession = document.getElementById('monitor-session');
    const monitorIntegrity = document.getElementById('monitor-integrity');
    
    if (!monitorTenant || !monitorSession || !monitorIntegrity) {
      return;
    }
    
    const stats = window.AdminPanelSecurity?.getStats();
    if (!stats || stats.error) {
      console.warn('âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµ±è¨ˆå–å¾—å¤±æ•—:', stats?.error);
      return;
    }
    
    // ãƒ†ãƒŠãƒ³ãƒˆçŠ¶æ…‹æ›´æ–°
    if (stats.userId && stats.userId !== 'unknown') {
      monitorTenant.textContent = stats.userId;
      monitorTenant.className = 'text-green-400';
    } else {
      monitorTenant.textContent = 'ERROR';
      monitorTenant.className = 'text-red-400';
    }
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹æ›´æ–°
    if (stats.sessionId && stats.sessionId !== 'unknown') {
      const shortSessionId = stats.sessionId.substring(0, 12) + '...';
      monitorSession.textContent = shortSessionId;
      monitorSession.className = 'text-green-400';
    } else {
      monitorSession.textContent = 'INVALID';
      monitorSession.className = 'text-red-400';
    }
    
    // æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    const urlUserId = window.SECURE_URL_USER_ID;
    const frameworkUserId = window.userId;
    const isIntegrityOk = !frameworkUserId || urlUserId === frameworkUserId;
    
    if (isIntegrityOk && stats.violations === 0) {
      monitorIntegrity.textContent = 'OK';
      monitorIntegrity.className = 'text-green-400';
    } else if (stats.violations > 0) {
      monitorIntegrity.textContent = `WARN(${stats.violations})`;
      monitorIntegrity.className = 'text-yellow-400';
    } else {
      monitorIntegrity.textContent = 'VIOLATION';
      monitorIntegrity.className = 'text-red-400';
      console.error('ğŸš¨ Integrity violation detected in security monitor');
    }
    
    // ç›£è¦–ãƒ‘ãƒãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºï¼‰
    const monitorTitle = document.querySelector('#security-monitor .font-semibold');
    if (monitorTitle && stats.securityLevel) {
      monitorTitle.textContent = `ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦– (${stats.securityLevel})`;
    }
  }
  
  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ‡æ›¿
   */
  function toggleSecurityMonitor() {
    const monitor = document.getElementById('security-monitor');
    if (!monitor) {
      console.warn('âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ‘ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    isMonitorVisible = !isMonitorVisible;
    monitor.style.display = isMonitorVisible ? 'block' : 'none';
    
    if (isMonitorVisible) {
      updateSecurityMonitor();
      startMonitoringTimer();
      console.log('ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ‘ãƒãƒ«è¡¨ç¤º');
    } else {
      stopMonitoringTimer();
      console.log('ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ‘ãƒãƒ«éè¡¨ç¤º');
    }
  }
  
  /**
   * ç›£è¦–ã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹
   */
  function startMonitoringTimer() {
    if (monitoringTimer) {
      clearInterval(monitoringTimer);
    }
    
    monitoringTimer = setInterval(updateSecurityMonitor, 5000); // 5ç§’ã”ã¨
  }
  
  /**
   * ç›£è¦–ã‚¿ã‚¤ãƒãƒ¼ã®åœæ­¢
   */
  function stopMonitoringTimer() {
    if (monitoringTimer) {
      clearInterval(monitoringTimer);
      monitoringTimer = null;
    }
  }
  
  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã®è¡¨ç¤º
   */
  function showSecurityAlert(message, type = 'warning') {
    const alertContainer = document.getElementById('message-area');
    if (!alertContainer) {
      console.error('Alert container not found');
      return;
    }
    
    const alertId = 'security-alert-' + Date.now();
    const alertColors = {
      error: 'bg-red-900 border-red-500 text-red-100',
      warning: 'bg-yellow-900 border-yellow-500 text-yellow-100',
      info: 'bg-blue-900 border-blue-500 text-blue-100'
    };
    
    const alertHtml = `
      <div id="${alertId}" class="mb-3 p-4 rounded-lg border-l-4 ${alertColors[type] || alertColors.warning}">
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 19c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          <div class="flex-1">
            <p class="text-sm font-medium">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£${type === 'error' ? 'ã‚¨ãƒ©ãƒ¼' : type === 'warning' ? 'è­¦å‘Š' : 'é€šçŸ¥'}</p>
            <p class="text-sm">${message}</p>
          </div>
          <button onclick="document.getElementById('${alertId}').remove()" class="ml-3 text-sm hover:opacity-75">
            Ã—
          </button>
        </div>
      </div>
    `;
    
    alertContainer.insertAdjacentHTML('afterbegin', alertHtml);
    
    // 10ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.remove();
      }
    }, 10000);
  }
  
  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤º
   */
  function displaySecurityStatus() {
    const stats = window.AdminPanelSecurity?.getStats();
    if (!stats || stats.error) {
      showSecurityAlert('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      return;
    }
    
    const statusMessage = `
      ã‚»ãƒƒã‚·ãƒ§ãƒ³: ${stats.sessionId}<br>
      ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${stats.userId}<br>
      é•åæ•°: ${stats.violations}<br>
      æœ€çµ‚æ¤œè¨¼: ${stats.lastValidation}<br>
      ç¨¼åƒæ™‚é–“: ${Math.round(stats.uptime / 1000)}ç§’
    `;
    
    showSecurityAlert(statusMessage, 'info');
  }
  
  /**
   * ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºç›£è¦–æ©Ÿèƒ½ã®åˆæœŸåŒ–
   */
  function initializeEnterpriseMonitoring() {
    // Ctrl+Shift+S ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ãƒ‹ã‚¿ãƒ¼è¡¨ç¤ºåˆ‡æ›¿
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.shiftKey && event.key === 'S') {
        event.preventDefault();
        toggleSecurityMonitor();
      }
    });
    
    // Ctrl+Shift+D ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.shiftKey && event.key === 'D') {
        event.preventDefault();
        displaySecurityStatus();
      }
    });
    
    // é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    console.log('%cğŸ”’ AdminPanel Enterprise Security Monitor', 'color: #10b981; font-weight: bold; font-size: 14px;');
    console.log('%cã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ:', 'color: #6b7280; font-weight: bold;');
    console.log('%c  Ctrl+Shift+S: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ‡æ›¿', 'color: #6b7280;');
    console.log('%c  Ctrl+Shift+D: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º', 'color: #6b7280;');
    
    console.log('âœ… Enterprise Security Monitoring åˆæœŸåŒ–å®Œäº†');
  }
  
  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é•åæ™‚ã®ç·Šæ€¥å¯¾å¿œ
   */
  function handleSecurityEmergency(violationType, details) {
    // ç›£è¦–ãƒ‘ãƒãƒ«ã‚’è‡ªå‹•è¡¨ç¤º
    if (!isMonitorVisible) {
      toggleSecurityMonitor();
    }
    
    // ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    showSecurityAlert(`ç·Šæ€¥: ${violationType} ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ`, 'error');
    
    // ç›£è¦–ãƒ‘ãƒãƒ«ã‚’å¼·èª¿è¡¨ç¤º
    const monitor = document.getElementById('security-monitor');
    if (monitor) {
      monitor.style.borderColor = '#ef4444';
      monitor.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.5)';
      
      // 5ç§’å¾Œã«å…ƒã«æˆ»ã™
      setTimeout(() => {
        monitor.style.borderColor = '#ef4444';
        monitor.style.boxShadow = '';
      }, 5000);
    }
    
    console.error('ğŸš¨ Security Emergency Handler triggered:', violationType, details);
  }
  
  // å…¬é–‹API
  return {
    init: initializeEnterpriseMonitoring,
    toggle: toggleSecurityMonitor,
    update: updateSecurityMonitor,
    showAlert: showSecurityAlert,
    showStatus: displaySecurityStatus,
    handleEmergency: handleSecurityEmergency
  };
})();

// =============================================================================
// AUTO INITIALIZATION
// =============================================================================

/**
 * ç›£è¦–UIã®è‡ªå‹•åˆæœŸåŒ–
 */
(function autoInitializeMonitoring() {
  'use strict';
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      window.AdminPanelMonitoring.init();
    });
  } else {
    window.AdminPanelMonitoring.init();
  }
})();

console.log('ğŸ“¦ AdminPanel Monitoring Module loaded');
</script>