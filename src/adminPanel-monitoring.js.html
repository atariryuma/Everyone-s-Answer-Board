<script>
/**
 * AdminPanel Security Monitoring UI Module
 * セキュリティ監視とリアルタイム表示機能
 */

'use strict';

// =============================================================================
// SECURITY MONITORING UI
// =============================================================================

window.AdminPanelMonitoring = (function() {
  'use strict';
  
  let monitoringTimer = null;
  let isMonitorVisible = false;
  
  /**
   * セキュリティ監視UIの更新
   */
  function updateSecurityMonitor() {
    const monitorTenant = document.getElementById('monitor-tenant');
    const monitorSession = document.getElementById('monitor-session');
    const monitorIntegrity = document.getElementById('monitor-integrity');
    
    if (!monitorTenant || !monitorSession || !monitorIntegrity) {
      return;
    }
    
    const stats = window.AdminPanelSecurity?.getStats();
    if (!stats || stats.error) {
      console.warn('⚠️ セキュリティ統計取得失敗:', stats?.error);
      return;
    }
    
    // テナント状態更新
    if (stats.userId && stats.userId !== 'unknown') {
      monitorTenant.textContent = stats.userId;
      monitorTenant.className = 'text-green-400';
    } else {
      monitorTenant.textContent = 'ERROR';
      monitorTenant.className = 'text-red-400';
    }
    
    // セッション状態更新
    if (stats.sessionId && stats.sessionId !== 'unknown') {
      const shortSessionId = stats.sessionId.substring(0, 12) + '...';
      monitorSession.textContent = shortSessionId;
      monitorSession.className = 'text-green-400';
    } else {
      monitorSession.textContent = 'INVALID';
      monitorSession.className = 'text-red-400';
    }
    
    // 整合性チェック
    const urlUserId = window.SECURE_URL_USER_ID;
    const frameworkUserId = window.userId;
    const isIntegrityOk = !frameworkUserId || urlUserId === frameworkUserId;
    
    if (isIntegrityOk && stats.violations === 0) {
      monitorIntegrity.textContent = 'OK';
      monitorIntegrity.className = 'text-green-400';
    } else if (stats.violations > 0) {
      monitorIntegrity.textContent = `WARN(${stats.violations})`;
      monitorIntegrity.className = 'text-yellow-400';
    } else {
      monitorIntegrity.textContent = 'VIOLATION';
      monitorIntegrity.className = 'text-red-400';
      console.error('🚨 Integrity violation detected in security monitor');
    }
    
    // 監視パネルのタイトル更新（セキュリティレベル表示）
    const monitorTitle = document.querySelector('#security-monitor .font-semibold');
    if (monitorTitle && stats.securityLevel) {
      monitorTitle.textContent = `セキュリティ監視 (${stats.securityLevel})`;
    }
  }
  
  /**
   * セキュリティ監視パネルの表示切替
   */
  function toggleSecurityMonitor() {
    const monitor = document.getElementById('security-monitor');
    if (!monitor) {
      console.warn('⚠️ セキュリティ監視パネルが見つかりません');
      return;
    }
    
    isMonitorVisible = !isMonitorVisible;
    monitor.style.display = isMonitorVisible ? 'block' : 'none';
    
    if (isMonitorVisible) {
      updateSecurityMonitor();
      startMonitoringTimer();
      console.log('🔒 セキュリティ監視パネル表示');
    } else {
      stopMonitoringTimer();
      console.log('🔒 セキュリティ監視パネル非表示');
    }
  }
  
  /**
   * 監視タイマーの開始
   */
  function startMonitoringTimer() {
    if (monitoringTimer) {
      clearInterval(monitoringTimer);
    }
    
    monitoringTimer = setInterval(updateSecurityMonitor, 5000); // 5秒ごと
  }
  
  /**
   * 監視タイマーの停止
   */
  function stopMonitoringTimer() {
    if (monitoringTimer) {
      clearInterval(monitoringTimer);
      monitoringTimer = null;
    }
  }
  
  /**
   * セキュリティアラートの表示
   */
  function showSecurityAlert(message, type = 'warning') {
    const alertContainer = document.getElementById('message-area');
    if (!alertContainer) {
      console.error('Alert container not found');
      return;
    }
    
    const alertId = 'security-alert-' + Date.now();
    const alertColors = {
      error: 'bg-red-900 border-red-500 text-red-100',
      warning: 'bg-yellow-900 border-yellow-500 text-yellow-100',
      info: 'bg-blue-900 border-blue-500 text-blue-100'
    };
    
    const alertHtml = `
      <div id="${alertId}" class="mb-3 p-4 rounded-lg border-l-4 ${alertColors[type] || alertColors.warning}">
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 19c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          <div class="flex-1">
            <p class="text-sm font-medium">セキュリティ${type === 'error' ? 'エラー' : type === 'warning' ? '警告' : '通知'}</p>
            <p class="text-sm">${message}</p>
          </div>
          <button onclick="document.getElementById('${alertId}').remove()" class="ml-3 text-sm hover:opacity-75">
            ×
          </button>
        </div>
      </div>
    `;
    
    alertContainer.insertAdjacentHTML('afterbegin', alertHtml);
    
    // 10秒後に自動削除
    setTimeout(() => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.remove();
      }
    }, 10000);
  }
  
  /**
   * セキュリティステータスの表示
   */
  function displaySecurityStatus() {
    const stats = window.AdminPanelSecurity?.getStats();
    if (!stats || stats.error) {
      showSecurityAlert('セキュリティ状態の取得に失敗しました', 'error');
      return;
    }
    
    const statusMessage = `
      セッション: ${stats.sessionId}<br>
      ユーザー: ${stats.userId}<br>
      違反数: ${stats.violations}<br>
      最終検証: ${stats.lastValidation}<br>
      稼働時間: ${Math.round(stats.uptime / 1000)}秒
    `;
    
    showSecurityAlert(statusMessage, 'info');
  }
  
  /**
   * エンタープライズ監視機能の初期化
   */
  function initializeEnterpriseMonitoring() {
    // Ctrl+Shift+S でセキュリティモニター表示切替
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.shiftKey && event.key === 'S') {
        event.preventDefault();
        toggleSecurityMonitor();
      }
    });
    
    // Ctrl+Shift+D でセキュリティステータス表示
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.shiftKey && event.key === 'D') {
        event.preventDefault();
        displaySecurityStatus();
      }
    });
    
    // 開発者ツールでコンソールに警告メッセージ表示
    console.log('%c🔒 AdminPanel Enterprise Security Monitor', 'color: #10b981; font-weight: bold; font-size: 14px;');
    console.log('%cキーボードショートカット:', 'color: #6b7280; font-weight: bold;');
    console.log('%c  Ctrl+Shift+S: セキュリティ監視パネル表示切替', 'color: #6b7280;');
    console.log('%c  Ctrl+Shift+D: セキュリティステータス表示', 'color: #6b7280;');
    
    console.log('✅ Enterprise Security Monitoring 初期化完了');
  }
  
  /**
   * セキュリティ違反時の緊急対応
   */
  function handleSecurityEmergency(violationType, details) {
    // 監視パネルを自動表示
    if (!isMonitorVisible) {
      toggleSecurityMonitor();
    }
    
    // 緊急アラート表示
    showSecurityAlert(`緊急: ${violationType} が検出されました`, 'error');
    
    // 監視パネルを強調表示
    const monitor = document.getElementById('security-monitor');
    if (monitor) {
      monitor.style.borderColor = '#ef4444';
      monitor.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.5)';
      
      // 5秒後に元に戻す
      setTimeout(() => {
        monitor.style.borderColor = '#ef4444';
        monitor.style.boxShadow = '';
      }, 5000);
    }
    
    console.error('🚨 Security Emergency Handler triggered:', violationType, details);
  }
  
  // 公開API
  return {
    init: initializeEnterpriseMonitoring,
    toggle: toggleSecurityMonitor,
    update: updateSecurityMonitor,
    showAlert: showSecurityAlert,
    showStatus: displaySecurityStatus,
    handleEmergency: handleSecurityEmergency
  };
})();

// =============================================================================
// AUTO INITIALIZATION
// =============================================================================

/**
 * 監視UIの自動初期化
 */
(function autoInitializeMonitoring() {
  'use strict';
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      window.AdminPanelMonitoring.init();
    });
  } else {
    window.AdminPanelMonitoring.init();
  }
})();

console.log('📦 AdminPanel Monitoring Module loaded');
</script>