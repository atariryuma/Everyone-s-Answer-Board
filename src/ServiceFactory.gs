/**
 * @fileoverview ServiceFactory - Áµ±‰∏Ä„Çµ„Éº„Éì„Çπ„Ç¢„ÇØ„Çª„ÇπÂ±§
 *
 * üéØ Ë≤¨‰ªªÁØÑÂõ≤:
 * - GAS Platform API„Å∏„ÅÆÁµ±‰∏Ä„Ç¢„ÇØ„Çª„Çπ
 * - ‰æùÂ≠òÈñ¢‰øÇ„ÅÆÈô§Âéª„Å®„Çº„É≠‰æùÂ≠ò„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£
 * - „Çµ„Éº„Éì„ÇπË™≠„ÅøËæº„ÅøÈ†ÜÂ∫èÂïèÈ°å„ÅÆËß£Ê±∫
 * - „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ
 *
 * üîÑ GAS Best PracticesÊ∫ñÊã†:
 * - Áõ¥Êé•Platform APIÂà©Áî®
 * - ‰æùÂ≠òÈñ¢‰øÇ„Å™„Åó„ÅÆËá™Â∑±ÂÆåÁµêÂûã
 * - „Ç®„É©„ÉºÂá¶ÁêÜ„Å®„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÊ©üËÉΩ
 */

/* global DB, DatabaseOperations */

/**
 * ServiceFactory - „Çº„É≠‰æùÂ≠ò„Çµ„Éº„Éì„Çπ„Ç¢„ÇØ„Çª„ÇπÂ±§
 * GAS„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÈ†ÜÂ∫è„Å´‰æùÂ≠ò„Åó„Å™„ÅÑÂ†ÖÁâ¢„Å™„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£
 */
const ServiceFactory = Object.freeze({

  // ===========================================
  // üîß Database Operations
  // ===========================================

  /**
   * „Éá„Éº„Çø„Éô„Éº„ÇπÊìç‰Ωú„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂèñÂæó
   * @returns {Object|null} DatabaseOperations or fallback
   */
  getDB() {
    try {
      // Method 1: „Ç∞„É≠„Éº„Éê„É´DBÂ§âÊï∞
      if (typeof DB !== 'undefined' && DB) {
        return DB;
      }

      // Method 2: DatabaseOperationsÁõ¥Êé•ÂèÇÁÖß
      if (typeof DatabaseOperations !== 'undefined') {
        return DatabaseOperations;
      }

      // Method 3: Fallback - null return
      console.warn('ServiceFactory.getDB: Database service not available');
      return null;
    } catch (error) {
      console.error('ServiceFactory.getDB error:', error.message);
      return null;
    }
  },

  // ===========================================
  // üîê Session Management
  // ===========================================

  /**
   * ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±ÂèñÂæó
   * @returns {Object} Session information
   */
  getSession() {
    try {
      const session = {
        email: null,
        effectiveEmail: null,
        isValid: false
      };

      // Primary method: Session.getActiveUser()
      try {
        session.email = Session.getActiveUser().getEmail();
        if (session.email) {
          session.isValid = true;
        }
      } catch (activeError) {
        console.warn('ServiceFactory.getSession: getActiveUser failed:', activeError.message);
      }

      // Fallback method: Session.getEffectiveUser()
      if (!session.email) {
        try {
          session.effectiveEmail = Session.getEffectiveUser().getEmail();
          if (session.effectiveEmail) {
            session.email = session.effectiveEmail;
            session.isValid = true;
          }
        } catch (effectiveError) {
          console.warn('ServiceFactory.getSession: getEffectiveUser failed:', effectiveError.message);
        }
      }

      return session;
    } catch (error) {
      console.error('ServiceFactory.getSession error:', error.message);
      return { email: null, effectiveEmail: null, isValid: false };
    }
  },

  // ===========================================
  // ‚öôÔ∏è Properties Management
  // ===========================================

  /**
   * „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„Éë„ÉÜ„Ç£ÁÆ°ÁêÜ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂèñÂæó
   * @returns {Object} Properties service wrapper
   */
  getProperties() {
    try {
      const props = PropertiesService.getScriptProperties();

      return {
        get: (key) => {
          try {
            return props.getProperty(key);
          } catch (error) {
            console.error(`ServiceFactory.getProperties.get(${key}):`, error.message);
            return null;
          }
        },

        set: (key, value) => {
          try {
            props.setProperty(key, value);
            return true;
          } catch (error) {
            console.error(`ServiceFactory.getProperties.set(${key}):`, error.message);
            return false;
          }
        },

        getAll: () => {
          try {
            return props.getProperties();
          } catch (error) {
            console.error('ServiceFactory.getProperties.getAll:', error.message);
            return {};
          }
        },

        // Áõ¥Êé•ÂÄ§ÂèñÂæóÔºàÂÆöÊï∞„Ç§„É≥„É©„Ç§„É≥ÂåñÔºâ
        getServiceAccountCreds: () => props.getProperty('SERVICE_ACCOUNT_CREDS'),
        getDatabaseSpreadsheetId: () => props.getProperty('DATABASE_SPREADSHEET_ID'),
        getAdminEmail: () => props.getProperty('ADMIN_EMAIL'),
        getGoogleClientId: () => props.getProperty('GOOGLE_CLIENT_ID')
      };
    } catch (error) {
      console.error('ServiceFactory.getProperties error:', error.message);
      return {
        get: () => null,
        set: () => false,
        getAll: () => ({}),
        getServiceAccountCreds: () => null,
        getDatabaseSpreadsheetId: () => null,
        getAdminEmail: () => null,
        getGoogleClientId: () => null
      };
    }
  },

  // ===========================================
  // üóÑÔ∏è Cache Management
  // ===========================================

  /**
   * „Ç≠„É£„ÉÉ„Ç∑„É•„Çµ„Éº„Éì„ÇπÁÆ°ÁêÜ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂèñÂæó
   * @returns {Object} Cache service wrapper
   */
  getCache() {
    try {
      const cache = CacheService.getScriptCache();

      return {
        get: (key, defaultValue = null) => {
          try {
            const cached = cache.get(key);
            return cached ? JSON.parse(cached) : defaultValue;
          } catch (error) {
            console.warn(`ServiceFactory.getCache.get(${key}):`, error.message);
            return defaultValue;
          }
        },

        put: (key, value, ttlSeconds = 300) => {
          try {
            cache.put(key, JSON.stringify(value), ttlSeconds);
            return true;
          } catch (error) {
            console.error(`ServiceFactory.getCache.put(${key}):`, error.message);
            return false;
          }
        },

        remove: (key) => {
          try {
            cache.remove(key);
            return true;
          } catch (error) {
            console.error(`ServiceFactory.getCache.remove(${key}):`, error.message);
            return false;
          }
        },

        removeAll: () => {
          try {
            cache.removeAll();
            return true;
          } catch (error) {
            console.error('ServiceFactory.getCache.removeAll:', error.message);
            return false;
          }
        }
      };
    } catch (error) {
      console.error('ServiceFactory.getCache error:', error.message);
      return {
        get: () => null,
        put: () => false,
        remove: () => false,
        removeAll: () => false
      };
    }
  },

  // ===========================================
  // üìä Spreadsheet Operations
  // ===========================================

  /**
   * „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊìç‰Ωú„Éò„É´„Éë„Éº
   * @returns {Object} Spreadsheet operations wrapper
   */
  getSpreadsheet() {
    return {
      openById: (spreadsheetId) => {
        try {
          return SpreadsheetApp.openById(spreadsheetId);
        } catch (error) {
          console.error(`ServiceFactory.getSpreadsheet.openById(${spreadsheetId}):`, error.message);
          return null;
        }
      },

      getActiveSpreadsheet: () => {
        try {
          return SpreadsheetApp.getActiveSpreadsheet();
        } catch (error) {
          console.warn('ServiceFactory.getSpreadsheet.getActiveSpreadsheet:', error.message);
          return null;
        }
      }
    };
  },

  // ===========================================
  // üîß Utility Functions
  // ===========================================

  /**
   * „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞Áæ§
   * @returns {Object} Utility functions
   */
  getUtils() {
    return {
      generateUserId: () => {
        return Utilities.getUuid();
      },

      getCurrentTimestamp: () => {
        return new Date().toISOString();
      },

      validateEmail: (email) => {
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return emailRegex.test(email);
      },

      sanitizeInput: (input) => {
        if (typeof input !== 'string') return '';
        return input.replace(/[<>&"']/g, '');
      }
    };
  },

  // ===========================================
  // üè• Health Check & Diagnostics
  // ===========================================

  /**
   * „Çµ„Éº„Éì„ÇπË®∫Êñ≠ÊÉÖÂ†±
   * @returns {Object} Diagnostic information
   */
  diagnose() {
    const startTime = Date.now();

    const diagnostics = {
      timestamp: new Date().toISOString(),
      factory: 'ServiceFactory',
      version: '1.0.0',
      services: {},
      platform: {},
      executionTime: 0
    };

    try {
      // Database service check
      diagnostics.services.database = {
        available: this.getDB() !== null,
        type: typeof DB !== 'undefined' ? 'Global' :
              typeof DatabaseOperations !== 'undefined' ? 'Direct' : 'None'
      };

      // Session service check
      const session = this.getSession();
      diagnostics.services.session = {
        available: session.isValid,
        email: session.email ? 'Available' : 'None'
      };

      // Properties service check
      const props = this.getProperties();
      diagnostics.services.properties = {
        available: props.getAdminEmail() !== null
      };

      // Cache service check
      const cache = this.getCache();
      const testKey = `test_key_${  Date.now()}`;
      cache.put(testKey, 'test', 10);
      const testResult = cache.get(testKey);
      cache.remove(testKey);
      diagnostics.services.cache = {
        available: testResult === 'test'
      };

      // Platform APIs check
      diagnostics.platform = {
        session: typeof Session !== 'undefined',
        properties: typeof PropertiesService !== 'undefined',
        cache: typeof CacheService !== 'undefined',
        spreadsheet: typeof SpreadsheetApp !== 'undefined',
        utilities: typeof Utilities !== 'undefined'
      };

    } catch (error) {
      diagnostics.error = error.message;
    }

    diagnostics.executionTime = `${Date.now() - startTime}ms`;
    return diagnostics;
  }

});

// ===========================================
// üåê „Ç∞„É≠„Éº„Éê„É´ Export
// ===========================================

/**
 * „É¨„Ç¨„Ç∑„Éº‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„ÅÆ„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
 * Êó¢Â≠ò„Ç≥„Éº„Éâ„ÅÆÊÆµÈöéÁöÑÁßªË°å„ÇíÊîØÊè¥
 */

/**
 * ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„É°„Éº„É´ÂèñÂæóÔºàServiceFactoryÁâàÔºâ
 * @returns {string|null} User email
 */
function getCurrentEmailFromFactory() {
  return ServiceFactory.getSession().email;
}

/**
 * „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„Éë„ÉÜ„Ç£ÂèñÂæóÔºàServiceFactoryÁâàÔºâ
 * @param {string} key - Property key
 * @returns {string|null} Property value
 */
function getSystemPropertyFromFactory(key) {
  return ServiceFactory.getProperties().get(key);
}

/**
 * „Éá„Éº„Çø„Éô„Éº„ÇπÊìç‰ΩúÂèñÂæóÔºàServiceFactoryÁâàÔºâ
 * @returns {Object|null} Database operations
 */
function getDatabaseFromFactory() {
  return ServiceFactory.getDB();
}