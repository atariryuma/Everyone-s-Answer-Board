<script>
/* =============================================================================
   StudyQuest - Setup Page Logic
   Extracted from SetupPage.html for better maintainability
   Handles system setup, validation, and testing functionality
   ============================================================================= */

// =============================================================================
// SETUP STATE MANAGEMENT
// =============================================================================

let setupInProgress = false;

// =============================================================================
// VALIDATION FUNCTIONS
// =============================================================================

/**
 * Validate service account JSON format
 * @param {string} jsonString - JSON string to validate
 * @returns {boolean} True if valid
 * @throws {Error} If validation fails
 */
function validateJSON(jsonString) {
  try {
    const parsed = JSON.parse(jsonString);
    const required = ['type', 'project_id', 'private_key_id', 'private_key', 'client_email'];
    
    for (const field of required) {
      if (!parsed[field]) {
        throw new Error(`必須フィールド '${field}' が見つかりません`);
      }
    }
    
    if (parsed.type !== 'service_account') {
      throw new Error('サービスアカウントタイプのJSONである必要があります');
    }
    
    return true;
  } catch (e) {
    throw new Error(`JSON形式が無効です: ${e.message}`);
  }
}

/**
 * Validate spreadsheet ID format
 * @param {string} id - Spreadsheet ID to validate
 * @returns {boolean} True if valid
 * @throws {Error} If validation fails
 */
function validateSpreadsheetId(id) {
  if (!id || id.length !== 44) {
    throw new Error('スプレッドシートIDは44文字である必要があります');
  }
  
  if (!/^[a-zA-Z0-9_-]+$/.test(id)) {
    throw new Error('スプレッドシートIDに無効な文字が含まれています');
  }
  
  return true;
}

// =============================================================================
// SETUP FORM HANDLING
// =============================================================================

/**
 * Handle setup form submission
 * @param {Event} e - Form submit event
 */
async function handleSetupSubmission(e) {
  e.preventDefault();
  
  if (setupInProgress) return;
  setupInProgress = true;

  const setupBtn = document.getElementById('setup-btn');
  const setupText = document.getElementById('setup-text');
  const setupSpinner = document.getElementById('setup-spinner');
  
  try {
    // Update button state
    if (setupBtn) setupBtn.disabled = true;
    if (setupText) setupText.style.display = 'none';
    if (setupSpinner) setupSpinner.classList.remove('hidden');
    
    // Get input values
    const serviceAccountJsonEl = document.getElementById('service-account-json');
    const databaseIdEl = document.getElementById('database-id');
    
    const serviceAccountJson = serviceAccountJsonEl ? serviceAccountJsonEl.value.trim() : '';
    const databaseId = databaseIdEl ? databaseIdEl.value.trim() : '';
    
    // Validate inputs
    validateJSON(serviceAccountJson);
    validateSpreadsheetId(databaseId);
    
    // Show progress message
    if (window.sharedUtilities && window.sharedUtilities.message) {
      window.sharedUtilities.message.show('セットアップを実行中...', 'info');
    } else {
      showMessage('セットアップを実行中...', 'info');
    }
    
    // Execute setup via GAS
    await new Promise((resolve, reject) => {
      if (window.sharedUtilities && window.sharedUtilities.gas && window.sharedUtilities.gas.call) {
        try {
          window.sharedUtilities.gas.call(
            'setupApplication',
            function(result) {
              if (window.sharedUtilities && window.sharedUtilities.message) {
                window.sharedUtilities.message.show('✅ セットアップが正常に完了しました！', 'success');
              } else {
                showMessage('✅ セットアップが正常に完了しました！', 'success');
              }
              
              // Show test section
              const testSection = document.getElementById('test-section');
              if (testSection) testSection.classList.remove('hidden');
              
              resolve(result);
            },
            function(error) {
              console.error('Setup error:', error);
              let displayMessage = `❌ セットアップに失敗しました: ${error.message || error}`;
              
              if (error.message && error.message.includes('スプレッドシートの共有設定が「制限付き」になっていません')) {
                displayMessage = `
                  <p class="font-bold">${error.message}</p>
                  <p class="mt-2">セキュリティのため、データベースとして使用するスプレッドシートの共有設定を「制限付き」に変更してください。</p>
                  <p>変更方法: スプレッドシートを開き、「共有」ボタン → 「一般的なアクセス」を「制限付き」に変更。</p>
                `;
              }
              
              if (window.sharedUtilities && window.sharedUtilities.message) {
                window.sharedUtilities.message.show(displayMessage, 'error');
              } else {
                showMessage(displayMessage, 'error');
              }
              
              reject(error);
            },
            [serviceAccountJson, databaseId],
            'アプリケーションセットアップ'
          );
        } catch (utilityError) {
          console.error('SharedUtilities call error:', utilityError);
          reject(new Error('共有ユーティリティの呼び出しに失敗しました: ' + utilityError.message));
        }
      } else {
        // Fallback to direct GAS call
        try {
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler((result) => {
                showMessage('✅ セットアップが正常に完了しました！', 'success');
                const testSection = document.getElementById('test-section');
                if (testSection) testSection.classList.remove('hidden');
                resolve(result);
              })
              .withFailureHandler((error) => {
                console.error('Setup error:', error);
                let displayMessage = `❌ セットアップに失敗しました: ${error.message || error}`;
                
                if (error.message && error.message.includes('スプレッドシートの共有設定が「制限付き」になっていません')) {
                  displayMessage = `
                    <p class="font-bold">${error.message}</p>
                    <p class="mt-2">セキュリティのため、データベースとして使用するスプレッドシートの共有設定を「制限付き」に変更してください。</p>
                    <p>変更方法: スプレッドシートを開き、「共有」ボタン → 「一般的なアクセス」を「制限付き」に変更。</p>
                  `;
                }
                
                showMessage(displayMessage, 'error');
                reject(error);
              })
              .setupApplication(serviceAccountJson, databaseId);
          } else {
            reject(new Error('Google Apps Script環境が利用できません'));
          }
        } catch (gasError) {
          console.error('Direct GAS call error:', gasError);
          reject(new Error('Google Apps Scriptの呼び出しに失敗しました: ' + gasError.message));
        }
      }
    });
        
  } catch (error) {
    console.error('Setup submission error:', error);
    const message = `❌ ${error.message || 'セットアップ中に予期しないエラーが発生しました'}`;
    
    if (window.sharedUtilities && window.sharedUtilities.message) {
      window.sharedUtilities.message.show(message, 'error');
    } else {
      showMessage(message, 'error');
    }
  } finally {
    // Reset button state
    if (setupBtn) setupBtn.disabled = false;
    if (setupText) setupText.style.display = 'inline';
    if (setupSpinner) setupSpinner.classList.add('hidden');
    setupInProgress = false;
  }
}

// =============================================================================
// TEST FUNCTIONALITY
// =============================================================================

/**
 * Handle system test execution
 */
function handleSystemTest() {
  const testBtn = document.getElementById('test-btn');
  if (!testBtn) return;
  
  const originalContent = testBtn.innerHTML;
  testBtn.disabled = true;
  testBtn.innerHTML = '<div class="loading-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mx-auto"></div>';
  
  if (window.sharedUtilities && window.sharedUtilities.gas && window.sharedUtilities.gas.call) {
    try {
      window.sharedUtilities.gas.call(
        'testSetup',
        function(result) {
          const message = result.message;
          const type = result.status === 'success' ? 'success' : 'warning';
          
          if (window.sharedUtilities && window.sharedUtilities.message) {
            window.sharedUtilities.message.show(message, type);
          } else {
            showMessage(message, type);
          }
          
          testBtn.disabled = false;
          testBtn.innerHTML = originalContent;
        },
        function(error) {
          const message = `テスト実行に失敗しました: ${error.message || error}`;
          
          if (window.sharedUtilities && window.sharedUtilities.message) {
            window.sharedUtilities.message.show(message, 'error');
          } else {
            showMessage(message, 'error');
          }
          
          testBtn.disabled = false;
          testBtn.innerHTML = originalContent;
        },
        [],
        'システムテスト'
      );
    } catch (utilityError) {
      console.error('SharedUtilities call error:', utilityError);
      const message = '共有ユーティリティの呼び出しに失敗しました: ' + utilityError.message;
      
      if (window.sharedUtilities && window.sharedUtilities.message) {
        window.sharedUtilities.message.show(message, 'error');
      } else {
        showMessage(message, 'error');
      }
      
      testBtn.disabled = false;
      testBtn.innerHTML = originalContent;
    }
  } else {
    // Fallback to direct GAS call
    google.script.run
      .withSuccessHandler((result) => {
        showMessage(`${result.message}`, result.status === 'success' ? 'success' : 'warning');
        testBtn.disabled = false;
        testBtn.innerHTML = originalContent;
      })
      .withFailureHandler((error) => {
        showMessage(`テスト実行に失敗しました: ${error.message || error}`, 'error');
        testBtn.disabled = false;
        testBtn.innerHTML = originalContent;
      })
      .testSetup();
  }
}

// =============================================================================
// REAL-TIME VALIDATION
// =============================================================================

/**
 * Setup real-time validation for form fields
 */
function setupRealTimeValidation() {
  // JSON validation on blur
  const serviceAccountJsonEl = document.getElementById('service-account-json');
  if (serviceAccountJsonEl) {
    serviceAccountJsonEl.addEventListener('blur', function() {
      try {
        if (this.value.trim()) {
          validateJSON(this.value.trim());
          this.style.borderColor = '#10b981';
        }
      } catch (e) {
        this.style.borderColor = '#ef4444';
      }
    });
  }

  // Spreadsheet ID validation on input
  const databaseIdEl = document.getElementById('database-id');
  if (databaseIdEl) {
    databaseIdEl.addEventListener('input', function() {
      try {
        if (this.value.trim()) {
          validateSpreadsheetId(this.value.trim());
          this.style.borderColor = '#10b981';
        }
      } catch (e) {
        this.style.borderColor = '#ef4444';
      }
    });
  }
}

// =============================================================================
// APP NAVIGATION
// =============================================================================

/**
 * Start the StudyQuest application
 */
function startApp() {
  const btn = document.getElementById('start-studyquest-btn');
  if (btn) {
    btn.innerHTML = '<span>読み込み中...</span>';
    btn.disabled = true;
  }

  if (window.sharedUtilities && window.sharedUtilities.gas && window.sharedUtilities.gas.call) {
    try {
      window.sharedUtilities.gas.call(
        'getWebAppUrl',
        function(url) {
          if (window.sharedUtilities && window.sharedUtilities.navigation) {
            window.sharedUtilities.navigation.safeNavigate(url, {
              fallbackMessage: 'StudyQuestを開始中...',
              method: 'auto'
            });
          } else {
            window.location.href = url;
          }
        },
        function(error) {
          const errorMessage = 'アプリケーションのURL取得に失敗しました: ' + error.message;
          
          if (window.sharedUtilities && window.sharedUtilities.message) {
            window.sharedUtilities.message.show(errorMessage, 'error');
          } else {
            alert(errorMessage);
          }
          
          if (btn) {
            btn.innerHTML = '📚 StudyQuestを開始';
            btn.disabled = false;
          }
        },
        [],
        'URL取得'
      );
    } catch (utilityError) {
      console.error('SharedUtilities call error:', utilityError);
      const errorMessage = '共有ユーティリティの呼び出しに失敗しました: ' + utilityError.message;
      
      if (window.sharedUtilities && window.sharedUtilities.message) {
        window.sharedUtilities.message.show(errorMessage, 'error');
      } else {
        alert(errorMessage);
      }
      
      if (btn) {
        btn.innerHTML = '📚 StudyQuestを開始';
        btn.disabled = false;
      }
    }
  } else {
    // Fallback to direct GAS call
    google.script.run
      .withSuccessHandler(function(url) {
        if (window.sharedUtilities && window.sharedUtilities.navigation) {
          window.sharedUtilities.navigation.safeNavigate(url, {
            fallbackMessage: 'StudyQuestを開始中...',
            method: 'auto'
          });
        } else {
          window.location.href = url;
        }
      })
      .withFailureHandler(function(error) {
        const errorMessage = 'アプリケーションのURL取得に失敗しました: ' + error.message;
        alert(errorMessage);
        
        if (btn) {
          btn.innerHTML = '📚 StudyQuestを開始';
          btn.disabled = false;
        }
      })
      .getWebAppUrl();
  }
}

// =============================================================================
// BACKWARD COMPATIBILITY FUNCTIONS
// =============================================================================

/**
 * Legacy message display function for backward compatibility
 * @param {string} message - Message to display
 * @param {string} type - Message type
 */
function showMessage(message, type = 'info') {
  if (window.sharedUtilities && window.sharedUtilities.message) {
    window.sharedUtilities.message.show(message, type);
    return;
  }
  
  // Fallback for legacy support
  const messageArea = document.getElementById('message-area');
  if (!messageArea) return;
  
  const colors = {
    success: 'bg-green-600/20 border-green-500/50 text-green-100',
    error: 'bg-red-600/20 border-red-500/50 text-red-100',
    warning: 'bg-yellow-600/20 border-yellow-500/50 text-yellow-100',
    info: 'bg-blue-600/20 border-blue-500/50 text-blue-100'
  };
  
  const icons = {
    success: '✅',
    error: '❌',
    warning: '⚠️',
    info: 'ℹ️'
  };
  
  messageArea.innerHTML = `
    <div class="message show glass-panel rounded-lg p-4 border ${colors[type]}">
      <div class="flex items-center">
        <div class="mr-3">${icons[type]}</div>
        <div class="flex-1">${message}</div>
        <button onclick="this.closest('.message').style.display='none'" class="ml-4 text-gray-400 hover:text-white">✕</button>
      </div>
    </div>
  `;
}

// =============================================================================
// EVENT LISTENERS SETUP
// =============================================================================

/**
 * Setup all event listeners for the setup page
 */
function setupEventListeners() {
  // Setup form submission
  const setupForm = document.getElementById('setup-form');
  if (setupForm) {
    setupForm.addEventListener('submit', handleSetupSubmission);
  }
  
  // Test button
  const testBtn = document.getElementById('test-btn');
  if (testBtn) {
    testBtn.addEventListener('click', handleSystemTest);
  }
  
  // Real-time validation
  setupRealTimeValidation();
  
  console.log('Setup page event listeners initialized');
}

// =============================================================================
// INITIALIZATION
// =============================================================================

/**
 * Initialize setup page functionality
 */
function initializeSetupPage() {
  console.log('🔧 Initializing Setup Page Logic...');
  
  // Setup event listeners
  setupEventListeners();
  
  console.log('✅ Setup Page Logic initialized');
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeSetupPage);
} else {
  initializeSetupPage();
}

// =============================================================================
// EXPORT TO GLOBAL SCOPE
// =============================================================================

// Export setup utilities to global scope
window.setupUtilities = {
  state: {
    setupInProgress: () => setupInProgress
  },
  validation: {
    validateJSON: validateJSON,
    validateSpreadsheetId: validateSpreadsheetId
  },
  form: {
    handleSubmission: handleSetupSubmission,
    setupValidation: setupRealTimeValidation
  },
  test: {
    execute: handleSystemTest
  },
  navigation: {
    startApp: startApp
  },
  legacy: {
    showMessage: showMessage
  }
};

</script>