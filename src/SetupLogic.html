<script>
/* =============================================================================
   StudyQuest - Setup Page Logic
   Extracted from SetupPage.html for better maintainability
   Handles system setup, validation, and testing functionality
   ============================================================================= */

// =============================================================================
// SETUP STATE MANAGEMENT
// =============================================================================

let setupInProgress = false;

// =============================================================================
// VALIDATION FUNCTIONS
// =============================================================================

/**
 * Validate service account JSON format
 * @param {string} jsonString - JSON string to validate
 * @returns {boolean} True if valid
 * @throws {Error} If validation fails
 */
function validateJSON(jsonString) {
  try {
    const parsed = JSON.parse(jsonString);
    const required = ['type', 'project_id', 'private_key_id', 'private_key', 'client_email'];
    
    for (const field of required) {
      if (!parsed[field]) {
        throw new Error(`å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ '${field}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
      }
    }
    
    if (parsed.type !== 'service_account') {
      throw new Error('ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã®JSONã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
    }
    
    return true;
  } catch (e) {
    throw new Error(`JSONå½¢å¼ãŒç„¡åŠ¹ã§ã™: ${e.message}`);
  }
}

/**
 * Validate spreadsheet ID format
 * @param {string} id - Spreadsheet ID to validate
 * @returns {boolean} True if valid
 * @throws {Error} If validation fails
 */
function validateSpreadsheetId(id) {
  if (!id || id.length !== 44) {
    throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¯44æ–‡å­—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
  }
  
  if (!/^[a-zA-Z0-9_-]+$/.test(id)) {
    throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã«ç„¡åŠ¹ãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
  }
  
  return true;
}

// =============================================================================
// SETUP FORM HANDLING
// =============================================================================

/**
 * Handle setup form submission
 * @param {Event} e - Form submit event
 */
async function handleSetupSubmission(e) {
  e.preventDefault();
  
  if (setupInProgress) return;
  setupInProgress = true;

  const setupBtn = document.getElementById('setup-btn');
  const setupText = document.getElementById('setup-text');
  const setupSpinner = document.getElementById('setup-spinner');
  
  try {
    // Update button state
    if (setupBtn) setupBtn.disabled = true;
    if (setupText) setupText.style.display = 'none';
    if (setupSpinner) setupSpinner.classList.remove('hidden');
    
    // Get input values
    const serviceAccountJsonEl = document.getElementById('service-account-json');
    const databaseIdEl = document.getElementById('database-id');
    
    const serviceAccountJson = serviceAccountJsonEl ? serviceAccountJsonEl.value.trim() : '';
    const databaseId = databaseIdEl ? databaseIdEl.value.trim() : '';
    
    // Validate inputs
    validateJSON(serviceAccountJson);
    validateSpreadsheetId(databaseId);
    
    // Show progress message
    if (window.sharedUtilities && window.sharedUtilities.message) {
      window.sharedUtilities.message.show('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œä¸­...', 'info');
    } else {
      showMessage('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œä¸­...', 'info');
    }
    
    // Execute setup via GAS
    await new Promise((resolve, reject) => {
      if (window.sharedUtilities && window.sharedUtilities.gas && window.sharedUtilities.gas.call) {
        try {
          window.sharedUtilities.gas.call(
            'setupApplication',
            function(result) {
              if (window.sharedUtilities && window.sharedUtilities.message) {
                window.sharedUtilities.message.show('âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼', 'success');
              } else {
                showMessage('âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼', 'success');
              }
              
              // Show test section
              const testSection = document.getElementById('test-section');
              if (testSection) testSection.classList.remove('hidden');
              
              resolve(result);
            },
            function(error) {
              console.error('Setup error:', error);
              let displayMessage = `âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`;
              
              if (error.message && error.message.includes('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šãŒã€Œåˆ¶é™ä»˜ãã€ã«ãªã£ã¦ã„ã¾ã›ã‚“')) {
                displayMessage = `
                  <p class="font-bold">${error.message}</p>
                  <p class="mt-2">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’ã€Œåˆ¶é™ä»˜ãã€ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
                  <p>å¤‰æ›´æ–¹æ³•: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ãã€ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ â†’ ã€Œä¸€èˆ¬çš„ãªã‚¢ã‚¯ã‚»ã‚¹ã€ã‚’ã€Œåˆ¶é™ä»˜ãã€ã«å¤‰æ›´ã€‚</p>
                `;
              }
              
              if (window.sharedUtilities && window.sharedUtilities.message) {
                window.sharedUtilities.message.show(displayMessage, 'error');
              } else {
                showMessage(displayMessage, 'error');
              }
              
              reject(error);
            },
            [serviceAccountJson, databaseId],
            'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
          );
        } catch (utilityError) {
          console.error('SharedUtilities call error:', utilityError);
          reject(new Error('å…±æœ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + utilityError.message));
        }
      } else {
        // Fallback to direct GAS call
        try {
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler((result) => {
                showMessage('âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                const testSection = document.getElementById('test-section');
                if (testSection) testSection.classList.remove('hidden');
                resolve(result);
              })
              .withFailureHandler((error) => {
                console.error('Setup error:', error);
                let displayMessage = `âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`;
                
                if (error.message && error.message.includes('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šãŒã€Œåˆ¶é™ä»˜ãã€ã«ãªã£ã¦ã„ã¾ã›ã‚“')) {
                  displayMessage = `
                    <p class="font-bold">${error.message}</p>
                    <p class="mt-2">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’ã€Œåˆ¶é™ä»˜ãã€ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
                    <p>å¤‰æ›´æ–¹æ³•: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ãã€ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ â†’ ã€Œä¸€èˆ¬çš„ãªã‚¢ã‚¯ã‚»ã‚¹ã€ã‚’ã€Œåˆ¶é™ä»˜ãã€ã«å¤‰æ›´ã€‚</p>
                  `;
                }
                
                showMessage(displayMessage, 'error');
                reject(error);
              })
              .setupApplication(serviceAccountJson, databaseId);
          } else {
            reject(new Error('Google Apps Scriptç’°å¢ƒãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'));
          }
        } catch (gasError) {
          console.error('Direct GAS call error:', gasError);
          reject(new Error('Google Apps Scriptã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + gasError.message));
        }
      }
    });
        
  } catch (error) {
    console.error('Setup submission error:', error);
    const message = `âŒ ${error.message || 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}`;
    
    if (window.sharedUtilities && window.sharedUtilities.message) {
      window.sharedUtilities.message.show(message, 'error');
    } else {
      showMessage(message, 'error');
    }
  } finally {
    // Reset button state
    if (setupBtn) setupBtn.disabled = false;
    if (setupText) setupText.style.display = 'inline';
    if (setupSpinner) setupSpinner.classList.add('hidden');
    setupInProgress = false;
  }
}

// =============================================================================
// TEST FUNCTIONALITY
// =============================================================================

/**
 * Handle system test execution
 */
function handleSystemTest() {
  const testBtn = document.getElementById('test-btn');
  if (!testBtn) return;
  
  const originalContent = testBtn.innerHTML;
  testBtn.disabled = true;
  testBtn.innerHTML = '<div class="loading-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mx-auto"></div>';
  
  if (window.sharedUtilities && window.sharedUtilities.gas && window.sharedUtilities.gas.call) {
    try {
      window.sharedUtilities.gas.call(
        'testSetup',
        function(result) {
          const message = result.message;
          const type = result.status === 'success' ? 'success' : 'warning';
          
          if (window.sharedUtilities && window.sharedUtilities.message) {
            window.sharedUtilities.message.show(message, type);
          } else {
            showMessage(message, type);
          }
          
          testBtn.disabled = false;
          testBtn.innerHTML = originalContent;
        },
        function(error) {
          const message = `ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`;
          
          if (window.sharedUtilities && window.sharedUtilities.message) {
            window.sharedUtilities.message.show(message, 'error');
          } else {
            showMessage(message, 'error');
          }
          
          testBtn.disabled = false;
          testBtn.innerHTML = originalContent;
        },
        [],
        'ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ'
      );
    } catch (utilityError) {
      console.error('SharedUtilities call error:', utilityError);
      const message = 'å…±æœ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + utilityError.message;
      
      if (window.sharedUtilities && window.sharedUtilities.message) {
        window.sharedUtilities.message.show(message, 'error');
      } else {
        showMessage(message, 'error');
      }
      
      testBtn.disabled = false;
      testBtn.innerHTML = originalContent;
    }
  } else {
    // Fallback to direct GAS call
    google.script.run
      .withSuccessHandler((result) => {
        showMessage(`${result.message}`, result.status === 'success' ? 'success' : 'warning');
        testBtn.disabled = false;
        testBtn.innerHTML = originalContent;
      })
      .withFailureHandler((error) => {
        showMessage(`ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`, 'error');
        testBtn.disabled = false;
        testBtn.innerHTML = originalContent;
      })
      .testSetup();
  }
}

// =============================================================================
// REAL-TIME VALIDATION
// =============================================================================

/**
 * Setup real-time validation for form fields
 */
function setupRealTimeValidation() {
  // JSON validation on blur
  const serviceAccountJsonEl = document.getElementById('service-account-json');
  if (serviceAccountJsonEl) {
    serviceAccountJsonEl.addEventListener('blur', function() {
      try {
        if (this.value.trim()) {
          validateJSON(this.value.trim());
          this.style.borderColor = '#10b981';
        }
      } catch (e) {
        this.style.borderColor = '#ef4444';
      }
    });
  }

  // Spreadsheet ID validation on input
  const databaseIdEl = document.getElementById('database-id');
  if (databaseIdEl) {
    databaseIdEl.addEventListener('input', function() {
      try {
        if (this.value.trim()) {
          validateSpreadsheetId(this.value.trim());
          this.style.borderColor = '#10b981';
        }
      } catch (e) {
        this.style.borderColor = '#ef4444';
      }
    });
  }
}

// =============================================================================
// APP NAVIGATION
// =============================================================================

/**
 * Start the StudyQuest application
 */
function startApp() {
  const btn = document.getElementById('start-studyquest-btn');
  if (btn) {
    btn.innerHTML = '<span>èª­ã¿è¾¼ã¿ä¸­...</span>';
    btn.disabled = true;
  }

  if (window.sharedUtilities && window.sharedUtilities.gas && window.sharedUtilities.gas.call) {
    try {
      window.sharedUtilities.gas.call(
        'getWebAppUrl',
        function(url) {
          if (window.sharedUtilities && window.sharedUtilities.navigation) {
            window.sharedUtilities.navigation.safeNavigate(url, {
              fallbackMessage: 'StudyQuestã‚’é–‹å§‹ä¸­...',
              method: 'auto'
            });
          } else {
            window.location.href = url;
          }
        },
        function(error) {
          const errorMessage = 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®URLå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
          
          if (window.sharedUtilities && window.sharedUtilities.message) {
            window.sharedUtilities.message.show(errorMessage, 'error');
          } else {
            alert(errorMessage);
          }
          
          if (btn) {
            btn.innerHTML = 'ğŸ“š StudyQuestã‚’é–‹å§‹';
            btn.disabled = false;
          }
        },
        [],
        'URLå–å¾—'
      );
    } catch (utilityError) {
      console.error('SharedUtilities call error:', utilityError);
      const errorMessage = 'å…±æœ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + utilityError.message;
      
      if (window.sharedUtilities && window.sharedUtilities.message) {
        window.sharedUtilities.message.show(errorMessage, 'error');
      } else {
        alert(errorMessage);
      }
      
      if (btn) {
        btn.innerHTML = 'ğŸ“š StudyQuestã‚’é–‹å§‹';
        btn.disabled = false;
      }
    }
  } else {
    // Fallback to direct GAS call
    google.script.run
      .withSuccessHandler(function(url) {
        if (window.sharedUtilities && window.sharedUtilities.navigation) {
          window.sharedUtilities.navigation.safeNavigate(url, {
            fallbackMessage: 'StudyQuestã‚’é–‹å§‹ä¸­...',
            method: 'auto'
          });
        } else {
          window.location.href = url;
        }
      })
      .withFailureHandler(function(error) {
        const errorMessage = 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®URLå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
        alert(errorMessage);
        
        if (btn) {
          btn.innerHTML = 'ğŸ“š StudyQuestã‚’é–‹å§‹';
          btn.disabled = false;
        }
      })
      .getWebAppUrl();
  }
}

// =============================================================================
// BACKWARD COMPATIBILITY FUNCTIONS
// =============================================================================

/**
 * Legacy message display function for backward compatibility
 * @param {string} message - Message to display
 * @param {string} type - Message type
 */
function showMessage(message, type = 'info') {
  if (window.sharedUtilities && window.sharedUtilities.message) {
    window.sharedUtilities.message.show(message, type);
    return;
  }
  
  // Fallback for legacy support
  const messageArea = document.getElementById('message-area');
  if (!messageArea) return;
  
  const colors = {
    success: 'bg-green-600/20 border-green-500/50 text-green-100',
    error: 'bg-red-600/20 border-red-500/50 text-red-100',
    warning: 'bg-yellow-600/20 border-yellow-500/50 text-yellow-100',
    info: 'bg-blue-600/20 border-blue-500/50 text-blue-100'
  };
  
  const icons = {
    success: 'âœ…',
    error: 'âŒ',
    warning: 'âš ï¸',
    info: 'â„¹ï¸'
  };
  
  messageArea.innerHTML = `
    <div class="message show glass-panel rounded-lg p-4 border ${colors[type]}">
      <div class="flex items-center">
        <div class="mr-3">${icons[type]}</div>
        <div class="flex-1">${message}</div>
        <button onclick="this.closest('.message').style.display='none'" class="ml-4 text-gray-400 hover:text-white">âœ•</button>
      </div>
    </div>
  `;
}

// =============================================================================
// EVENT LISTENERS SETUP
// =============================================================================

/**
 * Setup all event listeners for the setup page
 */
function setupEventListeners() {
  // Setup form submission
  const setupForm = document.getElementById('setup-form');
  if (setupForm) {
    setupForm.addEventListener('submit', handleSetupSubmission);
  }
  
  // Test button
  const testBtn = document.getElementById('test-btn');
  if (testBtn) {
    testBtn.addEventListener('click', handleSystemTest);
  }
  
  // Real-time validation
  setupRealTimeValidation();
  
  console.log('Setup page event listeners initialized');
}

// =============================================================================
// INITIALIZATION
// =============================================================================

/**
 * Initialize setup page functionality
 */
function initializeSetupPage() {
  console.log('ğŸ”§ Initializing Setup Page Logic...');
  
  // Setup event listeners
  setupEventListeners();
  
  console.log('âœ… Setup Page Logic initialized');
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeSetupPage);
} else {
  initializeSetupPage();
}

// =============================================================================
// EXPORT TO GLOBAL SCOPE
// =============================================================================

// Export setup utilities to global scope
window.setupUtilities = {
  state: {
    setupInProgress: () => setupInProgress
  },
  validation: {
    validateJSON: validateJSON,
    validateSpreadsheetId: validateSpreadsheetId
  },
  form: {
    handleSubmission: handleSetupSubmission,
    setupValidation: setupRealTimeValidation
  },
  test: {
    execute: handleSystemTest
  },
  navigation: {
    startApp: startApp
  },
  legacy: {
    showMessage: showMessage
  }
};

</script>