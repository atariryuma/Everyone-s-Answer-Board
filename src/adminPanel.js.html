<script>
  // Admin Panel JavaScript
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  // Validate current step with setup status consideration
  function validateCurrentStep() {
    const savePublishBtn = document.getElementById('save-publish-btn');
    if (!savePublishBtn) return;
    
    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ç¢ºèª
    const setupStatus = getSetupStatusFromGlobalStatus();
    
    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†æ™‚ã®æ®µéšçš„åˆ¶å¾¡
    if (setupStatus === 'pending') {
      enforceStepProgression();
    }
    
    let isValid = false;
    
    switch (currentStep) {
      case 1:
        isValid = selectedSheetId || selectedFormId;
        break;
      case 2:
        isValid = currentConfig && validateConfiguration();
        break;
      case 3:
        isValid = true;
        break;
    }
    
    savePublishBtn.disabled = !isValid;
  }
  
  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰å–å¾—
  function getSetupStatusFromGlobalStatus() {
    try {
      if (currentStatus && currentStatus.userInfo && currentStatus.userInfo.configJson) {
        const config = typeof currentStatus.userInfo.configJson === 'string' 
          ? JSON.parse(currentStatus.userInfo.configJson) 
          : currentStatus.userInfo.configJson;
        return config.setupStatus || 'pending';
      }
      return 'pending';
    } catch (error) {
      console.warn('getSetupStatusFromGlobalStatus ã‚¨ãƒ©ãƒ¼:', error);
      return 'pending';
    }
  }
  
  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†æ™‚ã®æ®µéšçš„åˆ¶å¾¡ã‚’å¼·åˆ¶
  function enforceStepProgression() {
    const step1Completed = checkStep1Completion();
    const step2Completed = checkStep2Completion();
    
    // Step 2ã®åˆ¶å¾¡
    const step2Section = document.getElementById('sheet-selection-section');
    if (!step1Completed) {
      disableSection(step2Section, 'âš ï¸ å…ˆã«ãƒ‡ãƒ¼ã‚¿æº–å‚™ã‚’å®Œäº†ã—ã¦ãã ã•ã„');
    } else {
      enableSection(step2Section);
    }
    
    // Step 3ã®åˆ¶å¾¡
    const step3Section = document.getElementById('config-section');
    if (!step1Completed || !step2Completed) {
      disableSection(step3Section, 'âš ï¸ å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†ã—ã¦ãã ã•ã„');
    } else {
      enableSection(step3Section);
    }
  }
  
  // Step 1å®Œäº†ãƒã‚§ãƒƒã‚¯
  function checkStep1Completion() {
    return !!(selectedSheetId || selectedFormId || 
              (currentStatus && currentStatus.userInfo && currentStatus.userInfo.spreadsheetId));
  }
  
  // Step 2å®Œäº†ãƒã‚§ãƒƒã‚¯
  function checkStep2Completion() {
    return !!(currentStatus && currentStatus.activeSheetName);
  }
  
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
  function disableSection(section, message) {
    if (!section) return;
    
    section.style.opacity = '0.5';
    section.style.pointerEvents = 'none';
    
    // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    const existingWarning = section.querySelector('.step-warning');
    if (!existingWarning) {
      const warning = document.createElement('div');
      warning.className = 'step-warning bg-yellow-100 border border-yellow-300 rounded-lg p-3 mb-4 text-sm text-yellow-800';
      warning.innerHTML = `<span class="font-semibold">${message}</span>`;
      section.insertBefore(warning, section.firstChild);
    }
  }
  
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–
  function enableSection(section) {
    if (!section) return;
    
    section.style.opacity = '1';
    section.style.pointerEvents = 'auto';
    
    // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    const warning = section.querySelector('.step-warning');
    if (warning) {
      warning.remove();
    }
  }
  
  // Handle sheet selection
  function handleSheetSelection(event) {
    selectedSheetId = event.target.value;
    selectedFormId = null; // Clear form selection
    
    if (selectedSheetId) {
      loadSheetColumns(selectedSheetId);
    }
    
    validateCurrentStep();
  }
  
  // Handle form selection
  function handleFormSelection(event) {
    selectedFormId = event.target.value;
    selectedSheetId = null; // Clear sheet selection
    
    if (selectedFormId) {
      loadFormColumns(selectedFormId);
    }
    
    validateCurrentStep();
  }
  
  // Load sheet columns
  function loadSheetColumns(sheetId) {
    if (typeof runGasWithUserId === 'function') {
      runGasWithUserId('getSheetColumns', sheetId)
        .then(columns => {
          displayColumnMapping(columns);
        })
        .catch(error => {
          console.error('Failed to load sheet columns:', error);
          showMessage('åˆ—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        });
    }
  }
  
  // Load form columns
  function loadFormColumns(formId) {
    if (typeof runGasWithUserId === 'function') {
      runGasWithUserId('getFormColumns', formId)
        .then(columns => {
          displayColumnMapping(columns);
        })
        .catch(error => {
          console.error('Failed to load form columns:', error);
          showMessage('ãƒ•ã‚©ãƒ¼ãƒ é …ç›®ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        });
    }
  }
  
  // Display column mapping interface
  function displayColumnMapping(columns) {
    const configPlaceholder = document.getElementById('config-placeholder');
    const configContent = document.getElementById('config-content');
    
    if (configPlaceholder) configPlaceholder.classList.add('hidden');
    if (configContent) configContent.classList.remove('hidden');
    
    const mappingContainer = document.getElementById('column-mappings');
    if (!mappingContainer) return;
    
    mappingContainer.innerHTML = '';
    
    columns.forEach((column, index) => {
      const mappingDiv = document.createElement('div');
      mappingDiv.className = 'column-mapping';
      mappingDiv.innerHTML = `
        <div>
          <label class="block text-sm font-medium text-gray-200 mb-2">
            ${column.name}
            ${column.required ? '<span class="text-red-400">*</span>' : ''}
          </label>
          <p class="text-xs text-gray-400">${column.description || ''}</p>
        </div>
        <div>
          <select class="form-control form-select column-mapping-select" data-column="${column.id}">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            ${columns.map(col => `<option value="${col.id}">${col.name}</option>`).join('')}
            <option value="content">å›ç­”å†…å®¹</option>
            <option value="author">å›ç­”è€…å</option>
            <option value="timestamp">å›ç­”æ™‚åˆ»</option>
            <option value="reaction">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³</option>
            <option value="ignore">ç„¡è¦–</option>
          </select>
        </div>
      `;
      mappingContainer.appendChild(mappingDiv);
    });
  }
  
  // Handle column mapping
  function handleColumnMapping(select) {
    const columnId = select.dataset.column;
    const mappingType = select.value;
    const mappingDiv = select.closest('.column-mapping');
    
    // Update visual feedback
    mappingDiv.classList.remove('required', 'mapped');
    if (mappingType && mappingType !== 'ignore') {
      mappingDiv.classList.add('mapped');
    }
    
    // Update configuration
    if (!currentConfig) currentConfig = {};
    if (!currentConfig.columnMappings) currentConfig.columnMappings = {};
    currentConfig.columnMappings[columnId] = mappingType;
    
    validateCurrentStep();
  }
  
  // Handle toggle changes
  function handleToggleChange(event) {
    const toggleName = event.target.name;
    const isChecked = event.target.checked;
    
    if (!currentConfig) currentConfig = {};
    currentConfig[toggleName] = isChecked;
    
    validateCurrentStep();
  }
  
  // Validate configuration
  function validateConfiguration() {
    if (!currentConfig || !currentConfig.columnMappings) return false;
    
    const mappings = currentConfig.columnMappings;
    const hasContent = Object.values(mappings).includes('content');
    const hasAuthor = Object.values(mappings).includes('author');
    
    return hasContent && hasAuthor;
  }
  
  // Handle save and publish
  function handleSaveAndPublish() {
    const btn = document.getElementById('save-publish-btn');
    if (!btn || btn.disabled) return;
    
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner mr-2"></div>ä¿å­˜ä¸­...';
    
    const config = {
      sheetId: selectedSheetId,
      formId: selectedFormId,
      columnMappings: currentConfig.columnMappings,
      displaySettings: {
        showCounts: currentConfig.showCounts || false,
        allowReactions: currentConfig.allowReactions || true,
        anonymousMode: currentConfig.anonymousMode || false
      }
    };
    
    if (typeof runGasWithUserId === 'function') {
      runGasWithUserId('saveAndPublishBoard', config)
        .then(result => {
          if (result.success) {
            showMessage('è¨­å®šãŒä¿å­˜ã•ã‚Œã€ãƒœãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸ', 'success');
            if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
              window.unifiedCache.clear();
            }
            loadSystemStatus();
            navigateToStep(3);
          } else {
            showMessage(result.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        })
        .catch(error => {
          console.error('Save failed:', error);
          showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .finally(() => {
          btn.disabled = false;
          btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹';
        });
    }
  }
  
  // Handle unpublish
  function handleUnpublish() {
    if (!confirm('ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    const btn = document.getElementById('unpublish-board-btn');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner mr-2"></div>åœæ­¢ä¸­...';
    
    if (typeof runGasWithUserId === 'function') {
      runGasWithUserId('unpublishBoard')
        .then(result => {
          if (result.success) {
            showMessage('ãƒœãƒ¼ãƒ‰ã®å…¬é–‹ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'success');
            if (window.unifiedCache && typeof window.unifiedCache.clear === 'function') {
              window.unifiedCache.clear();
            }
            loadSystemStatus();
          } else {
            showMessage(result.message || 'åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        })
        .catch(error => {
          console.error('Unpublish failed:', error);
          showMessage('åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .finally(() => {
          btn.disabled = false;
          btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path></svg>å…¬é–‹ã‚’åœæ­¢';
        });
    }
  }
  
  
  
  
  
  
  
  // Initialization is triggered from AdminPanel.html after userId is ready.
  
  // Export functions for global access
  window.adminPanel = {
    initializeAdminPanel,
    navigateToStep,
    showMessage,
    switchToAnotherAccount,
    openAppSetupPage,
    loadSystemStatus,
    updateAnswerCount,
    logoutAndRedirect
  };

  // StudyQuest ã‚¢ãƒ—ãƒªè¨­å®šã¸ã®é·ç§»
  function openAppSetupPage() {
    google.script.run
      .withSuccessHandler(function(url) {
        if (url) {
          // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã‚‰ã®é·ç§»ã¨åŒã˜ãƒ•ãƒ­ãƒ¼ã‚’å†ç¾
          showAdminPanelRedirect(url, 'ã‚¢ãƒ—ãƒªè¨­å®šç®¡ç†ã¸é·ç§»ã—ã¾ã™');
        } else {
          showMessage('ã‚¢ãƒ—ãƒªè¨­å®šURLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      })
      .withFailureHandler(function(error) {
        console.error('Failed to get app setup URL:', error);
        showMessage('ã‚¢ãƒ—ãƒªè¨­å®šURLã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
      })
      .getAppSetupUrl(); // ã“ã®é–¢æ•°ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®š
  }

  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  function logoutAndRedirect() {
    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
      google.script.run
        .withSuccessHandler(function(url) {
          window.location.href = url; // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        })
        .withFailureHandler(function(error) {
          console.error('Logout failed:', error);
          showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        })
        .resetUserAuthentication(); // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®èªè¨¼ãƒªã‚»ãƒƒãƒˆé–¢æ•°ã‚’å‘¼ã³å‡ºã™
    }
  }
  /**
   * ç®¡ç†ãƒ‘ãƒãƒ«ã‹ã‚‰åˆ¥ã®ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç”»é¢ã‚’è¡¨ç¤º
   * ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®åŒåé–¢æ•°ã‚’ç®¡ç†ãƒ‘ãƒãƒ«ç”¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
   * @param {string} targetUrl - é·ç§»å…ˆã®URL
   * @param {string} message - è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   */
  function showAdminPanelRedirect(targetUrl, message) {
    try {
      // å¼•æ•°ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
      if (!targetUrl || typeof targetUrl !== 'string') {
        console.error('showAdminPanelRedirect: ç„¡åŠ¹ãªtargetUrlãŒæ¸¡ã•ã‚Œã¾ã—ãŸ:', targetUrl);
        showMessage('é·ç§»URLãŒç„¡åŠ¹ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }
      
      console.log('ç®¡ç†ãƒ‘ãƒãƒ«ã‹ã‚‰ã®é·ç§»ç”»é¢ã‚’è¡¨ç¤º:', targetUrl);
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’åœæ­¢
      if (typeof setLoading === 'function') {
        setLoading(false);
      }
      
      // ç®¡ç†ãƒ‘ãƒãƒ«ç”¨ã®é·ç§»ç”»é¢HTML
      const redirectHtml = `
        <!DOCTYPE html>
        <html lang="ja">
        <head>
          <title>${message || 'ãƒšãƒ¼ã‚¸é·ç§»ä¸­...'}</title>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <style>
            body { 
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: #1a1b26;
              min-height: 100vh;
              margin: 0;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 20px;
            }
            .container {
              background: rgba(26,27,38,0.9);
              backdrop-filter: blur(12px);
              border: 1px solid rgba(255,255,255,0.1);
              border-radius: 16px;
              padding: 2rem;
              max-width: 420px;
              width: 90%;
              text-align: center;
              box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
              animation: slideUp 0.6s ease-out;
            }
            @keyframes slideUp {
              from { transform: translateY(20px); opacity: 0; }
              to { transform: translateY(0); opacity: 1; }
            }
            .success-icon {
              font-size: 3rem;
              margin-bottom: 1rem;
              animation: bounce 1s ease-out;
            }
            @keyframes bounce {
              0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
              40% { transform: translateY(-10px); }
              60% { transform: translateY(-5px); }
            }
            .title {
              color: #10b981;
              font-size: 1.5rem;
              font-weight: bold;
              margin-bottom: 1rem;
            }
            .message {
              color: #94a3b8;
              margin-bottom: 2rem;
              line-height: 1.6;
            }
            .redirect-button {
              background: linear-gradient(135deg, #10b981, #059669);
              color: white;
              border: none;
              border-radius: 8px;
              padding: 12px 24px;
              font-size: 1rem;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.3s ease;
              text-decoration: none;
              display: inline-block;
              margin: 0.5rem;
            }
            .redirect-button:hover {
              background: linear-gradient(135deg, #059669, #047857);
              transform: translateY(-2px);
              box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            }
            .back-button {
              background: rgba(148, 163, 184, 0.1);
              color: #94a3b8;
              border: 1px solid rgba(148, 163, 184, 0.3);
            }
            .back-button:hover {
              background: rgba(148, 163, 184, 0.2);
              color: #e2e8f0;
            }
            .url-display {
              background: rgba(0,0,0,0.3);
              border-radius: 6px;
              padding: 8px 12px;
              margin: 1rem 0;
              font-family: 'Monaco', 'Menlo', monospace;
              font-size: 0.8rem;
              color: #64748b;
              word-break: break-all;
              border: 1px solid rgba(255,255,255,0.1);
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="success-icon">ğŸš€</div>
            <div class="title">æº–å‚™å®Œäº†</div>
            <div class="message">${message || 'ãƒšãƒ¼ã‚¸é·ç§»ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ'}</div>
            <div class="url-display">${targetUrl}</div>
            <a href="${targetUrl}" class="redirect-button" target="_top">
              ğŸ”— ã‚¢ãƒ—ãƒªè¨­å®šç”»é¢ã‚’é–‹ã
            </a>
            <button onclick="returnToAdminPanel()" class="redirect-button back-button">
              â† ç®¡ç†ãƒ‘ãƒãƒ«ã«æˆ»ã‚‹
            </button>
          </div>
          <script>
            function returnToAdminPanel() {
              try {
                // ç®¡ç†ãƒ‘ãƒãƒ«ã®URLã‚’æ§‹ç¯‰
                const currentUrl = new URL(window.location.href);
                const baseUrl = currentUrl.origin + currentUrl.pathname;
                
                // ç¾åœ¨ã®ç®¡ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰ï¼‰
                google.script.run
                  .withSuccessHandler(function(adminUserId) {
                    if (adminUserId) {
                      const adminUrl = baseUrl + '?mode=admin&userId=' + encodeURIComponent(adminUserId);
                      console.log('Returning to admin panel:', adminUrl);
                      window.top.location.href = adminUrl;
                    } else {
                      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
                      window.top.location.href = baseUrl + '?mode=login';
                    }
                  })
                  .withFailureHandler(function(error) {
                    console.error('Failed to get admin user ID:', error);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
                    const loginUrl = baseUrl + '?mode=login';
                    window.top.location.href = loginUrl;
                  })
                  .getLastAdminUserId();
              } catch (error) {
                console.error('Error returning to admin panel:', error);
                // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå˜ç´”ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
                window.location.href = window.location.origin + window.location.pathname + '?mode=login';
              }
            }
          <\/script>
        </body>
        </html>
      `;
      
      // æ–°ã—ã„ãƒšãƒ¼ã‚¸ã«é·ç§»
      document.open();
      document.write(redirectHtml);
      document.close();
      
    } catch (error) {
      console.error('showAdminPanelRedirectã§ã‚¨ãƒ©ãƒ¼:', error);
      showMessage('ãƒšãƒ¼ã‚¸é·ç§»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
    }
  }

</script>
