<script>
// =============================================================================
// ADMIN PANEL CORE LITE - è»½é‡ç‰ˆã‚³ã‚¢æ©Ÿèƒ½
// =============================================================================
// Direct Embedding ã‚¢ãƒ—ãƒ­ãƒ¼ãƒç”¨ã®è»½é‡åŒ–ã•ã‚ŒãŸã‚³ã‚¢æ©Ÿèƒ½
// include() åˆ¶é™ã‚’å›é¿ã™ã‚‹ãŸã‚ã€æœ€å°é™ã®æ©Ÿèƒ½ã®ã¿å®Ÿè£…

console.log('ğŸ“¦ CORE LITE: Loading lightweight admin panel core...');

// åŸºæœ¬çš„ãªåå‰ç©ºé–“ã®è¨­å®š + Master Initialization Controller
window.AdminPanel = window.AdminPanel || {
  state: {
    current: null,
    isLoading: false,
    userId: null
  },
  core: {
    userId: null,
    userIdPromise: null
  },
  initialization: {
    isCompleted: false,
    isInProgress: false,
    masterControllerActive: false,
    stage: 'IDLE', // IDLE â†’ DIRECT â†’ CORE â†’ FRAMEWORK â†’ COMPLETED
    stages: {
      DIRECT_EMBEDDED: { completed: false, error: null },
      CORE_LITE: { completed: false, error: null },
      FRAMEWORK: { completed: false, error: null }
    }
  }
};

// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDåˆæœŸåŒ–
function initializeUserId() {
  console.log('ğŸ” CORE LITE: Initializing UserId');
  
  if (window.AdminPanel.core.userIdPromise) {
    console.log('ğŸ” CORE LITE: Reusing existing userIdPromise');
    return window.AdminPanel.core.userIdPromise;
  }

  window.AdminPanel.core.userIdPromise = new Promise((resolve, reject) => {
    console.log('ğŸ” CORE LITE: Creating new userIdPromise');
    
    // Direct communication using safeGoogleScriptRun
    if (typeof window.safeGoogleScriptRun === 'function') {
      window.safeGoogleScriptRun('getCurrentUserStatus')
        .then((result) => {
          if (result && result.status === 'success' && result.userInfo && result.userInfo.userId) {
            window.AdminPanel.core.userId = result.userInfo.userId;
            window.AdminPanel.state.userId = window.AdminPanel.core.userId;
            console.log('âœ… CORE LITE: UserID initialized:', window.AdminPanel.core.userId);
            resolve(window.AdminPanel.core.userId);
          } else {
            console.error('âŒ CORE LITE: Invalid user status response:', result);
            reject(new Error('Failed to get valid user status'));
          }
        })
        .catch((error) => {
          console.error('âŒ CORE LITE: Failed to initialize userId:', error);
          reject(error);
        });
    } else {
      console.error('âŒ CORE LITE: safeGoogleScriptRun not available');
      reject(new Error('safeGoogleScriptRun not available'));
    }
  });

  return window.AdminPanel.core.userIdPromise;
}

// åŸºæœ¬çš„ãªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
function loadInitialData() {
  console.log('ğŸ“Š CORE LITE: Loading initial data...');
  
  return initializeUserId()
    .then(() => {
      if (!window.AdminPanel.core.userId) {
        throw new Error('UserId not available');
      }
      
      return window.safeGoogleScriptRun('getInitialData', window.AdminPanel.core.userId, null);
    })
    .then((response) => {
      console.log('âœ… CORE LITE: Initial data loaded:', response);
      if (response && response.userInfo) {
        window.AdminPanel.state.current = response;
      }
      return response;
    })
    .catch((error) => {
      console.error('âŒ CORE LITE: Failed to load initial data:', error);
      throw error;
    });
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
window.initializeUserId = initializeUserId;
window.loadInitialData = loadInitialData;
window.AdminPanel.loadInitialData = loadInitialData;

// åŸºæœ¬çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ©Ÿèƒ½
function showMessage(message, type = 'info') {
  console.log(`ğŸ“¢ CORE LITE: ${type.toUpperCase()}: ${message}`);
  
  // ç°¡æ˜“çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆå¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µï¼‰
  const messageDiv = document.createElement('div');
  messageDiv.innerHTML = `
    <div style="display: flex; align-items: center; gap: 8px;">
      ${type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸'} 
      <span>${message}</span>
    </div>
  `;
  messageDiv.style.cssText = `
    position: fixed; 
    top: 20px; 
    right: 20px; 
    padding: 12px 16px; 
    background: ${type === 'error' ? '#dc2626' : type === 'success' ? '#16a34a' : '#2563eb'}; 
    color: white; 
    border-radius: 6px; 
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 14px;
    max-width: 400px;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
  `;
  
  document.body.appendChild(messageDiv);
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  setTimeout(() => {
    messageDiv.style.opacity = '1';
    messageDiv.style.transform = 'translateX(0)';
  }, 10);
  
  setTimeout(() => {
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.parentNode.removeChild(messageDiv);
      }
    }, 300);
  }, type === 'error' ? 8000 : 5000);
}

window.showMessage = showMessage;

// å¤‰æ•°è¡çªä¿®æ­£å¾Œã®ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
function testVariableFixCommunication() {
  console.log('ğŸ§ª CORE LITE: Testing variable fix communication...');
  
  return window.safeGoogleScriptRun('diagnosticFullTest')
    .then((result) => {
      console.log('âœ… CORE LITE: Variable fix test successful!', result);
      showMessage('å¤‰æ•°è¡çªä¿®æ­£ãƒ†ã‚¹ãƒˆæˆåŠŸ: ' + result.message, 'success');
      return result;
    })
    .catch((error) => {
      console.error('âŒ CORE LITE: Variable fix test failed:', error);
      showMessage('å¤‰æ•°è¡çªä¿®æ­£ãƒ†ã‚¹ãƒˆå¤±æ•—: ' + error.message, 'error');
      throw error;
    });
}

window.testVariableFixCommunication = testVariableFixCommunication;

// Master Controllerçµ±åˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
function testMasterControllerIntegration() {
  console.log('ğŸ¯ MASTER TEST: Testing Master Controller integration...');
  
  return window.safeGoogleScriptRun('diagnosticMasterController')
    .then((result) => {
      console.log('âœ… MASTER TEST: Integration test successful!', result);
      showMessage('Master Controllerçµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸ: ' + result.message, 'success');
      
      // åˆæœŸåŒ–çŠ¶æ…‹ã®è©³ç´°ãƒ­ã‚°
      console.log('ğŸ“Š MASTER TEST: Initialization state:', {
        isCompleted: window.AdminPanel.initialization.isCompleted,
        isInProgress: window.AdminPanel.initialization.isInProgress,
        stage: window.AdminPanel.initialization.stage,
        stages: window.AdminPanel.initialization.stages
      });
      
      return result;
    })
    .catch((error) => {
      console.error('âŒ MASTER TEST: Integration test failed:', error);
      showMessage('Master Controllerçµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—: ' + error.message, 'error');
      throw error;
    });
}

window.testMasterControllerIntegration = testMasterControllerIntegration;

// =============================================================================
// MASTER INITIALIZATION CONTROLLER
// =============================================================================

function initializeMasterController() {
  console.log('ğŸ¯ MASTER: Starting Master Initialization Controller');
  console.log('ğŸ“Š MASTER: Current system state:', {
    isInProgress: window.AdminPanel.initialization.isInProgress,
    isCompleted: window.AdminPanel.initialization.isCompleted,
    masterControllerActive: window.AdminPanel.initialization.masterControllerActive,
    stage: window.AdminPanel.initialization.stage
  });
  
  // é‡è¤‡åˆæœŸåŒ–é˜²æ­¢
  if (window.AdminPanel.initialization.isInProgress) {
    console.log('âš ï¸ MASTER: Initialization already in progress, skipping');
    return Promise.resolve('already_in_progress');
  }
  
  if (window.AdminPanel.initialization.isCompleted) {
    console.log('âœ… MASTER: Initialization already completed');
    return Promise.resolve('already_completed');
  }
  
  // åˆ¶å¾¡æ¨©ã‚’æ˜ç¢ºã«å®£è¨€
  window.AdminPanel.initialization.isInProgress = true;
  window.AdminPanel.initialization.masterControllerActive = true;
  window.AdminPanel.initialization.stage = 'DIRECT';
  
  console.log('ğŸš€ MASTER: Stage 1/3 - Direct Embedded Communication Test');
  console.log('ğŸ“‹ MASTER: Master Controller has taken control of initialization');
  
  // Stage 1: Direct Embedded Test
  return testDirectEmbeddedCommunication()
    .then((result) => {
      console.log('âœ… MASTER: Stage 1/3 completed - Direct Embedded');
      console.log('ğŸ“Š MASTER: Direct Embedded result:', result);
      window.AdminPanel.initialization.stages.DIRECT_EMBEDDED.completed = true;
      window.AdminPanel.initialization.stage = 'CORE';
      
      console.log('ğŸš€ MASTER: Stage 2/3 - Core Lite User Initialization');
      console.log('ğŸ”„ MASTER: Progress: Direct Embedded âœ… | Core Lite â³ | Framework â¸ï¸');
      return initializeCoreSystem();
    })
    .then((result) => {
      console.log('âœ… MASTER: Stage 2/3 completed - Core Lite');
      console.log('ğŸ“Š MASTER: Core Lite result:', result ? 'Success with data' : 'Success');
      window.AdminPanel.initialization.stages.CORE_LITE.completed = true;
      window.AdminPanel.initialization.stage = 'FRAMEWORK';
      
      console.log('ğŸš€ MASTER: Stage 3/3 - Framework System');
      console.log('ğŸ”„ MASTER: Progress: Direct Embedded âœ… | Core Lite âœ… | Framework â³');
      return initializeFrameworkSystem();
    })
    .then(() => {
      console.log('âœ… MASTER: All 3 stages completed successfully');
      console.log('ğŸ”„ MASTER: Final Progress: Direct Embedded âœ… | Core Lite âœ… | Framework âœ…');
      window.AdminPanel.initialization.stage = 'COMPLETED';
      window.AdminPanel.initialization.isCompleted = true;
      window.AdminPanel.initialization.isInProgress = false;
      
      // æœ€çµ‚çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      console.log('ğŸ§ª MASTER: Running final integration validation test');
      return testMasterControllerIntegration();
    })
    .then(() => {
      console.log('ğŸ‰ MASTER: Complete system initialization with integration test successful');
      console.log('ğŸ“‹ MASTER: Final system state:', {
        isCompleted: true,
        masterControllerActive: true,
        allStagesCompleted: Object.values(window.AdminPanel.initialization.stages).every(s => s.completed)
      });
      showMessage('ç®¡ç†ãƒ‘ãƒãƒ«åˆæœŸåŒ–å®Œäº† (çµ±åˆã‚·ã‚¹ãƒ†ãƒ )', 'success');
      return 'completed';
    })
    .catch((error) => {
      console.error('ğŸ’¥ MASTER: Initialization failed:', error);
      window.AdminPanel.initialization.isInProgress = false;
      
      // ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¸è¨˜éŒ²
      const currentStage = window.AdminPanel.initialization.stage;
      if (currentStage === 'DIRECT') {
        window.AdminPanel.initialization.stages.DIRECT_EMBEDDED.error = error;
      } else if (currentStage === 'CORE') {
        window.AdminPanel.initialization.stages.CORE_LITE.error = error;
      } else if (currentStage === 'FRAMEWORK') {
        window.AdminPanel.initialization.stages.FRAMEWORK.error = error;
      }
      
      showMessage('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      throw error;
    });
}

// Stage 1: Direct Embedded Communication Test
function testDirectEmbeddedCommunication() {
  console.log('ğŸ”¬ MASTER: Testing direct embedded communication');
  
  if (typeof window.safeGoogleScriptRun !== 'function') {
    throw new Error('safeGoogleScriptRun not available');
  }
  
  return window.safeGoogleScriptRun('diagnosticPing')
    .then((result) => {
      console.log('âœ… MASTER: Direct communication test successful', result);
      return result;
    });
}

// Stage 2: Core System Initialization
function initializeCoreSystem() {
  console.log('ğŸ”§ MASTER: Initializing core system');
  
  return initializeUserId()
    .then((userId) => {
      console.log('âœ… MASTER: Core system initialized with userId:', userId);
      return loadInitialData();
    })
    .then((initialData) => {
      console.log('âœ… MASTER: Initial data loaded:', initialData);
      return initialData;
    });
}

// Stage 3: Framework System Initialization (Safe)
function initializeFrameworkSystem() {
  console.log('ğŸ–¼ï¸ MASTER: Initializing framework system');
  
  // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚·ã‚¹ãƒ†ãƒ ãŒå­˜åœ¨ã—ã€å®‰å…¨ã«åˆæœŸåŒ–ã§ãã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if (typeof window.initializeAdminPanelMaster === 'function') {
    console.log('ğŸ–¼ï¸ MASTER: Framework system available, delegating initialization');
    
    // Framework system will check AdminPanel.initialization.isCompleted 
    // which is now properly initialized
    try {
      window.initializeAdminPanelMaster();
      console.log('âœ… MASTER: Framework system initialized');
      return Promise.resolve('framework_initialized');
    } catch (error) {
      console.warn('âš ï¸ MASTER: Framework initialization failed, continuing without:', error);
      return Promise.resolve('framework_skipped');
    }
  } else {
    console.log('â„¹ï¸ MASTER: Framework system not available, skipping');
    return Promise.resolve('framework_not_available');
  }
}

window.initializeMasterController = initializeMasterController;

// =============================================================================
// IMMEDIATE MASTER CONTROLLER EXECUTION  
// =============================================================================
console.log('ğŸš€ MASTER: IMMEDIATE EXECUTION - Starting Master Controller instantly');
console.log('ğŸ“Š MASTER: Current environment state:', {
  hasAdminPanel: !!window.AdminPanel,
  hasGoogleScript: typeof window.google !== 'undefined',
  hasSafeGoogleScriptRun: typeof window.safeGoogleScriptRun === 'function',
  documentReadyState: document.readyState,
  timestamp: new Date().toISOString()
});

// æœ€å„ªå…ˆã§Master Controlleråˆ¶å¾¡ã‚’å®£è¨€
if (window.AdminPanel && window.AdminPanel.initialization) {
  window.AdminPanel.initialization.masterControllerActive = true;
  console.log('ğŸ“‹ MASTER: IMMEDIATE CONTROL TAKEN - Other systems blocked');
  console.log('ğŸ”’ MASTER: Control flag set - masterControllerActive = true');
  
  // åˆ¶å¾¡çŠ¶æ…‹ã®è©³ç´°ãƒ­ã‚°
  console.log('ğŸ“Š MASTER: Initialization state after control taken:', {
    masterControllerActive: window.AdminPanel.initialization.masterControllerActive,
    isInProgress: window.AdminPanel.initialization.isInProgress,
    isCompleted: window.AdminPanel.initialization.isCompleted,
    stage: window.AdminPanel.initialization.stage
  });
} else {
  console.error('ğŸ’¥ MASTER: AdminPanel namespace not available!');
  console.error('ğŸ’¥ MASTER: Critical error - cannot take control');
}

// Direct Embedded ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
if (typeof window.safeGoogleScriptRun === 'function') {
  console.log('âœ… MASTER: Direct Embedded system available, proceeding with immediate initialization');
  console.log('âš¡ MASTER: BYPASSING DOM wait - starting immediately');
  
  // å³åº§ã«åˆæœŸåŒ–é–‹å§‹ï¼ˆDOMContentLoadedå¾…æ©Ÿãªã—ï¼‰
  initializeMasterController()
    .then((result) => {
      console.log('ğŸ‰ MASTER: IMMEDIATE initialization completed successfully:', result);
      console.log('âœ… MASTER: System ready - Master Controller in full control');
      
      // æœ€çµ‚åˆ¶å¾¡çŠ¶æ³ã®ç¢ºèª
      console.log('ğŸ“Š MASTER: Final control verification:', {
        masterControllerActive: window.AdminPanel.initialization.masterControllerActive,
        isCompleted: window.AdminPanel.initialization.isCompleted,
        coreUserIdAvailable: !!window.AdminPanel.core.userId,
        frameworkShouldBeBlocked: true
      });
    })
    .catch((error) => {
      console.error('ğŸ’¥ MASTER: IMMEDIATE initialization failed:', error);
      
      // DOMå®Œäº†å¾Œã«å†è©¦è¡Œ
      console.log('ğŸ”„ MASTER: Falling back to DOM ready initialization');
      document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸ”„ MASTER: DOM ready fallback attempt');
        initializeMasterController()
          .then((result) => {
            console.log('ğŸ‰ MASTER: DOM fallback initialization successful:', result);
          })
          .catch((fallbackError) => {
            console.error('ğŸ’€ MASTER: Even DOM fallback failed:', fallbackError);
            showMessage('åˆæœŸåŒ–ã«å®Œå…¨ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
          });
      });
    });
} else {
  // Direct Embeddedæœªæº–å‚™ã®å ´åˆã¯DOMå®Œäº†ã¾ã§å¾…æ©Ÿ
  console.log('â³ MASTER: Direct Embedded not ready, waiting for DOM...');
  document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸš€ MASTER: DOM ready, executing Master Controller');
    
    // DOMå®Œäº†æ™‚ã«ã‚‚åˆ¶å¾¡ã‚’å†å®£è¨€
    if (window.AdminPanel && window.AdminPanel.initialization) {
      window.AdminPanel.initialization.masterControllerActive = true;
      console.log('ğŸ“‹ MASTER: DOM - Control reaffirmed');
    }
    
    initializeMasterController()
      .then((result) => {
        console.log('ğŸ‰ MASTER: DOM initialization completed:', result);
      })
      .catch((error) => {
        console.error('ğŸ’¥ MASTER: DOM initialization failed:', error);
        showMessage('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
      });
  });
}
</script>