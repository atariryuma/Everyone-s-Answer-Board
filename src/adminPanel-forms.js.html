<script>
// 文字数カウンター機能
function setupCharacterCounters() {
  const questionTextarea = document.getElementById('custom-main-question');
  const questionCounter = document.getElementById('question-counter');

  if (questionTextarea && questionCounter) {
    questionTextarea.addEventListener('input', function() {
      const count = this.value.length;
      questionCounter.textContent = `${count}/500`;
      questionCounter.className = count > 450 ? 'text-xs text-red-400' : 'text-xs text-gray-500';
    });
  }
}

// セキュリティ情報表示関数
function showSecurityInfo() {
  if (window.sharedModals) {
    window.sharedModals.showSecurityDetails();
  } else {
    showModal('security-details-modal');
  }
}

// Google連携の利点表示関数
function showGoogleIntegrationInfo() {
  if (window.sharedModals) {
    window.sharedModals.showGoogleIntegration();
  } else {
    showModal('google-integration-modal');
  }
}

// モーダル表示時にカウンターを初期化
// 初期化は adminPanel-core.js の統合初期化システムで管理されます

// フォーム設定モーダルが開かれたときにカウンターをリセット
// この機能は既にshowFormConfigModal内で適切に処理されています
// 安全なフォーム初期化 - Core初期化後に実行
function safeInitializeForms() {
  // Core初期化完了を待機
  if (typeof window.coreInitialized !== 'undefined' && window.coreInitialized) {
    initializeFormComponents();
  } else {
    // Core初期化を待って再試行
    setTimeout(safeInitializeForms, 200);
  }
}

function initializeFormComponents() {
  console.log('📝 Initializing form components...');
  
  // モーダルが表示されるたびにカウンターをセットアップ
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const modal = document.getElementById('form-config-modal');
        if (modal && !modal.classList.contains('hidden')) {
          setTimeout(setupCharacterCounters, 100);
        }
      }
    });
  });
  
  // モーダルの監視を開始
  const modal = document.getElementById('form-config-modal');
  if (modal) {
    observer.observe(modal, { attributes: true });
  }
  
  window.apiInitialized = true; // Forms初期化完了フラグ
}

// 競合を避けるため、Core初期化システムから呼び出される
if (document.readyState !== 'loading') {
  // 既にDOMがロード済みの場合は即座に実行
  setTimeout(safeInitializeForms, 200);
} else {
  // DOMロード完了後に実行（Coreより後になる）
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(safeInitializeForms, 700); // UI初期化を待つ
  });
}
</script>
