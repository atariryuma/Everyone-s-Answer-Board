<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 20px; 
        line-height: 1.6;
        color: #333;
      }
      ol, ul { padding-left: 25px; }
      li { margin-bottom: 12px; }
      strong { color: #d73502; font-weight: 600; }
      code { 
        background-color: #f4f4f4; 
        padding: 3px 6px; 
        border-radius: 4px; 
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
      }
      button { 
        padding: 10px 20px; 
        background-color: #4285F4; 
        color: white; 
        border: none; 
        border-radius: 6px; 
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
      }
      button:hover { background-color: #357ae8; }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      input { 
        width: 95%; 
        padding: 10px; 
        margin-top: 10px; 
        border: 2px solid #ddd; 
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
      }
      input:focus {
        outline: none;
        border-color: #4285F4;
      }
      .info-box {
        background-color: #e8f4fd;
        border-left: 4px solid #4285F4;
        padding: 12px;
        margin: 15px 0;
        border-radius: 4px;
      }
      .warning-box {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 12px;
        margin: 15px 0;
        border-radius: 4px;
      }
      .success-box {
        background-color: #d4edda;
        border-left: 4px solid #28a745;
        padding: 12px;
        margin: 15px 0;
        border-radius: 4px;
      }
      h3 {
        color: #1a73e8;
        margin-bottom: 20px;
      }
      h4 {
        color: #5f6368;
        margin-top: 25px;
      }
      .step-number {
        background-color: #4285F4;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
        margin-right: 8px;
      }
      #status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        display: none;
      }
      .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <h3>üöÄ API Deployment Instructions</h3>
    
    <div class="info-box">
      <strong>üìã Quick Summary:</strong> Deploy this API as a web app to enable communication between the main application and this database.
    </div>
    
    <p>Follow these steps to deploy the optimized Admin Logger API:</p>
    
    <ol>
      <li>
        <span class="step-number">1</span>
        In the Apps Script editor, click the <strong>"Deploy"</strong> button (top right), then select <strong>"New deployment"</strong>.
      </li>
      
      <li>
        <span class="step-number">2</span>
        Click the gear icon next to "Type" and select <strong>"Web app"</strong>.
      </li>
      
      <li>
        <span class="step-number">3</span>
        Configure the deployment settings:
        <ul>
          <li><strong>Description:</strong> <code>StudyQuest Admin Logger API v2.0</code></li>
          <li><strong>Execute as:</strong> <strong>Me (your email address)</strong></li>
          <li><strong>Who has access:</strong> <strong>Anyone</strong></li>
        </ul>
        
        <div class="warning-box">
          <strong>‚ö†Ô∏è Important:</strong> "Anyone" access is required for the main app to communicate with this API. The API itself implements security through admin permissions.
        </div>
      </li>
      
      <li>
        <span class="step-number">4</span>
        Click the <strong>"Deploy"</strong> button and authorize permissions if prompted.
      </li>
      
      <li>
        <span class="step-number">5</span>
        After deployment completes, you'll see:
        <ul>
          <li><strong>Web app URL:</strong> Copy this URL - it's needed for the main application configuration</li>
          <li><strong>Deployment ID:</strong> Copy this ID and paste it in the field below</li>
        </ul>
      </li>
    </ol>
    
    <div class="success-box">
      <strong>‚úÖ Performance Features:</strong> This optimized version includes enhanced caching, batch processing, error handling, and cache invalidation for better reliability.
    </div>
    
    <hr style="margin: 30px 0;">
    
    <h4>üíæ Save Deployment Configuration</h4>
    <p>Paste the <strong>Deployment ID</strong> from step 5 above:</p>
    
    <input 
      type="text" 
      id="deploymentIdInput" 
      placeholder="Paste deployment ID here (e.g., AKfycbxxx...)" 
      maxlength="200"
    />
    
    <div id="status"></div>
    
    <br/><br/>
    <button onclick="saveDeploymentId()" id="saveButton">
      üíæ Save Configuration & Close
    </button>
    
    <div class="info-box" style="margin-top: 20px;">
      <strong>üîí Security Notes:</strong>
      <ul>
        <li>Keep the Web app URL confidential - only share it with the main application</li>
        <li>All API requests are logged in this database for monitoring</li>
        <li>You can redeploy anytime to generate a new URL if needed</li>
        <li>The API runs with your admin privileges for secure database access</li>
      </ul>
    </div>
    
    <script>
      let isSaving = false;
      
      function saveDeploymentId() {
        if (isSaving) return;
        
        const input = document.getElementById('deploymentIdInput');
        const button = document.getElementById('saveButton');
        const status = document.getElementById('status');
        const id = input.value.trim();
        
        // Validation
        if (!id) {
          showStatus('Please enter a deployment ID.', 'error');
          input.focus();
          return;
        }
        
        if (id.length < 10) {
          showStatus('Deployment ID appears to be too short. Please check and try again.', 'error');
          input.focus();
          return;
        }
        
        // Update UI
        isSaving = true;
        button.disabled = true;
        button.textContent = 'üíæ Saving...';
        showStatus('Saving deployment configuration...', 'info');
        
        // Save via Google Apps Script
        google.script.run
          .withSuccessHandler(onSaveSuccess)
          .withFailureHandler(onSaveError)
          .saveDeploymentIdToProperties(id);
      }
      
      function onSaveSuccess(result) {
        showStatus('‚úÖ Configuration saved successfully! You can now close this dialog.', 'success');
        
        // Auto-close after 2 seconds
        setTimeout(() => {
          google.script.host.close();
        }, 2000);
      }
      
      function onSaveError(error) {
        console.error('Save error:', error);
        showStatus(`‚ùå Save failed: ${error.message || 'Unknown error'}`, 'error');
        
        // Reset UI
        isSaving = false;
        const button = document.getElementById('saveButton');
        button.disabled = false;
        button.textContent = 'üíæ Save Configuration & Close';
      }
      
      function showStatus(message, type) {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = `status-${type}`;
        status.style.display = 'block';
      }
      
      // Enhanced input handling
      document.getElementById('deploymentIdInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveDeploymentId();
        }
      });
      
      // Auto-focus on input
      document.getElementById('deploymentIdInput').focus();
      
      // Input validation on typing
      document.getElementById('deploymentIdInput').addEventListener('input', function(e) {
        const status = document.getElementById('status');
        if (status.style.display === 'block' && status.className.includes('error')) {
          status.style.display = 'none';
        }
      });
    </script>
  </body>
</html>