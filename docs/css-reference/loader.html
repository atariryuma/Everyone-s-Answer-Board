<!-- =============================================================================
     CSS LOADER - Optimized loading for GAS environment
     ============================================================================= -->

<!-- Preload critical CSS for better performance -->
<link rel="preload" href="<?= getScriptUrl() ?>/src/styles/core-variables.css" as="style">

<!-- Critical CSS - Inline for immediate rendering -->
<style>
/* Critical path CSS - Dark theme foundation */
:root {
  --color-bg-primary: #0f0f0f;
  --color-bg-secondary: #1a1a1a;
  --color-text-primary: #ffffff;
  --color-text-secondary: #cccccc;
  --color-accent-primary: #3b82f6;
  --color-glass-primary: rgba(255, 255, 255, 0.05);
  --color-glass-border: rgba(255, 255, 255, 0.1);
  --color-border-transparent: transparent;
  --radius-md: 0.5rem;
  --space-sm: 0.5rem;
  --space-md: 1rem;
  --transition-fast: 150ms ease-out;
  --transition-base: 250ms ease-out;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  color: var(--color-text-primary);
  background-color: var(--color-bg-primary);
  margin: 0;
  overflow-x: hidden;
}

/* Critical transparent button styles */
.reaction-btn {
  background: transparent !important;
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
  color: var(--color-text-secondary);
  padding: var(--space-sm);
  border-radius: var(--radius-md);
  transition: var(--transition-base);
  cursor: pointer;
}

.reaction-btn:hover {
  background-color: rgba(255, 255, 255, 0.1) !important;
  color: var(--color-text-primary);
  transform: scale(1.1);
}

.reaction-btn:focus {
  outline: 2px solid var(--color-accent-primary);
  outline-offset: 2px;
}

/* Glass panel foundation */
.glass-panel {
  background: var(--color-glass-primary);
  border: 1px solid var(--color-glass-border);
  border-radius: var(--radius-md);
}

/* Loading state */
.css-loading {
  opacity: 0.7;
}
</style>

<!-- Load complete CSS system asynchronously -->
<script>
(function() {
  'use strict';
  
  // CSS files in load order
  var cssFiles = [
    'core-variables.css',
    'responsive-layout.css', 
    'button-components.css',
    'glass-panels.css'
  ];
  
  var baseUrl = '<?= getScriptUrl() ?>/src/styles/';
  var loadedCount = 0;
  var totalFiles = cssFiles.length;
  
  // Performance-optimized CSS loader
  function loadCSS(href, callback) {
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    link.media = 'print'; // Load as non-blocking
    link.onload = function() {
      this.media = 'all'; // Switch to all media
      if (callback) callback();
    };
    
    // Fallback for older browsers
    link.onerror = function() {
      console.warn('Failed to load CSS:', href);
      if (callback) callback();
    };
    
    document.head.appendChild(link);
  }
  
  // Track loading progress
  function onCSSLoaded() {
    loadedCount++;
    
    if (loadedCount === totalFiles) {
      // All CSS loaded - remove loading state
      document.body.classList.remove('css-loading');
      
      // Dispatch custom event for other scripts
      if (window.CustomEvent) {
        document.dispatchEvent(new CustomEvent('cssLoaded', {
          detail: { 
            message: 'All CSS files loaded successfully',
            timestamp: Date.now()
          }
        }));
      }
      
      console.log('âœ… All CSS files loaded successfully');
    }
  }
  
  // Add loading state
  document.body.classList.add('css-loading');
  
  // Load CSS files in sequence for better control
  function loadNextCSS(index) {
    if (index >= cssFiles.length) return;
    
    var fileName = cssFiles[index];
    var url = baseUrl + fileName;
    
    loadCSS(url, function() {
      onCSSLoaded();
      // Load next file
      loadNextCSS(index + 1);
    });
  }
  
  // Start loading process when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      loadNextCSS(0);
    });
  } else {
    loadNextCSS(0);
  }
  
  // Fallback timeout to prevent hanging
  setTimeout(function() {
    if (loadedCount < totalFiles) {
      console.warn('CSS loading timeout - some files may not have loaded');
      document.body.classList.remove('css-loading');
    }
  }, 5000);
  
})();
</script>

<!-- Fallback CSS for when files fail to load -->
<noscript>
<style>
/* Basic fallback styles */
body {
  font-family: Arial, sans-serif;
  background: #0f0f0f;
  color: #ffffff;
  margin: 0;
  padding: 1rem;
}

.reaction-btn {
  background: transparent;
  border: none;
  color: #cccccc;
  padding: 0.5rem;
  cursor: pointer;
}

.reaction-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff;
}

.glass-panel {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 0.5rem;
  padding: 1rem;
}
</style>
</noscript>