<script>
  /**
   * @fileoverview „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„ÉâÊúÄÈÅ©Âåñ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
   * GAS HTML ServiceÁî®„ÅÆÊúÄÈÅ©Âåñ„Åï„Çå„Åü„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÈñ¢Êï∞Áæ§
   */

  class GASOptimizer {
    constructor() {
      this.cache = new Map();
      this.loadingStates = new Map();
      this.concurrentLimit = 10;
      this.activeCalls = 0;
      this.callQueue = [];
    }

    /**
     * PromiseÂåñ„Åï„Çå„Åügoogle.script.runÂëº„Å≥Âá∫„Åó
     * @param {string} functionName - Âëº„Å≥Âá∫„ÅôÈñ¢Êï∞Âêç
     * @param {...any} args - Èñ¢Êï∞„ÅÆÂºïÊï∞
     * @returns {Promise} ÁµêÊûú„ÅÆPromise
     */
    async call(functionName, ...args) {
      return new Promise((resolve, reject) => {
        // ÂêåÊôÇÂÆüË°åÂà∂Èôê„ÅÆÁ¢∫Ë™ç
        if (this.activeCalls >= this.concurrentLimit) {
          this.callQueue.push(() => this.executeCall(functionName, args, resolve, reject));
          return;
        }

        this.executeCall(functionName, args, resolve, reject);
      });
    }

    /**
     * ÂÆüÈöõ„ÅÆÈñ¢Êï∞Âëº„Å≥Âá∫„ÅóÂÆüË°å
     */
    executeCall(functionName, args, resolve, reject) {
      this.activeCalls++;

      // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÅÆÁÆ°ÁêÜ
      this.setLoadingState(functionName, true);

      // GAS function call validation
      if (
        typeof google === 'undefined' ||
        !google.script ||
        !google.script.run ||
        typeof google.script.run[functionName] !== 'function'
      ) {
        throw new Error(`GAS function '${functionName}' is not available`);
      }

      google.script.run
        .withSuccessHandler((result) => {
          this.activeCalls--;
          this.setLoadingState(functionName, false);
          resolve(result);
          this.processQueue();
        })
        .withFailureHandler((error) => {
          this.activeCalls--;
          this.setLoadingState(functionName, false);
          console.error(`GAS Function Error [${functionName}]:`, error);
          reject(this.enhanceError(error, functionName));
          this.processQueue();
        })
        [functionName](...args);
    }

    /**
     * „Ç≠„É•„Éº„ÅÆÂá¶ÁêÜ
     */
    processQueue() {
      if (this.callQueue.length > 0 && this.activeCalls < this.concurrentLimit) {
        const nextCall = this.callQueue.shift();
        nextCall();
      }
    }

    /**
     * „Ç®„É©„ÉºÊÉÖÂ†±„ÅÆÊã°Âºµ
     */
    enhanceError(error, functionName) {
      return {
        ...error,
        function: functionName,
        timestamp: new Date().toISOString(),
        userMessage: this.getUserFriendlyErrorMessage(error.message),
      };
    }

    /**
     * „É¶„Éº„Ç∂„Éº„Éï„É¨„É≥„Éâ„É™„Éº„Å™„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
     */
    getUserFriendlyErrorMessage(originalMessage) {
      const errorMap = {
        'Exception: Ë™çË®º„Ç®„É©„Éº':
          '„É≠„Ç∞„Ç§„É≥„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÊúüÈôêÂàá„Çå„Åß„Åô„ÄÇ„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ',
        'Exception: ÁÑ°Âäπ„Å™„É¶„Éº„Ç∂„ÉºID':
          '„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ',
        'Exception: „Éá„Éº„Çø„Éô„Éº„Çπ':
          '„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ',
        ScriptError: '„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ',
      };

      for (const [key, message] of Object.entries(errorMap)) {
        if (originalMessage && originalMessage.includes(key)) {
          return message;
        }
      }

      return '‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
    }

    /**
     * „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÅÆÁÆ°ÁêÜ
     */
    setLoadingState(functionName, isLoading) {
      this.loadingStates.set(functionName, isLoading);
      this.updateGlobalLoadingIndicator();
    }

    /**
     * „Ç∞„É≠„Éº„Éê„É´„É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÅÆÊõ¥Êñ∞
     */
    updateGlobalLoadingIndicator() {
      const hasActiveLoading = Array.from(this.loadingStates.values()).some((state) => state);
      document.body.classList.toggle('gas-loading', hasActiveLoading);
    }

    /**
     * „Ç≠„É£„ÉÉ„Ç∑„É•‰ªò„Åç„ÅÆÈñ¢Êï∞Âëº„Å≥Âá∫„Åó
     */
    async callWithCache(functionName, args, ttl = 5 * 60 * 1000) {
      const cacheKey = `${functionName}_${JSON.stringify(args)}`;
      const cached = this.cache.get(cacheKey);

      if (cached && Date.now() - cached.timestamp < ttl) {
        return cached.data;
      }

      const result = await this.call(functionName, ...args);
      this.cache.set(cacheKey, {
        data: result,
        timestamp: Date.now(),
      });

      return result;
    }

    /**
     * „Éê„ÉÉ„ÉÅÂá¶ÁêÜÂØæÂøú„ÅÆÈñ¢Êï∞Âëº„Å≥Âá∫„Åó
     */
    async batchCall(calls) {
      const promises = calls.map(({ functionName, args }) =>
        this.call(functionName, ...args).catch((error) => ({ error, functionName }))
      );

      return Promise.all(promises);
    }

    /**
     * „Ç≠„É£„ÉÉ„Ç∑„É•„ÅÆ„ÇØ„É™„Ç¢
     */
    clearCache() {
      this.cache.clear();
    }

    /**
     * Áµ±Ë®àÊÉÖÂ†±„ÅÆÂèñÂæó
     */
    getStats() {
      return {
        activeCalls: this.activeCalls,
        queueLength: this.callQueue.length,
        cacheSize: this.cache.size,
        loadingStates: Object.fromEntries(this.loadingStates),
      };
    }
  }

  // „Ç∞„É≠„Éº„Éê„É´„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅÆ‰ΩúÊàê
  window.gasOptimizer = new GASOptimizer();

  /**
   * ‰æøÂà©„Å™Èñ¢Êï∞„ÅÆ„Ç®„Ç§„É™„Ç¢„Çπ
   */
  window.gasCall = (functionName, ...args) => window.gasOptimizer.call(functionName, ...args);
  window.gasCacheCall = (functionName, args, ttl) =>
    window.gasOptimizer.callWithCache(functionName, args, ttl);

  /**
   * „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„ÅÆÊúÄÈÅ©Âåñ
   */
  class MessageManager {
    constructor() {
      this.messageContainer = null;
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.init());
      } else {
        this.init();
      }
    }

    init() {
      // „É°„ÉÉ„Çª„Éº„Ç∏„Ç≥„É≥„ÉÜ„Éä„ÅÆ‰ΩúÊàê
      if (!document.getElementById('gas-message-container')) {
        const container = document.createElement('div');
        container.id = 'gas-message-container';
        container.className = 'fixed top-4 right-4 z-50 space-y-2';
        document.body.appendChild(container);
        this.messageContainer = container;
      }
    }

    show(message, type = 'info', duration = 5000) {
      const messageEl = document.createElement('div');
      messageEl.className = `
      p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full
      ${this.getTypeClasses(type)}
    `;
      messageEl.innerHTML = `
      <div class="flex items-center space-x-2">
        <div class="flex-shrink-0">
          ${this.getIcon(type)}
        </div>
        <div class="flex-1 text-sm font-medium">${message}</div>
        <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
          ${typeof window.IconLibrary !== 'undefined' ? window.IconLibrary.get('x', {size: 'w-4 h-4'}) : '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/></svg>'}
        </button>
      </div>
    `;

      this.messageContainer.appendChild(messageEl);

      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
      setTimeout(() => {
        messageEl.classList.remove('translate-x-full');
      }, 10);

      // Ëá™ÂãïÂâäÈô§
      if (duration > 0) {
        setTimeout(() => {
          if (messageEl.parentElement) {
            messageEl.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => messageEl.remove(), 300);
          }
        }, duration);
      }

      return messageEl;
    }

    getTypeClasses(type) {
      const classes = {
        info: 'bg-blue-500 text-white',
        success: 'bg-green-500 text-white',
        warning: 'bg-yellow-500 text-black',
        error: 'bg-red-500 text-white',
      };
      return classes[type] || classes.info;
    }

    getIcon(type) {
      // üéØ Áµ±‰∏Ä„Ç¢„Ç§„Ç≥„É≥„Ç∑„Çπ„ÉÜ„É† - „É°„ÉÉ„Çª„Éº„Ç∏„Ç¢„Ç§„Ç≥„É≥„ÅÆÁµ±‰∏Ä
      if (typeof window.IconLibrary !== 'undefined') {
        const iconMap = {
          info: 'info',
          success: 'check-circle',
          warning: 'alert-triangle',
          error: 'x-circle'
        };
        const iconName = iconMap[type] || 'info';
        return window.IconLibrary.get(iconName, {size: 'w-5 h-5'});
      }

      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöIconLibrary„ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà
      const fallbackIcons = {
        info: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0zm-7-4a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM9 9a1 1 0 0 0 0 2v3a1 1 0 001 1h1a1 1 0 1 0 0-2v-3a1 1 0 00-1-1H9z"/></svg>',
        success: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 0 1 0 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>',
        warning: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"/></svg>',
        error: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0zM7 8a1 1 0 012 0v4a1 1 0 1 1-2 0V8zM12 8a1 1 0 1 1 2 0v4a1 1 0 1 1-2 0V8z"/></svg>',
      };
      return fallbackIcons[type] || fallbackIcons.info;
    }
  }

  // „Ç∞„É≠„Éº„Éê„É´„É°„ÉÉ„Çª„Éº„Ç∏„Éû„Éç„Éº„Ç∏„É£„Éº
  window.messageManager = new MessageManager();
  window.showMessage = (message, type, duration) =>
    window.messageManager.show(message, type, duration);

  /**
   * „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÅÆCSS
   */
  const loadingCSS = `
<style>
.gas-loading {
  cursor: wait;
}

.gas-loading * {
  pointer-events: none;
}

.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(139, 233, 253, 0.3);
  border-top: 2px solid var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

/* Loading overlay styles moved to UnifiedStyles.html for consistency */
</style>
`;

  // CSS„ÇíÊ≥®ÂÖ•
  document.head.insertAdjacentHTML('beforeend', loadingCSS);

  // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºàÈñãÁô∫ÊôÇ„ÅÆ„ÅøÔºâ
  if (
    window.location.hostname === 'localhost' ||
    window.location.hostname.includes('script.google.com')
  ) {
    window.gasDebug = () => console.log('GAS Optimizer Stats:', window.gasOptimizer.getStats());
  }
</script>
